var scriptName = "ì£ ë´‡ í¬ì¼“ëª¬";
// â˜… [ì‹ ê·œ] ê¹ƒí—ˆë¸Œ ìë™ ì—…ë°ì´íŠ¸ìš© ë³€ìˆ˜
var GITHUB_RAW_URL = "https://raw.githubusercontent.com/sonsajang92/Firstpoke/main/po-1";
var SCRIPT_NAME = "ì£ ë´‡ í¬ì¼“ëª¬";// ë©”ì‹ ì €ë´‡R ì•±ì— ì íŒ ì´ë¦„ê³¼ ì •í™•íˆ ì¼ì¹˜í•´ì•¼ í•¨
// -------------------- ì „ì²´ë³´ê¸°(ì ‘ê¸°) SAFE --------------------
// ì¹´í†¡/ë©”ì‹ ì €ë´‡Rì—ì„œ ë„ˆë¬´ ê¸´ ë©”ì‹œì§€ëŠ” ì „ì†¡ ì‹¤íŒ¨/í¬ë˜ì‹œ ìœ ë°œ ê°€ëŠ¥
function replyFold(replier, summary, full) {
  summary = String(summary || "");
  full = String(full || "");
  
  // âœ… ìš”ì•½ì´ ê¸¸ì–´ì§€ë©´, ë’¤ìª½ì„ ì˜ë¼ì„œ ì „ì²´ë³´ê¸°ë¡œ ë³´ë‚´ë²„ë¦¼
  var SUMMARY_LIMIT = 220;  // 180~260 ì‚¬ì´ë¡œ ì·¨í–¥ ì¡°ì ˆ
  if (summary.length > SUMMARY_LIMIT) {
    var overflow = summary.substring(SUMMARY_LIMIT);
    summary = summary.substring(0, SUMMARY_LIMIT) + "\n... (ì „ì²´ë³´ê¸°)";
    // overflowë¥¼ full ì•ì— ë¶™ì—¬ì„œ "ëª©ë¡"ì´ ì „ì²´ë³´ê¸°ì— ë“¤ì–´ê°€ê²Œ í•¨
    full = overflow + "\n\n" + full;
  }
  
  // â˜… [í•µì‹¬ ìˆ˜ì •] ëˆˆì— ì•ˆ ë³´ì´ëŠ” ë¬¸ìê°€ ê¹¨ì§€ì§€ ì•Šë„ë¡ ìœ ë‹ˆì½”ë“œ(\u200b)ë¡œ ì§ì ‘ ì…ë ¥!
  var foldChar = "\u200b".repeat(500);
  
  replier.reply(summary + foldChar + (full ? ("\n" + full) : " "));
}

//ê³¨ë“œì½¤ë§ˆ
function fmtNum(n) {
  n = parseInt(n, 10);
  if (isNaN(n)) 
    n = 0;
  return String(n).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}
// null/undefined ëŒ€ë¹„ìš© (ìˆ«ì ì•„ë‹Œ ê°’ë„ ê·¸ëƒ¥ ë¬¸ìì—´ë¡œ)
function fmtAny(v) {
  if (v === null || v === undefined) 
    return "";
  if (typeof v === "number") 
    return fmtNum(v);
  if (typeof v === "string" && /^-?\d+$/.test(v)) 
    return fmtNum(v);
  return String(v);
}
// -------------------- ì €ì¥ íŒŒì¼ ê²½ë¡œ --------------------
var DATA_PATH = "/sdcard/mbot_pokemon_db.json";
// -------------------- ë°¸ëŸ°ìŠ¤(í‘œì¤€) --------------------
var MAX_LV = 200;// ğŸ‘¤ íŠ¸ë ˆì´ë„ˆ ë§Œë ™ (ê¸°ì¡´ 150 -> 200 í™•ì¥)
var MAX_POKE_LV = 99;// ğŸ¾ í¬ì¼“ëª¬ ë§Œë ™ (99 ê³ ì •)
var ENHANCE_MAX = 60;
var FIELD_COOLDOWN_MS = 10 * 1000;// /í•„ë“œ 10ì´ˆ
var EXPLORE_COOLDOWN_MS = 30 * 1000;// /íƒí—˜ 30ì´ˆ
var ENHANCE_COOLDOWN_MS = 5 * 1000;// /ê°•í™” 5ì´ˆ
var BATTLE_COOLDOWN_MS = 10 * 1000;// /ë°°í‹€ 10ì´ˆ
var ACTIVE_TTL_MS = 6 * 60 * 60 * 1000;// 6ì‹œê°„ ì´ë‚´ ì±„íŒ…í•œ ìœ ì €ë§Œ ë°°í‹€ ë§¤ì¹­
// ==================== [ê¸´ê¸‰] ìµœëŒ€ ë³´ìœ ëŸ‰ ì œí•œ ====================
var MAX_POKEMON_SLOT = 300;// 300ë§ˆë¦¬ ë„˜ìœ¼ë©´ í¬íš ë¶ˆê°€
// í¬íš ë³´ìƒ (ë‚œìˆ˜)
var CATCH_GOLD_MIN = 40;
var CATCH_GOLD_MAX = 90;
var CATCH_EXP_MIN = 30;
var CATCH_EXP_MAX = 60;
// [ì‹ ê·œ] ì´ë¡œì¹˜(Shiny) í™•ë¥  (0.005 = 0.5%)
var SHINY_PROBABILITY = 0.005;
// í¬íš ë³´ìƒ ì•ˆì „ ìº¡(ê²½ì œ í­ì£¼ ë°©ì§€)
var CATCH_GOLD_CAP = 220;
var CATCH_EXP_CAP = 80;
// -------------------- íƒí—˜ ë³´ìƒ ë°¸ëŸ°ìŠ¤ (ììœ  ê²½ì œ íŒ¨ì¹˜) --------------------
var EXPLORE_GOLD_MIN = 30000;
var EXPLORE_GOLD_MAX = 50000;
var EXPLORE_EXP_MIN = 5000;
var EXPLORE_EXP_MAX = 10000;
var EXPLORE_LV_RATE = 0.01;
// ì•ˆì „ ìº¡ ì œê±° (ì£¼ì„ ì²˜ë¦¬í•˜ê±°ë‚˜ ì•„ì£¼ í° ê°’ìœ¼ë¡œ ì„¤ì •)
// var EXPLORE_GOLD_CAP = 999999999999; 
// ë°°í‹€ ë³´ìƒ
var BATTLE_GOLD_WIN = 500;          // ìŠ¹ë¦¬ ë³´ìƒ (140 -> 500 ìƒí–¥)
var BATTLE_GOLD_LOSE = 150;         // íŒ¨ë°° ë³´ìƒ (40 -> 150 ìƒí–¥)
var BATTLE_EXP_WIN = 120;           // í¬ì¼“ëª¬ ìŠ¹ë¦¬ ê²½í—˜ì¹˜ (65 -> 120 ìƒí–¥)
var BATTLE_EXP_LOSE = 50;           // í¬ì¼“ëª¬ íŒ¨ë°° ê²½í—˜ì¹˜ (30 -> 50 ìƒí–¥)
// ìŠ¹ë¦¬ ë³´ë„ˆìŠ¤(ê°•í™” +1)
var BATTLE_BONUS_ENH_CHANCE = 0.07;
// ==================== ë°°í‹€ ì°¸ê°€ ìµœì†Œ ê°•í™” ====================
var BATTLE_MIN_ENH = 20;// 5 -> 20

// ğŸ“¦ ì¼ë°˜ ìƒì  ë°ì´í„°ë² ì´ìŠ¤ (ê³¨ë“œ ì†Œëª¨ìš© ê³ ê°€ ì•„ì´í…œ ì¶”ê°€)
var SHOP_ITEMS = {
  "ëª¬ìŠ¤í„°ë³¼": { price: 500, icon: "ğŸ”´", desc: "ê¸°ë³¸ì ì¸ í¬íšìš© ë³¼" },
  "ìŠˆí¼ë³¼": { price: 10000, icon: "ğŸ”µ", desc: "í¬íšë¥ ì´ ë†’ì€ ìƒìœ„ ë³¼" },
  "í•˜ì´í¼ë³¼": { price: 50000, icon: "âš«", desc: "í¬íšë¥ ì´ ë§¤ìš° ë†’ì€ ê³ ê¸‰ ë³¼" },
  "ë ˆì „ë“œë³¼": { price: 100000000, icon: "ğŸ‘‘", desc: "100% í™•ë¥  í¬íš (êµ¬ í‚¹ê°“ë³¼)" },
  
  // --- [ê°•í™” ë° ìœ¡ì„± ì•„ì´í…œ] ---
  "ë‘ì«€ì¿ ": { price: 1000000, icon: "ğŸª", desc: "ì‚¬ìš© ì‹œ ê°•í™” ìˆ˜ì¹˜ê°€ +1 ìƒìŠ¹í•©ë‹ˆë‹¤. (100% ì„±ê³µ)" }, // ê°•í™”ìš©ìœ¼ë¡œ ì •ì •
  "í¬ì¼“ëª¬í‘¸ë”©": { price: 100000, icon: "ğŸ®", desc: "ì¹œë°€ë„ë¥¼ ì¦‰ì‹œ +20 ì˜¬ë¦½ë‹ˆë‹¤. (ë‹¤ëŸ‰ ì‚¬ìš© ê°€ëŠ¥)" },
  "ì´ë™í‹°ì¼“": { price: 10000, icon: "ğŸ«", desc: "ì›í•˜ëŠ” ì§€ì—­ìœ¼ë¡œ ì¦‰ì‹œ ì´ë™í•©ë‹ˆë‹¤." },
  "íƒì‚¬ìŠ¤í”„ë ˆì´": { price: 500000, icon: "ğŸ’¨", desc: "30ë¶„ê°„ í•„ë“œ íƒìƒ‰ ì¿¨íƒ€ì„ì„ ì ˆë°˜ìœ¼ë¡œ ë‹¨ì¶•!" }
};
// ğŸ° [ë‹¤ì½”íƒ€ ìƒì ] í†µí•© ë°ì´í„°ë² ì´ìŠ¤
var DAKOTA_ITEMS = {
  "ì¥ë¹„ìƒì": { price: 100, icon: "ğŸ“¦", desc: "ì¥ë¹„ or íŒŒí¸ íšë“ (5% ì „ì„¤!)", aliases: ["ìƒì", "ë³´ë¬¼ìƒì"] },
  "ë”¸ì«€ì¿ ": { price: 5000, icon: "ğŸ¬", desc: "í¬ì¼“ëª¬ [ë ˆë²¨ +1] ìƒìŠ¹ (ì´ìƒí•œì‚¬íƒ•)", aliases: ["ë”¸ê¸°", "ë”¸ê¸°ì¿ í‚¤"] },
  "í™©ê¸ˆì—´ë§¤": { price: 25000, icon: "ğŸ†", desc: "ì ì¬ë ¥ MAX & Së“±ê¸‰ í™•ì •", aliases: ["ì—´ë§¤", "ë¼ì¦ˆì—´ë§¤"] },
  "í™©ê¸ˆí˜ì¸íŠ¸": { price: 35000, icon: "ğŸ¨", desc: "ì¼ë°˜ í¬ì¼“ëª¬ì„ [âœ¨ì´ë¡œì¹˜]ë¡œ ë³€í™˜", aliases: ["í˜ì¸íŠ¸", "ì´ë¡œì¹˜"] }
};
// íƒ€ì… ìƒì„± ì¬ë§¤í•‘ ê°’(0->1, 0.5->1.5, 1->2, 2->3.5)
var TYPE_STRONG = 3.0;
// ë°ë¯¸ì§€ ê°•í™” í¼ì„¼íŠ¸ ê¸°ì—¬
var ATK_ENH_RATE = 0.085;
var DEF_ENH_RATE = 0.050;
// ë°°í‹€ ê´€ë ¨ 
var STREAK_GOLD_BONUS_EVERY = 3;
var STREAK_GOLD_BONUS = 60;
var STREAK_EXP_BONUS_EVERY = 5;
var STREAK_EXP_BONUS = 25;
var STREAK_ENH_BONUS_EVERY = 10;
var STREAK_ENH_BONUS_CHANCE = 0.12;// 10ì—°ìŠ¹ ë„ë‹¬ ì‹œ ì¶”ê°€ í™•ë¥ 
var MIN_BATTLE_ENH = 5;
var BALL_CATCH_MULT = [1.00, 3.00, 5.00, 100.00];
var ACTIVE_SAVE_INTERVAL_MS = 20 * 1000;// 20ì´ˆì— 1ë²ˆë§Œ ì €ì¥
var MATCH_POOL_KEY = "__GLOBAL_MATCH__";

// ==================== [ë ˆì´ë“œ] ì›”ë“œ ë³´ìŠ¤ ì„¤ì • ====================
// 1. ê¸°ë³¸ ì²´ë ¥ (ê´€ë¦¬ì ì†Œí™˜ ì‹œ ìˆ«ì ì•ˆ ì ìœ¼ë©´ ì ìš©ë¨)
var RAID_BOSS_DEFAULT_HP = 1000000000;// 10ì–µ
var RAID_RANDOM_SPAWN_PROB = 0.0008;// ë©”ì‹œì§€ë‹¹ 0.08% í™•ë¥ 
var RAID_RANDOM_SPAWN_COOLDOWN_MS = 60 * 60 * 1000;// ëŒë°œ ë ˆì´ë“œ ìµœì†Œ ê°„ê²© 60ë¶„
// 2. â˜… ë ˆì´ë“œ ì œí•œ ì‹œê°„ (íˆë“ /ê´€ë¦¬ì ê³µí†µ ì ìš©)
var RAID_DURATION_MS = 40 * 60 * 1000;// 40ë¶„ (ì§‘ì¤‘ íƒ€ì„!)
// 3. ë¶€ìƒ(ì¿¨íƒ€ì„) ì‹œê°„ (2ë¶„)
var RAID_COOLDOWN_MS = 2 * 60 * 1000;
var RAID_FINISHER_MULT = 12;// í•„ì‚´ê¸° ë°°ìœ¨
var RAID_VIP_HEAL_COST = 10000000;// /ì¹˜ë£Œ ë¹„ìš© (1ì²œë§Œ ê³¨ë“œ)
var RAID_VIP_HEAL_REMAIN_MS = 5 * 1000;// VIP ì¹˜ë£Œ í›„ ë‚¨ì€ ë¶€ìƒ ì‹œê°„ 5ì´ˆ
// ==================== [ì„¤ì •] íˆë“ /ëŒë°œ ë ˆì´ë“œ ë³´ìŠ¤ ëª©ë¡ (ì „ì—­ ë³€ìˆ˜) ====================
var HIDDEN_RAIDS = {
  "ê°¸ê¾¸ë¥´ì¼": {
  name: "ì‹ í•œì¹´ë“œ ìœ ì €", 
  hp: 3, 
  img: "ğŸ˜’", 
  lv: 30}, 
  "ë˜ì´ë“œ": {
  name: "ë¬¼ê³ ê¸° ì‰í”„", 
  hp: 5, 
  img: "ğŸŸ", 
  lv: 70}, 
  "ë“œê°€ì": {
  name: "ì´ˆê°ì„± ë®¤ì¸ ", 
  hp: 10, 
  img: "ğŸ§¬", 
  lv: 100}};
// ==================== [ë‹¤ì½”íƒ€ ì•”ì‹œì¥] ê°€ê²© ë° í™•ë¥  ì„¤ì • (ì¸í”Œë ˆì´ì…˜ íŒ¨ì¹˜) ====================
// 1. ì•„ì´í…œ ê°€ê²© (ë‹¨ìœ„: ë‹¤ì½”íƒ€ ì½”ì¸)
// ë ˆì´ë“œ 1íšŒ 1ë“± ê¸°ëŒ€ ìˆ˜ìµ: ì•½ 150~200 ì½”ì¸
var DAKOTA_PRICE_BOX = 100;// ì¥ë¹„ìƒì (ë¹„ìŒˆ! ì‹ ì¤‘í•˜ê²Œ êµ¬ë§¤)
var DAKOTA_PRICE_DDAL = 5000;// ë”¸ê¸°ì¿ í‚¤ (+3ê°• í™•ì •ì˜ ê°€ì¹˜)
var DAKOTA_PRICE_NUT = 10000;// í™©ê¸ˆì—´ë§¤ (ì¡¸ì—…ê¸‰ ìŠ¤í™)
var DAKOTA_PRICE_PAINT = 25000;// í™©ê¸ˆí˜ì¸íŠ¸ (ë¶€ì˜ ìƒì§•)
// 2. ìƒìê¹¡ í™•ë¥  ì„¤ì • (4í‹°ì–´ ì²´ì œ)
// ğŸ‘‘ ì „ì„¤(0.5%) / ğŸŒŸ ìƒê¸‰(4.5%) / ğŸ”¹ í¬ê·€(15%) / âšª ì¼ë°˜(40%) / ğŸ§© íŒŒí¸(40%)
var BOX_PROB_TIER_4 = 0.005;
var BOX_PROB_TIER_3 = 0.045;
var BOX_PROB_TIER_2 = 0.15;
var BOX_PROB_TIER_1 = 0.40;
// -------------------- 1ì„¸ëŒ€ 151 DB --------------------
var POKEMON_DB = [{
  id: 1, 
  name: "ì´ìƒí•´ì”¨", 
  type1: "í’€", 
  type2: "ë…", 
  basePower: 50, 
  rarity: 2}, {
  id: 2, 
  name: "ì´ìƒí•´í’€", 
  type1: "í’€", 
  type2: "ë…", 
  basePower: 70, 
  rarity: 3}, {
  id: 3, 
  name: "ì´ìƒí•´ê½ƒ", 
  type1: "í’€", 
  type2: "ë…", 
  basePower: 90, 
  rarity: 4}, {
  id: 4, 
  name: "íŒŒì´ë¦¬", 
  type1: "ë¶ˆ", 
  type2: null, 
  basePower: 50, 
  rarity: 2}, {
  id: 5, 
  name: "ë¦¬ìë“œ", 
  type1: "ë¶ˆ", 
  type2: null, 
  basePower: 70, 
  rarity: 3}, {
  id: 6, 
  name: "ë¦¬ìëª½", 
  type1: "ë¶ˆ", 
  type2: "ë¹„í–‰", 
  basePower: 92, 
  rarity: 4}, {
  id: 7, 
  name: "ê¼¬ë¶€ê¸°", 
  type1: "ë¬¼", 
  type2: null, 
  basePower: 48, 
  rarity: 2}, {
  id: 8, 
  name: "ì–´ë‹ˆë¶€ê¸°", 
  type1: "ë¬¼", 
  type2: null, 
  basePower: 68, 
  rarity: 3}, {
  id: 9, 
  name: "ê±°ë¶ì™•", 
  type1: "ë¬¼", 
  type2: null, 
  basePower: 90, 
  rarity: 4}, {
  id: 10, 
  name: "ìºí„°í”¼", 
  type1: "ë²Œë ˆ", 
  type2: null, 
  basePower: 30, 
  rarity: 1}, {
  id: 11, 
  name: "ë‹¨ë°ê¸°", 
  type1: "ë²Œë ˆ", 
  type2: null, 
  basePower: 35, 
  rarity: 1}, {
  id: 12, 
  name: "ë²„í„°í”Œ", 
  type1: "ë²Œë ˆ", 
  type2: "ë¹„í–‰", 
  basePower: 65, 
  rarity: 2}, {
  id: 13, 
  name: "ë¿”ì¶©ì´", 
  type1: "ë²Œë ˆ", 
  type2: "ë…", 
  basePower: 30, 
  rarity: 1}, {
  id: 14, 
  name: "ë”±ì¶©ì´", 
  type1: "ë²Œë ˆ", 
  type2: "ë…", 
  basePower: 35, 
  rarity: 1}, {
  id: 15, 
  name: "ë…ì¹¨ë¶•", 
  type1: "ë²Œë ˆ", 
  type2: "ë…", 
  basePower: 70, 
  rarity: 2}, {
  id: 16, 
  name: "êµ¬êµ¬", 
  type1: "ë…¸ë§", 
  type2: "ë¹„í–‰", 
  basePower: 40, 
  rarity: 1}, {
  id: 17, 
  name: "í”¼ì£¤", 
  type1: "ë…¸ë§", 
  type2: "ë¹„í–‰", 
  basePower: 60, 
  rarity: 2}, {
  id: 18, 
  name: "í”¼ì£¤íˆ¬", 
  type1: "ë…¸ë§", 
  type2: "ë¹„í–‰", 
  basePower: 82, 
  rarity: 3}, {
  id: 19, 
  name: "ê¼¬ë ›", 
  type1: "ë…¸ë§", 
  type2: null, 
  basePower: 42, 
  rarity: 1}, {
  id: 20, 
  name: "ë ˆíŠ¸ë¼", 
  type1: "ë…¸ë§", 
  type2: null, 
  basePower: 68, 
  rarity: 2}, {
  id: 21, 
  name: "ê¹¨ë¹„ì°¸", 
  type1: "ë…¸ë§", 
  type2: "ë¹„í–‰", 
  basePower: 45, 
  rarity: 1}, {
  id: 22, 
  name: "ê¹¨ë¹„ë“œë¦´ì¡°", 
  type1: "ë…¸ë§", 
  type2: "ë¹„í–‰", 
  basePower: 78, 
  rarity: 2}, {
  id: 23, 
  name: "ì•„ë³´", 
  type1: "ë…", 
  type2: null, 
  basePower: 45, 
  rarity: 1}, {
  id: 24, 
  name: "ì•„ë³´í¬", 
  type1: "ë…", 
  type2: null, 
  basePower: 75, 
  rarity: 2}, {
  id: 25, 
  name: "í”¼ì¹´ì¸„", 
  type1: "ì „ê¸°", 
  type2: null, 
  basePower: 55, 
  rarity: 3}, {
  id: 26, 
  name: "ë¼ì´ì¸„", 
  type1: "ì „ê¸°", 
  type2: null, 
  basePower: 78, 
  rarity: 3}, {
  id: 27, 
  name: "ëª¨ë˜ë‘ì§€", 
  type1: "ë•…", 
  type2: null, 
  basePower: 50, 
  rarity: 2}, {
  id: 28, 
  name: "ê³ ì§€", 
  type1: "ë•…", 
  type2: null, 
  basePower: 78, 
  rarity: 3}, {
  id: 29, 
  name: "ë‹ˆë“œëŸ°â™€", 
  type1: "ë…", 
  type2: null, 
  basePower: 46, 
  rarity: 2}, {
  id: 30, 
  name: "ë‹ˆë“œë¦¬ë‚˜", 
  type1: "ë…", 
  type2: null, 
  basePower: 64, 
  rarity: 2}, {
  id: 31, 
  name: "ë‹ˆë“œí€¸", 
  type1: "ë…", 
  type2: "ë•…", 
  basePower: 88, 
  rarity: 4}, {
  id: 32, 
  name: "ë‹ˆë“œëŸ°â™‚", 
  type1: "ë…", 
  type2: null, 
  basePower: 46, 
  rarity: 2}, {
  id: 33, 
  name: "ë‹ˆë“œë¦¬ë…¸", 
  type1: "ë…", 
  type2: null, 
  basePower: 64, 
  rarity: 2}, {
  id: 34, 
  name: "ë‹ˆë“œí‚¹", 
  type1: "ë…", 
  type2: "ë•…", 
  basePower: 88, 
  rarity: 4}, {
  id: 35, 
  name: "ì‚ì‚", 
  type1: "í˜ì–´ë¦¬", 
  type2: null, 
  basePower: 48, 
  rarity: 3}, {
  id: 36, 
  name: "í”½ì‹œ", 
  type1: "í˜ì–´ë¦¬", 
  type2: null, 
  basePower: 78, 
  rarity: 3}, {
  id: 37, 
  name: "ì‹ìŠ¤í…Œì¼", 
  type1: "ë¶ˆ", 
  type2: null, 
  basePower: 45, 
  rarity: 3}, {
  id: 38, 
  name: "ë‚˜ì¸í…Œì¼", 
  type1: "ë¶ˆ", 
  type2: null, 
  basePower: 80, 
  rarity: 4}, {
  id: 39, 
  name: "í‘¸ë¦°", 
  type1: "ë…¸ë§", 
  type2: "í˜ì–´ë¦¬", 
  basePower: 45, 
  rarity: 2}, {
  id: 40, 
  name: "í‘¸í¬ë¦°", 
  type1: "ë…¸ë§", 
  type2: "í˜ì–´ë¦¬", 
  basePower: 75, 
  rarity: 3}, {
  id: 41, 
  name: "ì£¼ë±ƒ", 
  type1: "ë…", 
  type2: "ë¹„í–‰", 
  basePower: 40, 
  rarity: 2}, {
  id: 42, 
  name: "ê³¨ë±ƒ", 
  type1: "ë…", 
  type2: "ë¹„í–‰", 
  basePower: 75, 
  rarity: 3}, {
  id: 43, 
  name: "ëšœë²…ìµ¸", 
  type1: "í’€", 
  type2: "ë…", 
  basePower: 45, 
  rarity: 2}, {
  id: 44, 
  name: "ëƒ„ìƒˆê¼¬", 
  type1: "í’€", 
  type2: "ë…", 
  basePower: 62, 
  rarity: 2}, {
  id: 45, 
  name: "ë¼í”Œë ˆì‹œì•„", 
  type1: "í’€", 
  type2: "ë…", 
  basePower: 82, 
  rarity: 3}, {
  id: 46, 
  name: "íŒŒë¼ìŠ¤", 
  type1: "ë²Œë ˆ", 
  type2: "í’€", 
  basePower: 42, 
  rarity: 2}, {
  id: 47, 
  name: "íŒŒë¼ì„¹íŠ¸", 
  type1: "ë²Œë ˆ", 
  type2: "í’€", 
  basePower: 72, 
  rarity: 3}, {
  id: 48, 
  name: "ì½˜íŒ¡", 
  type1: "ë²Œë ˆ", 
  type2: "ë…", 
  basePower: 40, 
  rarity: 2}, {
  id: 49, 
  name: "ë„ë‚˜ë¦¬", 
  type1: "ë²Œë ˆ", 
  type2: "ë…", 
  basePower: 70, 
  rarity: 3}, {
  id: 50, 
  name: "ë””ê·¸ë‹¤", 
  type1: "ë•…", 
  type2: null, 
  basePower: 45, 
  rarity: 2}, {
  id: 51, 
  name: "ë‹¥íŠ¸ë¦¬ì˜¤", 
  type1: "ë•…", 
  type2: null, 
  basePower: 75, 
  rarity: 3}, {
  id: 52, 
  name: "ë‚˜ì˜¹", 
  type1: "ë…¸ë§", 
  type2: null, 
  basePower: 48, 
  rarity: 2}, {
  id: 53, 
  name: "í˜ë¥´ì‹œì˜¨", 
  type1: "ë…¸ë§", 
  type2: null, 
  basePower: 78, 
  rarity: 3}, {
  id: 54, 
  name: "ê³ ë¼íŒŒë•", 
  type1: "ë¬¼", 
  type2: null, 
  basePower: 52, 
  rarity: 2}, {
  id: 55, 
  name: "ê³¨ë•", 
  type1: "ë¬¼", 
  type2: null, 
  basePower: 80, 
  rarity: 3}, {
  id: 56, 
  name: "ë§í‚¤", 
  type1: "ê²©íˆ¬", 
  type2: null, 
  basePower: 50, 
  rarity: 2}, {
  id: 57, 
  name: "ì„±ì›ìˆ­", 
  type1: "ê²©íˆ¬", 
  type2: null, 
  basePower: 80, 
  rarity: 3}, {
  id: 58, 
  name: "ê°€ë””", 
  type1: "ë¶ˆ", 
  type2: null, 
  basePower: 55, 
  rarity: 3}, {
  id: 59, 
  name: "ìœˆë””", 
  type1: "ë¶ˆ", 
  type2: null, 
  basePower: 92, 
  rarity: 4}, {
  id: 60, 
  name: "ë°œì±™ì´", 
  type1: "ë¬¼", 
  type2: null, 
  basePower: 48, 
  rarity: 2}, {
  id: 61, 
  name: "ìŠˆë¥™ì±™ì´", 
  type1: "ë¬¼", 
  type2: null, 
  basePower: 65, 
  rarity: 2}, {
  id: 62, 
  name: "ê°•ì±™ì´", 
  type1: "ë¬¼", 
  type2: "ê²©íˆ¬", 
  basePower: 88, 
  rarity: 4}, {
  id: 63, 
  name: "ìºì´ì‹œ", 
  type1: "ì—ìŠ¤í¼", 
  type2: null, 
  basePower: 45, 
  rarity: 3}, {
  id: 64, 
  name: "ìœ¤ê²”ë¼", 
  type1: "ì—ìŠ¤í¼", 
  type2: null, 
  basePower: 72, 
  rarity: 3}, {
  id: 65, 
  name: "í›„ë”˜", 
  type1: "ì—ìŠ¤í¼", 
  type2: null, 
  basePower: 92, 
  rarity: 4}, {
  id: 66, 
  name: "ì•Œí†µëª¬", 
  type1: "ê²©íˆ¬", 
  type2: null, 
  basePower: 55, 
  rarity: 2}, {
  id: 67, 
  name: "ê·¼ìœ¡ëª¬", 
  type1: "ê²©íˆ¬", 
  type2: null, 
  basePower: 72, 
  rarity: 3}, {
  id: 68, 
  name: "ê´´ë ¥ëª¬", 
  type1: "ê²©íˆ¬", 
  type2: null, 
  basePower: 90, 
  rarity: 4}, {
  id: 69, 
  name: "ëª¨ë‹¤í”¼", 
  type1: "í’€", 
  type2: "ë…", 
  basePower: 45, 
  rarity: 2}, {
  id: 70, 
  name: "ìš°ì¸ ë™", 
  type1: "í’€", 
  type2: "ë…", 
  basePower: 65, 
  rarity: 2}, {
  id: 71, 
  name: "ìš°ì¸ ë³´íŠ¸", 
  type1: "í’€", 
  type2: "ë…", 
  basePower: 88, 
  rarity: 4}, {
  id: 72, 
  name: "ì™•ëˆˆí•´", 
  type1: "ë¬¼", 
  type2: "ë…", 
  basePower: 40, 
  rarity: 2}, {
  id: 73, 
  name: "ë…íŒŒë¦¬", 
  type1: "ë¬¼", 
  type2: "ë…", 
  basePower: 75, 
  rarity: 3}, {
  id: 74, 
  name: "ê¼¬ë§ˆëŒ", 
  type1: "ë°”ìœ„", 
  type2: "ë•…", 
  basePower: 50, 
  rarity: 2}, {
  id: 75, 
  name: "ë°êµ¬ë¦¬", 
  type1: "ë°”ìœ„", 
  type2: "ë•…", 
  basePower: 70, 
  rarity: 3}, {
  id: 76, 
  name: "ë”±êµ¬ë¦¬", 
  type1: "ë°”ìœ„", 
  type2: "ë•…", 
  basePower: 90, 
  rarity: 4}, {
  id: 77, 
  name: "í¬ë‹ˆíƒ€", 
  type1: "ë¶ˆ", 
  type2: null, 
  basePower: 55, 
  rarity: 2}, {
  id: 78, 
  name: "ë‚ ìŒ©ë§ˆ", 
  type1: "ë¶ˆ", 
  type2: null, 
  basePower: 85, 
  rarity: 3}, {
  id: 79, 
  name: "ì•¼ëˆ", 
  type1: "ë¬¼", 
  type2: "ì—ìŠ¤í¼", 
  basePower: 45, 
  rarity: 2}, {
  id: 80, 
  name: "ì•¼ë„ë€", 
  type1: "ë¬¼", 
  type2: "ì—ìŠ¤í¼", 
  basePower: 80, 
  rarity: 3}, {
  id: 81, 
  name: "ì½”ì¼", 
  type1: "ì „ê¸°", 
  type2: "ê°•ì² ", 
  basePower: 45, 
  rarity: 2}, {
  id: 82, 
  name: "ë ˆì–´ì½”ì¼", 
  type1: "ì „ê¸°", 
  type2: "ê°•ì² ", 
  basePower: 78, 
  rarity: 3}, {
  id: 83, 
  name: "íŒŒì˜¤ë¦¬", 
  type1: "ë…¸ë§", 
  type2: "ë¹„í–‰", 
  basePower: 65, 
  rarity: 3}, {
  id: 84, 
  name: "ë‘ë‘", 
  type1: "ë…¸ë§", 
  type2: "ë¹„í–‰", 
  basePower: 45, 
  rarity: 2}, {
  id: 85, 
  name: "ë‘íŠ¸ë¦¬ì˜¤", 
  type1: "ë…¸ë§", 
  type2: "ë¹„í–‰", 
  basePower: 78, 
  rarity: 3}, {
  id: 86, 
  name: "ì¥¬ì¥¬", 
  type1: "ë¬¼", 
  type2: null, 
  basePower: 45, 
  rarity: 2}, {
  id: 87, 
  name: "ì¥¬ë ˆê³¤", 
  type1: "ë¬¼", 
  type2: "ì–¼ìŒ", 
  basePower: 82, 
  rarity: 4}, {
  id: 88, 
  name: "ì§ˆí½ì´", 
  type1: "ë…", 
  type2: null, 
  basePower: 45, 
  rarity: 2}, {
  id: 89, 
  name: "ì§ˆë»ê¸°", 
  type1: "ë…", 
  type2: null, 
  basePower: 78, 
  rarity: 3}, {
  id: 90, 
  name: "ì…€ëŸ¬", 
  type1: "ë¬¼", 
  type2: null, 
  basePower: 40, 
  rarity: 2}, {
  id: 91, 
  name: "íŒŒë¥´ì…€", 
  type1: "ë¬¼", 
  type2: "ì–¼ìŒ", 
  basePower: 85, 
  rarity: 4}, {
  id: 92, 
  name: "ê³ ì˜¤ìŠ¤", 
  type1: "ê³ ìŠ¤íŠ¸", 
  type2: "ë…", 
  basePower: 45, 
  rarity: 3}, {
  id: 93, 
  name: "ê³ ìš°ìŠ¤íŠ¸", 
  type1: "ê³ ìŠ¤íŠ¸", 
  type2: "ë…", 
  basePower: 68, 
  rarity: 3}, {
  id: 94, 
  name: "íŒ¬í…€", 
  type1: "ê³ ìŠ¤íŠ¸", 
  type2: "ë…", 
  basePower: 90, 
  rarity: 4}, {
  id: 95, 
  name: "ë¡±ìŠ¤í†¤", 
  type1: "ë°”ìœ„", 
  type2: "ë•…", 
  basePower: 80, 
  rarity: 4}, {
  id: 96, 
  name: "ìŠ¬ë¦¬í”„", 
  type1: "ì—ìŠ¤í¼", 
  type2: null, 
  basePower: 45, 
  rarity: 2}, {
  id: 97, 
  name: "ìŠ¬ë¦¬í¼", 
  type1: "ì—ìŠ¤í¼", 
  type2: null, 
  basePower: 78, 
  rarity: 3}, {
  id: 98, 
  name: "í¬ë©", 
  type1: "ë¬¼", 
  type2: null, 
  basePower: 50, 
  rarity: 2}, {
  id: 99, 
  name: "í‚¹í¬ë©", 
  type1: "ë¬¼", 
  type2: null, 
  basePower: 85, 
  rarity: 3}, {
  id: 100, 
  name: "ì°Œë¦¬ë¦¬ê³µ", 
  type1: "ì „ê¸°", 
  type2: null, 
  basePower: 45, 
  rarity: 2}, {
  id: 101, 
  name: "ë¶ë³¼", 
  type1: "ì „ê¸°", 
  type2: null, 
  basePower: 80, 
  rarity: 3}, {
  id: 102, 
  name: "ì•„ë¼ë¦¬", 
  type1: "í’€", 
  type2: "ì—ìŠ¤í¼", 
  basePower: 45, 
  rarity: 2}, {
  id: 103, 
  name: "ë‚˜ì‹œ", 
  type1: "í’€", 
  type2: "ì—ìŠ¤í¼", 
  basePower: 85, 
  rarity: 3}, {
  id: 104, 
  name: "íƒ•êµ¬ë¦¬", 
  type1: "ë•…", 
  type2: null, 
  basePower: 50, 
  rarity: 2}, {
  id: 105, 
  name: "í……êµ¬ë¦¬", 
  type1: "ë•…", 
  type2: null, 
  basePower: 82, 
  rarity: 3}, {
  id: 106, 
  name: "ì‹œë¼ì†Œëª¬", 
  type1: "ê²©íˆ¬", 
  type2: null, 
  basePower: 85, 
  rarity: 4}, {
  id: 107, 
  name: "í™ìˆ˜ëª¬", 
  type1: "ê²©íˆ¬", 
  type2: null, 
  basePower: 85, 
  rarity: 4}, {
  id: 108, 
  name: "ë‚´ë£¨ë¯¸", 
  type1: "ë…¸ë§", 
  type2: null, 
  basePower: 70, 
  rarity: 3}, {
  id: 109, 
  name: "ë˜ê°€ìŠ¤", 
  type1: "ë…", 
  type2: null, 
  basePower: 45, 
  rarity: 2}, {
  id: 110, 
  name: "ë˜ë„ê°€ìŠ¤", 
  type1: "ë…", 
  type2: null, 
  basePower: 80, 
  rarity: 3}, {
  id: 111, 
  name: "ë¿”ì¹´ë…¸", 
  type1: "ë•…", 
  type2: "ë°”ìœ„", 
  basePower: 60, 
  rarity: 3}, {
  id: 112, 
  name: "ì½”ë¿Œë¦¬", 
  type1: "ë•…", 
  type2: "ë°”ìœ„", 
  basePower: 88, 
  rarity: 4}, {
  id: 113, 
  name: "ëŸ­í‚¤", 
  type1: "ë…¸ë§", 
  type2: null, 
  basePower: 70, 
  rarity: 4}, {
  id: 114, 
  name: "ë©ì¿ ë¦¬", 
  type1: "í’€", 
  type2: null, 
  basePower: 70, 
  rarity: 3}, {
  id: 115, 
  name: "ìº¥ì¹´", 
  type1: "ë…¸ë§", 
  type2: null, 
  basePower: 88, 
  rarity: 4}, {
  id: 116, 
  name: "ì˜ë“œë¼", 
  type1: "ë¬¼", 
  type2: null, 
  basePower: 45, 
  rarity: 2}, {
  id: 117, 
  name: "ì‹œë“œë¼", 
  type1: "ë¬¼", 
  type2: null, 
  basePower: 80, 
  rarity: 3}, {
  id: 118, 
  name: "ì½˜ì¹˜", 
  type1: "ë¬¼", 
  type2: null, 
  basePower: 45, 
  rarity: 2}, {
  id: 119, 
  name: "ì™•ì½˜ì¹˜", 
  type1: "ë¬¼", 
  type2: null, 
  basePower: 80, 
  rarity: 3}, {
  id: 120, 
  name: "ë³„ê°€ì‚¬ë¦¬", 
  type1: "ë¬¼", 
  type2: null, 
  basePower: 45, 
  rarity: 2}, {
  id: 121, 
  name: "ì•„ì¿ ìŠ¤íƒ€", 
  type1: "ë¬¼", 
  type2: "ì—ìŠ¤í¼", 
  basePower: 82, 
  rarity: 4}, {
  id: 122, 
  name: "ë§ˆì„ë§¨", 
  type1: "ì—ìŠ¤í¼", 
  type2: "í˜ì–´ë¦¬", 
  basePower: 78, 
  rarity: 4}, {
  id: 123, 
  name: "ìŠ¤ë¼í¬", 
  type1: "ë²Œë ˆ", 
  type2: "ë¹„í–‰", 
  basePower: 85, 
  rarity: 4}, {
  id: 124, 
  name: "ë£¨ì£¼ë¼", 
  type1: "ì–¼ìŒ", 
  type2: "ì—ìŠ¤í¼", 
  basePower: 80, 
  rarity: 4}, {
  id: 125, 
  name: "ì—ë ˆë¸Œ", 
  type1: "ì „ê¸°", 
  type2: null, 
  basePower: 82, 
  rarity: 4}, {
  id: 126, 
  name: "ë§ˆê·¸ë§ˆ", 
  type1: "ë¶ˆ", 
  type2: null, 
  basePower: 82, 
  rarity: 4}, {
  id: 127, 
  name: "ì˜ì‚¬ì´ì €", 
  type1: "ë²Œë ˆ", 
  type2: null, 
  basePower: 88, 
  rarity: 4}, {
  id: 128, 
  name: "ì¼„íƒ€ë¡œìŠ¤", 
  type1: "ë…¸ë§", 
  type2: null, 
  basePower: 85, 
  rarity: 4}, {
  id: 129, 
  name: "ì‰ì–´í‚¹", 
  type1: "ë¬¼", 
  type2: null, 
  basePower: 20, 
  rarity: 2}, {
  id: 130, 
  name: "ê°¸ë¼ë„ìŠ¤", 
  type1: "ë¬¼", 
  type2: "ë¹„í–‰", 
  basePower: 95, 
  rarity: 4}, {
  id: 131, 
  name: "ë¼í”„ë¼ìŠ¤", 
  type1: "ë¬¼", 
  type2: "ì–¼ìŒ", 
  basePower: 92, 
  rarity: 5}, {
  id: 132, 
  name: "ë©”íƒ€ëª½", 
  type1: "ë…¸ë§", 
  type2: null, 
  basePower: 60, 
  rarity: 4}, {
  id: 133, 
  name: "ì´ë¸Œì´", 
  type1: "ë…¸ë§", 
  type2: null, 
  basePower: 55, 
  rarity: 4}, {
  id: 134, 
  name: "ìƒ¤ë¯¸ë“œ", 
  type1: "ë¬¼", 
  type2: null, 
  basePower: 88, 
  rarity: 5}, {
  id: 135, 
  name: "ì¥¬í”¼ì¬ë”", 
  type1: "ì „ê¸°", 
  type2: null, 
  basePower: 88, 
  rarity: 5}, {
  id: 136, 
  name: "ë¶€ìŠ¤í„°", 
  type1: "ë¶ˆ", 
  type2: null, 
  basePower: 88, 
  rarity: 5}, {
  id: 137, 
  name: "í´ë¦¬ê³¤", 
  type1: "ë…¸ë§", 
  type2: null, 
  basePower: 70, 
  rarity: 4}, {
  id: 138, 
  name: "ì•”ë‚˜ì´íŠ¸", 
  type1: "ë°”ìœ„", 
  type2: "ë¬¼", 
  basePower: 60, 
  rarity: 4}, {
  id: 139, 
  name: "ì•”ìŠ¤íƒ€", 
  type1: "ë°”ìœ„", 
  type2: "ë¬¼", 
  basePower: 88, 
  rarity: 5}, {
  id: 140, 
  name: "íˆ¬êµ¬", 
  type1: "ë°”ìœ„", 
  type2: "ë¬¼", 
  basePower: 60, 
  rarity: 4}, {
  id: 141, 
  name: "íˆ¬êµ¬í‘¸ìŠ¤", 
  type1: "ë°”ìœ„", 
  type2: "ë¬¼", 
  basePower: 88, 
  rarity: 5}, {
  id: 142, 
  name: "í”„í…Œë¼", 
  type1: "ë°”ìœ„", 
  type2: "ë¹„í–‰", 
  basePower: 95, 
  rarity: 5}, {
  id: 143, 
  name: "ì ë§Œë³´", 
  type1: "ë…¸ë§", 
  type2: null, 
  basePower: 92, 
  rarity: 5}, {
  id: 144, 
  name: "í”„ë¦¬ì ¸", 
  type1: "ì–¼ìŒ", 
  type2: "ë¹„í–‰", 
  basePower: 110, 
  rarity: 5}, {
  id: 145, 
  name: "ì¬ë”", 
  type1: "ì „ê¸°", 
  type2: "ë¹„í–‰", 
  basePower: 110, 
  rarity: 5}, {
  id: 146, 
  name: "íŒŒì´ì–´", 
  type1: "ë¶ˆ", 
  type2: "ë¹„í–‰", 
  basePower: 110, 
  rarity: 5}, {
  id: 147, 
  name: "ë¯¸ë‡½", 
  type1: "ë“œë˜ê³¤", 
  type2: null, 
  basePower: 50, 
  rarity: 4}, {
  id: 148, 
  name: "ì‹ ë‡½", 
  type1: "ë“œë˜ê³¤", 
  type2: null, 
  basePower: 78, 
  rarity: 5}, {
  id: 149, 
  name: "ë§ë‚˜ë‡½", 
  type1: "ë“œë˜ê³¤", 
  type2: "ë¹„í–‰", 
  basePower: 112, 
  rarity: 5}, {
  id: 150, 
  name: "ë®¤ì¸ ", 
  type1: "ì—ìŠ¤í¼", 
  type2: null, 
  basePower: 120, 
  rarity: 5}, {
  id: 151, 
  name: "ë®¤", 
  type1: "ì—ìŠ¤í¼", 
  type2: null, 
  basePower: 115, 
  rarity: 5}];
// -------------------- 2ì„¸ëŒ€(í™•ì¥) ìƒ˜í”Œ DB --------------------
var POKEMON_DB_GEN2 = [{
  id: 152, 
  name: "ì¹˜ì½”ë¦¬íƒ€", 
  type1: "í’€", 
  type2: null, 
  basePower: 45, 
  rarity: 2}, {
  id: 153, 
  name: "ë² ì´ë¦¬í”„", 
  type1: "í’€", 
  type2: null, 
  basePower: 62, 
  rarity: 3}, {
  id: 154, 
  name: "ë©”ê°€ë‹ˆì›€", 
  type1: "í’€", 
  type2: null, 
  basePower: 82, 
  rarity: 4}, {
  id: 155, 
  name: "ë¸Œì¼€ì¸", 
  type1: "ë¶ˆ", 
  type2: null, 
  basePower: 46, 
  rarity: 2}, {
  id: 156, 
  name: "ë§ˆê·¸ì¼€ì¸", 
  type1: "ë¶ˆ", 
  type2: null, 
  basePower: 64, 
  rarity: 3}, {
  id: 157, 
  name: "ë¸”ë ˆì´ë²”", 
  type1: "ë¶ˆ", 
  type2: null, 
  basePower: 84, 
  rarity: 4}, {
  id: 158, 
  name: "ë¦¬ì•„ì½”", 
  type1: "ë¬¼", 
  type2: null, 
  basePower: 50, 
  rarity: 2}, {
  id: 159, 
  name: "ì—˜ë¦¬ê²Œì´", 
  type1: "ë¬¼", 
  type2: null, 
  basePower: 65, 
  rarity: 3}, {
  id: 160, 
  name: "ì¥í¬ë¡œë‹¤ì¼", 
  type1: "ë¬¼", 
  type2: null, 
  basePower: 85, 
  rarity: 4}, {
  id: 161, 
  name: "ê¼¬ë¦¬ì„ ", 
  type1: "ë…¸ë§", 
  type2: null, 
  basePower: 35, 
  rarity: 1}, {
  id: 162, 
  name: "ë‹¤ê¼¬ë¦¬", 
  type1: "ë…¸ë§", 
  type2: null, 
  basePower: 76, 
  rarity: 2}, {
  id: 163, 
  name: "ë¶€ìš°ë¶€", 
  type1: "ë…¸ë§", 
  type2: "ë¹„í–‰", 
  basePower: 35, 
  rarity: 1}, {
  id: 164, 
  name: "ì•¼ë¶€ì—‰", 
  type1: "ë…¸ë§", 
  type2: "ë¹„í–‰", 
  basePower: 76, 
  rarity: 2}, {
  id: 165, 
  name: "ë ˆë””ë°”", 
  type1: "ë²Œë ˆ", 
  type2: "ë¹„í–‰", 
  basePower: 20, 
  rarity: 1}, {
  id: 166, 
  name: "ë ˆë””ì•ˆ", 
  type1: "ë²Œë ˆ", 
  type2: "ë¹„í–‰", 
  basePower: 35, 
  rarity: 2}, {
  id: 167, 
  name: "í˜ì´ê²€", 
  type1: "ë²Œë ˆ", 
  type2: "ë…", 
  basePower: 30, 
  rarity: 1}, {
  id: 168, 
  name: "ì•„ë¦¬ì•„ë„ìŠ¤", 
  type1: "ë²Œë ˆ", 
  type2: "ë…", 
  basePower: 60, 
  rarity: 2}, {
  id: 169, 
  name: "í¬ë¡œë±ƒ", 
  type1: "ë…", 
  type2: "ë¹„í–‰", 
  basePower: 90, 
  rarity: 4}, {
  id: 170, 
  name: "ì´ˆë¼ê¸°", 
  type1: "ë¬¼", 
  type2: "ì „ê¸°", 
  basePower: 38, 
  rarity: 2}, {
  id: 171, 
  name: "ëœí„´", 
  type1: "ë¬¼", 
  type2: "ì „ê¸°", 
  basePower: 76, 
  rarity: 3}, {
  id: 172, 
  name: "í”¼ì¸„", 
  type1: "ì „ê¸°", 
  type2: null, 
  basePower: 20, 
  rarity: 2}, {
  id: 173, 
  name: "ì‚", 
  type1: "í˜ì–´ë¦¬", 
  type2: null, 
  basePower: 25, 
  rarity: 2}, {
  id: 174, 
  name: "í‘¸í‘¸ë¦°", 
  type1: "ë…¸ë§", 
  type2: "í˜ì–´ë¦¬", 
  basePower: 30, 
  rarity: 2}, {
  id: 175, 
  name: "í† ê²Œí”¼", 
  type1: "í˜ì–´ë¦¬", 
  type2: null, 
  basePower: 20, 
  rarity: 2}, {
  id: 176, 
  name: "í† ê²Œí‹±", 
  type1: "í˜ì–´ë¦¬", 
  type2: "ë¹„í–‰", 
  basePower: 40, 
  rarity: 3}, {
  id: 177, 
  name: "ë„¤ì´í‹°", 
  type1: "ì—ìŠ¤í¼", 
  type2: "ë¹„í–‰", 
  basePower: 35, 
  rarity: 2}, {
  id: 178, 
  name: "ë„¤ì´í‹°ì˜¤", 
  type1: "ì—ìŠ¤í¼", 
  type2: "ë¹„í–‰", 
  basePower: 75, 
  rarity: 3}, {
  id: 179, 
  name: "ë©”ë¦¬í”„", 
  type1: "ì „ê¸°", 
  type2: null, 
  basePower: 40, 
  rarity: 2}, {
  id: 180, 
  name: "ë³´ì†¡ì†¡", 
  type1: "ì „ê¸°", 
  type2: null, 
  basePower: 55, 
  rarity: 2}, {
  id: 181, 
  name: "ì „ë£¡", 
  type1: "ì „ê¸°", 
  type2: null, 
  basePower: 83, 
  rarity: 4}, {
  id: 182, 
  name: "ì•„ë¥´ì½”", 
  type1: "í’€", 
  type2: null, 
  basePower: 80, 
  rarity: 4}, {
  id: 183, 
  name: "ë§ˆë¦´", 
  type1: "ë¬¼", 
  type2: "í˜ì–´ë¦¬", 
  basePower: 20, 
  rarity: 2}, {
  id: 184, 
  name: "ë§ˆë¦´ë¦¬", 
  type1: "ë¬¼", 
  type2: "í˜ì–´ë¦¬", 
  basePower: 50, 
  rarity: 3}, {
  id: 185, 
  name: "ê¼¬ì§€ëª¨", 
  type1: "ë°”ìœ„", 
  type2: null, 
  basePower: 80, 
  rarity: 3}, {
  id: 186, 
  name: "ì™•êµ¬ë¦¬", 
  type1: "ë¬¼", 
  type2: null, 
  basePower: 75, 
  rarity: 4}, {
  id: 187, 
  name: "í†µí†µì½”", 
  type1: "í’€", 
  type2: "ë¹„í–‰", 
  basePower: 35, 
  rarity: 2}, {
  id: 188, 
  name: "ë‘ì½”", 
  type1: "í’€", 
  type2: "ë¹„í–‰", 
  basePower: 45, 
  rarity: 2}, {
  id: 189, 
  name: "ì†œì†œì½”", 
  type1: "í’€", 
  type2: "ë¹„í–‰", 
  basePower: 55, 
  rarity: 3}, {
  id: 190, 
  name: "ì—ì´íŒœ", 
  type1: "ë…¸ë§", 
  type2: null, 
  basePower: 70, 
  rarity: 2}, {
  id: 191, 
  name: "í•´ë„ˆì¸ ", 
  type1: "í’€", 
  type2: null, 
  basePower: 30, 
  rarity: 1}, {
  id: 192, 
  name: "í•´ë£¨ë¯¸", 
  type1: "í’€", 
  type2: null, 
  basePower: 75, 
  rarity: 2}, {
  id: 193, 
  name: "ì™•ìë¦¬", 
  type1: "ë²Œë ˆ", 
  type2: "ë¹„í–‰", 
  basePower: 65, 
  rarity: 3}, {
  id: 194, 
  name: "ìš°íŒŒ", 
  type1: "ë¬¼", 
  type2: "ë•…", 
  basePower: 45, 
  rarity: 2}, {
  id: 195, 
  name: "ëˆ„ì˜¤", 
  type1: "ë¬¼", 
  type2: "ë•…", 
  basePower: 85, 
  rarity: 3}, {
  id: 196, 
  name: "ì—ë¸Œì´", 
  type1: "ì—ìŠ¤í¼", 
  type2: null, 
  basePower: 90, 
  rarity: 4}, {
  id: 197, 
  name: "ë¸”ë˜í‚¤", 
  type1: "ì•…", 
  type2: null, 
  basePower: 85, 
  rarity: 4}, {
  id: 198, 
  name: "ë‹ˆë¡œìš°", 
  type1: "ì•…", 
  type2: "ë¹„í–‰", 
  basePower: 85, 
  rarity: 3}, {
  id: 199, 
  name: "ì•¼ë„í‚¹", 
  type1: "ë¬¼", 
  type2: "ì—ìŠ¤í¼", 
  basePower: 75, 
  rarity: 4}, {
  id: 200, 
  name: "ë¬´ìš°ë§ˆ", 
  type1: "ê³ ìŠ¤íŠ¸", 
  type2: null, 
  basePower: 60, 
  rarity: 3}, {
  id: 201, 
  name: "ì•ˆë†", 
  type1: "ì—ìŠ¤í¼", 
  type2: null, 
  basePower: 72, 
  rarity: 3}, {
  id: 202, 
  name: "ë§ˆììš©", 
  type1: "ì—ìŠ¤í¼", 
  type2: null, 
  basePower: 33, 
  rarity: 2}, {
  id: 203, 
  name: "í‚¤ë§í‚¤", 
  type1: "ë…¸ë§", 
  type2: "ì—ìŠ¤í¼", 
  basePower: 80, 
  rarity: 3}, {
  id: 204, 
  name: "í”¼ì½˜", 
  type1: "ë²Œë ˆ", 
  type2: null, 
  basePower: 35, 
  rarity: 2}, {
  id: 205, 
  name: "ì˜ì½˜", 
  type1: "ë²Œë ˆ", 
  type2: "ê°•ì² ", 
  basePower: 90, 
  rarity: 3}, {
  id: 206, 
  name: "ë…¸ê³ ì¹˜", 
  type1: "ë…¸ë§", 
  type2: null, 
  basePower: 70, 
  rarity: 2}, {
  id: 207, 
  name: "ê¸€ë¼ì´ê±°", 
  type1: "ë•…", 
  type2: "ë¹„í–‰", 
  basePower: 75, 
  rarity: 3}, {
  id: 208, 
  name: "ê°•ì² í†¤", 
  type1: "ê°•ì² ", 
  type2: "ë•…", 
  basePower: 85, 
  rarity: 4}, {
  id: 209, 
  name: "ë¸”ë£¨", 
  type1: "í˜ì–´ë¦¬", 
  type2: null, 
  basePower: 40, 
  rarity: 2}, {
  id: 210, 
  name: "ê·¸ë‘ë¸”ë£¨", 
  type1: "í˜ì–´ë¦¬", 
  type2: null, 
  basePower: 75, 
  rarity: 3}, {
  id: 211, 
  name: "ì¹¨ë°”ë£¨", 
  type1: "ë¬¼", 
  type2: "ë…", 
  basePower: 95, 
  rarity: 3}, {
  id: 212, 
  name: "í•«ì‚¼", 
  type1: "ë²Œë ˆ", 
  type2: "ê°•ì² ", 
  basePower: 100, 
  rarity: 4}, {
  id: 213, 
  name: "ë‹¨ë‹¨ì§€", 
  type1: "ë²Œë ˆ", 
  type2: "ë°”ìœ„", 
  basePower: 10, 
  rarity: 2}, {
  id: 214, 
  name: "í—¤ë¼í¬ë¡œìŠ¤", 
  type1: "ë²Œë ˆ", 
  type2: "ê²©íˆ¬", 
  basePower: 85, 
  rarity: 4}, {
  id: 215, 
  name: "í¬í‘¸ë‹ˆ", 
  type1: "ì•…", 
  type2: "ì–¼ìŒ", 
  basePower: 95, 
  rarity: 3}, {
  id: 216, 
  name: "ê¹œì§€ê³°", 
  type1: "ë…¸ë§", 
  type2: null, 
  basePower: 80, 
  rarity: 2}, {
  id: 217, 
  name: "ë§ê³°", 
  type1: "ë…¸ë§", 
  type2: null, 
  basePower: 100, 
  rarity: 3}, {
  id: 218, 
  name: "ë§ˆê·¸ë§ˆê·¸", 
  type1: "ë¶ˆ", 
  type2: null, 
  basePower: 40, 
  rarity: 2}, {
  id: 219, 
  name: "ë§ˆê·¸ì¹´ë¥´ê³ ", 
  type1: "ë¶ˆ", 
  type2: "ë°”ìœ„", 
  basePower: 50, 
  rarity: 3}, {
  id: 220, 
  name: "ê¾¸ê¾¸ë¦¬", 
  type1: "ì–¼ìŒ", 
  type2: "ë•…", 
  basePower: 50, 
  rarity: 2}, {
  id: 221, 
  name: "ë©”ê¾¸ë¦¬", 
  type1: "ì–¼ìŒ", 
  type2: "ë•…", 
  basePower: 100, 
  rarity: 3}, {
  id: 222, 
  name: "ì½”ì‚°í˜¸", 
  type1: "ë¬¼", 
  type2: "ë°”ìœ„", 
  basePower: 55, 
  rarity: 2}, {
  id: 223, 
  name: "ì´ì–´", 
  type1: "ë¬¼", 
  type2: null, 
  basePower: 65, 
  rarity: 2}, {
  id: 224, 
  name: "ëŒ€í¬ë¬´ë…¸", 
  type1: "ë¬¼", 
  type2: null, 
  basePower: 105, 
  rarity: 3}, {
  id: 225, 
  name: "ë”œë¦¬ë²„ë“œ", 
  type1: "ì–¼ìŒ", 
  type2: "ë¹„í–‰", 
  basePower: 55, 
  rarity: 2}, {
  id: 226, 
  name: "ë§Œíƒ€ì¸", 
  type1: "ë¬¼", 
  type2: "ë¹„í–‰", 
  basePower: 40, 
  rarity: 3}, {
  id: 227, 
  name: "ë¬´ì¥ì¡°", 
  type1: "ê°•ì² ", 
  type2: "ë¹„í–‰", 
  basePower: 80, 
  rarity: 3}, {
  id: 228, 
  name: "ë¸ë¹Œ", 
  type1: "ì•…", 
  type2: "ë¶ˆ", 
  basePower: 60, 
  rarity: 2}, {
  id: 229, 
  name: "í—¬ê°€", 
  type1: "ì•…", 
  type2: "ë¶ˆ", 
  basePower: 90, 
  rarity: 4}, {
  id: 230, 
  name: "í‚¹ë“œë¼", 
  type1: "ë¬¼", 
  type2: "ë“œë˜ê³¤", 
  basePower: 95, 
  rarity: 4}, {
  id: 231, 
  name: "ì½”ì½”ë¦¬", 
  type1: "ë•…", 
  type2: null, 
  basePower: 45, 
  rarity: 2}, {
  id: 232, 
  name: "ì½”ë¦¬ê°‘", 
  type1: "ë•…", 
  type2: null, 
  basePower: 90, 
  rarity: 3}, {
  id: 233, 
  name: "í´ë¦¬ê³¤2", 
  type1: "ë…¸ë§", 
  type2: null, 
  basePower: 80, 
  rarity: 4}, {
  id: 234, 
  name: "ë…¸ë¼í‚¤", 
  type1: "ë…¸ë§", 
  type2: null, 
  basePower: 95, 
  rarity: 3}, {
  id: 235, 
  name: "ë£¨ë¸Œë„", 
  type1: "ë…¸ë§", 
  type2: null, 
  basePower: 20, 
  rarity: 2}, {
  id: 236, 
  name: "ë°°ë£¨í‚¤", 
  type1: "ê²©íˆ¬", 
  type2: null, 
  basePower: 35, 
  rarity: 2}, {
  id: 237, 
  name: "ì¹´í¬ì—ë¼", 
  type1: "ê²©íˆ¬", 
  type2: null, 
  basePower: 95, 
  rarity: 3}, {
  id: 238, 
  name: "ë½€ë½€ë¼", 
  type1: "ì–¼ìŒ", 
  type2: "ì—ìŠ¤í¼", 
  basePower: 30, 
  rarity: 2}, {
  id: 239, 
  name: "ì—ë ˆí‚¤ë“œ", 
  type1: "ì „ê¸°", 
  type2: null, 
  basePower: 63, 
  rarity: 2}, {
  id: 240, 
  name: "ë§ˆê·¸ë¹„", 
  type1: "ë¶ˆ", 
  type2: null, 
  basePower: 75, 
  rarity: 2}, {
  id: 241, 
  name: "ë°€íƒ±í¬", 
  type1: "ë…¸ë§", 
  type2: null, 
  basePower: 80, 
  rarity: 3}, {
  id: 242, 
  name: "í•´í”¼ë„ˆìŠ¤", 
  type1: "ë…¸ë§", 
  type2: null, 
  basePower: 10, 
  rarity: 4}, {
  id: 243, 
  name: "ë¼ì´ì½”", 
  type1: "ì „ê¸°", 
  type2: null, 
  basePower: 115, 
  rarity: 5}, {
  id: 244, 
  name: "ì—”í…Œì´", 
  type1: "ë¶ˆ", 
  type2: null, 
  basePower: 115, 
  rarity: 5}, {
  id: 245, 
  name: "ìŠ¤ì´ì¿¤", 
  type1: "ë¬¼", 
  type2: null, 
  basePower: 95, 
  rarity: 5}, {
  id: 246, 
  name: "ì• ë²„ë¼ìŠ¤", 
  type1: "ë°”ìœ„", 
  type2: "ë•…", 
  basePower: 64, 
  rarity: 4}, {
  id: 247, 
  name: "ë°ê¸°ë¼ìŠ¤", 
  type1: "ë°”ìœ„", 
  type2: "ë•…", 
  basePower: 84, 
  rarity: 4}, {
  id: 248, 
  name: "ë§ˆê¸°ë¼ìŠ¤", 
  type1: "ë°”ìœ„", 
  type2: "ì•…", 
  basePower: 120, 
  rarity: 5}, {
  id: 249, 
  name: "ë£¨ê¸°ì•„", 
  type1: "ì—ìŠ¤í¼", 
  type2: "ë¹„í–‰", 
  basePower: 120, 
  rarity: 5}, {
  id: 250, 
  name: "ì¹ ìƒ‰ì¡°", 
  type1: "ë¶ˆ", 
  type2: "ë¹„í–‰", 
  basePower: 120, 
  rarity: 5}, {
  id: 251, 
  name: "ì„¸ë ˆë¹„", 
  type1: "ì—ìŠ¤í¼", 
  type2: "í’€", 
  basePower: 100, 
  rarity: 5}];
// ì „ì²´ í¬ì¼“ëª¬ í’€(1ì„¸ëŒ€ + 2ì„¸ëŒ€)
var ALL_POKEMON_DB = POKEMON_DB.concat(POKEMON_DB_GEN2);
// -------------------- í¬ì¼“ëª¬ DB ë¹ ë¥¸ ì¡°íšŒ ë§µ --------------------
var POKE_BY_ID = {};
for (var __i = 0; __i < ALL_POKEMON_DB.length; __i++) {
  var __p = ALL_POKEMON_DB[__i];
  if (__p && __p.id != null) 
    POKE_BY_ID[__p.id] = __p;
}
// =================================================================
// ğŸ§¬ [ìµœì¢… ë³´ì™„] ë¦¬ì–¼ ì§„í™” ë°ì´í„°ë² ì´ìŠ¤ (1ì„¸ëŒ€ & 2ì„¸ëŒ€ ì™„ê²°ë³¸)
// =================================================================
var EVOLVE_DB = {
  // --- 1ì„¸ëŒ€ ë ˆë²¨ ì§„í™” ---
  1: { to: 2, type: "level", val: 16 }, 2: { to: 3, type: "level", val: 32 }, 
  4: { to: 5, type: "level", val: 16 }, 5: { to: 6, type: "level", val: 36 }, 
  7: { to: 8, type: "level", val: 16 }, 8: { to: 9, type: "level", val: 36 }, 
  10: { to: 11, type: "level", val: 7 }, 11: { to: 12, type: "level", val: 10 }, 
  13: { to: 14, type: "level", val: 7 }, 14: { to: 15, type: "level", val: 10 }, 
  16: { to: 17, type: "level", val: 18 }, 17: { to: 18, type: "level", val: 36 }, 
  19: { to: 20, type: "level", val: 20 }, 21: { to: 22, type: "level", val: 20 }, 
  23: { to: 24, type: "level", val: 22 }, 27: { to: 28, type: "level", val: 22 }, 
  29: { to: 30, type: "level", val: 16 }, 32: { to: 33, type: "level", val: 16 }, 
  41: { to: 42, type: "level", val: 22 }, 43: { to: 44, type: "level", val: 21 }, 
  46: { to: 47, type: "level", val: 24 }, 48: { to: 49, type: "level", val: 31 }, 
  50: { to: 51, type: "level", val: 26 }, 52: { to: 53, type: "level", val: 28 }, 
  54: { to: 55, type: "level", val: 33 }, 56: { to: 57, type: "level", val: 28 }, 
  60: { to: 61, type: "level", val: 25 }, 63: { to: 64, type: "level", val: 16 }, 
  66: { to: 67, type: "level", val: 28 }, 69: { to: 70, type: "level", val: 21 }, 
  72: { to: 73, type: "level", val: 30 }, 74: { to: 75, type: "level", val: 25 }, 
  77: { to: 78, type: "level", val: 40 }, 81: { to: 82, type: "level", val: 30 }, 
  84: { to: 85, type: "level", val: 31 }, 86: { to: 87, type: "level", val: 34 }, 
  88: { to: 89, type: "level", val: 38 }, 92: { to: 93, type: "level", val: 25 }, 
  96: { to: 97, type: "level", val: 26 }, 98: { to: 99, type: "level", val: 28 }, 
  100: { to: 101, type: "level", val: 30 }, 104: { to: 105, type: "level", val: 28 }, 
  109: { to: 110, type: "level", val: 35 }, 111: { to: 112, type: "level", val: 42 }, 
  116: { to: 117, type: "level", val: 32 }, 118: { to: 119, type: "level", val: 33 }, 
  129: { to: 130, type: "level", val: 20 }, 138: { to: 139, type: "level", val: 40 }, 
  140: { to: 141, type: "level", val: 40 }, 147: { to: 148, type: "level", val: 30 }, 
  148: { to: 149, type: "level", val: 55 }, 

  // --- 2ì„¸ëŒ€ ë ˆë²¨ ì§„í™” ---
  152: { to: 153, type: "level", val: 16 }, 153: { to: 154, type: "level", val: 32 }, 
  155: { to: 156, type: "level", val: 14 }, 156: { to: 157, type: "level", val: 36 }, 
  158: { to: 159, type: "level", val: 18 }, 159: { to: 160, type: "level", val: 30 }, 
  161: { to: 162, type: "level", val: 15 }, 163: { to: 164, type: "level", val: 20 }, 
  165: { to: 166, type: "level", val: 18 }, 167: { to: 168, type: "level", val: 22 }, 
  170: { to: 171, type: "level", val: 26 }, 177: { to: 178, type: "level", val: 25 }, // ë„¤ì´í‹°
  179: { to: 180, type: "level", val: 15 }, 180: { to: 181, type: "level", val: 30 }, 
  183: { to: 184, type: "level", val: 18 }, 187: { to: 188, type: "level", val: 18 }, 
  188: { to: 189, type: "level", val: 27 }, 194: { to: 195, type: "level", val: 20 }, 
  204: { to: 205, type: "level", val: 31 }, 209: { to: 210, type: "level", val: 23 }, 
  216: { to: 217, type: "level", val: 30 }, 218: { to: 219, type: "level", val: 38 }, 
  220: { to: 221, type: "level", val: 33 }, 223: { to: 224, type: "level", val: 25 }, 
  231: { to: 232, type: "level", val: 25 }, 238: { to: 124, type: "level", val: 30 }, // ë½€ë½€ë¼
  239: { to: 125, type: "level", val: 30 }, // ì—ë ˆí‚¤ë“œ
  240: { to: 126, type: "level", val: 30 }, // ë§ˆê·¸ë¹„
  246: { to: 247, type: "level", val: 30 }, // ì• ë²„ë¼ìŠ¤
  247: { to: 248, type: "level", val: 55 }, // ë°ê¸°ë¼ìŠ¤

  // --- íŠ¹ìˆ˜ ì§„í™” (ì¹œë°€ë„) ---
  42: { to: 169, type: "friendship", val: 220 }, 113: { to: 242, type: "friendship", val: 220 }, 
  172: { to: 25, type: "friendship", val: 150 }, 173: { to: 35, type: "friendship", val: 150 }, 
  174: { to: 39, type: "friendship", val: 150 }, 175: { to: 176, type: "friendship", val: 150 }, 

  // --- ë„êµ¬ ë° í†µì‹  ì§„í™” ---
  133: [
    { to: 134, type: "item_hold", val: "ë¬¼ì˜ëŒ" }, { to: 135, type: "item_hold", val: "ì²œë‘¥ì˜ëŒ" }, 
    { to: 136, type: "item_hold", val: "ë¶ˆê½ƒì˜ëŒ" }, { to: 196, type: "friendship_day", val: 220 }, 
    { to: 197, type: "friendship_night", val: 220 }
  ], 
  25: { to: 26, type: "item_hold", val: "ì²œë‘¥ì˜ëŒ" }, 30: { to: 31, type: "item_hold", val: "ë‹¬ì˜ëŒ" }, 
  33: { to: 34, type: "item_hold", val: "ë‹¬ì˜ëŒ" }, 35: { to: 36, type: "item_hold", val: "ë‹¬ì˜ëŒ" }, 
  37: { to: 38, type: "item_hold", val: "ë¶ˆê½ƒì˜ëŒ" }, 39: { to: 40, type: "item_hold", val: "ë‹¬ì˜ëŒ" }, 
  44: [{ to: 45, type: "item_hold", val: "í’€ì˜ëŒ" }, { to: 182, type: "item_hold", val: "íƒœì–‘ì˜ëŒ" }], 
  58: { to: 59, type: "item_hold", val: "ë¶ˆê½ƒì˜ëŒ" }, 
  61: [{ to: 62, type: "item_hold", val: "ë¬¼ì˜ëŒ" }, { to: 186, type: "item_hold", val: "ì™•ì˜ì§•í‘œì„" }], 
  64: { to: 65, type: "trade", val: 0 }, 67: { to: 68, type: "trade", val: 0 }, 
  70: { to: 71, type: "item_hold", val: "í’€ì˜ëŒ" }, 75: { to: 76, type: "trade", val: 0 }, 
  79: [{ to: 80, type: "level", val: 37 }, { to: 199, type: "item_hold", val: "ì™•ì˜ì§•í‘œì„" }], 
  90: { to: 91, type: "item_hold", val: "ë¬¼ì˜ëŒ" }, 93: { to: 94, type: "trade", val: 0 }, 
  95: { to: 208, type: "item_hold", val: "ê¸ˆì†ì½”íŠ¸" }, 102: { to: 103, type: "item_hold", val: "í’€ì˜ëŒ" }, 
  117: { to: 230, type: "item_hold", val: "ìš©ì˜ë¹„ëŠ˜" }, 120: { to: 121, type: "item_hold", val: "ë¬¼ì˜ëŒ" }, 
  123: { to: 212, type: "item_hold", val: "ê¸ˆì†ì½”íŠ¸" }, 137: { to: 233, type: "item_hold", val: "ì—…ê·¸ë ˆì´ë“œ" }, 
  191: { to: 192, type: "item_hold", val: "íƒœì–‘ì˜ëŒ" },
  236: [ // ë°°ë£¨í‚¤ (ë¶„ê¸° ì§„í™”)
    { to: 106, type: "level", val: 20 }, { to: 107, type: "level", val: 20 }, { to: 237, type: "level", val: 20 }
  ]
};
 

// -------------------- íƒ€ì… ìƒì„±í‘œ(ê°„ë‹¨) --------------------
var TYPE_CHART = {
  "ë¶ˆ": {
  "í’€": 2, 
  "ë²Œë ˆ": 2, 
  "ì–¼ìŒ": 2, 
  "ë¬¼": 0.5, 
  "ë°”ìœ„": 0.5, 
  "ë“œë˜ê³¤": 0.5}, 
  "ë¬¼": {
  "ë¶ˆ": 2, 
  "ë•…": 2, 
  "ë°”ìœ„": 2, 
  "í’€": 0.5, 
  "ë“œë˜ê³¤": 0.5}, 
  "í’€": {
  "ë¬¼": 2, 
  "ë•…": 2, 
  "ë°”ìœ„": 2, 
  "ë¶ˆ": 0.5, 
  "í’€": 0.5, 
  "ë…": 0.5, 
  "ë²Œë ˆ": 0.5, 
  "ë“œë˜ê³¤": 0.5, 
  "ë¹„í–‰": 0.5}, 
  "ì „ê¸°": {
  "ë¬¼": 2, 
  "ë¹„í–‰": 2, 
  "ì „ê¸°": 0.5, 
  "í’€": 0.5, 
  "ë“œë˜ê³¤": 0.5, 
  "ë•…": 0}, 
  "ì–¼ìŒ": {
  "í’€": 2, 
  "ë•…": 2, 
  "ë¹„í–‰": 2, 
  "ë“œë˜ê³¤": 2, 
  "ë¶ˆ": 0.5, 
  "ë¬¼": 0.5, 
  "ì–¼ìŒ": 0.5}, 
  "ê²©íˆ¬": {
  "ë…¸ë§": 2, 
  "ë°”ìœ„": 2, 
  "ì–¼ìŒ": 2, 
  "ë…": 0.5, 
  "ë¹„í–‰": 0.5, 
  "ì—ìŠ¤í¼": 0.5, 
  "í˜ì–´ë¦¬": 0.5, 
  "ê³ ìŠ¤íŠ¸": 0}, 
  "ë…": {
  "í’€": 2, 
  "í˜ì–´ë¦¬": 2, 
  "ë…": 0.5, 
  "ë•…": 0.5, 
  "ë°”ìœ„": 0.5, 
  "ê³ ìŠ¤íŠ¸": 0.5}, 
  "ë•…": {
  "ë¶ˆ": 2, 
  "ì „ê¸°": 2, 
  "ë…": 2, 
  "ë°”ìœ„": 2, 
  "í’€": 0.5, 
  "ë²Œë ˆ": 0.5, 
  "ë¹„í–‰": 0}, 
  "ë¹„í–‰": {
  "í’€": 2, 
  "ê²©íˆ¬": 2, 
  "ë²Œë ˆ": 2, 
  "ì „ê¸°": 0.5, 
  "ë°”ìœ„": 0.5}, 
  "ë²Œë ˆ": {
  "í’€": 2, 
  "ì—ìŠ¤í¼": 2, 
  "ë¶ˆ": 0.5, 
  "ê²©íˆ¬": 0.5, 
  "ë¹„í–‰": 0.5, 
  "ê³ ìŠ¤íŠ¸": 0.5}, 
  "ë°”ìœ„": {
  "ë¶ˆ": 2, 
  "ì–¼ìŒ": 2, 
  "ë¹„í–‰": 2, 
  "ë²Œë ˆ": 2, 
  "ê²©íˆ¬": 0.5, 
  "ë•…": 0.5}, 
  "ê³ ìŠ¤íŠ¸": {
  "ê³ ìŠ¤íŠ¸": 2, 
  "ì—ìŠ¤í¼": 2, 
  "ë…¸ë§": 0}, 
  "ë“œë˜ê³¤": {
  "ë“œë˜ê³¤": 2}, 
  "ì—ìŠ¤í¼": {
  "ê²©íˆ¬": 2, 
  "ë…": 2, 
  "ì—ìŠ¤í¼": 0.5}, 
  "í˜ì–´ë¦¬": {
  "ê²©íˆ¬": 2, 
  "ë“œë˜ê³¤": 2, 
  "ë¶ˆ": 0.5, 
  "ë…": 0.5}};
// -------------------- íŒŒì¼ IO (í™˜ê²½ë³„ë¡œ êµì²´) --------------------
function readFile(path) {
  try {
    var file = new java.io.File(path);
    if (!file.exists()) 
      return null;
    var fis = new java.io.FileInputStream(file);
    var isr = new java.io.InputStreamReader(fis, "UTF-8");
    var br = new java.io.BufferedReader(isr);
    var sb = "";
    var line = null;
    while ((line = br.readLine()) !== null) 
      sb += line;
    br.close();
    isr.close();
    fis.close();
    return sb;
  }  catch (e) {
  return null;
}
}
function writeFile(path, text) {
  try {
    var file = new java.io.File(path);
    var parent = file.getParentFile();
    if (parent && !parent.exists()) 
      parent.mkdirs();
    var fos = new java.io.FileOutputStream(file);
    var osw = new java.io.OutputStreamWriter(fos, "UTF-8");
    osw.write(text);
    osw.close();
    fos.close();
    return true;
  }  catch (e) {
  return false;
}
}
// -------------------- ë°ì´í„° ë¡œë“œ/ì„¸ì´ë¸Œ --------------------
function loadData() {
  var raw = readFile(DATA_PATH);
  if (!raw) {
    return {
  users: {}, 
  lastSpawnByRoom: {}, 
  regionByRoom: {}};
  }
  try {
    var d = JSON.parse(raw);
    if (!d.users) 
      d.users = {};
    if (!d.lastSpawnByRoom) 
      d.lastSpawnByRoom = {};
    if (!d.regionByRoom) 
      d.regionByRoom = {};
    return d;
  }  catch (e) {
  return {
  users: {}, 
  lastSpawnByRoom: {}, 
  regionByRoom: {}};
}
}
// -------------------- ë°ì´í„° ì„¸ì´ë¸Œ --------------------
function saveData(d) {
  try {
    if (!d) 
      return false;
    return writeFile(DATA_PATH, JSON.stringify(d));
  }  catch (e) {
  return false;
}
}
// -------------------- ë°ì´í„° ìºì‹œ (í•„ìˆ˜ ìµœì í™”) --------------------
var DATA_CACHE = null;
var DATA_DIRTY = false;
var LAST_SAVE_AT = 0;
var SAVE_INTERVAL_MS = 20 * 1000;// 20ì´ˆ
function getDataCached() {
  if (DATA_CACHE) 
    return DATA_CACHE;
  DATA_CACHE = loadData();  // ê¸°ì¡´ loadData ê·¸ëŒ€ë¡œ ì‚¬ìš©
  return DATA_CACHE;
}
function markDirty() {
  DATA_DIRTY = true;
}
function flushSaveIfNeeded(force) {
  var now = nowMs();
  if (!DATA_CACHE) 
    return;
  if (force || (DATA_DIRTY && (now - LAST_SAVE_AT >= SAVE_INTERVAL_MS))) {
    saveData(DATA_CACHE);
    DATA_DIRTY = false;
    LAST_SAVE_AT = now;
  }
}
// -------------------- ì‹ ê·œ íšŒì›ê°€ì… ë³´ìƒ --------------------
function grantSignupBonusIfNeeded(u, sender) {
  if (!u.isNewUser) 
    return "";
  
  // ì´ˆê¸° ë°ì´í„°ê°€ ì—†ì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì•ˆì „ì¥ì¹˜(|| 0) ì ìš©
  u.gold = (u.gold || 0) + 10000;
  u.ball = (u.ball || 0) + 30;      // ëª¬ìŠ¤í„°ë³¼ ê¸°ì¡´ 10ê°œ -> 30ê°œë¡œ ìƒí–¥
  u.ticket = (u.ticket || 0) + 5;   // ì´ë™í‹°ì¼“ 5ì¥ ì‹ ê·œ ì¶”ê°€
  
  u.isNewUser = false;              // ì¤‘ë³µ ìˆ˜ë ¹ ë°©ì§€ í”Œë˜ê·¸ í•´ì œ
  
  return "ğŸŠ [ì‹ ì… íŠ¸ë ˆì´ë„ˆ í™˜ì˜ íŒ¨í‚¤ì§€] ğŸŠ\n" +
         "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
         sender + "ë‹˜, í¬ì¼“ëª¬ ì„¸ê³„ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!\n\n" +
         "ğŸ ì§€ê¸‰ ì•„ì´í…œ:\n" +
         "â€¢ ğŸ’° 10,000 ê³¨ë“œ\n" +
         "â€¢ ğŸ”´ ëª¬ìŠ¤í„°ë³¼ 30ê°œ\n" +
         "â€¢ ğŸ« ì´ë™í‹°ì¼“ 5ì¥\n\n" +
         "ğŸ’¡ '/ëª…ë ¹ì–´'ë¥¼ ì…ë ¥í•´ ëª¨í—˜ì„ ì‹œì‘í•´ë³´ì„¸ìš”!";
}

// -------------------- ìœ í‹¸ --------------------
function nowMs() {
  return new Date().getTime();
}
function dateKeyKST() {
  // ì„œë²„/í° íƒ€ì„ì¡´ì´ ì„ì—¬ë„ ìµœëŒ€í•œ ì•ˆì •ì ìœ¼ë¡œ "ì˜¤ëŠ˜"ì„ ë§Œë“¤ê¸° ìœ„í•´
  // ë¡œì»¬ ë‚ ì§œ ê¸°ë°˜ YYYY-MM-DDë¡œ ì €ì¥
  var d = new Date();
  var y = d.getFullYear();
  var m = d.getMonth() + 1;
  var dd = d.getDate();
  if (m < 10) 
    m = "0" + m;
  if (dd < 10) 
    dd = "0" + dd;
  return y + "-" + m + "-" + dd;
}
function ensureUserStats(u) {
  if (!u.stats) 
    u.stats = {};
  if (typeof u.stats.battleWin !== "number") 
    u.stats.battleWin = 0;
  if (typeof u.stats.battleLose !== "number") 
    u.stats.battleLose = 0;
  if (typeof u.stats.battleDraw !== "number") 
    u.stats.battleDraw = 0;
  if (typeof u.stats.battleStreak !== "number") 
    u.stats.battleStreak = 0;
  if (typeof u.stats.bestStreak !== "number") 
    u.stats.bestStreak = 0;
  if (typeof u.stats.lastBattleAt !== "number") 
    u.stats.lastBattleAt = 0;
}
function resetBattleStats(u) {
  if (!u) 
    return;
  if (!u.stats) 
    u.stats = {};
  u.stats.battleWin = 0;
  u.stats.battleLose = 0;
  u.stats.battleDraw = 0;
  u.stats.battleStreak = 0;
  u.stats.bestStreak = 0;
  u.stats.lastBattleAt = 0;
}
function resetBattleStatsAll(d) {
  if (!d || !d.users) 
    return 0;
  var cnt = 0;
  for (var name in d.users) {
    if (!d.users[name]) 
      continue;
    resetBattleStats(d.users[name]);
    cnt++;
  }
  return cnt;
}
function findPokemonDB(pid) {
  pid = parseInt(pid, 10);
  return POKE_BY_ID[pid] || null;
}
function getDisplayName(p) {
  if (!p) return "ì•Œìˆ˜ì—†ìŒ";
  
  // 1. ê¸°ë³¸ ì´ë¦„(ì›ë³¸) ê°€ì ¸ì˜¤ê¸°
  var targetId = p.pid || p.id;
  var db = findPokemonDB(targetId);
  var baseName = db ? db.name : "ì•Œìˆ˜ì—†ìŒ";
  
  // 2. ë³„ëª…ì´ ìˆìœ¼ë©´ ë³„ëª…ì„ ìš°ì„  ì‚¬ìš©
  var finalName = p.nickname || baseName;
  
  // 3. ì´ë¡œì¹˜ë©´ ë°˜ì§ì´ ì¶”ê°€
  if (p.shiny) {
    return "âœ¨" + finalName;
  }
  return finalName;
}

// í¬ì¼“ëª¬ ì´ë¦„ìœ¼ë¡œ DB ì°¾ê¸° (ìš´ì˜ì í¬ì¼“ëª¬ì§€ê¸‰ìš©)
// "ë®¤", "í”¼ì¹´ì¸„" ê°™ì€ ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰
function findPokemonDBByName(name) {
  if (!name) 
    return null;
  var key = ("" + name).trim();
  if (!key) 
    return null;
  var k = key.replace(/\s+/g, "").toLowerCase();
  // DB í›„ë³´ë“¤(ë„¤ ì½”ë“œì—ì„œ ì–´ë–¤ ì´ë¦„ì„ ì“°ë“  ìµœëŒ€í•œ ëŒ€ì‘)
  var arr = null;
  if (typeof ALL_POKEMON_DB !== "undefined" && ALL_POKEMON_DB && ALL_POKEMON_DB.length) 
    arr = ALL_POKEMON_DB;
  else if (typeof POKEMON_DB !== "undefined" && POKEMON_DB && POKEMON_DB.length) 
    arr = POKEMON_DB;
  else if (typeof pokemonDB !== "undefined" && pokemonDB && pokemonDB.length) 
    arr = pokemonDB;
  else if (typeof POKE_DB !== "undefined" && POKE_DB && POKE_DB.length) 
    arr = POKE_DB;
  else if (typeof POKEMONS !== "undefined" && POKEMONS && POKEMONS.length) 
    arr = POKEMONS;
  if (!arr) 
    return null;
  for (var i = 0; i < arr.length; i++) {
    var p = arr[i];
    if (!p) 
      continue;
    var cands = [];
    if (p.name) 
      cands.push(p.name);
    if (p.koName) 
      cands.push(p.koName);
    if (p.kor) 
      cands.push(p.kor);
    if (p.kr) 
      cands.push(p.kr);
    if (p.enName) 
      cands.push(p.enName);
    for (var j = 0; j < cands.length; j++) {
      var nm = ("" + cands[j]).trim();
      if (!nm) 
        continue;
      var nmKey = nm.replace(/\s+/g, "").toLowerCase();
      if (nmKey === k) 
        return p;
    }
  }
  return null;
}
function calcBattlePower(p) {
  var db = findPokemonDB(p.pid);
  if (!db) return 0;
  
  var base = db.basePower || 50;
  var ivBonus = (p.ivStr || 0) + (p.ivSpd || 0);

  // [ë°¸ëŸ°ìŠ¤ ì„¤ê³„]
  // 1. ë ˆë²¨: í¬ì¼“ëª¬ì˜ 'ê¸°ë³¸ ì²´ê¸‰' (Lv.100ì´ë©´ 3ë°° ê°•í•´ì§)
  var levelMul = 1 + (p.lv * 0.02); 
  
  // 2. ê°•í™”: í¬ì¼“ëª¬ì˜ 'ì¶”ê°€ ë¬´ë ¥' (1ê°•ë‹¹ 10%ì”© ë³µë¦¬ë¡œ ê°•í•´ì§)
  var enhMul = 1 + (p.enh * 0.10); 
  
  var power = Math.floor((base + ivBonus) * levelMul * enhMul);
  if (p.shiny) power = Math.floor(power * 1.2); // ì´ë¡œì¹˜ ë³´ë„ˆìŠ¤
  
  return power;
}

//ì „íˆ¬ë ¥ ê¸°ì¤€ ì •ë ¬
function sortPokemonsByPower(list) {
  return list.slice().sort(function(a, b) {
  var pa = calcBattlePower(a);
  var pb = calcBattlePower(b);
  if (pb !== pa) 
    return pb - pa;
  if ((b.enh || 0) !== (a.enh || 0)) 
    return (b.enh || 0) - (a.enh || 0);
  return a.uid - b.uid;
});
}
//ìœ ì € ë„ê° ë­í‚¹ ê³„ì‚°
function getTotalDexCount() {
  return POKEMON_DB.length;
}
function getUserDexCount(u) {
  if (!u || !u.dex) 
    return 0;
  var cnt = 0;
  // POKEMON_DB(1~151ë²ˆ)ë¼ëŠ” 'ê³µì‹ ëª©ë¡'ì„ ê¸°ì¤€ìœ¼ë¡œ í•˜ë‚˜ì”© ëŒ€ì¡°í•©ë‹ˆë‹¤.
  for (var i = 0; i < POKEMON_DB.length; i++) {
    var pid = String(POKEMON_DB[i].id);
    // ë„ê° ë°ì´í„°ì— í•´ë‹¹ ë²ˆí˜¸ê°€ ì¡´ì¬í•˜ê³ , ì¡ì€ íšŸìˆ˜(caught)ê°€ ìµœì†Œ 1íšŒ ì´ìƒì´ì–´ì•¼ ì¸ì •!
    if (u.dex[pid] && u.dex[pid].caught > 0) {
      cnt++;
    }
  }
  return cnt;
}
function getDexPercent(u) {
  var total = getTotalDexCount();
  if (total <= 0) 
    return 0;
  return Math.floor((getUserDexCount(u) / total) * 1000) / 10;
  // ì†Œìˆ˜ 1ìë¦¬
}
// [ìˆ˜ì •ë¨] ë„ê° ë­í‚¹ ë¹Œë” (1ìˆœìœ„: ë§ˆë¦¿ìˆ˜, 2ìˆœìœ„: Sê¸‰ ê°œìˆ˜)
function buildDexRankingWithMyRank(d, limit, myName) {
  limit = limit || 10;
  var list = [];
  var total = getTotalDexCount();
  for (var name in d.users) {
    if (!d.users.hasOwnProperty(name)) 
      continue;
    var u = d.users[name];
    if (!u || !u.dex) 
      continue;
    var count = 0;
    var sCount = 0;    // Së“±ê¸‰ ê°œìˆ˜
    for (var k in u.dex) {
      if (u.dex[k].caught > 0) {
        count++;
        // ì¡ì€ ê²ƒ ì¤‘ ìµœê³  ë“±ê¸‰ì´ Së¼ë©´ ì¹´ìš´íŠ¸
        if (u.dex[k].maxGrade === "S") {
          sCount++;
        }
      }
    }
    if (count <= 0) 
      continue;
    list.push({
  name: name, 
  count: count, 
  sCount: sCount, 
  percent: getDexPercent(u)});
  }
  // ì •ë ¬ ë¡œì§: ë§ˆë¦¿ìˆ˜ ë‚´ë¦¼ì°¨ìˆœ -> Sê¸‰ ê°œìˆ˜ ë‚´ë¦¼ì°¨ìˆœ -> ì´ë¦„ ì˜¤ë¦„ì°¨ìˆœ
  list.sort(function(a, b) {
  if (b.count !== a.count) 
    return b.count - a.count;
  if (b.sCount !== a.sCount) 
    return b.sCount - a.sCount;
  return String(a.name).localeCompare(String(b.name));
});
  var myIdx = -1;
  for (var i = 0; i < list.length; i++) {
    if (list[i].name === myName) {
      myIdx = i;
      break;
    }
  }
  return {
  rows: list, 
  myIdx: myIdx, 
  total: total, 
  top: list.slice(0, Math.min(limit, list.length))};
}
// ==================== [ì‹ ê·œ] ì¹­í˜¸ ë­í‚¹ ë¹Œë” ====================
// [ìˆ˜ì •ë¨] ì¹­í˜¸ ë­í‚¹ ë¹Œë” (1ìˆœìœ„: ì¹­í˜¸ ê°œìˆ˜, 2ìˆœìœ„: ë ˆë²¨+ê²½í—˜ì¹˜)
function buildTitleRanking(d, limit, myName) {
  limit = limit || 10;
  var list = [];
  var TOTAL_TITLES = 34;  // í˜„ì¬ ì´ ì¹­í˜¸ ê°œìˆ˜
  for (var name in d.users) {
    if (!d.users.hasOwnProperty(name)) 
      continue;
    var u = d.users[name];
    if (!u) 
      continue;
    var myTitles = u.titles || ["ë‰´ë¹„"];
    var count = myTitles.length;
    var percent = Math.floor((count / TOTAL_TITLES) * 100);
    list.push({
  name: name, 
  count: count, 
  percent: percent, 
  lv: u.trainerLv || 1, 
  exp: u.trainerExp || 0});
  }
  // â˜… ì •ë ¬ ë¡œì§: ê°œìˆ˜ -> ë ˆë²¨ -> ê²½í—˜ì¹˜
  list.sort(function(a, b) {
  if (b.count !== a.count) 
    return b.count - a.count;
  if (b.lv !== a.lv) 
    return b.lv - a.lv;
  return b.exp - a.exp;
});
  var myIdx = -1;
  for (var i = 0; i < list.length; i++) {
    if (list[i].name === myName) {
      myIdx = i;
      break;
    }
  }
  return {
  rows: list, 
  myIdx: myIdx, 
  totalTitles: TOTAL_TITLES, 
  top: list.slice(0, Math.min(limit, list.length))};
}

function normalizeUserData(u) {
  if (!u) return;
  
  // 1. ê¸°ë³¸ ì¬í™”/ë ˆë²¨ ì´ˆê¸°í™”
  u.trainerLv = u.trainerLv || 1;
  u.trainerExp = u.trainerExp || 0;
  u.gold = u.gold || 0;
  u.dakotaCoin = u.dakotaCoin || 0;
  
  u.ball = u.ball || 0; u.superBall = u.superBall || 0;
  u.ultraBall = u.ultraBall || 0; u.godBall = u.godBall || 0;
  u.dopaTicket = u.dopaTicket || 0; u.cookie = u.cookie || 0;
  u.ticket = u.ticket || 0; u.reroll = u.reroll || 0;

  // 2. ìœ„ì¹˜ ë° ìƒíƒœ ë³´í˜¸
  var validWorlds = ["íŒŒì•¼ë ˆë°”", "ì´ìŠŒ"];
  if (!u.world || validWorlds.indexOf(u.world) === -1) u.world = "íŒŒì•¼ë ˆë°”";
  u.lastRaidAt = u.lastRaidAt || 0;

  if (!u.items) u.items = {};
  if (!u.dex) u.dex = {};
  if (!Array.isArray(u.titles)) u.titles = ["ë‰´ë¹„"];
  u.activeTitle = u.activeTitle || "ë‰´ë¹„";
  if (!u.stats) u.stats = { battleWin: 0, battleLose: 0, battleDraw: 0, battleStreak: 0 };
  if (!Array.isArray(u.pokemons)) u.pokemons = [];

  if (!Array.isArray(u.party)) {
    u.party = [];
    if (u.pokemons.length > 0) {
      var sorted = u.pokemons.slice().sort(function(a, b) { return (b.enh||0) - (a.enh||0); });
      for(var k=0; k<Math.min(6, sorted.length); k++) { u.party.push(sorted[k].uid); }
    }
  }

  // 3. [í•µì‹¬] í¬ì¼“ëª¬ ë°ì´í„° ë³´ì • (In-place)
  for (var i = 0; i < u.pokemons.length; i++) {
    var p = u.pokemons[i];
    if (!p) continue;
    
    // ê°•í™”ì™€ ë ˆë²¨ì€ ë…ë¦½ì…ë‹ˆë‹¤.
    if (typeof p.lv !== "number" || isNaN(p.lv)) p.lv = 1; 
    if (typeof p.exp !== "number" || isNaN(p.exp)) p.exp = 0;
    if (typeof p.enh !== "number" || isNaN(p.enh)) p.enh = 0;
    p.friendship = p.friendship || 0;
    p.grade = p.grade || "D";
    p.ivStr = p.ivStr || 0; p.ivHp = p.ivHp || 0; p.ivSpd = p.ivSpd || 0;
  }

  if (typeof ensureUserDex === "function") ensureUserDex(u);
}


// 1. ë„ê° ì¹´ìš´íŠ¸ í—¬í¼ (ì¹­í˜¸ ì¡°ê±´ ì²´í¬ ì „ìš©)
function getDexCount(u) {
  var cnt = 0;
  if (u && u.dex) {
    for (var k in u.dex) {
      if (u.dex[k].caught > 0) 
        cnt++;
    }
  }
  return cnt;
}
// 2. [ìµœì¢… í†µí•©] ì¹­í˜¸ ìë™ ì§€ê¸‰ ë¡œì§
function updateTitles(u) {
  if (!u.titles) 
    u.titles = ["ë‰´ë¹„"];
  var gained = [];
  // ì¹­í˜¸ ì¶”ê°€ ë³´ì¡° í•¨ìˆ˜
  function check(titleName, condition) {
    if (u.titles.indexOf(titleName) === -1 && condition) {
      u.titles.push(titleName);
      gained.push(titleName);
    }
  }
  // ğŸŒ± ì„±ì¥ ê´€ë ¨ (Lv 30, 100, 150...)
  check("ë‰´ë¹„", true);
  check("ì„±ì¥ ì¤‘ì¸", u.trainerLv >= 30);
  check("ê³ ì—¬ë²„ë¦°", u.trainerLv >= 100);
  check("ì§„ì§€ì¶©", u.trainerLv >= 150);
  var totalB = (u.stats.battleWin || 0) + (u.stats.battleLose || 0);
  var winR = totalB > 0 ? (u.stats.battleWin / totalB) : 1;
  check("ë ˆë²¨ê°’ ëª»í•˜ëŠ”", u.trainerLv >= 50 && winR <= 0.3);
  // âš”ï¸ ì „íˆ¬ ê´€ë ¨ (ì—°ìŠ¹, ì—°íŒ¨, ëˆ„ì  íŒìˆ˜...)
  check("ì‹¸ì›€ê¾¼ì¸", u.stats.bestStreak >= 10);
  check("ê°•ë ¥í•œ", u.stats.bestStreak >= 20);
  check("ë„ë¼ì´", u.stats.bestStreak >= 50);
  check("ë°°í‹€ë§ˆìŠ¤í„°", u.stats.bestStreak >= 100);
  check("ìµœì•½ì²´ì¸", u.stats.loseStreak >= 10);
  check("ì°ë”° ê°™ì€", u.stats.loseStreak >= 20);
  check("ë‹¤ íŒ¨ê³  ë‹¤ë‹ˆëŠ”", (u.stats.battleWin + u.stats.battleLose + u.stats.battleDraw) >= 1000);
  // ğŸ“– ìˆ˜ì§‘ ê´€ë ¨ (ë„ê° ê°œìˆ˜, ë³´ìœ  ê°œìˆ˜...)
  var caughtCount = getDexCount(u);  // ìœ„ 1ë²ˆ í•¨ìˆ˜ ì‚¬ìš©
  check("ìˆ˜ì§‘ê°€", caughtCount >= 50);
  check("ìˆ˜ì§‘ì— ë¯¸ì¹œ", caughtCount >= 130);
  check("1ì„¸ëŒ€ ë§ˆìŠ¤í„°", caughtCount >= 151);
  check("ì¡ëŠ” ë§›ì„ ì•„ëŠ”", u.pokemons.length >= 150);
  if (caughtCount >= 151) {
    var allS = true;
    for (var k in u.dex) {
      if (u.dex[k].caught > 0 && (u.dex[k].maxGrade !== "S")) {
        allS = false;
        break;
      }
    }
    check("ì§„ì •í•œ 1ì„¸ëŒ€ ë§ˆìŠ¤í„°", allS);
  }
  check("ë°±ë§Œì¥ì", u.gold >= 1000000);
  check("ì²œë§Œì¥ì", u.gold >= 10000000);
  check("ì´ë”ë¦¬ì›€ í™€ë”", u.gold >= 80000000);
  check("ì¼ë¡ ë¨¸ìŠ¤í¬", u.gold >= 150000000);
  check("í”Œë ‰ìŠ¤", (u.stats.totalSpentShop || 0) >= 100000000);
  check("ê°•í™” ì¤‘ë…ì", (u.stats.totalSpentEnhance || 0) >= 100000000);
  check("ë„íŒŒë¯¼ ì¤‘ë…", (u.stats.totalDopaUsed || 0) >= 1000);
  check("íŒŒì•¼ë ˆë°” ëŸ¬ë²„", (u.stats.totalDopaReset || 0) >= 10);
  check("í¬ì¼“ëª¬ ì¥ì˜ì‚¬", (u.stats.totalDopaDestroy || 0) >= 10);
  // â˜… [í•µì‹¬ ì¶”ê°€] í‰ë²”í•˜ê²Œ ë¯¸ì¹œ (í‚¹ê°“ë³¼ 3ê°œ ì´ìƒ ëˆ„ì  êµ¬ë§¤ ì‹œ)
  check("í‰ë²”í•˜ê²Œ ë¯¸ì¹œ", (u.stats.totalGodBallBought || 0) >= 3);
  // ğŸ”¥ ê¸°íƒ€ íŠ¹ìˆ˜ ì¡°ê±´
  check("êµ¬ìŠ¬ë™ì ê°™ì€", u.ball >= 100 && u.superBall >= 100 && u.ultraBall >= 100);
  check("ìš°ì‚¬ì¸ë³¼íŠ¸ ê°™ì€", (u.stats.totalEscapes || 0) >= 1000);
  check("ì«€ë“í•œ", (u.stats.totalCookieUsed || 0) >= 1000);
  var sCount = 0;
  for (var i = 0; i < u.pokemons.length; i++) {
    if (u.pokemons[i].shiny) 
      sCount++;
  }
  check("ë¹›ë‚˜ëŠ” ëŒ€ë¨¸ë¦¬", sCount >= 5);
  // íŠ¹ì • 60ê°• ì²´í¬
  for (var j = 0; j < u.pokemons.length; j++) {
    var p = u.pokemons[j];
    if (p.enh >= 60) {
      if (p.pid === 95) 
        check("ë”´ë”´í•œê½‚ì¸„", true);      // ë¡±ìŠ¤í†¤
      if (p.pid === 145) 
        check("í…ŒìŠ¬ë¼ ëŒ€ì£¼ì£¼", true);      // ì¬ë”
      if (p.pid === 149) 
        check("ê°œë§ë‚˜ë‹ˆ", true);      // ë§ë‚˜ë‡½
    }
  }
  // â˜… [ì‹ ê·œ] ì±”í”¼ì–¸ ìŠ¹ë¦¬ 1íšŒ ì´ìƒì´ë©´ ì¹­í˜¸ ì§€ê¸‰
  check("ìµœì •ìƒì— ì˜¬ë¼ë³¸", (u.stats.championWins || 0) >= 1);
  return gained;
}
// 3. ë‹‰ë„¤ì„ ê¾¸ë¯¸ê¸° (ìˆ˜ì •ë¨: ì±”í”¼ì–¸ ì™•ê´€ ìë™ ë¶€ì°©)
function getDecoratedName(d, u, name) {
  if (!u) 
    return name;
  var title = u.activeTitle || "ë‰´ë¹„";
  var finalName = title + " " + name;  // ê¸°ë³¸: [ì¹­í˜¸] [ë‹‰ë„¤ì„]
  // â˜… [í•µì‹¬] í˜„ì¬ ì±”í”¼ì–¸ì¸ì§€ í™•ì¸
  if (d && d.champion && d.champion.name === name) {
    // NPCê°€ ì•„ë‹ ë•Œë§Œ (ìœ ì € ì±”í”¼ì–¸ì¼ ë•Œ)
    if (!d.champion.isNpc) {
      finalName = finalName + " ğŸ‘‘";      // ë’¤ì— ì™•ê´€ ì¶”ê°€!
    }
  }
  return finalName;
}
// 4. ë°ì´í„° ë³´ì • (ë“±ê¸‰ ëˆ„ë½ ë°©ì§€)
function ensurePokemonGrades(u) {
  if (!u || !u.pokemons || !Array.isArray(u.pokemons)) 
    return false;
  var isChanged = false;
  for (var i = 0; i < u.pokemons.length; i++) {
    var p = u.pokemons[i];
    if (!p.grade) {
      var newGrade = generatePokemonGrade();
      var newIVs = generateIVsByGrade(newGrade);
      p.grade = newGrade;
      p.ivStr = newIVs.str;
      p.ivHp = newIVs.hp;
      p.ivSpd = newIVs.spd;
      if (typeof dexCaught === "function") 
        dexCaught(u, p.pid, newGrade);
      isChanged = true;
    }
  }
  return isChanged;
}
// [ì‹ ê·œ] í¬ì¼“ëª¬ IDë¡œ ì–´ìš¸ë¦¬ëŠ” ì§€ì—­ ì°¾ê¸°
function getRecommendedRegion(pid) {
  var db = findPokemonDB(pid);
  if (!db) 
    return REGIONS[0].key;
  var t1 = db.type1;
  var t2 = db.type2;
  // ì§€ì—­ë³„ íƒ€ì… ë§¤ì¹­ í™•ì¸
  for (var i = 0; i < REGIONS.length; i++) {
    var r = REGIONS[i];
    if (r.key === "ëƒ¥ì¹˜ì˜ ë°©") 
      continue;
    if (r.types.indexOf(t1) !== -1 || (t2 && r.types.indexOf(t2) !== -1)) {
      return r.key;
    }
  }
  return REGIONS[0].key;
}
function findUserPokemonByUid(u, uid) {
  uid = parseInt(uid, 10);
  if (!u || !Array.isArray(u.pokemons)) 
    return null;
  for (var i = 0; i < u.pokemons.length; i++) {
    if (parseInt(u.pokemons[i].uid, 10) === uid) 
      return u.pokemons[i];
  }
  return null;
}
function randomPick(arr) {
  return arr[Math.floor(Math.random() * arr.length)];
}
function say(userName, text) {
  return userName + "ë‹˜, " + text;
}
function sayDo(userName, text) {
  return userName + "ë‹˜ì´ " + text;
}
var ENH_RESULT_UP = "UP";
var ENH_RESULT_KEEP = "KEEP";
var ENH_RESULT_EXIT = "EXIT";
var ENH_RESULT_DOWN = "DOWN";// ë”±íˆ ì•ˆì“°ì¼ ì˜ˆì •
// [ìˆ˜ì •ë¨] ê°•í™” í‹°ì–´ êµ¬ë¶„ (60ê°• ê¸°ì¤€)
function getEnhTier(enh) {
  if (enh < 10) 
    return "EASY";
  if (enh < 20) 
    return "MID";
  if (enh < 40) 
    return "HARD";
  return "HELL";
}
// -------------------- ì¶œì„ ë³´ìƒ í…Œì´ë¸” --------------------
var ATTENDANCE_STREAK_REWARD = {
  7: {
  dopa: 7}, 
  14: {
  dopa: 14}, 
  30: {
  dopa: 30}};
// ì¶œì„ ë°ì´í„° ì´ˆê¸°í™”
function ensureAttendance(u) {
  if (!u.attendance) {
    u.attendance = {
  lastDate: "", 
  streak: 0, 
  total: 0};
  }
}
// ì¶œì„ ê³¨ë“œ ê³„ì‚° (ê¸°ì¡´ * 5ë°°)
function calcAttendanceGold(u) {
  var base = randInt(300, 900);
  var lv = (u && typeof u.trainerLv === "number") ? u.trainerLv : 1;
  lv = Math.max(1, Math.min(99, lv));
  var mul = 1 + (lv - 1) * 0.08;
  if (mul > 3.5) 
    mul = 3.5;
  return Math.floor(base * mul * 8);
}
function randInt(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}
// -------------------- ì¶œì„ ì²´í¬ í•¨ìˆ˜ (ë°°í‹€ íšŸìˆ˜ ì´ˆê¸°í™” í¬í•¨) --------------------
function doAttendanceCheck(u, sender) {
  ensureUserStats(u);
  ensureAttendance(u);
  var today = dateKeyKST();
  // ì´ë¯¸ ì¶œì„í–ˆëŠ”ì§€ í™•ì¸
  if (u.attendance.lastDate === today) {
    return {
  ok: false, 
  msg: "ì˜¤ëŠ˜ì€ ì´ë¯¸ ì¶œì„í–ˆìŠµë‹ˆë‹¤.\në‚´ì¼ ë‹¤ì‹œ ì™€ì£¼ì„¸ìš”."};
  }
  u.dailyBattleCount = 0;
  u.lastBattleResetDate = today;  // ì˜¤ëŠ˜ ë‚ ì§œë¡œ ë¦¬ì…‹ë¨ì„ ê¸°ë¡
  // ì—°ì† ì¶œì„ ê³„ì‚°
  var newStreak = 1;
  if (u.attendance.lastDate) {
    var lastDay = dateKeyToDayNumber(u.attendance.lastDate);
    var todayDay = dateKeyToDayNumber(today);
    if (todayDay - lastDay === 1) {
      newStreak = (u.attendance.streak || 0) + 1;
    }
  }
  u.attendance.lastDate = today;
  u.attendance.streak = newStreak;
  u.attendance.total = (u.attendance.total || 0) + 1;
  // ğŸ ë³´ìƒ ì§€ê¸‰ (ê³¨ë“œ, ê²½í—˜ì¹˜)
  var goldGain = calcAttendanceGold(u);
  u.gold = (u.gold || 0) + goldGain;
  var expGain = 50 + (u.trainerLv * 10);
  var lvMsg = addExpWithLevelUpMsg(u, expGain);
  // ë„íŒŒë¯¼ í‹°ì¼“
  u.dopaTicket = (u.dopaTicket || 0) + 1;
  var bonusLines = ["ë„íŒŒë¯¼ ê°•í™”ê¶Œ +1ğŸ’³"];
  // ì—°ì† ì¶œì„ ë³´ë„ˆìŠ¤
  var streakReward = ATTENDANCE_STREAK_REWARD[newStreak];
  if (streakReward && streakReward.dopa) {
    u.dopaTicket += streakReward.dopa;
    bonusLines.push(newStreak + "ì¼ ì—°ì† ë³´ë„ˆìŠ¤ ë„íŒŒë¯¼ +" + streakReward.dopa);
  }
  var msg = sender + "ë‹˜ ì¶œì„ ì™„ë£Œ!\n" + "ì—°ì†: " + newStreak + "ì¼ / ëˆ„ì : " + u.attendance.total + "ì¼\n\n" + "âš”ï¸ [ë°°í‹€ íšŸìˆ˜ ì¶©ì „]\n" + "ì˜¤ëŠ˜ì˜ ë°°í‹€ ê¸°íšŒ 100íšŒê°€ ì¶©ì „ë˜ì—ˆìŠµë‹ˆë‹¤!\n\n" + "ğŸ ë³´ìƒ: +" + goldGain + "ğŸ’° / +" + expGain + "EXP\n" + "ğŸ”¥ ë³´ë„ˆìŠ¤: " + bonusLines.join(", ") + "\n";
  if (lvMsg) 
    msg += "\n" + lvMsg;
  return {
  ok: true, 
  msg: msg};
}
// ë‚ ì§œ â†’ ì¼ìˆ˜ ë³€í™˜
function dateKeyToDayNumber(key) {
  var y = parseInt(key.substr(0, 4), 10);
  var m = parseInt(key.substr(5, 2), 10);
  var d = parseInt(key.substr(8, 2), 10);
  return Math.floor(Date.UTC(y, m - 1, d) / 86400000);
}
// -------------------- íƒ€ì¸ ì •ë³´ ìœ í‹¸ --------------------
function getTargetFromMsg(d, sender, msg, cmd) {
  var tail = msg.slice(cmd.length).trim();
  if (!tail) 
    return {
  user: d.users[sender], 
  name: sender};
  if (tail.charAt(0) === "@") 
    tail = tail.slice(1);
  var tu = d.users[tail];
  if (!tu) 
    return null;
  normalizeUserData(tu);
  return {
  user: tu, 
  name: tail};
}
// -------------------- ë°°í‹€ ì—°ì¶œ ìœ í‹¸ --------------------
function clamp(n, a, b) {
  return Math.max(a, Math.min(b, n));
}
function rnd(min, max) {
  return min + Math.random() * (max - min);
}
function typeEffectTier(mult) {
  // remap ì´í›„ mult ìŠ¤ì¼€ì¼ì— ë§ì¶˜ ë¬¸êµ¬ ê¸°ì¤€
  if (mult >= 7.5) 
    return 3;
  if (mult >= 4.2) 
    return 2;
  if (mult >= 2.8) 
    return 1;
  if (mult <= 1.20) 
    return -1;
  return 0;
}
function typeEffectText(mult) {
  var t = typeEffectTier(mult);
  if (t === 3) 
    return "íš¨ê³¼ê°€ ë§ë„ ì•ˆ ë˜ê²Œ êµ‰ì¥í–ˆë‹¤!";
  if (t === 2) 
    return "íš¨ê³¼ê°€ êµ‰ì¥í–ˆë‹¤!";
  if (t === 1) 
    return "íš¨ê³¼ê°€ ì¢‹ì•˜ë‹¤!";
  if (t === -1) 
    return "íš¨ê³¼ê°€ ë³„ë¡œì¸ ë“¯í•˜ë‹¤â€¦";
  return "";
}
function funnyHitText() {
  var arr = ["ì •ì‹ ì´ ì ê¹ ë‚˜ê°”ë‹¤!", "í™”ë©´ ë°–ìœ¼ë¡œ ë‚ ì•„ê°ˆ ë»”í–ˆë‹¤!", "ì˜†ì—ì„œ êµ¬ê²½í•˜ë˜ ì‚¬ëŒë„ ë†€ëë‹¤!", "ë‚´ê°€ ë°©ê¸ˆ ë­˜ ë³¸ ê±°ì§€â€¦?", "ì´ê±´ ì¢€ ê³¼í–ˆë‹¤!", "ìƒëŒ€ê°€ ì ê¹ ë©ˆì·„ë‹¤â€¦(ë ‰ ì•„ë‹˜)"];
  return arr[Math.floor(Math.random() * arr.length)];
}
function funnyDodgeText() {
  var arr = ["íšŒí”¼í–ˆë‹¤! ìŠ¬ì© ë¹„ì¼œê°”ë‹¤!", "íšŒí”¼í–ˆë‹¤! ë¯¸ë„ëŸ¬ì§€ë“¯ í”¼í–ˆë‹¤!", "íšŒí”¼í–ˆë‹¤! â€˜ì•ˆ ë§ì¥¬?â€™", "íšŒí”¼í–ˆë‹¤! ì´ê±¸ í”¼í•˜ë„¤â€¦?", "íšŒí”¼í–ˆë‹¤! ë°œë°‘ì´ ê°€ë²¼ì› ë‹¤!"];
  return arr[Math.floor(Math.random() * arr.length)];
}
function funnyGuardText() {
  var arr = ["ë°©ì–´ íƒœì„¸! ë°ë¯¸ì§€ê°€ ì¤„ì—ˆë‹¤!", "ê°€ë“œ ì„±ê³µ! ë‹¨ë‹¨í•˜ê²Œ ë²„í…¼ë‹¤!", "ë§‰ì•„ëƒˆë‹¤! ê±°ì˜ ì•ˆ ë“¤ì–´ê°”ë‹¤!", "ë°©ì–´! ìƒëŒ€ê°€ ë‹¹í™©í–ˆë‹¤!"];
  return arr[Math.floor(Math.random() * arr.length)];
}
function crisisText(name) {
  var arr = [name + " ìœ„ê¸°! ìˆ¨ì´ í„±ê¹Œì§€ ì°¼ë‹¤!", name + " ìœ„ê¸°! ëˆˆì•ì´ í•˜ì–˜ì¡Œë‹¤!", name + " ìœ„ê¸°! ì†ì— ë•€ì´ ë‚œë‹¤!", name + " ìœ„ê¸°! â€˜ì—¬ê¸°ì„œ ì§€ë©´ ì•ˆ ë¼!â€™"];
  return arr[Math.floor(Math.random() * arr.length)];
}
// [ë°¸ëŸ°ìŠ¤ íŒ¨ì¹˜] ì²´ë ¥ ê³„ì‚° (í¬ê·€ë„ ë»¥íŠ€ê¸° ì™„í™”)
function calcHP(db, enh, ivHp, equipName) {
  var s = getStageFromBase(db.id);
  var r = db.rarity || 1;
  // ì„±ì¥í­ ì¡°ì • (ì „ì„¤ 120 -> 90, ìµœì¢…ì§„í™” 100 -> 80)
  var addPerEnh = 25;
  if (r >= 5) 
    addPerEnh = 90;  // ì „ì„¤
  else if (r === 4) 
    addPerEnh = 80;  // ìµœì¢…ì§„í™”
  else if (s >= 2) 
    addPerEnh = 75;  // 2ë‹¨ ì§„í™”
  else if (s === 1) 
    addPerEnh = 50;  // 1ë‹¨ ì§„í™”
  else 
    addPerEnh = 30;  // ê¸°ë³¸
  var base = 500 + (db.basePower * 10);  // ê¸°ë³¸ ì²´ë ¥ ê³„ìˆ˜ë„ ì‚´ì§ í•˜í–¥ (12->10)
  var hp = base + Math.floor(enh * addPerEnh) + (ivHp || 0);
  // ì „ì„¤ ë³´ë„ˆìŠ¤ 30% -> 10%ë¡œ ë„ˆí”„
  if (r === 5) 
    hp = Math.floor(hp * 1.1);
  if (equipName && EQUIP_DB[equipName]) {
    var item = EQUIP_DB[equipName];
    if (item.type === "hp_flat") {
      hp += item.val;
    } else if (item.type === "hp_pct") {
      hp = Math.floor(hp * (1 + item.val));
    }
  }
  return clamp(hp, 500, 300000);
}
// [ë°¸ëŸ°ìŠ¤ íŒ¨ì¹˜ 2ì°¨] ë°ë¯¸ì§€ ê³„ì‚° (ë°©ì–´ ê´€í†µ + ìƒì„± ê·¹ëŒ€í™”)
// [ë°¸ëŸ°ìŠ¤ íŒ¨ì¹˜] ë°ë¯¸ì§€ ê³„ì‚° (ë°©ì–´ ê´€í†µ ê°•í™”)
function calcDamage(attDb, attEnh, defDb, defEnh, attEquip, defEquip) {
  // 1. ìƒì„± ë°°ìœ¨ ê³„ì‚° (ê°€ì¥ ìœ ë¦¬í•œ ì†ì„± ì„ íƒ)
  var m1 = typeMultiplierAdjusted(attDb.type1, defDb.type1);
  var m2 = attDb.type2 ? typeMultiplierAdjusted(attDb.type2, defDb.type1) : 0;
  // 2ì†ì„± ë°©ì–´ì ì²´í¬ (ë§ë‚˜ë‡½ì€ ë“œë˜ê³¤/ë¹„í–‰ -> ì–¼ìŒ 4ë°°)
  if (defDb.type2) {
    // typeMultiplierAdjustedëŠ” ë‹¨ì¼ ìƒì„±ë§Œ ë³´ë¯€ë¡œ, ì´ì¤‘ ìƒì„± ë³´ì •
    var m1_2 = typeMultiplierAdjusted(attDb.type1, defDb.type2);
    var m2_2 = attDb.type2 ? typeMultiplierAdjusted(attDb.type2, defDb.type2) : 0;
    // ê³±ì—°ì‚° (4ë°° ì•½ì  êµ¬í˜„)
    m1 = m1 * m1_2;
    if (attDb.type2) 
      m2 = m2 * m2_2;
  }
  var mult = Math.max(m1, m2);
  // ê¸°ë³¸ ìŠ¤í™
  var attPid = attDb.id || attDb.pid;
  var defPid = defDb.id || defDb.pid;
  var aR = rarityBattleMul(attDb.rarity || 2, attPid);
  var dR = rarityBattleMul(defDb.rarity || 2, defPid);
  var atkPower = attDb.basePower * (1 + (attEnh * ATK_ENH_RATE)) * aR;
  var defPower = defDb.basePower * (1 + (defEnh * DEF_ENH_RATE)) * dR;
  // ì¥ë¹„ ìŠ¤íƒ¯
  if (attEquip && EQUIP_DB[attEquip]) {
    var eq = EQUIP_DB[attEquip];
    if (eq.type === "atk_pct") 
      atkPower *= (1 + eq.val);
    if (eq.type === "type_boost") {
      if (attDb.type1 === eq.cond || (attDb.type2 && attDb.type2 === eq.cond)) {
        atkPower *= (1 + eq.val);
      }
    }
  }
  if (defEquip && EQUIP_DB[defEquip]) {
    var eq = EQUIP_DB[defEquip];
    if (eq.type === "def_pct") 
      defPower *= (1 / (1 - eq.val));
  }
  if (mult >= 4.0) {
    // 4ë°° ì•½ì  (ì–¼ìŒ vs ë§ë‚˜ë‡½)
    defPower *= 0.2;    // ë°©ì–´ë ¥ 80% ë¬´ì‹œ (ì¢…ì‡ì¥ ë§Œë“¦)
    mult *= 1.5;    // ë°ë¯¸ì§€ 50% ì¶”ê°€ ì¦í­
  } else if (mult >= 2.0) {
    // 2ë°° ì•½ì 
    defPower *= 0.5;    // ë°©ì–´ë ¥ 50% ë¬´ì‹œ
    mult *= 1.2;
  }
  var baseDmg = atkPower * 0.55;
  var powerRatio = atkPower / Math.max(1, defPower);
  var score = Math.floor(baseDmg * powerRatio * mult);
  return {
  score: Math.max(1, score), 
  mult: mult};
}
// [ìˆ˜ì •] ìŠ¤í”¼ë“œ(ì„ ê³µ/íšŒí”¼)ì— ì¥ë¹„ ë°˜ì˜
function calcHit(attDb, attP, defDb, defP, trainerLvAtt, trainerLvDef) {
  // ë°ë¯¸ì§€ ê³„ì‚° ì‹œ ì¥ë¹„ ì •ë³´ ì „ë‹¬
  var base = calcDamage(attDb, attP.enh, defDb, defP.enh, attP.equip, defP.equip);
  var strBonus = 1 + ((attP.ivStr || 0) * 0.015);
  if (attP.shiny) 
    strBonus *= 1.1;
  base.score = Math.floor(base.score * strBonus);
  // â˜… [ì¥ë¹„] ìŠ¤í”¼ë“œ ê³„ì‚°
  var spdAtt = (attP.ivSpd || 0);
  var spdDef = (defP.ivSpd || 0);
  if (attP.equip && EQUIP_DB[attP.equip] && EQUIP_DB[attP.equip].type === "spd_flat") 
    spdAtt += EQUIP_DB[attP.equip].val;
  if (defP.equip && EQUIP_DB[defP.equip] && EQUIP_DB[defP.equip].type === "spd_flat") 
    spdDef += EQUIP_DB[defP.equip].val;
  var spdDiff = spdDef - spdAtt;
  // (ì´í•˜ ê¸°ì¡´ íšŒí”¼/í¬ë¦¬ ë¡œì§ ë™ì¼...)
  var dodge = 0.10 + clamp(((trainerLvDef || 1) - (trainerLvAtt || 1)) * 0.0008, -0.03, 0.03) + clamp((defP.enh - attP.enh) * 0.004, -0.02, 0.02) + (spdDiff * 0.002);
  dodge = clamp(dodge, 0.05, 0.25);
  var guard = 0.12 + clamp(defP.enh * 0.002, 0, 0.04);
  var crit = 0.12 + clamp(attP.enh * 0.001, 0, 0.03) + ((attP.ivSpd || 0) * 0.003);
  if (attP.shiny) 
    crit += 0.02;
  crit = clamp(crit, 0.10, 0.25);
  var swing = rnd(0.88, 1.12);
  if (Math.random() < dodge) 
    return {
  dodged: true, 
  guarded: false, 
  crit: false, 
  dmg: 0, 
  mult: base.mult};
  var isGuard = (Math.random() < guard);
  var isCrit = (Math.random() < crit);
  var dmg = Math.max(1, Math.floor(base.score * swing * (isCrit ? 1.55 : 1.0) * (isGuard ? 0.55 : 1.0)));
  return {
  dodged: false, 
  guarded: isGuard, 
  crit: isCrit, 
  dmg: dmg, 
  mult: base.mult};
}
// [ìµœì¢… ìˆ˜ì •] ë°°í‹€ ë¡œê·¸ ì‹œë®¬ë ˆì´í„° (ì¥ë¹„ ìŠ¤í”¼ë“œ ë°˜ì˜ + ì„ ê³µ í™•ì • + ë°˜ì‚¬ ë°ë¯¸ì§€)
function simulateBattleLog(aName, aDb, aP, aTLv, bName, bDb, bP, bTLv) {
  // 1. ì²´ë ¥ ì„¸íŒ… (ì¥ë¹„ ë°˜ì˜)
  var aMax = calcHP(aDb, aP.enh, aP.ivHp || 0, aP.equip);
  var bMax = calcHP(bDb, bP.enh, bP.ivHp || 0, bP.equip);
  var aHP = aMax;
  var bHP = bMax;
  // 2. ì‹¤ì „ ìŠ¤í”¼ë“œ ê³„ì‚° (ì¥ë¹„ í¬í•¨)
  function getRealSpd(p) {
    var s = (p.ivSpd || 0);    // ê¸°ë³¸ ì ì¬ë ¥
    // ê°•í™” ìˆ˜ì¹˜ì— ë”°ë¥¸ ìŠ¤í”¼ë“œ ë³´ì • (ì„ íƒ ì‚¬í•­, ì—¬ê¸°ì„  ì ì¬ë ¥+ì¥ë¹„ ìœ„ì£¼)
    if (p.equip && EQUIP_DB[p.equip] && EQUIP_DB[p.equip].type === "spd_flat") {
      s += EQUIP_DB[p.equip].val;      // ì¥ë¹„ë¹¨ ì¶”ê°€ (ì˜ˆ: ê¾¸ê¾¸ +35)
    }
    return s;
  }
  var aSpd = getRealSpd(aP);
  var bSpd = getRealSpd(bP);
  // 3. ì„ ê³µ ê²°ì • (ìŠ¤í”¼ë“œ ë†’ì€ ìª½ì´ 100% ì„ ê³µ)
  var aTurn = false;
  if (aSpd > bSpd) 
    aTurn = true;
  else if (aSpd < bSpd) 
    aTurn = false;
  else 
    aTurn = (Math.random() < 0.5);  // ë™ì ì¼ ë•Œë§Œ ëœë¤
  // 4. í‘œê¸°ìš© ì´ë¦„ ì„¸íŒ…
  var aPokeName = "[" + aName + "] " + getDisplayName(aP);
  var bPokeName = "[" + bName + "] " + getDisplayName(bP);
  var aShort = aPokeName;
  var bShort = bPokeName;
  // 5. ë¡œê·¸ í—¤ë” êµ¬ì„± (í‘œê¸°ìš© ê³µê²©ë ¥ ê³„ì‚°)
  function getRealAtkDisplay(db, p) {
    var base = db.basePower;
    var enhBonus = 1 + (p.enh * 0.085);
    var ivBonus = 1 + ((p.ivStr || 0) * 0.015);
    var rMul = rarityBattleMul(db.rarity || 2, db.id);
    var sMul = stageBattleMul(db.id).atk;
    var val = base * enhBonus * ivBonus * rMul * sMul;
    if (p.shiny) 
      val *= 1.1;
    if (p.equip && EQUIP_DB[p.equip] && EQUIP_DB[p.equip].type === "atk_pct") {
      val *= (1 + EQUIP_DB[p.equip].val);
    }
    return Math.floor(val);
  }
  var aRealAtk = getRealAtkDisplay(aDb, aP);
  var bRealAtk = getRealAtkDisplay(bDb, bP);
  var aE = (aP.enh > 0) ? ("+" + aP.enh + "ê°•") : "";
  var bE = (bP.enh > 0) ? ("+" + bP.enh + "ê°•") : "";
  var aLv = "Lv." + (aP.lv || 1);  // â˜… ì¶”ê°€
  var bLv = "Lv." + (bP.lv || 1);  // â˜… ì¶”ê°€
  var logHeader = "";
  // âš”ï¸ ì„ë¯¼ìˆ˜: Lv.50 âœ¨ë®¤ì¸  +60ê°•
  logHeader += "âš”ï¸ " + aName + ": " + aLv + " " + getDisplayName(aP) + " " + aE + "\n";
  logHeader += "(HP " + aMax + " / ê³µ " + aRealAtk + " / âš¡ì†ë„ " + aSpd + ")\n";
  logHeader += "ğŸ›¡ï¸ " + bName + ": " + bLv + " " + getDisplayName(bP) + " " + bE + "\n";
  logHeader += "(HP " + bMax + " / ê³µ " + bRealAtk + " / âš¡ì†ë„ " + bSpd + ")\n\n";
  logHeader += (aTurn ? (aShort + "ì˜ ì„ ê³µ! âš¡\n\n") : (bShort + "ì˜ ì„ ê³µ! âš¡\n\n"));
  // 6. ì „íˆ¬ ë£¨í”„ ì‹œì‘
  var turn = 1;
  var MAX_SAFE_TURNS = 200;
  var turnLogs = [];
  var aCrisisShown = false;
  var bCrisisShown = false;
  while (aHP > 0 && bHP > 0 && turn <= MAX_SAFE_TURNS) {
    var attackerName = aTurn ? aShort : bShort;
    var defenderName = aTurn ? bShort : aShort;
    var attDb = aTurn ? aDb : bDb;
    var defDb = aTurn ? bDb : aDb;
    var attP_curr = aTurn ? aP : bP;
    var defP_curr = aTurn ? bP : aP;
    var attLv = aTurn ? aTLv : bTLv;
    var defLv = aTurn ? bTLv : aTLv;
    // ëª…ì¤‘/íšŒí”¼/ë°ë¯¸ì§€ ê³„ì‚° (calcHit ë‚´ë¶€ì—ì„œ calcDamage í˜¸ì¶œ)
    var hit = calcHit(attDb, attP_curr, defDb, defP_curr, attLv, defLv);
    var thisTurnStr = "";
    if (hit.dodged) {
      thisTurnStr = turn + "í„´) " + attackerName + " ê³µê²©! â†’ " + defenderName + " " + funnyDodgeText();
    } else {
      var finalDmg = hit.dmg;
      // í¬ê·€ë„/í„´ ë³´ì • (ì „íˆ¬ íë¦„ ë³´ì •)
      var hpRate = (aTurn ? bHP / bMax : aHP / aMax);
      var mod = getRarityBattleModifier(attDb, turn, hpRate);
      finalDmg = Math.floor(finalDmg * mod.atk);
      if (defDb.rarity) {
        var dmod = getRarityBattleModifier(defDb, turn, hpRate);
        finalDmg = Math.floor(finalDmg * dmod.def);
      }
      finalDmg = Math.max(1, finalDmg);
      // â˜… [ìˆ˜ì • í•„ìš”] 0.60 -> 0.30 ìœ¼ë¡œ ë³€ê²½í•´ì•¼ ë°¸ëŸ°ìŠ¤ê°€ ë§ìŠµë‹ˆë‹¤!
      var reflectDmg = 0;
      if (defP_curr.equip === "ê¹€ì‹œì‹±ì˜ë©˜íƒˆ") {
        reflectDmg = Math.floor(finalDmg * 0.30);        // 0.60ì—ì„œ ìˆ˜ì •
      }
      if (aTurn) {
        bHP -= finalDmg;        // B(ë°©ì–´ì) í”¼í•´
        if (reflectDmg > 0) {
          aHP -= reflectDmg;          // A(ê³µê²©ì) ë°˜ì‚¬ í”¼í•´
        }
      } else {
        aHP -= finalDmg;        // A(ë°©ì–´ì) í”¼í•´
        if (reflectDmg > 0) {
          bHP -= reflectDmg;          // B(ê³µê²©ì) ë°˜ì‚¬ í”¼í•´
        }
      }
      // ë¡œê·¸ ì‘ì„±
      thisTurnStr = turn + "í„´) " + attackerName + " ê³µê²©! â†’ " + defenderName + " -" + finalDmg;
      if (hit.crit) 
        thisTurnStr += " ğŸ’¥ê¸‰ì†Œ!";
      if (hit.guarded) 
        thisTurnStr += " ğŸ›¡ï¸ë°©ì–´";
      thisTurnStr += "\n";
      // ë°˜ì‚¬ ë¡œê·¸ ì¶”ê°€
      if (reflectDmg > 0) {
        thisTurnStr += "âœ¨ [ë°˜ì‚¬] ê¹€ì‹œì‹±ì˜ë©˜íƒˆ ë°œë™! " + attackerName + "ì—ê²Œ " + reflectDmg + " ë°ë¯¸ì§€ë¥¼ ëŒë ¤ì¤Œ!\n";
      }
      var eff = typeEffectText(hit.mult);
      if (eff) 
        thisTurnStr += eff + "\n";
      thisTurnStr += "HP: " + Math.max(0, aHP) + " vs " + Math.max(0, bHP);
    }
    // ìœ„ê¸° ë©˜íŠ¸ (HP 20% ì´í•˜)
    if (!aCrisisShown && aHP > 0 && aHP <= aMax * 0.2) {
      thisTurnStr += "\n\n" + crisisText(aShort);
      aCrisisShown = true;
    }
    if (!bCrisisShown && bHP > 0 && bHP <= bMax * 0.2) {
      thisTurnStr += "\n\n" + crisisText(bShort);
      bCrisisShown = true;
    }
    turnLogs.push(thisTurnStr);
    // í„´ êµì²´
    aTurn = !aTurn;
    turn++;
  }
  // ìŠ¹íŒ¨ íŒì •
  var winner = "draw";
  if (aHP <= 0 && bHP <= 0) 
    winner = "draw";  // ëŸ¬ë¸Œìƒ·(ë°˜ì‚¬ë€ ë“±)
  else if (bHP <= 0) 
    winner = "A";
  else if (aHP <= 0) 
    winner = "B";
  else {
    // í„´ ì´ˆê³¼ ì‹œ HP ë§ì€ ìª½ ìŠ¹ë¦¬
    if (aHP > bHP) 
      winner = "A";
    else if (bHP > aHP) 
      winner = "B";
  }
  var finalLogBody = "";
  var SHOW_HEAD = 10;
  var SHOW_TAIL = 4;
  if (turnLogs.length <= (SHOW_HEAD + SHOW_TAIL + 2)) {
    finalLogBody = turnLogs.join("\n\n");
  } else {
    var headLog = turnLogs.slice(0, SHOW_HEAD).join("\n\n");
    var tailLog = turnLogs.slice(turnLogs.length - SHOW_TAIL).join("\n\n");
    finalLogBody = headLog + "\n\n...\nâš”ï¸ (ì¹˜ì—´í•œ ê³µë°©ì´ ì´ì–´ì§‘ë‹ˆë‹¤...)\n...\n\n" + tailLog;
  }
  var fullLog = logHeader + finalLogBody + "\n";
  var resultLine = (winner === "A") ? ("ê²°ê³¼: " + aName + " ìŠ¹ë¦¬!") : (winner === "B") ? ("ê²°ê³¼: " + bName + " ìŠ¹ë¦¬!") : "ê²°ê³¼: ë¬´ìŠ¹ë¶€!";
  return {
  winner: winner, 
  log: fullLog, 
  resultLine: resultLine};
}
function battleRewardLine(gold, exp) {
  return "ğŸ ë³´ìƒ: +" + gold + "ğŸ’° / +" + exp + "EXP";
}
// [ìˆ˜ì •] ë°°í‹€ ê²°ê³¼ì°½ ë‚´ í¬ì¼“ëª¬ í‘œì‹œ (ì´ë¡œì¹˜ ë°˜ì˜)
function battleMyPickLine(myUid, db, p) {
  // enh ëŒ€ì‹  p ê°ì²´ ë°›ìŒ
  var e = enhLabel(p.enh);
  var pName = getDisplayName(p);  // â˜… ì—¬ê¸°ì„œ âœ¨ ì²˜ë¦¬
  return "ë‚´ í¬ì¼“ëª¬: #" + myUid + " " + pName + (e ? (" " + e) : "");
}
// [ìˆ˜ì •] ë°°í‹€ ê²°ê³¼ì°½ ìƒëŒ€ í¬ì¼“ëª¬ í‘œì‹œ
function battleOppPickLine(oppName, oppUid, db, p) {
  // enh ëŒ€ì‹  p ê°ì²´ ë°›ìŒ
  var e = enhLabel(p.enh);
  var pName = getDisplayName(p);  // â˜… ì—¬ê¸°ì„œ âœ¨ ì²˜ë¦¬
  return oppName + "ì˜ í¬ì¼“ëª¬: #" + oppUid + " " + pName + (e ? (" " + e) : "");
}
// [ìµœì¢… ê°œí¸] ë°°í‹€ ì‹¤í–‰ (ê²½í—˜ì¹˜ 1,000~3,000ëŒ€ë¡œ ëŒ€í­ ìƒí–¥)
function runSingleBattle(d, room, sender, u, myPickUid, opt) {
  ensureUserStats(u);
  opt = opt || {};
  var isChain = !!opt.isChain;
  var mult = (opt.rewardMult != null) ? opt.rewardMult : 1.0;

  // 1. ë°°í‹€ íšŸìˆ˜ ì œí•œ ì²´í¬
  var today = dateKeyKST();
  if (u.lastBattleResetDate !== today) {
    return { ok: false, msg: "â›” [ë°°í‹€ ë¶ˆê°€]\nì•„ì§ ì˜¤ëŠ˜ì˜ ë°°í‹€ íšŸìˆ˜ê°€ ì¶©ì „ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\në¨¼ì € '/ì¶œì„'ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!" };
  }

  var DAILY_LIMIT = 100;
  var isFatigued = (u.dailyBattleCount >= DAILY_LIMIT);
  var affectRecord = !isChain && !isFatigued;

  if (ensurePokemonGrades(u)) saveData(d);

  // 2. ì¶œì „ í¬ì¼“ëª¬ ì„ ì •
  var myEligible = getBattleEligiblePokemons(u);
  if (myEligible.length === 0) {
    return { ok: false, msg: "ë°°í‹€ ì°¸ê°€ ì¡°ê±´: " + BATTLE_MIN_ENH + "ê°• ì´ìƒ í¬ì¼“ëª¬ì´ í•„ìš”í•©ë‹ˆë‹¤." };
  }

  var myP = null;
  if (myPickUid != null) {
    myP = findUserPokemonByUid(u, myPickUid);
    if (isPokemonBusy(u, myPickUid)) return { ok: false, msg: "ğŸš« í•´ë‹¹ í¬ì¼“ëª¬ì€ íƒí—˜ ì¤‘ì´ë¼ ë‚˜ê°ˆ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." };
    if (!myP || (myP.enh || 0) < BATTLE_MIN_ENH) return { ok: false, msg: "ìµœì†Œ " + BATTLE_MIN_ENH + "ê°• ì´ìƒ í¬ì¼“ëª¬ë§Œ ì°¸ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤." };
  } else {
    myP = randomPick(myEligible);
  }

  // 3. ë§¤ì¹­ ë¡œì§
  var oppList = getEligibleOpponentsMem(d, room, sender, myP.enh);
  if (oppList.length === 0) return { ok: false, msg: "âš”ï¸ ë§¤ì¹­ ì‹¤íŒ¨\në¹„ìŠ·í•œ ì²´ê¸‰(Â±10ê°•)ì˜ ìƒëŒ€ê°€ ì—†ìŠµë‹ˆë‹¤." };

  var oppName = randomPick(oppList);
  var opp = d.users[oppName];
  normalizeUserData(opp);
  if (ensurePokemonGrades(opp)) saveData(d);

  var oppAllEligible = getBattleEligiblePokemons(opp);
  var oppTargetPool = [];
  var RANGE = 10;
  var minT = (myP.enh || 0) - RANGE;
  var maxT = (myP.enh || 0) + RANGE;

  for (var z = 0; z < oppAllEligible.length; z++) {
    var pObj = oppAllEligible[z];
    var pe = pObj.enh || 0;
    if (pe >= minT && pe <= maxT) oppTargetPool.push(pObj);
  }

  if (oppTargetPool.length === 0) return { ok: false, msg: "ë§¤ì¹­ ì·¨ì†Œ (ìƒëŒ€ í¬ì¼“ëª¬ ë°ì´í„° ë³€ê²½)" };

  var opP = randomPick(oppTargetPool);
  var myDb = findPokemonDB(myP.pid);
  var opDb = findPokemonDB(opP.pid);
  if (!myDb || !opDb) return { ok: false, msg: "DB ì˜¤ë¥˜" };

  // 4. ì „íˆ¬ ì‹œë®¬ë ˆì´ì…˜
  var sim = simulateBattleLog(sender, myDb, myP, u.trainerLv, oppName, opDb, opP, opp.trainerLv);
  var result = (sim.winner === "A") ? 1 : (sim.winner === "B") ? -1 : 0;

  var goldGain = 0;
  var expGain = 0;
  var coinGain = 0;
  var extraLines = "";

  u.dailyBattleCount = (u.dailyBattleCount || 0) + 1;

  // -----------------------------------------------------------
  // [5] ê²°ê³¼ íŒì • ë° ë³´ìƒ (ê²½í—˜ì¹˜ ëŒ€í­ ìƒí–¥ êµ¬ê°„)
  // -----------------------------------------------------------
  if (result === 1) { // ìŠ¹ë¦¬
    // 1) ê¸°ë³¸ ìŠ¹ë¦¬ ë³´ìƒ ì„¤ì •
    var baseWinGold = Math.floor((BATTLE_GOLD_WIN * 150) + (u.trainerLv * 250));
    var enhBonusGold = (myP.enh || 0) * randInt(800, 4000); 
    goldGain = baseWinGold + enhBonusGold;
    // íŠ¸ë ˆì´ë„ˆ ê²½í—˜ì¹˜ë„ 65 -> 500~1000 ìˆ˜ì¤€ìœ¼ë¡œ ìƒí–¥
    expGain = (u.trainerLv * 10) + randInt(300, 600); 
    coinGain = randInt(3, 12);

    // 2) ì—°ìŠ¹ ê¸°ë¡ ë° ë³´ë„ˆìŠ¤
    if (affectRecord) {
      u.stats.battleWin++;
      u.stats.battleStreak++;
      u.stats.loseStreak = 0;
      u.stats.bestStreak = Math.max(u.stats.bestStreak, u.stats.battleStreak);

      // â˜… 5ì—°ìŠ¹ ë³´ë„ˆìŠ¤
      if (u.stats.battleStreak > 0 && u.stats.battleStreak % 5 === 0) {
        var streakLevel = u.stats.battleStreak;
        var bonusGold = STREAK_GOLD_BONUS * streakLevel * 10;
        var bonusUserExp = STREAK_EXP_BONUS * (streakLevel / 5);
        // ì—°ìŠ¹ ì‹œ íŒŒí‹° ì¶”ê°€ ê²½í—˜ì¹˜ë„ ì ì í•˜ê²Œ (2000~5000)
        var bonusPartyExp = 2000 + (streakLevel * 100); 

        u.gold += bonusGold;
        addExpWithLevelUpMsg(u, bonusUserExp);
        
        extraLines += "ğŸ”¥ " + streakLevel + "ì—°ìŠ¹ ë³´ë„ˆìŠ¤!!\n";
        extraLines += "ğŸ’° +" + fmtNum(bonusGold) + "ğŸ’° / âœ¨ íŠ¸ë ˆì´ë„ˆ EXP +" + bonusUserExp + "\n";
        extraLines += "ğŸŠ íŒŒí‹° ì „ì› ì¶”ê°€ EXP +" + fmtNum(bonusPartyExp) + "!\n";
        
        if (u.party) {
          for (var k = 0; k < u.party.length; k++) {
            var pM = findUserPokemonByUid(u, u.party[k]);
            if (pM) gainPokemonExp(u, pM, bonusPartyExp);
          }
        }
      }
    }

    // 3) â˜… [í•µì‹¬] íŒŒí‹°ì› ì „ì› ê¸°ë³¸ ê²½í—˜ì¹˜ (1,000 ~ 3,000 ëª©í‘œ)
    var opRarity = (opDb && opDb.rarity) ? opDb.rarity : 1;
    // ê³„ì‚°ì‹: í¬ê·€ë„*150 + ë ˆë²¨*15 + ë‚œìˆ˜(800~1500)
    // ìµœì†Œ(ì¡ëª¹): 150 + 15 + 800 = ì•½ 965 EXP
    // ìµœëŒ€(ì „ì„¤): 750 + 1500 + 1500 = ì•½ 3,750 EXP
    var partyBaseExp = (opRarity * 150) + (u.trainerLv * 15) + randInt(800, 1500);
    
    extraLines += "â¤ï¸ íŒŒí‹° ì¹œë°€ë„ +2 / ğŸ”¼ ì „ì› ê²½í—˜ì¹˜ +" + fmtNum(partyBaseExp) + "\n";

    if (u.party) {
      for (var i = 0; i < u.party.length; i++) {
        var member = findUserPokemonByUid(u, u.party[i]);
        if (member) {
          member.friendship = Math.min(255, (member.friendship || 0) + 2);
          var lvNotice = gainPokemonExp(u, member, partyBaseExp);
          if (lvNotice) extraLines += lvNotice + "\n";
        }
      }
    }

  } else if (result === -1) { // íŒ¨ë°°
    if (affectRecord) {
      u.stats.battleLose++;
      u.stats.battleStreak = 0;
      u.stats.loseStreak = (u.stats.loseStreak || 0) + 1;
    }
    goldGain = BATTLE_GOLD_LOSE * 120;
    expGain = BATTLE_EXP_LOSE * 5; // íŒ¨ë°°í•´ë„ ê²½í—˜ì¹˜ ì¡°ê¸ˆ ìƒí–¥
    coinGain = randInt(1, 4);
  } else { // ë¬´ìŠ¹ë¶€
    if (affectRecord) {
      u.stats.battleDraw++;
      u.stats.battleStreak = 0;
    }
    goldGain = 3000;
  }

  // 6. í”¼ë¡œë„ ë° ìµœì¢… ì •ì‚°
  if (isFatigued) {
    goldGain = Math.floor(goldGain * 0.001);
    expGain = 0; coinGain = 0;
    extraLines += "ğŸ’¤ [í”¼ë¡œë„ ì´ˆê³¼] ë³´ìƒì´ ì œí•œë©ë‹ˆë‹¤.\n";
  } else {
    goldGain = Math.floor(goldGain * mult);
    expGain = Math.floor(expGain * mult);
  }

  if (goldGain > 0) u.gold += goldGain;
  if (coinGain > 0) u.dakotaCoin = (u.dakotaCoin || 0) + coinGain;
  if (expGain > 0) {
    var uLvMsg = addExpWithLevelUpMsg(u, expGain);
    if (uLvMsg) extraLines += uLvMsg + "\n";
  }

  // 7. ê²°ê³¼ UI ì¡°ë¦½
  var header = blockTitle("ë°°í‹€ ê²°ê³¼") + battleMyPickLine(myP.uid, myDb, myP) + "\n" + battleOppPickLine(oppName, opP.uid, opDb, opP) + "\n\n";
  var resLine = (result === 1) ? ("ğŸ† ìŠ¹ë¦¬: " + sender + " (" + u.stats.battleStreak + "ì—°ìŠ¹ì¤‘)\n") : (result === -1) ? ("ğŸ’€ íŒ¨ë°°: " + sender + "\n") : ("ğŸ¤ ë¬´ìŠ¹ë¶€\n");
  
  var rewardLine = "ğŸ’° ì´ íšë“: +" + fmtNum(goldGain) + "ğŸ’° / +" + fmtNum(expGain) + "EXP" + (coinGain > 0 ? " / +" + coinGain + "ğŸª™" : "") + "\n";
  var left = Math.max(0, DAILY_LIMIT - u.dailyBattleCount);
  var remainMsg = "â³ ë‚¨ì€ ë°°í‹€: " + left + " / " + DAILY_LIMIT + "íšŒ";

  var summary = header + resLine + rewardLine + remainMsg + (extraLines ? ("\n" + extraLines) : "") + "\n\nì „ì²´ë³´ê¸°ë¡œ ë°°í‹€ ë¡œê·¸ í™•ì¸";
  return { ok: true, result: result, summary: summary, full: "\n\n[ë¡œê·¸]\n" + sim.log + sim.resultLine, myPick: myP, oppPick: opP };
}

function battleRewardLine(gold, exp) {
  return "ğŸ ë³´ìƒ: +" + gold + "ğŸ’° / +" + exp + "EXP";
}
// [ìˆ˜ì •] ë°°í‹€ ê²°ê³¼ì°½ ë‚´ í¬ì¼“ëª¬ í‘œì‹œ (ì´ë¡œì¹˜ ë°˜ì˜)
function battleMyPickLine(myUid, db, p) {
  // enh ëŒ€ì‹  p ê°ì²´ ë°›ìŒ
  var e = enhLabel(p.enh);
  var pName = getDisplayName(p);  // â˜… ì—¬ê¸°ì„œ âœ¨ ì²˜ë¦¬
  return "ë‚´ í¬ì¼“ëª¬: #" + myUid + " " + pName + (e ? (" " + e) : "");
}
// [ìˆ˜ì •] ë°°í‹€ ê²°ê³¼ì°½ ìƒëŒ€ í¬ì¼“ëª¬ í‘œì‹œ
function battleOppPickLine(oppName, oppUid, db, p) {
  // enh ëŒ€ì‹  p ê°ì²´ ë°›ìŒ
  var e = enhLabel(p.enh);
  var pName = getDisplayName(p);  // â˜… ì—¬ê¸°ì„œ âœ¨ ì²˜ë¦¬
  return oppName + "ì˜ í¬ì¼“ëª¬: #" + oppUid + " " + pName + (e ? (" " + e) : "");
}
// [ìˆ˜ì •ë¨] ë°°í‹€ ì°¸ê°€ ê°€ëŠ¥ í¬ì¼“ëª¬ (ì˜¤ì§ ì—”íŠ¸ë¦¬ ë©¤ë²„ë§Œ!)
function getBattleEligiblePokemons(u) {
  if (!u || !u.party || u.party.length === 0) return [];
  
  var out = [];
  for (var i = 0; i < u.party.length; i++) {
    var uid = u.party[i];
    var pp = findUserPokemonByUid(u, uid);
    
    if (!pp) continue;
    // íƒí—˜ ì¤‘ì´ë©´ ì œì™¸
    if (isPokemonBusy(u, pp.uid)) continue; 
    
    // ìµœì†Œ ê°•í™” ì¡°ê±´ ë“±ì€ ìœ ì§€
    if ((pp.enh || 0) >= BATTLE_MIN_ENH) out.push(pp);
  }
  return out;
}

// [ìˆ˜ì •ë¨] í¬ê·€ë„/í„´ ë³´ì • (2-3í‹°ì–´ í†µí•© ë°¸ëŸ°ìŠ¤)
function getRarityBattleModifier(db, turn, hpRate) {
  var r = db.rarity || 1;
  var atkMod = 1.0;
  var defMod = 1.0;
  // 1. [2~3í‹°ì–´] ì–¸ë”ë…ì˜ ë°˜ë€ (ë²„í„°í”Œ, í”¼ì£¤íˆ¬, ë¼ì´ì¸„ ë“±)
  // "ë¬´ì‹œí•˜ì§€ ë§ˆë¼! ì¥ë„ ê¶ì§€ì— ëª°ë¦¬ë©´ ê³ ì–‘ì´ë¥¼ ë¬¸ë‹¤."
  // ì „ëµ: ë§ìœ¼ë©´ì„œ ë²„í‹°ë‹¤ê°€, ì²´ë ¥ ì ˆë°˜ ì´í•˜(ìœ„ê¸°)ì¼ ë•Œ í­ë”œì„ ë„£ì–´ì•¼ í•¨.
  if (r <= 3) {
    if (hpRate <= 0.5) {
      atkMod = 1.25;      // ê³µê²©ë ¥ 25% ë–¡ìƒ (ë°°ìˆ˜ì˜ ì§„)
    }
  } else if (r === 4) {
    if (turn >= 4 && turn <= 8) {
      atkMod = 1.15;      // ê³µ 15% ì¦ê°€
      defMod = 1.10;      // ë°© 10% ì¦ê°€
    }
  } else if (r === 5) {
    if (turn <= 3) {
      atkMod = 0.90;      // ì´ˆë°˜ 3í„´: 10% ë´ì¤Œ (ë°©ì‹¬)
    } else if (turn >= 10) {
      atkMod = 1.45;      // 10í„´ ì´í›„: 45% ë€ì¦ (ì¬ì•™)
      defMod = 1.15;      // ë§·ì§‘ë„ ì„¸ì§
    }
  }
  return {
  atk: atkMod, 
  def: defMod};
}
/* =========================
   ê°•í™” ë©˜íŠ¸ ì„¸íŠ¸ (ì™„í™” ë²„ì „)
========================= */

// ---------- ìƒìŠ¹ ----------
var ENH_UP_EASY = ["í›ˆë ¨ íš¨ê³¼ê°€ ë°”ë¡œ ë‚˜íƒ€ë‚¬ì–´ìš”.", "ëª¸ë†€ë¦¼ì´ í•œê²° ê°€ë²¼ì›Œì¡ŒìŠµë‹ˆë‹¤.", "í¬ì¼“ëª¬ì´ ì¦ê²ê²Œ ì„±ì¥í•˜ê³  ìˆì–´ìš”."];
var ENH_UP_MID = ["í›ˆë ¨ì´ ì‰½ì§„ ì•Šì•˜ì§€ë§Œ ì„±ê³¼ê°€ ìˆì—ˆì–´ìš”.", "í¬ì¼“ëª¬ì´ ì´ë¥¼ ì•…ë¬¼ê³  ë²„í…¨ëƒˆìŠµë‹ˆë‹¤.", "ì„±ì¥ì´ ëˆˆì— ë„ê²Œ ëŠê»´ì§‘ë‹ˆë‹¤."];
var ENH_UP_HARD = ["âš¡ ì ì¬ë ¥ì´ í¬ê²Œ ìê·¹ë°›ì•˜ìŠµë‹ˆë‹¤!", "ğŸ”¥ í•œê³„ë¥¼ ë„˜ëŠ” ì„±ì¥ì…ë‹ˆë‹¤!", "âœ¨ ìƒˆë¡œìš´ ê²½ì§€ì— í•œ ë°œ ë‹¤ê°€ì„°ì–´ìš”."];
// ---------- ìœ ì§€ ----------
var ENH_KEEP_EASY = ["í° ë³€í™”ëŠ” ì—†ì—ˆì§€ë§Œ ì•ˆì •ì ì´ì—ˆì–´ìš”.", "ì˜¤ëŠ˜ì€ ì»¨ë””ì…˜ ì ê²€ ì •ë„ë¡œ ì¶©ë¶„í•©ë‹ˆë‹¤.", "ë¬´ë¦¬í•˜ì§€ ì•ŠëŠ” ê²ƒë„ ì„±ì¥ì˜ ì¼ë¶€ì˜ˆìš”."];
var ENH_KEEP_MID = ["ê°„ì‹ íˆ ê· í˜•ì„ ìœ ì§€í–ˆìŠµë‹ˆë‹¤.", "ì„±ì¥ì€ ë©ˆì·„ì§€ë§Œ ë¬´ë„ˆì§€ì§„ ì•Šì•˜ì–´ìš”.", "ì§€ê¸ˆ ë‹¨ê³„ì—ì„  ì´ê²ƒë„ ë‚˜ì˜ì§€ ì•Šì•„ìš”."];
var ENH_KEEP_HARD = ["âš ï¸ ë§¤ìš° ì•„ìŠ¬ì•„ìŠ¬í•œ í›ˆë ¨ì´ì—ˆì–´ìš”.", "ğŸ”¥ í•œê³„ì—ì„œ ê°„ì‹ íˆ ë²„í…¨ëƒˆìŠµë‹ˆë‹¤.", "ì¡°ê¸ˆë§Œ ë” ë°€ì—ˆìœ¼ë©´ ìœ„í—˜í–ˆì„ì§€ë„ ëª°ë¼ìš”."];
// ---------- í•˜ë½ ----------
var ENH_DOWN_EASY = ["í›ˆë ¨ ê°•ë„ê°€ ì¡°ê¸ˆ ê³¼í–ˆë‚˜ ë´…ë‹ˆë‹¤.", "ì»¨ë””ì…˜ ì¡°ì ˆì´ í•„ìš”í•´ ë³´ì—¬ìš”.", "ì ì‹œ ì‰¬ì–´ê°€ëŠ” ê²Œ ì¢‹ê² ìŠµë‹ˆë‹¤."];
var ENH_DOWN_MID = ["í›ˆë ¨ ë¶€ë‹´ì´ ê·¸ëŒ€ë¡œ ë“œëŸ¬ë‚¬ìŠµë‹ˆë‹¤.", "í¬ì¼“ëª¬ì´ ë²„í‹°ê¸° í˜ë“¤ì–´í–ˆì–´ìš”.", "ì§€ê¸ˆ ë‹¨ê³„ì—ì„  ë¬´ë¦¬ì˜€ë˜ ê²ƒ ê°™ì•„ìš”."];
var ENH_DOWN_HARD = ["ğŸ’¢ í•œê³„ì— í¬ê²Œ ë¶€ë”ªí˜”ìŠµë‹ˆë‹¤.", "ğŸ”¥ ìœ„í—˜í•œ í›ˆë ¨ì´ì—ˆì–´ìš”.", "âš ï¸ ìƒíƒœê°€ ëˆˆì— ë„ê²Œ ë‚˜ë¹ ì¡ŒìŠµë‹ˆë‹¤."];
// ---------- ì´íƒˆ (ì™„í™”ëœ ì‚¬ë§) ----------
var ENH_EXIT_LINES = ["í¬ì¼“ëª¬ì´ í›ˆë ¨ì„ ë” ì´ìƒ ì´ì–´ê°€ê¸° í˜ë“  ìƒíƒœì…ë‹ˆë‹¤.", "í° ë¶€ë‹´ì´ ëˆ„ì ë˜ì–´ í›ˆë ¨ì—ì„œ ì´íƒˆí–ˆìŠµë‹ˆë‹¤.", "ì§€ê¸ˆì€ íœ´ì‹ê³¼ íšŒë³µì´ í•„ìš”í•œ ìƒíƒœì˜ˆìš”.", "ë¬´ë¦¬í•œ í›ˆë ¨ìœ¼ë¡œ ë” ì´ìƒ ë™í–‰í•  ìˆ˜ ì—†ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤."];
// ---------- í—¬ ê°“? ----------
var ENH_UP_HELL = ["ğŸ”¥ ë¶ˆê°€ëŠ¥ì„ ê°€ëŠ¥ìœ¼ë¡œ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤!", "ğŸ©¸ í”¼ì™€ ë•€ìœ¼ë¡œ ë§Œë“  ê²°ê³¼ì…ë‹ˆë‹¤!", "ğŸ”± ì‹ í™”ì ì¸ í˜ì´ ê¹ƒë“¤ê¸° ì‹œì‘í•©ë‹ˆë‹¤."];
var ENH_UP_GOD = ["ğŸ‘‘ ì´ê²ƒì€ ê¸°ì ì…ë‹ˆë‹¤! ì „ì„¤ì˜ íƒ„ìƒ!", "ğŸŒŒ ìš°ì£¼ê°€ ë‹¹ì‹ ì„ ë•ê³  ìˆìŠµë‹ˆë‹¤!", "ğŸŒŸ ì„œë²„ì˜ ì—­ì‚¬ë¥¼ ìƒˆë¡œ ì”ë‹ˆë‹¤!"];
var ENH_KEEP_HELL = ["ğŸ’€ ì‹¬ì¥ì´ ë©ˆì¶œ ë»”í–ˆìŠµë‹ˆë‹¤... ìœ ì§€ ì„±ê³µ.", "ğŸ›¡ï¸ íŒŒê´´ë˜ì§€ ì•Šì€ ê²ƒë§Œìœ¼ë¡œë„ ë‹¤í–‰ì…ë‹ˆë‹¤.", "ğŸ’¢ ë²½ì´ ë„ˆë¬´ë‚˜ë„ ë†’ìŠµë‹ˆë‹¤."];
var ENH_KEEP_GOD = ["ğŸŒŒ ì‹ ì˜ ì˜ì—­ì€ ì‰½ê²Œ í—ˆë½ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.", "ğŸ§˜ ë¬´ì‚¬í•œ ê²ƒì— ê°ì‚¬í•˜ì‹­ì‹œì˜¤.", "ğŸŒ«ï¸ í—ˆê³µì— ê³¨ë“œë¥¼ ë¿Œë ¸ì§€ë§Œ, í¬ì¼“ëª¬ì€ ë¬´ì‚¬í•©ë‹ˆë‹¤."];
var ENH_DOWN_HELL = ["ğŸ©¸ ë¼ˆì•„í”ˆ ì‹¤íŒ¨... ë‹¨ê³„ê°€ í•˜ë½í–ˆìŠµë‹ˆë‹¤.", "ğŸ“‰ ì •ì ì—ì„œ ë¯¸ë„ëŸ¬ì¡ŒìŠµë‹ˆë‹¤.", "ğŸ’” ìš•ì‹¬ì´ ê³¼í–ˆë˜ ê±¸ê¹Œìš”..."];
var ENH_DOWN_GOD = ["â˜„ï¸ ì¶”ë½í•˜ëŠ” ê²ƒì€ ë‚ ê°œê°€ ìˆë‹¤...", "ğŸ“‰ ì‹ ì˜ ë¶„ë…¸ë¥¼ ìƒ€ìŠµë‹ˆë‹¤.", "ğŸŒ‘ ë‹¤ì‹œ ë°‘ë°”ë‹¥ë¶€í„° ê¸°ì–´ì˜¬ë¼ê°€ì•¼ í•©ë‹ˆë‹¤."];
// -------------------- ê°•í™” ê²°ê³¼ ë©˜íŠ¸ ë¹Œë” (ì´ë¡œì¹˜ ë°˜ì˜ ë²„ì „) --------------------
function buildEnhResultMsg(sender, p, before, after, resultType) {
  var tier = getEnhTier(before);
  var line = "";
  // â˜… í¬ì¼“ëª¬ ê°ì²´(p)ë¥¼ ë„£ì–´ì„œ âœ¨ë³„ì´ ë¶™ì€ ì´ë¦„ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
  var pShowName = getDisplayName(p);
  if (resultType === ENH_RESULT_UP) {
    if (tier === "EASY") 
      line = pick(ENH_UP_EASY);
    else if (tier === "MID") 
      line = pick(ENH_UP_MID);
    else if (tier === "HARD") 
      line = pick(ENH_UP_HARD);
    else if (tier === "HELL") 
      line = pick(ENH_UP_HELL);
    else 
      line = pick(ENH_UP_GOD);
  } else if (resultType === ENH_RESULT_KEEP) {
    if (tier === "EASY") 
      line = pick(ENH_KEEP_EASY);
    else if (tier === "MID") 
      line = pick(ENH_KEEP_MID);
    else if (tier === "HARD") 
      line = pick(ENH_KEEP_HARD);
    else if (tier === "HELL") 
      line = pick(ENH_KEEP_HELL);
    else 
      line = pick(ENH_KEEP_GOD);
  } else if (resultType === ENH_RESULT_DOWN) {
    if (tier === "EASY") 
      line = pick(ENH_DOWN_EASY);
    else if (tier === "MID") 
      line = pick(ENH_DOWN_MID);
    else if (tier === "HARD") 
      line = pick(ENH_DOWN_HARD);
    else if (tier === "HELL") 
      line = pick(ENH_DOWN_HELL);
    else 
      line = pick(ENH_DOWN_GOD);
  } else if (resultType === ENH_RESULT_EXIT) {
    line = pick(ENH_EXIT_LINES);
  }
  var afterLabel = (resultType === ENH_RESULT_EXIT) ? "ì´íƒˆ" : enhLabelAlways(after);
  // pName ëŒ€ì‹  pShowNameì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
  var header = "ğŸ¾ " + sayDo(sender, pShowName + " í›ˆë ¨ ê²°ê³¼") + "\n" + "ğŸ“Š ê°•í™” ë‹¨ê³„: " + enhLabelAlways(before) + " â†’ " + afterLabel + "\n\n";
  return header + line;
}
function pct(x) {
  return Math.floor(x * 1000) / 10;
}
function clamp01(x) {
  return Math.max(0, Math.min(1, x));
}
// [ë°¸ëŸ°ìŠ¤ íŒ¨ì¹˜] 60ê°• ì²´ì œ í™•ë¥ í‘œ
// 0~20: ì§„í™” ì§€ì› (í˜œì)
// 30~40: í†µê³¡ì˜ ë²½ (ë‘ì«€ì¿  ìœ ë„ ì‹œì‘)
// 40~60: 1~2% (ë‘ì«€ì¿  í•„ìˆ˜ êµ¬ê°„)
function enhanceRatesByRarity(nextEnh, trainerLv, rarity) {
  nextEnh = parseInt(nextEnh, 10);
  if (isNaN(nextEnh)) 
    nextEnh = 1;
  var curEnh = nextEnh - 1;
  var min = 0.01, max = 0.01;
  // [êµ¬ê°„ë³„ í™•ë¥  ì„¤ì •]
  if (curEnh < 5) {
    min = 0.95;
    max = 1.00;
  } else if (curEnh < 10) {
    min = 0.80;
    max = 0.90;
  } else if (curEnh < 15) {
    min = 0.60;
    max = 0.75;
  } else if (curEnh < 20) {
    min = 0.40;
    max = 0.55;
  } else if (curEnh < 30) {
    min = 0.15;
    max = 0.30;
  } else if (curEnh < 40) {
    min = 0.03;
    max = 0.08;
  } else {
    min = 0.01;
    max = 0.02;
  }
  // êµ¬ê°„ ë‚´ ë¯¸ì„¸ ì¡°ì •
  var rangeSize = 5;
  if (curEnh >= 20) 
    rangeSize = 10;
  if (curEnh >= 40) 
    rangeSize = 20;
  var segmentPos = curEnh % rangeSize;
  var t = clamp01(segmentPos / rangeSize);
  var base = max - (max - min) * t;
  // [ë ˆë²¨ ë³´ì •] (ìµœëŒ€ +8%)
  // 40ê°• ì´í›„ì—” ë ˆë²¨ë¹¨ë„ ê±°ì˜ ì•ˆ ë°›ê²Œ ë„ˆí”„ (ì¿ í‚¤ ê°€ì¹˜ ë³´ì¡´)
  var lv = trainerLv || 1;
  var bonus = (lv - 1) * 0.0008;
  if (curEnh >= 40) 
    bonus = 0;  // 40ê°•ë¶€í„°ëŠ” ë ˆë²¨ ë³´ì • ì—†ìŒ (ìˆœìˆ˜ ìš´ or ì¿ í‚¤)
  else if (bonus > 0.08) 
    bonus = 0.08;
  var success = base + bonus;
  // [í¬ê·€ë„ ë³´ì •] ì „ì„¤(5ì„±)ì€ 30ê°• ì´í›„ ì•„ì£¼ ì¡°ê¸ˆ ë³´ì •
  if (rarity === 5 && curEnh >= 30) 
    success += 0.005;
  success = clamp01(success);
  if (success < 0.01) 
    success = 0.01;  // ìµœì†Œ 1% ë³´ì¥
  return {
  success: success, 
  keep: 1 - success, 
  death: 0};
}
function buildNextEnhInfoLine(p, resultType, u) {
  if (resultType === ENH_RESULT_EXIT) {
    return "\n\nğŸ“Œ ë‹¤ë¥¸ í¬ì¼“ëª¬ì„ ê°•í™”í•˜ë ¤ë©´ /ë‚´í¬ì¼“ëª¬ ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.";
  }
  if (!p) 
    return "";
  var dbx = findPokemonDB(p.pid);
  var rr = dbx ? dbx.rarity : 2;
  // âœ… ë‹¤ìŒ ì‹œë„ëŠ” (í˜„ì¬ ê°•í™” + 1)ì„ ëª©í‘œë¡œ í•¨
  var nextEnh = Math.min(ENHANCE_MAX, (p.enh || 0) + 1);
  // ê¸°ì¡´: var rates = enhanceRatesByRarity(p.enh, (u ? u.trainerLv : 1), rr);
  var rates = enhanceRatesByRarity(nextEnh, (u ? u.trainerLv : 1), rr);
  // ê¸°ì¡´: var nextCost = enhanceCostByRarity(p.enh, rr);
  var nextCost = enhanceCostByRarity(nextEnh, rr);
  var myGold = (u && typeof u.gold === "number") ? u.gold : null;
  var out = "";
  out += "\n\ní˜„ì¬ ë³´ìœ  ê³¨ë“œ : " + (myGold === null ? "-" : (fmtNum(myGold) + "ğŸ’°")) + "\n";
  out += "ë‹¤ìŒ ê°•í™” ì„±ê³µ í™•ë¥  : " + pct(rates.success) + "%\n";
  out += "ë‹¤ìŒ ê°•í™” í•„ìš” ê³¨ë“œ : " + fmtNum(nextCost) + "ğŸ’°";
  return out;
}
function cooldownRemainMsg(sender, lastAt, cooldownMs, actionName) {
  var now = nowMs();
  var remainMs = cooldownMs - (now - lastAt);
  if (remainMs < 0) 
    remainMs = 0;
  var sec = Math.ceil(remainMs / 1000);
  return sender + "ë‹˜, " + sec + "ì´ˆ í›„ ë‹¤ì‹œ " + actionName + "í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
}
// -------------------- [ì‹ ê·œ] íƒí—˜ ìƒíƒœ í™•ì¸ ìœ í‹¸ -------------------
function isPokemonBusy(u, uid) {
  if (!u.exploration) 
    return false;
  if (u.exploration.uid === uid) 
    return true;
  return false;
}
function getExploringPokemon(u) {
  if (!u.exploration) 
    return null;
  return findUserPokemonByUid(u, u.exploration.uid);
}
// ğŸ§­ [í•¨ìˆ˜] íƒí—˜ ìƒíƒœ ë° ë£¨íŠ¸ ìƒì„±ê¸° (ë‹¤ì´ë‚˜ë¯¹ ë²„ì „)
function getExploreProgress(u, p) {
  var now = new Date().getTime();
  var totalTime = 30 * 60 * 1000; // ê¸°ë³¸ 30ë¶„ ê¸°ì¤€
  var remain = u.exploreEndTime - now;
  var elapsed = totalTime - remain;
  var progress = Math.max(0, Math.min(100, Math.floor((elapsed / totalTime) * 100)));
  
  // íƒí—˜ ë‹¨ê³„ë³„ ìƒí™© ì—°ì¶œ (ì§„í–‰ë„ì— ë”°ë¼ ë³€í™”)
  var stages = [
    "ğŸš© ì…êµ¬ì—ì„œ ì¥ë¹„ ì ê²€ ì¤‘...",
    "ğŸŒ² ìš¸ì°½í•œ ìˆ²ì„ í—¤ì¹˜ë©° ë‚˜ì•„ê°€ëŠ” ì¤‘",
    "â›°ï¸ ê°€íŒŒë¥¸ ì–¸ë•ì„ ì˜¤ë¥´ë©° ì£¼ë³€ íƒìƒ‰",
    "ğŸ’§ ì‹œì›í•œ í­í¬ ì˜†ì—ì„œ ì ì‹œ íœ´ì‹",
    "ğŸ•¯ï¸ ì–´ë‘ìš´ ë™êµ´ ê¹Šìˆ™í•œ ê³³ìœ¼ë¡œ ì§„ì…",
    "âœ¨ ì „ì„¤ì˜ ê¸°ìš´ì´ ëŠê»´ì§€ëŠ” ì§€ì ì— ë„ë‹¬",
    "ğŸƒ ë³µê·€ë¥¼ ìœ„í•´ ë‹¤ì‹œ ëŒì•„ì˜¤ëŠ” ì¤‘"
  ];
  
  var stageIdx = Math.min(stages.length - 1, Math.floor((progress / 100) * stages.length));
  var currentStage = stages[stageIdx];
  
  // ê²Œì´ì§€ ë°” ìƒì„± (visual)
  var barCount = 10;
  var activeBars = Math.floor((progress / 100) * barCount);
  var bar = "ğŸŸ¥".repeat(activeBars) + "â¬œ".repeat(barCount - activeBars);
  
  return {
    stage: currentStage,
    progress: progress,
    bar: bar,
    remainMin: Math.floor(remain / 60000),
    remainSec: Math.floor((remain % 60000) / 1000)
  };
}
// -------------------- ëœë¤ ë©˜íŠ¸ ì„¸íŠ¸ --------------------
function pick(arr) {
  return arr[Math.floor(Math.random() * arr.length)];
}
// í•„ë“œ íƒìƒ‰/ì¡°ìš° ë©˜íŠ¸
var FIELD_SEARCH_LINES = ["ì£¼ë³€ì„ ë‘ë¦¬ë²ˆê±°ë ¸ì–´ìš”.", "í’€ìˆ²ì„ í—¤ì§‘ê³  ë“¤ì–´ê°”ì–´ìš”.", "ë°œì†Œë¦¬ë¥¼ ì£½ì´ê³  ì‚´ê¸ˆì‚´ê¸ˆ ë‹¤ê°€ê°”ì–´ìš”.", "ë­”ê°€ ìˆ˜ìƒí•œ ê¸°ìš´ì´ ëŠê»´ì ¸ìš”â€¦", "ì´ë²ˆì—” ë­”ê°€ ë‚˜ì˜¬ ê²ƒ ê°™ì€ë°ìš”?"];
var FIELD_ENCOUNTER_LINES = ["ì™€! ê°‘ìê¸° íŠ€ì–´ë‚˜ì™”ì–´ìš”!", "ëˆˆì´ ë§ˆì£¼ì³¤ì–´ìš”â€¦!", "ê¸°ì²™ì„ ëŠë¼ê³  ë‚˜íƒ€ë‚¬ì–´ìš”!", "ì‚¬ë‚©ê²Œ ìš¸ë¶€ì§–ìœ¼ë©° ë‹¤ê°€ì™€ìš”!", "ê°€ë§Œíˆ ìˆë‹¤ê°€ ìŠ¬ì© ëª¨ìŠµì„ ë“œëŸ¬ëƒˆì–´ìš”!"];
// í¬íš ì„±ê³µ/ì‹¤íŒ¨ ë“œë¦½
var CATCH_SUCCESS_LINES = ["ë”¸ê¹! ì™„ë²½í–ˆì–´ìš”.", "ì˜¤ì¼€ì´! ì†ë§› ì œëŒ€ë¡œë„¤ìš”.", "ë“¤ì–´ê°”ë‹¤! ì¡ì•˜ë‹¤!", "ê¹”ë”í•˜ê²Œ í¬íš ì„±ê³µ!", "ì˜¤ëŠ˜ ìš´ ì¢‹ì€ë°ìš”?"];
var CATCH_FAIL_LINES = ["ì•—! íŠ€ì–´ë‚˜ì™”ì–´ìš”â€¦", "ì•„ê¹ë‹¤â€¦ ì†ëì—ì„œ ë¹ ì ¸ë‚˜ê°”ì–´ìš”.", "ë°©ê¸ˆ ì¡ì€ ì¤„ ì•Œì•˜ëŠ”ë°!", "êµ¬ë¥´ë‹¤ê°€ íˆ­! íƒˆì¶œí–ˆì–´ìš”.", "ì´ê±´â€¦ ì¢€ ì–µìš¸í•œë°ìš”?"];
var CATCH_TRY_AGAIN_LINES = ["ë‹¤ì‹œ í•œ ë²ˆë§Œ ë”!", "ì´ë²ˆì—” ì§„ì§œ ì¡ì•„ë³´ì.", "ë³¼ë§Œ ë” ìˆìœ¼ë©´ ëœë‹¤â€¦", "ë‹¤ìŒì—” ë” ê°•í•œ ë³¼ë¡œ ê°€ì.", "ì¹¨ì°©â€¦ ì¹¨ì°©â€¦"];
// ë°°í‹€ ìš”ì•½ í•´ì„¤ ë©˜íŠ¸
var BATTLE_COMMENT_WIN = ["ì˜¤ëŠ˜ ì»¨ë””ì…˜ ë¯¸ì³¤ë‹¤!", "ì™„ë²½í•œ ìš´ì˜ì´ì—ˆì–´ìš”.", "ìƒì„±/ê°•í™”/ê° ëª¨ë‘ ì¢‹ì•˜ë„¤ìš”.", "ìƒëŒ€ê°€ ë‹¹í™©í–ˆì„ ë“¯!", "ì´ ë§›ì— ë°°í‹€í•˜ì£ ."];
var BATTLE_COMMENT_LOSE = ["ì•„â€¦ ë‹¤ìŒì—” ë³µìˆ˜ì „ ê°‘ì‹œë‹¤.", "ìƒëŒ€ê°€ í•œ ìˆ˜ ìœ„ì˜€ì–´ìš”.", "ìš´ì´ ì‚´ì§ ì•ˆ ë”°ë¼ì¤¬ë„¤ìš”.", "ê´œì°®ì•„ìš”. ê²½í—˜ì¹˜ê°€ ìŒ“ì˜€ì–´ìš”.", "ë‹¤ìŒ íŒì—” ë’¤ì§‘ëŠ”ë‹¤."];
var BATTLE_COMMENT_DRAW = ["íŒ½íŒ½í–ˆë‹¤â€¦ ì§„ì§œ íŒ½íŒ½!", "ë‘˜ ë‹¤ í•œ ë— ì°¨ì´ì˜€ì–´ìš”.", "ìŠ¹ë¶€ê°€ ì•ˆ ë‚˜ë„¤â€¦ ë‹¤ì‹œ?", "ë¬´ìŠ¹ë¶€ë„ ë‚˜ì˜ì§€ ì•Šì£ .", "ì„œë¡œ ì¸ì •!"];
// ë¬´ìŠ¹ë¶€ streak ë¦¬ì…‹ ë¬¸êµ¬ (ë„¤ ì •ì±… ì“¸ ë•Œ)
var STREAK_RESET_DRAW_LINES = ["ë¬´ìŠ¹ë¶€ë¼ ì—°ìŠ¹ì€ ì—¬ê¸°ì„œ ì ê¹ ë©ˆì·„ì–´ìš”.", "ìŠ¹ë¶€ê°€ ì•ˆ ë‚¬ìœ¼ë‹ˆ ì—°ìŠ¹ì€ ë¦¬ì…‹!", "ë¬´ìŠ¹ë¶€! ì—°ìŠ¹ ê¸°ë¡ì€ ì ì‹œ ë³´ë¥˜!", "íŒ½íŒ½í–ˆì§€ë§Œâ€¦ ì—°ìŠ¹ì€ ì´ˆê¸°í™”!"];
function blockTitle(t) {
  return "ã€" + t + "ã€‘\n";
}
function joinLines(arr) {
  var out = "";
  for (var i = 0; i < arr.length; i++) 
    out += arr[i] + "\n";
  return out;
}
var EMPHASIS_RARE5 = ["âœ¨ í¬ê·€í•œ ê¸°ìš´ì´ ëŠê»´ì§‘ë‹ˆë‹¤â€¦", "âœ¨ ê³µê¸°ê°€ ë‹¬ë¼ì¡Œì–´ìš”â€¦ ë­”ê°€ ì˜¨ë‹¤!", "âœ¨ ë“±ê³¨ì´ ì„œëŠ˜í•´ì¡ŒìŠµë‹ˆë‹¤â€¦", "âœ¨ ì´ê±´â€¦ ì§„ì§œë‹¤."];
var EMPHASIS_LEGENDARY = ["ğŸ”¥ ì „ì„¤ê¸‰ í¬ì¼“ëª¬ ì¶œí˜„!", "ğŸ”¥ ë¶„ìœ„ê¸° ë¬´ì—‡â€¦ ì „ì„¤ ê°ì¸ë°ìš”?", "ğŸ”¥ ì´ê±´ ì¡ì•„ì•¼ í•©ë‹ˆë‹¤. ë¬´ì¡°ê±´.", "ğŸ”¥ ì‹¬ì¥ì´ ë›´ë‹¤â€¦ ì „ì„¤ì´ë‹¤!"];
var CATCH_FAIL_DRIP_LINES = ["ğŸ’¥ ì•„â€¦ ë°©ê¸ˆ ê·¸ê±° ì¡ì„ ë»”í–ˆëŠ”ë°!", "ğŸ˜µâ€ğŸ’« ì†ì´ ë¯¸ë„ëŸ¬ì¡Œì–´ìš”â€¦ ë‹¤ì‹œ!", "ğŸ˜¤ ì•„ë‹ˆ ì´ê²Œ ì™œ ì•ˆ ì¡í˜€â€¦?", "ğŸ¥² ë³¼ì´ ë°°ì‹ í–ˆì–´ìš”â€¦", "ğŸ«  ì§„ì§œ ë”± í•œ ë²ˆë§Œ ë”â€¦"];
var CATCH_FAIL_TIP_LINES = ["íŒíŠ¸: ë” ì¢‹ì€ ë³¼ì´ë©´ í™•ë¥ ì´ ì˜¬ë¼ê°€ìš”.", "íŒíŠ¸: íŠ¸ë ˆì´ë„ˆ ë ˆë²¨ì´ ì˜¤ë¥´ë©´ í¬íš ë³´ë„ˆìŠ¤ë„ ì˜¬ë¼ê°€ìš”.", "íŒíŠ¸: ìŠˆí¼ë³¼/í•˜ì´í¼ë³¼ë¡œ ì••ë°•í•´ë´…ì‹œë‹¤.", "íŒíŠ¸: ìš´ë„ ì‹¤ë ¥ì…ë‹ˆë‹¤â€¦(ì•„ë§ˆë„)"];
var COOLDOWN_LINES = ["ì•„ì§ ìˆ¨ ì¢€ ëŒë¦¬ëŠ” ì¤‘ì´ì—ìš”. ì ì‹œë§Œìš”!", "ì ê¹ë§Œ! ì¬ì •ë¹„í•˜ê³  ë‹¤ì‹œ ê°€ìš”.", "ì¡°ê¸ˆë§Œ ê¸°ë‹¤ë¦¬ë©´ ë°”ë¡œ ë‹¤ì‹œ í•  ìˆ˜ ìˆì–´ìš”."];
function enhLabel(enh) {
  // 0ì´ë©´ í‘œê¸° ì•ˆ í•¨ (ë‚´í¬ì¼“ëª¬/ë°°í‹€ í‘œê¸°ìš©)
  return (enh > 0) ? (enh + "ê°•") : "";
}
function enhLabelAlways(enh) {
  // 0ë„ í‘œê¸° (ê°•í™” ê²°ê³¼ â€œ0ê°• â†’ 1ê°•â€ ê°™ì€ í‘œê¸°ìš©)
  return (enh + "ê°•");
}
function ensureUserDex(u) {
  if (!u.dex) 
    u.dex = {};
  for (var k in u.dex) {
    if (u.dex.hasOwnProperty(k)) {
      if (typeof u.dex[k] === "number") {
        u.dex[k] = {
  seen: 0, 
  caught: u.dex[k]};
      }
    }
  }
  // ë§ˆì´ê·¸ë ˆì´ì…˜: í˜„ì¬ ë³´ìœ  í¬ì¼“ëª¬ì€ ìµœì†Œ caught 1ë¡œ ë‚¨ê²¨ì¤Œ
  if (u.pokemons && u.pokemons.length > 0) {
    for (var i = 0; i < u.pokemons.length; i++) {
      var p = u.pokemons[i];
      if (!p || p.pid == null) 
        continue;
      var pid = String(p.pid);
      if (!u.dex[pid]) 
        u.dex[pid] = {
  seen: 0, 
  caught: 0};
      if (u.dex[pid].caught < 1) 
        u.dex[pid].caught = 1;
    }
  }
}
function dexSeen(u, pid) {
  ensureUserDex(u);
  pid = String(pid);
  if (!u.dex[pid]) 
    u.dex[pid] = {
  seen: 0, 
  caught: 0};
  u.dex[pid].seen += 1;
}
// =========================================================
// ğŸ› ï¸ [ì‚¬ì¥ë‹˜ íŒ¨ì¹˜] ì´ë¡œì¹˜/ë“±ê¸‰ ëˆ„ë½ ë°©ì§€ ê¸´ê¸‰ ìˆ˜ì •ë³¸
// (ê¹ƒí—ˆë¸Œ ì½”ë“œë³´ë‹¤ ì•„ë˜ì— ë¶™ì—¬ë„£ì–´ì„œ ë®ì–´ì”Œì›€)
// =========================================================
// 1. ë„ê° ë“±ë¡ í•¨ìˆ˜ (ì´ë¡œì¹˜ ë„ì¥ ì¾…!)
function dexCaught(u, pid, grade, isShiny) {
  ensureUserDex(u);
  pid = String(pid);
  if (!u.dex[pid]) {
    u.dex[pid] = {
  seen: 0, 
  caught: 0, 
  maxGrade: "D", 
  hasShiny: false};
  }
  u.dex[pid].caught += 1;
  var curMax = u.dex[pid].maxGrade || "D";
  var scoreNew = (GRADE_ORDER && GRADE_ORDER[grade]) ? GRADE_ORDER[grade] : 0;
  var scoreCur = (GRADE_ORDER && GRADE_ORDER[curMax]) ? GRADE_ORDER[curMax] : 0;
  if (scoreNew > scoreCur) 
    u.dex[pid].maxGrade = grade;
  if (isShiny) 
    u.dex[pid].hasShiny = true;  // â˜… ì´ë¡œì¹˜ ë°•ì œ
}
// 2. í¬ì¼“ëª¬ ì¶”ê°€ í•¨ìˆ˜ (íšë“ ì‹œì ë¶€í„° ë°ì´í„° ë³´ì¡´)
function addPokemonToUser(u, pid, isShiny) {
  var uid = nextPokemonUid(u);
  var grade = generatePokemonGrade();
  var ivs = generateIVsByGrade(grade);
  u.pokemons.push({
  uid: uid, 
  pid: pid, 
  enh: 0, 
  grade: grade, 
  ivStr: ivs.str, 
  ivHp: ivs.hp, 
  ivSpd: ivs.spd, 
  shiny: !!isShiny});
  dexCaught(u, pid, grade, !!isShiny);  // â˜… ì •ë³´ ë„˜ê¹€
  return uid;
}
// ì´ì œ í¬íšì´ë“  êµí™˜ì´ë“  ë¬´ì¡°ê±´ ì´ í•¨ìˆ˜ë¥¼ ì“°ë©´ ì¤‘ë³µì´ ì ˆëŒ€ ì•ˆ ìƒê¹ë‹ˆë‹¤.
function nextPokemonUid(u) {
  if (!u.pokemons) 
    u.pokemons = [];
  var max = 0;
  for (var i = 0; i < u.pokemons.length; i++) {
    // ì•ˆì „í•˜ê²Œ ìˆ«ìë¡œ ë³€í™˜í•´ì„œ ë¹„êµ
    var p = u.pokemons[i];
    if (p && p.uid) {
      var uid = parseInt(p.uid, 10);
      if (!isNaN(uid) && uid > max) {
        max = uid;
      }
    }
  }
  // ë¬´ì¡°ê±´ (ê°€ì¥ í° ë²ˆí˜¸ + 1) ë¦¬í„´
  var newUid = max + 1;
  // ì¹´ìš´í„° ë³€ìˆ˜ë„ í˜¹ì‹œ ëª¨ë¥´ë‹ˆ ê°±ì‹ í•´ë‘  (í•˜ìœ„ í˜¸í™˜ì„±)
  u.nextPokeUid = newUid + 1;
  return newUid;
}
function expNeed(lv) {
  var L = Math.max(1, Math.min(MAX_LV, lv));
  var x = L - 1;
  return 90 + 18 * x + 5 * x * x;
}
function onLevelUpReward(u) {
  u.ball += 2;
  u.gold += 180;
  if (u.trainerLv % 10 === 0 && u.trainerLv < 99) {
    u.superBall += 5;
    u.ultraBall += 2;
  }
  if (u.trainerLv === 99) {
    u.superBall += 10;
    u.ultraBall += 5;
  }
}
function addExpAndCheckLevelUp(u, expGained) {
  var leveled = false;
  u.trainerExp += expGained;
  while (u.trainerLv < MAX_LV && u.trainerExp >= expNeed(u.trainerLv)) {
    u.trainerExp -= expNeed(u.trainerLv);
    u.trainerLv += 1;
    leveled = true;
    onLevelUpReward(u);
  }
  return leveled;
}
// -------------------- ë ˆë²¨ì—… ë©”ì‹œì§€(ë³´ìƒ í¬í•¨) --------------------
function addExpWithLevelUpMsg(u, expGained) {
  var beforeLv = u.trainerLv;
  var bGold = u.gold;
  var bBall = u.ball;
  var bSuper = u.superBall;
  var bUltra = u.ultraBall;
  var leveled = addExpAndCheckLevelUp(u, expGained);
  if (!leveled) 
    return "";
  var gGold = u.gold - bGold;
  var gBall = u.ball - bBall;
  var gSuper = u.superBall - bSuper;
  var gUltra = u.ultraBall - bUltra;
  var line = "ğŸŠ ë ˆë²¨ì—…! Lv." + beforeLv + " â†’ Lv." + u.trainerLv;
  var rewards = [];
  if (gGold > 0) 
    rewards.push("+" + gGold + "ğŸ’°");
  if (gBall > 0) 
    rewards.push("+" + gBall + " ëª¬ìŠ¤í„°ë³¼");
  if (gSuper > 0) 
    rewards.push("+" + gSuper + " ìŠˆí¼ë³¼");
  if (gUltra > 0) 
    rewards.push("+" + gUltra + " í•˜ì´í¼ë³¼");
  if (rewards.length > 0) {
    line += "\nğŸ ë ˆë²¨ì—… ë³´ìƒ: " + rewards.join(" / ");
  }
  return line;
}
// -------------------- ìŠ¤í°/í¬ê·€ë„ ê°€ì¤‘ì¹˜ --------------------
// [ë°¸ëŸ°ìŠ¤ ìˆ˜ì •] í¬ê·€ë„ë³„ ì¶œí˜„ ê°€ì¤‘ì¹˜ (ê³ ë“±ê¸‰ í™•ë¥  UP!)
function raritySpawnWeight(r) {
  if (r === 1) 
    return 1.00;
  if (r === 2) 
    return 0.95;
  if (r === 3) 
    return 0.80;
  if (r === 4) 
    return 0.55;
  return 0.35;
}
function enhanceCost(nextEnh) {
  nextEnh = parseInt(nextEnh, 10);
  if (isNaN(nextEnh)) 
    nextEnh = 1;
  if (nextEnh < 1) 
    nextEnh = 1;
  if (nextEnh > ENHANCE_MAX) 
    nextEnh = ENHANCE_MAX;
  return 25 + Math.floor(nextEnh * nextEnh * 2.6);
}
function rarityCostMult(rarity) {
  // í¬ê·€ë„ 1ì€ ì‹¸ê³  5ëŠ” ë§¤ìš° ë¹„ì‹¸ê²Œ
  if (rarity <= 1) 
    return 1.0;
  if (rarity === 2) 
    return 1.4;
  if (rarity === 3) 
    return 1.9;
  if (rarity === 4) 
    return 2.6;
  return 3.6;
}
// ê¸°ì¡´ enhanceCost(enh)ëŠ” "ë² ì´ìŠ¤ ë¹„ìš©"ìœ¼ë¡œ ìœ ì§€í•˜ê³ ,
// ì‹¤ì œ ì°¨ê°ì—ëŠ” ì•„ë˜ í•¨ìˆ˜ ì‚¬ìš©
function enhanceCostByRarity(enh, rarity) {
  var base = enhanceCost(enh);
  var mult = rarityCostMult(rarity || 2);
  // ê³ ê°•í™” êµ¬ê°„ ì¶”ê°€ ê°€ì¤‘ì¹˜(ì „ì„¤ ê°€ì¹˜ ìƒìŠ¹ í•µì‹¬)
  // enh 15ë¶€í„° ì„œì„œíˆ, 20ë¶€í„° í™•ì‹¤íˆ ë¹„ì‹¸ì§€ê²Œ
  var extra = 1.0;
  if (enh >= 15) 
    extra += (enh - 14) * 0.03;  // 15->1.03, 20->1.18
  if (enh >= 20) 
    extra += (enh - 19) * 0.04;  // 20->+0.04, 25->+0.24
  return Math.floor(base * mult * extra);
}
// [ìˆ˜ì •ë¨] íŒë§¤ê°€ ê³„ì‚° (ì¸í”Œë ˆ ë°©ì§€: ì ë‹¹í•œ ìƒí•œì„  ìœ ì§€)
function sellPrice(pid, enh, grade) {
  var db = findPokemonDB(pid);
  if (!db) 
    return 1;
  var r = db.rarity || 2;
  enh = parseInt(enh, 10) || 0;
  if (enh > ENHANCE_MAX) 
    enh = ENHANCE_MAX;
  var baseByR = [0, 1000, 2500, 7000, 40000, 80000];
  var base = baseByR[r] || 2500;
  var e0 = Math.min(enh, 14);
  var lin = e0 * (40 + r * 18);
  var quad = (e0 * e0) * (6 + r * 3);
  var premium15 = 0;
  if (enh >= 15) {
    var e15 = Math.min(enh, 19) - 14;
    premium15 = e15 * (700 + r * 450);
  }
  var premium20 = 0;
  if (enh >= 20) {
    var e20 = Math.min(enh, 24) - 19;
    premium20 = (e20 * e20) * (6000 + r * 2500);
  }
  var premium25 = 0;
  if (enh >= 25) {
    var e25 = enh - 24;
    premium25 = (e25 * e25 * e25) * (12000 + r * 5000);
  }
  var price = Math.floor((base + lin + quad + premium15 + premium20 + premium25) * 5);
  // ë“±ê¸‰ ë³´ë„ˆìŠ¤
  var gradeMult = 1.0;
  if (grade === "S") 
    gradeMult = 2.0;
  else if (grade === "A") 
    gradeMult = 1.6;
  else if (grade === "B") 
    gradeMult = 1.2;
  else if (grade === "C") 
    gradeMult = 1.0;
  else 
    gradeMult = 0.8;
  price = Math.floor(price * gradeMult);
  // â˜… [ì¸í”Œë ˆ ë°©ì§€ ìº¡]
  // ë„ˆë¬´ ë†’ì§€ ì•Šê²Œ ì„¤ì •í•˜ì—¬ ê³ ê°•í™” í¬ì¼“ëª¬ì€ "ìœ ì € ê±°ë˜"ë¥¼ ìœ ë„í•¨
  var cap = (r === 5) ? 20000000 : (r === 4) ? 15000000 : (r === 3) ? 8000000 : 5000000;
  // ì¡ëª¹: 500ë§Œ
  if (price > cap) 
    price = cap;
  return price;
}
function rarityCatchMod(rarity) {
  // í¬ê·€ë„ë³„ í¬íš ë‚œì´ë„ ê³„ìˆ˜ (ë‚®ì„ìˆ˜ë¡ ì–´ë ¤ì›€)
  // ì²´ê° ì°¨ì´ í¬ê²Œ ì„¤ê³„
  if (rarity <= 1) 
    return 1.40;
  if (rarity === 2) 
    return 1.15;
  if (rarity === 3) 
    return 0.85;
  if (rarity === 4) 
    return 0.55;
  return 0.32;
}
function trainerCatchBonus(lv) {
  lv = Math.max(1, Math.min(99, lv || 1));
  // 1ë ˆë²¨ 0% â†’ 50ë ˆë²¨ ì•½ +18% â†’ 99ë ˆë²¨ +30%
  return 0.30 * Math.sqrt((lv - 1) / 98);
}
// 1. íƒí—˜ ê³¨ë“œ ê³„ì‚° (8~15ë°° ì¦ê°€ ë²„ì „ ìœ ì§€ ë° ìº¡ ì—†ìŒ)
function calcExploreGold(u) {
  var base = Math.floor(Math.random() * (EXPLORE_GOLD_MAX - EXPLORE_GOLD_MIN + 1) + EXPLORE_GOLD_MIN);
  var lv = Math.max(1, u.trainerLv || 1);
  var mult = 1 + (lv * EXPLORE_LV_RATE);
  return Math.floor(base * mult);
}

// 2. íƒí—˜ ê²½í—˜ì¹˜ ê³„ì‚° (ì ë‹¹í•œ íŒŒë°ì„ ìœ„í•´ 3ë°° -> 1.5ë°°ë¡œ ì¡°ì •)
function calcExploreExp() {
  var base = Math.floor(Math.random() * (EXPLORE_EXP_MAX - EXPLORE_EXP_MIN + 1) + EXPLORE_EXP_MIN);
  // â˜… ì‚¬ì¥ë‹˜ ì§€ì‹œ: ì ë‹¹í•œ íŒŒë°ì„ ìœ„í•´ 1.5ë°°ë¡œ ì„¸íŒ…
  return Math.floor(base * 1.5);
}

// 3. ì •ìˆ˜ ì œí•œ ìœ í‹¸ë¦¬í‹°
function clampInt(n, a, b) {
  n = Math.floor(n);
  return Math.max(a, Math.min(b, n));
}

// 4. í¬íš ê³¨ë“œ ê³„ì‚° (ì†Œí”„íŠ¸ ìƒí–¥ ë° ë ˆë²¨ íš¨ìœ¨ ê°•í™”)
function calcCatchGold(u, db, ballType) {
  // ë² ì´ìŠ¤ ë²”ìœ„ë¥¼ ê¸°ì¡´ë³´ë‹¤ ì•½ 2ë°° ìƒí–¥
  var base = Math.floor(rnd(CATCH_GOLD_MIN * 2, (CATCH_GOLD_MAX + 1) * 2)); 
  var lv = Math.max(1, u.trainerLv || 1);
  var lvMult = 1 + (lv * 0.02);  // ë ˆë²¨ë‹¹ 1.2% -> 2%ë¡œ ìƒí–¥
  
  var rarity = (db && db.rarity) ? db.rarity : 2;
  var rarityMult = 1 + (rarity - 1) * 0.3; // í¬ê·€ë„ ë³´ë„ˆìŠ¤ ì†Œí­ ê°•í™”
  
  var ballMult = (ballType === 2) ? 1.2 : (ballType === 1) ? 1.1 : 1.0;
  var gold = Math.floor(base * lvMult * rarityMult * ballMult);
  
  // ì œí•œ(CAP)ì„ 9,999,999 ì •ë„ë¡œ ëŒ€í­ ë†’ì—¬ì„œ ì‚¬ì‹¤ìƒ ë¬´ì œí•œìœ¼ë¡œ ì‘ë™í•˜ê²Œ í•¨
  return clampInt(gold, 1, 9999999);
}

// 5. í¬íš ê²½í—˜ì¹˜ ê³„ì‚° (í•„ë“œ ì‚¬ëƒ¥ ë©”ë¦¬íŠ¸ë¥¼ ìœ„í•´ 3~5ë°° ìƒí–¥)
function calcCatchExp(u, db, ballType) {
  // ë² ì´ìŠ¤ ë²”ìœ„ë¥¼ ê¸°ì¡´ë³´ë‹¤ ì•½ 3~4ë°° ìƒí–¥
  var base = Math.floor(rnd(CATCH_EXP_MIN * 3, (CATCH_EXP_MAX + 1) * 4));
  var lv = Math.max(1, u.trainerLv || 1);
  var lvMult = 1 + (lv * 0.015);  // ë ˆë²¨ë‹¹ 0.6% -> 1.5%ë¡œ ìƒí–¥ (ê³¨ë“œë³´ë‹¤ ì™„ë§Œí•˜ê²Œ ìœ ì§€)
  
  var rarity = (db && db.rarity) ? db.rarity : 2;
  var rarityMult = 1 + (rarity - 1) * 0.4; // ì „ì„¤ í¬íš ì‹œ ë³´ëŒì´ ìˆë„ë¡ ê°•í™”
  
  var ballMult = (ballType === 2) ? 1.15 : (ballType === 1) ? 1.08 : 1.0;
  var exp = Math.floor(base * lvMult * rarityMult * ballMult);
  
  // ì œí•œ(CAP)ì„ ëŒ€í­ ë†’ì—¬ ë…¸ë ¥ì´ ë°°ì‹ í•˜ì§€ ì•Šê²Œ í•¨
  return clampInt(exp, 1, 9999999);
}

// -------------------- í¬íš ë‚œì´ë„ ê°œë³„ ë³´ì • --------------------
var CATCH_TIER_OVERRIDES = {
  131: 3.5, 
  143: 3.5, 
  144: 4.6, 
  145: 4.6, 
  146: 4.6, 
  150: 4.85, 
  151: 4.75, 
  133: 4.2, 
  134: 4.4, 
  135: 4.4, 
  136: 4.4};
// =================================================================
// ğŸ—ºï¸ [ìµœì¢…] ì›”ë“œë³„ ì „ìš© ì§€ì—­ ë°ì´í„°ë² ì´ìŠ¤ (ì„¸ëŒ€ë³„ íƒ€ì… ë¶„ë¦¬)
// =================================================================
var WORLD_REGIONS = {
  "íŒŒì•¼ë ˆë°”": [
    { key: "ì´ˆì›", types: ["ë…¸ë§", "í’€", "ë²Œë ˆ", "ë¹„í–‰", "ë…"], name: "ğŸŒ¿ í‘¸ë¥¸ ì´ˆì›" },
    { key: "í˜¸ìˆ˜", types: ["ë¬¼", "ì–¼ìŒ"], name: "ğŸ’§ ë§‘ì€ í˜¸ìˆ˜" },
    { key: "ë™êµ´", types: ["ë°”ìœ„", "ë•…", "ê³ ìŠ¤íŠ¸", "ë…"], name: "ğŸ¦‡ ì–´ë‘ìš´ ë™êµ´" },
    { key: "ë°œì „ì†Œ", types: ["ì „ê¸°"], name: "âš¡ ë‚¡ì€ ë°œì „ì†Œ" }, // 1ì„¸ëŒ€: ê°•ì²  ì œì™¸
    { key: "ìœ ì ", types: ["ì—ìŠ¤í¼", "ê³ ìŠ¤íŠ¸", "ë“œë˜ê³¤"], name: "ğŸ›ï¸ ê³ ëŒ€ ìœ ì " },
    { key: "ê²©íˆ¬ì¥", types: ["ê²©íˆ¬"], name: "ğŸ¥Š ë¹„ë°€ ê²©íˆ¬ì¥" },
    { key: "ìš”ì •ìˆ²", types: ["í˜ì–´ë¦¬", "í’€"], name: "âœ¨ ìš”ì •ì˜ ìˆ²" },
    { key: "í™”ì‚°", types: ["ë¶ˆ", "ë°”ìœ„", "ë•…"], name: "ğŸŒ‹ ëœ¨ê±°ìš´ í™”ì‚°" },
    { key: "ë°”ë‹¤", types: ["ë¬¼", "ë¹„í–‰"], name: "ğŸŒŠ ê¹Šì€ ë°”ë‹¤" },
    { key: "ì„¤ì‚°", types: ["ì–¼ìŒ", "ë°”ìœ„"], name: "â„ï¸ ì°¨ê°€ìš´ ì„¤ì‚°" },
    { key: "í­í’í‰ì›", types: ["ì „ê¸°", "ë¹„í–‰"], name: "ğŸŒªï¸ í­í’ì˜ í‰ì›" },
    { key: "ì–´ë‘ ì˜ìˆ²", types: ["ê³ ìŠ¤íŠ¸", "ë…"], name: "ğŸ‘» ì›ë ¹ì˜ ìˆ²" }, // 1ì„¸ëŒ€: ì•… ì œì™¸
    { key: "ì‚¬ë§‰", types: ["ë•…", "ë°”ìœ„", "ë…"], name: "ğŸœï¸ í™©ëŸ‰í•œ ì‚¬ë§‰" },
    { key: "ì—°êµ¬ì†Œ", types: ["ì—ìŠ¤í¼", "ë…¸ë§"], name: "ğŸ§ª í¬ì¼“ëª¬ ì—°êµ¬ì†Œ" }, // 1ì„¸ëŒ€: ê°•ì²  ì œì™¸
    { key: "ìš©ì˜ë‘¥ì§€", types: ["ë“œë˜ê³¤", "ë¶ˆ"], name: "ğŸ‰ ìš©ì˜ ë‘¥ì§€" }
  ],
  "ì´ìŠŒ": [
    { key: "í™©ê¸ˆë“¤íŒ", types: ["ë…¸ë§", "í’€", "ë•…"], name: "ğŸŒ¾ í™©ê¸ˆ ë“¤íŒ" },
    { key: "ëŒ€ë‚˜ë¬´ìˆ²", types: ["í’€", "ë²Œë ˆ", "ê²©íˆ¬"], name: "ğŸ‹ ëŒ€ë‚˜ë¬´ ìˆ²" },
    { key: "ì€ë¹›ì‚°ê¸¸", types: ["ì–¼ìŒ", "ê°•ì² ", "ë°”ìœ„"], name: "â›°ï¸ ì€ë¹› ì‚°ê¸¸" },
    { key: "ì•ˆê°œê³„ê³¡", types: ["ê³ ìŠ¤íŠ¸", "ì—ìŠ¤í¼", "í˜ì–´ë¦¬"], name: "ğŸŒ«ï¸ ì•ˆê°œ ê³„ê³¡" },
    { key: "ë‚™ë¢°ë´‰ìš°ë¦¬", types: ["ì „ê¸°", "ê°•ì² ", "ë¹„í–‰"], name: "âš¡ ë‚™ë¢° ë´‰ìš°ë¦¬" },
    { key: "ìœ¼ìŠ¤ìŠ¤í•œíƒ‘", types: ["ê³ ìŠ¤íŠ¸", "ì•…", "ê°•ì² "], name: "ğŸ¯ ìœ¼ìŠ¤ìŠ¤í•œ íƒ‘" },
    { key: "ì†Œìš©ëŒì´ì„¬", types: ["ë¬¼", "ë¹„í–‰", "ë“œë˜ê³¤"], name: "ğŸŒŠ ì†Œìš©ëŒì´ ì„¬" },
    { key: "ë‹¨í’ìˆ²", types: ["ë…¸ë§", "ë¶ˆ", "ë¹„í–‰"], name: "ğŸ‚ ë‹¨í’ ìˆ²" },
    { key: "ê²€ì€ìš©ì•”", types: ["ë¶ˆ", "ë•…", "ê°•ì² "], name: "ğŸŒ‹ ê²€ì€ ìš©ì•”ì§€ëŒ€" },
    { key: "ë§¹ë…ëŠªì§€", types: ["ë…", "ë²Œë ˆ", "ë¬¼"], name: "ğŸ¥€ ë§¹ë… ëŠªì§€" },
    { key: "ë¬´ìˆ ë„ì¥", types: ["ê²©íˆ¬", "ì—ìŠ¤í¼"], name: "ğŸ¥Š ê³ ëŒ€ ë¬´ìˆ  ë„ì¥" },
    { key: "ëª¨ë˜ì–¸ë•", types: ["ë•…", "ë°”ìœ„", "ê°•ì² "], name: "ğŸœï¸ ëª¨ë˜ë°”ëŒ ì–¸ë•" },
    { key: "ì‹ ë¹„í•œì—°ëª»", types: ["ë¬¼", "ì—ìŠ¤í¼", "í˜ì–´ë¦¬"], name: "ğŸ”® ì‹ ë¹„í•œ ì—°ëª»" },
    { key: "ì°¨ì›ì˜í‹ˆ", types: ["ì—ìŠ¤í¼", "ì•…", "ë“œë˜ê³¤"], name: "ğŸŒŒ ì°¨ì›ì˜ í‹ˆ" },
    { key: "ë¬´ì§€ê°œê¸¸", types: ["ë…¸ë§", "í˜ì–´ë¦¬", "ë¹„í–‰"], name: "ğŸ›¤ï¸ ë¬´ì§€ê°œ ê¸¸" }
  ]
};
// ğŸ° [ì „ì—­ ìŠ¤í˜ì…œ ì§€ì—­] (ì¼ë°˜ í•„ë“œ ìŠ¤í° ì œì™¸)
var SPECIAL_REGIONS = {
  "ëƒ¥ì¹˜ì˜ ë°©": { types: [], name: "ğŸ° ëƒ¥ì¹˜ì˜ ë°©" },
  "ë‹¤ì½”íƒ€": { types: [], name: "ğŸ° ì „ì„¤ì˜ ë„ì‹œ ë‹¤ì½”íƒ€" }
};

var SPAWN_EXPIRE_MS = 60 * 1000;
// ğŸ›‘ [ì‹œìŠ¤í…œ] ì•¼ìƒ ì¶œí˜„ ê¸ˆì§€ ëª©ë¡ (1ì„¸ëŒ€ + 2ì„¸ëŒ€ ì „ì²´ ì§„í™”ì²´ ë° ì „ì„¤/ì•„ê¸°)
var NO_SPAWN_LIST = [
  // [1ì„¸ëŒ€ ì§„í™”ì²´]
  2, 3, 5, 6, 8, 9, 11, 12, 14, 15, 17, 18, 20, 22, 24, 26, 28, 30, 31, 33, 34, 36, 38, 40, 42, 44, 45, 47, 49, 51, 53, 55, 57, 59, 61, 62, 64, 65, 67, 68, 70, 71, 73, 75, 76, 78, 80, 82, 85, 87, 89, 91, 93, 94, 97, 99, 101, 103, 105, 110, 112, 117, 119, 121, 130, 134, 135, 136, 139, 141, 148, 149,
  // [2ì„¸ëŒ€ ì§„í™”ì²´]
  153, 154, 156, 157, 159, 160, 162, 164, 166, 168, 169, 171, 176, 178, 180, 181, 182, 184, 186, 188, 189, 192, 195, 196, 197, 199, 205, 208, 210, 212, 217, 219, 221, 224, 229, 230, 232, 233, 242, 247, 248,
  // [ì•„ê¸° í¬ì¼“ëª¬ & íŠ¹ìˆ˜]
  172, 173, 174, 175, 236, 238, 239, 240,
  // [ì „ì„¤ì˜ í¬ì¼“ëª¬] (ì¼ë°˜ í•„ë“œ ìŠ¤í° ë°©ì§€ - ì´ë²¤íŠ¸/ë ˆì´ë“œ ì „ìš©)
  144, 145, 146, 150, 151, 243, 244, 245, 249, 250, 251
];

// ì´ í•¨ìˆ˜ê°€ ìœ„ ë¦¬ìŠ¤íŠ¸ë¥¼ ë³´ê³  ì§„í™”ì²´ë¥¼ ê±¸ëŸ¬ì¤ë‹ˆë‹¤.
function isBaseStagePokemonId(pid) {
  // ê¸ˆì§€ ëª©ë¡ì— ìˆìœ¼ë©´ false(ìŠ¤í° ì•ˆ í•¨), ì—†ìœ¼ë©´ true(ìŠ¤í° í•¨)
  if (NO_SPAWN_LIST.indexOf(pid) !== -1) return false;
  return true;
}


/**
 * ğŸ—ºï¸ [ë‚´ë¹„ê²Œì´í„°] íŠ¹ì • ì§€ì—­ì´ ì–´ëŠ ì›”ë“œ ì†Œì†ì¸ì§€ í™•ì¸
 * ì´ë™ í‹°ì¼“ ì‚¬ìš© ì‹œ ìœ ì €ì˜ u.worldë¥¼ ìë™ìœ¼ë¡œ ë°”ê¿”ì£¼ê¸° ìœ„í•´ ê¼­ í•„ìš”í•©ë‹ˆë‹¤.
 */
function findWorldByRegion(regionKey) {
  if (SPECIAL_REGIONS[regionKey]) return "íŒŒì•¼ë ˆë°”"; 
  for (var i = 0; i < WORLD_REGIONS["íŒŒì•¼ë ˆë°”"].length; i++) {
    if (WORLD_REGIONS["íŒŒì•¼ë ˆë°”"][i].key === regionKey) return "íŒŒì•¼ë ˆë°”";
  }
  for (var j = 0; j < WORLD_REGIONS["ì´ìŠŒ"].length; j++) {
    if (WORLD_REGIONS["ì´ìŠŒ"][j].key === regionKey) return "ì´ìŠŒ";
  }
  return "íŒŒì•¼ë ˆë°”";
}

// ë§ˆì„ ì •ë³´ë¥¼ ë°›ì•„ì„œ í•´ë‹¹ ë§ˆì„ì˜ ëœë¤ ì§€ì—­ ë°˜í™˜
function getRoomRegion(u, d, room) {
  var worldName = getSpawnWorldName(u);
  var pool = WORLD_REGIONS[worldName] || WORLD_REGIONS["íŒŒì•¼ë ˆë°”"];
  return randomPick(pool).key;
}

// ì›”ë“œ ì´ë¦„ì„ í•¨ê»˜ ë°›ì•„ì„œ ì†ì„± ë¦¬ìŠ¤íŠ¸ ë°˜í™˜
function regionTypes(regionKey, worldName) {
  if (SPECIAL_REGIONS[regionKey]) return SPECIAL_REGIONS[regionKey].types;
  var pool = WORLD_REGIONS[worldName] || WORLD_REGIONS["íŒŒì•¼ë ˆë°”"];
  for (var i = 0; i < pool.length; i++) {
    if (pool[i].key === regionKey) return pool[i].types;
  }
  return ["ë…¸ë§", "í’€", "ë²Œë ˆ", "ë¹„í–‰"];
}

function getSpawnWorldName(u) {
  return (u && u.world) ? u.world : "íŒŒì•¼ë ˆë°”";
}
// ğŸ›‘ [ëˆ„ë½ëœ í•¨ìˆ˜ ë³µêµ¬] í˜„ì¬ ìœ„ì¹˜ê°€ íŒŒì•¼ë ˆë°”(íƒœì´ˆë§ˆì„)ì¸ì§€ í™•ì¸
function isInTaechoVillage(u) {
  return getSpawnWorldName(u) === "íŒŒì•¼ë ˆë°”";
}

function getSpawnDbByWorld(worldName) {
  // ì´ìŠŒ ì›”ë“œë©´ ì „ì²´ ë„ê°(1+2ì„¸ëŒ€)ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
  if (worldName === "ì´ìŠŒ") return ALL_POKEMON_DB;
  return POKEMON_DB;
}

// ì›”ë“œë³„ ìƒíƒœê³„ê°€ ì™„ë²½íˆ ì ìš©ëœ ìŠ¤í° ì—”ì§„
function spawnPokemonForRegion(regionKey, worldName) {
  var srcDb = getSpawnDbByWorld(worldName); 
  var allowedTypes = regionTypes(regionKey, worldName);
  var pool = [];

  for (var i = 0; i < srcDb.length; i++) {
    var p = srcDb[i];
    if (!p || !isBaseStagePokemonId(p.id)) continue;

    // íŒŒì•¼ë ˆë°” ë§ˆì„ì´ë©´ 151ë²ˆ ì´ˆê³¼(2ì„¸ëŒ€) í¬ì¼“ëª¬ì€ ë¬´ì¡°ê±´ ì œì™¸
    if (worldName === "íŒŒì•¼ë ˆë°”" && p.id > 151) continue;

    var ok = false;
    if (allowedTypes.indexOf(p.type1) !== -1) ok = true;
    else if (p.type2 && allowedTypes.indexOf(p.type2) !== -1) ok = true;
    
    if (ok) pool.push(p);
  }

  // ë¹„ìƒ ëŒ€ì±… (ì¡°ê±´ ë§ëŠ” í¬ì¼“ëª¬ì´ ì—†ì„ ë•Œ)
  if (pool.length === 0) {
    var fb = srcDb.filter(function(x){ 
        return worldName === "íŒŒì•¼ë ˆë°”" ? (x && x.id <= 151) : true; 
    });
    return randomPick(fb);
  }

  // --- ê¸°ì¡´ ê°€ì¤‘ì¹˜ ë° í™•ë¥  ë¡œì§ (ì‚¬ì¥ë‹˜ ì›ë³¸ ìœ ì§€) ---
  var filtered = [];
  for (var k = 0; k < pool.length; k++) {
    var c = pool[k];
    var w = raritySpawnWeight(c.rarity || 2);
    if (Math.random() < w) filtered.push(c);
  }
  if (filtered.length === 0) filtered = pool;

  var sum = 0;
  var weights = [];
  for (var m = 0; m < filtered.length; m++) {
    var rarity = filtered[m].rarity || 2;
    var ww = 1 / Math.pow(rarity, 1.2);
    weights.push(ww);
    sum += ww;
  }
  var r = Math.random() * sum;
  for (var n = 0; n < filtered.length; n++) {
    r -= weights[n];
    if (r <= 0) return filtered[n];
  }
  return filtered[filtered.length - 1];
}
// [ê¸°ì¡´ í•¨ìˆ˜ë“¤ ê·¼ì²˜ì— ë¶™ì—¬ë„£ê¸°]
function processBattleVictory(u, enemyDb, replier) {
  // 1. ë°°í‹€ ë³´ìƒ ìˆ˜ì‹
  var baseExp = randInt(2000, 4500); 
  var baseGold = randInt(3000, 6000);
  
  var lvMult = 1 + (u.trainerLv * 0.03);
  var finalExp = Math.floor(baseExp * lvMult);
  var finalGold = Math.floor(baseGold * lvMult);

  u.gold += finalGold;
  
  var growMsg = "";
  // 2. íŒŒí‹° ì „ì› ê²½í—˜ì¹˜ ë°°ë¶„
  if (u.party && u.party.length > 0) {
    for (var i = 0; i < u.party.length; i++) {
      var pMember = findUserPokemonByUid(u, u.party[i]);
      if (pMember) {
        var lvNotice = gainPokemonExp(u, pMember, finalExp);
        if (lvNotice) growMsg += "\n" + lvNotice;
      }
    }
  }

  // 3. íŠ¸ë ˆì´ë„ˆ ê²½í—˜ì¹˜
  var userLvMsg = addExpWithLevelUpMsg(u, Math.floor(finalExp * 0.5));

  var battleResult = "âš”ï¸ [BATTLE VICTORY]\n" +
                     "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                     "ğŸ† ìŠ¹ë¦¬ ë³´ìƒ íšë“!\n" +
                     "ğŸ’° ê³¨ë“œ: +" + fmtNum(finalGold) + "G\n" +
                     "âœ¨ ê²½í—˜ì¹˜: +" + fmtNum(finalExp) + " EXP (íŒŒí‹° ì „ì›)\n" +
                     growMsg + "\n" + (userLvMsg || "");
                     
  replier.reply(battleResult);
  commitSave(true);
}


// -------------------- [ê°œì¸ë³„ ì„¸ì…˜ ì ìš©] ì•¼ìƒ ìŠ¤í° ìœ í‹¸ë¦¬í‹° --------------------
function getWild(d, user) {
  if (!d.lastSpawnByRoom) d.lastSpawnByRoom = {};
  var rKey = user.toString().trim();
  var w = d.lastSpawnByRoom[rKey];
  if (!w || new Date().getTime() > (w.expiresAt || 0)) return null;
  return w;
}

function setWild(d, user, pid, isShiny) {
  if (!d.lastSpawnByRoom) d.lastSpawnByRoom = {};
  var rKey = user.toString().trim();
  d.lastSpawnByRoom[rKey] = {
    pid: pid, at: new Date().getTime(),
    expiresAt: new Date().getTime() + SPAWN_EXPIRE_MS,
    attempts: 0, maxAttempts: getMaxCatchAttempts(pid), isShiny: !!isShiny
  };
  saveData(d);
}

function clearWild(d, user) {
  var rKey = user.toString().trim();
  if (d.lastSpawnByRoom) { delete d.lastSpawnByRoom[rKey]; saveData(d); }
}

function takeExpiredWild(d, user) {
  var rKey = user.toString().trim();
  var w = d.lastSpawnByRoom[rKey];
  if (w && new Date().getTime() > (w.expiresAt || 0)) {
    delete d.lastSpawnByRoom[rKey]; saveData(d); return w;
  }
  return null;
}


// -------------------- ë³¼/í¬íš í™•ë¥  --------------------
function ballCatchRate(ballType) {
  if (ballType === 0) 
    return 0.75;
  if (ballType === 1) 
    return 1.15;
  return 1.45;
}
// í¬ê·€ë„ì— ë”°ë¥¸ í¬íš íŒ¨ë„í‹°
function rarityCatchPenalty(r) {
  if (r <= 1) 
    return 1.0;
  if (r === 2) 
    return 0.9;
  if (r === 3) 
    return 0.75;
  if (r === 4) 
    return 0.6;
  return 0.45;
}
function consumeBall(u, ballType) {
  if (ballType === 0) {
    if (u.ball <= 0) 
      return false;
    u.ball--;
    return true;
  }
  if (ballType === 1) {
    if (u.superBall <= 0) 
      return false;
    u.superBall--;
    return true;
  }
  if (ballType === 2) {
    if (u.ultraBall <= 0) 
      return false;
    u.ultraBall--;
    return true;
  }
  if (ballType === 3) {
    if (!u.godBall || u.godBall <= 0) 
      return false;
    u.godBall--;
    return true;
  }
  return false;
}
function getMaxCatchAttempts(pid) {
  var db = findPokemonDB(pid);
  var r = db ? (db.rarity || 2) : 2;
  var min = 1;
  var max = 8;
  if (r <= 1) 
    min = 5;
  else if (r === 2) 
    min = 4;
  else if (r === 3) 
    min = 3;
  else if (r === 4) 
    min = 2;
  else 
    min = 1;  // r5
  return min + Math.floor(Math.random() * (max - min + 1));
}
// -------------------- í¬ê·€ë„ í¬íš ë°°ìœ¨ --------------------
function rarityCatchMul(r) {
  if (r === 1) 
    return 1.00;
  if (r === 2) 
    return 0.85;
  if (r === 3) 
    return 0.65;
  if (r === 4) 
    return 0.40;
  return 0.18;
}
// ë„íŒŒë¯¼ê°•í™”ê¶Œ
function rollDopaEnhance() {
  var r = Math.random();
  // UP 35% / KEEP 25% / RESET0 30% / EXIT 10%
  if (r < 0.35) {
    // ì„±ê³µ ì‹œ 2~10ê°• ë¶„í¬
    var x = Math.random();
    var up = 2;
    if (x < 0.25) 
      up = 2;
    else if (x < 0.45) 
      up = 3;
    else if (x < 0.60) 
      up = 4;
    else if (x < 0.72) 
      up = 5;
    else if (x < 0.82) 
      up = 6;
    else if (x < 0.90) 
      up = 7;
    else if (x < 0.95) 
      up = 8;
    else if (x < 0.98) 
      up = 9;
    else 
      up = 10;
    return {
  kind: "UP", 
  up: up};
  }
  if (r < 0.60) 
    return {
  kind: "KEEP"};
  if (r < 0.90) 
    return {
  kind: "RESET0"};
  return {
  kind: "EXIT"};
}
// ğŸª [í•¨ìˆ˜] ì¼ë°˜ ìƒì  í…ìŠ¤íŠ¸ ìƒì„±
function getGeneralShopText(u, decoName) {
  var summary = "ğŸª " + decoName + "ë‹˜, ì¼ë°˜ ìƒì ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!\n" +
                "ğŸ’° ë³´ìœ  ê³¨ë“œ: " + fmtNum(u.gold) + "ğŸ’°\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\n";
  var list = "";
  for (var key in SHOP_ITEMS) {
    var item = SHOP_ITEMS[key];
    list += item.icon + " " + key + " : " + fmtNum(item.price) + "ğŸ’°\n   â”” " + item.desc + "\n\n";
  }
  var footer = "ğŸ›’ êµ¬ë§¤ ë°©ë²•: /êµ¬ë§¤ [ì•„ì´í…œëª…] [ìˆ˜ëŸ‰]\nì˜ˆ: /êµ¬ë§¤ ëª¬ìŠ¤í„°ë³¼ 10";
  return { summary: summary + "ğŸ‘‰ í’ˆëª© ë³´ê¸°ëŠ” [ì „ì²´ë³´ê¸°] í™•ì¸", full: list + footer };
}
// ğŸ›’ [í•¨ìˆ˜] í†µí•© êµ¬ë§¤ ì²˜ë¦¬ ë¡œì§
function handlePurchase(u, itemName, qty) {
  var item = SHOP_ITEMS[itemName];
  if (!item) return { ok: false, reason: "ğŸš« ìƒì ì— ì—†ëŠ” ë¬¼ê±´ì…ë‹ˆë‹¤." };

  var totalPrice = item.price * qty;
  if (u.gold < totalPrice) {
    return { ok: false, reason: "ğŸš« ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.\ní•„ìš”: " + fmtNum(totalPrice) + "ğŸ’°\në³´ìœ : " + fmtNum(u.gold) + "ğŸ’°" };
  }

  // ğŸ’° ì¬í™” ì°¨ê°
  u.gold -= totalPrice;

  // ğŸ“¦ ì•„ì´í…œ ì§€ê¸‰ (ë°ì´í„° í•„ë“œ ë§¤í•‘)
  if (!u.items) u.items = {};

  if (itemName === "ëª¬ìŠ¤í„°ë³¼") u.ball = (u.ball || 0) + qty;
  else if (itemName === "ìŠˆí¼ë³¼") u.superBall = (u.superBall || 0) + qty;
  else if (itemName === "í•˜ì´í¼ë³¼") u.ultraBall = (u.ultraBall || 0) + qty;
  else if (itemName === "ë ˆì „ë“œë³¼") u.godBall = (u.godBall || 0) + qty;
  else if (itemName === "ë‘ì«€ì¿ ") u.cookie = (u.cookie || 0) + qty; //
  else if (itemName === "ì´ë™í‹°ì¼“") u.ticket = (u.ticket || 0) + qty; //
  else {
    // í‘¸ë”©, ìŠ¤í”„ë ˆì´ ë“±ì€ ê°€ë°©(u.items)ì— ë³´ê´€
    u.items[itemName] = (u.items[itemName] || 0) + qty;
  }

  return {
    ok: true,
    msg: "ğŸ›’ êµ¬ë§¤ ì„±ê³µ!\n" + item.icon + " " + itemName + " " + qty + "ê°œë¥¼ êµ¬ë§¤í–ˆìŠµë‹ˆë‹¤.\nğŸ’° ì”ì—¬ ê³¨ë“œ: " + fmtNum(u.gold) + "ğŸ’°"
  };
}

// ğŸ° [í•¨ìˆ˜] ë‹¤ì½”íƒ€ ì•„ì´í…œ ê²€ìƒ‰ (ë³„ì¹­ ì§€ì›)
function findDakotaItem(input) {
  for (var key in DAKOTA_ITEMS) {
    if (key === input || (DAKOTA_ITEMS[key].aliases && DAKOTA_ITEMS[key].aliases.indexOf(input) !== -1)) {
      return { name: key, data: DAKOTA_ITEMS[key] };
    }
  }
  return null;
}
// -------------------- ì „ì /ë­í¬ --------------------
function battleScoreRank(u) {
  ensureUserStats(u);
  var w = u.stats.battleWin;
  var l = u.stats.battleLose;
  var d0 = u.stats.battleDraw;
  var total = w + l + d0;
  var base = (w * 3) + (d0 * 1);
  var streakBonus = Math.min(30, u.stats.battleStreak * 2);
  var playPenalty = (total < 3) ? (3 - total) * 2 : 0;
  return base + streakBonus - playPenalty;
}
function formatRecord(u) {
  ensureUserStats(u);
  var w = u.stats.battleWin, l = u.stats.battleLose, d0 = u.stats.battleDraw;
  var total = w + l + d0;
  var rate = (total === 0) ? 0 : Math.floor((w / total) * 1000) / 10;
  return ("ì „ì : " + w + "ìŠ¹ " + l + "íŒ¨" + (d0 > 0 ? (" " + d0 + "ë¬´") : "") + "\n" + "ìŠ¹ë¥ : " + rate + "%\n" + "ì—°ìŠ¹: " + u.stats.battleStreak + "\n" + "ìµœê³  ì—°ìŠ¹: " + u.stats.bestStreak + "\n" + "ë­í‚¹ ì ìˆ˜: " + battleScoreRank(u));
}
function rankTopList(d) {
  var list = [];
  for (var name in d.users) {
    var uu = d.users[name];
    if (!uu) 
      continue;
    ensureUserStats(uu);
    var total = uu.stats.battleWin + uu.stats.battleLose + uu.stats.battleDraw;
    if (total <= 0) 
      continue;
    list.push({
  name: name, 
  score: battleScoreRank(uu), 
  w: uu.stats.battleWin, 
  l: uu.stats.battleLose, 
  s: uu.stats.battleStreak, 
  total: total});
  }
  list.sort(function(a, b) {
  if (b.score !== a.score) 
    return b.score - a.score;
  if (b.w !== a.w) 
    return b.w - a.w;
  return b.total - a.total;
});
  return list;
}
//ì „íˆ¬ë ¥ë­í‚¹
// [ìˆ˜ì •] ì „íˆ¬ë ¥ ë­í‚¹ìš© ì •ë³´ ì¶”ì¶œ (ì´ë¡œì¹˜ ì´ë¦„ ë°˜ì˜)
function getUserTopPokemonPower(user) {
  normalizeUserData(user);
  if (!user.pokemons || user.pokemons.length === 0) {
    return {
  power: 0, 
  uid: 0, 
  name: "-", 
  enh: 0};
  }
  var sorted = sortPokemonsByPower(user.pokemons);
  var top = sorted[0];
  // â˜… [ìˆ˜ì •] ì—¬ê¸°ì„œ getDisplayName ì‚¬ìš©!
  var pName = getDisplayName(top);
  return {
  power: calcBattlePower(top), 
  uid: top.uid, 
  name: pName, 
  enh: top.enh || 0};
}
// [ìˆ˜ì •ë¨] ì „íˆ¬ë ¥ ë­í‚¹ (ì¡°íšŒ ì‹œ ë°ì´í„° ë³´ì • í¬í•¨)
function buildBattlePowerRanking(d, topN, sender) {
  topN = topN || 7;
  var rows = [];
  var names = Object.keys(d.users || {});
  // ë­í‚¹ ì‚°ì • ì¤‘ ë°ì´í„° ë³€ê²½ì´ ì¼ì–´ë‚  ìˆ˜ ìˆìŒ (ë¯¸ì ‘ì†ì ë“±ê¸‰ ë¶€ì—¬ ë“±)
  var dataChanged = false;
  for (var i = 0; i < names.length; i++) {
    var name = names[i];
    if (!name) 
      continue;
    var user = d.users[name];
    if (!user) 
      continue;
    normalizeUserData(user);
    if (!user.pokemons || user.pokemons.length === 0) 
      continue;
    if (ensurePokemonGrades(user)) {
      dataChanged = true;
    }
    var top = getUserTopPokemonPower(user);    // ì´ì œ ë“±ê¸‰ì´ ë°˜ì˜ëœ ì „íˆ¬ë ¥ì´ ë‚˜ì˜´
    rows.push({
  name: name, 
  power: top.power, 
  uid: top.uid, 
  pName: top.name, 
  enh: top.enh});
  }
  // ë­í‚¹ ì§‘ê³„ ì¤‘ ë°ì´í„°ê°€ ë³€í–ˆìœ¼ë©´ ì €ì¥ (ë¯¸ì ‘ì†ì ë°ì´í„° ê°±ì‹ )
  if (dataChanged) {
    saveData(d);
  }
  rows.sort(function(a, b) {
  if (b.power !== a.power) 
    return b.power - a.power;
  if ((b.enh || 0) !== (a.enh || 0)) 
    return (b.enh || 0) - (a.enh || 0);
  return (a.uid || 0) - (b.uid || 0);
});
  var myIdx = -1;
  if (sender) {
    for (var k = 0; k < rows.length; k++) {
      if (rows[k].name === sender) {
        myIdx = k;
        break;
      }
    }
  }
  return {
  rows: rows, 
  myIdx: myIdx, 
  topN: topN};
}
// ğŸ’ [ì¥ë¹„] ì•„ì´í…œ ë°ì´í„°ë² ì´ìŠ¤ (v4.5: ì•„ì´ì½˜ ì¤‘ë³µ ì œê±° & ì§„í™”ëŒ ì¶”ê°€)
var EQUIP_DB = {
  "í˜ì˜ë¨¸ë¦¬ë ": {
  type: "atk_pct", 
  val: 0.10, 
  icon: "ğŸ—ï¸", 
  desc: "ê³µê²©ë ¥ 10% ì¦ê°€", 
  tier: 1}, 
  "ìë­‰ì—´ë§¤": {
  type: "hp_flat", 
  val: 1000, 
  icon: "ğŸ’", 
  desc: "ìµœëŒ€ ì²´ë ¥ +1000", 
  tier: 1}, 
  "êµ¬ì• ìŠ¤ì¹´í”„": {
  type: "spd_flat", 
  val: 15, 
  icon: "ğŸ§£", 
  desc: "ìŠ¤í”¼ë“œ +15 (ì„ ê³µ ìœ ë¦¬)", 
  tier: 1}, 
  "ë°©ì–´ë³´ì„": {
  type: "def_pct", 
  val: 0.15, 
  icon: "ğŸ›¡ï¸", 
  desc: "ë°›ëŠ” í”¼í•´ 15% ê°ì†Œ", 
  tier: 1}, 
  "ë¶ˆê½ƒì˜ëŒ": {
  type: "evo_material", 
  val: 0, 
  icon: "ğŸ”´", 
  desc: "íŠ¹ì • í¬ì¼“ëª¬ ì§„í™” ì´‰ë§¤ (ì¥ì°© í›„ ë ™ì—…)", 
  tier: 2}, 
  "ë¬¼ì˜ëŒ": {
  type: "evo_material", 
  val: 0, 
  icon: "ğŸ”µ", 
  desc: "íŠ¹ì • í¬ì¼“ëª¬ ì§„í™” ì´‰ë§¤ (ì¥ì°© í›„ ë ™ì—…)", 
  tier: 2}, 
  "ì²œë‘¥ì˜ëŒ": {
  type: "evo_material", 
  val: 0, 
  icon: "ğŸŸ¡", 
  desc: "íŠ¹ì • í¬ì¼“ëª¬ ì§„í™” ì´‰ë§¤ (ì¥ì°© í›„ ë ™ì—…)", 
  tier: 2}, 
  "í’€ì˜ëŒ": {
  type: "evo_material", 
  val: 0, 
  icon: "ğŸŸ¢", 
  desc: "íŠ¹ì • í¬ì¼“ëª¬ ì§„í™” ì´‰ë§¤ (ì¥ì°© í›„ ë ™ì—…)", 
  tier: 2}, 
  "ë‹¬ì˜ëŒ": {
  type: "evo_material", 
  val: 0, 
  icon: "ğŸŒ‘", 
  desc: "íŠ¹ì • í¬ì¼“ëª¬ ì§„í™” ì´‰ë§¤ (ì¥ì°© í›„ ë ™ì—…)", 
  tier: 2}, 
  "íƒœì–‘ì˜ëŒ": {
  type: "evo_material", 
  val: 0, 
  icon: "ğŸŒ", 
  desc: "íŠ¹ì • í¬ì¼“ëª¬ ì§„í™” ì´‰ë§¤ (ì¥ì°© í›„ ë ™ì—…)", 
  tier: 2}, 
  "ì–´ë‘ ì˜ëŒ": {
  type: "evo_material", 
  val: 0, 
  icon: "ğŸŸ£", 
  desc: "ì–´ë‘  ì†ì„± ì§„í™” (ì¥ì°© í›„ ë ™ì—…)", 
  tier: 3}, 
  "ì™•ì˜ì§•í‘œì„": {
  type: "evo_material", 
  val: 0, 
  icon: "ğŸ‘‘", 
  desc: "ì™•ì´ ë  ìì§ˆì„ ê°€ì§„ í¬ì¼“ëª¬ ì§„í™”", 
  tier: 3}, 
  "ìš©ì˜ë¹„ëŠ˜": {
  type: "evo_material", 
  val: 0, 
  icon: "ğŸ‰", 
  desc: "ë“œë˜ê³¤ í¬ì¼“ëª¬ ì§„í™”", 
  tier: 3}, 
  "ê¸ˆì†ì½”íŠ¸": {
  type: "evo_material", 
  val: 0, 
  icon: "ğŸ§¥", 
  desc: "ê°•ì²  ì†ì„± ì§„í™” (í•«ì‚¼/ê°•ì² í†¤)", 
  tier: 3}, 
  "ì—…ê·¸ë ˆì´ë“œ": {
  type: "evo_material", 
  val: 0, 
  icon: "ğŸ’¾", 
  desc: "í´ë¦¬ê³¤ ì§„í™” ì¥ì¹˜", 
  tier: 3}, 
  "ë¶ˆê½ƒêµ¬ìŠ¬": {
  type: "type_boost", 
  val: 0.15, 
  cond: "ë¶ˆ", 
  icon: "ğŸ”¥", 
  desc: "[ë¶ˆ] ê¸°ìˆ  ìœ„ë ¥ 15% ì¦ê°€", 
  tier: 2}, 
  "ë¬¼ë°©ìš¸êµ¬ìŠ¬": {
  type: "type_boost", 
  val: 0.15, 
  cond: "ë¬¼", 
  icon: "ğŸ’§", 
  desc: "[ë¬¼] ê¸°ìˆ  ìœ„ë ¥ 15% ì¦ê°€", 
  tier: 2}, 
  "ê¸°ì ì˜ì”¨": {
  type: "type_boost", 
  val: 0.15, 
  cond: "í’€", 
  icon: "ğŸŒ±", 
  desc: "[í’€] ê¸°ìˆ  ìœ„ë ¥ 15% ì¦ê°€", 
  tier: 2}, 
  "ìì„": {
  type: "type_boost", 
  val: 0.15, 
  cond: "ì „ê¸°", 
  icon: "ğŸ§²", 
  desc: "[ì „ê¸°] ê¸°ìˆ  ìœ„ë ¥ 15% ì¦ê°€", 
  tier: 2}, 
  "ë…¹ì§€ì•ŠëŠ”ì–¼ìŒ": {
  type: "type_boost", 
  val: 0.15, 
  cond: "ì–¼ìŒ", 
  icon: "ğŸ§Š", 
  desc: "[ì–¼ìŒ] ê¸°ìˆ  ìœ„ë ¥ 15% ì¦ê°€", 
  tier: 2}, 
  "ë¶€ë“œëŸ¬ìš´ëª¨ë˜": {
  type: "type_boost", 
  val: 0.15, 
  cond: "ë•…", 
  icon: "âŒ›", 
  desc: "[ë•…] ê¸°ìˆ  ìœ„ë ¥ 15% ì¦ê°€", 
  tier: 2}, 
  "ë‚ ì¹´ë¡œìš´ë¶€ë¦¬": {
  type: "type_boost", 
  val: 0.15, 
  cond: "ë¹„í–‰", 
  icon: "ğŸª¶", 
  desc: "[ë¹„í–‰] ê¸°ìˆ  ìœ„ë ¥ 15% ì¦ê°€", 
  tier: 2}, 
  "ìš©ì˜ì´ë¹¨": {
  type: "type_boost", 
  val: 0.15, 
  cond: "ë“œë˜ê³¤", 
  icon: "ğŸ¦·", 
  desc: "[ë“œë˜ê³¤] ê¸°ìˆ  ìœ„ë ¥ 15% ì¦ê°€", 
  tier: 2}, 
  "ê²€ì€ì•ˆê²½": {
  type: "type_boost", 
  val: 0.15, 
  cond: "ì•…", 
  icon: "ğŸ•¶ï¸", 
  desc: "[ì•…] ê¸°ìˆ  ìœ„ë ¥ 15% ì¦ê°€", 
  tier: 2}, 
  "ê²€ì€ë ": {
  type: "type_boost", 
  val: 0.15, 
  cond: "ê²©íˆ¬", 
  icon: "ğŸ¥‹", 
  desc: "[ê²©íˆ¬] ê¸°ìˆ  ìœ„ë ¥ 15% ì¦ê°€", 
  tier: 2}, 
  "ë…ë°”ëŠ˜": {
  type: "type_boost", 
  val: 0.15, 
  cond: "ë…", 
  icon: "ğŸ’‰", 
  desc: "[ë…] ê¸°ìˆ  ìœ„ë ¥ 15% ì¦ê°€", 
  tier: 2}, 
  "ì €ì£¼ë°›ì€ë¶€ì ": {
  type: "type_boost", 
  val: 0.15, 
  cond: "ê³ ìŠ¤íŠ¸", 
  icon: "ğŸ‘»", 
  desc: "[ê³ ìŠ¤íŠ¸] ê¸°ìˆ  ìœ„ë ¥ 15% ì¦ê°€", 
  tier: 2}, 
  "êµ¬ë¶€ëŸ¬ì§„ìŠ¤í‘¼": {
  type: "type_boost", 
  val: 0.15, 
  cond: "ì—ìŠ¤í¼", 
  icon: "ğŸ¥„", 
  desc: "[ì—ìŠ¤í¼] ê¸°ìˆ  ìœ„ë ¥ 15% ì¦ê°€", 
  tier: 2}, 
  "ì€ë¹›ê°€ë£¨": {
  type: "type_boost", 
  val: 0.15, 
  cond: "ë²Œë ˆ", 
  icon: "ğŸ¦‹", 
  desc: "[ë²Œë ˆ] ê¸°ìˆ  ìœ„ë ¥ 15% ì¦ê°€", 
  tier: 2}, 
  "ë‹¨ë‹¨í•œëŒ": {
  type: "type_boost", 
  val: 0.15, 
  cond: "ë°”ìœ„", 
  icon: "ğŸª¨", 
  desc: "[ë°”ìœ„] ê¸°ìˆ  ìœ„ë ¥ 15% ì¦ê°€", 
  tier: 2}, 
  "ê¸ˆì†ì½”íŠ¸": {
  type: "type_boost", 
  val: 0.15, 
  cond: "ê°•ì² ", 
  icon: "ğŸ”©", 
  desc: "[ê°•ì² ] ê¸°ìˆ  ìœ„ë ¥ 15% ì¦ê°€ (ì¤‘ë³µ ì£¼ì˜: ì§„í™”ìš©ê³¼ ë™ì¼)", 
  tier: 2}, 
  "ì‹¤í¬ìŠ¤ì¹´í”„": {
  type: "type_boost", 
  val: 0.15, 
  cond: "ë…¸ë§", 
  icon: "ğŸ§£", 
  desc: "[ë…¸ë§] ê¸°ìˆ  ìœ„ë ¥ 15% ì¦ê°€", 
  tier: 2}, 
  "í˜ì–´ë¦¬ì°¸": {
  type: "type_boost", 
  val: 0.15, 
  cond: "í˜ì–´ë¦¬", 
  icon: "ğŸ§š", 
  desc: "[í˜ì–´ë¦¬] ê¸°ìˆ  ìœ„ë ¥ 15% ì¦ê°€", 
  tier: 2}, 
  "ë§ˆê·¸ë§ˆì˜ëŒ": {
  type: "type_boost", 
  val: 0.30, 
  cond: "ë¶ˆ", 
  icon: "ğŸŒ‹", 
  desc: "[ë¶ˆ] ê¸°ìˆ  ìœ„ë ¥ 30% ì¦ê°€ (ìƒê¸‰)", 
  tier: 3}, 
  "ì‹¬í•´ì˜ë¬¼ë°©ìš¸": {
  type: "type_boost", 
  val: 0.30, 
  cond: "ë¬¼", 
  icon: "ğŸŒŠ", 
  desc: "[ë¬¼] ê¸°ìˆ  ìœ„ë ¥ 30% ì¦ê°€ (ìƒê¸‰)", 
  tier: 3}, 
  "ìƒëª…ì˜ë‚˜ë¬´": {
  type: "type_boost", 
  val: 0.30, 
  cond: "í’€", 
  icon: "ğŸŒ³", 
  desc: "[í’€] ê¸°ìˆ  ìœ„ë ¥ 30% ì¦ê°€ (ìƒê¸‰)", 
  tier: 3}, 
  "ë²ˆê°œí”Œë ˆì´íŠ¸": {
  type: "type_boost", 
  val: 0.30, 
  cond: "ì „ê¸°", 
  icon: "âš¡", 
  desc: "[ì „ê¸°] ê¸°ìˆ  ìœ„ë ¥ 30% ì¦ê°€ (ìƒê¸‰)", 
  tier: 3}, 
  "ì ˆëŒ€ì˜ë„": {
  type: "type_boost", 
  val: 0.30, 
  cond: "ì–¼ìŒ", 
  icon: "â„ï¸", 
  desc: "[ì–¼ìŒ] ê¸°ìˆ  ìœ„ë ¥ 30% ì¦ê°€ (ìƒê¸‰)", 
  tier: 3}, 
  "ëŒ€ì§€ì˜í˜": {
  type: "type_boost", 
  val: 0.30, 
  cond: "ë•…", 
  icon: "â›°ï¸", 
  desc: "[ë•…] ê¸°ìˆ  ìœ„ë ¥ 30% ì¦ê°€ (ìƒê¸‰)", 
  tier: 3}, 
  "íƒœí’ì˜ëˆˆ": {
  type: "type_boost", 
  val: 0.30, 
  cond: "ë¹„í–‰", 
  icon: "ğŸŒªï¸", 
  desc: "[ë¹„í–‰] ê¸°ìˆ  ìœ„ë ¥ 30% ì¦ê°€ (ìƒê¸‰)", 
  tier: 3}, 
  "ì—­ë¦°": {
  type: "type_boost", 
  val: 0.30, 
  cond: "ë“œë˜ê³¤", 
  icon: "ğŸ²", 
  desc: "[ë“œë˜ê³¤] ê¸°ìˆ  ìœ„ë ¥ 30% ì¦ê°€ (ìƒê¸‰)", 
  tier: 3}, 
  "ì±”í”¼ì–¸ë²¨íŠ¸": {
  type: "type_boost", 
  val: 0.30, 
  cond: "ê²©íˆ¬", 
  icon: "ğŸ¥Š", 
  desc: "[ê²©íˆ¬] ê¸°ìˆ  ìœ„ë ¥ 30% ì¦ê°€ (ìƒê¸‰)", 
  tier: 3}, 
  "ë§¹ë…êµ¬ìŠ¬": {
  type: "type_boost", 
  val: 0.30, 
  cond: "ë…", 
  icon: "ğŸ§ª", 
  desc: "[ë…] ê¸°ìˆ  ìœ„ë ¥ 30% ì¦ê°€ (ìƒê¸‰)", 
  tier: 3}, 
  "ì‚¬ì´ì½”ì¼": {
  type: "type_boost", 
  val: 0.30, 
  cond: "ì—ìŠ¤í¼", 
  icon: "ğŸ”®", 
  desc: "[ì—ìŠ¤í¼] ê¸°ìˆ  ìœ„ë ¥ 30% ì¦ê°€ (ìƒê¸‰)", 
  tier: 3}, 
  "ê°•ë¶€ì¥ì˜êµìœ¡": {
  type: "atk_pct", 
  val: 0.40, 
  icon: "ğŸ‘º", 
  desc: "ê³µê²©ë ¥ 40% ì¦ê°€ (íŒŒê´´ì‹ )", 
  tier: 4}, 
  "ëˆ„ëˆ„ì˜ìš”ë¦¬": {
  type: "hp_pct", 
  val: 0.50, 
  icon: "ğŸ¥˜", 
  desc: "ìµœëŒ€ ì²´ë ¥ 50% ì¦ê°€ (ì§„ì •í•œ ë¶ˆì‚¬ì‹ )", 
  tier: 4}, 
  "ê¾¸ê¾¸ì˜íƒ„ìƒ": {
  type: "spd_flat", 
  val: 35, 
  icon: "ğŸ£", 
  desc: "ìŠ¤í”¼ë“œ +35 (ì••ë„ì ì¸ ì†ë„)", 
  tier: 4}, 
  "ë¯¼ì¤€ì´ì§€ê°‘": {
  type: "def_pct", 
  val: 0.25, 
  icon: "ğŸ’¸", 
  desc: "ë°›ëŠ” í”¼í•´ 25% ê°ì†Œ (ì ˆëŒ€ë°©ì–´)", 
  tier: 4}, 
  "ë‘ë‘¥ì˜ì•ˆê²½": {
  type: "raid_crit_rate", 
  val: 0.35, 
  icon: "ğŸ‘“", 
  desc: "[ë ˆì´ë“œ] ë¦¬ë” ì¥ì°© ì‹œ íŒ€ ì¹˜ëª…íƒ€ìœ¨ ëŒ€í­ ì¦ê°€!", 
  tier: 4}, 
  "í•´ë¦¬ì˜ë§ˆë¼": {
  type: "raid_crit_dmg", 
  val: 5.0, 
  icon: "ğŸŒ¶", 
  desc: "[ë ˆì´ë“œ] ë¦¬ë” ì¥ì°© ì‹œ ì¹˜ëª…íƒ€ ë°ë¯¸ì§€ 5ë°° ì ìš©!", 
  tier: 4}, 
  "ê¹€ì‹œì‹±ì˜ë©˜íƒˆ": {
  type: "reflect_dmg", 
  val: 0.30, 
  icon: "ğŸ§ ", 
  desc: "ë°›ì€ í”¼í•´ì˜ 30%ë¥¼ ìƒëŒ€ì—ê²Œ ë°˜ì‚¬ (ê°€ì‹œê°‘ì˜·)", 
  tier: 4}, 
  "ìŠ¤íŒŒê²Œí‹°ì˜ì§€ë„": {
  type: "explore_luck", 
  val: 2.5, 
  icon: "ğŸ—ºï¸", 
  desc: "íƒí—˜ ì‹œ íˆë“  ì§€ì—­ ë°œê²¬ í™•ë¥  ëŒ€í­(25%) ìƒìŠ¹!", 
  tier: 4}};
// -------------------- ğŸ›¡ï¸ [ë³´ì•ˆ ê°•í™”] ìš´ì˜ì ì„¤ì • (ì§€ë¬¸ ì¸ì‹) --------------------
// â˜… ì—¬ê¸°ì— ì•„ê¹Œ ì•Œì•„ë‚¸ "ìˆ«ì(ê³ ìœ ì½”ë“œ)"ë¥¼ ë„£ìœ¼ì„¸ìš”! (ì—¬ëŸ¬ ëª…ì´ë©´ ì½¤ë§ˆë¡œ ì¶”ê°€)
var ADMIN_HASHES = {
  "-1073767707": true};
// ì´ë¦„(sender)ê³¼ ì§€ë¬¸(imageDB)ì„ ë™ì‹œì— ê²€ì‚¬í•˜ëŠ” í•¨ìˆ˜
function isAdmin(sender, imageDB) {
  // 1. ì´ë¯¸ì§€DBê°€ ì—†ìœ¼ë©´(í…ŒìŠ¤íŠ¸ í™˜ê²½ ë“±) ë¬´ì¡°ê±´ ì‹¤íŒ¨ (ë³´ì•ˆ)
  if (!imageDB) 
    return false;
  var userHash = java.lang.String(imageDB.getProfileImage()).hashCode();
  // 3. ë“±ë¡ëœ ì§€ë¬¸ì¸ì§€ í™•ì¸
  return !!ADMIN_HASHES[userHash];
}
function cleanName(s) {
  if (!s) 
    return "";
  s = ("" + s).trim();
  if (s.charAt(0) === "@") 
    s = s.slice(1);
  return s.trim();
}
function getUserByName(d, name) {
  name = cleanName(name);
  if (!name) 
    return null;
  if (!d.users) 
    d.users = {};
  var u = d.users[name];
  if (!u) 
    return null;
  if (typeof u.gold !== "number") 
    u.gold = 0;
  if (typeof u.trainerLv !== "number") 
    u.trainerLv = 1;
  if (typeof u.trainerExp !== "number") 
    u.trainerExp = 0;
  if (typeof u.ball !== "number") 
    u.ball = 0;
  if (typeof u.superBall !== "number") 
    u.superBall = 0;
  if (typeof u.ultraBall !== "number") 
    u.ultraBall = 0;
  if (typeof u.dopaTicket !== "number") 
    u.dopaTicket = 0;
  if (!u.pokemons) 
    u.pokemons = [];
  return {
  name: name, 
  user: u};
}
function addAdminLog(d, actor, line) {
  if (!d.adminLog) 
    d.adminLog = [];
  d.adminLog.push({
  t: nowMs(), 
  by: actor, 
  line: line});
  if (d.adminLog.length > 200) 
    d.adminLog = d.adminLog.slice(d.adminLog.length - 200);
}
// -------------------- ì „ì—­ ì„¤ì •(ëŸ°íƒ€ì„ + ì €ì¥) --------------------
function ensureConfig(d) {
  if (!d.config) 
    d.config = {};
  if (!d.config.shop) 
    d.config.shop = {};
  if (!d.config.flags) 
    d.config.flags = {};
  if (typeof d.config.shop.BALL !== "number") 
    d.config.shop.BALL = SHOP_PRICE_BALL;
  if (typeof d.config.shop.SUPER !== "number") 
    d.config.shop.SUPER = SHOP_PRICE_SUPER;
  if (typeof d.config.shop.ULTRA !== "number") 
    d.config.shop.ULTRA = SHOP_PRICE_ULTRA;
  if (typeof d.config.shop.DOPA !== "number") 
    d.config.shop.DOPA = SHOP_PRICE_DOPA;
  if (typeof d.config.flags.EVENT_ON !== "boolean") 
    d.config.flags.EVENT_ON = false;
  if (typeof d.config.flags.FIELD_ON !== "boolean") 
    d.config.flags.FIELD_ON = true;
  if (typeof d.config.flags.ENHANCE_ON !== "boolean") 
    d.config.flags.ENHANCE_ON = true;
  if (typeof d.config.flags.DOPA_ON !== "boolean") 
    d.config.flags.DOPA_ON = true;
}
function getShopPrice(d, key) {
  ensureConfig(d);
  return d.config.shop[key];
}
function setShopPrice(d, key, val) {
  ensureConfig(d);
  d.config.shop[key] = val;
}
function isFlagOn(d, key) {
  ensureConfig(d);
  return !!d.config.flags[key];
}
function setFlag(d, key, on) {
  ensureConfig(d);
  d.config.flags[key] = !!on;
}
function globalConfigText(d) {
  ensureConfig(d);
  return ("ì „ì—­ ì„¤ì •\n\n" + "ìƒì \n" + "ëª¬ìŠ¤í„°ë³¼: " + d.config.shop.BALL + "ğŸ’°\n" + "ìŠˆí¼ë³¼: " + d.config.shop.SUPER + "ğŸ’°\n" + "í•˜ì´í¼ë³¼: " + d.config.shop.ULTRA + "ğŸ’°\n" + "ë„íŒŒë¯¼ê°•í™”ê¶Œ: " + d.config.shop.DOPA + "ğŸ’°\n\n" + "í† ê¸€\n" + "ì´ë²¤íŠ¸: " + (d.config.flags.EVENT_ON ? "ON" : "OFF") + "\n" + "í•„ë“œ: " + (d.config.flags.FIELD_ON ? "ON" : "OFF") + "\n" + "ê°•í™”: " + (d.config.flags.ENHANCE_ON ? "ON" : "OFF") + "\n" + "ë„íŒŒë¯¼ê°•í™”: " + (d.config.flags.DOPA_ON ? "ON" : "OFF"));
}
// [ìµœì¢… ì—…ë°ì´íŠ¸] ê´€ë¦¬ì ë„ì›€ë§ (ë ˆì´ë“œ & ì¥ë¹„ í¬í•¨)
function adminHelpText() {
  return ("ğŸ‘‘ [ìš´ì˜ì ê´€ë¦¬ íŒ¨ë„ v2.3]\n\n" + "ğŸ¦– [ë ˆì´ë“œ ê´€ë¦¬] (NEW)\n" + "/ê´€ë¦¬ì ë ˆì´ë“œì†Œí™˜ [ì²´ë ¥(ì–µ)]\n" + "â”” ì˜ˆ: /ê´€ë¦¬ì ë ˆì´ë“œì†Œí™˜ 30\n" + "/ê´€ë¦¬ì ë ˆì´ë“œì¢…ë£Œ (ê°•ì œ ì‚­ì œ)\n\n" + "ğŸ [ì§€ê¸‰ ë° ë³´ìƒ]\n" + "/ê´€ë¦¬ì ì§€ê¸‰ [ë‹‰ë„¤ì„] [í•­ëª©] [ìˆ˜ëŸ‰]\n" + "â”” ìì›: ê³¨ë“œ, ê²½í—˜ì¹˜, ë ˆë²¨\n" + "â”” ì•„ì´í…œ: ëª¬, ìŠˆ, í•˜, í‚¹ê°“ë³¼, ë„íŒŒë¯¼, ì¿ í‚¤, ë¦¬ì…‹, í‹°ì¼“\n" + "â”” ì¥ë¹„: í˜ì˜ë¨¸ë¦¬ë , ëˆ„ëˆ„ì˜ìš”ë¦¬ ë“± (ìë™ì¸ì‹)\n" + "/ê´€ë¦¬ì ì „ì²´ë³´ìƒ [í•­ëª©] [ìˆ˜ëŸ‰]\n\n" + "ğŸ“¢ [ì„œë²„ ê´€ë¦¬]\n" + "/ê´€ë¦¬ì ê³µì§€ [ë‚´ìš©]\n" + "/ê´€ë¦¬ì ì €ì¥ / ë°ì´í„°ì •ë¦¬\n" + "/ê´€ë¦¬ì ì „ì ì´ˆê¸°í™” [ë‹‰ë„¤ì„/ìƒëµì‹œì „ì²´]\n" + "/ê´€ë¦¬ì ê³„ì •ì´ë™ [êµ¬ë‹‰] [ì‹ ë‹‰]\n\n" + "ğŸ‘¾ [í¬ì¼“ëª¬ ê´€ë¦¬]\n" + "/ê´€ë¦¬ì í¬ì¼“ëª¬ [ë‹‰ë„¤ì„]\n" + "/ê´€ë¦¬ì í¬ì¼“ëª¬ì§€ê¸‰ [ë‹‰ë„¤ì„] [ì´ë¦„]\n" + "/ê´€ë¦¬ì ìŠ¤í° [ë‹‰ë„¤ì„] [ì´ë¦„] [ì´ë¡œì¹˜Y/N]\n" + "/ê´€ë¦¬ì ì‚­ì œ [ë‹‰ë„¤ì„] [UID]\n" + "/ê´€ë¦¬ì ê°•í™” [ë‹‰ë„¤ì„] [UID] [ìˆ˜ì¹˜]\n\n" + "ğŸ§ª [ì»¤ìŠ¤í…€ ì—ë””íŠ¸]\n" + "/ê´€ë¦¬ì ì´ë¡œì¹˜ [ë‹‰ë„¤ì„] [UID]\n" + "/ê´€ë¦¬ì ì ì¬ë ¥ [ë‹‰ë„¤ì„] [UID] [í˜] [ì²´] [ë¯¼]");
}
// -------------------- roomActive: ë©”ëª¨ë¦¬ ì „ìš©(íŒŒì¼ ì €ì¥ X) --------------------
// ë°©ë³„ ìµœê·¼ í™œë™ ìœ ì €(ë°°í‹€ ë§¤ì¹­ìš©) - ì•± ì¬ì‹œì‘ ì‹œ ë¦¬ì…‹ë¨ (ì˜ë„ëœ ë™ì‘)
var ROOM_ACTIVE_MEM = {};// { [room]: { [sender]: lastActiveMs } }
function trackRoomActiveMem(room, sender) {
  var now = nowMs();
  var key = MATCH_POOL_KEY;  // room ëŒ€ì‹  ê³ ì •í‚¤ ì‚¬ìš©
  if (!ROOM_ACTIVE_MEM[key]) 
    ROOM_ACTIVE_MEM[key] = {};
  ROOM_ACTIVE_MEM[key][sender] = now;
  if (Math.random() < 0.08) {
    var m = ROOM_ACTIVE_MEM[key];
    for (var name in m) {
      if (now - m[name] > ACTIVE_TTL_MS) 
        delete m[name];
    }
  }
}
// [ìˆ˜ì •ë¨] ìƒëŒ€ ë§¤ì¹­ í•„í„° (ê°•í™” ìˆ˜ì¹˜ ë²”ìœ„ ì ìš©)
function getEligibleOpponentsMem(d, room, myName, targetEnh) {
  var now = nowMs();
  var key = MATCH_POOL_KEY;
  var active = ROOM_ACTIVE_MEM[key] || {};
  var list = [];
  var RANGE = 10;  // Â±10ê°• ë§¤ì¹­
  for (var name in active) {
    if (name === myName) 
      continue;
    if (now - active[name] > ACTIVE_TTL_MS) 
      continue;
    var u = d.users[name];
    if (!u) 
      continue;
    normalizeUserData(u);
    var hasEligible = false;
    var pokes = getBattleEligiblePokemons(u);
    if (pokes.length === 0) 
      continue;
    if (targetEnh == null) {
      hasEligible = true;
    } else {
      // ë‚´ í¬ì¼“ëª¬ ê¸°ì¤€ Â±10ê°•ì´ ìˆëŠ”ì§€ í™•ì¸
      var minE = targetEnh - RANGE;
      var maxE = targetEnh + RANGE;
      for (var k = 0; k < pokes.length; k++) {
        var pe = pokes[k].enh || 0;
        if (pe >= minE && pe <= maxE) {
          hasEligible = true;
          break;
        }
      }
    }
    if (hasEligible) 
      list.push(name);
  }
  return list;
}
// ë˜í¼(ê¸°ì¡´ í˜¸ì¶œë¶€ í˜¸í™˜)
function trackRoomActive(d, room, sender) {
  trackRoomActiveMem(room, sender);
}
function getEligibleOpponents(d, room, myName) {
  return getEligibleOpponentsMem(d, room, myName);
}
// -------------------- íƒ€ì… ìƒì„± ê³„ì‚° --------------------
function remapTypeMult(m) {
  // ì›ë³¸ ìƒì„± m: 0, 0.5, 1, 2
  // ëª©í‘œ: ìƒì„±ì€ ê°•í•˜ê²Œ, í•˜ì§€ë§Œ ê°•í™”/í¬ê·€ë„ë¡œ ì»¤ë²„ ì—¬ì§€ ìœ ì§€
  if (m === 0) 
    return 0.25;
  if (m === 0.5) 
    return 0.95;
  if (m === 1) 
    return 1.50;
  if (m === 2) 
    return TYPE_STRONG;
  return 2.40;
}
function typeMultiplierAdjusted(attackType, defendType) {
  if (!attackType || !defendType) 
    return 2;
  var row = TYPE_CHART[attackType];
  if (!row) 
    return 2;
  var raw = row[defendType];
  return remapTypeMult((raw === undefined) ? 1 : raw);
}
// [ìˆ˜ì •] í¬ê·€ë„ë³„ ìŠ¤íƒ¯ ë°°ìœ¨ (ë®¤ì¸  ì „ìš© í˜œíƒ ì¶”ê°€)
function rarityBattleMul(r, dbId) {
  // dbId ì¸ì ì¶”ê°€ë¨
  // â˜… ë®¤ì¸ (150) ì „ìš© íˆë“  ë²„í”„ (ê¸°ì¡´ ì „ì„¤ë³´ë‹¤ 10% ë” ì…ˆ)
  if (dbId === 150) 
    return 1.60;
  if (dbId === 151) 
    return 1.60;
  if (r <= 1) 
    return 1.00;
  if (r === 2) 
    return 1.06;
  if (r === 3) 
    return 1.13;
  if (r === 4) 
    return 1.25;
  return 1.45;
}
// [ë°¸ëŸ°ìŠ¤ íŒ¨ì¹˜] ì§„í™” ë‹¨ê³„ë³„ ë³´ë„ˆìŠ¤ ì••ì¶•
function stageBattleMul(pid) {
  if (!pid) 
    return {
  atk: 1.00, 
  def: 1.00};
  var s = getStageFromBase(pid);
  // 0ë‹¨ê³„ (ë¯¸ì§„í™”): ê¸°ì¤€
  if (s === 0) 
    return {
  atk: 1.00, 
  def: 1.00};
  if (s === 1) 
    return {
  atk: 1.08, 
  def: 1.05};
  return {
  atk: 1.18, 
  def: 1.10};
}
// =================================================================
// ğŸ§¬ [ì‹œìŠ¤í…œ] ì§„í™” ì¡±ë³´ í•´ì„ê¸° (EVOLVE_DB ëŒ€ì‘ ë²„ì „)
// =================================================================
// 1. ì—­ë°©í–¥ ì¡±ë³´ ìƒì„± (ìì‹ -> ë¶€ëª¨ ì°¾ê¸°ìš©)
// EVOLVE_DBê°€ ë³µì¡í•´ì¡Œìœ¼ë¯€ë¡œ(ë°°ì—´/ê°ì²´ í˜¼ìš©), í•´ì„ê¸°ë„ ë˜‘ë˜‘í•´ì ¸ì•¼ í•©ë‹ˆë‹¤.
function buildPreMap() {
  var pre = {};
  for (var src in EVOLVE_DB) {
    var rule = EVOLVE_DB[src];
    var parentId = parseInt(src, 10);
    // ì´ë¸Œì´/ëƒ„ìƒˆê¼¬ì²˜ëŸ¼ ì§„í™”ì²˜ê°€ ì—¬ëŸ¬ ê°œì¸ ê²½ìš° (ë°°ì—´)
    if (Array.isArray(rule)) {
      for (var i = 0; i < rule.length; i++) {
        pre[rule[i].to] = parentId;
      }
    } else {
      pre[rule.to] = parentId;
    }
  }
  return pre;
}
// â˜… ì´ ë³€ìˆ˜ê°€ ì¡±ë³´ì˜ í•µì‹¬ì…ë‹ˆë‹¤!
var PRE_MAP = buildPreMap();
// 2. ì¡°ìƒë‹˜(ê¸°ë³¸í˜•) ì°¾ê¸° - "ë‚´ ë¿Œë¦¬ëŠ” ì–´ë””ì¸ê°€?"
function getBaseId(pid) {
  var cur = pid;
  var safety = 0;
  // ë¶€ëª¨ê°€ ì—†ì„ ë•Œê¹Œì§€ ê±°ìŠ¬ëŸ¬ ì˜¬ë¼ê°
  while (PRE_MAP[cur] && safety < 10) {
    cur = PRE_MAP[cur];
    safety++;
  }
  return cur;
}
// 3. ì§„í™” ë‹¨ê³„ í™•ì¸ (0:ê¸°ë³¸, 1:1ì°¨, 2:2ì°¨) - ìŠ¤íƒ¯ ê³„ì‚°ìš©
function getStageFromBase(pid) {
  var depth = 0;
  var cur = pid;
  var safety = 0;
  while (PRE_MAP[cur] && safety < 10) {
    cur = PRE_MAP[cur];
    depth++;
    safety++;
  }
  return depth;
}
// 4. (êµ¬í˜• í˜¸í™˜) ì²´ì¸ ê¹Šì´ ê³„ì‚° - ì´ì œ ì•ˆ ì“°ì§€ë§Œ ì—ëŸ¬ ë°©ì§€ìš©ìœ¼ë¡œ ë‚¨ê¹€
function chainDepthFromBase(baseId) {
  return 0;
}
// 5. ì§„í™” ì‹¤í–‰ í•¨ìˆ˜ (ì´ë¦„ ë³€ê²½ ì•Œë¦¼)
function evolveTo(p, newPid) {
  var before = findPokemonDB(p.pid);
  p.pid = newPid;
  var after = findPokemonDB(p.pid);
  var bName = before ? before.name : "í¬ì¼“ëª¬";
  var aName = after ? after.name : "ì•Œìˆ˜ì—†ìŒ";
  return bName + " â” " + aName;
}
// [ìˆ˜ì •ë¨] ì§„í™” ì²´í¬ (ì¹œë°€ë„ ì ìš©)
function checkLevelEvolution(u, p) {
    var rule = EVOLVE_DB[p.pid];
    if (!rule) return null; 
    
    var targetId = 0;
    var consumeItem = null; 
    var currentHour = new Date().getHours(); 

    function evaluateRule(r) {
        // [A] ì•„ì´í…œ ì¥ì°© ë ˆë²¨ì—…
        if (r.type === "item_hold") {
            if (p.equip === r.val) return { id: r.to, item: r.val };
        }
        // [B] ë‹¨ìˆœ ë ˆë²¨ì—…
        else if (r.type === "level") {
            if ((p.lv || 1) >= r.val) return { id: r.to, item: null };
        }
        // [C] â˜… ì¹œë°€ë„ ì§„í™” (220 ì´ìƒ)
        else if (r.type === "friendship") {
             if ((p.friendship || 0) >= 220) return { id: r.to, item: null };
        }
        // [D] ì‹œê°„ëŒ€ë³„ ì¹œë°€ë„ (ì´ë¸Œì´)
        else if (r.type === "friendship_day") { // ë‚® (06~18ì‹œ)
            if ((p.friendship || 0) >= 220 && currentHour >= 6 && currentHour < 18) return { id: r.to, item: null };
        }
        else if (r.type === "friendship_night") { // ë°¤ (18~06ì‹œ)
            if ((p.friendship || 0) >= 220 && (currentHour >= 18 || currentHour < 6)) return { id: r.to, item: null };
        }
        
        // â€» trade, trade_itemì€ ì—¬ê¸°ì„œ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ (êµí™˜ ì‹œ ì²˜ë¦¬)
        return null;
    }

    if (Array.isArray(rule)) {
        for (var i = 0; i < rule.length; i++) {
            var res = evaluateRule(rule[i]);
            if (res) { targetId = res.id; consumeItem = res.item; break; }
        }
    } else {
        var res = evaluateRule(rule);
        if (res) { targetId = res.id; consumeItem = res.item; }
    }

    if (targetId > 0) {
        if (consumeItem) p.equip = null; 
        return evolveTo(p, targetId);
    }
    return null;
}

// =================================================================
// ğŸ“ˆ [Phase 3] í¬ì¼“ëª¬ ì„±ì¥ ì‹œìŠ¤í…œ (ê²½í—˜ì¹˜ & ë ˆë²¨ì—… & ìë™ì§„í™”)
// =================================================================
// 1. í¬ì¼“ëª¬ ë ˆë²¨ì—…ì— í•„ìš”í•œ ê²½í—˜ì¹˜ëŸ‰ ê³„ì‚° (ê³µì‹: ë ˆë²¨^3)
function getPokemonNextExp(lv) {
  // 1ë ™->2ë ™: 100, 10ë ™->11ë ™: 1000... ì ì  ì–´ë ¤ì›Œì§
  // (ë°¸ëŸ°ìŠ¤ëŠ” í•„ìš”ì‹œ ì—¬ê¸°ì„œ ì¡°ì •)
  var base = 100;
  if (lv > 50) 
    base = 250;
  return Math.floor(Math.pow(lv, 3) / 4) + base;
}
// [ê°œí¸] ë ˆë²¨ì—…/ê²½í—˜ì¹˜ íšë“ ì‹œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜
function gainPokemonExp(u, p, expGain) {
  if (p.lv >= MAX_POKE_LV) return "";
  
  p.exp += expGain;
  var totalMsg = "";
  var levelUpCount = 0;

  while (true) {
    var need = getPokemonNextExp(p.lv);
    if (p.exp >= need) {
      p.exp -= need;
      p.lv++;
      levelUpCount++;
      if (p.lv >= MAX_POKE_LV) { p.exp = 0; break; }
    } else { break; }
  }

  if (levelUpCount > 0) {
    totalMsg += "ğŸ†™ " + getDisplayName(p) + " (Lv." + (p.lv - levelUpCount) + " â” Lv." + p.lv + ") ìƒìŠ¹!";
    
    // â˜… ì—¬ê¸°ì„œë§Œ ì§„í™” ì²´í¬ë¥¼ í•©ë‹ˆë‹¤! (ê°•í™” ì‹œì—ëŠ” ì•ˆ í•¨)
    var evoResult = checkLevelEvolution(u, p); 
    if (evoResult) {
      totalMsg += "\nâœ¨ ì˜¤?! í¬ì¼“ëª¬ì˜ ìƒíƒœê°€...! " + evoResult + " ì§„í™” ì„±ê³µ!";
      dexCaught(u, p.pid, p.grade, p.shiny);
    }
  }
  return totalMsg;
}


// -------------------- íšŒì› / ê³„ì • --------------------
function ensureUser(d, sender) {
  if (!d.users[sender]) {
    d.users[sender] = {
  trainerLv: 1, 
  trainerExp: 0, 
  gold: 0, 
  ball: 0, 
  superBall: 0, 
  ultraBall: 0, 
  pokemons: [], 
  nextPokeUid: 1, 
  lastFieldAt: 0, 
  lastExploreAt: 0, 
  lastEnhanceAt: 0, 
  lastAttendanceKey: "", 
  catchFailStreak: 0, 
  lastCatchPid: 0, 
  stats: {}, 
  dex: {}, 
  isNewUser: true, 
  world: "íŒŒì•¼ë ˆë°”"};
    ensureUserStats(d.users[sender]);
    ensureUserDex(d.users[sender]);
    return true;
  }
  return false;
}
// -------------------- [ì‹ ì„¤] ë“±ê¸‰ ë° ê°œì²´ê°’(IV) ì‹œìŠ¤í…œ --------------------
var GRADE_ORDER = {
  "D": 0, 
  "C": 1, 
  "B": 2, 
  "A": 3, 
  "S": 4};
// ëœë¤ ë“±ê¸‰ ê²°ì • (S: 5%, A: 10%, B: 20%, C: 35%, D: 30%)
function generatePokemonGrade() {
  var r = Math.random();
  if (r < 0.05) 
    return "S";
  if (r < 0.15) 
    return "A";
  if (r < 0.35) 
    return "B";
  if (r < 0.65) 
    return "C";
  return "D";
}
// ë“±ê¸‰ì— ë”°ë¥¸ ê°œì²´ê°’(IV) ìƒì„± ë²”ìœ„
function generateIVsByGrade(grade) {
  var ivs = {
  str: 0, 
  hp: 0, 
  spd: 0};
  if (grade === "S") {
    ivs.str = randInt(13, 15);
    ivs.hp = randInt(120, 150);
    ivs.spd = randInt(13, 15);
  } else if (grade === "A") {
    ivs.str = randInt(10, 12);
    ivs.hp = randInt(80, 119);
    ivs.spd = randInt(10, 12);
  } else if (grade === "B") {
    ivs.str = randInt(7, 9);
    ivs.hp = randInt(50, 79);
    ivs.spd = randInt(7, 9);
  } else if (grade === "C") {
    ivs.str = randInt(4, 6);
    ivs.hp = randInt(20, 49);
    ivs.spd = randInt(4, 6);
  } else {
    ivs.str = randInt(1, 3);
    ivs.hp = randInt(1, 19);
    ivs.spd = randInt(1, 3);
  }
  return ivs;
}

// í¬ê·€ë„: 1(í”í•¨) ~ 5(ì „ì„¤)
// db.rarity ë˜ëŠ” db.tier ê°™ì€ ê°’ì´ ì´ë¯¸ ìˆìœ¼ë©´ ê±°ê¸°ì— ë§ì¶° ì—°ê²°í•˜ë©´ ë¨.
function randInt(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}
function getRarity(pid) {
  // ìš°ì„  DBì— rarityê°€ ìˆìœ¼ë©´ ê·¸ê±¸ ì“°ëŠ” ê±¸ ì¶”ì²œ
  // ì—¬ê¸°ì„œëŠ” findPokemonDB(pid).rarity ë¥¼ ê°€ì •
  var db = findPokemonDB(pid);
  if (db && db.rarity != null) 
    return db.rarity;
  return 1;
}
function isLegendary(pid) {
  // DBì— legendary í”Œë˜ê·¸ê°€ ìˆìœ¼ë©´ ê·¸ê±¸ ì‚¬ìš© ì¶”ì²œ
  // ì—¬ê¸°ì„œëŠ” db.legendary ë˜ëŠ” rarity==5 ë¡œ ì²˜ë¦¬
  var db = findPokemonDB(pid);
  if (db && db.legendary != null) 
    return !!db.legendary;
  var r = (db && db.rarity != null) ? db.rarity : 1;
  return r >= 5;
}
// í¬ê·€ë„ë³„ ê¸°ë³¸ ë³´ìƒ í…Œì´ë¸” (ì›í•˜ëŠ” ìˆ˜ì¹˜ë¡œ ì¡°ì ˆ ê°€ëŠ¥)
var CATCH_REWARD_BASE = {
  1: {
  gold: 60, 
  exp: 18}, 
  2: {
  gold: 100, 
  exp: 28}, 
  3: {
  gold: 160, 
  exp: 45}, 
  4: {
  gold: 260, 
  exp: 70}, 
  5: {
  gold: 400, 
  exp: 110}};
// ë ˆë²¨/ë‚œìˆ˜/í¬ê·€ë„ê¹Œì§€ ë°˜ì˜í•´ì„œ ìµœì¢… ë³´ìƒ ì‚°ì¶œ
function calcCatchRewards(u, pid) {
  var db = findPokemonDB(pid) || {};
  var rarity = (db.rarity != null) ? db.rarity : 1;
  rarity = clamp(rarity, 1, 5);
  var base = CATCH_REWARD_BASE[rarity] || CATCH_REWARD_BASE[1];
  // ë ˆë²¨ ë³´ì •: ë ˆë²¨ì´ ë†’ì„ìˆ˜ë¡ ì†Œí­ ì¦ê°€ (ë„ˆë¬´ í­ì¦í•˜ì§€ ì•Šê²Œ)
  var lv = (u && typeof u.trainerLv === "number") ? u.trainerLv : 1;
  // ë‚œìˆ˜ ë³´ì •: í¬ê·€ë„ê°€ ë†’ì„ìˆ˜ë¡ í­ì´ ì»¤ì§
  // ì˜ˆ: í”í•¨ Â±20%, ì „ì„¤ Â±35%
  var jitterPct = [0, 20, 22, 26, 30, 35][rarity];  // ì¸ë±ìŠ¤ ë§ì¶¤
  var goldJ = randInt(-jitterPct, jitterPct) / 100;
  var expJ = randInt(-jitterPct, jitterPct) / 100;
  // ë ˆë²¨ ê³„ìˆ˜: 1 + (ë ˆë²¨ / 100) ì •ë„ë¡œ ì™„ë§Œí•˜ê²Œ
  var lvMul = 1 + (lv / 100);
  var gold = Math.floor(base.gold * lvMul * (1 + goldJ));
  var exp = Math.floor(base.exp * lvMul * (1 + expJ));
  // ìµœì†Œê°’ ë³´ì •
  gold = Math.max(1, gold);
  exp = Math.max(1, exp);
  // ì „ì„¤ íŠ¹ìˆ˜ ë³´ë„ˆìŠ¤(ì¶”ê°€ ë³´ìƒ): í° í•œë°© + ì—°ì¶œìš©
  var legendary = isLegendary(pid);
  var bonusGold = 0;
  var bonusExp = 0;
  if (legendary) {
    bonusGold = randInt(180, 360) + Math.floor(lv * 1.2);
    bonusExp = randInt(120, 240) + Math.floor(lv * 0.9);
  }
  return {
  rarity: rarity, 
  legendary: legendary, 
  gold: gold, 
  exp: exp, 
  bonusGold: bonusGold, 
  bonusExp: bonusExp, 
  totalGold: gold + bonusGold, 
  totalExp: exp + bonusExp};
}
// ì „ì„¤ ì—°ì¶œ ë¬¸êµ¬
function legendaryCatchFX(sender, name, r) {
  // r: calcCatchRewards ê²°ê³¼
  return (blockTitle("ì „ì„¤ í¬íš") + "âœ¨ " + sayDo(sender, "ì „ì„¤ê¸‰ " + name + "ì„(ë¥¼) í¬íší–ˆì–´ìš”!") + "\n\n" + "ğŸ† íŠ¹ìˆ˜ ë³´ìƒ ë°œìƒ!\n" + "ì¶”ê°€ ë³´ìƒ: +" + r.bonusGold + "ğŸ’° / +" + r.bonusExp + "EXP\n\n");
}
function getMaxCatchAttempts(pid) {
  var db = findPokemonDB(pid);
  var r = db ? (db.rarity || 2) : 2;
  var min = 1;
  var max = 8;
  if (r <= 1) 
    min = 5;
  else if (r === 2) 
    min = 4;
  else if (r === 3) 
    min = 3;
  else if (r === 4) 
    min = 2;
  else 
    min = 1;  // r5
  return min + Math.floor(Math.random() * (max - min + 1));
}
// -------------------- ì†Œí”„íŠ¸ í”¼í‹° í¬í•¨ í¬íš íŒì • (4-D) --------------------
var CATCH_PITY_START = 2;// 2ì—°ì† ì‹¤íŒ¨ë¶€í„°
var CATCH_PITY_STEP = 0.01;// ì‹¤íŒ¨ 1íšŒë‹¹ +1%
var CATCH_PITY_MAX = 0.05;// ìµœëŒ€ +5%
function lerp(a, b, t) {
  return a + (b - a) * t;
}
function tierCatchMod(tier) {
  if (tier <= 1) 
    return 1.40;
  if (tier >= 5) 
    return 0.32;
  if (tier < 2) 
    return lerp(1.40, 1.15, tier - 1);
  if (tier < 3) 
    return lerp(1.15, 0.85, tier - 2);
  if (tier < 4) 
    return lerp(0.85, 0.55, tier - 3);
  return lerp(0.55, 0.32, tier - 4);
}
function getCatchTier(db) {
  if (!db) 
    return 2;
  return CATCH_TIER_OVERRIDES[db.id] || db.rarity || 2;
}
function tryCatch(u, pid, ballType) {
  // â˜… [ìˆ˜ì •] í‚¹ê°“ë³¼(3ë²ˆ)ì€ ë¬»ì§€ë„ ë”°ì§€ì§€ë„ ì•Šê³  100% ì„±ê³µ ë¦¬í„´
  if (ballType === 3) {
    return {
  ok: true, 
  success: true, 
  chance: 1.0, 
  streak: 0, 
  tier: 0};
  }
  var db = findPokemonDB(pid);
  if (!db) 
    return {
  ok: false};
  if (u.lastCatchPid !== pid) {
    u.catchFailStreak = 0;
    u.lastCatchPid = pid;
  }
  var base = 0.38;
  var ballMult = BALL_CATCH_MULT[ballType] || 1.0;
  var tier = getCatchTier(db);
  var tierMult = tierCatchMod(tier);
  var lvBonus = trainerCatchBonus(u.trainerLv);
  var chance = base * ballMult * tierMult * rarityCatchMul(db.rarity || 2) * (1 + lvBonus);
  // ì €ë ˆë²¨ ì „ì„¤ ì–µì œ
  if (db.rarity === 5 && u.trainerLv < 20) {
    chance *= 0.5;
  }
  if (chance < 0.02) 
    chance = 0.02;
  if (chance > 0.90) 
    chance = 0.90;
  if (u.catchFailStreak >= CATCH_PITY_START) {
    var pity = (u.catchFailStreak - CATCH_PITY_START + 1) * CATCH_PITY_STEP;
    pity *= (1 + (tier - 2) * 0.12);
    pity = Math.min(CATCH_PITY_MAX, pity);
    chance *= (1 + pity);
  }
  chance = Math.max(0.02, Math.min(0.95, chance));
  var success = Math.random() < chance;
  if (success) {
    u.catchFailStreak = 0;
    u.lastCatchPid = 0;
  } else {
    u.catchFailStreak++;
  }
  return {
  ok: true, 
  success: success, 
  chance: chance, 
  streak: u.catchFailStreak, 
  tier: tier};
}
function commitSave(force) {
  markDirty();
  flushSaveIfNeeded(!!force);
}
function debugBattle(d, sender, room, replier) {
  var now = Date.now();
  var roomActive = ROOM_ACTIVE_MEM[room] || {};
  var activeUsers = [];
  var existUsers = [];
  var pokemonUsers = [];
  var candidates = [];
  for (var name in roomActive) {
    var last = roomActive[name];
    if (now - last <= ACTIVE_TTL_MS) {
      activeUsers.push(name);
      if (d.users && d.users[name]) {
        existUsers.push(name);
        var pokes = d.users[name].pokemons;
        if (pokes && Object.keys(pokes).length > 0) {
          pokemonUsers.push(name);
          if (name !== sender) 
            candidates.push(name);
        }
      }
    }
  }
  var msgLines = [];
  msgLines.push("ë°°í‹€ ë””ë²„ê·¸");
  msgLines.push("ë°©: " + room);
  msgLines.push("ë‚˜: " + sender);
  msgLines.push("í˜„ì¬ ì‹œê°„: " + new Date(now).toLocaleString());
  msgLines.push("");
  msgLines.push("ìµœê·¼ í™œë™ ìœ ì € ìˆ˜: " + activeUsers.length);
  msgLines.push(activeUsers.join(", ") || "(ì—†ìŒ)");
  msgLines.push("");
  msgLines.push("ìœ ì € ë°ì´í„° ì¡´ì¬: " + existUsers.length);
  msgLines.push(existUsers.join(", ") || "(ì—†ìŒ)");
  msgLines.push("");
  msgLines.push("í¬ì¼“ëª¬ ë³´ìœ  ìœ ì €: " + pokemonUsers.length);
  msgLines.push(pokemonUsers.join(", ") || "(ì—†ìŒ)");
  msgLines.push("");
  msgLines.push("ìµœì¢… ë°°í‹€ í›„ë³´(ë³¸ì¸ ì œì™¸): " + candidates.length);
  msgLines.push(candidates.join(", ") || "(ì—†ìŒ)");
  replier.reply(msgLines.join("\n"));
}
// ê±°ë˜ ì¤‘ë³µ ë°©ì§€ìš© ë½
var TRANSACTION_LOCK = {};
// ==================================================================
// ğŸ›ï¸ [v3.4 ìµœì¢…] ì²´ìœ¡ê´€ ê´€ì¥ (ì…ì¥ë£Œ í˜„ì‹¤í™”: 50ë§Œ ~ 2,000ë§Œ)
// ==================================================================
var GYM_LEADERS = [{
  name: "ì›…ì´", 
  type: "ë°”ìœ„", 
  badge: "ğŸª¨", 
  entryFee: 500000, 
  lineup: [{
  id: 74, 
  name: "ê¼¬ë§ˆëŒ", 
  enh: 10, 
  grade: "B", 
  shiny: false}, {
  id: 111, 
  name: "ë¿”ì¹´ë…¸", 
  enh: 15, 
  grade: "A", 
  shiny: false}, {
  id: 95, 
  name: "ë¡±ìŠ¤í†¤", 
  enh: 25, 
  grade: "S", 
  shiny: true}]}, {
  name: "ì´ìŠ¬", 
  type: "ë¬¼", 
  badge: "ğŸ’§", 
  entryFee: 1000000, 
  lineup: [{
  id: 120, 
  name: "ë³„ê°€ì‚¬ë¦¬", 
  enh: 20, 
  grade: "A", 
  shiny: false}, {
  id: 130, 
  name: "ê°¸ë¼ë„ìŠ¤", 
  enh: 30, 
  grade: "S", 
  shiny: false}, {
  id: 121, 
  name: "ì•„ì¿ ìŠ¤íƒ€", 
  enh: 40, 
  grade: "S", 
  shiny: true}]}, {
  name: "ë§ˆí‹°ìŠ¤", 
  type: "ì „ê¸°", 
  badge: "âš¡", 
  entryFee: 2000000, 
  lineup: [{
  id: 100, 
  name: "ì°Œë¦¬ë¦¬ê³µ", 
  enh: 35, 
  grade: "A", 
  shiny: false}, {
  id: 125, 
  name: "ì—ë ˆë¸Œ", 
  enh: 45, 
  grade: "S", 
  shiny: false}, {
  id: 26, 
  name: "ë¼ì´ì¸„", 
  enh: 50, 
  grade: "S", 
  shiny: true}]}, {
  name: "ë¯¼í™”", 
  type: "í’€", 
  badge: "ğŸŒ¿", 
  entryFee: 3500000, 
  lineup: [{
  id: 70, 
  name: "ìš°ì¸ ë™", 
  enh: 45, 
  grade: "A", 
  shiny: false}, {
  id: 114, 
  name: "ë©ì¿ ë¦¬", 
  enh: 50, 
  grade: "S", 
  shiny: false}, {
  id: 3, 
  name: "ì´ìƒí•´ê½ƒ", 
  enh: 60, 
  grade: "S", 
  shiny: true}]}, {
  name: "ë…ìˆ˜", 
  type: "ë…", 
  badge: "â˜ ï¸", 
  entryFee: 5000000, 
  lineup: [{
  id: 109, 
  name: "ë˜ê°€ìŠ¤", 
  enh: 55, 
  grade: "A", 
  shiny: false}, {
  id: 89, 
  name: "ì§ˆë»ê¸°", 
  enh: 60, 
  grade: "S", 
  shiny: false}, {
  id: 110, 
  name: "ë˜ë„ê°€ìŠ¤", 
  enh: 65, 
  grade: "S", 
  shiny: true}]}, {
  name: "ì´ˆë ¨", 
  type: "ì—ìŠ¤í¼", 
  badge: "ğŸ”®", 
  entryFee: 8000000, 
  lineup: [{
  id: 122, 
  name: "ë§ˆì„ë§¨", 
  enh: 60, 
  grade: "S", 
  shiny: false}, {
  id: 65, 
  name: "í›„ë”˜", 
  enh: 65, 
  grade: "S", 
  shiny: false}, {
  id: 151, 
  name: "ë®¤", 
  enh: 70, 
  grade: "S", 
  shiny: true}]}, {
  name: "ê°•ì—°", 
  type: "ë¶ˆ", 
  badge: "ğŸ”¥", 
  entryFee: 12000000, 
  lineup: [{
  id: 78, 
  name: "ë‚ ìŒ©ë§ˆ", 
  enh: 65, 
  grade: "S", 
  shiny: false}, {
  id: 6, 
  name: "ë¦¬ìëª½", 
  enh: 70, 
  grade: "S", 
  shiny: false}, {
  id: 146, 
  name: "íŒŒì´ì–´", 
  enh: 75, 
  grade: "S", 
  shiny: true}]}, {
  name: "ë¹„ì£¼ê¸°", 
  type: "ë•…", 
  badge: "ğŸŒ", 
  entryFee: 20000000, 
  lineup: [{
  id: 112, 
  name: "ì½”ë¿Œë¦¬", 
  enh: 75, 
  grade: "S", 
  shiny: false}, {
  id: 34, 
  name: "ë‹ˆë“œí‚¹", 
  enh: 80, 
  grade: "S", 
  shiny: false}, {
  id: 150, 
  name: "ë®¤ì¸ ", 
  enh: 75, 
  grade: "S", 
  shiny: true}]}];
// ==================================================================
// ğŸ‘‘ [v3.4 ìµœì¢…] NPC ì±”í”¼ì–¸ 'ë ˆë“œ' (ë§ë‚˜ë‡½ ì—ì´ìŠ¤) - í•˜ë‚˜ë§Œ ë‚¨ê¹€
// ==================================================================
var NPC_CHAMPION = {
  name: "ë ˆë“œ(NPC)", 
  isNpc: true, 
  lineup: [{
  id: 25, 
  name: "í”¼ì¹´ì¸„", 
  enh: 75, 
  grade: "S", 
  shiny: true}, {
  id: 3, 
  name: "ì´ìƒí•´ê½ƒ", 
  enh: 78, 
  grade: "S", 
  shiny: false}, {
  id: 9, 
  name: "ê±°ë¶ì™•", 
  enh: 78, 
  grade: "S", 
  shiny: false}, {
  id: 143, 
  name: "ì ë§Œë³´", 
  enh: 78, 
  grade: "S", 
  shiny: false}, {
  id: 6, 
  name: "ë¦¬ìëª½", 
  enh: 85, 
  grade: "S", 
  shiny: true}, {
  id: 149, 
  name: "ë§ë‚˜ë‡½", 
  enh: 90, 
  grade: "S", 
  shiny: true}]};
// ==================== [í•µì‹¬] ë¦´ë ˆì´ ë°°í‹€ ì—”ì§„ (ì´ë¦„ ëª…ì‹œ ë²„ì „) ====================
function simulateRelayBattle(teamA, teamB, nameA, nameB, isChampBattle) {
  // íŒ€ ë°ì´í„° ì´ˆê¸°í™” (HP ì„¸íŒ… + ì¥ë¹„ ì²´ë ¥ ë°˜ì˜)
  function initTeam(team, isChallenger) {
    return team.map(function(p) {
  var db = findPokemonDB(p.pid || p.id);
  // ì²´ë ¥ ê³„ì‚° ì‹œ ì¥ë¹„(p.equip) ì „ë‹¬
  var maxHp = calcHP(db, p.enh, p.ivHp || 15, p.equip);
  // ì±”í”¼ì–¸ ë°©ì–´ì „ ë²„í”„ (ë„ì „ìê°€ ì•„ë‹ˆë©´ ì²´ë ¥ 1.5ë°°)
  if (isChampBattle && !isChallenger) {
    maxHp = Math.floor(maxHp * 1.5);
  }
  return {
  origin: p, 
  db: db, 
  maxHp: maxHp, 
  curHp: maxHp, 
  isDead: false};
});
  }
  var tA = initTeam(teamA, true);
  var tB = initTeam(teamB, false);
  var idxA = 0;
  var idxB = 0;
  var log = [];
  var turn = 1;
  log.push("âš”ï¸ BATTLE START âš”ï¸");
  log.push(nameA + " ğŸ†š " + nameB + "\n");
  // ì´ˆê¸° í¬ì¼“ëª¬ ë“±ì¥ ì²˜ë¦¬ (justSwapped í”Œë˜ê·¸ ê°•ì œ ì„¤ì •)
  tA[0].justSwapped = true;
  tB[0].justSwapped = true;
  // --- ë¦´ë ˆì´ ë£¨í”„ ---
  while (idxA < tA.length && idxB < tB.length && turn < 500) {
    var pA = tA[idxA];
    var pB = tB[idxB];
    // 1. í¬ì¼“ëª¬ êµì²´/ë“±ì¥ ë¡œê·¸ (í„´ ì‹œì‘ ì „)
    if (turn === 1 || pA.justSwapped || pB.justSwapped) {
      if (pA.justSwapped) {
        log.push("ğŸ”„ " + nameA + "ì˜ " + getDisplayName(pA.origin) + " ë“±ì¥!");
        pA.justSwapped = false;
      }
      if (pB.justSwapped) {
        log.push("ğŸ”„ " + nameB + "ì˜ " + getDisplayName(pB.origin) + " ë“±ì¥!");
        pB.justSwapped = false;
      }
    }
    var spdA = (pA.origin.ivSpd || 0) + (pA.origin.enh || 0);
    var spdB = (pB.origin.ivSpd || 0) + (pB.origin.enh || 0);
    // ì¥ë¹„ ìŠ¤í”¼ë“œ ë³´ì •
    if (pA.origin.equip && EQUIP_DB[pA.origin.equip] && EQUIP_DB[pA.origin.equip].type === "spd_flat") 
      spdA += EQUIP_DB[pA.origin.equip].val;
    if (pB.origin.equip && EQUIP_DB[pB.origin.equip] && EQUIP_DB[pB.origin.equip].type === "spd_flat") 
      spdB += EQUIP_DB[pB.origin.equip].val;
    var aFirst = spdA >= spdB;
    if (spdA === spdB) 
      aFirst = Math.random() < 0.5;
    function attack(attacker, defender, isChallenger) {
      var attP = attacker.origin;
      var defP = defender.origin;
      // â˜… [ìˆ˜ì •] ê³µê²©ì ì´ë¦„ ìƒì„± (isChallengerê°€ trueë©´ nameA ì‚¬ìš©)
      var trainerName = isChallenger ? nameA : nameB;
      var attackName = trainerName + "ì˜ " + getDisplayName(attP);
      // ë°ë¯¸ì§€ ê³„ì‚°
      var dmgObj = calcDamage(attacker.db, attP.enh, defender.db, defP.enh, attP.equip, defP.equip);
      var damage = dmgObj.score;
      // ì±”í”¼ì–¸ ë°©ì–´ ë²„í”„ (NPCê°€ ë§ì„ ë•Œ ë€ê°)
      if (isChampBattle && !isChallenger) {
        damage = Math.floor(damage * 0.8);
      }
      if (attP.shiny) 
        damage = Math.floor(damage * 1.1);
      damage = Math.floor(damage * rnd(0.9, 1.1));
      // ìµœì†Œ ë°ë¯¸ì§€ 1
      damage = Math.max(1, damage);
      defender.curHp -= damage;
      var eff = typeEffectText(dmgObj.mult);
      var icon = (dmgObj.mult > 1.5) ? "ğŸ’¥" : "ğŸ—¡ï¸";
      // ë¡œê·¸ ì¶œë ¥
      log.push(turn + "í„´) " + icon + " " + attackName + " ê³µê²©! â†’ " + damage + (eff ? (" (" + eff + ")") : ""));
    }    // í„´ ì§„í–‰
    if (aFirst) {
      // Aê°€ ì„ ê³µ -> ê³µê²©ìëŠ” A(ë„ì „ì) -> true
      attack(pA, pB, true);
      // Bê°€ ë°˜ê²© -> ê³µê²©ìëŠ” B(ì±”í”¼ì–¸) -> false
      if (pB.curHp > 0) 
        attack(pB, pA, false);
    } else {
      // Bê°€ ì„ ê³µ -> ê³µê²©ìëŠ” B(ì±”í”¼ì–¸) -> false
      attack(pB, pA, false);
      // Aê°€ ë°˜ê²© -> ê³µê²©ìëŠ” A(ë„ì „ì) -> true
      if (pA.curHp > 0) 
        attack(pA, pB, true);
    }
    // ì‚¬ë§ ì²´í¬ ë° ë¡œê·¸
    if (pA.curHp <= 0) {
      log.push("ğŸ’€ " + nameA + "ì˜ " + getDisplayName(pA.origin) + " ì“°ëŸ¬ì§!");
      idxA++;
      if (idxA < tA.length) 
        tA[idxA].justSwapped = true;
    }
    if (pB.curHp <= 0) {
      log.push("ğŸ’€ " + nameB + "ì˜ " + getDisplayName(pB.origin) + " ì“°ëŸ¬ì§!");
      idxB++;
      if (idxB < tB.length) 
        tB[idxB].justSwapped = true;
    }
    turn++;
  }
  var winner = (idxA < tA.length) ? "A" : "B";
  var winnerName = (winner === "A" ? nameA : nameB);
  log.push("\nğŸ ê²½ê¸° ì¢…ë£Œ! ìŠ¹ì: " + winnerName);
  return {
  winner: winner, 
  log: log.join("\n")};
}
// ==================================================================
// ğŸ¦– [ì›”ë“œ ë³´ìŠ¤] ë ˆì´ë“œ ì‹œìŠ¤í…œ ì—”ì§„ (ê³µë™ ê¸ˆê³  & Në¹µ ë¶„ë°°)
// ==================================================================
// 1. ë³´ìŠ¤ ì†Œí™˜ (ê³µê²© íšŸìˆ˜ ì¹´ìš´í„° ì¶”ê°€)
function spawnRaidBoss(d, hpBillions) {
  var hp = (hpBillions || 20) * 1000000000;
  d.worldBoss = {
  active: true, 
  name: "ë‹¤ì½”íƒ€ ë®¤ì¸ ", 
  maxHp: hp, 
  curHp: hp, 
  startTime: nowMs(), 
  endTime: nowMs() + RAID_DURATION_MS, 
  logs: {}, 
  lastHitter: null, 
  rewardPool: 0, 
  attackCounts: {}};
  return "ğŸ¦– [ê²½ê³ ] ì›”ë“œ ë³´ìŠ¤ 'ë‹¤ì½”íƒ€ ë®¤ì¸ 'ê°€ ì†Œí™˜ë˜ì—ˆìŠµë‹ˆë‹¤!\nì²´ë ¥: " + fmtNum(hp) + "\nì œí•œì‹œê°„: 40ë¶„ \nëª…ë ¹ì–´: /ë ˆì´ë“œ";
}
// 2. ë ˆì´ë“œ ì¢…ë£Œ ë° ë³´ìƒ ì •ì‚° (ìƒì„¸ ë¦¬í¬íŠ¸: ì´ ì²´ë ¥ & ê°œë³„ ë”œëŸ‰ í‘œì‹œ)
function endRaidBoss(d, isClear) {
  if (!d.worldBoss || !d.worldBoss.active) 
    return "ì§„í–‰ ì¤‘ì¸ ë ˆì´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.";
  var boss = d.worldBoss;
  if (!boss.logs) 
    boss.logs = {};
  var rankMsg = "";
  // --- 1. ë­í‚¹ ë° í†µê³„ ì‚°ì • (ì„±ê³µ/ì‹¤íŒ¨ ê³µí†µ) ---
  var list = [];
  var totalDamage = 0;
  for (var name in boss.logs) {
    var dmg = boss.logs[name];
    list.push({
  name: name, 
  dmg: dmg});
    totalDamage += dmg;
  }
  // ë”œëŸ‰ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
  list.sort(function(a, b) {
  return b.dmg - a.dmg;
});
  // --- 2. ê¸ˆê³ (Pool) ê³„ì‚° ---
  var totalPool = boss.rewardPool || 0;  // í˜„ì¬ ëª¨ì¸ ëˆ
  // â˜… [ì„±ê³µ ë³´ë„ˆìŠ¤] í† ë²Œ ì„±ê³µ ì‹œ 1000ê°œ ì¶”ê°€!
  if (isClear) {
    totalPool += 1000;
  }
  var participantCount = list.length;
  // ê¸°ë³¸ ì§€ê¸‰ (ì°¸ê°€ìƒ 3ê°œ)
  var basicReward = 3;
  var usedForBasic = participantCount * basicReward;
  // ì„±ê³¼ê¸‰ ì¬ì› (ê¸ˆê³  - ì°¸ê°€ìƒ)
  var performancePool = Math.max(0, totalPool - usedForBasic);
  // --- 3. ë¶„ë°° ë¡œì§ ---
  for (var i = 0; i < list.length; i++) {
    var r = list[i];
    var u = d.users[r.name];
    if (!u) 
      continue;
    var share = (totalDamage > 0) ? (r.dmg / totalDamage) : 0;
    var bonusCoin = Math.floor(performancePool * share);
    var finalCoin = basicReward + bonusCoin;
    var lastHitMsg = "";
    // â˜… ë§‰íƒ€ ë³´ë„ˆìŠ¤ëŠ” ì„±ê³µí–ˆì„ ë•Œë§Œ ì§€ê¸‰
    if (isClear && boss.lastHitter === r.name) {
      finalCoin += 300;
      lastHitMsg = " (ë§‰íƒ€+300)";
    }
    u.dakotaCoin = (u.dakotaCoin || 0) + finalCoin;
    // ë­í‚¹ ë¡œê·¸ (ìƒìœ„ 5ëª…) - â˜… [ìˆ˜ì •] ì •í™•í•œ ë”œëŸ‰ í‘œì‹œ ì¶”ê°€
    if (i < 5) {
      var percent = Math.floor(share * 100);
      // ì˜ˆ: 1ìœ„ ì†ì‚¬ì¥ (15,000,000ë”œ / 61%) â” ...
      rankMsg += (i + 1) + "ìœ„ " + r.name + " (ë”œëŸ‰ : " + fmtNum(r.dmg) + " / " + percent + "%) â” +" + fmtNum(finalCoin) + "ğŸª™" + lastHitMsg + "\n";
    }
  }
  var title = "";
  var subTitle = "";
  if (isClear) {
    title = "ğŸ‰ ë ˆì´ë“œ í† ë²Œ ì„±ê³µ! ğŸ‰";
    subTitle = "ğŸ’° ì„±ê³µ ë³´ë„ˆìŠ¤ +1,000ì½”ì¸ í¬í•¨ ë¶„ë°° ì™„ë£Œ!";
  } else {
    title = "ğŸ’€ ì œí•œ ì‹œê°„ ì¢…ë£Œ... í† ë²Œ ì‹¤íŒ¨";
    subTitle = "âš ï¸ ë³´ìŠ¤ëŠ” ë†“ì³¤ì§€ë§Œ, ì ë¦½ëœ ì½”ì¸ì€ ì •ì‚°í•˜ì—¬ ì§€ê¸‰ë©ë‹ˆë‹¤.";
  }
  // â˜… [ìˆ˜ì •] ë³´ìŠ¤ ì´ ì²´ë ¥ ì •ë³´ ì¶”ê°€
  var resultMsg = title + "\n\n" + subTitle + "\n" + "ğŸ‘¹ ì´ ì²´ë ¥: " + fmtNum(boss.maxHp) + "\n" + "ğŸ’° ì´ ë¶„ë°° ì½”ì¸: " + fmtNum(totalPool) + "ê°œ\n" + "ğŸ‘¥ ì°¸ì—¬ì: " + participantCount + "ëª…\n" + "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + "[ğŸ… ëª…ì˜ˆì˜ ì „ë‹¹ & ì •ì‚° ê²°ê³¼]\n" + rankMsg;
  d.worldBoss = null;  // ë³´ìŠ¤ ì‚­ì œ
  return resultMsg;
}
// [ìˆ˜ì •ë¨] ë ˆì´ë“œ ì „íˆ¬ë ¥ ê³„ì‚° (ì—”íŠ¸ë¦¬ 6ë§ˆë¦¬ í•©ì‚°)
function getRaidPower(u) {
    if (!u.party || u.party.length === 0) return 0;
    
    var totalPower = 0;
    // ì—”íŠ¸ë¦¬ì— ìˆëŠ” ëª¨ë“  í¬ì¼“ëª¬ì˜ ì „íˆ¬ë ¥ í•©ì‚°
    for(var i=0; i<u.party.length; i++) {
        var p = findUserPokemonByUid(u, u.party[i]);
        if(p) totalPower += calcBattlePower(p); 
    }
    return totalPower;
}

function executeRaidAttack(d, room, sender, u, replier, decoName, finisherReady) {
  var b = d.worldBoss;
  if (!b || !b.active || b.endTime <= new Date().getTime()) {
    replier.reply("ëŠ¦ì—ˆìŠµë‹ˆë‹¤... ì´ë¯¸ ë ˆì´ë“œê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    return;
  }
  
  if (!b.attackCounts) b.attackCounts = {};
  if (!b.attackCounts[sender]) b.attackCounts[sender] = 0;
  b.attackCounts[sender]++;

  var power = getRaidPower(u);
  var randomRate = 0.9 + (Math.random() * 0.2);
  var raidBuffMult = 60;
  var dmg = Math.floor(power * randomRate * raidBuffMult);

  var leaderUid = (u.champTeam && u.champTeam[0]) || (u.party && u.party[0]);
  var leaderP = findUserPokemonByUid(u, leaderUid);
  
  var equipType = "", equipVal = 0;
  if (leaderP && leaderP.equip && EQUIP_DB[leaderP.equip]) {
    equipType = EQUIP_DB[leaderP.equip].type;
    equipVal = EQUIP_DB[leaderP.equip].val;
  }

  var critChance = 0.15;
  var critMult = 3.0;
  var itemMsg = "";

  if (equipType === "raid_crit_rate") {
    critChance += equipVal;
    itemMsg = " (ğŸ‘“ë‘ë‘¥ë“±ì¥!)";
  } 
  else if (equipType === "raid_crit_dmg") {
    critMult = equipVal; 
    itemMsg = " (??í•´ë¦¬ì˜ ë§¤ìš´ë§›!)";
  }

  var isCrit = Math.random() < critChance;
  var hitIcon = "ğŸ’¥";
  var hitTag = "ê³µê²©";

  if (isCrit) {
    dmg = Math.floor(dmg * critMult);
    hitIcon = "â˜„ï¸";
    hitTag = "ì¹˜ëª…íƒ€" + itemMsg;
  }

  if (finisherReady) {
    dmg = Math.floor(dmg * RAID_FINISHER_MULT);
    hitIcon = "ğŸŒŒ";
    hitTag = "í•„ì‚´ê¸° ë°œí˜„" + (isCrit ? " + ì¹˜ëª…íƒ€" : "");
  }

  b.curHp -= dmg;
  if (!b.logs[sender]) b.logs[sender] = 0;
  b.logs[sender] += dmg;

  var dropCoin = 1 + Math.floor(dmg / 75000);
  dropCoin = Math.min(1000, dropCoin);
  if (finisherReady) dropCoin *= 2;
  b.rewardPool = (b.rewardPool || 0) + dropCoin;

  if (b.curHp <= 0) {
    b.curHp = 0;
    b.lastHitter = sender;
    var clearMsg = endRaidBoss(d, true);
    commitSave(true);
    checkAndNotifyTitles(u, replier);
    replier.reply("âš”ï¸ [ë ˆì´ë“œ] " + decoName + "ë‹˜ì˜ ê²°ì •íƒ€!\n" + hitIcon + " " + hitTag + ": -" + fmtNum(dmg) + " í”¼í•´!\nğŸ’° ê¸ˆê³  ì ë¦½: +" + dropCoin + "ì½”ì¸\n\n" + clearMsg);
    return;
  }

  // â˜… [í•µì‹¬ ìˆ˜ì •] ë¶€ìƒ ë°œìƒ ì‹œ ì‹œê°„ì„ ê¸°ë¡í•˜ì—¬ ê³µê²©ì„ ë§‰ìŠµë‹ˆë‹¤.
  var isInjured = Math.random() < 0.05;
  var injureMsg = "\nğŸ’¨ ê°€ë³ê²Œ ë°˜ê²©ì„ í”¼í–ˆìŠµë‹ˆë‹¤!";
  if (isInjured) {
    u.lastRaidAt = new Date().getTime(); // ë¶€ìƒ ì‹œê°„ ê¸°ë¡
    injureMsg = "\nğŸš‘ [ë¶€ìƒ] ë³´ìŠ¤ì˜ ë°˜ê²©ì— ë‹¹í–ˆìŠµë‹ˆë‹¤! (2ë¶„ê°„ ì¹˜ë£Œ í•„ìš”)";
  }
  
  commitSave(true);
  replier.reply("âš”ï¸ [ë ˆì´ë“œ] " + decoName + "ë‹˜ì˜ ì´ê³µê²©!\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + hitIcon + " " + hitTag + ": " + b.name + "ì—ê²Œ -" + fmtNum(dmg) + " í”¼í•´!\nğŸ’° ê¸ˆê³  ì ë¦½: +" + dropCoin + "ì½”ì¸" + injureMsg);
}

// -------------------- ë©”ì¸ ì‘ë‹µ --------------------
function response(room, msg, sender, isGroupChat, replier, imageDB) {
  try {
    // [ì„ì‹œ] ë‚´ ê³ ìœ ì½”ë“œ í™•ì¸ìš© (ë³´ì•ˆ ì„¤ì • í›„ì—ëŠ” ì§€ìš°ì…”ë„ ë©ë‹ˆë‹¤)
    if (msg === "/ë‚´ì½”ë“œ") {
      var myHash = java.lang.String(imageDB.getProfileImage()).hashCode();
      replier.reply(sender + "ë‹˜ì˜ ê³ ìœ  ì½”ë“œ: " + myHash);
      return;
    }
    trackRoomActiveMem(room, sender);
    var MATCH_POOL = "__GLOBAL_MATCH__";
    if (!ROOM_ACTIVE_MEM[MATCH_POOL]) 
      ROOM_ACTIVE_MEM[MATCH_POOL] = {};
    ROOM_ACTIVE_MEM[MATCH_POOL][sender] = Date.now();
    var d = getDataCached();
    // ----------------------------------------------------------------------
    // ğŸ² [ì •ì‹] ëŒë°œ ë ˆì´ë“œ ë¡œì§ (0.08% í™•ë¥  + 1ì‹œê°„ ì¿¨íƒ€ì„)
    // ----------------------------------------------------------------------
 // 1. ì¢€ë¹„ ë³´ìŠ¤ ë°ì´í„° ì •ë¦¬ ë° ìë™ ì •ì‚° ë¡œì§
    if (d.worldBoss && d.worldBoss.active && d.worldBoss.endTime <= new Date().getTime()) {
      // â˜… ì‹œê°„ì´ ì¢…ë£Œë˜ë©´ ìë™ìœ¼ë¡œ ì •ì‚° ë¦¬í¬íŠ¸ë¥¼ ë„ìš°ê³  ë³´ìƒì„ ë¶„ë°°í•©ë‹ˆë‹¤.
      var timeoutMsg = endRaidBoss(d, false); 
      replier.reply(timeoutMsg);
      commitSave(true);
    }
    if (!d.worldBoss || !d.worldBoss.active) {
      // ì¿¨íƒ€ì„ ì²´í¬ (ì „ì—­ ë³€ìˆ˜ ì‚¬ìš©)
      if (typeof d.lastRandomRaidSpawnAt !== "number") 
        d.lastRandomRaidSpawnAt = 0;
      var nowTime = new Date().getTime();
      if (nowTime - d.lastRandomRaidSpawnAt >= RAID_RANDOM_SPAWN_COOLDOWN_MS) {
        // í™•ë¥  ì²´í¬ (ì „ì—­ ë³€ìˆ˜ ì‚¬ìš©)
        if (Math.random() < RAID_RANDOM_SPAWN_PROB) {
          var keys = [];
          for (var k in HIDDEN_RAIDS) 
            keys.push(k);
          if (keys.length > 0) {
            var pickKey = keys[Math.floor(Math.random() * keys.length)];
            var rInfo = HIDDEN_RAIDS[pickKey];
            var rHp = rInfo.hp * 100000000;            // ì–µ ë‹¨ìœ„ ì ìš© (ê¸°ì¡´ 1000ë§Œ -> 1ì–µ ë‹¨ìœ„ë¡œ ë³µêµ¬)
            d.worldBoss = {
  active: true, 
  name: rInfo.name, 
  lv: rInfo.lv, 
  maxHp: rHp, 
  curHp: rHp, 
  img: rInfo.img, 
  startTime: nowTime, 
  endTime: nowTime + RAID_DURATION_MS, 
  logs: {}, 
  rewardPool: 0, 
  lastHitter: null, 
  attackCounts: {}};
            d.lastRandomRaidSpawnAt = nowTime;
            saveData(d);
            replier.reply("ğŸ² [ëŒë°œ ë ˆì´ë“œ] ëˆ„êµ°ê°€ì˜ ë§ í•œë§ˆë””ì— ë³´ìŠ¤ê°€ ì†Œí™˜ë˜ì—ˆìŠµë‹ˆë‹¤!\n" + "ğŸ‘¤ ì†Œí™˜ íŠ¸ë¦¬ê±°: " + sender + "ë‹˜ì˜ ì±„íŒ…\n\n" + "ğŸ‘¹ ë³´ìŠ¤: Lv." + rInfo.lv + " " + rInfo.name + " " + rInfo.img + "\n" + "â¤ï¸ ì²´ë ¥: " + fmtNum(rHp) + "\n" + "âš”ï¸ '/ë ˆì´ë“œ'ë¡œ ê³µê²©í•˜ì„¸ìš”!");
          }
        }
      }
    }
    if (msg.indexOf("/ê´€ë¦¬ì") === 0) {
      // sender ì˜†ì— imageDBë¥¼ ê°™ì´ ë„˜ê²¨ì¤ë‹ˆë‹¤.
      if (!isAdmin(sender, imageDB)) {
        replier.reply("ğŸš« ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.\n(ë³´ì•ˆ: ì†ì‚¬ì¥ì´ ì•„ë‹˜)");
        return;
      }
      var parts = msg.split(" ").filter(Boolean);
      var sub = parts[1] || "ë„ì›€";
      // -------------------- 1. [ë„ì›€ë§ & ì—…ë°ì´íŠ¸] --------------------
      if (sub === "ë„ì›€") {
        replier.reply(adminHelpText());
        return;
      }
      if (sub === "ì—…ë°ì´íŠ¸") {
        replier.reply("â³ ê¹ƒí—ˆë¸Œì—ì„œ ìµœì‹  ì½”ë“œë¥¼ ë°›ì•„ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...\n" + GITHUB_RAW_URL);
        try {
          // â˜… [ìˆ˜ì •] URL ë’¤ì— '?v=ì‹œê°„'ì„ ë¶™ì—¬ì„œ ìºì‹œë¥¼ ë¬´ì‹œí•˜ê³  ìµœì‹ ë³¸ì„ ê°•ì œë¡œ ê°€ì ¸ì˜´
          var noCacheUrl = GITHUB_RAW_URL + "?v=" + new Date().getTime();
          var newCode = org.jsoup.Jsoup.connect(noCacheUrl).ignoreContentType(true).execute().body();
          if (!newCode || newCode.length < 100) {
            replier.reply("ğŸš« ì‹¤íŒ¨: ì½”ë“œê°€ ë„ˆë¬´ ì§§ê±°ë‚˜ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.");
            return;
          }
          var path = "/sdcard/msgbot/Bots/" + SCRIPT_NAME + ".js";
          // (ê¸°ì¡´ ì½”ë“œ ê·¸ëŒ€ë¡œ)
          var currentCode = readFile(path);
          if (currentCode) 
            writeFile(path + ".bak", currentCode);          // ë°±ì—…
          writeFile(path, newCode);          // ë®ì–´ì“°ê¸°
          replier.reply("âœ… ë‹¤ìš´ë¡œë“œ ì™„ë£Œ! ë´‡ì„ ì¬ë¡œë”©í•©ë‹ˆë‹¤...");
          Api.reload(SCRIPT_NAME);
        }        catch (e) {
  replier.reply("âŒ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨!\n" + e);
}
        return;
      }
      if (sub === "ë ˆì´ë“œì†Œí™˜") {
        var hpInput = parseInt(parts[2]);        // ì–µ ë‹¨ìœ„
        var msgRaid = spawnRaidBoss(d, hpInput || 20);        // ê¸°ë³¸ 20ì–µ
        commitSave(true);
        replier.reply(msgRaid);
        return;
      }
      if (sub === "ë ˆì´ë“œì¢…ë£Œ") {
        d.worldBoss = null;        // ê°•ì œ ì‚­ì œ
        commitSave(true);
        replier.reply("ğŸ—‘ï¸ ë ˆì´ë“œê°€ ê°•ì œ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        return;
      }
      if (sub === "ì§€ê¸‰") {
        var targetName = parts[2];
        var itemKey = parts[3];
        var amount = parseInt(parts[4], 10);
        if (!targetName || !itemKey || isNaN(amount)) {
          replier.reply("ì‚¬ìš©ë²•: /ê´€ë¦¬ì ì§€ê¸‰ [ë‹‰ë„¤ì„] [ì•„ì´í…œëª…] [ìˆ˜ëŸ‰]");
          return;
        }
        var t = getUserByName(d, targetName);
        if (!t) {
          replier.reply("ğŸš« ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }
        normalizeUserData(t.user);        // ê°€ë°© ì•ˆì „ ì´ˆê¸°í™”
        var logMsg = "";
        // [A] ê¸°ë³¸ ìì› (ì½”ì¸ ì¶”ê°€ë¨)
        if (itemKey === "ê³¨ë“œ") {
          t.user.gold += amount;
          logMsg = "ê³¨ë“œ";
        } else if (["ì½”ì¸", "ë‹¤ì½”íƒ€ì½”ì¸", "ë‹¤ì½”íƒ€"].indexOf(itemKey) !== -1) {
          t.user.dakotaCoin = (t.user.dakotaCoin || 0) + amount;
          logMsg = "ë‹¤ì½”íƒ€ ì½”ì¸";
        } else if (itemKey === "ê²½í—˜ì¹˜") {
          t.user.trainerExp += amount;
          logMsg = "ê²½í—˜ì¹˜";
        } else if (itemKey === "ë ˆë²¨") {
          t.user.trainerLv = Math.min(MAX_LV, t.user.trainerLv + amount);
          logMsg = "ë ˆë²¨";
        } else if (["ëª¬ìŠ¤í„°ë³¼", "ëª¬", "ã…"].indexOf(itemKey) !== -1) {
          t.user.ball += amount;
          logMsg = "ëª¬ìŠ¤í„°ë³¼";
        } else if (["ìŠˆí¼ë³¼", "ìŠˆ", "ã……"].indexOf(itemKey) !== -1) {
          t.user.superBall += amount;
          logMsg = "ìŠˆí¼ë³¼";
        } else if (["í•˜ì´í¼ë³¼", "í•˜", "ã…"].indexOf(itemKey) !== -1) {
          t.user.ultraBall += amount;
          logMsg = "í•˜ì´í¼ë³¼";
        } else if (itemKey.indexOf("í‚¹ê°“") !== -1) {
          t.user.godBall = (t.user.godBall || 0) + amount;
          logMsg = "í‚¹ê°“ë³¼";
        } else if (["ë„íŒŒë¯¼", "ê°•í™”ê¶Œ"].indexOf(itemKey) !== -1) {
          t.user.dopaTicket += amount;
          logMsg = "ë„íŒŒë¯¼ê°•í™”ê¶Œ";
        } else if (["ë‘ì«€ì¿ ", "ì¿ í‚¤"].indexOf(itemKey) !== -1) {
          t.user.cookie += amount;
          logMsg = "ë‘ì«€ì¿ ";
        } else if (["í‹°ì–´ë¦¬ì…‹", "ë¦¬ì…‹"].indexOf(itemKey) !== -1) {
          t.user.reroll += amount;
          logMsg = "í‹°ì–´ë¦¬ì…‹ê¶Œ";
        } else if (["ì´ë™í‹°ì¼“", "í‹°ì¼“"].indexOf(itemKey) !== -1) {
          t.user.ticket += amount;
          logMsg = "ì´ë™í‹°ì¼“";
        } else if (["ì¥ë¹„ìƒì", "ìƒì", "ë³´ë¬¼ìƒì"].indexOf(itemKey) !== -1) {
          if (!t.user.items) 
            t.user.items = {};
          t.user.items["ì¥ë¹„ìƒì"] = (t.user.items["ì¥ë¹„ìƒì"] || 0) + amount;
          logMsg = "ğŸ“¦ ì¥ë¹„ìƒì";
        } else if (["ìƒìíŒŒí¸", "íŒŒí¸"].indexOf(itemKey) !== -1) {
          if (!t.user.items) 
            t.user.items = {};
          t.user.items["ìƒìíŒŒí¸"] = (t.user.items["ìƒìíŒŒí¸"] || 0) + amount;
          logMsg = "ğŸ§© ìƒìíŒŒí¸";
        } else if (["ë”¸ê¸°ì¿ í‚¤", "ë”¸ê¸°", "ë”¸ì«€ì¿ "].indexOf(itemKey) !== -1) {
          if (!t.user.items) 
            t.user.items = {};
          t.user.items["ë”¸ê¸°ì¿ í‚¤"] = (t.user.items["ë”¸ê¸°ì¿ í‚¤"] || 0) + amount;
          logMsg = "ğŸ“ ë”¸ê¸°ì¿ í‚¤";
        } else if (["í™©ê¸ˆì—´ë§¤", "ì—´ë§¤", "ë¼ì¦ˆì—´ë§¤"].indexOf(itemKey) !== -1) {
          if (!t.user.items) 
            t.user.items = {};
          t.user.items["í™©ê¸ˆì—´ë§¤"] = (t.user.items["í™©ê¸ˆì—´ë§¤"] || 0) + amount;
          logMsg = "ğŸ¥œ í™©ê¸ˆì—´ë§¤";
        } else if (["í™©ê¸ˆí˜ì¸íŠ¸", "í˜ì¸íŠ¸", "ì´ë¡œì¹˜"].indexOf(itemKey) !== -1) {
          if (!t.user.items) 
            t.user.items = {};
          t.user.items["í™©ê¸ˆí˜ì¸íŠ¸"] = (t.user.items["í™©ê¸ˆí˜ì¸íŠ¸"] || 0) + amount;
          logMsg = "ğŸ¨ í™©ê¸ˆí˜ì¸íŠ¸";
        } else if (EQUIP_DB[itemKey]) {
          if (!t.user.items) 
            t.user.items = {};
          t.user.items[itemKey] = (t.user.items[itemKey] || 0) + amount;
          var icon = EQUIP_DB[itemKey].icon || "ğŸ›¡ï¸";
          logMsg = icon + " " + itemKey;
        } else {
          replier.reply("ğŸš« ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì•„ì´í…œì…ë‹ˆë‹¤: " + itemKey);
          return;
        }
        commitSave(true);
        replier.reply("âœ… ì§€ê¸‰ ì™„ë£Œ: " + t.name + " ë‹˜ì—ê²Œ [" + logMsg + "] x" + amount);
        return;
      }
      if (sub === "ì „ì²´ë³´ìƒ") {
        var itemKey = parts[2];
        var amount = parseInt(parts[3], 10);
        if (!itemKey || isNaN(amount)) {
          replier.reply("ì‚¬ìš©ë²•: /ê´€ë¦¬ì ì „ì²´ë³´ìƒ [ì•„ì´í…œ] [ìˆ˜ëŸ‰]");
          return;
        }
        var count = 0;
        var isEquip = !!EQUIP_DB[itemKey];
        for (var name in d.users) {
          var uTarget = d.users[name];
          normalizeUserData(uTarget);
          var gave = false;          // ì§€ê¸‰ ì„±ê³µ ì—¬ë¶€ ì²´í¬
          // [A] ìì›
          if (itemKey === "ê³¨ë“œ") {
            uTarget.gold += amount;
            gave = true;
          } else if (["ì½”ì¸", "ë‹¤ì½”íƒ€ì½”ì¸", "ë‹¤ì½”íƒ€"].indexOf(itemKey) !== -1) {
            uTarget.dakotaCoin = (uTarget.dakotaCoin || 0) + amount;
            gave = true;
          } else if (["ë„íŒŒë¯¼", "ê°•í™”ê¶Œ"].includes(itemKey)) {
            uTarget.dopaTicket += amount;
            gave = true;
          } else if (["ë‘ì«€ì¿ ", "ì¿ í‚¤"].includes(itemKey)) {
            uTarget.cookie += amount;
            gave = true;
          } else if (["í‹°ì–´ë¦¬ì…‹", "ë¦¬ì…‹"].includes(itemKey)) {
            uTarget.reroll += amount;
            gave = true;
          } else if (["ì´ë™í‹°ì¼“", "í‹°ì¼“"].includes(itemKey)) {
            uTarget.ticket += amount;
            gave = true;
          } else if (itemKey.indexOf("í‚¹ê°“") !== -1) {
            uTarget.godBall = (uTarget.godBall || 0) + amount;
            gave = true;
          } else if (["ì¥ë¹„ìƒì", "ìƒì", "ë³´ë¬¼ìƒì"].indexOf(itemKey) !== -1) {
            if (!uTarget.items) 
              uTarget.items = {};
            uTarget.items["ì¥ë¹„ìƒì"] = (uTarget.items["ì¥ë¹„ìƒì"] || 0) + amount;
            gave = true;
          } else if (["ìƒìíŒŒí¸", "íŒŒí¸"].indexOf(itemKey) !== -1) {
            if (!uTarget.items) 
              uTarget.items = {};
            uTarget.items["ìƒìíŒŒí¸"] = (uTarget.items["ìƒìíŒŒí¸"] || 0) + amount;
            gave = true;
          } else if (["ë”¸ê¸°ì¿ í‚¤", "ë”¸ê¸°", "ë”¸ì«€ì¿ "].indexOf(itemKey) !== -1) {
            if (!uTarget.items) 
              uTarget.items = {};
            uTarget.items["ë”¸ê¸°ì¿ í‚¤"] = (uTarget.items["ë”¸ê¸°ì¿ í‚¤"] || 0) + amount;
            gave = true;
          } else if (["í™©ê¸ˆì—´ë§¤", "ì—´ë§¤", "ë¼ì¦ˆì—´ë§¤"].indexOf(itemKey) !== -1) {
            if (!uTarget.items) 
              uTarget.items = {};
            uTarget.items["í™©ê¸ˆì—´ë§¤"] = (uTarget.items["í™©ê¸ˆì—´ë§¤"] || 0) + amount;
            gave = true;
          } else if (["í™©ê¸ˆí˜ì¸íŠ¸", "í˜ì¸íŠ¸", "ì´ë¡œì¹˜"].indexOf(itemKey) !== -1) {
            if (!uTarget.items) 
              uTarget.items = {};
            uTarget.items["í™©ê¸ˆí˜ì¸íŠ¸"] = (uTarget.items["í™©ê¸ˆí˜ì¸íŠ¸"] || 0) + amount;
            gave = true;
          } else if (isEquip) {
            if (!uTarget.items) 
              uTarget.items = {};
            uTarget.items[itemKey] = (uTarget.items[itemKey] || 0) + amount;
            gave = true;
          } else {
            if (itemKey === "ëª¬ìŠ¤í„°ë³¼" || itemKey === "ë³¼") {
              uTarget.ball += amount;
              gave = true;
            } else if (itemKey === "ìŠˆí¼ë³¼") {
              uTarget.superBall += amount;
              gave = true;
            } else if (itemKey === "í•˜ì´í¼ë³¼") {
              uTarget.ultraBall += amount;
              gave = true;
            }
          }
          if (gave) 
            count++;
        }
        commitSave(true);
        if (count === 0) {
          replier.reply("ğŸš« ì§€ê¸‰ëœ ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤. ì•„ì´í…œ ì´ë¦„ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
        } else {
          replier.reply("ğŸ“¢ ì „ì²´ ë³´ìƒ ì§€ê¸‰ ì™„ë£Œ (" + count + "ëª…)\në‚´ìš©: " + itemKey + " x" + amount);
        }
        return;
      }
      if (sub === "ìŠ¤í°" || sub === "ìŠ¤í°ì˜ˆì•½") {
        var tName = parts[2];
        var pName = parts[3];
        var shinyOpt = parts[4];
        var t = getUserByName(d, tName);
        if (!t) {
          replier.reply("ìœ ì € ì—†ìŒ");
          return;
        }
        var db = findPokemonDBByName(pName);
        if (!db) {
          replier.reply("í¬ì¼“ëª¬ ì—†ìŒ");
          return;
        }
        t.user.nextSpawnPid = db.id;
        t.user.nextSpawnShiny = (shinyOpt === "Y" || shinyOpt === "y");
        commitSave(true);
        replier.reply("ğŸ“ ìŠ¤í° ì˜ˆì•½: " + t.name + " -> " + db.name + (t.user.nextSpawnShiny ? "(âœ¨)" : ""));
        return;
      }
      if (sub === "í¬ì¼“ëª¬ì§€ê¸‰") {
        var tName = parts[2];
        var pName = parts[3];
        var t = getUserByName(d, tName);
        if (!t) {
          replier.reply("ìœ ì € ì—†ìŒ");
          return;
        }
        var db = isNaN(parseInt(pName)) ? findPokemonDBByName(pName) : findPokemonDB(pName);
        if (!db) {
          replier.reply("í¬ì¼“ëª¬ ì—†ìŒ");
          return;
        }
        var uid = addPokemonToUser(t.user, db.id);
        commitSave(true);
        replier.reply("âœ… í¬ì¼“ëª¬ ì§€ê¸‰: " + t.name + " -> " + db.name + " (#" + uid + ")");
        return;
      }
      if (sub === "ì‚­ì œ") {
        var tName = parts[2];
        var uid = parseInt((parts[3] || "").replace("#", ""), 10);
        var t = getUserByName(d, tName);
        if (!t) 
          return;
        var arr = t.user.pokemons;
        for (var i = 0; i < arr.length; i++) {
          if (arr[i].uid === uid) {
            var delName = getDisplayName(arr[i]);
            arr.splice(i, 1);
            commitSave(true);
            replier.reply("ğŸ—‘ï¸ ì‚­ì œ ì™„ë£Œ: " + t.name + "ì˜ " + delName);
            return;
          }
        }
        replier.reply("UID ëª» ì°¾ìŒ");
        return;
      }
            // â˜… [ì‹ ê·œ ì¶”ê°€] ìœ ì € ê³„ì • í†µì§¸ë¡œ ì˜êµ¬ ì‚­ì œ
      if (sub === "ê³„ì •ì‚­ì œ") {
        var targetName = parts[2];
        
        if (!targetName) {
          replier.reply("ì‚¬ìš©ë²•: /ê´€ë¦¬ì ê³„ì •ì‚­ì œ [ë‹‰ë„¤ì„]");
          return;
        }

        // ëŒ€ìƒ ìœ ì €ê°€ ë°ì´í„°ë² ì´ìŠ¤(d.users)ì— ì¡´ì¬í•˜ëŠ”ì§€ ì§ì ‘ í™•ì¸
        if (d.users[targetName]) {
          delete d.users[targetName]; // í•µì‹¬: ê°ì²´ ìì²´ë¥¼ ì¦ë°œì‹œí‚´
          commitSave(true);
          replier.reply("ğŸš¨ [ê´€ë¦¬ì ì‹œìŠ¤í…œ]\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\n[" + targetName + "]ë‹˜ì˜ ëª¨ë“  ë°ì´í„°(ê³¨ë“œ, í¬ì¼“ëª¬, ì•„ì´í…œ ë“±)ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        } else {
          replier.reply("âš ï¸ [" + targetName + "]ë‹˜ì˜ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
        return;
      }
      
      if (sub === "ì ì¬ë ¥") {
        var tName = parts[2];
        var uid = parseInt(parts[3], 10);
        var str = parseInt(parts[4]);
        var hp = parseInt(parts[5]);
        var spd = parseInt(parts[6]);
        var t = getUserByName(d, tName);
        if (!t || isNaN(str)) {
          replier.reply("ì‚¬ìš©ë²•: /ê´€ë¦¬ì ì ì¬ë ¥ [ë‹‰] [UID] [í˜] [ì²´] [ë¯¼]");
          return;
        }
        var p = findUserPokemonByUid(t.user, uid);
        if (!p) {
          replier.reply("í¬ì¼“ëª¬ ì—†ìŒ");
          return;
        }
        p.ivStr = str;
        p.ivHp = hp;
        p.ivSpd = spd;
        // ë“±ê¸‰ ì¬ê³„ì‚°
        var score = str + Math.floor(hp / 10) + spd;
        if (score >= 38) 
          p.grade = "S";
        else if (score >= 28) 
          p.grade = "A";
        else if (score >= 19) 
          p.grade = "B";
        else if (score >= 10) 
          p.grade = "C";
        else 
          p.grade = "D";
        // â˜… [ìˆ˜ì •ë¨] ê´€ë¦¬ìê°€ ë°”ê¿”ì¤€ ë“±ê¸‰ì„ ë„ê°ì— ê°•ì œ ì €ì¥
        dexCaught(t.user, p.pid, p.grade);
        commitSave(true);
        replier.reply("ğŸ’ª ì ì¬ë ¥ ë³€ê²½ ì™„ë£Œ: " + getDisplayName(p) + " (" + p.grade + ")");
        return;
      }
      if (sub === "ê°•í™”") {
        var tName = parts[2];
        var uid = parseInt(parts[3], 10);
        var val = parseInt(parts[4], 10);
        var t = getUserByName(d, tName);
        if (!t) 
          return;
        var p = findUserPokemonByUid(t.user, uid);
        if (!p) 
          return;
        p.enh = val;
        if (typeof tryAutoEvolveByEnh === "function") 
          tryAutoEvolveByEnh(p);
        commitSave(true);
        replier.reply("ğŸ› ï¸ ê°•í™” ìˆ˜ì¹˜ ë³€ê²½: " + val + "ê°•");
        return;
      }
      if (sub === "ì´ë¡œì¹˜") {
        var tName = parts[2];
        var uid = parseInt(parts[3], 10);
        var t = getUserByName(d, tName);
        if (!t) 
          return;
        var p = findUserPokemonByUid(t.user, uid);
        if (!p) {
          replier.reply("í¬ì¼“ëª¬ ì—†ìŒ");
          return;
        }
        p.shiny = !p.shiny;
        // â˜… [ìˆ˜ì •ë¨] ì´ë¡œì¹˜ ìƒíƒœê°€ ì¼œì¡Œìœ¼ë©´ ë„ê°ì—ë„ 'ì´ë¡œì¹˜ ìˆìŒ' ì²´í¬
        if (p.shiny) {
          ensureUserDex(t.user);
          var pidStr = String(p.pid);
          // ë„ê° ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
          if (!t.user.dex[pidStr]) {
            t.user.dex[pidStr] = {
  seen: 0, 
  caught: 1, 
  maxGrade: p.grade || "D"};
          }
          t.user.dex[pidStr].hasShiny = true;
        }
        commitSave(true);
        replier.reply("âœ¨ ì´ë¡œì¹˜ ìƒíƒœ ë³€ê²½: " + (p.shiny ? "ON" : "OFF"));
        return;
      }
      if (sub === "ë„ê°ë™ê¸°í™”") {
        var inputName = parts.slice(2).join(" ").trim();
        if (!inputName) {
          replier.reply("ì‚¬ìš©ë²•: /ê´€ë¦¬ì ë„ê°ë™ê¸°í™” [ë‹‰ë„¤ì„]");
          return;
        }
        var tUser = null;
        var foundName = "";
        if (d.users[inputName]) {
          tUser = d.users[inputName];
          foundName = inputName;
        } else {
          var searchKey = inputName.replace(/\s+/g, "");
          for (var key in d.users) {
            var dbKey = key.replace(/\s+/g, "");
            if (dbKey === searchKey) {
              tUser = d.users[key];
              foundName = key;
              break;
            }
          }
        }
        if (!tUser) {
          replier.reply("ğŸš« ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: [" + inputName + "]");
          return;
        }
        if (!tUser.dex) 
          tUser.dex = {};        // â˜… ë³€ìˆ˜ëª… dex í™•ì¸ (pokedex ì•„ë‹˜)
        var rankScore = {
  "S": 5, 
  "A": 4, 
  "B": 3, 
  "C": 2, 
  "D": 1, 
  "F": 0};
        var updateCount = 0;
        // 3. ê°€ë°© ì „ìˆ˜ ì¡°ì‚¬
        for (var i = 0; i < tUser.pokemons.length; i++) {
          var p = tUser.pokemons[i];
          // â˜… [í•µì‹¬ ìˆ˜ì •] ì´ë¦„(name)ì´ ì•„ë‹ˆë¼ ë„ê°ë²ˆí˜¸(pid)ë¥¼ ì‚¬ìš©í•´ì•¼ í•¨!
          var pidStr = String(p.pid);
          // ê°€ë°©ì— ìˆëŠ” ë†ˆì˜ ë“±ê¸‰
          var pGrade = p.grade || "C";
          // í˜„ì¬ ë„ê° ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸°
          if (!tUser.dex[pidStr]) {
            tUser.dex[pidStr] = {
  seen: 0, 
  caught: 0, 
  maxGrade: "F"};
          }
          var currentDex = tUser.dex[pidStr];
          var currentDexGrade = currentDex.maxGrade || "F";
          // ì ìˆ˜ ë¹„êµ (ê°€ë°© ë“±ê¸‰ > ë„ê° ë“±ê¸‰ ì´ë©´ ê°±ì‹ )
          var currentScore = rankScore[currentDexGrade] || 0;
          var newScore = rankScore[pGrade] || 0;
          if (newScore > currentScore) {
            currentDex.maxGrade = pGrade;
            // ì¡ì€ íšŸìˆ˜ê°€ 0ì´ë©´ 1ë¡œ ë³´ì •
            if ((currentDex.caught || 0) < 1) 
              currentDex.caught = 1;
            updateCount++;
          }
          if (p.shiny) {
            currentDex.hasShiny = true;
          }
        }
        commitSave(true);
        replier.reply("âœ… " + foundName + "ë‹˜ì˜ ë„ê° ë™ê¸°í™” ì™„ë£Œ!\n(ê°±ì‹ ëœ í•­ëª©: " + updateCount + "ê°œ)\nğŸ‘‰ ì´ì œ '/ë„ê°'ì„ í™•ì¸í•´ë³´ì„¸ìš”!");
        return;
      }
      if (sub === "ê³µì§€") {
        var text = msg.replace("/ê´€ë¦¬ì ê³µì§€", "").trim();
        addAdminLog(d, sender, "ê³µì§€: " + text);
        commitSave(true);
        replier.reply("ğŸ“¢ [ê³µì§€ì‚¬í•­]\n\n" + text);
        return;
      }
      if (sub === "ì €ì¥") {
        saveData(d);
        replier.reply("ğŸ’¾ ì €ì¥ ì™„ë£Œ");
        return;
      }
      if (sub === "ë°ì´í„°ì •ë¦¬") {
        var res = manageInactiveUsers(d);
        replier.reply(res);
        return;
      }
      if (sub === "ì±”í”¼ì–¸ë¦¬ì…‹") {
        // ì±”í”¼ì–¸ ë°ì´í„°ë¥¼ ì•„ì˜ˆ ë‚ ë ¤ì„œ NPCë¡œ ë˜ëŒë¦¼
        delete d.champion;
        commitSave(true);
        replier.reply("ğŸ‘‘ ì±”í”¼ì–¸ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.\ní˜„ì¬ ì±”í”¼ì–¸: ë ˆë“œ(NPC)");
        return;
      }
      
      if (sub === "ì„ ë°œëŒ€ì´ˆê¸°í™”") {
        var fixedCount = 0;
        var userCount = 0;
        
        for (var name in d.users) {
          var uTarget = d.users[name];
          userCount++;
          
          // [í•µì‹¬ ìˆ˜ì •] ìœ ì € ë°ì´í„°ì— ì €ì¥ëœ ì„ ë°œëŒ€ ëª…ë‹¨(ë°°ì—´) ìì²´ë¥¼ ë¹„ì›ë‹ˆë‹¤.
          uTarget.champTeam = []; 
          uTarget.gymTeam = [];
          
          if (uTarget.pokemons) {
            for (var i = 0; i < uTarget.pokemons.length; i++) {
              var p = uTarget.pokemons[i];
              // í¬ì¼“ëª¬ì—ê²Œ ì§ì ‘ ë¶™ì–´ìˆëŠ” ëª¨ë“  ì ê¸ˆ í”Œë˜ê·¸ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.
              if (p.isChampionMember || p.isLeague || p.isExploring || p.busy) {
                delete p.isChampionMember;
                delete p.isLeague;
                delete p.isExploring;
                delete p.busy;
                fixedCount++;
              }
            }
          }
        }
        
        commitSave(true); // ë³€ê²½ëœ ëª…ë‹¨ê³¼ í”Œë˜ê·¸ë¥¼ íŒŒì¼ì— ì¦‰ì‹œ ì €ì¥
        replier.reply("âœ… [ë°ì´í„° í´ë¦°ì—… ì™„ë£Œ]\n- ëŒ€ìƒ ìœ ì €: " + userCount + "ëª…\n- í•´ì œëœ í¬ì¼“ëª¬: " + fixedCount + "ë§ˆë¦¬\n- ëª¨ë“  ì„ ë°œëŒ€ ëª…ë‹¨(champTeam/gymTeam)ì„ ì´ˆê¸°í™”í–ˆìŠµë‹ˆë‹¤.\nì´ì œ ë§ë‚˜ë‡½ì„ ë‹¤ì‹œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!");
        return;
      }

      
      if (sub === "ê³„ì •ì´ë™") {
        var oldName = parts[2];
        var newName = parts[3];
        if (!d.users[oldName]) {
          replier.reply("êµ¬ ë‹‰ë„¤ì„ ë°ì´í„° ì—†ìŒ");
          return;
        }
        d.users[newName] = JSON.parse(JSON.stringify(d.users[oldName]));
        delete d.users[oldName];
        commitSave(true);
        replier.reply("âœ… ê³„ì • ì´ë™ ì™„ë£Œ: " + oldName + " -> " + newName);
        return;
      }
      if (sub === "ì „ì ì´ˆê¸°í™”") {
        var target = parts[2];
        if (target) {
          var t = getUserByName(d, target);
          if (t) {
            resetBattleStats(t.user);
            replier.reply(t.name + " ì „ì  ì´ˆê¸°í™” ì™„ë£Œ");
          }
        } else {
          var n = resetBattleStatsAll(d);
          replier.reply("ì „ì²´ ìœ ì €(" + n + "ëª…) ì „ì  ì´ˆê¸°í™” ì™„ë£Œ");
        }
        commitSave(true);
        return;
      }
      if (sub === "ì‹œì¦Œë§ˆê°") {
        ensureConfig(d);
        // ì‹œì¦Œ ì¹´ìš´íŠ¸ ë³€ìˆ˜ (ì—†ìœ¼ë©´ 1ë¶€í„° ì‹œì‘)
        if (typeof d.config.seasonCount !== "number") 
          d.config.seasonCount = 1;
        var list = rankTopList(d);
        if (list.length === 0) {
          replier.reply("âš ï¸ ë°°í‹€ ê¸°ë¡ì´ ì—†ì–´ ì‹œì¦Œì„ ë§ˆê°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }
        var currentSeason = d.config.seasonCount;
        var report = "ğŸ† [ì œ " + currentSeason + "íšŒ ì‹œì¦Œ ì¢…ë£Œ!]\në³´ìƒ ì§€ê¸‰ ê²°ê³¼ ë³´ê³ \nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\n";
        var count = 0;
        // 2. ìˆœìœ„ë³„ ë³´ìƒ ì§€ê¸‰ Loop
        for (var i = 0; i < list.length; i++) {
          var rankInfo = list[i];
          var rank = i + 1;
          var tUser = d.users[rankInfo.name];
          if (!tUser) 
            continue;
          normalizeUserData(tUser);
          var rewardMsg = "";
          // ğŸ¥‡ 1ìœ„ ë³´ìƒ
          if (rank === 1) {
            if (tUser.titles.indexOf("ì‹œì¦Œ íŒ¨ì™•") === -1) 
              tUser.titles.push("ì‹œì¦Œ íŒ¨ì™•");
            tUser.godBall = (tUser.godBall || 0) + 1;
            tUser.dakotaCoin = (tUser.dakotaCoin || 0) + 3000;
            tUser.cookie = (tUser.cookie || 0) + 5;
            rewardMsg = "ğŸ¥‡ [1ìœ„] ì¹­í˜¸+í‚¹ê°“ë³¼+3000ì½”ì¸+ì¿ í‚¤5";
          } else if (rank <= 3) {
            tUser.dakotaCoin = (tUser.dakotaCoin || 0) + 1500;
            tUser.cookie = (tUser.cookie || 0) + 3;
            if (!tUser.items) 
              tUser.items = {};
            tUser.items["ì¥ë¹„ìƒì"] = (tUser.items["ì¥ë¹„ìƒì"] || 0) + 5;
            rewardMsg = "ğŸ¥ˆ [TOP 3] 1500ì½”ì¸+ì¿ í‚¤3+ìƒì5";
          } else if (rank <= 10) {
            tUser.dakotaCoin = (tUser.dakotaCoin || 0) + 500;
            tUser.dopaTicket += 10;
            rewardMsg = "ğŸ¥‰ [TOP 10] 500ì½”ì¸+ë„íŒŒë¯¼10";
          } else if (rankInfo.w > 0) {
            tUser.gold += 1000000;
            rewardMsg = "ğŸ–ï¸ [ì°¸ê°€ìƒ] 100ë§Œ ê³¨ë“œ";
          }
          if (rank <= 10) {
            report += rank + "ìœ„ " + rankInfo.name + " â” " + rewardMsg + "\n";
          }
          count++;
        }
        // 3. ì „ì  ì´ˆê¸°í™” ë° ì‹œì¦Œ ì¹´ìš´íŠ¸ ì¦ê°€
        resetBattleStatsAll(d);
        // â˜… ë‹¤ìŒ ì‹œì¦Œ ë²ˆí˜¸ë¡œ ì¦ê°€
        d.config.seasonCount++;
        commitSave(true);
        replier.reply(report + "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + "ğŸ“¢ ì´ " + count + "ëª…ì—ê²Œ ë³´ìƒì´ ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤.\n" + "ğŸ§¹ ì „ì  ì´ˆê¸°í™” ì™„ë£Œ!\n\n" + "âš”ï¸ [ì œ " + d.config.seasonCount + "íšŒ ë°°í‹€ ì‹œì¦Œ]ì´ ì§€ê¸ˆë¶€í„° ì‹œì‘ë©ë‹ˆë‹¤!\n" + "ìƒˆë¡œìš´ ì „ì„¤ì— ë„ì „í•˜ì„¸ìš”!");
        return;
      }
      if (sub === "ì¬ë°œê¸‰" || sub === "UIDì´ˆê¸°í™”") {
        var tName = parts[2];
        var t = getUserByName(d, tName);
        if (!t) {
          replier.reply("ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }
        var arr = t.user.pokemons;
        // 1ë²ˆë¶€í„° ìˆœì„œëŒ€ë¡œ ë²ˆí˜¸ ë‹¤ì‹œ ë§¤ê¸°ê¸°
        for (var i = 0; i < arr.length; i++) {
          arr[i].uid = i + 1;
        }
        // ë‹¤ìŒ ì¡ì„ í¬ì¼“ëª¬ ë²ˆí˜¸ë„ ê°±ì‹ 
        t.user.nextPokeUid = arr.length + 1;
        commitSave(true);
        replier.reply("âœ… " + tName + "ë‹˜ì˜ í¬ì¼“ëª¬ UIDë¥¼ ì „ë¶€ ì¬ë°œê¸‰í–ˆìŠµë‹ˆë‹¤.\n(ì´ " + arr.length + "ë§ˆë¦¬ ì •ë¦¬ ì™„ë£Œ)\nì´ì œ ì¤‘ë³µ ë²ˆí˜¸ ì˜¤ë¥˜ê°€ í•´ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.");
        return;
      }
      if (sub === "ì¡°íšŒ") {
        var t = getUserByName(d, parts[2]);
        if (!t) {
          replier.reply("ìœ ì € ì—†ìŒ");
          return;
        }
        var uInfo = t.user;
        replier.reply("ğŸ” " + t.name + "\nê³¨ë“œ: " + fmtNum(uInfo.gold) + "\në„íŒŒë¯¼: " + uInfo.dopaTicket + "\ní¬ì¼“ëª¬: " + uInfo.pokemons.length);
        return;
      }
      if (sub === "ì „ì—­ì¡°íšŒ") {
        replier.reply(globalConfigText(d));
        return;
      }
      if (sub === "ì „ì—­ì„¤ì •") {
        var key = parts[2];
        var val = parseInt(parts[3], 10);
        if (key && key.indexOf("SHOP_PRICE") !== -1) {
          if (key === "SHOP_PRICE_BALL") 
            setShopPrice(d, "BALL", val);
          else if (key === "SHOP_PRICE_SUPER") 
            setShopPrice(d, "SUPER", val);
          else if (key === "SHOP_PRICE_ULTRA") 
            setShopPrice(d, "ULTRA", val);
          else if (key === "SHOP_PRICE_DOPA") 
            setShopPrice(d, "DOPA", val);
          else {
            replier.reply("ì•Œ ìˆ˜ ì—†ëŠ” í‚¤");
            return;
          }
        }
        commitSave(true);
        replier.reply("âœ… ì„¤ì • ì™„ë£Œ: " + key + " = " + val);
        return;
      }
      replier.reply("ì•Œ ìˆ˜ ì—†ëŠ” ëª…ë ¹ì–´ì…ë‹ˆë‹¤. '/ê´€ë¦¬ì ë„ì›€'ì„ í™•ì¸í•˜ì„¸ìš”.");
      return;
    }
    if (!d.users[sender]) {
      var archivePath = "/sdcard/mbot_pokemon_archive.json";
      var file = new java.io.File(archivePath);      // íŒŒì¼ ê°ì²´ ìƒì„±
      // [í•µì‹¬ ìˆ˜ì •] íŒŒì¼ì´ ìˆì„ ë•Œë§Œ ì½ê¸° ì‹œë„
      if (file.exists()) {
        var archiveStr = File.read(archivePath);
        if (archiveStr) {
          try {
            var archive = JSON.parse(archiveStr);
            if (archive[sender]) {
              // ë³µêµ¬ ì§„í–‰
              d.users[sender] = archive[sender];
              d.users[sender].lastDate = new Date().getTime();
              delete archive[sender];
              File.save(archivePath, JSON.stringify(archive));              // êº¼ëƒˆìœ¼ë‹ˆ íŒŒì¼ ê°±ì‹ 
              commitSave(true);
              replier.reply("ğŸ“¦ íœ´ë©´ ê³„ì •ì´ì—ˆë˜ " + sender + "ë‹˜ì˜ ë°ì´í„°ë¥¼ ë³µêµ¬í–ˆìŠµë‹ˆë‹¤!\në‹¤ì‹œ ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤! ğŸ‰");
            }
          }          catch (e) {
  /* íŒŒì‹± ì—ëŸ¬ ë¬´ì‹œ */

}
        }
      }
    }
    if (msg === "/íšŒì›ê°€ì…") {
      if (ensureUser(d, sender)) {
        commitSave(true);
        replier.reply("íšŒì›ê°€ì… ì™„ë£Œ!\n/í•„ë“œ ë¡œ í¬ì¼“ëª¬ì„ ë§Œë‚˜ë³´ì„¸ìš”.");
      } else {
        replier.reply("ì´ë¯¸ íšŒì›ì…ë‹ˆë‹¤.");
      }
      return;
    }
    var u = d.users[sender];
    if (!u) {
      replier.reply("ë¨¼ì € /íšŒì›ê°€ì… ì„ í•´ì£¼ì„¸ìš”.");
      return;
    }
    normalizeUserData(u);
    // â˜… ì—¬ê¸°ì— dë¥¼ ì¶”ê°€í•´ì„œ í•¨ìˆ˜ì— ë„˜ê²¨ì¤ë‹ˆë‹¤!
    var decoName = getDecoratedName(d, u, sender);
    // âœ… ì‹ ê·œ íšŒì›ê°€ì… ë³´ìƒ (ë”± 1íšŒ)
    var joinMsg = grantSignupBonusIfNeeded(u, sender);
    if (joinMsg) {
      replier.reply(joinMsg);
      commitSave(true);
    }
    if (msg === "/ë‚´ì •ë³´") {
      ensureUserStats(u);
      // 1. ë§Œë ™ ì²´í¬ (150ë ™ ì´ìƒ ì‹œ 0% ë° ë¹ˆ ê²Œì´ì§€)
      var isMaxLv = (u.trainerLv >= MAX_LV);
      var need = expNeed(u.trainerLv);
      var cur = u.trainerExp;
      var pctExp = "";
      var bar = "";
      var expString = "";
      if (isMaxLv) {
        pctExp = "0%";
        for (var i = 0; i < 10; i++) 
          bar += "â–¡";          // ë¹ˆ ì¹¸ 10ê°œ
        expString = "0 / 0 EXP (MAX)";
      } else {
        pctExp = (need <= 0) ? "0" : (Math.floor((cur / need) * 1000) / 10);
        pctExp += "%";
        var barN = 10;
        var filled = Math.max(0, Math.min(barN, Math.floor((cur / need) * barN)));
        for (var i = 0; i < barN; i++) 
          bar += (i < filled ? "â– " : "â–¡");
        expString = cur + "/" + need + " EXP";
      }
      // 2. ë°°í‹€ í”¼ë¡œë„ í˜„í™© ê³„ì‚°
      var today = dateKeyKST();
      var battleStatus = "";
      var DAILY_LIMIT = 100;
      var currentCount = u.dailyBattleCount || 0;
      var remainCount = Math.max(0, DAILY_LIMIT - currentCount);
      if (u.lastBattleResetDate !== today) {
        battleStatus = "â›” ì¶œì„ í•„ìš” (0íšŒ ì¶©ì „ë¨)";
      } else if (currentCount >= DAILY_LIMIT) {
        battleStatus = "ğŸ’¤ í”¼ë¡œë„ MAX (ë³´ìƒ ì—†ìŒ)";
      } else {
        battleStatus = "âš”ï¸ " + currentCount + " / " + DAILY_LIMIT + " (ë‚¨ì€ íšŸìˆ˜: " + remainCount + "íšŒ)";
      }
      // 3. ë„ê° ìˆ˜ì§‘ë¥ 
      ensureUserDex(u);
      var uniqueCaught = 0;
      for (var i = 0; i < POKEMON_DB.length; i++) {
        var pid = String(POKEMON_DB[i].id);
        var rec = u.dex[pid] || {
  seen: 0, 
  caught: 0};
        if (rec.caught > 0) 
          uniqueCaught++;
      }
      var dexRate = (POKEMON_DB.length === 0) ? 0 : Math.floor((uniqueCaught / POKEMON_DB.length) * 1000) / 10;
      // 4. ë°°ì§€ ë° ì „ì 
      var badgesStr = "";
      if (!u.badges) 
        u.badges = [];
      for (var k = 0; k < GYM_LEADERS.length; k++) {
        var g = GYM_LEADERS[k];
        if (u.badges.indexOf(g.badge) !== -1) 
          badgesStr += g.badge + " ";
      }
      if (badgesStr === "") 
        badgesStr = "(ì—†ìŒ)";
      var w = u.stats.battleWin, l = u.stats.battleLose, d0 = u.stats.battleDraw;
      var total = w + l + d0;
      var winRate = (total === 0) ? 0 : Math.floor((w / total) * 1000) / 10;
      // 5. ìµœì¢… ë©”ì‹œì§€ ì¡°í•©
      var out = "";
      out += "ğŸ‘¤ " + decoName + "ë‹˜ì˜ íŠ¸ë ˆì´ë„ˆ ì •ë³´\n\n";
      out += "Lv." + u.trainerLv + " (" + pctExp + ")\n";
      out += bar + "  " + expString + "\n\n";
      out += "[ë³´ìœ  ì¬í™”]\n";
      out += "ğŸ’° ê³¨ë“œ: " + fmtNum(u.gold) + "ğŸ’°\n";
      out += "ğŸª™ ë‹¤ì½”íƒ€ ì½”ì¸: " + fmtNum(u.dakotaCoin || 0) + "ê°œ\n\n";
      out += "[ì˜¤ëŠ˜ì˜ ë°°í‹€]\n";
      out += battleStatus + "\n\n";
      out += "ğŸ–ï¸ ë°°ì§€: " + badgesStr + "\n\n";
      out += "ğŸ¾ ì»¬ë ‰ì…˜\n";
      out += "ë³´ìœ  í¬ì¼“ëª¬: " + u.pokemons.length + "ë§ˆë¦¬\n";
      out += "ë„ê°: " + uniqueCaught + "/" + POKEMON_DB.length + " (" + dexRate + "%)\n\n";
      out += "âš”ï¸ ë°°í‹€\n";
      out += "ì „ì : " + w + "ìŠ¹ " + l + "íŒ¨" + (d0 > 0 ? (" " + d0 + "ë¬´") : "") + "\n";
      out += "ìŠ¹ë¥ : " + winRate + "% | ì—°ìŠ¹: " + u.stats.battleStreak + " | ë­í‚¹ì ìˆ˜: " + battleScoreRank(u);
      replier.reply(out);
      commitSave(false);
      return;
    }
    if (msg === "/ë‚´ì§€ê°‘" || msg === "/ì§€ê°‘" || msg === "/ëˆ") {
      var coin = u.dakotaCoin || 0;
      replier.reply("ğŸ‘› " + decoName + "ë‹˜ì˜ ì§€ê°‘\n" + "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + "ğŸ’° ê³¨ë“œ : " + fmtNum(u.gold) + "ğŸ’°\n" + "ğŸª™ ë‹¤ì½”íƒ€ ì½”ì¸ : " + fmtNum(coin) + "ê°œ\n" + "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + "ğŸ’¡ ì½”ì¸ì€ ë ˆì´ë“œ ë³´ìƒìœ¼ë¡œ íšë“ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
      return;
    }
    if (msg.indexOf("/ì •ë³´") === 0) {
      var t = getTargetFromMsg(d, sender, msg, "/ì •ë³´");
      if (!t) {
        replier.reply("í•´ë‹¹ ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      var target = t.user;
      var targetName = t.name;
      ensureUserStats(target);
      ensureUserDex(target);
      // ë§Œë ™ ì²´í¬
      var isMaxLv = (target.trainerLv >= MAX_LV);
      var need = expNeed(target.trainerLv);
      var cur = target.trainerExp;
      var pctExp = "";
      var bar = "";
      var expString = "";
      if (isMaxLv) {
        // â˜… [ìˆ˜ì •] ë§Œë ™ì´ë©´ 0%ë¡œ ê³ ì •í•˜ê³  ê²Œì´ì§€ ë¹„ì›€
        pctExp = "0%";
        for (var i = 0; i < 10; i++) 
          bar += "â–¡";          // ë¹ˆ ì¹¸
        expString = "0 / 0 EXP (MAX)";
      } else {
        // ë§Œë ™ ì•„ë‹ˆë©´ ì •ìƒ ê³„ì‚°
        pctExp = (need <= 0) ? "0" : (Math.floor((cur / need) * 1000) / 10);
        pctExp += "%";
        var barN = 10;
        var filled = Math.max(0, Math.min(barN, Math.floor((cur / need) * barN)));
        for (var i = 0; i < barN; i++) 
          bar += (i < filled ? "â– " : "â–¡");
        expString = cur + "/" + need + " EXP";
      }
      // ì „ì 
      var w = target.stats.battleWin, l = target.stats.battleLose, d0 = target.stats.battleDraw;
      var total = w + l + d0;
      var winRate = (total === 0) ? 0 : Math.floor((w / total) * 1000) / 10;
      // ë„ê°
      var uniqueCaught = 0;
      for (var j = 0; j < POKEMON_DB.length; j++) {
        var pid = String(POKEMON_DB[j].id);
        var rec = target.dex[pid] || {
  seen: 0, 
  caught: 0};
        if (rec.caught > 0) 
          uniqueCaught++;
      }
      var dexRate = (POKEMON_DB.length === 0) ? 0 : Math.floor((uniqueCaught / POKEMON_DB.length) * 1000) / 10;
      // ë°°ì§€ ëª©ë¡ ìƒì„±
      var badgesStr = "";
      if (!target.badges) 
        target.badges = [];
      for (var k = 0; k < GYM_LEADERS.length; k++) {
        var g = GYM_LEADERS[k];
        if (target.badges.indexOf(g.badge) !== -1) 
          badgesStr += g.badge + " ";
      }
      if (badgesStr === "") 
        badgesStr = "(ì—†ìŒ)";
      var out = "";
      out += "ğŸ‘¤ " + targetName + "ë‹˜ì˜ íŠ¸ë ˆì´ë„ˆ ì •ë³´\n\n";
      out += "Lv." + target.trainerLv + " (" + pctExp + ")\n";
      out += bar + "  " + expString + "\n\n";
      out += "ğŸ’° ê³¨ë“œ: " + fmtNum(target.gold) + "ğŸ’°\n";
      out += "ğŸª™ ì½”ì¸: " + fmtNum(target.dakotaCoin || 0) + "ê°œ\n";
      out += "ğŸ–ï¸ ë°°ì§€: " + badgesStr + "\n\n";
      out += "ğŸ¾ ì»¬ë ‰ì…˜\n";
      out += "ë³´ìœ  í¬ì¼“ëª¬: " + (target.pokemons ? target.pokemons.length : 0) + "ë§ˆë¦¬\n";
      out += "ë„ê°: " + uniqueCaught + "/" + POKEMON_DB.length + " (" + dexRate + "%)\n\n";
      out += "âš”ï¸ ë°°í‹€\n";
      out += "ì „ì : " + w + "ìŠ¹ " + l + "íŒ¨" + (d0 > 0 ? (" " + d0 + "ë¬´") : "") + "\n";
      out += "ìŠ¹ë¥ : " + winRate + "% | ì—°ìŠ¹: " + target.stats.battleStreak + " | ë­í‚¹ì ìˆ˜: " + battleScoreRank(target);
      replier.reply(out);
      commitSave(false);
      return;
    }
    if (msg === "/ë‚´ê°€ë°©") {
      var list = "";
      list += "ğŸ”´ ëª¬ìŠ¤í„°ë³¼: " + fmtNum(u.ball) + "ê°œ\n";
      list += "ğŸ”µ ìŠˆí¼ë³¼: " + fmtNum(u.superBall) + "ê°œ\n";
      list += "âš« í•˜ì´í¼ë³¼: " + fmtNum(u.ultraBall) + "ê°œ\n";
      list += "ğŸ‘‘ í‚¹ê°“ë³¼: " + fmtNum(u.godBall || 0) + "ê°œ\n";
      list += "ğŸ’³ ë„íŒŒë¯¼ê°•í™”ê¶Œ: " + fmtNum(u.dopaTicket) + "ì¥\n";
      list += "ğŸª ë‘ì«€ì¿ (í™•ì •ê°•í™”): " + fmtNum(u.cookie) + "ê°œ\n";
      list += "ğŸ« ì´ë™í‹°ì¼“: " + fmtNum(u.ticket) + "ì¥\n";
      list += "ğŸ”„ í‹°ì–´ë¦¬ì…‹ê¶Œ: " + fmtNum(u.reroll) + "ì¥";
      // [ì‹ ê·œ] ë‹¤ì½”íƒ€ ì•„ì´í…œ ëª©ë¡
      var dakotaList = [];
      var specialItems = ["ì¥ë¹„ìƒì", "ìƒìíŒŒí¸", "ë”¸ê¸°ì¿ í‚¤", "í™©ê¸ˆì—´ë§¤", "í™©ê¸ˆí˜ì¸íŠ¸"];
      if (!u.items) 
        u.items = {};
      if ((u.items["ì¥ë¹„ìƒì"] || 0) > 0) 
        dakotaList.push("ğŸ“¦ ì¥ë¹„ìƒì: " + u.items["ì¥ë¹„ìƒì"] + "ê°œ");
      if ((u.items["ìƒìíŒŒí¸"] || 0) > 0) 
        dakotaList.push("ğŸ§© ìƒìíŒŒí¸: " + u.items["ìƒìíŒŒí¸"] + "ê°œ (10ê°œ ëª¨ìœ¼ë©´ ìƒì!)");
      if ((u.items["ë”¸ê¸°ì¿ í‚¤"] || 0) > 0) 
        dakotaList.push("ğŸ“ ë”¸ê¸°ì¿ í‚¤: " + u.items["ë”¸ê¸°ì¿ í‚¤"] + "ê°œ (+3ê°•)");
      if ((u.items["í™©ê¸ˆì—´ë§¤"] || 0) > 0) 
        dakotaList.push("ğŸ¥œ í™©ê¸ˆì—´ë§¤: " + u.items["í™©ê¸ˆì—´ë§¤"] + "ê°œ (ì ì¬ë ¥MAX)");
      if ((u.items["í™©ê¸ˆí˜ì¸íŠ¸"] || 0) > 0) 
        dakotaList.push("ğŸ¨ í™©ê¸ˆí˜ì¸íŠ¸: " + u.items["í™©ê¸ˆí˜ì¸íŠ¸"] + "ê°œ (ì´ë¡œì¹˜)");
      if (dakotaList.length > 0) {
        list += "\n\n[ë‹¤ì½”íƒ€ ë³´ê´€í•¨]\n" + dakotaList.join("\n");
      }
      var equipList = [];
      // ì •ë ¬ì„ ìœ„í•´ í‹°ì–´ë³„ë¡œ ë¶„ë¦¬
      var t4 = [], t3 = [], t2 = [], t1 = [];
      for (var key in u.items) {
        if (specialItems.indexOf(key) !== -1) 
          continue;
        if (u.items[key] <= 0) 
          continue;
        var item = EQUIP_DB[key];
        if (!item) 
          continue;
        var icon = item.icon || "ğŸ›¡ï¸";
        var dName = key;
        var count = u.items[key];
        var tier = item.tier || 1;
        var displayStr = "";
        // â˜… [í•µì‹¬] í‹°ì–´ë³„ ê°•ì¡° íš¨ê³¼
        if (tier === 4) {
          dName = "ğŸ‘‘ã€" + dName + "ã€ğŸ‘‘";          // 4í‹°ì–´: ì™•ê´€ + ê´„í˜¸
          displayStr = icon + " " + dName + ": " + count + "ê°œ";
          t4.push(displayStr);
        } else if (tier === 3) {
          dName = "ã€" + dName + "ã€";          // 3í‹°ì–´: ê´„í˜¸
          displayStr = icon + " " + dName + ": " + count + "ê°œ";
          t3.push(displayStr);
        } else if (tier === 2) {
          displayStr = icon + " " + dName + ": " + count + "ê°œ";
          t2.push(displayStr);
        } else {
          displayStr = icon + " " + dName + ": " + count + "ê°œ";
          t1.push(displayStr);
        }
      }
      var allEquips = t4.concat(t3, t2, t1);      // ë†’ì€ í‹°ì–´ë¶€í„° ì •ë ¬
      if (allEquips.length > 0) {
        list += "\n\n[ì¥ë¹„ ë³´ê´€í•¨]\n" + allEquips.join("\n");
      } else {
        list += "\n\n[ì¥ë¹„ ë³´ê´€í•¨]\n(ë¹„ì–´ìˆìŒ)";
      }
      replier.reply("ğŸ’ " + sender + "ë‹˜ì˜ ê°€ë°©\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + list);
      return;
    }
// ğŸ [ì•„ì´í…œ ì‚¬ìš© í†µí•© ì‹œìŠ¤í…œ] (ì˜¤ë¥˜ ì™„ë²½ í•´ê²° ë° ë¦¬ëª¨ë¸ë§)
if (msg.indexOf("/ì‚¬ìš©") === 0) {
  var parts = msg.split(" ").filter(Boolean);
  var itemCmd = parts[1];
  
  if (!itemCmd) {
    replier.reply("ğŸ“ [ì•„ì´í…œ ì‚¬ìš© ê°€ì´ë“œ]\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ“¦ ìƒì: /ì‚¬ìš© ìƒì [ìˆ˜ëŸ‰]\nğŸ« í‹°ì¼“: /ì‚¬ìš© í‹°ì¼“ [ì§€ì—­ëª…]\nğŸ’¨ ìŠ¤í”„ë ˆì´: /ì‚¬ìš© ìŠ¤í”„ë ˆì´\n\nğŸ§¬ í¬ì¼“ëª¬ ëŒ€ìƒ ì•„ì´í…œ\n- /ì‚¬ìš© [ì•„ì´í…œ] [ë³„ëª…/UID] [ìˆ˜ëŸ‰]\n(ë”¸ê¸°, ì¿ í‚¤, í‘¸ë”©, ì—´ë§¤, í˜ì¸íŠ¸, ë¦¬ì…‹)");
    return;
  }

  // -----------------------------------------------------------
  // [A] ë¹„ëŒ€ìƒí˜• ì•„ì´í…œ (ìƒì, ìŠ¤í”„ë ˆì´, ì´ë™í‹°ì¼“)
  // -----------------------------------------------------------
  
  // 1. ì¥ë¹„ìƒì ê°œë´‰
  if (itemCmd === "ìƒì" || itemCmd === "ë³´ë¬¼ìƒì" || itemCmd === "ì¥ë¹„ìƒì") {
    var qty = Math.max(1, Math.min(100, parseInt(parts[2], 10) || 1));
    if (!u.items || !u.items["ì¥ë¹„ìƒì"] || u.items["ì¥ë¹„ìƒì"] < qty) {
      replier.reply("ğŸ 'ì¥ë¹„ìƒì'ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.\në³´ìœ : " + (u.items ? (u.items["ì¥ë¹„ìƒì"] || 0) : 0) + "ê°œ");
      return;
    }

    u.items["ì¥ë¹„ìƒì"] -= qty;
    var resultLog = ""; var getItems = {}; var fragmentCount = 0;
    var t1 = [], t2 = [], t3 = [], t4 = [];
    for (var k in EQUIP_DB) {
      var item = EQUIP_DB[k]; var tier = item.tier || 1;
      if (tier === 4) t4.push(k); else if (tier === 3) t3.push(k);
      else if (tier === 2) t2.push(k); else t1.push(k);
    }

    for (var i = 0; i < qty; i++) {
      var roll = Math.random(); var picked = ""; var grade = "";
      if (roll < BOX_PROB_TIER_4) { picked = t4[Math.floor(Math.random() * t4.length)]; grade = "ğŸ‘‘[ì „ì„¤]"; }
      else if (roll < (BOX_PROB_TIER_4 + BOX_PROB_TIER_3)) { picked = t3[Math.floor(Math.random() * t3.length)]; grade = "ğŸŒŸ[ìƒê¸‰]"; }
      else if (roll < (BOX_PROB_TIER_4 + BOX_PROB_TIER_3 + BOX_PROB_TIER_2)) { picked = t2[Math.floor(Math.random() * t2.length)]; grade = "ğŸ”¹"; }
      else if (roll < (BOX_PROB_TIER_4 + BOX_PROB_TIER_3 + BOX_PROB_TIER_2 + BOX_PROB_TIER_1)) { picked = t1[Math.floor(Math.random() * t1.length)]; grade = "âšª"; }
      else { fragmentCount++; continue; }
      getItems[picked] = (getItems[picked] || 0) + 1;
      resultLog += grade + " " + picked + "\n";
    }

    for (var key in getItems) { u.items[key] = (u.items[key] || 0) + getItems[key]; }
    var autoBox = 0;
    if (fragmentCount > 0) {
      u.items["ìƒìíŒŒí¸"] = (u.items["ìƒìíŒŒí¸"] || 0) + fragmentCount;
      resultLog += "ğŸ§© ìƒìíŒŒí¸ +" + fragmentCount + "ê°œ\n";
      if (u.items["ìƒìíŒŒí¸"] >= 10) {
        autoBox = Math.floor(u.items["ìƒìíŒŒí¸"] / 10);
        u.items["ìƒìíŒŒí¸"] %= 10;
        u.items["ì¥ë¹„ìƒì"] = (u.items["ì¥ë¹„ìƒì"] || 0) + autoBox;
      }
    }
    commitSave(true);
    var summary = "ğŸ ìƒì " + qty + "ê°œë¥¼ ê°œë´‰í–ˆìŠµë‹ˆë‹¤!\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + (resultLog || "ğŸ§© íŒŒí¸ë§Œ ì”ëœ© ë‚˜ì™”ìŠµë‹ˆë‹¤...\n");
    if (autoBox > 0) summary += "\nâ™»ï¸ íŒŒí¸ 10ê°œë¥¼ ëª¨ì•„ [ì¥ë¹„ìƒì +" + autoBox + "]ê°œë¥¼ í•©ì„±í–ˆìŠµë‹ˆë‹¤!";
    replier.reply(summary);
    return;
  }

  // 2. íƒì‚¬ìŠ¤í”„ë ˆì´
  if (itemCmd === "ìŠ¤í”„ë ˆì´" || itemCmd === "íƒì‚¬ìŠ¤í”„ë ˆì´") {
    if (!u.items || !u.items["íƒì‚¬ìŠ¤í”„ë ˆì´"] || u.items["íƒì‚¬ìŠ¤í”„ë ˆì´"] < 1) {
      replier.reply("ğŸ’¨ 'íƒì‚¬ìŠ¤í”„ë ˆì´'ê°€ ì—†ìŠµë‹ˆë‹¤."); return;
    }
    var now = new Date().getTime();
    u.sprayEndTime = Math.max(now, (u.sprayEndTime || 0)) + (30 * 60 * 1000);
    u.items["íƒì‚¬ìŠ¤í”„ë ˆì´"]--;
    commitSave(true);
    replier.reply("ğŸ’¨ ì¹™-! íƒì‚¬ìŠ¤í”„ë ˆì´ë¥¼ ë¿Œë ¸ìŠµë‹ˆë‹¤.\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\nâ³ íš¨ê³¼: 30ë¶„ê°„ í•„ë“œ íƒìƒ‰ ì¿¨íƒ€ì„ì´ 50% ë‹¨ì¶•ë©ë‹ˆë‹¤.\nğŸƒ í˜„ì¬ ì¿¨íƒ€ì„: [5ì´ˆ] (ì ìš© ì¤‘!)");
    return;
  }

  // 3. ì´ë™ í‹°ì¼“
  if (itemCmd === "ì´ë™" || itemCmd === "í‹°ì¼“") {
    var regionName = parts[2];
    var curWorld = u.world || "íŒŒì•¼ë ˆë°”"; 
    var currentWorldData = WORLD_REGIONS[curWorld];
    
    if (!currentWorldData) { replier.reply("ğŸš« í˜„ì¬ ë§ˆì„(" + curWorld + ")ì˜ í•„ë“œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
    var validRegions = currentWorldData.map(function(r) { return r.key; });
    
    if (!regionName || validRegions.indexOf(regionName) === -1) {
      replier.reply("ğŸš« í˜„ì¬ ìœ„ì¹˜(" + curWorld + ")ì—ì„œ ê°ˆ ìˆ˜ ì—†ëŠ” ì§€ì—­ì…ë‹ˆë‹¤.\nğŸ« ê°€ëŠ¥ ì§€ì—­: " + validRegions.join(", ")); return;
    }
    if (!u.ticket || u.ticket <= 0) { replier.reply("ğŸ« ì´ë™í‹°ì¼“ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
    
    u.ticket--; 
    u.nextFieldRegion = regionName;
    commitSave(true);
    replier.reply("ğŸ« í‹°ì¼“ ì‚¬ìš© ì™„ë£Œ! ë‹¤ìŒ '/í•„ë“œ' íƒìƒ‰ ì‹œ " + curWorld + "ì˜ [" + regionName + "] ì§€ì—­ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
    return;
  }

  // -----------------------------------------------------------
  // [B] ëŒ€ìƒí˜• ì†Œë¹„ ì•„ì´í…œ (í¬ì¼“ëª¬ ìŠ¤í™ ì—…)
  // -----------------------------------------------------------
  var pInput = parts[2] ? parts[2].replace("#", "") : null;
  if (!pInput) { replier.reply("ğŸš« ëŒ€ìƒì„ ì§€ì •í•´ì£¼ì„¸ìš”.\nì‚¬ìš©ë²•: /ì‚¬ìš© [ì•„ì´í…œ] [ë³„ëª…/UID] [ìˆ˜ëŸ‰]"); return; }

  var amount = parseInt(parts[3] || "1", 10);
  if (isNaN(amount) || amount <= 0) { replier.reply("ğŸš« ìˆ˜ëŸ‰ì€ 1 ì´ìƒì˜ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤."); return; }

  var p = findPokemonByAny(u, pInput);
  if (!p) { replier.reply("ğŸš« [" + pInput + "] í¬ì¼“ëª¬ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
  if (isPokemonBusy(u, p.uid)) { replier.reply("ğŸš« íƒí—˜/ì„ë¬´ ì¤‘ì¸ í¬ì¼“ëª¬ì€ ì•„ì´í…œì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }

  // ì•„ì´í…œ ì´ë¦„ ë§¤ì¹­
  var itemKey = "";
  if (["ë‘ì«€ì¿ ", "ì¿ í‚¤"].indexOf(itemCmd) !== -1) itemKey = "ë‘ì«€ì¿ ";
  else if (["ë”¸ê¸°ì¿ í‚¤", "ë”¸ê¸°", "ë”¸ì«€ì¿ "].indexOf(itemCmd) !== -1) itemKey = "ë”¸ê¸°ì¿ í‚¤";
  else if (["í™©ê¸ˆì—´ë§¤", "ì—´ë§¤", "ë¼ì¦ˆì—´ë§¤"].indexOf(itemCmd) !== -1) itemKey = "í™©ê¸ˆì—´ë§¤";
  else if (["ë„íŒŒë¯¼", "ê°•í™”ê¶Œ"].indexOf(itemCmd) !== -1) itemKey = "ë„íŒŒë¯¼ê°•í™”ê¶Œ";
  else if (["í‹°ì–´ë¦¬ì…‹", "ë¦¬ì…‹"].indexOf(itemCmd) !== -1) itemKey = "í‹°ì–´ë¦¬ì…‹ê¶Œ";
  else if (["í™©ê¸ˆí˜ì¸íŠ¸", "í˜ì¸íŠ¸", "ì´ë¡œì¹˜"].indexOf(itemCmd) !== -1) itemKey = "í™©ê¸ˆí˜ì¸íŠ¸";
  else itemKey = itemCmd; 

  // ì¬í™” ì²´í¬
  var hasEnough = false;
  if (itemKey === "ë‘ì«€ì¿ ") { hasEnough = (u.cookie >= amount); }
  else if (itemKey === "ë„íŒŒë¯¼ê°•í™”ê¶Œ") { hasEnough = (u.dopaTicket >= amount); }
  else if (itemKey === "í‹°ì–´ë¦¬ì…‹ê¶Œ") { hasEnough = (u.reroll >= amount); }
  else { if (u.items && u.items[itemKey] >= amount) hasEnough = true; }

  if (!hasEnough) { replier.reply("ğŸš« [" + itemKey + "] ì•„ì´í…œì´ ë¶€ì¡±í•©ë‹ˆë‹¤.\n(ë³´ìœ ëŸ‰ í™•ì¸: /ê°€ë°©)"); return; }

  var pName = getDisplayName(p);
  var resultLog = "";

  // ì•„ì´í…œ íš¨ê³¼ ì ìš© (ì—ëŸ¬ ì™„ë²½ ì°¨ë‹¨ ë¡œì§)
  if (itemKey === "ë‘ì«€ì¿ ") {
    var oldEnh = p.enh || 0;
    p.enh = oldEnh + amount;
    u.cookie -= amount;
    if (typeof tryAutoEvolveByEnh === "function") tryAutoEvolveByEnh(p);
    resultLog = "ğŸ’ª ê°•í™” ìˆ˜ì¹˜: +" + oldEnh + " â” +" + p.enh + "\n(100% í™•ì • ê°•í™” ì„±ê³µ!)";
  } else if (itemKey === "ë”¸ê¸°ì¿ í‚¤") {
    var oldLv = p.lv || 1;
    var maxLv = 100;
    var upLv = Math.min(maxLv - oldLv, amount);
    if (upLv <= 0) { replier.reply("ğŸš« ì´ë¯¸ ìµœëŒ€ ë ˆë²¨(" + maxLv + ")ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤."); return; }
    p.lv = oldLv + upLv;
    u.items[itemKey] -= amount;
    resultLog = "ğŸ†™ ë ˆë²¨: Lv." + oldLv + " â” Lv." + p.lv + "\n(í­í’ ì„±ì¥!)";
  } else if (itemKey === "í™©ê¸ˆì—´ë§¤") {
    var oldFr = p.friendship || 0;
    var upFr = amount * 10;
    p.friendship = Math.min(255, oldFr + upFr);
    u.items[itemKey] -= amount;
    resultLog = "â¤ï¸ ì¹œë°€ë„: " + oldFr + " â” " + p.friendship + "\n(í¬ì¼“ëª¬ì´ íŠ¸ë ˆì´ë„ˆë¥¼ ë”ìš± ë”°ë¦…ë‹ˆë‹¤!)";
  } else if (itemKey === "ë„íŒŒë¯¼ê°•í™”ê¶Œ") {
    var oldEnhDopa = p.enh || 0;
    var successCount = 0;
    for (var i = 0; i < amount; i++) { if (Math.random() < 0.3) successCount++; }
    p.enh = oldEnhDopa + successCount;
    u.dopaTicket -= amount;
    if (typeof tryAutoEvolveByEnh === "function") tryAutoEvolveByEnh(p);
    resultLog = "ğŸ° ì´ " + amount + "íšŒ ì‹œë„ â” " + successCount + "íšŒ ì„±ê³µ!\n(í˜„ì¬ +" + p.enh + "ê°•)";
 } else if (itemKey === "í‹°ì–´ë¦¬ì…‹ê¶Œ") {
    if (amount > 1) { replier.reply("ğŸš« í‹°ì–´ë¦¬ì…‹ê¶Œì€ í•œ ë²ˆì— 1ê°œì”©ë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤."); return; }
    
    // 1. ê¸°ì¡´ ìŠ¤íƒ¯ ê¸°ì–µí•˜ê¸°
    var oldGrade = p.grade || "D";
    var oldStr = p.ivStr || 0; 
    var oldHp = Math.floor((p.ivHp || 0) / 10); 
    var oldSpd = p.ivSpd || 0;

    // 2. ìƒˆë¡œìš´ ë“±ê¸‰ ë° ì ì¬ë ¥(IV) ë¶€ì—¬ (í•µì‹¬ ìˆ˜ì •)
    p.grade = typeof generatePokemonGrade === "function" ? generatePokemonGrade() : ["D", "C", "B", "A", "S"][Math.floor(Math.random() * 5)];
    
    if (typeof generateIVsByGrade === "function") {
        var newIVs = generateIVsByGrade(p.grade);
        p.ivStr = newIVs.str; 
        p.ivHp = newIVs.hp; 
        p.ivSpd = newIVs.spd;
    } else {
        // ì•ˆì „ì¥ì¹˜: í•¨ìˆ˜ê°€ ì—†ì„ ê²½ìš° ìˆ˜ë™ìœ¼ë¡œ ë“±ê¸‰ë³„ ê¸°ë³¸ ìŠ¤íƒ¯ ë¶€ì—¬
        var baseIv = {"S":14, "A":11, "B":8, "C":4, "D":1}[p.grade] || 1;
        p.ivStr = baseIv + Math.floor(Math.random() * 2);
        p.ivSpd = baseIv + Math.floor(Math.random() * 2);
        p.ivHp = (baseIv + Math.floor(Math.random() * 2)) * 10;
    }

    u.reroll -= 1;
    if (typeof dexCaught === "function") dexCaught(u, p.pid, p.grade); // ë„ê° ìµœê³ ë“±ê¸‰ ê°±ì‹ 
    
    // 3. í™”ì‚´í‘œ ì—°ì¶œ ë° ê²°ê³¼ ì¡°ë¦½
    var gradeLevels = {"D":1, "C":2, "B":3, "A":4, "S":5};
    var arrow = (gradeLevels[p.grade] > gradeLevels[oldGrade]) ? "ğŸ“ˆ(ìƒìŠ¹!)" : (gradeLevels[p.grade] < gradeLevels[oldGrade] ? "ğŸ“‰(í•˜ë½..)" : "â–(ìœ ì§€)");

    resultLog = "ğŸŒ€ ì ì¬ë ¥ í‹°ì–´: [" + oldGrade + "] " + arrow + " ã€ " + p.grade + " ã€‘\n\n" +
                "[ì ì¬ë ¥ ë³€í™” (15ì  ë§Œì )]\n" +
                "ğŸ’ª í˜ : " + oldStr + " â” " + p.ivStr + "\n" +
                "â¤ï¸ ì²´ : " + oldHp + " â” " + Math.floor(p.ivHp / 10) + "\n" +
                "âš¡ ë¯¼ : " + oldSpd + " â” " + p.ivSpd + "\n" +
                "ğŸ’¡ ë“±ê¸‰ì— ë§ì¶° ì„¸ë¶€ ìŠ¤íƒ¯ì´ ì •ìƒ ì¬ì¡°ì •ë˜ì—ˆìŠµë‹ˆë‹¤!";
                
  } else if (itemKey === "í™©ê¸ˆí˜ì¸íŠ¸") {
    if (amount > 1) { replier.reply("ğŸš« í™©ê¸ˆí˜ì¸íŠ¸ëŠ” í•œ ë²ˆì— 1ê°œì”©ë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤."); return; }
    if (p.shiny) { replier.reply("ğŸš« ì´ë¯¸ ìƒ‰ì´ ë‹¤ë¥¸ í¬ì¼“ëª¬ì…ë‹ˆë‹¤!"); return; }
    p.shiny = true;
    u.items[itemKey] -= 1;
    resultLog = "âœ¨ ì•—! í¬ì¼“ëª¬ì—ê²Œ ì˜ë¡±í•œ ë¹›ì´ ê°ëŒê¸° ì‹œì‘í•©ë‹ˆë‹¤!\n(ì´ë¡œì¹˜ í™•ì • ë¶€ì—¬)";
    
  } else {
    replier.reply("ğŸš« ì‚¬ìš© ê°€ëŠ¥í•œ ì†Œë¹„ ì•„ì´í…œì´ ì•„ë‹ˆê±°ë‚˜ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
    return;
  }

  commitSave(true);
  replier.reply("ğŸ [" + itemKey + "] ì‚¬ìš© ì™„ë£Œ!\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\nëŒ€ìƒ: " + pName + "\nì†Œëª¨: " + amount + "ê°œ\n\nğŸ’¡ [íš¨ê³¼ ì ìš©]\n" + resultLog);
  return;
}

    if (msg.indexOf("/ë¶„í•´") === 0 || msg.indexOf("/ê°ˆê°ˆ") === 0) {
      var parts = msg.split(" ").filter(Boolean);
      var itemName = parts[1];
      var qty = parseInt(parts[2], 10);
      // ì…ë ¥ê°’ ê²€ì¦
      if (!itemName || isNaN(qty) || qty <= 0) {
        replier.reply("â™»ï¸ ì‚¬ìš©ë²•: /ë¶„í•´ [ì•„ì´í…œëª…] [ìˆ˜ëŸ‰]\nì˜ˆ: /ë¶„í•´ í˜ì˜ë¨¸ë¦¬ë  5\n\n(ì‰ì—¬ ì¥ë¹„ë¥¼ ê°ˆì•„ì„œ 'ìƒìíŒŒí¸'ì„ íšë“í•©ë‹ˆë‹¤.)");
        return;
      }
      var itemInfo = EQUIP_DB[itemName];
      if (!itemInfo) {
        replier.reply("ğŸš« " + sender + "ë‹˜, ë¶„í•´í•  ìˆ˜ ì—†ëŠ” ì•„ì´í…œì´ê±°ë‚˜ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì´ë¦„ì…ë‹ˆë‹¤.");
        return;
      }
      if (!u.items || !u.items[itemName] || u.items[itemName] < qty) {
        replier.reply("ğŸš« " + sender + "ë‹˜, ë³´ìœ  ìˆ˜ëŸ‰ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.\ní˜„ì¬: " + (u.items ? (u.items[itemName] || 0) : 0) + "ê°œ");
        return;
      }
      var tier = itemInfo.tier || 1;
      var minF = 1, maxF = 1;
      // í‹°ì–´ë³„ íŒŒí¸ íšë“ ë²”ìœ„ ì„¤ì •
      if (tier === 1) {
        minF = 1;
        maxF = 3;
      } else if (tier === 2) {
        minF = 2;
        maxF = 5;
      } else if (tier === 3) {
        minF = 5;
        maxF = 10;
      } else if (tier === 4) {
        minF = 30;
        maxF = 200;
      }
      var totalFrag = 0;
      // ê°œë³„ ì•„ì´í…œë§ˆë‹¤ ì£¼ì‚¬ìœ„ë¥¼ ë”°ë¡œ êµ´ë¦¼
      for (var i = 0; i < qty; i++) {
        totalFrag += randInt(minF, maxF);
      }
      // 4. ì‹¤í–‰ (ì•„ì´í…œ ì°¨ê°)
      u.items[itemName] -= qty;
      if (u.items[itemName] <= 0) 
        delete u.items[itemName];
      if (!u.items["ìƒìíŒŒí¸"]) 
        u.items["ìƒìíŒŒí¸"] = 0;
      u.items["ìƒìíŒŒí¸"] += totalFrag;
      // 5. íŒŒí¸ -> ìƒì ìë™ í•©ì„± ë¡œì§
      var autoBox = 0;
      if (u.items["ìƒìíŒŒí¸"] >= 10) {
        autoBox = Math.floor(u.items["ìƒìíŒŒí¸"] / 10);
        u.items["ìƒìíŒŒí¸"] %= 10;
        if (!u.items["ì¥ë¹„ìƒì"]) 
          u.items["ì¥ë¹„ìƒì"] = 0;
        u.items["ì¥ë¹„ìƒì"] += autoBox;
      }
      commitSave(true);
      // â˜… [ìˆ˜ì •ë¨] ì´ë¦„(sender) ëª…ì‹œ
      var out = "â™»ï¸ " + sender + "ë‹˜, ì¥ë¹„ ë¶„í•´ ì™„ë£Œ!\n" + "ğŸ“‰ ì†Œëª¨: " + itemName + " -" + qty + "ê°œ\n" + "ğŸ“ˆ íšë“: ğŸ§© ìƒìíŒŒí¸ +" + totalFrag + "ê°œ\n" + "(ê°œë‹¹ " + minF + "~" + maxF + "ê°œ ëœë¤ íšë“)";
      if (autoBox > 0) {
        out += "\n\nğŸ íŒŒí¸ì´ ëª¨ì—¬ [ì¥ë¹„ìƒì +" + autoBox + "]ê°œë¡œ ìë™ í•©ì„±ë˜ì—ˆìŠµë‹ˆë‹¤!";
      }
      replier.reply(out);
      return;
    }
    
   // -------------------- [ìˆ˜ì •ë¨] /ë‚´í¬ì¼“ëª¬ (ì—”íŠ¸ë¦¬/ë‚´ë°•ìŠ¤ ë¶„ë¦¬) --------------------
  if (msg === "/ë‚´í¬ì¼“ëª¬") {
    if (!u.pokemons || u.pokemons.length === 0) {
      replier.reply(sender + "ë‹˜ì€ ë³´ìœ í•œ í¬ì¼“ëª¬ì´ ì—†ìŠµë‹ˆë‹¤."); return;
    }
    
    if (typeof ensurePokemonGrades === "function") ensurePokemonGrades(u);
    var partyLines = [];
    var boxLines = [];
    var sorted = sortPokemonsByPower(u.pokemons);

    for (var i = 0; i < sorted.length; i++) {
      var p = sorted[i];
      var name = getDisplayName(p);
      var power = calcBattlePower(p);
      var heart = (p.friendship >= 220) ? "â¤ï¸" : (p.friendship >= 150) ? "ğŸ§¡" : "ğŸ–¤";
      var gradeStr = "[" + (p.grade || "D") + "]" + (p.grade === "S" ? "ğŸ‘‘" : "");
      var status = isPokemonBusy(u, p.uid) ? " (ğŸ§­)" : "";
      
      var equipStr = "";
      if (p.equip && EQUIP_DB[p.equip]) {
        equipStr = " [" + (EQUIP_DB[p.equip].icon || "ğŸ›¡ï¸") + p.equip + "]";
      }
      
      // [í•µì‹¬] í•œ ì¤„ í¬ë§· ì •ì˜
      var line = "#" + p.uid + " " + name + " (Lv." + (p.lv || 1) + ") +" + (p.enh || 0) + "ê°• | íˆ¬ë ¥ " + fmtNum(power) + " " + gradeStr + " " + heart + equipStr + status;

      if (u.party && u.party.indexOf(p.uid) !== -1) partyLines.push("â˜… " + line);
      else boxLines.push((boxLines.length + 1) + ". " + line);
    }

    var summary = "ğŸ’ " + decoName + "ë‹˜ì˜ í¬ì¼“ëª¬ ê´€ë¦¬\n" + 
                  "ì—”íŠ¸ë¦¬: " + partyLines.length + " / 6\n" +
                  "ë°•ìŠ¤: " + boxLines.length + "ë§ˆë¦¬\n\n" + 
                  "ì „ì²´ë³´ê¸°ë¡œ ìƒì„¸ ëª©ë¡ì„ í™•ì¸í•˜ì„¸ìš”.";
                  
    var full = "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
               "âš”ï¸ [ì—”íŠ¸ë¦¬ ë©¤ë²„]\n" +
               "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
               (partyLines.length > 0 ? partyLines.join("\n") : "(ë¹„ì–´ìˆìŒ)") + "\n\n" +
               "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
               "ğŸ“¦ [ë°•ìŠ¤ ëŒ€ê¸° ë©¤ë²„]\n" +
               "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
               (boxLines.length > 0 ? boxLines.join("\n") : "(ë¹„ì–´ìˆìŒ)");

    replyFold(replier, summary, full);
    return;
  }

    if (msg.indexOf("/í¬ì¼“ëª¬") === 0) {
      var t = getTargetFromMsg(d, sender, msg, "/í¬ì¼“ëª¬");
      if (!t) {
        replier.reply("ğŸš« ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ìœ ì €ì…ë‹ˆë‹¤.\nì‚¬ìš©ë²•: /í¬ì¼“ëª¬ [ë‹‰ë„¤ì„]");
        return;
      }
      var targetName = t.name;
      var targetU = t.user;
      if (!targetU.pokemons || targetU.pokemons.length === 0) {
        replier.reply(targetName + "ë‹˜ì€ ë³´ìœ í•œ í¬ì¼“ëª¬ì´ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      
      if (typeof ensurePokemonGrades === "function") ensurePokemonGrades(targetU);

      var summary = "ğŸ” " + targetName + "ë‹˜ì˜ í¬ì¼“ëª¬ ëª©ë¡\n" + "ì´ " + targetU.pokemons.length + "ë§ˆë¦¬\n\n" + "ì „ì²´ë³´ê¸°ë¡œ ìƒì„¸ ìŠ¤í™ì„ í™•ì¸í•˜ì„¸ìš”.";
      var full = "\n\n[" + targetName + "ë‹˜ì˜ ì „ì²´ ëª©ë¡]\n\n";
      
      var listCopy = targetU.pokemons.slice();
      var sorted = sortPokemonsByPower(listCopy);
      
      for (var i = 0; i < sorted.length; i++) {
        var p = sorted[i];
        var power = calcBattlePower(p);
        var name = getDisplayName(p);
        var enh = (p.enh && p.enh > 0) ? ("+" + p.enh + "ê°•") : "";
        var lvStr = "Lv." + (p.lv || 1);
        var grade = p.grade || "D";
        var gradeStr = "[" + grade + "]" + (grade === "S" ? "ğŸ‘‘" : "");
        
        // â˜… [ì¥ë¹„ í‘œê¸° ê°œì„ ]: [ì•„ì´ì½˜+ì´ë¦„] í˜•íƒœ
        var equipStr = "";
        if (p.equip && EQUIP_DB[p.equip]) {
          var item = EQUIP_DB[p.equip];
          equipStr = " [" + (item.icon || "ğŸ›¡ï¸") + p.equip + "]";
        }
        
        var status = isPokemonBusy(targetU, p.uid) ? " (ğŸ§­)" : "";
        full += (i + 1) + ". #" + p.uid + " " + lvStr + " " + name + " " + enh + " | íˆ¬ë ¥ " + fmtNum(power) + " " + gradeStr + equipStr + status + "\n";
      }
      
      replyFold(replier, summary, full);
      return;
    }

  if (msg.indexOf("/ìƒíƒœ") === 0 || msg.indexOf("/ì •ë³´") === 0) {
    var parts = msg.split(" ").filter(Boolean);
    var input = parts[1]; 
    
    if (!input) {
      replier.reply("ğŸ“ ì‚¬ìš©ë²•: /ìƒíƒœ [UID ë˜ëŠ” ë³„ëª…]\nì˜ˆ: /ìƒíƒœ 202 ë˜ëŠ” /ìƒíƒœ ëœì¥");
      return;
    }

    var p = findPokemonByAny(u, input); 
    if (!p) {
      replier.reply("ğŸš« '" + input + "' í¬ì¼“ëª¬ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    var db = findPokemonDB(p.pid);
    var speciesName = db ? db.name : "ì•Œìˆ˜ì—†ìŒ"; // ì›ë³¸ ì¢…ì¡±ëª…
    var shinyMark = p.shiny ? "âœ¨" : "";
    
    // ë³„ëª…ì´ ìˆìœ¼ë©´ "âœ¨ë³„ëª… (ì¢…ì¡±ëª…)", ì—†ìœ¼ë©´ "âœ¨ì¢…ì¡±ëª…"
    var pShowName = p.nickname ? p.nickname + " (" + speciesName + ")" : speciesName;
    
    var power = calcBattlePower(p);
    var gradeStr = "[" + (p.grade || "D") + "]" + (p.grade === "S" ? "ğŸ‘‘" : "");
    var heart = (p.friendship >= 220) ? "â¤ï¸ (ì‹¬ë³µ)" : (p.friendship >= 150) ? "ğŸ§¡ (ì¹œë°€)" : "ğŸ–¤ (ì„œë¨¹)";
    var typeStr = db ? (db.type1 + (db.type2 ? " / " + db.type2 : "")) : "ë¯¸í™•ì¸"; // ì†ì„± ì •ë³´

    // ì‹¤ì‹œê°„ ìŠ¤íƒ¯ ê³„ì‚°
    var realHP = calcHP(db, p.enh, p.ivHp || 0, p.equip);
    var aR = rarityBattleMul(db.rarity || 2, db.id);
    var sMul = stageBattleMul(db.id).atk;
    var realAtk = Math.floor(db.basePower * (1 + (p.enh * 0.085)) * (1 + ((p.ivStr || 0) * 0.015)) * aR * sMul);
    if (p.shiny) realAtk = Math.floor(realAtk * 1.1);
    if (p.equip && EQUIP_DB[p.equip] && EQUIP_DB[p.equip].type === "atk_pct") {
        realAtk = Math.floor(realAtk * (1 + EQUIP_DB[p.equip].val));
    }
    var realSpd = (p.ivSpd || 0);
    if (p.equip && EQUIP_DB[p.equip] && EQUIP_DB[p.equip].type === "spd_flat") {
        realSpd += EQUIP_DB[p.equip].val;
    }

    // ê²°ê³¼ ì¶œë ¥
    var finalMsg = "ğŸ“Š [" + shinyMark + pShowName + "] ìƒì„¸ ì •ë³´\n" +
                   "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                   "ğŸ’  ì†ì„±: " + typeStr + "\n" + // ì‚¬ì¥ë‹˜ì´ ìš”ì²­í•˜ì‹  ì†ì„± ì¶”ê°€
                   "â­ Lv." + (p.lv || 1) + " (+" + (p.enh || 0) + "ê°•)\n" +
                   "âš”ï¸ íˆ¬ë ¥: " + fmtNum(power) + " " + gradeStr + "\n" +
                   "ğŸ¤ ì¹œë°€: " + heart + " (" + (p.friendship || 0) + "p)\n\n" +
                   "âš”ï¸ [ì‹¤ì „ ì „íˆ¬ ìŠ¤íƒ¯]\n" +
                   "ğŸ’ª ê³µê²©ë ¥: " + fmtNum(realAtk) + "\n" +
                   "â¤ï¸ ì²´ë ¥: " + fmtNum(realHP) + "\n" +
                   "âš¡ ì†ë„: " + realSpd + "\n\n" +
                   "ğŸ§¬ [ì ì¬ë ¥ (IV)]\n" +
                   "ğŸ”¥ í˜: " + (p.ivStr || 0) + " / 15\n" +
                   "â¤ï¸ ì²´: " + Math.floor((p.ivHp || 0) / 10) + " / 15\n" +
                   "âš¡ ë¯¼: " + (p.ivSpd || 0) + " / 15\n\n" +
                   "ğŸ›¡ï¸ [ì¥ì°© ì¥ë¹„]\n";

    if (p.equip && EQUIP_DB[p.equip]) {
      var item = EQUIP_DB[p.equip];
      finalMsg += (item.icon || "ğŸ›¡ï¸") + " " + p.equip + "\n" +
                  "âœ¨ íš¨ê³¼: " + (item.desc || "íš¨ê³¼ ì—†ìŒ") + "\n";
    } else {
      finalMsg += "ì¥ì°©ëœ ì¥ë¹„ê°€ ì—†ìŠµë‹ˆë‹¤.\n";
    }

    finalMsg += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                "ğŸ’¡ ë³„ëª… ì„¤ì •: '/ë³„ëª… " + p.uid + " [ì´ë¦„]'\n" +
                "ğŸ’¡ ì¥ë¹„ ì¥ì°©: '/ì¥ì°© " + (p.nickname || p.uid) + " [ì¥ë¹„ëª…]'";

    replier.reply(finalMsg);
    return;
  }

    if (msg.indexOf("/ë³„ëª…") === 0) {
      var parts = msg.split(" ").filter(Boolean);
      var uid = parseInt(parts[1], 10);
      var newName = parts.slice(2).join(" ").trim();

      if (isNaN(uid) || !newName) {
        replier.reply("ğŸ“ ì‚¬ìš©ë²•: /ë³„ëª… [UID] [ìƒˆì´ë¦„]\nì˜ˆ: /ë³„ëª… 186 ì´ˆì½”ë¦¿");
        return;
      }

      var p = findUserPokemonByUid(u, uid);
      if (!p) {
        replier.reply("ğŸš« í•´ë‹¹ í¬ì¼“ëª¬ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      if (newName.length > 10) {
        replier.reply("ğŸš« ë³„ëª…ì€ ìµœëŒ€ 10ìê¹Œì§€ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        return;
      }

      p.nickname = newName;
      commitSave(true);
      replier.reply("âœ¨ ë³„ëª… ì„¤ì • ì™„ë£Œ!\nì´ì œ #" + uid + "ë²ˆ í¬ì¼“ëª¬ì€ '" + newName + "'(ìœ¼)ë¡œ ë¶ˆë¦½ë‹ˆë‹¤.");
      return;
    }


    if (msg.indexOf("/íŒë§¤ í•˜ìœ„") === 0 || msg.indexOf("/íŒë§¤í•˜ìœ„") === 0) {
      var sp = msg.split(" ").filter(Boolean);
      var n = 0;
      // ëª…ë ¹ì–´ í˜•íƒœì— ë”°ë¼ ìˆ«ì ìœ„ì¹˜ íŒŒì•…
      // 1) "/íŒë§¤í•˜ìœ„ 10" -> sp[0]="/íŒë§¤í•˜ìœ„", sp[1]="10"
      // 2) "/íŒë§¤ í•˜ìœ„ 10" -> sp[0]="/íŒë§¤", sp[1]="í•˜ìœ„", sp[2]="10"
      if (msg.indexOf("/íŒë§¤í•˜ìœ„") === 0) {
        n = parseInt(sp[1], 10);
      } else {
        n = parseInt(sp[2], 10);
      }
      if (isNaN(n) || n <= 0) {
        replier.reply("ì‚¬ìš©ë²•: /íŒë§¤í•˜ìœ„ [ìˆ«ì]\nì˜ˆ: /íŒë§¤í•˜ìœ„ 50");
        return;
      }
      if (!u.pokemons || u.pokemons.length <= 1) {
        replier.reply("íŒë§¤í•  í¬ì¼“ëª¬ì´ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      var sorted = sortPokemonsByPower(u.pokemons);
      var maxSell = Math.min(n, sorted.length - 1);
      var targets = sorted.slice(sorted.length - maxSell);
      var totalGold = 0;
      var soldCount = 0;
      var skippedCount = 0;
      var logLimit = 20;
      var soldLogs = [];
      for (var i = u.pokemons.length - 1; i >= 0; i--) {
        var p = u.pokemons[i];
        var isTarget = false;
        for (var j = 0; j < targets.length; j++) {
          if (p.uid === targets[j].uid) {
            isTarget = true;
            break;
          }
        }
        if (isTarget) {
          if (isPokemonBusy(u, p.uid)) {
            skippedCount++;
            continue;
          }
          var isInTeam = false;
          if (u.gymTeam && u.gymTeam.indexOf(p.uid) !== -1) 
            isInTeam = true;
          if (u.champTeam && u.champTeam.indexOf(p.uid) !== -1) 
            isInTeam = true;
          if (isInTeam) {
            skippedCount++;
            continue;
          }
          var price = sellPrice(p.pid, p.enh, p.grade);
          u.pokemons.splice(i, 1);
          totalGold += price;
          soldCount++;
          if (soldLogs.length < logLimit) {
            var db = findPokemonDB(p.pid);
            var name = db ? db.name : "í¬ì¼“ëª¬";
            if (p.shiny) 
              name = "âœ¨" + name;
            soldLogs.push("#" + p.uid + " " + name + " (+" + fmtNum(price) + "ğŸ’°)");
          }
        }
      }
      u.gold += totalGold;
      commitSave(true);
      checkAndNotifyTitles(u, replier);
      var resultMsg = "ğŸ—‘ï¸ ëŒ€ëŸ‰ íŒë§¤ ì™„ë£Œ!\nì´ " + soldCount + "ë§ˆë¦¬ë¥¼ íŒë§¤í–ˆìŠµë‹ˆë‹¤.\n\n";
      if (soldLogs.length > 0) {
        resultMsg += "[íŒë§¤ ë‚´ì—­ (ìƒìœ„ " + soldLogs.length + "ê°œ)]\n" + soldLogs.join("\n");
        if (soldCount > logLimit) 
          resultMsg += "\n...ì™¸ " + (soldCount - logLimit) + "ë§ˆë¦¬";
      }
      resultMsg += "\n\nğŸ’° ì´ íšë“: +" + fmtNum(totalGold) + "ğŸ’°\nğŸ’ ë‚¨ì€ í¬ì¼“ëª¬: " + u.pokemons.length + " / " + MAX_POKEMON_SLOT;
      if (skippedCount > 0) {
        resultMsg += "\nâš ï¸ íƒí—˜ ì¤‘ì´ê±°ë‚˜ ì„ ë°œëŒ€ì— ë“±ë¡ëœ " + skippedCount + "ë§ˆë¦¬ëŠ” íŒë§¤ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
      }
      replier.reply(resultMsg);
      return;
    }
    if (msg.indexOf("/íŒë§¤") === 0) {
      var sp2 = msg.split(" ").filter(Boolean);
      if (sp2.length < 2) {
        replier.reply("ì‚¬ìš©ë²•:\n/íŒë§¤ 12\n/íŒë§¤ 12 15 19\n/íŒë§¤ í•˜ìœ„ 5");
        return;
      }
      if (!u.pokemons || u.pokemons.length === 0) {
        replier.reply("íŒë§¤í•  í¬ì¼“ëª¬ì´ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      if (u.pokemons.length <= 1) {
        replier.reply("ë³´ìœ  í¬ì¼“ëª¬ì´ 1ë§ˆë¦¬ì¼ ë•ŒëŠ” íŒë§¤í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      var uidList = [];
      for (var a = 1; a < sp2.length; a++) {
        var v = parseInt(sp2[a], 10);
        if (!isNaN(v) && v > 0 && uidList.indexOf(v) === -1) 
          uidList.push(v);
      }
      if (uidList.length === 0) {
        replier.reply("í¬ì¼“ëª¬IDê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.\nì˜ˆ: /íŒë§¤ 12 15 19");
        return;
      }
      var soldLines2 = [];
      var notFound = [];
      var blockedLines = [];
      var totalGold2 = 0;
      var foundMap = {};
      for (var i2 = 0; i2 < uidList.length; i2++) 
        foundMap[uidList[i2]] = false;
      for (var si = u.pokemons.length - 1; si >= 0; si--) {
        var pSell = u.pokemons[si];
        if (uidList.indexOf(pSell.uid) === -1) 
          continue;
        if (isPokemonBusy(u, pSell.uid)) {
          blockedLines.push("#" + pSell.uid + "(íƒí—˜ì¤‘)");
          continue;
        }
        foundMap[pSell.uid] = true;
        if (u.pokemons.length <= 1) {
          blockedLines.push("#" + pSell.uid + "(ë§ˆì§€ë§‰ 1ë§ˆë¦¬ ë³´í˜¸)");
          continue;
        }
        var dbSell = findPokemonDB(pSell.pid);
        // â˜… [ìˆ˜ì •] ì´ë¡œì¹˜ ì´ë¦„ ì ìš©
        var nm = getDisplayName(pSell);
        var price2 = sellPrice(pSell.pid, pSell.enh, pSell.grade);        // grade ì¸ì ì¶”ê°€ë¨ì— ì£¼ì˜
        u.pokemons.splice(si, 1);
        totalGold2 += price2;
        soldLines2.push("#" + pSell.uid + " " + nm + " " + (pSell.enh || 0) + "ê°• (+" + fmtNum(price2) + "ğŸ’°)");
      }
      for (var k = 0; k < uidList.length; k++) {
        if (!foundMap[uidList[k]]) 
          notFound.push("#" + uidList[k]);
      }
      if (soldLines2.length === 0) {
        var msgFail = "íŒë§¤ ê°€ëŠ¥í•œ í¬ì¼“ëª¬ì´ ì—†ìŠµë‹ˆë‹¤.";
        if (notFound.length) 
          msgFail += "\n\nì°¾ì§€ ëª»í•œ ID: " + notFound.join(", ");
        if (blockedLines.length) 
          msgFail += "\n\níŒë§¤ ì œí•œ: " + blockedLines.join(", ");
        replier.reply(msgFail);
        return;
      }
      u.gold += totalGold2;
      commitSave(true);
      checkAndNotifyTitles(u, replier);
      var out = sayDo(decoName, "ìš”ì²­í•˜ì‹  í¬ì¼“ëª¬ íŒë§¤ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.") + "\n\nğŸ§¾ íŒë§¤ ë‚´ì—­\n" + soldLines2.join("\n") + "\n\nğŸ’° ì´ íšë“ ê³¨ë“œ: +" + fmtNum(totalGold2) + "ğŸ’°" + "\nğŸ’° ì”ì—¬ ê³¨ë“œ: " + fmtNum(u.gold) + "ğŸ’°";
      if (notFound.length) 
        out += "\n\nğŸ” ì°¾ì§€ ëª»í•œ ID\n" + notFound.join(", ");
      if (blockedLines.length) 
        out += "\n\nâ›” íŒë§¤ ì œí•œ\n" + blockedLines.join(", ");
      replier.reply(out);
      return;
    }
// ==================================================================
// ğŸ“– [v9.5 ì™„ê²°] ì§€ëŠ¥í˜• ë°±ê³¼ì‚¬ì „ & ëª…ë ¹ì–´ ê°€ì´ë“œ ì‹œìŠ¤í…œ
// ==================================================================

// 1. ìƒì„¸ ë°±ê³¼ì‚¬ì „ ë°ì´í„° (ìœ ì € ë§ì¶¤í˜• ìƒì„¸ ê°€ì´ë“œ)
var GUIDE_MAP = {
  "ì—”íŠ¸ë¦¬": "ğŸ’ [ì—”íŠ¸ë¦¬ & ë°•ìŠ¤ ì‹œìŠ¤í…œ]\n- **ì—”íŠ¸ë¦¬**: ì „íˆ¬/ë ˆì´ë“œì— ì°¸ì—¬í•˜ëŠ” ì •ì˜ˆ 6ë§ˆë¦¬ (`/ì—”íŠ¸ë¦¬`)\n- **ë°•ìŠ¤**: ëŒ€ê¸° ì¤‘ì¸ í¬ì¼“ëª¬ ë³´ê´€ì†Œ (`/ë‚´ë°•ìŠ¤`)\n- **êµì²´**: `/êµì²´ [ëº„ë†ˆ] [ë„£ì„ë†ˆ]` ìœ¼ë¡œ ì¦‰ì‹œ êµëŒ€ ê°€ëŠ¥!",

  "ë³„ëª…": "âœ¨ [ë³„ëª…(ë‹‰ë„¤ì„) ì‹œìŠ¤í…œ]\n- ë‚˜ë§Œì˜ í¬ì¼“ëª¬ì—ê²Œ ì´ë¦„ì„ ì§€ì–´ì£¼ì„¸ìš”!\n- ì„¤ì •: `/ë³„ëª… [UID] [ì´ë¦„]`\n- í˜¸ì¶œ: ì´ì œ `/ê°•í™” ëœì¥` ì²˜ëŸ¼ UID ëŒ€ì‹  ë³„ëª…ìœ¼ë¡œë„ ëª…ë ¹ì–´ê°€ ì‘ë™í•©ë‹ˆë‹¤.",

  "ì›”ë“œ": "ğŸŒ [ì›”ë“œ ì´ë™ ê°€ì´ë“œ]\n- **íŒŒì•¼ë ˆë°”**: 1ì„¸ëŒ€ í¬ì¼“ëª¬ / ë ˆì´ë“œ / ì²´ìœ¡ê´€ / ë¦¬ê·¸\n- **ì´ìŠŒ**: 2ì„¸ëŒ€ í¬ì¼“ëª¬ ë“±ì¥ / ë°°ì§€ 8ê°œ ë³´ìœ  ì‹œ ì…ì¥ ê°€ëŠ¥\n- **ì´ë™**: `/ì´ë™ [ë§ˆì„ëª…]` (ì´ë™í‹°ì¼“ 100ì¥ ì†Œëª¨)",

  "ì§„í™”": "ğŸ§¬ [ì§„í™”ì˜ ëª¨ë“  ê²ƒ]\n1. **ë ˆë²¨**: íŠ¹ì • ë ˆë²¨ ë‹¬ì„± ì‹œ ìë™ ì§„í™”\n2. **ë„êµ¬**: ì§„í™”ì˜ ëŒ ì¥ì°© í›„ ë ˆë²¨ì—…\n3. **ì¹œë°€ë„**: ì—”íŠ¸ë¦¬ì— ë„£ê³  ì‚¬ëƒ¥/í¬íš ì‹œ ìƒìŠ¹ (220p ì´ìƒ ì‹œ ì§„í™”)\n4. **í†µì‹ **: `/êµí™˜` ì‹œ ì¦‰ì‹œ ì§„í™” (í•«ì‚¼, ê°•ì² í†¤ ë“±)",

  "ë ˆì´ë“œ": "ğŸ¦– [ì›”ë“œ ë ˆì´ë“œ 2.0]\n- `/ë ˆì´ë“œ` ì‹œ ê³µê²© 30íšŒë§ˆë‹¤ **[í•„ì‚´ê¸°]** ë°œë™!\n- ë³´ìƒ: ë°ë¯¸ì§€ ë¹„ë¡€ **ë‹¤ì½”íƒ€ ì½”ì¸** ì§€ê¸‰\n- ë¶€ìƒ: ê³µê²© ì‹œ 5% í™•ë¥ ë¡œ ë¶€ìƒ (2ë¶„ ëŒ€ê¸° ë˜ëŠ” `/ì¹˜ë£Œ`)",

  "ë‹¤ì½”íƒ€": "ğŸ° [ë‹¤ì½”íƒ€ ìƒì ]\n- ë ˆì´ë“œ ì½”ì¸ ì „ìš© ìƒì ì…ë‹ˆë‹¤. (`/ë‹¤ì½”íƒ€ìƒì `)\n- **ê¿€í…œ**: Sê¸‰ í™•ì •ê¶Œ(í™©ê¸ˆì—´ë§¤), ê°•í™”+3(ë”¸ì«€ì¿ ), ì´ë¡œì¹˜ë³€í™˜(í™©ê¸ˆí˜ì¸íŠ¸)\n- **íšë“**: ë ˆì´ë“œ ë³´ìƒ ë˜ëŠ” `/íƒí—˜` ì¤‘ ë‚®ì€ í™•ë¥ ë¡œ ë°œê²¬ ê°€ëŠ¥!",

  "ì ì¬ë ¥": "ğŸ“Š [ë“±ê¸‰ & ì ì¬ë ¥(IV)]\n- **ë“±ê¸‰**: S(ğŸ‘‘) > A > B > C > D\n- **ìŠ¤íƒ¯**: í˜ / ì²´ë ¥ / ë¯¼ì²© (ê° 15ì  ë§Œì )\n- ë“±ê¸‰ì´ ë†’ì„ìˆ˜ë¡ ë°°í‹€ ì‹œ ê³µê²©ë ¥ê³¼ ì²´ë ¥ ë³´ë„ˆìŠ¤ê°€ í¬ê²Œ ìƒìŠ¹í•©ë‹ˆë‹¤.",

  "ë°˜ì‚¬": "ğŸ§  [íŠ¹ìˆ˜ íš¨ê³¼: ë°˜ì‚¬]\n- ì¥ë¹„ **'ê¹€ì‹œì‹±ì˜ë©˜íƒˆ'** ì¥ì°© ì‹œ ë°œë™!\n- ìƒëŒ€ì—ê²Œ ë°›ì€ ë°ë¯¸ì§€ì˜ 30%ë¥¼ ê³ ìŠ¤ë€íˆ ëŒë ¤ì¤ë‹ˆë‹¤.",

  "ìƒì„±": "âš”ï¸ [ì†ì„± ìƒì„±í‘œ: ì£½ì°½ ë©”íƒ€]\nìƒì„± ìš°ìœ„ ì‹œ ìƒëŒ€ ë°©ì–´ë ¥ì„ 50~80% ë¬´ì‹œí•©ë‹ˆë‹¤!\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ”¥ ë¶ˆê½ƒ â” í’€, ë²Œë ˆ, ì–¼ìŒ, ê°•ì² \nğŸ’§ ë¬¼ â” ë¶ˆê½ƒ, ë•…, ë°”ìœ„\nğŸŒ¿ í’€ â” ë¬¼, ë•…, ë°”ìœ„\nâš¡ ì „ê¸° â” ë¬¼, ë¹„í–‰\nâ„ï¸ ì–¼ìŒ â” í’€, ë•…, ë¹„í–‰, ë“œë˜ê³¤\nğŸ‘Š ê²©íˆ¬ â” ë…¸ë§, ë°”ìœ„, ê°•ì² , ì–¼ìŒ, ì•…\nâ˜ ï¸ ë… â” í’€, í˜ì–´ë¦¬\nğŸœï¸ ë•… â” ë¶ˆê½ƒ, ì „ê¸°, ë…, ë°”ìœ„, ê°•ì² \nğŸª½ ë¹„í–‰ â” í’€, ê²©íˆ¬, ë²Œë ˆ\nğŸ§  ì—ìŠ¤í¼ â” ê²©íˆ¬, ë…\nğŸ› ë²Œë ˆ â” í’€, ì—ìŠ¤í¼, ì•…\nğŸª¨ ë°”ìœ„ â” ë¶ˆê½ƒ, ì–¼ìŒ, ë¹„í–‰, ë²Œë ˆ\nğŸ‘» ê³ ìŠ¤íŠ¸ â” ì—ìŠ¤í¼, ê³ ìŠ¤íŠ¸\nğŸ‰ ë“œë˜ê³¤ â” ë“œë˜ê³¤\nğŸŒ‘ ì•… â” ì—ìŠ¤í¼, ê³ ìŠ¤íŠ¸\nâš™ï¸ ê°•ì²  â” ì–¼ìŒ, ë°”ìœ„, í˜ì–´ë¦¬\nğŸ§š í˜ì–´ë¦¬ â” ê²©íˆ¬, ë“œë˜ê³¤, ì•…",

  "ì¥ë¹„": "ğŸ¦¾ [ì¥ë¹„ ì¥ì°© ê°€ì´ë“œ]\n- ì¥ì°©: `/ì¥ì°© [ë³„ëª…/UID] [ì¥ë¹„ëª…]`\n- í•´ì œ: `/í•´ì œ [ë³„ëª…/UID]`\n- **íŒ**: `/ì„¤ëª… ì¥ë¹„`ë¥¼ ì¹˜ë©´ ëª¨ë“  ì¥ë¹„ ë“±ê¸‰ê³¼ íš¨ê³¼ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤!"
};


// ğŸ“– [í†µí•© ë„ì›€ë§] ëª…ë ¹ì–´ ê°€ì´ë“œ (v12.9 ì „ìˆ˜ ì¡°ì‚¬ ë° ì—”íŠ¸ë¦¬ ê°œí¸ ë°˜ì˜)
if (msg === "/ëª…ë ¹ì–´" || msg === "/ë„ì›€ë§" || msg === "/help") {
  var guideTitle = "ğŸ“œ [í¬ì¼“ëª¬ ëŒ€ëª¨í—˜] ê³µì‹ ëª…ë ¹ì–´ ê°€ì´ë“œ\n" +
                   "ìƒì„¸ ë‚´ìš©ì„ í™•ì¸í•˜ë ¤ë©´ [ì „ì²´ë³´ê¸°]ë¥¼ í´ë¦­í•˜ì„¸ìš”!";
  
  var guideContent = "ğŸ‘¤ [1. íŠ¸ë ˆì´ë„ˆ ë° ì •ë³´]\n" +
                     "â€¢ /ì •ë³´ (ë˜ëŠ” /ë‚´ì •ë³´) : ë‚˜ì˜ ìƒì„¸ ìŠ¤í™ í™•ì¸\n" +
                     "â€¢ /ì§€ê°‘ (ë˜ëŠ” /ë‚´ì§€ê°‘, /ëˆ) : ë³´ìœ  ê³¨ë“œ ë° ì½”ì¸ í™•ì¸\n" +
                     "â€¢ /ê°€ë°© (ë˜ëŠ” /í…œ, /ì¸ë²¤, /ì•„ì´í…œ) : ë³´ìœ  ì†Œëª¨í’ˆ í™•ì¸\n" +
                     "â€¢ /ë‚´ë°•ìŠ¤ (ë˜ëŠ” /ë°•ìŠ¤, /í¬ì¼“ëª¬) : ë³´ìœ  í¬ì¼“ëª¬ ëª©ë¡ ë³´ê¸°\n" +
                     "â€¢ /ë„ê°, /ë„ê°2 : í¬ì¼“ëª¬ ìˆ˜ì§‘ í˜„í™© ë° ë°ì´í„°\n" +
                     "â€¢ /ì¹­í˜¸ : ì¥ì°© ì¤‘ì¸ ì¹­í˜¸ í™•ì¸ ë° ë³€ê²½\n" +
                     "â€¢ /ìƒíƒœ [ë³„ëª…/UID] : íŠ¹ì • í¬ì¼“ëª¬ ìƒì„¸ ìŠ¤í™\n\n" +
                     
                     "ğŸ¹ [2. ëª¨í—˜ ë° ì›”ë“œ]\n" +
                     "â€¢ /í•„ë“œ (ë˜ëŠ” /ì‚¬ëƒ¥) : í¬ì¼“ëª¬ íƒìƒ‰ ë° í¬íš\n" +
                     "â€¢ /ì§€ì—­ì´ë™ [ë²ˆí˜¸] : ë‹¤ë¥¸ ì§€ì—­ì´ë‚˜ ë§ˆì„ë¡œ ì´ë™\n" +
                     "â€¢ /ë‚´ìœ„ì¹˜ : í˜„ì¬ ìœ„ì¹˜í•œ ì›”ë“œ ë° ë§ˆì„ ì •ë³´ í™•ì¸\n" +
                     "â€¢ /íƒí—˜ [ë³„ëª…/UID] : 30ë¶„ê°„ í¬ì¼“ëª¬ íŒŒê²¬ (ë³´ìƒ íšë“)\n" +
                     "â€¢ /íƒí—˜ì·¨ì†Œ : íƒí—˜ ì¤‘ì¸ í¬ì¼“ëª¬ ì¦‰ì‹œ ë³µê·€\n\n" +
                     
                     "ğŸ†™ [3. ìœ¡ì„± ë° ê°•í™”]\n" +
                     "â€¢ /ê°•í™” [ë³„ëª…/UID] : ê³¨ë“œë¥¼ ì‚¬ìš©í•˜ì—¬ í¬ì¼“ëª¬ ê°•í™”\n" +
                     "â€¢ /ë„íŒŒë¯¼ [ë³„ëª…/UID] : ë„íŒŒë¯¼ê°•í™”ê¶Œ ì•„ì´í…œ ì‚¬ìš©\n" +
                     "â€¢ /ë³„ëª… [UID] [ì´ë¦„] : í¬ì¼“ëª¬ì—ê²Œ ìƒˆë¡œìš´ ì• ì¹­ ë¶€ì—¬\n" +
                     "â€¢ /ì¥ì°© [ë³„ëª…/UID] [í…œëª…] : íšë“í•œ ì¥ë¹„ë¥¼ í¬ì¼“ëª¬ì—ê²Œ ì°©ìš©\n" +
                     "â€¢ /í•´ì œ [ë³„ëª…/UID] : ì¥ì°© ì¤‘ì¸ ì¥ë¹„ ë¶„ë¦¬\n" +
                     "â€¢ /ë¶„í•´ [í…œëª…] [ìˆ˜ëŸ‰] : í•„ìš” ì—†ëŠ” ì¥ë¹„ë¥¼ íŒŒí¸ìœ¼ë¡œ ë¶„í•´\n" +
                     "â€¢ /ì‚¬ìš© [ì•„ì´í…œ] [ë³„ëª…/UID] [ìˆ˜ëŸ‰] : ì•„ì´í…œ ì‚¬ìš©\n" +
                     "â€¢ /ì§„í™” [ë³„ëª…/UID] : ì§„í™” ì¡°ê±´ ì¶©ì¡± ì‹œ ë‹¤ìŒ ë‹¨ê³„ ì§„í™”\n\n" +
                     
                     "âš”ï¸ [4. ì „íˆ¬ ë° ì—”íŠ¸ë¦¬]\n" +
                     "â€¢ /ì„ íƒ [ë³„ëª…/UID] : ì—”íŠ¸ë¦¬ ë„£ê¸°/ë¹¼ê¸° (ë„ì–´ì“°ê¸°ë¡œ ë‹¤ì¤‘ ë“±ë¡ ê°€ëŠ¥)\n" +
                     "â€¢ /ì„ íƒ ì´ˆê¸°í™” : í˜„ì¬ ì—”íŠ¸ë¦¬ ë©¤ë²„ ì¼ê´„ ë¹„ìš°ê¸°\n" +
                     "â€¢ /êµì²´ [ëº„ë†ˆ] [ë„£ì„ë†ˆ] : 1:1 ë©¤ë²„ êµì²´ (ìˆœì„œ ìœ ì§€, ë³„ëª… ì§€ì›)\n" +
                     "â€¢ /ì—”íŠ¸ë¦¬ : í˜„ì¬ ì„¤ì •ëœ ì„ ë°œëŒ€ ë©¤ë²„ í™•ì¸\n" +
                     "â€¢ /ë°°í‹€ [ë‹‰ë„¤ì„] : ìœ ì €ì™€ 1:1 ì§„ê²€ìŠ¹ë¶€\n" +
                     "â€¢ /ëª¨ì˜ë°°í‹€ [ë‹‰ë„¤ì„] : ë³´ìƒ ì—†ëŠ” ì—°ìŠµ ëŒ€ê²°\n" +
                     "â€¢ /ë ˆì´ë“œ, /ë³´ìŠ¤ : ì›”ë“œ ë³´ìŠ¤ í˜„í™© í™•ì¸ ë° ê³µê²©\n" +
                     "â€¢ /ì²´ìœ¡ê´€, /ì±”í”¼ì–¸ : ë¦¬ê·¸ ë„ì „ ë° ë°°ì§€ í™•ì¸\n" +
                     "â€¢ /ë­í‚¹ : ë¶„ì•¼ë³„ íŠ¸ë ˆì´ë„ˆ ë° í¬ì¼“ëª¬ ìˆœìœ„\n\n" +
                     
                     "ğŸ’° [5. ê²½ì œ ë° ê±°ë˜]\n" +
                     "â€¢ /ìƒì , /ë‹¤ì½”íƒ€ìƒì  : ì¼ë°˜/ê³ ê¸‰ ì•„ì´í…œ íŒë§¤ì²˜\n" +
                     "â€¢ /êµ¬ë§¤ [ì•„ì´í…œ] [ìˆ˜ëŸ‰] : ìƒì ì—ì„œ í†µí•© êµ¬ë§¤\n" +
                     "â€¢ /íŒë§¤ [UID] : í¬ì¼“ëª¬ì„ ê³¨ë“œë¡œ íŒë§¤\n" +
                     "â€¢ /íŒë§¤í•˜ìœ„ [N] : ë‚®ì€ ë“±ê¸‰ í¬ì¼“ëª¬ ì¼ê´„ ì •ë¦¬\n" +
                     "â€¢ /êµí™˜ [ë‹‰ë„¤ì„] [UID] : ë‹¤ë¥¸ ìœ ì €ì™€ í¬ì¼“ëª¬ ê±°ë˜\n" +
                     "â€¢ /ì†¡ê¸ˆ [ë‹‰ë„¤ì„] [ê¸ˆì•¡] : ê³¨ë“œ ë³´ë‚´ê¸°\n" +
                     "â€¢ /ì„ ë¬¼ [ë‹‰ë„¤ì„] [í…œëª…] : ì•„ì´í…œ ì„ ë¬¼í•˜ê¸°\n\n" +
                     
                     "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                     "ğŸ’¡ ëª¨ë“  í¬ì¼“ëª¬ ëŒ€ìƒ ëª…ë ¹ì–´ëŠ” 'ë³„ëª…'ì„ ì§€ì›í•©ë‹ˆë‹¤!\n" +
                     "ì˜ˆ: /ì‚¬ìš© í‘¸ë”© í”¼ì¹´ì¸„ 10\n" +
                     "ì˜ˆ: /ì„ íƒ 15 íŒŒì´ë¦¬ 42";

  replyFold(replier, guideTitle, guideContent);
  return;
}


// 3. ì§€ëŠ¥í˜• ì„¤ëª… í˜¸ì¶œ (ì¥ë¹„ ë„ê° ìš°ì„ ìˆœìœ„ ìƒí–¥ + ê°€ë…ì„± íŒ¨ì¹˜)
if (msg.indexOf("/ì„¤ëª…") === 0) {
  var keyword = msg.replace("/ì„¤ëª…", "").trim();
  if (!keyword) {
    replier.reply("ğŸ“– [ë°±ê³¼ì‚¬ì „ ì‚¬ìš©ë²•]\n/ì„¤ëª… [í‚¤ì›Œë“œ ë˜ëŠ” í¬ì¼“ëª¬ëª…]\n\nğŸ’¡ ì˜ˆ: /ì„¤ëª… ì§„í™”, /ì„¤ëª… ì´ë¸Œì´, /ì„¤ëª… ì¥ë¹„");
    return;
  }

  // [A] â˜… [ê°€ì¥ ë¨¼ì € ì²´í¬] ë“±ê¸‰ë³„ ê·¸ë£¹í™” ì¥ë¹„ ë„ê° â˜…
  // ê°€ì´ë“œë¶ë³´ë‹¤ ë„ê°ì´ ë¨¼ì € ë‚˜ì˜¤ë„ë¡ ìˆœì„œë¥¼ ë§¨ ìœ„ë¡œ ì˜¬ë ¸ìŠµë‹ˆë‹¤.
  if (keyword === "ì¥ë¹„ëª©ë¡" || keyword === "ì¥ë¹„") {
    var summary = "ğŸ›¡ï¸ ì „ì²´ ì¥ë¹„ ì•„ì´í…œ ë„ê°\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\n";
    var count = 0;
    var t4 = [], t3 = [], t2 = [], t1 = [];
    
    for (var key in EQUIP_DB) {
      var item = EQUIP_DB[key];
      var icon = item.icon || "ğŸ›¡ï¸";
      var str = icon + " " + key + "\n   â”” " + item.desc + "\n\n";
      
      if (item.tier === 4) t4.push(str);
      else if (item.tier === 3) t3.push(str);
      else if (item.tier === 2) t2.push(str);
      else t1.push(str);
      count++;
    }

    var full = "ğŸ‘‘ [4í‹°ì–´ : ë ˆì „ë“œ/íŠ¹ìˆ˜]\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + (t4.join("") || "(ì—†ìŒ)\n\n") +
               "ğŸŒŸ [3í‹°ì–´ : ìƒê¸‰/ì§„í™”ë¬¼ì§ˆ]\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + (t3.join("") || "(ì—†ìŒ)\n\n") +
               "ğŸ”¹ [2í‹°ì–´ : ì¤‘ê¸‰/ì†ì„±ê°•í™”]\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + (t2.join("") || "(ì—†ìŒ)\n\n") +
               "âšª [1í‹°ì–´ : ê¸°ì´ˆ/ê¸°ë³¸ëŠ¥ë ¥]\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + (t1.join("") || "(ì—†ìŒ)\n\n");
    
    summary += "ğŸ“Š ë“±ë¡ëœ ì¥ë¹„: ì´ " + count + "ì¢…\nğŸ‘‰ ë“±ê¸‰ë³„ ìƒì„¸ ì •ë³´ëŠ” [ì „ì²´ë³´ê¸°] í™•ì¸!\n";
    replyFold(replier, summary, full);
    return;
  }

  // [B] ê°€ì´ë“œë¶ í‚¤ì›Œë“œ ì²´í¬ (ì—”íŠ¸ë¦¬, ë³„ëª… ë“±)
  if (GUIDE_MAP[keyword]) {
    replier.reply(GUIDE_MAP[keyword]);
    return;
  } 

  // [C] ê°œë³„ ì¥ë¹„ ì •ë³´ ì²´í¬ (íŠ¹ì • ì¥ë¹„ ê²€ìƒ‰ ì‹œ)
  if (EQUIP_DB[keyword]) {
    var item = EQUIP_DB[keyword];
    replier.reply("ğŸ›¡ï¸ [ì¥ë¹„ ì •ë³´]\n" + (item.icon || "ğŸ›¡ï¸") + " " + keyword + " (" + (item.tier || 1) + "í‹°ì–´)\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ“ íš¨ê³¼: " + item.desc);
    return;
  }

  // [D] í¬ì¼“ëª¬ ìƒì„¸ ì •ë³´ (ì§„í™” ì¡°ê±´ + ì›”ë“œë³„ íšë“ì²˜ ì¤„ë°”ê¿ˆ)
  var db = findPokemonDBByName(keyword);
  if (db) {
    var pid = db.id;
    var evoRule = EVOLVE_DB[pid];
    var speciesMsg = "ğŸ” [" + db.name + "] ì¢…ì¡± ì •ë³´\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                     "ğŸ’  íƒ€ì…: " + db.type1 + (db.type2 ? " / " + db.type2 : "") + "\n" +
                     "âš”ï¸ ê¸°ë³¸ì „íˆ¬ë ¥: " + db.basePower + "\n\n";

    // --- [íšë“ì²˜ ì •ë³´ ê°€ë…ì„± ê°•í™”] ---
    var acquisitionMsg = "ğŸ“ ã€ íšë“ì²˜ ã€‘\n";
    var babyList = [172, 173, 174, 175, 236, 238, 239, 240]; 

    if (babyList.indexOf(pid) !== -1) {
      acquisitionMsg += "â” ğŸ¥š ì•Œ ë¶€í™”ë¡œ íšë“ (ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸ ì˜ˆì •)\n";
    } else if (NO_SPAWN_LIST.indexOf(pid) !== -1) {
      acquisitionMsg += "â” ì•¼ìƒ ë¯¸ë°œê²¬ (ì§„í™” ë˜ëŠ” ë ˆì´ë“œ ì „ìš©)\n";
    } else {
      var locsP = []; var locsI = [];
      if (pid <= 151) {
        var pPool = WORLD_REGIONS["íŒŒì•¼ë ˆë°”"];
        for (var i = 0; i < pPool.length; i++) {
          if (pPool[i].types.indexOf(db.type1) !== -1 || (db.type2 && pPool[i].types.indexOf(db.type2) !== -1)) locsP.push(pPool[i].key);
        }
      }
      var iPool = WORLD_REGIONS["ì´ìŠŒ"];
      for (var j = 0; j < iPool.length; j++) {
        if (iPool[j].types.indexOf(db.type1) !== -1 || (db.type2 && iPool[j].types.indexOf(db.type2) !== -1)) locsI.push(iPool[j].key);
      }
      // ì‚¬ì¥ë‹˜ ìš”ì²­ í¬ë§·: ì›”ë“œë³„ ì¤„ë°”ê¿ˆ ì ìš©
      if (locsP.length > 0) acquisitionMsg += "â” íŒŒì•¼ë ˆë°” - " + (locsP.length > 4 ? locsP.slice(0, 4).join(", ") + " ë“±" : locsP.join(", ")) + "\n";
      if (locsI.length > 0) acquisitionMsg += "â” ì´ìŠŒ - " + (locsI.length > 4 ? locsI.slice(0, 4).join(", ") + " ë“±" : locsI.join(", ")) + "\n";
      if (locsP.length === 0 && locsI.length === 0) acquisitionMsg += "â” íŠ¹ìˆ˜ ì¡°ìš° (ì´ë²¤íŠ¸ í™•ì¸)\n";
    }
    speciesMsg += acquisitionMsg + "\n";

    // --- [ì§„í™” ì¡°ê±´ ë¡œì§] ---
    if (!evoRule) {
      speciesMsg += "âœ¨ í•´ë‹¹ í¬ì¼“ëª¬ì€ ë” ì´ìƒ ì§„í™”í•˜ì§€ ì•ŠëŠ” [ìµœì¢… ë‹¨ê³„]ì…ë‹ˆë‹¤.";
    } else {
      speciesMsg += "ğŸ§¬ ã€ ì§„í™” ì¡°ê±´ ã€‘\n";
      function formatEvoLine(rule) {
        var toDb = findPokemonDB(rule.to);
        var toName = toDb ? toDb.name : "ì•Œìˆ˜ì—†ìŒ";
        var line = "â” " + toName + " : ";
        if (rule.type === "level") line += "Lv." + rule.val + " ë‹¬ì„± ì‹œ";
        else if (rule.type === "item_hold") line += "[" + rule.val + "] ì¥ì°© í›„ ë ˆë²¨ì—…";
        else if (rule.type === "friendship") line += "ì¹œë°€ë„ 220 ì´ìƒì¼ ë•Œ ë ˆë²¨ì—…";
        else if (rule.type === "friendship_day") line += "ë‚®(06~18ì‹œ)ì— ì¹œë°€ë„ 220 ì´ìƒ ë ˆë²¨ì—…";
        else if (rule.type === "friendship_night") line += "ë°¤(18~06ì‹œ)ì— ì¹œë°€ë„ 220 ì´ìƒ ë ˆë²¨ì—…";
        else if (rule.type === "trade") line += "ìœ ì €ì™€ [/êµí™˜] ì‹œ ì¦‰ì‹œ ì§„í™”";
        else if (rule.type === "trade_item") line += "[" + rule.val + "] ì¥ì°© í›„ [/êµí™˜] ì‹œ";
        return line;
      }
      if (Array.isArray(evoRule)) {
        for (var k = 0; k < evoRule.length; k++) speciesMsg += formatEvoLine(evoRule[k]) + "\n";
      } else {
        speciesMsg += formatEvoLine(evoRule) + "\n";
      }
    }
    replier.reply(speciesMsg);
    return;
  }

  replier.reply("â“ '" + keyword + "'ì— ëŒ€í•œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
}



    if (msg.indexOf("/ì¥ì°©") === 0) {
      var parts = msg.split(" ").filter(Boolean);
      var uid = parseInt(parts[1]);
      var itemName = parts[2];
      if (isNaN(uid) || !itemName) {
        replier.reply("ì‚¬ìš©ë²•: /ì¥ì°© [UID] [ì•„ì´í…œëª…]\nì˜ˆ: /ì¥ì°© 15 í˜ì˜ë¨¸ë¦¬ë ");
        return;
      }
      var p = findUserPokemonByUid(u, uid);
      if (!p) {
        replier.reply("í•´ë‹¹ í¬ì¼“ëª¬ì´ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      if (isPokemonBusy(u, p.uid)) {
        replier.reply("íƒí—˜ ì¤‘ì¸ í¬ì¼“ëª¬ì€ ì¥ë¹„ë¥¼ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      if (!u.items || !u.items[itemName] || u.items[itemName] <= 0) {
        replier.reply("ğŸ’ ê°€ë°©ì— '" + itemName + "' ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      if (!EQUIP_DB[itemName]) {
        replier.reply("ğŸš« ì°©ìš©í•  ìˆ˜ ì—†ëŠ” ì•„ì´í…œì…ë‹ˆë‹¤.");
        return;
      }
      if (p.equip) {
        u.items[p.equip] = (u.items[p.equip] || 0) + 1;        // ê¸°ì¡´ ì¥ë¹„ í•´ì œ
      }
      u.items[itemName]--;
      p.equip = itemName;
      commitSave(true);
      replier.reply("ğŸ¦¾ " + getDisplayName(p) + "ì—ê²Œ [" + itemName + "] ì¥ì°© ì™„ë£Œ!\níš¨ê³¼: " + EQUIP_DB[itemName].desc);
      return;
    }
    if (msg.indexOf("/í•´ì œ") === 0) {
      var uid = parseInt(msg.split(" ")[1]);
      var p = findUserPokemonByUid(u, uid);
      if (!p) 
        return;
      if (isPokemonBusy(u, p.uid)) {
        replier.reply("íƒí—˜ ì¤‘ì¸ í¬ì¼“ëª¬ì€ ì¥ë¹„ë¥¼ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      if (!p.equip) {
        replier.reply("ì¥ì°© ì¤‘ì¸ ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      if (!u.items) 
        u.items = {};
      u.items[p.equip] = (u.items[p.equip] || 0) + 1;
      var old = p.equip;
      p.equip = null;
      commitSave(true);
      replier.reply("ğŸ’ " + getDisplayName(p) + "ì˜ [" + old + "] ì¥ë¹„ë¥¼ í•´ì œí–ˆìŠµë‹ˆë‹¤.");
      return;
    }
  // -----------------------------------------------------------
    // ğŸª ìƒì  ì‹œìŠ¤í…œ (ì¼ë°˜ / ë‹¤ì½”íƒ€ í†µí•©)
    // -----------------------------------------------------------

    // 1. ì¼ë°˜ ìƒì  ëª©ë¡
    if (msg === "/ìƒì " || msg === "/ìƒì ëª©ë¡") {
      var shopData = getGeneralShopText(u, decoName);
      replyFold(replier, shopData.summary, shopData.full);
      return;
    }

    // 2. ë‹¤ì½”íƒ€ ìƒì  ëª©ë¡
if (msg === "/ë‹¤ì½”íƒ€ìƒì " || msg === "/ì½”ì¸ìƒì ") {
      var coin = u.dakotaCoin || 0;
      var dShop = "ğŸ° [ë‹¤ì½”íƒ€ ìƒì ]\n\"ì–´ì„œ ì˜¤ê²Œ... ì½”ì¸ë§Œ ìˆë‹¤ë©´ ë¬´ì—‡ì´ë“  íŒ”ì§€.\"\n\n" +
                  "ğŸª™ ë‚´ ì½”ì¸: " + fmtNum(coin) + "ê°œ\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\n";
      
      for (var key in DAKOTA_ITEMS) {
        var item = DAKOTA_ITEMS[key];
        dShop += item.icon + " " + key + " : " + item.price + "ì½”ì¸\n   â”” " + item.desc + "\n\n";
      }
      
      dShop += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ›’ êµ¬ë§¤ ë°©ë²•: /êµ¬ë§¤ [ì•„ì´í…œëª…] [ìˆ˜ëŸ‰]";
      replier.reply(dShop);
      return;
    }
if (msg.indexOf("/êµ¬ë§¤") === 0) {
      var parts = msg.split(" ").filter(Boolean);
      if (parts.length < 2) {
        replier.reply("ğŸ›’ [êµ¬ë§¤ ê°€ì´ë“œ]\n/êµ¬ë§¤ [ì•„ì´í…œëª…] [ìˆ˜ëŸ‰]\n\nğŸ’° ê³¨ë“œ: ëª¬ìŠ¤í„°ë³¼, ë‘ì«€ì¿ , í‘¸ë”©, ìŠ¤í”„ë ˆì´...\nğŸª™ ì½”ì¸: ìƒì, ë”¸ê¸°, ì—´ë§¤, í˜ì¸íŠ¸");
        return;
      }

      var itemInput = parts[1];
      var qty = Math.max(1, Math.min(999, parseInt(parts[2], 10) || 1));

      // [A] ë‹¤ì½”íƒ€ ì½”ì¸ ìƒí’ˆ ì²´í¬ (DAKOTA_ITEMS ê°ì²´ í™œìš©)
      var dItem = findDakotaItem(itemInput);
      if (dItem) {
        var totalC = dItem.data.price * qty;
        if ((u.dakotaCoin || 0) < totalC) {
          replier.reply("ğŸª™ ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤!\ní•„ìš”: " + fmtNum(totalC) + " / ë³´ìœ : " + fmtNum(u.dakotaCoin));
          return;
        }
        u.dakotaCoin -= totalC;
        if (!u.items) u.items = {};
        u.items[dItem.name] = (u.items[dItem.name] || 0) + qty;
        commitSave(true);
        replier.reply("ğŸ›’ [ë‹¤ì½”íƒ€] êµ¬ë§¤ ì™„ë£Œ!\n" + dItem.data.icon + " " + dItem.name + " " + qty + "ê°œë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤.\nğŸª™ ì”ì•¡: " + fmtNum(u.dakotaCoin) + "ì½”ì¸");
        return;
      }

      // [B] ì¼ë°˜ ê³¨ë“œ ìƒí’ˆ ì²´í¬ (ê¸°ì¡´ handlePurchase í˜¸ì¶œ)
      var result = handlePurchase(u, itemInput, qty);
      if (result.ok) {
        commitSave(true);
        checkAndNotifyTitles(u, replier);
        replier.reply(result.msg);
      } else {
        replier.reply(result.reason);
      }
      return;
    }
    if (msg === "/ë‚´ìœ„ì¹˜") {
      var nowWorld = getSpawnWorldName(u);
      var badgeCnt = (u.badges && u.badges.length) ? u.badges.length : 0;
      replier.reply("ğŸš‰ " + decoName + "ë‹˜ì˜ í˜„ì¬ ìœ„ì¹˜\n" + "- í˜„ì¬ ë§ˆì„: " + nowWorld + "\n" + "- ì´ë™í‹°ì¼“: " + (u.ticket || 0) + "ì¥\n" + "- ë°°ì§€: " + badgeCnt + " / 8\n\n" + "ì´ë™: /ì´ë™ íŒŒì•¼ë ˆë°” ë˜ëŠ” /ì´ë™ ì´ìŠŒ");
      return;
    }
  // ==================== [ìˆ˜ì •ë¨] ì›”ë“œ ì´ë™ (í‹°ì¼“ 100ì¥ ì†Œëª¨) ====================
  if (msg.indexOf("/ì´ë™") === 0) {
    var mParts = msg.split(" ");
    var dest = (mParts[1] || "").trim();
    
    // 1. ì…ë ¥ê°’ ì²´í¬
    if (!dest) {
      replier.reply("ì‚¬ìš©ë²•: /ì´ë™ [íŒŒì•¼ë ˆë°”|ì´ìŠŒ]\n(ë¹„ìš©: ì´ë™í‹°ì¼“ 100ì¥)");
      return;
    }

    if (dest !== "íŒŒì•¼ë ˆë°”" && dest !== "ì´ìŠŒ") {
      replier.reply("ì´ë™ ê°€ëŠ¥í•œ ë§ˆì„: íŒŒì•¼ë ˆë°”(1ì„¸ëŒ€), ì´ìŠŒ(2ì„¸ëŒ€)");
      return;
    }

    // 2. í˜„ì¬ ìœ„ì¹˜ ì²´í¬
    var curWorld = getSpawnWorldName(u);
    if (dest === curWorld) {
      replier.reply("ì´ë¯¸ [" + dest + "]ì— ìˆìŠµë‹ˆë‹¤.");
      return;
    }

    // 3. â˜… ë¹„ìš© ì²´í¬ (100ì¥)
    var COST = 100;
    if (!u.ticket || u.ticket < COST) {
      replier.reply("ğŸš« ì´ë™í‹°ì¼“ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.\ní•„ìš”: " + COST + "ì¥\në³´ìœ : " + (u.ticket||0) + "ì¥\n\nìƒì ì—ì„œ 'ì´ë™í‹°ì¼“'ì„ êµ¬ë§¤í•´ì£¼ì„¸ìš”.");
      return;
    }

    // 4. ì´ìŠŒ(2ì„¸ëŒ€) ì§„ì… ì¡°ê±´: ë°°ì§€ 8ê°œ
    if (dest === "ì´ìŠŒ") {
      var badgeCount = (u.badges && u.badges.length) ? u.badges.length : 0;
      if (badgeCount < 8) {
        replier.reply("ğŸš« ì´ìŠŒ ì´ë™ ì¡°ê±´ ë¯¸ì¶©ì¡±\n- í•„ìš”: ì²´ìœ¡ê´€ ë°°ì§€ 8ê°œ\n- í˜„ì¬: " + badgeCount + "ê°œ\n(ê´€ë™ ì§€ë°©ì„ ì œíŒ¨í•´ì•¼ ê°ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤!)");
        return;
      }
    }

    // 5. ì´ë™ ì‹¤í–‰
    u.ticket -= COST;
    u.world = dest;
    
    commitSave(true);
    
    replier.reply(
        "ğŸš† MRTë¥¼ íƒ€ê³  ê¸´ ì—¬ì •ì„ ë– ë‚©ë‹ˆë‹¤...\n" +
        "ğŸ« ì´ë™í‹°ì¼“ " + COST + "ì¥ ì†Œëª¨\n\n" +
        " ë„ì°©! ì´ê³³ì€ [" + dest + "] ì…ë‹ˆë‹¤."
    );
    return;
  }

  if (msg === "/í•„ë“œ") {
    var currentWild = getWild(d, sender);
    if (currentWild) {
      var dbOld = findPokemonDB(currentWild.pid);
      replier.reply("âš ï¸ ì´ë¯¸ í•„ë“œì— [" + (currentWild.isShiny?"âœ¨":"") + (dbOld?dbOld.name:"í¬ì¼“ëª¬") + "]ê°€ ìˆìŠµë‹ˆë‹¤!\në¨¼ì € í¬íší•˜ê±°ë‚˜ /ã…Œã…Œ í•˜ì„¸ìš”.");
      return;
    }

    var now = new Date().getTime();
    if (now - u.lastFieldAt < FIELD_COOLDOWN_MS) {
      var sec = Math.ceil((FIELD_COOLDOWN_MS - (now - u.lastFieldAt)) / 1000);
      replier.reply(decoName + "ë‹˜, " + sec + "ì´ˆ í›„ ë‹¤ì‹œ íƒìƒ‰ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
      return;
    }
    u.lastFieldAt = now;

    // â˜… [ë²„ê·¸ ìˆ˜ì •] ë³€ìˆ˜ëª… ë¶ˆì¼ì¹˜ í•´ê²° (nextFieldRegion vs nextRegion)
    var regionKey;
    var reservedRegion = u.nextFieldRegion || u.nextRegion; // ë‘˜ ì¤‘ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ ì ìš©

    if (reservedRegion) {
      regionKey = reservedRegion;
      // ì˜ˆì•½ëœ ì§€ì—­ì´ ì†í•œ ì›”ë“œë¡œ ìë™ ë³€ê²½ (ì´ìŠŒ/íŒŒì•¼ë ˆë°” ìë™ ì „í™˜)
      var targetWorld = findWorldByRegion(regionKey);
      if (targetWorld) u.world = targetWorld; 
      
      u.nextFieldRegion = null; // ì‚¬ìš© í›„ ë°˜ë“œì‹œ ì´ˆê¸°í™”
      u.nextRegion = null;
    } else {
      // ì˜ˆì•½ì´ ì—†ì„ ë•Œë§Œ í˜„ì¬ ë°©ì˜ ê¸°ë³¸ ì§€ì—­ì„ ê°€ì ¸ì˜´
      regionKey = getRoomRegion(u, d, room);
    }

    var currentWorld = getSpawnWorldName(u);
    var worldPool = (WORLD_REGIONS[currentWorld] || WORLD_REGIONS["íŒŒì•¼ë ˆë°”"]);
    var regObj = worldPool.filter(function(r) { return r.key === regionKey; })[0];
    var regionName = regObj ? regObj.name : (SPECIAL_REGIONS[regionKey] ? SPECIAL_REGIONS[regionKey].name : regionKey);

    var wildData = spawnPokemonForRegion(regionKey, currentWorld);
    var forcedShiny = (Math.random() < SHINY_PROBABILITY);

    if (u.nextSpawnPid && u.nextSpawnPid > 0) {
      wildData = findPokemonDB(u.nextSpawnPid);
      forcedShiny = !!u.nextSpawnShiny;
      u.nextSpawnPid = 0; u.nextSpawnShiny = false;
    }

    setWild(d, sender, wildData.id, forcedShiny);
    dexSeen(u, wildData.id);

    // -----------------------------------------------------------
    // â¤ï¸ [ì¹œë°€ë„ ì¶”ê°€] í•„ë“œ íƒìƒ‰ ì‹œ ì—”íŠ¸ë¦¬ ì „ì› ì¹œë°€ë„ +1
    // -----------------------------------------------------------
    if (u.party && u.party.length > 0) {
      for (var f = 0; f < u.party.length; f++) {
        var pMem = findUserPokemonByUid(u, u.party[f]);
        if (pMem) {
          pMem.friendship = Math.min(255, (pMem.friendship || 0) + 1);
        }
      }
    }

    commitSave(true);

    // -----------------------------------------------------------
    // âœ¨ [ì ì •ì„  ì—°ì¶œ] ë¾°ë¡œë¡± ê°¬ì„± + ê¹”ë”í•œ ê°•ì¡°
    // -----------------------------------------------------------
    var header = "ğŸ” ì•¼ìƒ í¬ì¼“ëª¬ ì¡°ìš°";
    var bodyText = "í‰ë²”í•œ " + wildData.name + "ì´(ê°€) ë‚˜íƒ€ë‚¬ìŠµë‹ˆë‹¤.";
    var isLegend = (wildData.rarity >= 5);

    if (forcedShiny) {
        header = "âœ¨ ë¾°ë¡œë¡±~ ìƒ‰ì´ ë‹¤ë¥¸ í¬ì¼“ëª¬ âœ¨";
        bodyText = "ğŸ’¡ ì•—! ì˜ë¡±í•œ ë¹›ê³¼ í•¨ê»˜ ã€ âœ¨" + wildData.name + " ã€‘ ì´(ê°€) ë“±ì¥í–ˆìŠµë‹ˆë‹¤!";
    } else if (isLegend) {
        header = "ğŸ”¥ ì „ì„¤ì˜ í¬ì¼“ëª¬ ê°•ë¦¼ ğŸ”¥";
        bodyText = "ğŸ“¢ ê°•ë ¥í•œ ì••ë°•ê°! ì „ì„¤ì˜ ã€ " + wildData.name + " ã€‘ ì´(ê°€) ëª¨ìŠµì„ ë“œëŸ¬ëƒˆìŠµë‹ˆë‹¤!";
    }

    var output = "ã€ " + header + " ã€‘\n" +
                 decoName + "ë‹˜ì´ " + pick(FIELD_SEARCH_LINES) + "\n\n" +
                 "ğŸ“ [ìœ„ì¹˜: " + currentWorld + " / " + regionName + "]\n" +
                 "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                 bodyText + "\n" +
                 "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                 "ğŸ’ ë³´ìœ  ë³¼\n" +
                 "- ğŸ”´ " + (u.ball || 0) + " / ğŸ”µ " + (u.superBall || 0) + " / âš« " + (u.ultraBall || 0) + "\n\n" +
                 "ğŸ¯ í¬íš: /ëª¬, /ìŠˆ, /í•˜\n" +
                 "ğŸƒ ë„ë§: /ã…Œã…Œ";

    replier.reply(output);
    return;
  }



  // -------------------- [ìµœì¢…] /ë„ë§(/ã…Œã…Œ) ëª…ë ¹ì–´ --------------------
  if (msg === "/ë„ë§" || msg === "/ã…Œã…Œ") {
    var targetW = getWild(d, sender);
    if (!targetW) {
      replier.reply("í•„ë“œì— ë§ˆì£¼ì¹œ í¬ì¼“ëª¬ì´ ì—†ê±°ë‚˜ ì´ë¯¸ ì‚¬ë¼ì¡ŒìŠµë‹ˆë‹¤.");
      return;
    }
    var dbw3 = findPokemonDB(targetW.pid);
    var pName = (dbw3 && dbw3.name) ? dbw3.name : "ì•¼ìƒ í¬ì¼“ëª¬";

    clearWild(d, sender); // ì¦‰ì‹œ ì‚­ì œ ë° ì €ì¥
    if (!u.stats.totalEscapes) u.stats.totalEscapes = 0;
    u.stats.totalEscapes++;
    commitSave(true);    

    replier.reply(sayDo(decoName, pName + "ì—ê²Œì„œ ë¬´ì‚¬íˆ ë„ë§ì³¤ìŠµë‹ˆë‹¤! ğŸƒğŸ’¨"));
    return;
  }

  // -------------------- [ìµœì¢… ê°œí¸] handleCatch í•¨ìˆ˜ (íŒŒí‹° ê²½í—˜ì¹˜ ë¶„ë°° ë²„ì „) --------------------
  function handleCatch(ballType, ballName, decoName, replier) {
    var wild = getWild(d, sender); 
    if (!wild) {
      var ex = takeExpiredWild(d, sender); 
      if (ex) {
        var dbx = findPokemonDB(ex.pid);
        replier.reply(sayDo(decoName, (dbx ? dbx.name : "í¬ì¼“ëª¬") + "ì´(ê°€) ì´ë¯¸ ë„ë§ê°”ìŠµë‹ˆë‹¤."));
        return;
      }
      replier.reply(sayDo(decoName, "í˜„ì¬ ì•¼ìƒ í¬ì¼“ëª¬ì´ ì—†ìŠµë‹ˆë‹¤.\n/í•„ë“œ ë¡œ ë¨¼ì € íƒìƒ‰í•´ ì£¼ì„¸ìš”."));
      return;
    }

    if (u.pokemons.length >= MAX_POKEMON_SLOT) {
      replier.reply("ğŸš« ê°€ë°©ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤. '/íŒë§¤í•˜ìœ„'ë¡œ ì •ë¦¬í•´ ì£¼ì„¸ìš”.");
      return;
    }

    if (!consumeBall(u, ballType)) {
      replier.reply(ballName + "ì´(ê°€) ë¶€ì¡±í•©ë‹ˆë‹¤.");
      return;
    }

    var t = tryCatch(u, wild.pid, ballType);
    var db = findPokemonDB(wild.pid);

    if (t.success) {
      clearWild(d, sender); 
      var uid = addPokemonToUser(u, wild.pid, wild.isShiny);
      
      // 1. [ì•„ì´í…œ ìŠµë“ ë¡œì§]
      var heldItemMsg = "";
      if (Math.random() < 0.15) {
          var itemRoll = Math.random();
          if (itemRoll < 0.003) { u.godBall = (u.godBall||0)+1; heldItemMsg="\nğŸ‘‘ [ëŒ€ë°•] [í‚¹ê°“ë³¼] íšë“!"; }
          else if (itemRoll < 0.10) { u.reroll = (u.reroll||0)+1; heldItemMsg="\nğŸ”„ [íšë“] [í‹°ì–´ë¦¬ì…‹ê¶Œ] íšë“!"; }
          else if (itemRoll < 0.40) { u.dopaTicket = (u.dopaTicket||0)+1; heldItemMsg="\nğŸ’³ [íšë“] [ë„íŒŒë¯¼ê°•í™”ê¶Œ] íšë“!"; }
          else { u.ball = (u.ball||0)+1; heldItemMsg="\nğŸ”´ [ì¤ì¤] ëª¬ìŠ¤í„°ë³¼ íšŒìˆ˜"; }
      }

      // 2. [ë³´ìƒ ë° ì¹œë°€ë„ ê³„ì‚°]
      var finalGold = calcCatchGold(u, db, ballType);
      var finalExp = calcCatchExp(u, db, ballType);
      u.gold += finalGold;

      // â˜… [í•µì‹¬] í¬íš ì„±ê³µ ì‹œ ì—”íŠ¸ë¦¬ ì¹œë°€ë„ +1 ë¡œì§ì„ ì—¬ê¸°ë¡œ ì´ë™
      if (u.party && u.party.length > 0) {
        for (var f = 0; f < u.party.length; f++) {
          var pMem = findUserPokemonByUid(u, u.party[f]);
          if (pMem) {
            pMem.friendship = Math.min(255, (pMem.friendship || 0) + 1);
          }
        }
      }

      // 3. [íŒŒí‹° ê²½í—˜ì¹˜ ë¶„ë°°]
      var partyGrowMsg = "";
      if (u.party && u.party.length > 0) {
        for (var i = 0; i < u.party.length; i++) {
          var pMember = findUserPokemonByUid(u, u.party[i]);
          if (pMember) {
            var lvUpNotice = gainPokemonExp(u, pMember, finalExp);
            if (lvUpNotice) partyGrowMsg += "\n" + lvUpNotice;
          }
        }
      }
      var userLvMsg = addExpWithLevelUpMsg(u, Math.floor(finalExp * 0.3));

      // 4. [ì—°ì¶œ ë©˜íŠ¸ ì„¤ì •]
      var p = findUserPokemonByUid(u, uid);
      var resHeader = "ã€ í¬íš ì„±ê³µ ã€‘";
      var resComment = "ë‚˜ì´ìŠ¤ ìºì¹˜! ìƒˆë¡œìš´ ë™ë£Œì™€ ì¸ì—°ì„ ë§ºì—ˆìŠµë‹ˆë‹¤.";

      if (wild.isShiny) {
        resHeader = "âœ¨ ë¾°ë¡œë¡±~ ì´ë¡œì¹˜ í¬íš ëŒ€ì„±ê³µ! âœ¨";
        resComment = "ğŸŒˆ ê¸°ì ì´ ì¼ì–´ë‚¬ìŠµë‹ˆë‹¤! ì˜ë¡±í•˜ê²Œ ë¹›ë‚˜ëŠ” íŠ¹ë³„í•œ ë™ë£Œë¥¼ ì–»ì—ˆìŠµë‹ˆë‹¤!!";
      } else if (db.rarity >= 5) {
        resHeader = "ğŸ”± ì „ì„¤ì˜ í¬ì¼“ëª¬ êµ´ë³µ ì„±ê³µ! ğŸ”±";
        resComment = "ğŸ”¥ ì‹ í™” ì† ì¡´ì¬ê°€ ë‹¹ì‹ ì˜ ì‹¤ë ¥ì„ ì¸ì •í–ˆìŠµë‹ˆë‹¤!!";
      }

      // 5. [ìµœì¢… ì¶œë ¥] ì¹œë°€ë„ ì •ë³´ë¥¼ ë³´ìƒ ë¼ì¸ì— ì¶”ê°€
      var resultMsg = "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                      resHeader + "\n" +
                      "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                      "ğŸ‰ " + decoName + "ë‹˜ì´ " + (wild.isShiny ? "âœ¨" : "") + db.name + " í¬íšì— ì„±ê³µ!\n\n" +
                      "âœ¨ ë“±ê¸‰: ã€ " + (p.grade || "D") + " ë“±ê¸‰ ã€‘ " + (p.grade === "S" ? "ğŸ‘‘" : "") + "\n" +
                      "ğŸ“Š ì ì¬ë ¥: í˜ " + (p.ivStr||0) + " / ì²´ " + Math.floor((p.ivHp||0)/10) + " / ë¯¼ " + (p.ivSpd||0) + "\n" +
                      "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                      "ğŸ§¬ ë‚´ í¬ì¼“ëª¬ ID #" + uid + " (Lv." + (p.lv || 1) + ")\n" +
                      "ğŸ’° ë³´ìƒ: +" + fmtNum(finalGold) + "ğŸ’° / +" + fmtNum(finalExp) + " EXP (ì „ì›)\n" +
                      "â¤ï¸ ì¹œë°€ë„: +1 (ì—”íŠ¸ë¦¬ ì „ì›)\n" + // ì‚¬ì¥ë‹˜ ìš”ì²­ ë°˜ì˜!
                      (partyGrowMsg || "") + "\n" + (userLvMsg || "") +
                      "\n" + resComment + heldItemMsg;

      replier.reply(resultMsg);
      commitSave(true); 
    } else {
      // (ì‹¤íŒ¨ ë¡œì§ ë™ì¼)
      wild.attempts = (wild.attempts || 0) + 1;
      var leftTry = Math.max(0, (wild.maxAttempts || 5) - wild.attempts);
      if (leftTry <= 0 || Math.random() < (wild.attempts * 0.1)) {
        replier.reply("ğŸ’¨ " + db.name + "ì´(ê°€) ë„ë§ê°”ìŠµë‹ˆë‹¤!");
        clearWild(d, sender); 
      } else {
        commitSave(true); 
        replier.reply("ğŸ’¥ í¬íš ì‹¤íŒ¨! " + db.name + "ì´(ê°€) ë‚ ëœë‹ˆë‹¤.\n(ë‚¨ì€ ê¸°íšŒ: ì•½ " + leftTry + "íšŒ)");
      }
    }
  }

// ğŸ¯ í¬íš ëª…ë ¹ì–´ êµ¬ì—­
    if (msg === "/ëª¬ìŠ¤í„°ë³¼" || msg === "/ëª¬" || msg === "/ã…") {
      handleCatch(0, "ëª¬ìŠ¤í„°ë³¼", decoName, replier);
      return;
    }
    if (msg === "/ìŠˆí¼ë³¼" || msg === "/ìŠˆ" || msg === "/ã……") {
      handleCatch(1, "ìŠˆí¼ë³¼", decoName, replier);
      return;
    }
    if (msg === "/í•˜ì´í¼ë³¼" || msg === "/í•˜" || msg === "/ã…") {
      handleCatch(2, "í•˜ì´í¼ë³¼", decoName, replier);
      return;
    }
    if (msg === "/ìŠˆí¼ìš¸íŠ¸ë¼í‚¹ê°“ì— í˜ëŸ¬ê°œì©ŒëŠ”í•˜ì´í¼ì±Œë¦°ì €í˜ì´ì»¤í‰ë²”í•œìš©íƒœëŠ”ë¯¸ì¹œì‚¬ëŒê°“ë¯¼ìˆ˜ë„ë¶€ë³¼") {
      handleCatch(3, "ìŠˆí¼ìš¸íŠ¸ë¼í‚¹ê°“ì— í˜ëŸ¬ê°œì©ŒëŠ”í•˜ì´í¼ì±Œë¦°ì €í˜ì´ì»¤í‰ë²”í•œìš©íƒœëŠ”ë¯¸ì¹œì‚¬ëŒê°“ë¯¼ìˆ˜ë„ë¶€ë³¼", decoName, replier);
      return;
    }
    
    if (msg.indexOf("/ì¹­í˜¸") === 0) {
      updateTitles(u);
      var parts = msg.split(" ").filter(Boolean);
      var sub = parts[1];
      // [A] ì¹­í˜¸ ë„ê° (ì „ì²´ ëª©ë¡ ë° íšë“ ì¡°ê±´ ê³µê°œ)
      if (sub === "ë„ê°") {
        var listStr = "";
        var masterList = [{
  n: "ë‰´ë¹„", 
  c: "ìœ ì € íšŒì›ê°€ì…"}, {
  n: "ì„±ì¥ ì¤‘ì¸", 
  c: "30ë ˆë²¨ ë‹¬ì„±"}, {
  n: "ê³ ì—¬ë²„ë¦°", 
  c: "100ë ˆë²¨ ë‹¬ì„±"}, {
  n: "ì§„ì§€ì¶©", 
  c: "150ë ˆë²¨ ë‹¬ì„±"}, {
  n: "ë ˆë²¨ê°’ ëª»í•˜ëŠ”", 
  c: "50ë ˆë²¨ ì´ìƒ ìŠ¹ë¥  30% ì´í•˜"}, {
  n: "ì‹¸ì›€ê¾¼ì¸", 
  c: "ë°°í‹€ 10ì—°ìŠ¹ ë‹¬ì„±"}, {
  n: "ê°•ë ¥í•œ", 
  c: "ë°°í‹€ 20ì—°ìŠ¹ ë‹¬ì„±"}, {
  n: "ë„ë¼ì´", 
  c: "ë°°í‹€ 50ì—°ìŠ¹ ë‹¬ì„±"}, {
  n: "ë°°í‹€ë§ˆìŠ¤í„°", 
  c: "ë°°í‹€ 100ì—°ìŠ¹ ë‹¬ì„±"}, {
  n: "ìµœì•½ì²´ì¸", 
  c: "ë°°í‹€ 10ì—°íŒ¨ ë‹¬ì„±"}, {
  n: "ì°ë”° ê°™ì€", 
  c: "ë°°í‹€ 20ì—°íŒ¨ ë‹¬ì„±"}, {
  n: "ë‹¤ íŒ¨ê³  ë‹¤ë‹ˆëŠ”", 
  c: "ë°°í‹€ ëˆ„ì  1,000íšŒ"}, {
  n: "ìˆ˜ì§‘ê°€", 
  c: "ì¡ì€ í¬ì¼“ëª¬ 50ì¢… ë‹¬ì„±"}, {
  n: "ìˆ˜ì§‘ì— ë¯¸ì¹œ", 
  c: "ì¡ì€ í¬ì¼“ëª¬ 130ì¢… ë‹¬ì„±"}, {
  n: "1ì„¸ëŒ€ ë§ˆìŠ¤í„°", 
  c: "ì¡ì€ í¬ì¼“ëª¬ 151ì¢… ë‹¬ì„±"}, {
  n: "ì¡ëŠ” ë§›ì„ ì•„ëŠ”", 
  c: "ë³´ìœ  í¬ì¼“ëª¬ 150ë§ˆë¦¬ ë‹¬ì„±"}, {
  n: "ì§„ì •í•œ 1ì„¸ëŒ€ ë§ˆìŠ¤í„°", 
  c: "ë„ê° 151ì¢… & ì „ì› Së“±ê¸‰"}, {
  n: "ë°±ë§Œì¥ì", 
  c: "100ë§Œ ê³¨ë“œ ë³´ìœ "}, {
  n: "ì²œë§Œì¥ì", 
  c: "1,000ë§Œ ê³¨ë“œ ë³´ìœ "}, {
  n: "ì´ë”ë¦¬ì›€ í™€ë”", 
  c: "8,000ë§Œ ê³¨ë“œ ë³´ìœ "}, {
  n: "ì¼ë¡ ë¨¸ìŠ¤í¬", 
  c: "1ì–µ 5,000ë§Œ ê³¨ë“œ ë³´ìœ "}, {
  n: "í”Œë ‰ìŠ¤", 
  c: "ìƒì  ëˆ„ì  1ì–µ ì†Œë¹„"}, {
  n: "ê°•í™” ì¤‘ë…ì", 
  c: "ê°•í™” ëˆ„ì  1ì–µ ì†Œë¹„"}, {
  n: "ë„íŒŒë¯¼ ì¤‘ë…", 
  c: "ë„íŒŒë¯¼ ê°•í™” 1,000íšŒ ì‚¬ìš©"}, {
  n: "íƒœì´ˆë§ˆì„ ëŸ¬ë²„", 
  c: "ë„íŒŒë¯¼ 0ê°• ì´ˆê¸°í™” 10íšŒ ë°œìƒ"}, {
  n: "í¬ì¼“ëª¬ ì¥ì˜ì‚¬", 
  c: "ë„íŒŒë¯¼ íŒŒê´´ 10íšŒ ë°œìƒ"}, {
  n: "êµ¬ìŠ¬ë™ì ê°™ì€", 
  c: "ëª¬/ìŠˆ/í•˜ ë³¼ 100ê°œì”© ë³´ìœ "}, {
  n: "ìš°ì‚¬ì¸ë³¼íŠ¸ ê°™ì€", 
  c: "ë„ë§ì¹˜ê¸° 1,000íšŒ ë‹¬ì„±"}, {
  n: "ë”´ë”´í•œê½‚ì¸„", 
  c: "ë¡±ìŠ¤í†¤ 60ê°• ë‹¬ì„±"}, {
  n: "í…ŒìŠ¬ë¼ ëŒ€ì£¼ì£¼", 
  c: "ì¬ë” 60ê°• ë‹¬ì„±"}, {
  n: "ê°œë§ë‚˜ë‹ˆ", 
  c: "ë§ë‚˜ë‡½ 60ê°• ë‹¬ì„±"}, {
  n: "ì«€ë“í•œ", 
  c: "ë‘ì«€ì¿  1,000ê°œ ì‚¬ìš©"}, {
  n: "ë¹›ë‚˜ëŠ” ëŒ€ë¨¸ë¦¬", 
  c: "ì´ë¡œì¹˜ í¬ì¼“ëª¬ 5ë§ˆë¦¬ ë³´ìœ "}, {
  n: "í‰ë²”í•˜ê²Œ ë¯¸ì¹œ", 
  c: "ì „ì„¤ì˜ ë³¼ ëˆ„ì  3ê°œ êµ¬ë§¤"}, {
  n: "ìµœì •ìƒì— ì˜¬ë¼ë³¸", 
  c: "ğŸ† ì±”í”¼ì–¸ ë“±ê·¹ ì„±ê³µ"}, {
  n: "ì‹œì¦Œ íŒ¨ì™•", 
  c: "ğŸ¥‡ ë°°í‹€ ë­í‚¹ ì‹œì¦Œ 1ìœ„ (ì „ì„¤)"}];
        var collected = 0;
        for (var i = 0; i < masterList.length; i++) {
          var item = masterList[i];
          var has = (u.titles.indexOf(item.n) !== -1);
          if (has) {
            collected++;
            listStr += (i + 1) + ". âœ… " + item.n + " (" + item.c + ")\n";
          } else {
            listStr += (i + 1) + ". ğŸ”’ " + item.n + " (ë¯¸íšë“)\n";
          }
        }
        var rate = Math.floor((collected / masterList.length) * 100);
        replier.reply("ğŸ·ï¸ " + sender + "ë‹˜ì˜ ì¹­í˜¸ ë„ê°\n" + "ìˆ˜ì§‘ë¥ : " + rate + "% (" + collected + "/" + masterList.length + ")\n" + "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + listStr + "\n" + "ğŸ’¡ íšë“í•œ ì¹­í˜¸ë§Œ ìƒì„¸ ì¡°ê±´ì´ ê³µê°œë©ë‹ˆë‹¤!");
        return;
      }
      if (sub) {
        var targetTitle = "";
        var num = parseInt(sub, 10);
        if (!isNaN(num)) {
          var idx = num - 1;
          if (idx >= 0 && idx < u.titles.length) {
            targetTitle = u.titles[idx];
          } else {
            replier.reply("ğŸš« í•´ë‹¹ ë²ˆí˜¸ì˜ ì¹­í˜¸ë¥¼ ë³´ìœ í•˜ê³  ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.");
            return;
          }
        } else {
          targetTitle = parts.slice(1).join(" ");
          if (u.titles.indexOf(targetTitle) === -1 && u.titles.indexOf(targetTitle + "ì¸") !== -1) {
            targetTitle = targetTitle + "ì¸";
          }
        }
        if (u.titles.indexOf(targetTitle) !== -1) {
          u.activeTitle = targetTitle;
          commitSave(true);
          replier.reply("ğŸ·ï¸ ì¹­í˜¸ ì¥ì°© ì™„ë£Œ!\nì´ì œë¶€í„° '" + targetTitle + " " + sender + "'ë‹˜ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.");
        } else {
          replier.reply("ğŸš« ë³´ìœ í•˜ì§€ ì•Šì€ ì¹­í˜¸ì…ë‹ˆë‹¤.");
        }
        return;
      }
      var myStr = "";
      for (var j = 0; j < u.titles.length; j++) {
        var tName = u.titles[j];
        var mark = (tName === u.activeTitle) ? "âœ…" : "â¬œ";
        myStr += (j + 1) + ". " + mark + " " + tName + "\n";
      }
      replier.reply("ğŸ·ï¸ " + sender + "ë‹˜ì˜ ë³´ìœ  ì¹­í˜¸ ëª©ë¡\n" + "í˜„ì¬ ì¥ì°©: " + (u.activeTitle || "ë‰´ë¹„") + "\n\n" + myStr + "\n" + "ğŸ’¡ ì‚¬ìš©ë²•: /ì¹­í˜¸ [ë²ˆí˜¸]\n" + "ğŸ’¡ ì „ì²´ ëª©ë¡ í™•ì¸: /ì¹­í˜¸ ë„ê°");
      return;
    }
    if (msg.indexOf("/ë„ê°") === 0 || msg.indexOf("/ë„ê°2") === 0) {
      var isGen2 = (msg.indexOf("/ë„ê°2") === 0);
      var cmdPrefix = isGen2 ? "/ë„ê°2" : "/ë„ê°";
      var dexMode = isGen2 ? 2 : 1;

      var t = getTargetFromMsg(d, sender, msg, cmdPrefix);
      if (!t) { replier.reply("ğŸš« ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ìœ ì €ì…ë‹ˆë‹¤."); return; }
      
      var target = t.user;
      var targetName = t.name;
      ensureUserDex(target);

      var dexDb = ALL_POKEMON_DB.filter(function(p) {
          return dexMode === 2 ? p.id > 151 : p.id <= 151;
      });

      var total = dexDb.length;
      var uniqueCaught = 0;
      var shinyCount = 0;

      for (var i = 0; i < total; i++) {
        var pid = String(dexDb[i].id);
        var rec = target.dex[pid];
        if (rec && rec.caught > 0) {
          uniqueCaught++;
          if (rec.hasShiny) shinyCount++;
        }
      }

      var rate = (total === 0) ? 0 : (Math.floor((uniqueCaught / total) * 1000) / 10);
      
      // âœ… [ìš”ì•½ë³¸] ì˜¤ì§ í†µê³„ ì •ë³´ë§Œ ë‹´ìŠµë‹ˆë‹¤. (ì±„íŒ…ì°½ ê°€ë…ì„± ìµœìš°ì„ )
      var summary = "ğŸ“– " + targetName + "ë‹˜ì˜ " + (dexMode === 2 ? "2ì„¸ëŒ€" : "1ì„¸ëŒ€") + " ë„ê°\n" +
                    "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                    "âœ… ìˆ˜ì§‘ë¥ : " + uniqueCaught + " / " + total + " (" + rate + "%)\n" +
                    "âœ¨ ì´ë¡œì¹˜: " + shinyCount + "ì¢…\n" +
                    "ğŸ‘‰ ìƒì„¸ ëª©ë¡ì€ [ì „ì²´ë³´ê¸°] í™•ì¸\n" +
                    "ğŸ’¡ ì „í™˜: /ë„ê° (1ì„¸ëŒ€), /ë„ê°2 (2ì„¸ëŒ€)";

      // âœ… [ì „ì²´ë³´ê¸° ë‚´ìš©] ëª©ë¡ì˜ ì œëª©ë¶€í„° ì•„ë˜ ë£¨í”„ê¹Œì§€ ëª¨ë‘ ì—¬ê¸°ì— ë‹´ìŠµë‹ˆë‹¤.
      var full = "\n[" + (dexMode === 2 ? "2ì„¸ëŒ€ í¬ì¼“ëª¬" : "1ì„¸ëŒ€ í¬ì¼“ëª¬") + " ë„ê° ì „ì²´ ë¦¬ìŠ¤íŠ¸]\n" +
                 "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n";
      
      for (var j = 0; j < dexDb.length; j++) {
        var pp = dexDb[j];
        var pid = String(pp.id);
        var rec = target.dex[pid] || { seen: 0, caught: 0, maxGrade: "" };
        var mark = rec.caught ? "âœ”" : (rec.seen ? "ğŸ‘€" : "â–¡");
        var infoMsg = "";
        
        if (rec.caught) {
          var grade = rec.maxGrade || "D";
          var star = (rec.hasShiny) ? " âœ¨" : "";
          infoMsg = " [" + grade + "]" + (grade === "S" ? "ğŸ‘‘" : "") + star;
        }
        full += mark + " #" + pp.id + " " + pp.name + infoMsg + "\n";
      }

      replyFold(replier, summary, full);
      return;
    }


    if (msg.indexOf("/ì´ë¡œì¹˜") === 0 || msg.indexOf("/ì´ë¡œì¹˜2") === 0) {
      // 1. ì„¸ëŒ€ ë° ëª…ë ¹ì–´ ì •ë³´ íŒë³„
      var isGen2 = (msg.indexOf("/ì´ë¡œì¹˜2") === 0);
      var cmdPrefix = isGen2 ? "/ì´ë¡œì¹˜2" : "/ì´ë¡œì¹˜";
      var shinyDb = isGen2 ? POKEMON_DB_GEN2 : POKEMON_DB;

      // 2. íƒ€ê²Ÿ ìœ ì € ì°¾ê¸° (getTargetFromMsg í™œìš©)
      var t = getTargetFromMsg(d, sender, msg, cmdPrefix);
      if (!t) {
        replier.reply("ğŸš« ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ìœ ì €ì…ë‹ˆë‹¤.\nì‚¬ìš©ë²•: " + cmdPrefix + " [ë‹‰ë„¤ì„]");
        return;
      }
      
      var target = t.user;
      var targetName = t.name;

      // 3. ë„ê° ë°ì´í„° ê¸°ì´ˆí™”
      ensureUserDex(target);

      // 4. [í•µì‹¬] ê°€ë°©-ë„ê° ì´ë¡œì¹˜ ë°ì´í„° ê°•ì œ ë™ê¸°í™”
      // ê°€ë°©ì— ì´ë¡œì¹˜ê°€ ìˆëŠ”ë° ë„ê°ì— ì²´í¬ê°€ ì•ˆ ëœ ê²½ìš°ë¥¼ ì „ìˆ˜ì¡°ì‚¬í•˜ì—¬ ë„ì¥ì— ì¾… ì°ì–´ì¤ë‹ˆë‹¤.
      if (target.pokemons) {
        for (var k = 0; k < target.pokemons.length; k++) {
          var p = target.pokemons[k];
          if (p.shiny) {
            var pidStr = String(p.pid);
            if (!target.dex[pidStr]) {
              target.dex[pidStr] = { seen: 0, caught: 1, maxGrade: p.grade || "D", hasShiny: true };
            } else {
              target.dex[pidStr].hasShiny = true;
            }
          }
        }
      }

      // 5. ì´ë¡œì¹˜ ìˆ˜ì§‘ ëª©ë¡ ì¶”ì¶œ
      var myShinies = [];
      for (var i = 0; i < shinyDb.length; i++) {
        var db = shinyDb[i];
        var pid = String(db.id);
        if (target.dex[pid] && target.dex[pid].hasShiny) {
          myShinies.push(db);
        }
      }

      // 6. ê²°ê³¼ ì¶œë ¥ (ìš”ì•½ ë° ëª©ë¡ ë¶„ë¦¬)
      var totalShiny = shinyDb.length;
      var collectedCount = myShinies.length;
      var rate = (totalShiny === 0) ? 0 : Math.floor((collectedCount / totalShiny) * 1000) / 10;

      var summary = "âœ¨ " + targetName + "ë‹˜ì˜ ìƒ¤ì´ë‹ˆ ì»¬ë ‰ì…˜ (" + (isGen2 ? "2ì„¸ëŒ€" : "1ì„¸ëŒ€") + ")\n" +
                    "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                    "ğŸ† ìˆ˜ì§‘ í˜„í™©: " + collectedCount + " / " + totalShiny + " (" + rate + "%)\n\n" +
                    "ì „ì²´ë³´ê¸°ë¡œ íšë“í•œ ì´ë¡œì¹˜ ë¦¬ìŠ¤íŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.\n" +
                    "ğŸ’¡ ì „í™˜: /ì´ë¡œì¹˜ (1ì„¸ëŒ€), /ì´ë¡œì¹˜2 (2ì„¸ëŒ€)";

      var full = "[" + targetName + "ë‹˜ì˜ ì´ë¡œì¹˜ íšë“ ë¦¬ìŠ¤íŠ¸]\n" +
                 "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n";
      
      if (collectedCount === 0) {
        full += "(ì•„ì§ ë°œê²¬í•œ ì´ë¡œì¹˜ í¬ì¼“ëª¬ì´ ì—†ìŠµë‹ˆë‹¤.)";
      } else {
        for (var m = 0; m < myShinies.length; m++) {
          var s = myShinies[m];
          full += "ğŸŒŸ #" + s.id + " " + s.name + "\n";
        }
      }

      // ì‚¬ì¥ë‹˜ì˜ 'ì ‘ê¸° ì „ìš©' í•¨ìˆ˜ë¡œ ê¹”ë”í•˜ê²Œ ì „ì†¡
      replyFold(replier, summary, full);
      return;
    }


    if (msg === "/íƒí—˜ì·¨ì†Œ") {
      if (!u.exploration) {
        replier.reply("í˜„ì¬ íƒí—˜ ì¤‘ì¸ í¬ì¼“ëª¬ì´ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      var pEx = findUserPokemonByUid(u, u.exploration.uid);
      var pName = pEx ? getDisplayName(pEx) : "ì•Œ ìˆ˜ ì—†ëŠ” í¬ì¼“ëª¬";
      delete u.exploration;
      commitSave(true);
      replier.reply("â†©ï¸ íƒí—˜ì„ ì·¨ì†Œí•˜ê³  ê¸´ê¸‰ ë³µê·€ ëª…ë ¹ì„ ë‚´ë ¸ìŠµë‹ˆë‹¤.\n\n" + "ğŸƒ " + decoName + "ë‹˜ì˜ " + pName + "ì´(ê°€) ë¹ˆì†ìœ¼ë¡œ í—ë ˆë²Œë–¡ ëŒì•„ì™”ìŠµë‹ˆë‹¤.\n" + "âš ï¸ ì¤‘ë„ í¬ê¸°ë¡œ ì¸í•´ ì•„ë¬´ëŸ° ë³´ìƒë„ íšë“í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
      return;
    }
    if (msg.indexOf("/íƒí—˜") === 0) {
      var now = new Date().getTime();
      var parts = msg.split(" ").filter(Boolean);
      var EXPLORE_TIME_MS = 30 * 60 * 1000;

      // -----------------------------------------------------------
      // [A] íƒí—˜ ë³µê·€ ë° ì‹¤ì‹œê°„ ì§„í–‰ ìƒíƒœ (ë‹¤ì´ë‚˜ë¯¹ ì—°ì¶œ)
      // -----------------------------------------------------------
      if (u.exploration) {
        var diff = u.exploration.endAt - now;
        var pEx = findUserPokemonByUid(u, u.exploration.uid);
        var pName = pEx ? getDisplayName(pEx) : "ì•Œ ìˆ˜ ì—†ëŠ” í¬ì¼“ëª¬";

        // 1. ì•„ì§ íƒí—˜ ì¤‘ì¼ ë•Œ (ë‹¤ì´ë‚˜ë¯¹ ìƒíƒœì°½)
        if (diff > 0) {
          var info = getExploreProgress(u, pEx);
          var statusMsg = "ğŸ§­ " + decoName + "ë‹˜ì˜ #" + u.exploration.uid + " " + pName + " ëŒ€ëª¨í—˜ ì¤‘!\n" +
                          "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                          "ğŸ“ í˜„ì¬ ìœ„ì¹˜: " + info.stage + "\n" +
                          "ğŸ“Š ì§„í–‰ë„: [" + info.bar + "] " + info.progress + "%\n" +
                          "â³ ë‚¨ì€ ì‹œê°„: " + info.min + "ë¶„ " + info.sec + "ì´ˆ\n" +
                          "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                          "ğŸ’¡ " + pName + "ì´(ê°€) ì—´ì‹¬íˆ ì£¼ë³€ì„ ì¡°ì‚¬í•˜ê³  ìˆìŠµë‹ˆë‹¤!";
          replier.reply(statusMsg);
          return;
        }

        // 2. íƒí—˜ ì™„ë£Œ! (ë³´ìƒ ì •ì‚° ë° ë£¨íŠ¸ ë¦¬í¬íŠ¸)
        var isJackpot = (u.exploration.routes.indexOf("ëƒ¥ì¹˜ì˜ ë°©") !== -1 || u.exploration.routes.indexOf("ë‹¤ì½”íƒ€") !== -1);
        var finalGold = calcExploreGold(u);
        var finalExp = calcExploreExp();
        
        if (isJackpot) { finalGold *= 3; finalExp *= 3; u.dakotaCoin = (u.dakotaCoin || 0) + randInt(30, 80); }

        u.gold += finalGold;
        var pExpGain = Math.floor(finalExp * 0.8);
        var pLvMsg = gainPokemonExp(u, pEx, pExpGain);
        var trainerExpGain = Math.floor(pExpGain * 0.3);
        var userLvMsg = addExpWithLevelUpMsg(u, trainerExpGain);

        // ì•„ì´í…œ ë£¨íŒ… ë¡œì§
        var itemLog = "";
        var lootCount = Math.max(3, Math.min(8, 3 + (pEx.grade === 'S' ? 2 : 0) + randInt(-1, 1)));
        for (var i = 0; i < lootCount; i++) {
          var rVal = Math.random();
          if (rVal < 0.05) { u.reroll = (u.reroll || 0) + 1; itemLog += "ğŸ”„ í‹°ì–´ë¦¬ì…‹ê¶Œ +1\n"; }
          else if (rVal < 0.12) { u.cookie = (u.cookie || 0) + 1; itemLog += "ğŸª ë‘ì«€ì¿  +1\n"; }
          else if (rVal < 0.25) { u.dopaTicket = (u.dopaTicket || 0) + 1; itemLog += "ğŸ’³ ë„íŒŒë¯¼ê°•í™”ê¶Œ +1\n"; }
          else if (rVal < 0.40) { u.ticket = (u.ticket || 0) + 1; itemLog += "ğŸ« ì´ë™í‹°ì¼“ +1\n"; }
          else if (rVal < 0.60) { u.ultraBall = (u.ultraBall || 0) + randInt(1, 3); itemLog += "âš« í•˜ì´í¼ë³¼ ë³´ê¸‰\n"; }
          else if (rVal < 0.80) { u.superBall = (u.superBall || 0) + randInt(3, 7); itemLog += "ğŸ”µ ìŠˆí¼ë³¼ ë³´ê¸‰\n"; }
          else { u.ball = (u.ball || 0) + randInt(5, 15); itemLog += "ğŸ”´ ëª¬ìŠ¤í„°ë³¼ ë³´ê¸‰\n"; }
        }

        // ì­íŒŸ ë£¨íŠ¸ ìƒì„¸ ë©˜íŠ¸ ì¶”ê°€
        var routeSummary = "ğŸ“ [íƒí—˜ ë£¨íŠ¸ ì •ì‚°]\nâ” " + u.exploration.routes[0] + " ì™¸ " + (u.exploration.routes.length - 1) + "ê³³ ì¡°ì‚¬\n";
        if (isJackpot) routeSummary += "ğŸ° [JACKPOT] ìˆ¨ê²¨ì§„ ì„±ì—­(ëƒ¥ì¹˜/ë‹¤ì½”íƒ€) ë°œê²¬!\n";

        var resultMsg = "ğŸ‰ " + decoName + "ë‹˜ì˜ " + pName + " íƒí—˜ ë³µê·€!\n" +
                        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                        routeSummary + "\n" +
                        "ğŸ’° íšë“ ê³¨ë“œ: +" + fmtNum(finalGold) + "ğŸ’°\n" +
                        "âœ¨ ê²½í—˜ì¹˜: PokÃ© +" + fmtNum(pExpGain) + " / Trainer +" + fmtNum(trainerExpGain) + "\n\n" +
                        "ğŸ [íšë“ ì „ë¦¬í’ˆ]\n" + (itemLog || "ì•„ì´í…œ ì—†ìŒ\n") + "\n" +
                        "ğŸ’ª [ì„±ì¥ ë³´ê³ ]\n" + (pLvMsg || "(ê²½í—˜ì¹˜ íšë“)") + "\n" +
                        (userLvMsg ? (userLvMsg + "\n") : "") +
                        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + "ìˆ˜ê³ í–ˆì–´! í‘¹ ì‰¬ë ´.";

        delete u.exploration;
        commitSave(true);
        checkAndNotifyTitles(u, replier);
        replier.reply(resultMsg); 
        return;
      }

      // -----------------------------------------------------------
      // [B] íƒí—˜ ë– ë‚˜ê¸° ë¡œì§ (ë³„ëª… ë° UID ì§€ëŠ¥í˜• ê²€ìƒ‰ ì§€ì›)
      // -----------------------------------------------------------
      var pInput = parts[1];
      if (!pInput) {
        replier.reply("ğŸ’ ëˆ„êµ¬ë¥¼ ëŒ€ëª¨í—˜ì— ë³´ë‚¼ê¹Œìš”?\nì‚¬ìš©ë²•: /íƒí—˜ [ë³„ëª…/UID]\nì˜ˆ: /íƒí—˜ í”¼ì¹´ì¸„\n\nğŸ’¡ 30ë¶„ ì†Œìš” / ê°•í•œ í¬ì¼“ëª¬ì¼ìˆ˜ë¡ ë” ì¢‹ì€ ë³´ìƒì„ ê°€ì ¸ì˜µë‹ˆë‹¤!");
        return;
      }

      var pStart = findPokemonByAny(u, pInput);
      if (!pStart) { replier.reply("ğŸš« [" + pInput + "] í¬ì¼“ëª¬ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
      if (u.gymTeam && u.gymTeam.indexOf(pStart.uid) !== -1) { replier.reply("ğŸš« [ì²´ìœ¡ê´€ ì„ ë°œëŒ€]ëŠ” íƒí—˜ ë¶ˆê°€"); return; }
      if (u.champTeam && u.champTeam.indexOf(pStart.uid) !== -1) { replier.reply("ğŸš« [ì±”í”¼ì–¸ ì„ ë°œëŒ€]ëŠ” íƒí—˜ ë¶ˆê°€"); return; }

      // â˜… [ì›”ë“œë³„ ì „ìš© í•„ë“œ ë£¨íŠ¸ ìƒì„±] ì•ˆì „ì¥ì¹˜ ì¶”ê°€
      var worldName = getSpawnWorldName(u) || "íŒŒì•¼ë ˆë°”";
      var worldPool = WORLD_REGIONS[worldName] || WORLD_REGIONS["íŒŒì•¼ë ˆë°”"];
      
      var possibleRegions = [];
      for (var k = 0; k < worldPool.length; k++) {
        possibleRegions.push(worldPool[k].key);
      }

      var routeCount = randInt(3, 5);
      var routes = [];
      for (var r = 0; r < routeCount; r++) {
        routes.push(randomPick(possibleRegions));
      }

      var hasMap = (pStart.equip === "ìŠ¤íŒŒê²Œí‹°ì˜ì§€ë„");
      if (Math.random() < (hasMap ? 0.25 : 0.1)) {
        routes.push(Math.random() < 0.5 ? "ëƒ¥ì¹˜ì˜ ë°©" : "ë‹¤ì½”íƒ€");
      }

      u.exploration = {
        uid: pStart.uid,
        routes: routes,
        region: routes[0],
        startAt: now,
        endAt: now + EXPLORE_TIME_MS
      };
      
      commitSave(true);
      
      var pNameStart = getDisplayName(pStart);
      var displayRegionName = (worldPool.filter(function(r){ return r.key === routes[0]; })[0] || {name: routes[0]}).name;

      replier.reply("ğŸ’ " + decoName + "ë‹˜ì˜ " + pNameStart + " ëŒ€ëª¨í—˜ ì¶œë°œ!\n" +
                    "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                    "ğŸ“… ì˜ˆì • ê²½ë¡œ: " + displayRegionName + " ì™¸ " + (routes.length - 1) + "ê³³\n" +
                    "â³ ì†Œìš” ì‹œê°„: 30ë¶„\n" +
                    "ğŸ“ ì¶œë°œ ì›”ë“œ: " + worldName + "\n" +
                    "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                    "ğŸ‘‹ \"ë‹¤ë…€ì˜¤ê² ìŠµë‹ˆë‹¤! ë§ì´ ì£¼ì›Œì˜¬ê²Œìš”!\"");
      return;
    }



    if (msg === "/ì „ì ") {
      ensureUserStats(u);
      var total = u.stats.battleWin + u.stats.battleLose + u.stats.battleDraw;
      if (total === 0) {
        replier.reply("ì•„ì§ ë°°í‹€ ì „ì ì´ ì—†ìŠµë‹ˆë‹¤.\n/ë°°í‹€ ë¡œ ì²« ì „íˆ¬ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”.");
        return;
      }
      replier.reply(sender + "ë‹˜ì˜ ë°°í‹€ ì „ì \n\n" + formatRecord(u));
      return;
    }
    if (msg.indexOf("/ê°•í™”") === 0) {
      var nowE = nowMs();
      if (nowE - u.lastEnhanceAt < ENHANCE_COOLDOWN_MS) {
        var remain = ENHANCE_COOLDOWN_MS - (nowE - u.lastEnhanceAt);
        var sec = Math.ceil(remain / 1000);
        replier.reply(sayDo(decoName, pick(COOLDOWN_LINES)) + "\nâ³ " + sec + "ì´ˆ í›„ ë‹¤ì‹œ ì‹œë„ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        return;
      }
      u.lastEnhanceAt = nowE;

      var parts = msg.split(" ").filter(Boolean);
      var input = parts[1];
      if (!input) { replier.reply("ğŸ“ ì‚¬ìš©ë²•: /ê°•í™” [UID ë˜ëŠ” ë³„ëª…]"); return; }
      
      // â˜… ì§€ëŠ¥í˜• ê²€ìƒ‰ ì ìš©
      var p = findPokemonByAny(u, input);
      if (!p) { replier.reply("ğŸš« '" + input + "' í¬ì¼“ëª¬ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
      
      if (isPokemonBusy(u, p.uid)) { replier.reply("ğŸš« í¬ì¼“ëª¬ì´ íƒí—˜ ì¤‘ì…ë‹ˆë‹¤."); return; }
      if (p.enh >= ENHANCE_MAX) { replier.reply("ì´ë¯¸ ìµœëŒ€ ê°•í™” ë‹¨ê³„ì…ë‹ˆë‹¤."); return; }

      var dbp = findPokemonDB(p.pid);
      var nextEnh = (p.enh || 0) + 1;
      var rarity = dbp ? dbp.rarity : 2;
      var cost = enhanceCostByRarity(nextEnh, rarity);

      if (u.gold < cost) {
        replier.reply(sender + "ë‹˜, ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.\ní•„ìš”: " + fmtNum(cost) + "ğŸ’°");
        return;
      }

      u.gold -= cost;
      if (!u.stats.totalSpentEnhance) u.stats.totalSpentEnhance = 0;
      u.stats.totalSpentEnhance += cost;

      var rates = enhanceRatesByRarity(nextEnh, u.trainerLv, rarity);
      var rVal = Math.random();
      var resultType = (rVal < rates.success) ? ENH_RESULT_UP : (rVal < rates.success + rates.keep) ? ENH_RESULT_KEEP : ENH_RESULT_DOWN;

      var before = p.enh;
      if (resultType === ENH_RESULT_UP) p.enh = nextEnh;
      else if (resultType === ENH_RESULT_DOWN) p.enh = Math.max(0, before - 1);

      commitSave(true);
      replier.reply(buildEnhResultMsg(sender, p, before, p.enh, resultType) + buildNextEnhInfoLine(p, resultType, u));
      return;
    }


    if (msg === "/ì¶œì„" || msg === "/ì¶œì„ì²´í¬") {
      var r = doAttendanceCheck(u, sender);
      // ì¶œì„ ì„±ê³µ ì‹œ ì±”í”¼ì–¸ ì²´í¬
      if (r.ok) {
        // í˜„ì¬ ì±”í”¼ì–¸ì´ ë‚˜(sender)ì´ê³ , NPCê°€ ì•„ë‹ˆë¼ë©´?
        if (d.champion && d.champion.name === sender && !d.champion.isNpc) {
          // 1. í‚¹ê°“ë³¼ 1ê°œ
          u.godBall = (u.godBall || 0) + 1;
          // 2. ë‹¤ì½”íƒ€ ì½”ì¸ 300ê°œ
          u.dakotaCoin = (u.dakotaCoin || 0) + 300;
          r.msg += "\n\nğŸ‘‘ [ì±”í”¼ì–¸ íŠ¹ì „]\nì„œë²„ì˜ ì§€ë°°ìì—ê²Œ ì¡°ê³µì´ ë„ì°©í–ˆìŠµë‹ˆë‹¤.\nğŸ í‚¹ê°“ë³¼ +1ê°œ\nğŸª™ ë‹¤ì½”íƒ€ ì½”ì¸ +300ê°œ";
        }
      }
      commitSave(true);
      replier.reply(r.msg);
      return;
    }
    if (msg.indexOf("/ë„íŒŒë¯¼") === 0) {
      var parts = msg.split(" ").filter(Boolean);
      var input = parts[1];
      if (!input) { replier.reply("ğŸ“ ì‚¬ìš©ë²•: /ë„íŒŒë¯¼ [UID ë˜ëŠ” ë³„ëª…]"); return; }

      var pD = findPokemonByAny(u, input);
      if (!pD) { replier.reply("ğŸš« '" + input + "' í¬ì¼“ëª¬ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
      
      if (isPokemonBusy(u, pD.uid)) { replier.reply("ğŸš« íƒí—˜ ì¤‘ì¸ í¬ì¼“ëª¬ì…ë‹ˆë‹¤."); return; }
      if (pD.enh >= ENHANCE_MAX) { replier.reply("ì´ë¯¸ ìµœëŒ€ ê°•í™” ë‹¨ê³„ì…ë‹ˆë‹¤."); return; }
      if (!u.dopaTicket || u.dopaTicket <= 0) { replier.reply("ë„íŒŒë¯¼ê°•í™”ê¶Œì´ ì—†ìŠµë‹ˆë‹¤."); return; }

      u.dopaTicket--;
      u.stats.totalDopaUsed = (u.stats.totalDopaUsed || 0) + 1;
      var before = pD.enh || 0;
      var pNameD = getDisplayName(pD);
      var roll = Math.random();
      var header = "ğŸ° ë„íŒŒë¯¼ ê°•í™” ì‹œë„!\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\n";

      if (roll < 0.01) { // íŒŒê´´
        var idxD = u.pokemons.indexOf(pD);
        if (idxD >= 0) u.pokemons.splice(idxD, 1);
        u.stats.totalDopaDestroy = (u.stats.totalDopaDestroy || 0) + 1;
        replier.reply(header + "ğŸ’€ [íŒŒê´´] ğŸ’€\n\në„íŒŒë¯¼ ê³¼ë¶€í•˜ë¡œ í¬ì¼“ëª¬ì´ ì†Œë©¸í–ˆìŠµë‹ˆë‹¤!");
      } else if (roll < 0.41) { // ëŒ€ì„±ê³µ
        var upAmount = randInt(2, 10);
        pD.enh = Math.min(ENHANCE_MAX, before + upAmount);
        replier.reply(header + "ğŸš€ [ëŒ€ì„±ê³µ] ğŸš€\n\n" + pNameD + ": " + before + "ê°• â†’ " + pD.enh + "ê°•!");
      } else if (roll < 0.71) { // ìœ ì§€
        replier.reply(header + "ğŸ’¨ [ìœ ì§€] ğŸ’¨\n\n" + pNameD + ": " + before + "ê°• ìœ ì§€!");
      } else { // í•˜ë½
        var downAmount = randInt(2, 10);
        pD.enh = Math.max(0, before - downAmount);
        replier.reply(header + "ğŸ“‰ [í•˜ë½] ğŸ“‰\n\n" + pNameD + ": " + before + "ê°• â†’ " + pD.enh + "ê°•...");
      }
      commitSave(true);
      return;
    }


    if (msg === "/ë°°í‹€" || msg.indexOf("/ë°°í‹€ ") === 0) {
      ensureUserStats(u);
      // âœ… í•¨ìˆ˜ ì¡´ì¬ ì²´í¬ (ìš”ì¦˜ ë„ˆ ì—ëŸ¬ ë‚œ í•µì‹¬ì´ ì´ê±°ì˜€ìŒ)
      if (typeof getBattleEligiblePokemons !== "function") {
        replier.reply("ë°°í‹€ ì‹œìŠ¤í…œ ë¡œë”© ì˜¤ë¥˜: getBattleEligiblePokemons í•¨ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.\në°°í‹€ ìœ í‹¸ í•¨ìˆ˜ ì˜ì—­ì— í•´ë‹¹ í•¨ìˆ˜ê°€ ì„ ì–¸ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.");
        return;
      }
      var nowB = nowMs();
      if (nowB - u.stats.lastBattleAt < BATTLE_COOLDOWN_MS) {
        replier.reply(cooldownRemainMsg(sender, u.stats.lastBattleAt, BATTLE_COOLDOWN_MS, "ë°°í‹€"));
        return;
      }
      u.stats.lastBattleAt = nowB;
      // /ë°°í‹€ #33 ì²˜ëŸ¼ uid ì§€ì • ê°€ëŠ¥
      var pickUid = null;
      if (msg !== "/ë°°í‹€") {
        var arg = msg.substring(3).trim();        // "/ë°°í‹€" ê¸¸ì´ 3
        arg = arg.replace("#", "").trim();
        pickUid = parseInt(arg, 10);
        if (isNaN(pickUid)) {
          replier.reply("ì‚¬ìš©ë²•: /ë°°í‹€ ë˜ëŠ” /ë°°í‹€ #ë²ˆí˜¸\nì˜ˆ) /ë°°í‹€ #33\n/ë‚´í¬ì¼“ëª¬ ì—ì„œ #ë²ˆí˜¸ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.");
          commitSave(false);
          return;
        }
        if (isPokemonBusy(u, pickUid)) {
          replier.reply("ğŸš« í•´ë‹¹ í¬ì¼“ëª¬ì€ í˜„ì¬ íƒí—˜ ì¤‘ì…ë‹ˆë‹¤.\në°°í‹€ì— ì°¸ê°€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          commitSave(false);          // ì¿¨íƒ€ì„ì€ ëŒë ¤ì£¼ì§€ ì•ŠìŒ (ì‹¤ìˆ˜ ë°©ì§€)
          return;
        }
      }
      var r1 = runSingleBattle(d, room, sender, u, pickUid);
      if (!r1.ok) {
        commitSave(false);
        replier.reply(r1.msg);
        return;
      }
      commitSave(true);
      checkAndNotifyTitles(u, replier);
      replyFold(replier, r1.summary, r1.full);
      return;
    }
    
    if (msg.indexOf("/ëª¨ì˜ë°°í‹€") === 0) {
      var parts = msg.split(" ").filter(Boolean);
      if (parts.length < 3) {
        replier.reply("âš”ï¸ [ëª¨ì˜ ë°°í‹€]\në‚´ í¬ì¼“ëª¬ë¼ë¦¬ ì‹¸ì›€ì„ ë¶™ì—¬ë³´ì„¸ìš”!\n(ë³´ìƒ/ì „ì  ë°˜ì˜ X)\n\nì‚¬ìš©ë²•: /ëª¨ì˜ë°°í‹€ [UID1] [UID2]\nì˜ˆ: /ëª¨ì˜ë°°í‹€ 15 23");
        return;
      }
      var uidA = parseInt(parts[1], 10);
      var uidB = parseInt(parts[2], 10);
      if (isNaN(uidA) || isNaN(uidB)) {
        replier.reply("UID ìˆ«ìë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }
      if (uidA === uidB) {
        replier.reply("ìê¸° ìì‹ ê³¼ëŠ” ì‹¸ìš¸ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      var pA = findUserPokemonByUid(u, uidA);
      var pB = findUserPokemonByUid(u, uidB);
      if (!pA) {
        replier.reply("ì²« ë²ˆì§¸ í¬ì¼“ëª¬(UID " + uidA + ")ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      if (!pB) {
        replier.reply("ë‘ ë²ˆì§¸ í¬ì¼“ëª¬(UID " + uidB + ")ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      if (isPokemonBusy(u, pA.uid) || isPokemonBusy(u, pB.uid)) {
        replier.reply("ğŸš« íƒí—˜ ì¤‘ì¸ í¬ì¼“ëª¬ì€ ëª¨ì˜ ë°°í‹€ì— ì°¸ì—¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      var dbA = findPokemonDB(pA.pid);
      var dbB = findPokemonDB(pB.pid);
      // ì´ë¦„ ê°€ì ¸ì˜¤ê¸° (ì´ë¡œì¹˜ ë°˜ì˜)
      var nameA = getDisplayName(pA);
      var nameB = getDisplayName(pB);
      // ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰ (ì–‘ìª½ ë‹¤ ë‚´ ë ˆë²¨ ì ìš©)
      // simulateBattleLog(Aì´ë¦„, A_DB, A_Obj, A_Lv, Bì´ë¦„, B_DB, B_Obj, B_Lv)
      var sim = simulateBattleLog(sender + "(A)", dbA, pA, u.trainerLv, sender + "(B)", dbB, pB, u.trainerLv);
      // ê²°ê³¼ í…ìŠ¤íŠ¸ êµ¬ì„±
      var resultStr = "";
      if (sim.winner === "A") 
        resultStr = "ğŸ† ìŠ¹ì: #" + uidA + " " + nameA;
      else if (sim.winner === "B") 
        resultStr = "ğŸ† ìŠ¹ì: #" + uidB + " " + nameB;
      else 
        resultStr = "ğŸ¤ ê²°ê³¼: ë¬´ìŠ¹ë¶€";
      // ìš”ì•½ë³¸
      var summary = blockTitle("ëª¨ì˜ ë°°í‹€ ê²°ê³¼") + "ğŸ¥Š " + nameA + " (" + (pA.enh || 0) + "ê°•) vs " + nameB + " (" + (pB.enh || 0) + "ê°•)\n\n" + resultStr + "\n\n" + "âš ï¸ ëª¨ì˜ì „ì€ ë³´ìƒê³¼ ì „ì ì— ë°˜ì˜ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\n" + "ì „ì²´ë³´ê¸°ë¡œ ìƒì„¸ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.";
      // ì „ì²´ë³´ê¸°
      var full = "\n\n[âš”ï¸ ìŠ¤íŒŒë§ ìƒì„¸ ë¡œê·¸]\n\n" + sim.log;
      replyFold(replier, summary, full);
      return;
    }
    if (msg.indexOf("/ë­í‚¹") === 0) {
      var partsR = msg.split(" ").filter(Boolean);
      var typeR = partsR[1];
      // [1] ë„ê° ë­í‚¹
      if (typeR === "ë„ê°") {
        var data = buildDexRankingWithMyRank(d, 10, sender);
        var out = "ğŸ“˜ ë„ê° ë­í‚¹ (Sê¸‰ í¬í•¨)\n";
        for (var i = 0; i < data.top.length; i++) {
          var rr = data.top[i];
          out += (i + 1) + ". " + rr.name + " (" + rr.percent + "% / Sê¸‰ " + rr.sCount + "ê°œ)\n";
        }
        if (data.myIdx >= 0) {
          var me = data.rows[data.myIdx];
          out += "\në‚´ ìˆœìœ„: " + (data.myIdx + 1) + "ìœ„ (" + me.percent + "%)\n";
        }
        replier.reply(out);
        return;
      }
      if (typeR === "ì „íˆ¬ë ¥") {
        var pack = buildBattlePowerRanking(d, 7, sender);
        var out = "âš”ï¸ ì „íˆ¬ë ¥ ë­í‚¹ (ëŒ€í‘œ í¬ì¼“ëª¬)\n";
        for (var i = 0; i < pack.rows.length; i++) {
          var r = pack.rows[i];
          out += (i + 1) + ". " + r.name + " (" + fmtNum(r.power) + " / " + r.pName + ")\n";
        }
        if (pack.myIdx >= 0) {
          var my = pack.rows[pack.myIdx];
          out += "\në‚´ ìˆœìœ„: " + (pack.myIdx + 1) + "ìœ„ (" + fmtNum(my.power) + ")\n";
        }
        replier.reply(out);
        return;
      }
      if (typeR === "ë°°í‹€") {
        var list = rankTopList(d);
        if (list.length === 0) {
          replier.reply("ì•„ì§ ë°°í‹€ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.\n/ë°°í‹€ ë¡œ ë­í‚¹ì— ë„ì „í•˜ì„¸ìš”!");
          return;
        }
        var myRankIdx = -1;
        for (var k = 0; k < list.length; k++) {
          if (list[k].name === sender) {
            myRankIdx = k;
            break;
          }
        }
        // 1. ìš”ì•½ë³¸ (ì±„íŒ…ì°½ì— ë°”ë¡œ ë³´ì´ëŠ” ë¶€ë¶„)
        var summary = "ğŸ† ë°°í‹€ ë­í‚¹ ëª…ì˜ˆì˜ ì „ë‹¹\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\n";
        var topSummaryLimit = Math.min(3, list.length);        // 1~3ìœ„ë§Œ ê°•ì¡°
        for (var i = 0; i < topSummaryLimit; i++) {
          var r = list[i];
          var medal = (i === 0) ? "ğŸ¥‡" : (i === 1) ? "ğŸ¥ˆ" : "ğŸ¥‰";
          summary += medal + " " + r.name + " (" + fmtNum(r.score) + "ì )\n";
        }
        // ë‚´ ìˆœìœ„ ìš”ì•½
        if (myRankIdx !== -1) {
          var myR = list[myRankIdx];
          summary += "\nğŸ‘¤ ë‚´ ìˆœìœ„: " + (myRankIdx + 1) + "ìœ„ (" + fmtNum(myR.score) + "ì )";
        } else {
          summary += "\nğŸ‘¤ ë‚´ ìˆœìœ„: ê¸°ë¡ ì—†ìŒ";
        }
        summary += "\n\nì „ì²´ë³´ê¸°ë¡œ 100ìœ„ê¶Œ ìƒì„¸ ê¸°ë¡ì„ í™•ì¸í•˜ì„¸ìš”.";
        // 2. ì „ì²´ë³´ê¸° (ìƒì„¸ ë¦¬ìŠ¤íŠ¸)
        var full = "\n\n[âš”ï¸ ì „ì²´ ë­í‚¹ TOP 100]\n" + "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n";
        var limit = Math.min(100, list.length);
        for (var i = 0; i < limit; i++) {
          var r = list[i];
          var rankStr = (i + 1) + "ìœ„";
          if (i < 3) 
            rankStr = ["ğŸ¥‡1ìœ„", "ğŸ¥ˆ2ìœ„", "ğŸ¥‰3ìœ„"][i];
          var marker = (r.name === sender) ? " ğŸ‘ˆ (ë‚˜)" : "";
          full += rankStr + " " + r.name + marker + "\n";
          // ìƒì„¸ ì •ë³´ í•œ ì¤„ ì•„ë˜ì— í‘œì‹œ (ê°€ë…ì„± UP)
          full += "â”” " + fmtNum(r.score) + "ì  | " + r.w + "ìŠ¹ " + r.l + "íŒ¨ | " + r.s + "ì—°ìŠ¹\n";
        }
        // ë§¨ ì•„ë˜ì— ë‚´ ìƒì„¸ ì „ì  ì¹´ë“œ ë¶™ì´ê¸°
        full += "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\n[ğŸ“Š ë‚´ ìƒì„¸ ì „ì ]\n" + formatRecord(u);
        replyFold(replier, summary, full);
        return;
      }
      if (typeR === "ì¹­í˜¸") {
        var tData = buildTitleRanking(d, 10, sender);
        var out = "ğŸ·ï¸ ì¹­í˜¸ ìˆ˜ì§‘ ë­í‚¹ (ì´ " + tData.totalTitles + "ì¢…)\n";
        for (var i = 0; i < tData.top.length; i++) {
          var row = tData.top[i];
          out += (i + 1) + ". " + row.name + " (" + row.percent + "% / " + row.count + "ê°œ)\n";
        }
        if (tData.myIdx >= 0) {
          var me = tData.rows[tData.myIdx];
          out += "\në‚´ ìˆœìœ„: " + (tData.myIdx + 1) + "ìœ„ (" + me.count + "ê°œ)\n";
        }
        replier.reply(out);
        return;
      }
      replier.reply("ğŸ“Š ì‚¬ìš©ë²•: /ë­í‚¹ [ì¢…ë¥˜]\nì¢…ë¥˜: ë„ê°, ì „íˆ¬ë ¥, ë°°í‹€, ì¹­í˜¸");
      return;
    }
  // 1. [ìˆ˜ì • ì™„ê²°] 1:1 í¬ì¼“ëª¬ êµí™˜ (ìƒˆ UID ì•ˆë‚´ ë° í†µì‹  ì§„í™” ì ìš©)
  if (msg.indexOf("/êµí™˜") === 0) {
    if (TRANSACTION_LOCK[sender]) { replier.reply("â³ ì´ì „ ê±°ë˜ ì²˜ë¦¬ ì¤‘..."); return; }
    TRANSACTION_LOCK[sender] = true; 

    try {
      var parts = msg.split(" ").filter(Boolean);
      if (parts.length < 3) {
        replier.reply("ğŸ“¦ ì‚¬ìš©ë²•: /êµí™˜ [ë°›ì„ì‚¬ëŒ] [UID]\nì˜ˆ: /êµí™˜ ì†ì‚¬ì¥ 15");
        delete TRANSACTION_LOCK[sender]; return;
      }

      var targetName = parts[1].replace("@", "").trim();
      var uidToSend = parseInt(parts[2], 10);

      if (targetName === sender) { replier.reply("ğŸš« ë³¸ì¸ê³¼ëŠ” êµí™˜í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); delete TRANSACTION_LOCK[sender]; return; }
      
      var targetU = d.users[targetName];
      if (!targetU) { replier.reply("ğŸš« ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); delete TRANSACTION_LOCK[sender]; return; }
      normalizeUserData(targetU);

      if (targetU.pokemons.length >= MAX_POKEMON_SLOT) {
          replier.reply("ğŸš« ìƒëŒ€ë°©ì˜ ê°€ë°©ì´ ê½‰ ì°¼ìŠµë‹ˆë‹¤.");
          delete TRANSACTION_LOCK[sender]; return; 
      }

      var tradeP = findUserPokemonByUid(u, uidToSend);
      if (!tradeP) { replier.reply("ğŸš« í•´ë‹¹ í¬ì¼“ëª¬ì´ ì—†ìŠµë‹ˆë‹¤."); delete TRANSACTION_LOCK[sender]; return; }

      if (u.party.indexOf(tradeP.uid) !== -1) {
          replier.reply("ğŸš« ì—”íŠ¸ë¦¬ì— ìˆëŠ” í¬ì¼“ëª¬ì€ ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\në¨¼ì € ì—”íŠ¸ë¦¬ì—ì„œ ì œì™¸í•´ì£¼ì„¸ìš”.");
          delete TRANSACTION_LOCK[sender]; return;
      }
      if (isPokemonBusy(u, tradeP.uid)) {
          replier.reply("ğŸš« íƒí—˜ ì¤‘ì¸ í¬ì¼“ëª¬ì…ë‹ˆë‹¤.");
          delete TRANSACTION_LOCK[sender]; return;
      }

      // --- [ë³´ë‚´ê¸° ì²˜ë¦¬] ---
      var myIdx = u.pokemons.indexOf(tradeP);
      u.pokemons.splice(myIdx, 1);

      // â˜… [í•µì‹¬ ìˆ˜ì •] ìƒˆ UIDë¥¼ ë¯¸ë¦¬ ë³€ìˆ˜ì— í• ë‹¹í•´ì„œ ì¶œë ¥ì— ì‚¬ìš©í•©ë‹ˆë‹¤.
      var assignedUid = nextPokemonUid(targetU); 
      var newPokeObj = JSON.parse(JSON.stringify(tradeP));
      newPokeObj.uid = assignedUid;
      newPokeObj.friendship = 70; 

      // 3. [í†µì‹  ì§„í™” ì²´í¬]
      var rule = EVOLVE_DB[newPokeObj.pid];
      var evoTarget = 0;
      var consumeItem = null;

      if (rule) {
          if (!Array.isArray(rule)) rule = [rule];
          for(var i=0; i<rule.length; i++) {
              var r = rule[i];
              if (r.type === "trade") {
                  evoTarget = r.to; break;
              } else if (r.type === "trade_item" && newPokeObj.equip === r.val) {
                  evoTarget = r.to; consumeItem = r.val; break;
              }
          }
      }

      var evoMsg = "";
      if (evoTarget > 0) {
          if (consumeItem) newPokeObj.equip = null;
          var oldName = getDisplayName(newPokeObj);
          newPokeObj.pid = evoTarget;
          var newName = getDisplayName(newPokeObj);
          evoMsg = "\n\nğŸ§¬ ã€ í†µì‹  ì§„í™” ë°œë™! ã€‘\nâœ¨ " + oldName + " â” " + newName;
          dexCaught(targetU, evoTarget, newPokeObj.grade);
      } else {
          dexCaught(targetU, newPokeObj.pid, newPokeObj.grade);
      }

      if (!targetU.pokemons) targetU.pokemons = [];
      targetU.pokemons.push(newPokeObj);

      commitSave(true);
      checkAndNotifyTitles(u, replier);

      // -----------------------------------------------------------
      // ğŸ“¦ [ìµœì¢…] ì •ì„± ë‹´ê¸´ êµí™˜ ê²°ê³¼ ë¦¬í¬íŠ¸
      // -----------------------------------------------------------
      var pName = getDisplayName(tradeP);
      var resultMsg = "ğŸ“¦ ã€ í¬ì¼“ëª¬ êµí™˜ ì™„ë£Œ ã€‘ ğŸ“¦\n" +
                      "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                      "ğŸ‘‹ ë³´ë‚¸ ë¶„: " + sender + "\n" +
                      "ğŸ¤ ë°›ì€ ë¶„: " + targetName + "\n\n" +
                      "ğŸ‘¾ í¬ì¼“ëª¬: " + pName + "\n" +
                      "ğŸ†” ìƒˆ ë²ˆí˜¸: #" + assignedUid + " (ë°•ìŠ¤ ë“±ë¡ ì™„ë£Œ)\n" +
                      "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                      "ğŸ’¡ " + targetName + "ë‹˜ì˜ ë°•ìŠ¤ì—ì„œ ìƒˆë¡œìš´ ì¼ë ¨ë²ˆí˜¸ë¥¼ ë¶€ì—¬ë°›ì•˜ìŠµë‹ˆë‹¤!" + 
                      evoMsg;

      replier.reply(resultMsg);

    } catch(e) {
      replier.reply("ğŸš« êµí™˜ ì˜¤ë¥˜: " + e);
    } finally {
      delete TRANSACTION_LOCK[sender]; 
    }
    return;
  }


    if (msg.indexOf("/ì†¡ê¸ˆ") === 0 || msg.indexOf("/ê³¨ë“œë³´ë‚´ê¸°") === 0) {
      if (TRANSACTION_LOCK[sender]) {
        return;
      }
      TRANSACTION_LOCK[sender] = true;
      try {
        var parts = msg.split(" ").filter(Boolean);
        if (parts.length < 3) {
          replier.reply("ğŸ’¸ ì‚¬ìš©ë²•: /ì†¡ê¸ˆ [ë°›ì„ì‚¬ëŒ] [ê¸ˆì•¡]\nì˜ˆ: /ì†¡ê¸ˆ ì†ì‚¬ì¥ 10000");
          delete TRANSACTION_LOCK[sender];
          return;
        }
        var targetName = parts[1].replace("@", "").trim();
        var amount = parseInt(parts[2], 10);
        if (targetName === sender) {
          replier.reply("ğŸš« ìê¸° ìì‹ ì—ê²ŒëŠ” ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          delete TRANSACTION_LOCK[sender];
          return;
        }
        if (isNaN(amount) || amount <= 0) {
          replier.reply("ğŸš« 1ì› ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          delete TRANSACTION_LOCK[sender];
          return;
        }
        var targetU = d.users[targetName];
        if (!targetU) {
          replier.reply("ğŸš« '" + targetName + "'ë‹˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          delete TRANSACTION_LOCK[sender];
          return;
        }
        normalizeUserData(targetU);
        if (u.gold < amount) {
          replier.reply("ğŸš« ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.\në³´ìœ : " + fmtNum(u.gold) + "ğŸ’°");
          delete TRANSACTION_LOCK[sender];
          return;
        }
        u.gold -= amount;
        targetU.gold += amount;
        commitSave(true);
        checkAndNotifyTitles(u, replier);
        replier.reply("ğŸ’¸ ì†¡ê¸ˆ ì„±ê³µ!\n" + sender + " â¡ï¸ " + targetName + "\nê¸ˆì•¡: " + fmtNum(amount) + "ğŸ’°\në‚¨ì€ ëˆ: " + fmtNum(u.gold) + "ğŸ’°");
      }      catch (e) {
  replier.reply("ğŸš« ì†¡ê¸ˆ ì˜¤ë¥˜: " + e);
}
 finally       {
        delete TRANSACTION_LOCK[sender];
      }
      return;
    }
    if (msg.indexOf("/ì„ ë¬¼") === 0) {
      if (TRANSACTION_LOCK[sender]) {
        return;
      }
      TRANSACTION_LOCK[sender] = true;
      try {
        var parts = msg.split(" ").filter(Boolean);
        if (parts.length < 4) {
          replier.reply("ğŸ ì‚¬ìš©ë²•: /ì„ ë¬¼ [ë°›ì„ì‚¬ëŒ] [ì•„ì´í…œ] [ìˆ˜ëŸ‰]\nì˜ˆ: /ì„ ë¬¼ ì†ì‚¬ì¥ ìƒì 1\nì˜ˆ: /ì„ ë¬¼ ì†ì‚¬ì¥ í˜ì˜ë¨¸ë¦¬ë  1");
          delete TRANSACTION_LOCK[sender];
          return;
        }
        var targetName = parts[1].replace("@", "").trim();
        var itemName = parts[2];
        var qty = parseInt(parts[3], 10);
        if (targetName === sender) {
          replier.reply("ğŸš« ë³¸ì¸ì—ê²Œ ì„ ë¬¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          delete TRANSACTION_LOCK[sender];
          return;
        }
        if (isNaN(qty) || qty <= 0) {
          replier.reply("ğŸš« 1ê°œ ì´ìƒ ë³´ë‚´ì„¸ìš”.");
          delete TRANSACTION_LOCK[sender];
          return;
        }
        var targetU = d.users[targetName];
        if (!targetU) {
          replier.reply("ğŸš« ëŒ€ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          delete TRANSACTION_LOCK[sender];
          return;
        }
        normalizeUserData(targetU);        // ë°›ëŠ” ì‚¬ëŒ ê°€ë°© ì´ˆê¸°í™”
        // ë³€ìˆ˜ ì„¤ì •
        var isItemInBag = false;        // u.items(ê°€ë°©)ì— ìˆëŠ” ë¬¼ê±´ì¸ê°€?
        var field = "";
        var label = "";
        // [1] ì¼ë°˜ ì†Œë¹„ ì•„ì´í…œ (u.ë³€ìˆ˜)
        if (itemName === "ë„íŒŒë¯¼" || itemName === "ë„íŒŒë¯¼ê°•í™”ê¶Œ") {
          field = "dopaTicket";
          label = "ë„íŒŒë¯¼ê°•í™”ê¶Œ";
        } else if (itemName === "ë‘ì«€ì¿ " || itemName === "ì¿ í‚¤") {
          field = "cookie";
          label = "ë‘ì«€ì¿ ";
        } else if (itemName === "í‹°ì–´ë¦¬ì…‹" || itemName === "í‹°ì–´ë¦¬ì…‹ê¶Œ") {
          field = "reroll";
          label = "í‹°ì–´ë¦¬ì…‹ê¶Œ";
        } else if (itemName === "ì´ë™í‹°ì¼“" || itemName === "í‹°ì¼“") {
          field = "ticket";
          label = "ì´ë™í‹°ì¼“";
        } else if (itemName.indexOf("í‚¹ê°“ë³¼") !== -1) {
          field = "godBall";
          label = "í‚¹ê°“ë³¼";
        } else if (["ì¥ë¹„ìƒì", "ìƒì", "ë³´ë¬¼ìƒì"].indexOf(itemName) !== -1) {
          isItemInBag = true;
          field = "ì¥ë¹„ìƒì";
          label = "ğŸ“¦ ì¥ë¹„ìƒì";
        } else if (["ìƒìíŒŒí¸", "íŒŒí¸"].indexOf(itemName) !== -1) {
          isItemInBag = true;
          field = "ìƒìíŒŒí¸";
          label = "ğŸ§© ìƒìíŒŒí¸";
        } else if (["ë”¸ê¸°ì¿ í‚¤", "ë”¸ê¸°", "ë”¸ì«€ì¿ "].indexOf(itemName) !== -1) {
          isItemInBag = true;
          field = "ë”¸ê¸°ì¿ í‚¤";
          label = "ğŸ“ ë”¸ê¸°ì¿ í‚¤";
        } else if (["í™©ê¸ˆì—´ë§¤", "ì—´ë§¤", "ë¼ì¦ˆì—´ë§¤"].indexOf(itemName) !== -1) {
          isItemInBag = true;
          field = "í™©ê¸ˆì—´ë§¤";
          label = "ğŸ¥œ í™©ê¸ˆì—´ë§¤";
        } else if (["í™©ê¸ˆí˜ì¸íŠ¸", "í˜ì¸íŠ¸", "ì´ë¡œì¹˜"].indexOf(itemName) !== -1) {
          isItemInBag = true;
          field = "í™©ê¸ˆí˜ì¸íŠ¸";
          label = "ğŸ¨ í™©ê¸ˆí˜ì¸íŠ¸";
        } else if (EQUIP_DB[itemName]) {
          isItemInBag = true;
          field = itemName;          // ì¥ë¹„ëŠ” ì´ë¦„ ê·¸ëŒ€ë¡œê°€ í‚¤ê°’
          var icon = EQUIP_DB[itemName].icon || "ğŸ›¡ï¸";
          label = icon + " " + itemName;
        } else {
          replier.reply("ğŸš« ì„ ë¬¼í•  ìˆ˜ ì—†ëŠ” ì•„ì´í…œì…ë‹ˆë‹¤.\n(ì •í™•í•œ ì•„ì´í…œ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!)");
          delete TRANSACTION_LOCK[sender];
          return;
        }
        // [4] ì•„ì´í…œ ì°¨ê° ë° ì „ì†¡ ë¡œì§
        if (isItemInBag) {
          // --- ê°€ë°©(u.items) ì•„ì´í…œ ì „ì†¡ ---
          if (!u.items) 
            u.items = {};
          if (!u.items[field] || u.items[field] < qty) {
            replier.reply("ğŸš« ë³´ìœ í•˜ì‹  [" + field + "] ìˆ˜ëŸ‰ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.\ní˜„ì¬ ë³´ìœ : " + (u.items[field] || 0) + "ê°œ");
            delete TRANSACTION_LOCK[sender];
            return;
          }
          u.items[field] -= qty;
          if (u.items[field] <= 0) 
            delete u.items[field];          // 0ê°œë©´ ì‚­ì œ
          if (!targetU.items) 
            targetU.items = {};
          targetU.items[field] = (targetU.items[field] || 0) + qty;
        } else {
          // --- ì¼ë°˜ ë³€ìˆ˜(u.prop) ì•„ì´í…œ ì „ì†¡ ---
          var myQty = u[field] || 0;
          if (myQty < qty) {
            replier.reply("ğŸš« ìˆ˜ëŸ‰ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.\në³´ìœ : " + fmtNum(myQty) + "ê°œ");
            delete TRANSACTION_LOCK[sender];
            return;
          }
          u[field] -= qty;
          if (typeof targetU[field] !== "number") 
            targetU[field] = 0;
          targetU[field] += qty;
        }
        commitSave(true);
        checkAndNotifyTitles(u, replier);
        replier.reply("ğŸ ì„ ë¬¼ ë°°ì†¡ ì™„ë£Œ!\n" + sender + " â¡ï¸ " + targetName + "\në‚´ìš©ë¬¼: " + label + " " + qty + "ê°œ");
      }      catch (e) {
  replier.reply("ğŸš« ì„ ë¬¼ ì˜¤ë¥˜: " + e);
}
 finally       {
        delete TRANSACTION_LOCK[sender];
      }
      return;
    }

  if (msg === "/ì—”íŠ¸ë¦¬" || msg === "/íŒŒí‹°" || msg === "/ë‚´íŒ€") {
    var partyList = [];
    var totalPower = 0;
    
    for (var i = 0; i < u.party.length; i++) {
      var uid = u.party[i];
      var p = findUserPokemonByUid(u, uid);
      if (!p) { u.party.splice(i, 1); i--; continue; }
      
      var pName = getDisplayName(p);
      var power = calcBattlePower(p);
      
      // [ìˆ˜ì •ì™„ë£Œ] cp ì—ëŸ¬ ìœ ë°œ ì½”ë“œ ì‚­ì œí•¨
      totalPower += power; 

      var heart = (p.friendship >= 220) ? "â¤ï¸" : (p.friendship >= 150) ? "ğŸ§¡" : "ğŸ–¤";
      var gradeStr = "[" + (p.grade || "D") + "]" + (p.grade === "S" ? "ğŸ‘‘" : "");
      var status = isPokemonBusy(u, p.uid) ? " (ğŸ§­)" : "";
      
      var equipStr = "";
      if (p.equip && EQUIP_DB[p.equip]) {
        equipStr = " [" + (EQUIP_DB[p.equip].icon || "ğŸ›¡ï¸") + p.equip + "]";
      }

      // [í•µì‹¬] í•œ ì¤„ í¬ë§· ì •ì˜ (ë‚´í¬ì¼“ëª¬ê³¼ 100% ë™ì¼)
      var line = "#" + p.uid + " " + pName + " (Lv." + (p.lv || 1) + ") +" + (p.enh || 0) + "ê°• | íˆ¬ë ¥ " + fmtNum(power) + " " + gradeStr + " " + heart + equipStr + status;
      partyList.push((i + 1) + ". " + line);
    }
    
    var summary = "ğŸ’ " + decoName + "ë‹˜ì˜ ì—”íŠ¸ë¦¬ (" + partyList.length + "/6)\n" +
                  "âš”ï¸ ì´ ì „íˆ¬ë ¥: " + fmtNum(totalPower) + "\n\n" +
                  "ì „ì²´ë³´ê¸°ë¡œ ìƒì„¸ ë©¤ë²„ë¥¼ í™•ì¸í•˜ì„¸ìš”.";
                  
    var full = "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
               "âš”ï¸ [ì¶œì „ ë©¤ë²„ ë¦¬ìŠ¤íŠ¸]\n" +
               "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
               (partyList.length > 0 ? partyList.join("\n") : "(ë¹„ì–´ìˆìŒ)") +
               "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
               "ğŸ’¡ ì¶”ê°€/ì œê±°: '/ì„ íƒ [UID]'\n" +
               "ğŸ’¡ ì„ ìˆ˜êµì²´: '/êµì²´ [ëº„UID] [ë„£ì„UID]'";

    replyFold(replier, summary, full);
    return;
  }
 

  if (msg === "/ë‚´ë°•ìŠ¤" || msg === "/ë°•ìŠ¤" || msg === "/pc") {
    var boxList = [];
    var sorted = sortPokemonsByPower(u.pokemons);

    for (var i = 0; i < sorted.length; i++) {
      var p = sorted[i];
      if (u.party.indexOf(p.uid) === -1) {
        var pName = getDisplayName(p);
        var power = calcBattlePower(p);
        var heart = (p.friendship >= 220) ? "â¤ï¸" : (p.friendship >= 150) ? "ğŸ§¡" : "ğŸ–¤";
        var gradeStr = "[" + (p.grade || "D") + "]" + (p.grade === "S" ? "ğŸ‘‘" : "");
        var status = isPokemonBusy(u, p.uid) ? " (ğŸ§­)" : "";
        
        var equipStr = "";
        if (p.equip && EQUIP_DB[p.equip]) {
          equipStr = " [" + (EQUIP_DB[p.equip].icon || "ğŸ›¡ï¸") + p.equip + "]";
        }
        
        // [í•µì‹¬] í•œ ì¤„ í¬ë§· ì •ì˜
        var line = "#" + p.uid + " " + pName + " (Lv." + (p.lv || 1) + ") +" + (p.enh || 0) + "ê°• | íˆ¬ë ¥ " + fmtNum(power) + " " + gradeStr + " " + heart + equipStr + status;
        boxList.push((boxList.length + 1) + ". " + line);
      }
    }
    
    var summary = "ğŸ“¦ " + decoName + "ë‹˜ì˜ í¬ì¼“ëª¬ ë°•ìŠ¤\n" +
                  "ì´ " + boxList.length + "ë§ˆë¦¬ ëŒ€ê¸° ì¤‘\n\n" +
                  "ì „ì²´ë³´ê¸°ë¡œ ë³´ê´€í•¨ ëª©ë¡ì„ í™•ì¸í•˜ì„¸ìš”.";
                  
    var full = "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
               "ğŸ“¦ [ë°•ìŠ¤ ë³´ê´€í•¨ ëª©ë¡]\n" +
               "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
               (boxList.length > 0 ? boxList.join("\n") : "(ë¹„ì–´ìˆìŒ)") +
               "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
               "ğŸ’¡ ë„£ê¸°: '/ì„ íƒ [UID]'\n" +
               "ğŸ’¡ êµì²´: '/êµì²´ [ëº„UID] [ë„£ì„UID]'";

    replyFold(replier, summary, full);
    return;
  }

  // âš”ï¸ [ì—”íŠ¸ë¦¬ ê´€ë¦¬] ì„ íƒ / ë‹¤ì¤‘ ë“±ë¡ / ì´ˆê¸°í™” í†µí•© ì‹œìŠ¤í…œ
  if (msg.indexOf("/ì„ íƒ") === 0 || msg.indexOf("/í”½") === 0) {
    var parts = msg.split(" ").filter(Boolean);
    
    if (parts.length < 2) {
      replier.reply("ğŸ“ [ì„ ë°œëŒ€ ê´€ë¦¬ ê°€ì´ë“œ]\n" +
                    "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                    "â€¢ ë„£ê¸°/ë¹¼ê¸° : /ì„ íƒ [ë³„ëª…/UID]\n" +
                    "â€¢ ë‹¤ì¤‘ ë“±ë¡ : /ì„ íƒ 15 22 41 (ë„ì–´ì“°ê¸° êµ¬ë¶„)\n" +
                    "â€¢ ì „ì²´ ë¹„ìš°ê¸° : /ì„ íƒ ì´ˆê¸°í™”\n" +
                    "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                    "ğŸ’¡ ì´ë¯¸ ë“¤ì–´ê°„ í¬ì¼“ëª¬ì„ í•œ ë²ˆ ë” ì„ íƒí•˜ë©´ í•´ì œë©ë‹ˆë‹¤!");
      return;
    }

    if (!u.party) u.party = [];

    // 1. ì—”íŠ¸ë¦¬ ì „ì²´ ë¹„ìš°ê¸° (ì¼ê´„ í•´ì œ)
    if (parts[1] === "ì´ˆê¸°í™”" || parts[1] === "ë¹„ìš°ê¸°" || parts[1] === "ë¦¬ì…‹") {
      u.party = [];
      commitSave(true);
      replier.reply("ğŸ—‘ï¸ ì—”íŠ¸ë¦¬ë¥¼ ëª¨ë‘ ë¹„ì› ìŠµë‹ˆë‹¤!\nì´ì œ '/ì„ íƒ [ë³„ëª…/UID]' ë¥¼ í†µí•´ ìƒˆë¡œìš´ ë©¤ë²„ë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”.");
      return;
    }

    // 2. ë‹¨ì¼ ë° ë‹¤ì¤‘ ì„ íƒ ì²˜ë¦¬ (ë³„ëª… ë° UID ì§€ëŠ¥í˜• ê²€ìƒ‰ ì§€ì›)
    var added = [];
    var removed = [];
    var errors = [];

    // ë„ì–´ì“°ê¸°ë¡œ êµ¬ë¶„ëœ ì—¬ëŸ¬ ë§ˆë¦¬ì˜ ì…ë ¥ê°’ì„ ìˆœì„œëŒ€ë¡œ ì²˜ë¦¬
    for (var i = 1; i < parts.length; i++) {
      var pInput = parts[i].replace("#", "");
      var p = findPokemonByAny(u, pInput); // ë³„ëª… ë˜ëŠ” UIDë¡œ ê²€ìƒ‰
      
      if (!p) {
        errors.push(pInput + "(ì¡´ì¬ì•ˆí•¨)");
        continue;
      }
      if (isPokemonBusy(u, p.uid)) {
        errors.push(getDisplayName(p) + "(íƒí—˜/ì„ë¬´ì¤‘)");
        continue;
      }

      var idx = u.party.indexOf(p.uid);
      if (idx !== -1) {
        // ì´ë¯¸ ì—”íŠ¸ë¦¬ì— ìˆìœ¼ë©´ ëºŒ (í† ê¸€ ê¸°ëŠ¥)
        u.party.splice(idx, 1);
        removed.push(getDisplayName(p));
      } else {
        // ì—”íŠ¸ë¦¬ì— ì—†ìœ¼ë©´ ë„£ìŒ (ìµœëŒ€ 6ë§ˆë¦¬ ì œí•œ)
        if (u.party.length >= 6) {
          errors.push(getDisplayName(p) + "(ê³µê°„ë¶€ì¡±)");
        } else {
          u.party.push(p.uid);
          added.push(getDisplayName(p));
        }
      }
    }

    commitSave(true);
    
    // 3. ì¼ê´„ ì²˜ë¦¬ ê²°ê³¼ ë³´ê³ ì„œ ì¶œë ¥
    var resultMsg = "ğŸ’ [ì—”íŠ¸ë¦¬ í¸ì„± ê²°ê³¼]\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\n";
    if (added.length > 0) resultMsg += "ğŸ“¥ ë“±ë¡: " + added.join(", ") + "\n";
    if (removed.length > 0) resultMsg += "ğŸ“¤ í•´ì œ: " + removed.join(", ") + "\n";
    if (errors.length > 0) resultMsg += "âš ï¸ ì‹¤íŒ¨: " + errors.join(", ") + "\n";
    
    resultMsg += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\ní˜„ì¬ ì—”íŠ¸ë¦¬ ìˆ˜: " + u.party.length + " / 6\nğŸ‘‰ ë± í™•ì¸: '/ì—”íŠ¸ë¦¬'";
    
    replier.reply(resultMsg);
    return;
  }

  // -------------------- [ì‹ ê·œ] ë‹¤ì´ë ‰íŠ¸ êµì²´ ì‹œìŠ¤í…œ (ë³„ëª… ì§€ì›) --------------------
  if (msg.indexOf("/êµì²´") === 0) {
      var parts = msg.split(" ").filter(Boolean);
      
      if (parts.length < 3) {
          replier.reply("ğŸ”„ ì—”íŠ¸ë¦¬ ë©¤ë²„ë¥¼ ì¦‰ì‹œ 1:1 êµì²´í•©ë‹ˆë‹¤. (ìˆœì„œ ìœ ì§€)\nì‚¬ìš©ë²•: /êµì²´ [ëº„ë³„ëª…/UID] [ë„£ì„ë³„ëª…/UID]\nì˜ˆ: /êµì²´ í”¼ì¹´ì¸„ íŒŒì´ë¦¬");
          return;
      }

      var pOutInput = parts[1].replace("#", ""); // ëº„ ë†ˆ
      var pInInput = parts[2].replace("#", "");  // ë„£ì„ ë†ˆ

      // â˜… [í•µì‹¬] ë³„ëª…ê³¼ UIDë¥¼ ëª¨ë‘ ì§€ì›í•˜ëŠ” ì§€ëŠ¥í˜• ê²€ìƒ‰
      var pOut = findPokemonByAny(u, pOutInput);
      var pIn = findPokemonByAny(u, pInInput);

      if (!pOut) { replier.reply("ğŸš« ëº„ í¬ì¼“ëª¬ [" + pOutInput + "]ì„(ë¥¼) ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
      if (!pIn) { replier.reply("ğŸš« ë„£ì„ í¬ì¼“ëª¬ [" + pInInput + "]ì„(ë¥¼) ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }

      if (pOut.uid === pIn.uid) { replier.reply("ğŸš« ê°™ì€ í¬ì¼“ëª¬ë¼ë¦¬ëŠ” êµì²´í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }

      // 1. ìœ„ì¹˜ ê²€ì¦
      var idxOut = u.party.indexOf(pOut.uid);
      if (idxOut === -1) {
          replier.reply("ğŸš« " + getDisplayName(pOut) + "ëŠ” í˜„ì¬ ì—”íŠ¸ë¦¬ì— ì—†ìŠµë‹ˆë‹¤.");
          return;
      }
      if (u.party.indexOf(pIn.uid) !== -1) {
          replier.reply("ğŸš« " + getDisplayName(pIn) + "ëŠ” ì´ë¯¸ ì—”íŠ¸ë¦¬ì— ìˆìŠµë‹ˆë‹¤.");
          return;
      }

      // 2. íƒí—˜ ìƒíƒœ ê²€ì¦
      if (isPokemonBusy(u, pOut.uid)) { replier.reply("ğŸš« ëº„ í¬ì¼“ëª¬ì´ íƒí—˜/ë°°í‹€ ì¤‘ì…ë‹ˆë‹¤."); return; }
      if (isPokemonBusy(u, pIn.uid)) { replier.reply("ğŸš« ë„£ì„ í¬ì¼“ëª¬ì´ íƒí—˜/ë°°í‹€ ì¤‘ì…ë‹ˆë‹¤."); return; }

      // 3. êµì²´ ì‹¤í–‰ (ë°°ì—´ ì¸ë±ìŠ¤ ë®ì–´ì“°ê¸° -> ê¸°ì¡´ ìë¦¬ ê·¸ëŒ€ë¡œ ìœ ì§€!)
      u.party[idxOut] = pIn.uid;

      commitSave(true);
      
      replier.reply(
          "ğŸ”„ ë©¤ë²„ êµì²´ ì™„ë£Œ!\n" +
          "ğŸ‘‹ ë°•ìŠ¤ë¡œ: " + getDisplayName(pOut) + " (Lv." + pOut.lv + ")\n" +
          "ğŸ‘‰ ì—”íŠ¸ë¦¬ë¡œ: " + getDisplayName(pIn) + " (Lv." + pIn.lv + ")"
      );
      return;
  }


    if (msg === "/ì²´ìœ¡ê´€" || msg === "/ë°°ì§€") {
      if (!isInTaechoVillage(u)) {
        replier.reply("ğŸš« ì²´ìœ¡ê´€ ì½˜í…ì¸ ëŠ” íŒŒì•¼ë ˆë°”ì—ì„œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.\n/ì´ë™ íŒŒì•¼ë ˆë°” ë¡œ ë³µê·€í•´ì£¼ì„¸ìš”.");
        return;
      }
      ensureUserDex(u);
      if (!u.badges) 
        u.badges = [];
      var out = "ğŸ›¡ï¸ " + decoName + "ë‹˜ì˜ ì²´ìœ¡ê´€ ë„ì „ í˜„í™©\n" + "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n";
      for (var i = 0; i < GYM_LEADERS.length; i++) {
        var gym = GYM_LEADERS[i];
        var hasBadge = (u.badges.indexOf(gym.badge) !== -1);
        var status = hasBadge ? "âœ… [í´ë¦¬ì–´]" : "ğŸ”’ [ë„ì „ ê°€ëŠ¥]";
        // ë¼ì¸ì—… ì´ë¦„ ì¶”ì¶œ
        var lineupNames = [];
        for (var j = 0; j < gym.lineup.length; j++) {
          var pInfo = gym.lineup[j];
          var pMark = pInfo.shiny ? "âœ¨" : "";
          lineupNames.push(pMark + pInfo.name);
        }
        out += (i + 1) + ". ê´€ì¥ " + gym.name + " (" + gym.type + ") " + status + "\n";
        out += "   ğŸ’° ì…ì¥ë£Œ: " + fmtNum(gym.entryFee) + " ê³¨ë“œ\n";
        out += "   ğŸ‘¾ ë¼ì¸ì—…: " + lineupNames.join(" / ") + "\n";
        out += "\n";
      }
      out += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + "âš”ï¸ ë„ì „ ë°©ë²•: '/ì²´ìœ¡ê´€ ë„ì „ [ë²ˆí˜¸]'\n" + "ğŸ’¡ íŒ: ìƒì„±ì„ ê³ ë ¤í•´ '/ì—”íŠ¸ë¦¬'ë¥¼ ì¡°ì •í•˜ì„¸ìš”!";
      replier.reply(out);
      return;
    }
// ==================== [ìˆ˜ì •ë¨] ì²´ìœ¡ê´€ ë„ì „ (ì—”íŠ¸ë¦¬ 1~3ë²ˆ ìë™ ì¶œì „) ====================
if (msg.indexOf("/ì²´ìœ¡ê´€ ë„ì „") === 0) {
    if (!isInTaechoVillage(u)) { replier.reply("ğŸš« ì²´ìœ¡ê´€ ë„ì „ì€ íŒŒì•¼ë ˆë°”ì—ì„œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.\n/ì´ë™ íŒŒì•¼ë ˆë°” ë¡œ ë³µê·€í•´ì£¼ì„¸ìš”."); return; }
    
    var parts = msg.split(" ");
    var num = parseInt(parts[2]);
    if (isNaN(num) || num < 1 || num > 8) { replier.reply("ğŸš« ì²´ìœ¡ê´€ ë²ˆí˜¸(1~8)ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }

    var gymIdx = num - 1;
    var gym = GYM_LEADERS[gymIdx];

    // 1. ì„ í–‰ ë°°ì§€ ë° ì¤‘ë³µ í´ë¦¬ì–´ ì²´í¬
    if (gymIdx > 0) {
        var prevBadge = GYM_LEADERS[gymIdx-1].badge;
        if (!u.badges || u.badges.indexOf(prevBadge) === -1) {
            replier.reply("ğŸš« ì´ì „ ì²´ìœ¡ê´€(" + GYM_LEADERS[gymIdx-1].name + ")ì„ ë¨¼ì € í´ë¦¬ì–´í•´ì•¼ í•©ë‹ˆë‹¤.");
            return;
        }
    }
    if (u.badges && u.badges.indexOf(gym.badge) !== -1) {
        replier.reply("âœ… ì´ë¯¸ " + gym.badge + "ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤.");
        return;
    }

    // 2. â˜… ì—”íŠ¸ë¦¬ ì²´í¬ (ì•ì—ì„œ 3ë§ˆë¦¬)
    if (!u.party || u.party.length < 3) {
        replier.reply("ğŸš« [ë„ì „ ë¶ˆê°€] ì—”íŠ¸ë¦¬ì— ìµœì†Œ 3ë§ˆë¦¬ì˜ í¬ì¼“ëª¬ì´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.\n(í˜„ì¬: " + (u.party?u.party.length:0) + "ë§ˆë¦¬)\nğŸ‘‰ '/ë‚´ë°•ìŠ¤'ì—ì„œ '/ì„ íƒ'í•˜ì—¬ í¬ì¼“ëª¬ì„ ë°ë ¤ì˜¤ì„¸ìš”.");
        return;
    }
    
    // 3. ì…ì¥ë£Œ ì²´í¬
    if (u.gold < gym.entryFee) {
        replier.reply("ğŸš« ì…ì¥ë£Œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.\ní•„ìš”: " + fmtNum(gym.entryFee) + "ğŸ’°");
        return;
    }

    // --- ì „íˆ¬ ì¤€ë¹„ ---
    var myTeam = [];
    // â˜… ì—”íŠ¸ë¦¬ 0,1,2ë²ˆ (ìƒìœ„ 3ë§ˆë¦¬)ë§Œ ê°€ì ¸ì˜´
    for(var k=0; k<3; k++) {
        var p = findUserPokemonByUid(u, u.party[k]);
        if (!p) { replier.reply("ğŸš« ì—”íŠ¸ë¦¬ ì˜¤ë¥˜: ì¡´ì¬í•˜ì§€ ì•ŠëŠ” í¬ì¼“ëª¬ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤."); return; }
        if (isPokemonBusy(u, p.uid)) { replier.reply("ğŸš« ì—”íŠ¸ë¦¬ì˜ #" + p.uid + " " + getDisplayName(p) + "ì´(ê°€) íƒí—˜ ì¤‘ì…ë‹ˆë‹¤."); return; }
        myTeam.push(p);
    }

    u.gold -= gym.entryFee; // ì…ì¥ë£Œ ì°¨ê°

    // ì „íˆ¬ ì‹¤í–‰
    var result = simulateRelayBattle(myTeam, gym.lineup, sender, "ê´€ì¥ " + gym.name, false);
    var out = blockTitle("ì²´ìœ¡ê´€ ë„ì „: " + gym.name) + "\n" + result.log + "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\n";

    if (result.winner === "A") {
        if (!u.badges) u.badges = [];
        u.badges.push(gym.badge);
        
        var rewardGold = gym.entryFee * 3;
        u.gold += rewardGold;
        var ticketAmount = (gymIdx >= 5) ? 2 : 1;
        u.reroll = (u.reroll || 0) + ticketAmount;
        
        // â˜… [ì‹ ê·œ] ìŠ¹ë¦¬ ì‹œ ì—”íŠ¸ë¦¬ 3ë§ˆë¦¬ ì¹œë°€ë„ ì¦ê°€
        for(var i=0; i<myTeam.length; i++) {
             myTeam[i].friendship = Math.min(255, (myTeam[i].friendship||0) + 5);
        }
        
        out += "ğŸ‰ ìŠ¹ë¦¬! " + gym.badge + "ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!\n";
        out += "ğŸ’° ìƒê¸ˆ: " + fmtNum(rewardGold) + "ğŸ’°\n";
        out += "ğŸ íŠ¹ë³„ ë³´ìƒ: í‹°ì–´ë¦¬ì…‹ê¶Œ +" + ticketAmount + "ì¥\n";
        out += "â¤ï¸ ì¶œì „ í¬ì¼“ëª¬ ì¹œë°€ë„ ëŒ€í­ ìƒìŠ¹!";
    } else {
        out += "ğŸ’€ íŒ¨ë°°... ëˆˆì•ì´ ìº„ìº„í•´ì¡ŒìŠµë‹ˆë‹¤.\n(ì…ì¥ë£ŒëŠ” í™˜ë¶ˆë˜ì§€ ì•ŠìŠµë‹ˆë‹¤)";
    }

    commitSave(true);
    checkAndNotifyTitles(u, replier);
    replyFold(replier, "âš”ï¸ " + sender + " vs " + gym.name + " ëŒ€ê²° ê²°ê³¼", out);
    return;
}

    if (msg === "/ì±”í”¼ì–¸") {
      if (!isInTaechoVillage(u)) {
        replier.reply("ğŸš« ì±”í”¼ì–¸ ë¦¬ê·¸ëŠ” íŒŒì•¼ë ˆë°”ì—ì„œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.\n/ì´ë™ íŒŒì•¼ë ˆë°” ë¡œ ë³µê·€í•´ì£¼ì„¸ìš”.");
        return;
      }
      var champ = d.champion || NPC_CHAMPION;
      var owner = champ.name;
      var info = champ.isNpc ? "NPC (ì´ˆëŒ€ ì±”í”¼ì–¸)" : "ğŸ‘‘ í˜„ ì„œë²„ ìµœê°•ì";
      var line = "ğŸ† [í¬ì¼“ëª¬ ë¦¬ê·¸ ì±”í”¼ì–¸]\n\n" + "ğŸ‘¤ " + owner + "\n" + "ğŸ“ " + info + "\n\n" + "ğŸ›¡ï¸ ë°©ì–´ ë¼ì¸ì—… (6ë§ˆë¦¬)\n";
      for (var i = 0; i < champ.lineup.length; i++) {
        var p = champ.lineup[i];
        var icon = p.shiny ? "âœ¨" : "";
        var grade = p.grade ? (" [" + p.grade + "]") : "";
        line += (i + 1) + ". " + icon + p.name + " (" + (p.enh || 0) + "ê°•)" + grade + "\n";
      }
      line += "\nâš”ï¸ ë„ì „í•˜ë ¤ë©´ '/ì±”í”¼ì–¸ ë„ì „'ì„ ì…ë ¥í•˜ì„¸ìš”.\n(8ê°œ ë°°ì§€ ë³´ìœ  í•„ìˆ˜ / ì…ì¥ë£Œ 5,000ë§ŒğŸ’°)";
      replier.reply(line);
      return;
    }
// ==================== [ìˆ˜ì •ë¨] ì±”í”¼ì–¸ ë„ì „ (ì—”íŠ¸ë¦¬ 6ë§ˆë¦¬ í’€íŒŒí‹°) ====================
if (msg === "/ì±”í”¼ì–¸ ë„ì „") {
    if (!isInTaechoVillage(u)) { replier.reply("ğŸš« ì±”í”¼ì–¸ ë„ì „ì€ íŒŒì•¼ë ˆë°”ì—ì„œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.\n/ì´ë™ íŒŒì•¼ë ˆë°” ë¡œ ë³µê·€í•´ì£¼ì„¸ìš”."); return; }
    
    // 1. ìê²© ì²´í¬
    if (!u.badges || u.badges.length < 8) {
        replier.reply("ğŸš« ë„ì „ ìê²©ì´ ì—†ìŠµë‹ˆë‹¤.\n8ê°œì˜ ì²´ìœ¡ê´€ ë°°ì§€ë¥¼ ëª¨ë‘ ëª¨ì•„ì•¼ í•©ë‹ˆë‹¤.");
        return;
    }

    // 2. â˜… ì—”íŠ¸ë¦¬ ì²´í¬ (6ë§ˆë¦¬ í•„ìˆ˜)
    if (!u.party || u.party.length < 6) {
        replier.reply("ğŸš« [ë„ì „ ë¶ˆê°€] ì±”í”¼ì–¸ ë¦¬ê·¸ëŠ” ë°˜ë“œì‹œ 6ë§ˆë¦¬ í’€íŒŒí‹°ë¡œ ë„ì „í•´ì•¼ í•©ë‹ˆë‹¤.\n(í˜„ì¬: " + (u.party?u.party.length:0) + "ë§ˆë¦¬)\nğŸ‘‰ '/ë‚´ë°•ìŠ¤'ì—ì„œ ë©¤ë²„ë¥¼ ì±„ì›Œì£¼ì„¸ìš”!");
        return;
    }

    // 3. ì…ì¥ë£Œ ì²´í¬
    var champFee = 50000000;
    if (u.gold < champFee) {
        replier.reply("ğŸš« ì…ì¥ë£Œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.\ní•„ìš”: " + fmtNum(champFee) + "ğŸ’°");
        return;
    }

    // --- ì „íˆ¬ ì¤€ë¹„ ---
    var myTeam = [];
    for(var k=0; k<6; k++) {
        var p = findUserPokemonByUid(u, u.party[k]);
        if (!p) { replier.reply("ğŸš« ì—”íŠ¸ë¦¬ ì˜¤ë¥˜: ì¡´ì¬í•˜ì§€ ì•ŠëŠ” í¬ì¼“ëª¬ì´ ìˆìŠµë‹ˆë‹¤."); return; }
        if (isPokemonBusy(u, p.uid)) { replier.reply("ğŸš« ì—”íŠ¸ë¦¬ì˜ #" + p.uid + " " + getDisplayName(p) + "ì´(ê°€) íƒí—˜ ì¤‘ì…ë‹ˆë‹¤."); return; }
        myTeam.push(p);
    }

    u.gold -= champFee;

    // ì±”í”¼ì–¸ ë°ì´í„° ë¡œë“œ
    var currentChamp = d.champion || NPC_CHAMPION;
    var champTeamData = currentChamp.lineup;

    var result = simulateRelayBattle(myTeam, champTeamData, sender, "ğŸ‘‘ " + currentChamp.name, true);
    var out = blockTitle("ğŸ† ì±”í”¼ì–¸ íƒ€ì´í‹€ ë§¤ì¹˜ ğŸ†") + "\n" + result.log + "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\n";

    if (result.winner === "A") {
        out += "ğŸ‰ğŸ‰ğŸ‰ ê¸°ì ì´ ì¼ì–´ë‚¬ìŠµë‹ˆë‹¤! ğŸ‰ğŸ‰ğŸ‰\n\n";
        out += "ìƒˆë¡œìš´ ì±”í”¼ì–¸: " + sender + "ë‹˜!\n";
        out += "ê¸°ì¡´ ì±”í”¼ì–¸(" + currentChamp.name + ")ì„ êº¾ê³  ì™•ì¢Œì— ì˜¬ëìŠµë‹ˆë‹¤!\n\n";

        // ì±”í”¼ì–¸ ë°ì´í„° ê°±ì‹  (ë‚´ ì—”íŠ¸ë¦¬ ìŠ¤ëƒ…ìƒ·)
        var newSnapshot = JSON.parse(JSON.stringify(myTeam));
        for(var z=0; z<newSnapshot.length; z++) {
            var db = findPokemonDB(newSnapshot[z].pid);
            if(db) newSnapshot[z].name = db.name;
        }

        d.champion = {
            name: sender,
            isNpc: false,
            obtainedAt: nowMs(),
            lineup: newSnapshot
        };

        u.gold += 100000000;
        out += "\nğŸ’° ìƒê¸ˆ: 100,000,000ğŸ’° íšë“!";
        u.stats.championWins = (u.stats.championWins || 0) + 1;
        
        // ì¹œë°€ë„ ë³´ë„ˆìŠ¤
        for(var i=0; i<myTeam.length; i++) myTeam[i].friendship = 255; // ì „ì› MAX

    } else {
        out += "ğŸ’€ ë„ì „ ì‹¤íŒ¨...\nì±”í”¼ì–¸ì˜ ë²½ì€ ë†’ì•˜ìŠµë‹ˆë‹¤.";
    }

    commitSave(true);
    checkAndNotifyTitles(u, replier);
    replyFold(replier, "ğŸ† ì±”í”¼ì–¸ ë„ì „ ê²°ê³¼", out);
    return;
}


    if (msg === "/ë ˆì´ë“œ ì •ë³´" || msg === "/ë³´ìŠ¤") {
      if (!isInTaechoVillage(u)) {
        replier.reply("ğŸš« ë ˆì´ë“œëŠ” íŒŒì•¼ë ˆë°”ì—ì„œë§Œ í™•ì¸/ì°¸ì—¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n/ì´ë™ íŒŒì•¼ë ˆë°” ë¡œ ë³µê·€í•´ì£¼ì„¸ìš”.");
        return;
      }
      if (!d.worldBoss || !d.worldBoss.active) {
        replier.reply("ğŸ’¤ í˜„ì¬ ì¶œí˜„í•œ ì›”ë“œ ë³´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      var b = d.worldBoss;
      var now = nowMs();      // nowMs() í•¨ìˆ˜ ì‚¬ìš©
      var remain = b.endTime - now;
      if (remain <= 0) {
        // ì‹œê°„ ì´ˆê³¼ ì²˜ë¦¬
        var endMsg = endRaidBoss(d, false);        // ì‹¤íŒ¨ ì²˜ë¦¬
        commitSave(true);
        replier.reply(endMsg);
        return;
      }
      var min = Math.floor(remain / 60000);
      var hpPct = Math.floor((b.curHp / b.maxHp) * 1000) / 10;
      var barLen = 10;
      var filled = Math.floor((b.curHp / b.maxHp) * barLen);
      var bar = "";
      for (var i = 0; i < barLen; i++) 
        bar += (i < filled ? "ğŸŸ¥" : "â¬œ");
      var rankTxt = "";
      var list = [];
      var totalDmg = 0;
      for (var name in b.logs) {
        var dmg = b.logs[name] || 0;
        totalDmg += dmg;
        list.push({
  n: name, 
  d: dmg});
      }
      list.sort(function(a, b) {
  return b.d - a.d;
});
      for (var k = 0; k < Math.min(5, list.length); k++) {
        var pct = totalDmg > 0 ? Math.floor((list[k].d / totalDmg) * 1000) / 10 : 0;
        rankTxt += (k + 1) + ". " + list[k].n + " (" + fmtNum(list[k].d) + " / " + pct + "%)\n";
      }
      if (!rankTxt) 
        rankTxt = "(ì•„ì§ ì°¸ì—¬ìê°€ ì—†ìŠµë‹ˆë‹¤)";
      replier.reply("ğŸ¦– [ì›”ë“œ ë³´ìŠ¤] " + b.name + "\n" + "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + "â¤ï¸ ì²´ë ¥: " + fmtNum(b.curHp) + " / " + fmtNum(b.maxHp) + " (" + hpPct + "%)\n" + "[" + bar + "]\n\n" + "â³ ë‚¨ì€ ì‹œê°„: " + min + "ë¶„\n" + "ğŸ’° í˜„ì¬ ê¸ˆê³ : " + fmtNum(b.rewardPool || 0) + " ì½”ì¸\n\n" + "ğŸ† [ë”œ ë¯¸í„°ê¸° TOP 5]\n" + rankTxt + "\n" + "ğŸ‘‰ ì°¸ì—¬: '/ë ˆì´ë“œ' ì…ë ¥ (ë¬¸ì œ í’€ê³  ê³µê²©!)");
      return;
    }
    if (msg === "/ì¹˜ë£Œ") {
      var nowHeal = nowMs();
      var remainHeal = RAID_COOLDOWN_MS - (nowHeal - u.lastRaidAt);
      if (remainHeal <= 0) {
        replier.reply("âœ… " + decoName + "ë‹˜ì€ í˜„ì¬ ì¹˜ë£Œê°€ í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        return;
      }
      if (remainHeal <= RAID_VIP_HEAL_REMAIN_MS) {
        replier.reply("â±ï¸ ì´ë¯¸ ê±°ì˜ íšŒë³µë˜ì—ˆìŠµë‹ˆë‹¤.\n(ë‚¨ì€ ì‹œê°„: " + Math.ceil(remainHeal / 1000) + "ì´ˆ)");
        return;
      }
      if (u.gold < RAID_VIP_HEAL_COST) {
        replier.reply("ğŸš« VIP ì¹˜ë£Œ ë¹„ìš©ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.\ní•„ìš” ê³¨ë“œ: " + fmtNum(RAID_VIP_HEAL_COST) + "\në³´ìœ  ê³¨ë“œ: " + fmtNum(u.gold));
        return;
      }
      u.gold -= RAID_VIP_HEAL_COST;
      u.lastRaidAt = nowHeal - (RAID_COOLDOWN_MS - RAID_VIP_HEAL_REMAIN_MS);
      commitSave(true);
      replier.reply("ğŸ’‰ [VIP ì¹˜ë£Œ ì™„ë£Œ] " + decoName + "ë‹˜\n" + "-" + fmtNum(RAID_VIP_HEAL_COST) + " ê³¨ë“œ ì§€ë¶ˆ\n" + "ğŸš‘ ê°„í˜¸ìˆœ íŠ¹ê¸‰ ì¼€ì–´ë¡œ íšŒë³µ ì‹œê°„ì´ 5ì´ˆë¡œ ë‹¨ì¶•ë˜ì—ˆìŠµë‹ˆë‹¤!");
      return;
    }
    if (u.raidCaptcha && !isNaN(msg)) {
      var inputAns = parseInt(msg, 10);
      var now = new Date().getTime();
      // ì‹œê°„ ì´ˆê³¼ (15ì´ˆ ì§€ë‚¨) -> ë¬¸ì œ ì‚­ì œ ë° ë¬´ì‹œ
      if (now > u.raidCaptcha.expire) {
        delete u.raidCaptcha;
        return;
      }
      if (inputAns === u.raidCaptcha.ans) {
        var finisherReady = !!u.raidCaptcha.finisher;
        delete u.raidCaptcha;        // ë¬¸ì œ ì‚­ì œ
        // â˜… ì—¬ê¸°ì„œ ì•„ê¹Œ ë§Œë“  ê³µê²© í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤!
        executeRaidAttack(d, room, sender, u, replier, decoName, finisherReady);
        return;
      }
    }
    if (msg === "/ë ˆì´ë“œ") {
      if (!isInTaechoVillage(u)) {
        replier.reply("ğŸš« ë ˆì´ë“œëŠ” íŒŒì•¼ë ˆë°”ì—ì„œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        return;
      }
      if (!d.worldBoss || !d.worldBoss.active) {
        replier.reply("ğŸ’¤ ì§„í–‰ ì¤‘ì¸ ë ˆì´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      if (d.worldBoss.endTime <= new Date().getTime()) {
        replier.reply("â° ë ˆì´ë“œê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        return;
      }
      // [ìˆ˜ì •ë¨] ì—”íŠ¸ë¦¬ ì²´í¬
      if (!u.party || u.party.length < 6) {
        replier.reply("ğŸš« ë ˆì´ë“œì— ì°¸ì—¬í•˜ë ¤ë©´ ì—”íŠ¸ë¦¬ 6ë§ˆë¦¬ê°€ ê½‰ ì°¨ìˆì–´ì•¼ í•©ë‹ˆë‹¤.\n(í˜„ì¬: " + (u.party?u.party.length:0) + "ë§ˆë¦¬)\nğŸ‘‰ '/ë‚´ë°•ìŠ¤'ì—ì„œ ë©¤ë²„ë¥¼ ë³´ì¶©í•˜ì„¸ìš”!"); 
        return;
      }

      if (nowMs() - u.lastRaidAt < RAID_COOLDOWN_MS) {
        var remain = Math.ceil((RAID_COOLDOWN_MS - (nowMs() - u.lastRaidAt)) / 1000);
        replier.reply("ğŸš‘ [ì¹˜ë£Œ ì¤‘] ë‚¨ì€ ì‹œê°„: " + remain + "ì´ˆ");
        return;
      }
      if (u.raidCaptcha) {
        var left = u.raidCaptcha.expire - new Date().getTime();
        if (left > 0) {
          replier.reply("ğŸ”’ ì´ë¯¸ ìŠ¹ì¸ ì½”ë“œê°€ ë°œê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤.");
          return;
        }
      }
      if (!d.worldBoss.attackCounts) 
        d.worldBoss.attackCounts = {};
      
      var myCount = d.worldBoss.attackCounts[sender] || 0;
      var FINISHER_REQ = 30;
      var isFinisherQuiz = ((myCount + 1) % FINISHER_REQ === 0);
      var qText = "";
      var ans = 0;

      // [A] í•„ì‚´ê¸°ìš©: ê³ ë‚œì´ë„
      if (isFinisherQuiz) {
        var qType = randInt(1, 4);
        if (qType === 1) {
          var divisor = randInt(3, 12);
          var answer = randInt(11, 30);
          var dividend = divisor * answer;
          qText = "ğŸ”¥[í•„ì‚´ê¸°] " + dividend + " Ã· " + divisor;
          ans = answer;
        } else if (qType === 2) {
          var n1 = randInt(5, 20);
          var n2 = randInt(5, 20);
          var n3 = randInt(2, 9);
          qText = "ğŸ”¥[í•„ì‚´ê¸°] (" + n1 + " + " + n2 + ") Ã— " + n3;
          ans = (n1 + n2) * n3;
        } else if (qType === 3) {
          var n1 = randInt(50, 100);
          var n2 = randInt(5, 12);
          var n3 = randInt(3, 9);
          qText = "ğŸ”¥[í•„ì‚´ê¸°] " + n1 + " + " + n2 + " Ã— " + n3;
          ans = n1 + (n2 * n3);
        } else {
          var n1 = randInt(11, 19);
          var n2 = randInt(11, 19);
          qText = "ğŸ”¥[í•„ì‚´ê¸°] " + n1 + " Ã— " + n2;
          ans = n1 * n2;
        }
      } else {
        var n1 = randInt(11, 99);
        var n2 = randInt(11, 99);
        if (Math.random() < 0.5) {
          qText = n1 + " + " + n2;
          ans = n1 + n2;
        } else {
          var max = Math.max(n1, n2);
          var min = Math.min(n1, n2);
          qText = max + " - " + min;
          ans = max - min;
        }
      }

      u.raidCaptcha = {
        ans: ans, 
        finisher: isFinisherQuiz, 
        expire: new Date().getTime() + 15000
      };
      commitSave(true);

      // ì¶œë ¥ ë©˜íŠ¸ ì •ë¦¬
      var countMsg = "\n(ëˆ„ì  ê³µê²©: " + myCount + "íšŒ / í•„ì‚´ê¸°ê¹Œì§€ " + (FINISHER_REQ - (myCount % FINISHER_REQ)) + "íšŒ)";
      if (isFinisherQuiz) {
        countMsg = "\nğŸ”¥ [í•„ì‚´ê¸° ë°œë™] ê³ ë‚œì´ë„ ë¬¸ì œì…ë‹ˆë‹¤! ì§‘ì¤‘í•˜ì„¸ìš”!!";
      }

      // âœ… ì‚¬ì¥ë‹˜ ì½”ë“œì˜ ë³€ìˆ˜ëª… qTextì™€ decoNameì„ ì •í™•íˆ ë§¤ì¹­í–ˆìŠµë‹ˆë‹¤.
      replier.reply("ğŸ”’ [" + decoName + "ë‹˜ì˜ ê³µê²© ì½”ë“œ]\n" + qText + " = ?\n" + countMsg);
      return;
    }

  }  catch (e) {
  // <--- â˜… 2. ë§¨ ì•„ë˜ ë‹«ê¸° ì§ì „ì— ì´ê±° ì¶”ê°€
  Log.error("ğŸš¨ ì—ëŸ¬ ë°œìƒ: " + e + " (Line: " + (e.lineNumber || "Unknown") + ")");
  replier.reply("ì‹œìŠ¤í…œ ì˜¤ë¥˜: " + e);
}
}
// â˜… ì—¬ê¸°ê°€ response í•¨ìˆ˜ ë (ë¦¬ìŠ¤í° ë‹«ê¸°)


// ==================================================================
// ğŸ”§ [ìœ í‹¸] ë°ì´í„° ê´€ë¦¬ ë° íƒ€ì´í‹€ ì•Œë¦¼ í•¨ìˆ˜
// ==================================================================
// [ìˆ˜ì •ë¨] ë¯¸ì ‘ì†ì ì •ë¦¬ í•¨ìˆ˜ (ëˆ„ë½ëœ ë¶€ë¶„ ë³µêµ¬ ì™„ë£Œ)
function manageInactiveUsers(d) {
  var now = new Date().getTime();
  var archivePath = "/sdcard/mbot_pokemon_archive.json";
  // íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
  var file = new java.io.File(archivePath);
  var archive = {};
  if (file.exists()) {
    var archiveStr = readFile(archivePath);    // File.read ëŒ€ì‹  readFile ì‚¬ìš© ê¶Œì¥
    if (!archiveStr) {
      // readFileì´ ì‹¤íŒ¨í–ˆì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ê¸°ì¡´ File.read ì‹œë„ (í™˜ê²½ í˜¸í™˜ì„±)
      try {
        archiveStr = File.read(archivePath);
      }      catch (e) {
}
    }
    if (archiveStr) {
      try {
        archive = JSON.parse(archiveStr);
      }      catch (e) {
  archive = {};
}
    }
  }
  var deletedCount = 0;
  var archivedCount = 0;
  var users = d.users;
  var keys = Object.keys(users);
  var day = 24 * 60 * 60 * 1000;
  var limitDelete = 30 * day;
  var limitArchive = 2 * day;
  for (var i = 0; i < keys.length; i++) {
    var key = keys[i];
    var u = users[key];
    if (!u.lastDate) 
      continue;
    var diff = now - u.lastDate;
    if (diff > limitDelete) {
      delete users[key];
      deletedCount++;
    } else if (diff > limitArchive) {
      archive[key] = u;
      delete users[key];
      archivedCount++;
    }
  }
  // ì •ë¦¬ ê²°ê³¼ ì €ì¥ ë° ë°˜í™˜
  if (deletedCount > 0 || archivedCount > 0) {
    saveData(d);
    // ì•„ì¹´ì´ë¸Œ íŒŒì¼ ì €ì¥
    var fos = new java.io.FileOutputStream(file);
    var str = new java.lang.String(JSON.stringify(archive));
    fos.write(str.getBytes());
    fos.close();
    return "âœ… ë°ì´í„° ì •ë¦¬ ì™„ë£Œ!\nğŸ—‘ï¸ ì˜êµ¬ ì‚­ì œ: " + deletedCount + "ëª…\nğŸ“¦ ì•„ì¹´ì´ë¹™: " + archivedCount + "ëª…";
  } else {
    return "âœ¨ ì •ë¦¬í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
  }
}
// ì¹­í˜¸ íšë“ ì•Œë¦¼ í•¨ìˆ˜
function checkAndNotifyTitles(u, replier) {
  var gained = updateTitles(u);
  if (gained && gained.length > 0) {
    replier.reply("ğŸŠ [ì¹­í˜¸ íšë“!] ğŸŠ\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + gained.map(n => "['" + n + "']").join(", ") + " ì„(ë¥¼) ì–»ì—ˆìŠµë‹ˆë‹¤!");
  }
}

// ğŸ” [ì§€ëŠ¥í˜• ê²€ìƒ‰ ì—”ì§„] UID ìˆ«ì ë˜ëŠ” ë³„ëª…ìœ¼ë¡œ í¬ì¼“ëª¬ ì°¾ê¸°
function findPokemonByAny(u, input) {
  if (!u || !u.pokemons) return null;
  
  // 1. ìˆ«ìì¸ ê²½ìš° (UID ê²€ìƒ‰)
  var uid = parseInt(input, 10);
  if (!isNaN(uid)) {
    for (var i = 0; i < u.pokemons.length; i++) {
      if (u.pokemons[i].uid === uid) return u.pokemons[i];
    }
  }

  // 2. ë¬¸ìì—´ì¸ ê²½ìš° (ë³„ëª… ê²€ìƒ‰)
  var searchName = String(input).trim();
  for (var j = 0; j < u.pokemons.length; j++) {
    if (u.pokemons[j].nickname === searchName) {
      return u.pokemons[j];
    }
  }
  
  return null;
}
