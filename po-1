var scriptName = "ì£ ë´‡ í¬ì¼“ëª¬";

// â˜… [ì‹ ê·œ] ê¹ƒí—ˆë¸Œ ìë™ ì—…ë°ì´íŠ¸ìš© ë³€ìˆ˜
var GITHUB_RAW_URL = "https://raw.githubusercontent.com/sonsajang92/Firstpoke/main/po-1";
var SCRIPT_NAME = "ì£ ë´‡ í¬ì¼“ëª¬"; // ë©”ì‹ ì €ë´‡R ì•±ì— ì íŒ ì´ë¦„ê³¼ ì •í™•íˆ ì¼ì¹˜í•´ì•¼ í•¨
// -------------------- ì „ì²´ë³´ê¸°(ì ‘ê¸°) SAFE --------------------
// ì¹´í†¡/ë©”ì‹ ì €ë´‡Rì—ì„œ ë„ˆë¬´ ê¸´ ë©”ì‹œì§€ëŠ” ì „ì†¡ ì‹¤íŒ¨/í¬ë˜ì‹œ ìœ ë°œ ê°€ëŠ¥
function replyFold(replier, summary, full) {
  summary = String(summary || "");
  full = String(full || "");

  // âœ… ìš”ì•½ì´ ê¸¸ì–´ì§€ë©´, ë’¤ìª½ì„ ì˜ë¼ì„œ ì „ì²´ë³´ê¸°ë¡œ ë³´ë‚´ë²„ë¦¼
  var SUMMARY_LIMIT = 220; // 180~260 ì‚¬ì´ë¡œ ì·¨í–¥ ì¡°ì ˆ

  if (summary.length > SUMMARY_LIMIT) {
    var overflow = summary.substring(SUMMARY_LIMIT);
    summary = summary.substring(0, SUMMARY_LIMIT) + "\n... (ì „ì²´ë³´ê¸°)";
    // overflowë¥¼ full ì•ì— ë¶™ì—¬ì„œ "ëª©ë¡"ì´ ì „ì²´ë³´ê¸°ì— ë“¤ì–´ê°€ê²Œ í•¨
    full = overflow + "\n\n" + full;
  }

  replier.reply(summary + "\u200b".repeat(500) + (full ? ("\n" + full) : " "));
}
//ê³¨ë“œì½¤ë§ˆ
function fmtNum(n) {
  n = parseInt(n, 10);
  if (isNaN(n)) n = 0;
  return String(n).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

// null/undefined ëŒ€ë¹„ìš© (ìˆ«ì ì•„ë‹Œ ê°’ë„ ê·¸ëƒ¥ ë¬¸ìì—´ë¡œ)
function fmtAny(v) {
  if (v === null || v === undefined) return "";
  if (typeof v === "number") return fmtNum(v);
  // "12345" ê°™ì€ ìˆ«ì ë¬¸ìì—´ì´ë©´ ì½¤ë§ˆ
  if (typeof v === "string" && /^-?\d+$/.test(v)) return fmtNum(v);
  return String(v);
}

// -------------------- ì €ì¥ íŒŒì¼ ê²½ë¡œ --------------------
var DATA_PATH = "/sdcard/mbot_pokemon_db.json";
// -------------------- ë°¸ëŸ°ìŠ¤(í‘œì¤€) --------------------
var MAX_LV = 150;
var ENHANCE_MAX = 60;
var FIELD_COOLDOWN_MS = 10 * 1000;// /í•„ë“œ 10ì´ˆ
var EXPLORE_COOLDOWN_MS = 30 * 1000;// /íƒí—˜ 30ì´ˆ
var ENHANCE_COOLDOWN_MS = 5 * 1000;// /ê°•í™” 5ì´ˆ
var BATTLE_COOLDOWN_MS = 10 * 1000;// /ë°°í‹€ 10ì´ˆ
var ACTIVE_TTL_MS = 6 * 60 * 60 * 1000;// 6ì‹œê°„ ì´ë‚´ ì±„íŒ…í•œ ìœ ì €ë§Œ ë°°í‹€ ë§¤ì¹­

// í¬íš ë³´ìƒ (ë‚œìˆ˜)
var CATCH_GOLD_MIN = 35;
var CATCH_GOLD_MAX = 85;
var CATCH_EXP_MIN = 12;
var CATCH_EXP_MAX = 26;
// [ì‹ ê·œ] ì´ë¡œì¹˜(Shiny) í™•ë¥  (0.005 = 0.5%)
var SHINY_PROBABILITY = 0.005;

// í¬íš ë³´ìƒ ì•ˆì „ ìº¡(ê²½ì œ í­ì£¼ ë°©ì§€)
var CATCH_GOLD_CAP = 220;
var CATCH_EXP_CAP = 80;
// -------------------- íƒí—˜ ë³´ìƒ ë°¸ëŸ°ìŠ¤ (ììœ  ê²½ì œ íŒ¨ì¹˜) --------------------
var EXPLORE_GOLD_MIN = 100;   
var EXPLORE_GOLD_MAX = 500;   
var EXPLORE_EXP_MIN = 18;      
var EXPLORE_EXP_MAX = 42;      
var EXPLORE_LV_RATE = 0.15;    

// ì•ˆì „ ìº¡ ì œê±° (ì£¼ì„ ì²˜ë¦¬í•˜ê±°ë‚˜ ì•„ì£¼ í° ê°’ìœ¼ë¡œ ì„¤ì •)
// var EXPLORE_GOLD_CAP = 999999999999; 


// ë°°í‹€ ë³´ìƒ
var BATTLE_GOLD_WIN = 140;
var BATTLE_GOLD_LOSE = 40;
var BATTLE_EXP_WIN = 65;
var BATTLE_EXP_LOSE = 30;

// ìŠ¹ë¦¬ ë³´ë„ˆìŠ¤(ê°•í™” +1)
var BATTLE_BONUS_ENH_CHANCE = 0.07;

// ë³¼ ê°€ê²©(ìƒì )
var SHOP_PRICE_BALL = 100;
var SHOP_PRICE_SUPER = 500;
var SHOP_PRICE_ULTRA = 1000;
var SHOP_PRICE_GOD = 100000000;  // ìŠˆí¼ìš¸íŠ¸ë¼í‚¹ê°“ì— í˜ëŸ¬ê°œì©ŒëŠ”í•˜ì´í¼ì±Œë¦°ì €í˜ì´ì»¤í‰ë²”í•œìš©íƒœëŠ”ë¯¸ì¹œì‚¬ëŒê°“ë¯¼ìˆ˜ë„ë¶€ë³¼ (1ì–µ ğŸ’°)
var SHOP_PRICE_DOPA = 50000;// ë„íŒŒë¯¼ê°•í™”ê¶Œ
var SHOP_PRICE_COOKIE = 800000; // ë‘ì«€ì¿  (100% +1ê°•)
var SHOP_PRICE_TICKET = 5000;  // ì´ë™ í‹°ì¼“ (ì›í•˜ëŠ” ì§€ì—­ ì´ë™)
var SHOP_PRICE_REROLL = 50000; // ë“±ê¸‰ ì¬ì„¤ì •ê¶Œ (S~D ëœë¤)

// íƒ€ì… ìƒì„± ì¬ë§¤í•‘ ê°’(0->1, 0.5->1.5, 1->2, 2->3.5)
var TYPE_STRONG = 4.4;
// ë°ë¯¸ì§€ ê°•í™” í¼ì„¼íŠ¸ ê¸°ì—¬
var ATK_ENH_RATE = 0.085;
var DEF_ENH_RATE = 0.050;
// ë°°í‹€ ê´€ë ¨ 
var MAX_BATTLE_CHAIN = 5;
var STREAK_GOLD_BONUS_EVERY = 3;
var STREAK_GOLD_BONUS = 60;
var STREAK_EXP_BONUS_EVERY = 5;
var STREAK_EXP_BONUS = 25;
var STREAK_ENH_BONUS_EVERY = 10;
var STREAK_ENH_BONUS_CHANCE = 0.12;// 10ì—°ìŠ¹ ë„ë‹¬ ì‹œ ì¶”ê°€ í™•ë¥ 
var MIN_BATTLE_ENH = 5;
var BALL_CATCH_MULT = [1.00, 3.00, 5.00, 100.00];
var ACTIVE_SAVE_INTERVAL_MS = 20 * 1000;// 20ì´ˆì— 1ë²ˆë§Œ ì €ì¥
var MATCH_POOL_KEY = "__GLOBAL_MATCH__";
// ==================== ë°°í‹€ ì°¸ê°€ ìµœì†Œ ê°•í™” ====================
var BATTLE_MIN_ENH = 20; // 5 -> 20

// ==================== [ë ˆì´ë“œ] ì›”ë“œ ë³´ìŠ¤ ì„¤ì • ====================
var RAID_BOSS_DEFAULT_HP = 2000000000; // 20ì–µ
var RAID_DURATION_MS = 2 * 60 * 60 * 1000; // 2ì‹œê°„

// â˜… [ìˆ˜ì •] 5ë¶„ -> 1ë¶„ (ê°„í˜¸ìˆœ ìºë¦¬)
var RAID_COOLDOWN_MS = 2 * 60 * 1000; 
var RAID_MIN_COIN = 1; 
var RAID_MAX_COIN = 3; 

// ==================== [ë‹¤ì½”íƒ€ ì•”ì‹œì¥] ê°€ê²© ë° í™•ë¥  ì„¤ì • (ì¸í”Œë ˆì´ì…˜ íŒ¨ì¹˜) ====================

// 1. ì•„ì´í…œ ê°€ê²© (ë‹¨ìœ„: ë‹¤ì½”íƒ€ ì½”ì¸)
// ë ˆì´ë“œ 1íšŒ 1ë“± ê¸°ëŒ€ ìˆ˜ìµ: ì•½ 150~200 ì½”ì¸
var DAKOTA_PRICE_BOX = 50;      // ì¥ë¹„ìƒì (ë¹„ìŒˆ! ì‹ ì¤‘í•˜ê²Œ êµ¬ë§¤)
var DAKOTA_PRICE_DDAL = 500;     // ë”¸ê¸°ì¿ í‚¤ (+3ê°• í™•ì •ì˜ ê°€ì¹˜)
var DAKOTA_PRICE_NUT = 1000;     // í™©ê¸ˆì—´ë§¤ (ì¡¸ì—…ê¸‰ ìŠ¤í™)
var DAKOTA_PRICE_PAINT = 2500;   // í™©ê¸ˆí˜ì¸íŠ¸ (ë¶€ì˜ ìƒì§•)

// 2. ìƒìê¹¡ í™•ë¥  ì„¤ì • (ì´í•© 1.0)
// ê½ ëŒ€ì‹  'íŒŒí¸'ì´ ë‚˜ì˜¤ë¯€ë¡œ, ì¥ë¹„ íšë“ í™•ë¥ ì€ ì¢€ ë‚®ì•„ë„ ë©ë‹ˆë‹¤.
var BOX_PROB_TIER_3 = 0.01; // ğŸ‘‘ ì „ì„¤ (1%) - ì—”ë“œê¸‰
var BOX_PROB_TIER_2 = 0.19; // ğŸ”¹ í¬ê·€ (19%)
var BOX_PROB_TIER_1 = 0.40; // âšª ì¼ë°˜ (40%)
// ë‚˜ë¨¸ì§€ 40% = 'ìƒìíŒŒí¸' (10ê°œ ëª¨ìœ¼ë©´ ìƒì 1ê°œ)




// -------------------- 1ì„¸ëŒ€ 151 DB --------------------
var POKEMON_DB = [
  { id: 1, name: "ì´ìƒí•´ì”¨", type1: "í’€", type2: "ë…", basePower: 50, rarity: 2 },
  { id: 2, name: "ì´ìƒí•´í’€", type1: "í’€", type2: "ë…", basePower: 70, rarity: 3 },
  { id: 3, name: "ì´ìƒí•´ê½ƒ", type1: "í’€", type2: "ë…", basePower: 90, rarity: 4 },

  { id: 4, name: "íŒŒì´ë¦¬", type1: "ë¶ˆ", type2: null, basePower: 50, rarity: 2 },
  { id: 5, name: "ë¦¬ìë“œ", type1: "ë¶ˆ", type2: null, basePower: 70, rarity: 3 },
  { id: 6, name: "ë¦¬ìëª½", type1: "ë¶ˆ", type2: "ë¹„í–‰", basePower: 92, rarity: 4 },

  { id: 7, name: "ê¼¬ë¶€ê¸°", type1: "ë¬¼", type2: null, basePower: 48, rarity: 2 },
  { id: 8, name: "ì–´ë‹ˆë¶€ê¸°", type1: "ë¬¼", type2: null, basePower: 68, rarity: 3 },
  { id: 9, name: "ê±°ë¶ì™•", type1: "ë¬¼", type2: null, basePower: 90, rarity: 4 },

  { id: 10, name: "ìºí„°í”¼", type1: "ë²Œë ˆ", type2: null, basePower: 30, rarity: 1 },
  { id: 11, name: "ë‹¨ë°ê¸°", type1: "ë²Œë ˆ", type2: null, basePower: 35, rarity: 1 },
  { id: 12, name: "ë²„í„°í”Œ", type1: "ë²Œë ˆ", type2: "ë¹„í–‰", basePower: 65, rarity: 2 },

  { id: 13, name: "ë¿”ì¶©ì´", type1: "ë²Œë ˆ", type2: "ë…", basePower: 30, rarity: 1 },
  { id: 14, name: "ë”±ì¶©ì´", type1: "ë²Œë ˆ", type2: "ë…", basePower: 35, rarity: 1 },
  { id: 15, name: "ë…ì¹¨ë¶•", type1: "ë²Œë ˆ", type2: "ë…", basePower: 70, rarity: 2 },

  { id: 16, name: "êµ¬êµ¬", type1: "ë…¸ë§", type2: "ë¹„í–‰", basePower: 40, rarity: 1 },
  { id: 17, name: "í”¼ì£¤", type1: "ë…¸ë§", type2: "ë¹„í–‰", basePower: 60, rarity: 2 },
  { id: 18, name: "í”¼ì£¤íˆ¬", type1: "ë…¸ë§", type2: "ë¹„í–‰", basePower: 82, rarity: 3 },

  { id: 19, name: "ê¼¬ë ›", type1: "ë…¸ë§", type2: null, basePower: 42, rarity: 1 },
  { id: 20, name: "ë ˆíŠ¸ë¼", type1: "ë…¸ë§", type2: null, basePower: 68, rarity: 2 },

  { id: 21, name: "ê¹¨ë¹„ì°¸", type1: "ë…¸ë§", type2: "ë¹„í–‰", basePower: 45, rarity: 1 },
  { id: 22, name: "ê¹¨ë¹„ë“œë¦´ì¡°", type1: "ë…¸ë§", type2: "ë¹„í–‰", basePower: 78, rarity: 2 },

  { id: 23, name: "ì•„ë³´", type1: "ë…", type2: null, basePower: 45, rarity: 1 },
  { id: 24, name: "ì•„ë³´í¬", type1: "ë…", type2: null, basePower: 75, rarity: 2 },

  { id: 25, name: "í”¼ì¹´ì¸„", type1: "ì „ê¸°", type2: null, basePower: 55, rarity: 3 },
  { id: 26, name: "ë¼ì´ì¸„", type1: "ì „ê¸°", type2: null, basePower: 78, rarity: 3 },

  { id: 27, name: "ëª¨ë˜ë‘ì§€", type1: "ë•…", type2: null, basePower: 50, rarity: 2 },
  { id: 28, name: "ê³ ì§€", type1: "ë•…", type2: null, basePower: 78, rarity: 3 },

  { id: 29, name: "ë‹ˆë“œëŸ°â™€", type1: "ë…", type2: null, basePower: 46, rarity: 2 },
  { id: 30, name: "ë‹ˆë“œë¦¬ë‚˜", type1: "ë…", type2: null, basePower: 64, rarity: 2 },
  { id: 31, name: "ë‹ˆë“œí€¸", type1: "ë…", type2: "ë•…", basePower: 88, rarity: 4 },

  { id: 32, name: "ë‹ˆë“œëŸ°â™‚", type1: "ë…", type2: null, basePower: 46, rarity: 2 },
  { id: 33, name: "ë‹ˆë“œë¦¬ë…¸", type1: "ë…", type2: null, basePower: 64, rarity: 2 },
  { id: 34, name: "ë‹ˆë“œí‚¹", type1: "ë…", type2: "ë•…", basePower: 88, rarity: 4 },

  { id: 35, name: "ì‚ì‚", type1: "í˜ì–´ë¦¬", type2: null, basePower: 48, rarity: 3 },
  { id: 36, name: "í”½ì‹œ", type1: "í˜ì–´ë¦¬", type2: null, basePower: 78, rarity: 3 },

  { id: 37, name: "ì‹ìŠ¤í…Œì¼", type1: "ë¶ˆ", type2: null, basePower: 45, rarity: 3 },
  { id: 38, name: "ë‚˜ì¸í…Œì¼", type1: "ë¶ˆ", type2: null, basePower: 80, rarity: 4 },

  { id: 39, name: "í‘¸ë¦°", type1: "ë…¸ë§", type2: "í˜ì–´ë¦¬", basePower: 45, rarity: 2 },
  { id: 40, name: "í‘¸í¬ë¦°", type1: "ë…¸ë§", type2: "í˜ì–´ë¦¬", basePower: 75, rarity: 3 },

  { id: 41, name: "ì£¼ë±ƒ", type1: "ë…", type2: "ë¹„í–‰", basePower: 40, rarity: 2 },
  { id: 42, name: "ê³¨ë±ƒ", type1: "ë…", type2: "ë¹„í–‰", basePower: 75, rarity: 3 },

  { id: 43, name: "ëšœë²…ìµ¸", type1: "í’€", type2: "ë…", basePower: 45, rarity: 2 },
  { id: 44, name: "ëƒ„ìƒˆê¼¬", type1: "í’€", type2: "ë…", basePower: 62, rarity: 2 },
  { id: 45, name: "ë¼í”Œë ˆì‹œì•„", type1: "í’€", type2: "ë…", basePower: 82, rarity: 3 },

  { id: 46, name: "íŒŒë¼ìŠ¤", type1: "ë²Œë ˆ", type2: "í’€", basePower: 42, rarity: 2 },
  { id: 47, name: "íŒŒë¼ì„¹íŠ¸", type1: "ë²Œë ˆ", type2: "í’€", basePower: 72, rarity: 3 },

  { id: 48, name: "ì½˜íŒ¡", type1: "ë²Œë ˆ", type2: "ë…", basePower: 40, rarity: 2 },
  { id: 49, name: "ë„ë‚˜ë¦¬", type1: "ë²Œë ˆ", type2: "ë…", basePower: 70, rarity: 3 },

  { id: 50, name: "ë””ê·¸ë‹¤", type1: "ë•…", type2: null, basePower: 45, rarity: 2 },
  { id: 51, name: "ë‹¥íŠ¸ë¦¬ì˜¤", type1: "ë•…", type2: null, basePower: 75, rarity: 3 },

  { id: 52, name: "ë‚˜ì˜¹", type1: "ë…¸ë§", type2: null, basePower: 48, rarity: 2 },
  { id: 53, name: "í˜ë¥´ì‹œì˜¨", type1: "ë…¸ë§", type2: null, basePower: 78, rarity: 3 },

  { id: 54, name: "ê³ ë¼íŒŒë•", type1: "ë¬¼", type2: null, basePower: 52, rarity: 2 },
  { id: 55, name: "ê³¨ë•", type1: "ë¬¼", type2: null, basePower: 80, rarity: 3 },

  { id: 56, name: "ë§í‚¤", type1: "ê²©íˆ¬", type2: null, basePower: 50, rarity: 2 },
  { id: 57, name: "ì„±ì›ìˆ­", type1: "ê²©íˆ¬", type2: null, basePower: 80, rarity: 3 },

  { id: 58, name: "ê°€ë””", type1: "ë¶ˆ", type2: null, basePower: 55, rarity: 3 },
  { id: 59, name: "ìœˆë””", type1: "ë¶ˆ", type2: null, basePower: 92, rarity: 4 },

  { id: 60, name: "ë°œì±™ì´", type1: "ë¬¼", type2: null, basePower: 48, rarity: 2 },
  { id: 61, name: "ìŠˆë¥™ì±™ì´", type1: "ë¬¼", type2: null, basePower: 65, rarity: 2 },
  { id: 62, name: "ê°•ì±™ì´", type1: "ë¬¼", type2: "ê²©íˆ¬", basePower: 88, rarity: 4 },

  { id: 63, name: "ìºì´ì‹œ", type1: "ì—ìŠ¤í¼", type2: null, basePower: 45, rarity: 3 },
  { id: 64, name: "ìœ¤ê²”ë¼", type1: "ì—ìŠ¤í¼", type2: null, basePower: 72, rarity: 3 },
  { id: 65, name: "í›„ë”˜", type1: "ì—ìŠ¤í¼", type2: null, basePower: 92, rarity: 4 },

  { id: 66, name: "ì•Œí†µëª¬", type1: "ê²©íˆ¬", type2: null, basePower: 55, rarity: 2 },
  { id: 67, name: "ê·¼ìœ¡ëª¬", type1: "ê²©íˆ¬", type2: null, basePower: 72, rarity: 3 },
  { id: 68, name: "ê´´ë ¥ëª¬", type1: "ê²©íˆ¬", type2: null, basePower: 90, rarity: 4 },

  { id: 69, name: "ëª¨ë‹¤í”¼", type1: "í’€", type2: "ë…", basePower: 45, rarity: 2 },
  { id: 70, name: "ìš°ì¸ ë™", type1: "í’€", type2: "ë…", basePower: 65, rarity: 2 },
  { id: 71, name: "ìš°ì¸ ë³´íŠ¸", type1: "í’€", type2: "ë…", basePower: 88, rarity: 4 },

  { id: 72, name: "ì™•ëˆˆí•´", type1: "ë¬¼", type2: "ë…", basePower: 40, rarity: 2 },
  { id: 73, name: "ë…íŒŒë¦¬", type1: "ë¬¼", type2: "ë…", basePower: 75, rarity: 3 },

  { id: 74, name: "ê¼¬ë§ˆëŒ", type1: "ë°”ìœ„", type2: "ë•…", basePower: 50, rarity: 2 },
  { id: 75, name: "ë°êµ¬ë¦¬", type1: "ë°”ìœ„", type2: "ë•…", basePower: 70, rarity: 3 },
  { id: 76, name: "ë”±êµ¬ë¦¬", type1: "ë°”ìœ„", type2: "ë•…", basePower: 90, rarity: 4 },

  { id: 77, name: "í¬ë‹ˆíƒ€", type1: "ë¶ˆ", type2: null, basePower: 55, rarity: 2 },
  { id: 78, name: "ë‚ ìŒ©ë§ˆ", type1: "ë¶ˆ", type2: null, basePower: 85, rarity: 3 },

  { id: 79, name: "ì•¼ëˆ", type1: "ë¬¼", type2: "ì—ìŠ¤í¼", basePower: 45, rarity: 2 },
  { id: 80, name: "ì•¼ë„ë€", type1: "ë¬¼", type2: "ì—ìŠ¤í¼", basePower: 80, rarity: 3 },

  { id: 81, name: "ì½”ì¼", type1: "ì „ê¸°", type2: "ê°•ì² ", basePower: 45, rarity: 2 },
  { id: 82, name: "ë ˆì–´ì½”ì¼", type1: "ì „ê¸°", type2: "ê°•ì² ", basePower: 78, rarity: 3 },

  { id: 83, name: "íŒŒì˜¤ë¦¬", type1: "ë…¸ë§", type2: "ë¹„í–‰", basePower: 65, rarity: 3 },

  { id: 84, name: "ë‘ë‘", type1: "ë…¸ë§", type2: "ë¹„í–‰", basePower: 45, rarity: 2 },
  { id: 85, name: "ë‘íŠ¸ë¦¬ì˜¤", type1: "ë…¸ë§", type2: "ë¹„í–‰", basePower: 78, rarity: 3 },

  { id: 86, name: "ì¥¬ì¥¬", type1: "ë¬¼", type2: null, basePower: 45, rarity: 2 },
  { id: 87, name: "ì¥¬ë ˆê³¤", type1: "ë¬¼", type2: "ì–¼ìŒ", basePower: 82, rarity: 4 },

  { id: 88, name: "ì§ˆí½ì´", type1: "ë…", type2: null, basePower: 45, rarity: 2 },
  { id: 89, name: "ì§ˆë»ê¸°", type1: "ë…", type2: null, basePower: 78, rarity: 3 },

  { id: 90, name: "ì…€ëŸ¬", type1: "ë¬¼", type2: null, basePower: 40, rarity: 2 },
  { id: 91, name: "íŒŒë¥´ì…€", type1: "ë¬¼", type2: "ì–¼ìŒ", basePower: 85, rarity: 4 },

  { id: 92, name: "ê³ ì˜¤ìŠ¤", type1: "ê³ ìŠ¤íŠ¸", type2: "ë…", basePower: 45, rarity: 3 },
  { id: 93, name: "ê³ ìš°ìŠ¤íŠ¸", type1: "ê³ ìŠ¤íŠ¸", type2: "ë…", basePower: 68, rarity: 3 },
  { id: 94, name: "íŒ¬í…€", type1: "ê³ ìŠ¤íŠ¸", type2: "ë…", basePower: 90, rarity: 4 },

  { id: 95, name: "ë¡±ìŠ¤í†¤", type1: "ë°”ìœ„", type2: "ë•…", basePower: 80, rarity: 4 },

  { id: 96, name: "ìŠ¬ë¦¬í”„", type1: "ì—ìŠ¤í¼", type2: null, basePower: 45, rarity: 2 },
  { id: 97, name: "ìŠ¬ë¦¬í¼", type1: "ì—ìŠ¤í¼", type2: null, basePower: 78, rarity: 3 },

  { id: 98, name: "í¬ë©", type1: "ë¬¼", type2: null, basePower: 50, rarity: 2 },
  { id: 99, name: "í‚¹í¬ë©", type1: "ë¬¼", type2: null, basePower: 85, rarity: 3 },

  { id: 100, name: "ì°Œë¦¬ë¦¬ê³µ", type1: "ì „ê¸°", type2: null, basePower: 45, rarity: 2 },
  { id: 101, name: "ë¶ë³¼", type1: "ì „ê¸°", type2: null, basePower: 80, rarity: 3 },

  { id: 102, name: "ì•„ë¼ë¦¬", type1: "í’€", type2: "ì—ìŠ¤í¼", basePower: 45, rarity: 2 },
  { id: 103, name: "ë‚˜ì‹œ", type1: "í’€", type2: "ì—ìŠ¤í¼", basePower: 85, rarity: 3 },

  { id: 104, name: "íƒ•êµ¬ë¦¬", type1: "ë•…", type2: null, basePower: 50, rarity: 2 },
  { id: 105, name: "í……êµ¬ë¦¬", type1: "ë•…", type2: null, basePower: 82, rarity: 3 },

  { id: 106, name: "ì‹œë¼ì†Œëª¬", type1: "ê²©íˆ¬", type2: null, basePower: 85, rarity: 4 },
  { id: 107, name: "í™ìˆ˜ëª¬", type1: "ê²©íˆ¬", type2: null, basePower: 85, rarity: 4 },

  { id: 108, name: "ë‚´ë£¨ë¯¸", type1: "ë…¸ë§", type2: null, basePower: 70, rarity: 3 },

  { id: 109, name: "ë˜ê°€ìŠ¤", type1: "ë…", type2: null, basePower: 45, rarity: 2 },
  { id: 110, name: "ë˜ë„ê°€ìŠ¤", type1: "ë…", type2: null, basePower: 80, rarity: 3 },

  { id: 111, name: "ë¿”ì¹´ë…¸", type1: "ë•…", type2: "ë°”ìœ„", basePower: 60, rarity: 3 },
  { id: 112, name: "ì½”ë¿Œë¦¬", type1: "ë•…", type2: "ë°”ìœ„", basePower: 88, rarity: 4 },

  { id: 113, name: "ëŸ­í‚¤", type1: "ë…¸ë§", type2: null, basePower: 70, rarity: 4 },

  { id: 114, name: "ë©ì¿ ë¦¬", type1: "í’€", type2: null, basePower: 70, rarity: 3 },

  { id: 115, name: "ìº¥ì¹´", type1: "ë…¸ë§", type2: null, basePower: 88, rarity: 4 },

  { id: 116, name: "ì˜ë“œë¼", type1: "ë¬¼", type2: null, basePower: 45, rarity: 2 },
  { id: 117, name: "ì‹œë“œë¼", type1: "ë¬¼", type2: null, basePower: 80, rarity: 3 },

  { id: 118, name: "ì½˜ì¹˜", type1: "ë¬¼", type2: null, basePower: 45, rarity: 2 },
  { id: 119, name: "ì™•ì½˜ì¹˜", type1: "ë¬¼", type2: null, basePower: 80, rarity: 3 },

  { id: 120, name: "ë³„ê°€ì‚¬ë¦¬", type1: "ë¬¼", type2: null, basePower: 45, rarity: 2 },
  { id: 121, name: "ì•„ì¿ ìŠ¤íƒ€", type1: "ë¬¼", type2: "ì—ìŠ¤í¼", basePower: 82, rarity: 4 },

  { id: 122, name: "ë§ˆì„ë§¨", type1: "ì—ìŠ¤í¼", type2: "í˜ì–´ë¦¬", basePower: 78, rarity: 4 },

  { id: 123, name: "ìŠ¤ë¼í¬", type1: "ë²Œë ˆ", type2: "ë¹„í–‰", basePower: 85, rarity: 4 },

  { id: 124, name: "ë£¨ì£¼ë¼", type1: "ì–¼ìŒ", type2: "ì—ìŠ¤í¼", basePower: 80, rarity: 4 },
  { id: 125, name: "ì—ë ˆë¸Œ", type1: "ì „ê¸°", type2: null, basePower: 82, rarity: 4 },
  { id: 126, name: "ë§ˆê·¸ë§ˆ", type1: "ë¶ˆ", type2: null, basePower: 82, rarity: 4 },

  { id: 127, name: "ì˜ì‚¬ì´ì €", type1: "ë²Œë ˆ", type2: null, basePower: 88, rarity: 4 },

  { id: 128, name: "ì¼„íƒ€ë¡œìŠ¤", type1: "ë…¸ë§", type2: null, basePower: 85, rarity: 4 },

  { id: 129, name: "ì‰ì–´í‚¹", type1: "ë¬¼", type2: null, basePower: 20, rarity: 2 },
  { id: 130, name: "ê°¸ë¼ë„ìŠ¤", type1: "ë¬¼", type2: "ë¹„í–‰", basePower: 95, rarity: 4 },

  { id: 131, name: "ë¼í”„ë¼ìŠ¤", type1: "ë¬¼", type2: "ì–¼ìŒ", basePower: 92, rarity: 5 },

  { id: 132, name: "ë©”íƒ€ëª½", type1: "ë…¸ë§", type2: null, basePower: 60, rarity: 4 },

  { id: 133, name: "ì´ë¸Œì´", type1: "ë…¸ë§", type2: null, basePower: 55, rarity: 4 },

  { id: 134, name: "ìƒ¤ë¯¸ë“œ", type1: "ë¬¼", type2: null, basePower: 88, rarity: 5 },
  { id: 135, name: "ì¥¬í”¼ì¬ë”", type1: "ì „ê¸°", type2: null, basePower: 88, rarity: 5 },
  { id: 136, name: "ë¶€ìŠ¤í„°", type1: "ë¶ˆ", type2: null, basePower: 88, rarity: 5 },

  { id: 137, name: "í´ë¦¬ê³¤", type1: "ë…¸ë§", type2: null, basePower: 70, rarity: 4 },

  { id: 138, name: "ì•”ë‚˜ì´íŠ¸", type1: "ë°”ìœ„", type2: "ë¬¼", basePower: 60, rarity: 4 },
  { id: 139, name: "ì•”ìŠ¤íƒ€", type1: "ë°”ìœ„", type2: "ë¬¼", basePower: 88, rarity: 5 },

  { id: 140, name: "íˆ¬êµ¬", type1: "ë°”ìœ„", type2: "ë¬¼", basePower: 60, rarity: 4 },
  { id: 141, name: "íˆ¬êµ¬í‘¸ìŠ¤", type1: "ë°”ìœ„", type2: "ë¬¼", basePower: 88, rarity: 5 },

  { id: 142, name: "í”„í…Œë¼", type1: "ë°”ìœ„", type2: "ë¹„í–‰", basePower: 95, rarity: 5 },

  { id: 143, name: "ì ë§Œë³´", type1: "ë…¸ë§", type2: null, basePower: 92, rarity: 5 },

  { id: 144, name: "í”„ë¦¬ì ¸", type1: "ì–¼ìŒ", type2: "ë¹„í–‰", basePower: 110, rarity: 5 },
  { id: 145, name: "ì¬ë”", type1: "ì „ê¸°", type2: "ë¹„í–‰", basePower: 110, rarity: 5 },
  { id: 146, name: "íŒŒì´ì–´", type1: "ë¶ˆ", type2: "ë¹„í–‰", basePower: 110, rarity: 5 },

  { id: 147, name: "ë¯¸ë‡½", type1: "ë“œë˜ê³¤", type2: null, basePower: 50, rarity: 4 },
  { id: 148, name: "ì‹ ë‡½", type1: "ë“œë˜ê³¤", type2: null, basePower: 78, rarity: 5 },
  { id: 149, name: "ë§ë‚˜ë‡½", type1: "ë“œë˜ê³¤", type2: "ë¹„í–‰", basePower: 112, rarity: 5 },

  { id: 150, name: "ë®¤ì¸ ", type1: "ì—ìŠ¤í¼", type2: null, basePower: 120, rarity: 5 },
  { id: 151, name: "ë®¤", type1: "ì—ìŠ¤í¼", type2: null, basePower: 115, rarity: 5 }
];

// -------------------- í¬ì¼“ëª¬ DB ë¹ ë¥¸ ì¡°íšŒ ë§µ --------------------
var POKE_BY_ID = {};
for (var __i = 0; __i < POKEMON_DB.length; __i++) {
  var __p = POKEMON_DB[__i];
  if (__p && __p.id != null) 
    POKE_BY_ID[__p.id] = __p;
}
// -------------------- ì§„í™” ë£° --------------------
// 2ë²ˆ ì§„í™”: +10, +20
// 1ë²ˆ ì§„í™”(ëŒ/í†µì‹  í¬í•¨): +15
// ì´ë¸Œì´: +13 ëœë¤(134/135/136)
var EVOLVE_TWO_STAGE_1 = 10;
var EVOLVE_TWO_STAGE_2 = 20;
var EVOLVE_ONE_STAGE = 15;
var EVOLVE_EEVEE = 13;
var EEVEE_EVOS = [134, 135, 136];
// 1ì„¸ëŒ€ ì§„í™” ë§µ(ë„ˆ ë£° ê¸°ì¤€: ëŒ/í†µì‹ ë„ í¬í•¨í•´ì„œ ì „ë¶€ ê°•í™”ë¡œ ì²˜ë¦¬)
var EVOLUTION_MAP = {
  1: 2, 
  2: 3, 
  4: 5, 
  5: 6, 
  7: 8, 
  8: 9, 
  10: 11, 
  11: 12, 
  13: 14, 
  14: 15, 
  16: 17, 
  17: 18, 
  19: 20, 
  21: 22, 
  23: 24, 
  25: 26, 
  27: 28, 
  29: 30, 
  30: 31, 
  32: 33, 
  33: 34, 
  35: 36, 
  37: 38, 
  39: 40, 
  41: 42, 
  43: 44, 
  44: 45, 
  46: 47, 
  48: 49, 
  50: 51, 
  52: 53, 
  54: 55, 
  56: 57, 
  58: 59, 
  60: 61, 
  61: 62, 
  63: 64, 
  64: 65, 
  66: 67, 
  67: 68, 
  69: 70, 
  70: 71, 
  72: 73, 
  74: 75, 
  75: 76, 
  77: 78, 
  79: 80, 
  81: 82, 
  84: 85, 
  86: 87, 
  88: 89, 
  90: 91, 
  92: 93, 
  93: 94, 
  96: 97, 
  98: 99, 
  100: 101, 
  102: 103, 
  104: 105, 
  109: 110, 
  111: 112, 
  116: 117, 
  118: 119, 
  120: 121, 
  129: 130, 
  138: 139, 
  140: 141, 
  147: 148, 
  148: 149};
// -------------------- íƒ€ì… ìƒì„±í‘œ(ê°„ë‹¨) --------------------
var TYPE_CHART = {
  "ë¶ˆ": {  "í’€": 2,   "ë²Œë ˆ": 2,   "ì–¼ìŒ": 2,   "ë¬¼": 0.5,   "ë°”ìœ„": 0.5,   "ë“œë˜ê³¤": 0.5}, 
  "ë¬¼": {  "ë¶ˆ": 2,   "ë•…": 2,   "ë°”ìœ„": 2,   "í’€": 0.5,   "ë“œë˜ê³¤": 0.5}, 
  "í’€": {  "ë¬¼": 2,   "ë•…": 2,   "ë°”ìœ„": 2,   "ë¶ˆ": 0.5,   "í’€": 0.5,   "ë…": 0.5,   "ë²Œë ˆ": 0.5,   "ë“œë˜ê³¤": 0.5,   "ë¹„í–‰": 0.5}, 
  "ì „ê¸°": {  "ë¬¼": 2,   "ë¹„í–‰": 2,   "ì „ê¸°": 0.5,   "í’€": 0.5,   "ë“œë˜ê³¤": 0.5,   "ë•…": 0}, 
  "ì–¼ìŒ": {  "í’€": 2,   "ë•…": 2,   "ë¹„í–‰": 2,   "ë“œë˜ê³¤": 2,   "ë¶ˆ": 0.5,   "ë¬¼": 0.5,   "ì–¼ìŒ": 0.5}, 
  "ê²©íˆ¬": {  "ë…¸ë§": 2,   "ë°”ìœ„": 2,   "ì–¼ìŒ": 2,   "ë…": 0.5,   "ë¹„í–‰": 0.5,   "ì—ìŠ¤í¼": 0.5,   "í˜ì–´ë¦¬": 0.5,   "ê³ ìŠ¤íŠ¸": 0}, 
  "ë…": {  "í’€": 2,   "í˜ì–´ë¦¬": 2,   "ë…": 0.5,   "ë•…": 0.5,   "ë°”ìœ„": 0.5,   "ê³ ìŠ¤íŠ¸": 0.5}, 
  "ë•…": {  "ë¶ˆ": 2,   "ì „ê¸°": 2,   "ë…": 2,   "ë°”ìœ„": 2,   "í’€": 0.5,   "ë²Œë ˆ": 0.5,   "ë¹„í–‰": 0}, 
  "ë¹„í–‰": {  "í’€": 2,   "ê²©íˆ¬": 2,   "ë²Œë ˆ": 2,   "ì „ê¸°": 0.5,   "ë°”ìœ„": 0.5}, 
  "ë²Œë ˆ": {  "í’€": 2,   "ì—ìŠ¤í¼": 2,   "ë¶ˆ": 0.5,   "ê²©íˆ¬": 0.5,   "ë¹„í–‰": 0.5,   "ê³ ìŠ¤íŠ¸": 0.5}, 
  "ë°”ìœ„": {  "ë¶ˆ": 2,   "ì–¼ìŒ": 2,  "ë¹„í–‰": 2,   "ë²Œë ˆ": 2,   "ê²©íˆ¬": 0.5,   "ë•…": 0.5}, 
  "ê³ ìŠ¤íŠ¸": {  "ê³ ìŠ¤íŠ¸": 2,   "ì—ìŠ¤í¼": 2,   "ë…¸ë§": 0}, 
  "ë“œë˜ê³¤": {  "ë“œë˜ê³¤": 2}, 
  "ì—ìŠ¤í¼": {  "ê²©íˆ¬": 2,   "ë…": 2,   "ì—ìŠ¤í¼": 0.5}, 
  "í˜ì–´ë¦¬": {  "ê²©íˆ¬": 2,   "ë“œë˜ê³¤": 2,   "ë¶ˆ": 0.5,   "ë…": 0.5}
  };
  
// -------------------- íŒŒì¼ IO (í™˜ê²½ë³„ë¡œ êµì²´) --------------------
function readFile(path) {
  try {
    var file = new java.io.File(path);
    if (!file.exists()) 
      return null;
    var fis = new java.io.FileInputStream(file);
    var isr = new java.io.InputStreamReader(fis, "UTF-8");
    var br = new java.io.BufferedReader(isr);
    var sb = "";
    var line = null;
    while ((line = br.readLine()) !== null) 
      sb += line;
    br.close();
    isr.close();
    fis.close();
    return sb;
  }  catch (e) {
  return null;
}
}
function writeFile(path, text) {
  try {
    var file = new java.io.File(path);
    var parent = file.getParentFile();
    if (parent && !parent.exists()) 
      parent.mkdirs();
    var fos = new java.io.FileOutputStream(file);
    var osw = new java.io.OutputStreamWriter(fos, "UTF-8");
    osw.write(text);
    osw.close();
    fos.close();
    return true;
  }  catch (e) {
  return false;
}
}
// -------------------- ë°ì´í„° ë¡œë“œ/ì„¸ì´ë¸Œ --------------------
function loadData() {
  var raw = readFile(DATA_PATH);
  if (!raw) {
    return {
  users: {}, 
  lastSpawnByRoom: {}, 
  regionByRoom: {}};
  }
  try {
    var d = JSON.parse(raw);
    if (!d.users) 
      d.users = {};
    if (!d.lastSpawnByRoom) 
      d.lastSpawnByRoom = {};
    if (!d.regionByRoom) 
      d.regionByRoom = {};
    return d;
  }  catch (e) {
  return {
  users: {}, 
  lastSpawnByRoom: {}, 
  regionByRoom: {}};
}
}
// -------------------- ë°ì´í„° ì„¸ì´ë¸Œ --------------------
function saveData(d) {
  try {
    if (!d) 
      return false;
    return writeFile(DATA_PATH, JSON.stringify(d));
  }  catch (e) {
  return false;
}
}
// -------------------- ë°ì´í„° ìºì‹œ (í•„ìˆ˜ ìµœì í™”) --------------------
var DATA_CACHE = null;
var DATA_DIRTY = false;
var LAST_SAVE_AT = 0;
var SAVE_INTERVAL_MS = 20 * 1000;// 20ì´ˆ
function getDataCached() {
  if (DATA_CACHE) 
    return DATA_CACHE;
  DATA_CACHE = loadData();  // ê¸°ì¡´ loadData ê·¸ëŒ€ë¡œ ì‚¬ìš©
  return DATA_CACHE;
}
function markDirty() {
  DATA_DIRTY = true;
}
function flushSaveIfNeeded(force) {
  var now = nowMs();
  if (!DATA_CACHE) 
    return;
  if (force || (DATA_DIRTY && (now - LAST_SAVE_AT >= SAVE_INTERVAL_MS))) {
    saveData(DATA_CACHE);
    DATA_DIRTY = false;
    LAST_SAVE_AT = now;
  }
}
// -------------------- ì‹ ê·œ íšŒì›ê°€ì… ë³´ìƒ --------------------
function grantSignupBonusIfNeeded(u, sender) {
  if (!u.isNewUser) 
    return "";
  u.gold += 10000;
  u.ball += 10;
  u.isNewUser = false;
  return (sender + "ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!\n\n" + "ğŸ‰ ì‹ ê·œ íšŒì›ê°€ì… ë³´ìƒ\n" + "+10000ğŸ’° / +10 ëª¬ìŠ¤í„°ë³¼");
}
// -------------------- ìœ í‹¸ --------------------
function nowMs() {
  return new Date().getTime();
}
function dateKeyKST() {
  // ì„œë²„/í° íƒ€ì„ì¡´ì´ ì„ì—¬ë„ ìµœëŒ€í•œ ì•ˆì •ì ìœ¼ë¡œ "ì˜¤ëŠ˜"ì„ ë§Œë“¤ê¸° ìœ„í•´
  // ë¡œì»¬ ë‚ ì§œ ê¸°ë°˜ YYYY-MM-DDë¡œ ì €ì¥
  var d = new Date();
  var y = d.getFullYear();
  var m = d.getMonth() + 1;
  var dd = d.getDate();
  if (m < 10) 
    m = "0" + m;
  if (dd < 10) 
    dd = "0" + dd;
  return y + "-" + m + "-" + dd;
}
function ensureUserStats(u) {
  if (!u.stats) 
    u.stats = {};
  if (typeof u.stats.battleWin !== "number") 
    u.stats.battleWin = 0;
  if (typeof u.stats.battleLose !== "number") 
    u.stats.battleLose = 0;
  if (typeof u.stats.battleDraw !== "number") 
    u.stats.battleDraw = 0;
  if (typeof u.stats.battleStreak !== "number") 
    u.stats.battleStreak = 0;
  if (typeof u.stats.bestStreak !== "number") 
    u.stats.bestStreak = 0;
  if (typeof u.stats.lastBattleAt !== "number") 
    u.stats.lastBattleAt = 0;
}

function resetBattleStats(u) {
  if (!u) return;
  if (!u.stats) u.stats = {};
  u.stats.battleWin = 0;
  u.stats.battleLose = 0;
  u.stats.battleDraw = 0;
  u.stats.battleStreak = 0;
  u.stats.bestStreak = 0;
  u.stats.lastBattleAt = 0;
}

function resetBattleStatsAll(d) {
  if (!d || !d.users) return 0;
  var cnt = 0;
  for (var name in d.users) {
    if (!d.users[name]) continue;
    resetBattleStats(d.users[name]);
    cnt++;
  }
  return cnt;
}

function findPokemonDB(pid) {
  pid = parseInt(pid, 10);
  return POKE_BY_ID[pid] || null;
}
// [ìˆ˜ì •ë¨] í¬ì¼“ëª¬ ì´ë¦„ ê°€ì ¸ì˜¤ê¸° (NPC/ìœ ì € í˜¸í™˜)
function getDisplayName(p) {
  if (!p) return "ì•Œìˆ˜ì—†ìŒ";
  
  // ìœ ì €ëŠ” pid, NPC/ê´€ì¥ì€ idë¥¼ ì”ë‹ˆë‹¤. ë‘˜ ë‹¤ í™•ì¸!
  var targetId = p.pid || p.id; 
  
  var db = findPokemonDB(targetId);
  var name = db ? db.name : "ì•Œìˆ˜ì—†ìŒ";
  
  if (p.shiny) {
    return "âœ¨" + name; 
  }
  return name;
}

// í¬ì¼“ëª¬ ì´ë¦„ìœ¼ë¡œ DB ì°¾ê¸° (ìš´ì˜ì í¬ì¼“ëª¬ì§€ê¸‰ìš©)
// "ë®¤", "í”¼ì¹´ì¸„" ê°™ì€ ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰
function findPokemonDBByName(name) {
  if (!name) 
    return null;
  var key = ("" + name).trim();
  if (!key) 
    return null;
  var k = key.replace(/\s+/g, "").toLowerCase();
  // DB í›„ë³´ë“¤(ë„¤ ì½”ë“œì—ì„œ ì–´ë–¤ ì´ë¦„ì„ ì“°ë“  ìµœëŒ€í•œ ëŒ€ì‘)
  var arr = null;
  if (typeof POKEMON_DB !== "undefined" && POKEMON_DB && POKEMON_DB.length) 
    arr = POKEMON_DB;
  else if (typeof pokemonDB !== "undefined" && pokemonDB && pokemonDB.length) 
    arr = pokemonDB;
  else if (typeof POKE_DB !== "undefined" && POKE_DB && POKE_DB.length) 
    arr = POKE_DB;
  else if (typeof POKEMONS !== "undefined" && POKEMONS && POKEMONS.length) 
    arr = POKEMONS;
  if (!arr) 
    return null;
  for (var i = 0; i < arr.length; i++) {
    var p = arr[i];
    if (!p) 
      continue;
    var cands = [];
    if (p.name) 
      cands.push(p.name);
    if (p.koName) 
      cands.push(p.koName);
    if (p.kor) 
      cands.push(p.kor);
    if (p.kr) 
      cands.push(p.kr);
    if (p.enName) 
      cands.push(p.enName);
    for (var j = 0; j < cands.length; j++) {
      var nm = ("" + cands[j]).trim();
      if (!nm) 
        continue;
      var nmKey = nm.replace(/\s+/g, "").toLowerCase();
      if (nmKey === k) 
        return p;
    }
  }
  return null;
}
// [4ë‹¨ê³„ ìˆ˜ì •] ì „íˆ¬ë ¥ ê³„ì‚° (í˜/ê³µì† IV ë°˜ì˜)
// [ìˆ˜ì •ë¨] ì „íˆ¬ë ¥ ê³„ì‚° (ì´ë¡œì¹˜ 10% ë³´ë„ˆìŠ¤ ì ìš©)
function calcBattlePower(p) {
  var db = findPokemonDB(p.pid);
  if (!db) return 0;
  
  var base = db.basePower || 1;
  var enh = p.enh || 0;
  
  // ê°œì²´ê°’ ë³´ë„ˆìŠ¤
  var ivBonus = (p.ivStr || 0) + (p.ivSpd || 0); 
  
  // ê¸°ë³¸ ì „íˆ¬ë ¥ ê³„ì‚°
  var power = Math.floor((base + ivBonus) * (1 + enh * 0.15));

  // â˜… [ì´ë¡œì¹˜ íŠ¹ì „] ì „íˆ¬ë ¥ 1.2ë°° ì¦ê°€!
  if (p.shiny) {
    power = Math.floor(power * 1.2); 
  }

  return power;
}


//ì „íˆ¬ë ¥ ê¸°ì¤€ ì •ë ¬
function sortPokemonsByPower(list) {
  return list.slice().sort(function(a, b) {
  var pa = calcBattlePower(a);
  var pb = calcBattlePower(b);
  if (pb !== pa) 
    return pb - pa;
  if ((b.enh || 0) !== (a.enh || 0)) 
    return (b.enh || 0) - (a.enh || 0);
  return a.uid - b.uid;
});
}
//ìœ ì € ë„ê° ë­í‚¹ ê³„ì‚°
function getTotalDexCount() {
  return POKEMON_DB.length;
}
function getUserDexCount(u) {
  if (!u || !u.dex) return 0;
  var cnt = 0;
  
  // POKEMON_DB(1~151ë²ˆ)ë¼ëŠ” 'ê³µì‹ ëª©ë¡'ì„ ê¸°ì¤€ìœ¼ë¡œ í•˜ë‚˜ì”© ëŒ€ì¡°í•©ë‹ˆë‹¤.
  for (var i = 0; i < POKEMON_DB.length; i++) {
    var pid = String(POKEMON_DB[i].id);
    // ë„ê° ë°ì´í„°ì— í•´ë‹¹ ë²ˆí˜¸ê°€ ì¡´ì¬í•˜ê³ , ì¡ì€ íšŸìˆ˜(caught)ê°€ ìµœì†Œ 1íšŒ ì´ìƒì´ì–´ì•¼ ì¸ì •!
    if (u.dex[pid] && u.dex[pid].caught > 0) {
      cnt++;
    }
  }
  return cnt;
}

function getDexPercent(u) {
  var total = getTotalDexCount();
  if (total <= 0) return 0;
  return Math.floor((getUserDexCount(u) / total) * 1000) / 10; 
  // ì†Œìˆ˜ 1ìë¦¬
}
// [ìˆ˜ì •ë¨] ë„ê° ë­í‚¹ ë¹Œë” (1ìˆœìœ„: ë§ˆë¦¿ìˆ˜, 2ìˆœìœ„: Sê¸‰ ê°œìˆ˜)
function buildDexRankingWithMyRank(d, limit, myName) {
  limit = limit || 10;
  var list = [];
  var total = getTotalDexCount();

  for (var name in d.users) {
    if (!d.users.hasOwnProperty(name)) continue;
    var u = d.users[name];
    if (!u || !u.dex) continue;

    var count = 0;
    var sCount = 0; // Së“±ê¸‰ ê°œìˆ˜

    for (var k in u.dex) {
      if (u.dex[k].caught > 0) {
        count++;
        // ì¡ì€ ê²ƒ ì¤‘ ìµœê³  ë“±ê¸‰ì´ Së¼ë©´ ì¹´ìš´íŠ¸
        if (u.dex[k].maxGrade === "S") {
          sCount++;
        }
      }
    }

    if (count <= 0) continue;

    list.push({
      name: name,
      count: count,
      sCount: sCount,
      percent: getDexPercent(u)
    });
  }

  // ì •ë ¬ ë¡œì§: ë§ˆë¦¿ìˆ˜ ë‚´ë¦¼ì°¨ìˆœ -> Sê¸‰ ê°œìˆ˜ ë‚´ë¦¼ì°¨ìˆœ -> ì´ë¦„ ì˜¤ë¦„ì°¨ìˆœ
  list.sort(function(a, b) {
    if (b.count !== a.count) return b.count - a.count;
    if (b.sCount !== a.sCount) return b.sCount - a.sCount;
    return String(a.name).localeCompare(String(b.name));
  });

  var myIdx = -1;
  for (var i = 0; i < list.length; i++) {
    if (list[i].name === myName) { myIdx = i; break; }
  }

  return {
    rows: list,
    myIdx: myIdx,
    total: total,
    top: list.slice(0, Math.min(limit, list.length))
  };
}
// ==================== [ì‹ ê·œ] ì¹­í˜¸ ë­í‚¹ ë¹Œë” ====================
// [ìˆ˜ì •ë¨] ì¹­í˜¸ ë­í‚¹ ë¹Œë” (1ìˆœìœ„: ì¹­í˜¸ ê°œìˆ˜, 2ìˆœìœ„: ë ˆë²¨+ê²½í—˜ì¹˜)
function buildTitleRanking(d, limit, myName) {
  limit = limit || 10;
  var list = [];
  var TOTAL_TITLES = 34; // í˜„ì¬ ì´ ì¹­í˜¸ ê°œìˆ˜

  for (var name in d.users) {
    if (!d.users.hasOwnProperty(name)) continue;
    var u = d.users[name];
    if (!u) continue;
    
    var myTitles = u.titles || ["ë‰´ë¹„"];
    var count = myTitles.length;
    var percent = Math.floor((count / TOTAL_TITLES) * 100);

    list.push({
      name: name,
      count: count,
      percent: percent,
      lv: u.trainerLv || 1,      // ë ˆë²¨
      exp: u.trainerExp || 0     // í˜„ì¬ ê²½í—˜ì¹˜
    });
  }

  // â˜… ì •ë ¬ ë¡œì§: ê°œìˆ˜ -> ë ˆë²¨ -> ê²½í—˜ì¹˜
  list.sort(function(a, b) {
    if (b.count !== a.count) return b.count - a.count; // 1. ì¹­í˜¸ ë§ì€ ìˆœ
    if (b.lv !== a.lv) return b.lv - a.lv;             // 2. ë ˆë²¨ ë†’ì€ ìˆœ (ê³ ì¸ë¬¼ ìš°ëŒ€)
    return b.exp - a.exp;                              // 3. ê°™ì€ ë ˆë²¨ì´ë©´ ê²½í—˜ì¹˜ ë†’ì€ ìˆœ
  });

  var myIdx = -1;
  for (var i = 0; i < list.length; i++) {
    if (list[i].name === myName) { myIdx = i; break; }
  }

  return {
    rows: list,
    myIdx: myIdx,
    totalTitles: TOTAL_TITLES,
    top: list.slice(0, Math.min(limit, list.length))
  };
}

// [ìˆ˜ì •ë¨] í†µê³„ ë°ì´í„°, ì•„ì´í…œ ê°€ë°©, ë ˆì´ë“œ ë³€ìˆ˜ ì´ˆê¸°í™” (ì „ì²´ ì½”ë“œ)
function normalizeUserData(u) {
  if (!u) return;
  
  // 1. ê¸°ë³¸ ìœ ì € ì •ë³´ ì´ˆê¸°í™”
  if (typeof u.trainerLv !== "number") u.trainerLv = 1;
  if (typeof u.trainerExp !== "number") u.trainerExp = 0;
  if (typeof u.gold !== "number") u.gold = 0;
  
  if (typeof u.ball !== "number") u.ball = 0;
  if (typeof u.superBall !== "number") u.superBall = 0;
  if (typeof u.ultraBall !== "number") u.ultraBall = 0;
  if (typeof u.godBall !== "number") u.godBall = 0;
  
  if (typeof u.dopaTicket !== "number") u.dopaTicket = 0; 
  if (typeof u.cookie !== "number") u.cookie = 0;    
  if (typeof u.ticket !== "number") u.ticket = 0;    
  if (typeof u.reroll !== "number") u.reroll = 0;    
  if (typeof u.nextFieldRegion !== "string") u.nextFieldRegion = "";

  // â˜… [ì‹ ê·œ] ë ˆì´ë“œ ê´€ë ¨ ë³€ìˆ˜ ì¶”ê°€
  if (typeof u.dakotaCoin !== "number") u.dakotaCoin = 0; // ë‹¤ì½”íƒ€ ì½”ì¸
  if (typeof u.lastRaidAt !== "number") u.lastRaidAt = 0; // ë ˆì´ë“œ ì¿¨íƒ€ì„

  // â˜… [í•µì‹¬] ì¥ë¹„ ì•„ì´í…œ ê°€ë°© ì´ˆê¸°í™”
  if (!u.items || typeof u.items !== "object") u.items = {};

  // ì¹­í˜¸ ì´ˆê¸°í™”
  if (!Array.isArray(u.titles)) u.titles = ["ë‰´ë¹„"];
  if (typeof u.activeTitle !== "string") u.activeTitle = "ë‰´ë¹„";

  // í†µê³„ ë°ì´í„° ì´ˆê¸°í™”
  if (!u.stats) u.stats = {};
  if (typeof u.stats.battleWin !== "number") u.stats.battleWin = 0;
  if (typeof u.stats.battleLose !== "number") u.stats.battleLose = 0;
  if (typeof u.stats.battleDraw !== "number") u.stats.battleDraw = 0;
  if (typeof u.stats.battleStreak !== "number") u.stats.battleStreak = 0;
  if (typeof u.stats.bestStreak !== "number") u.stats.bestStreak = 0;
  
  if (typeof u.stats.loseStreak !== "number") u.stats.loseStreak = 0;
  if (typeof u.stats.maxLoseStreak !== "number") u.stats.maxLoseStreak = 0;
  if (typeof u.stats.totalSpentShop !== "number") u.stats.totalSpentShop = 0;
  if (typeof u.stats.totalSpentEnhance !== "number") u.stats.totalSpentEnhance = 0;
  if (typeof u.stats.totalDopaUsed !== "number") u.stats.totalDopaUsed = 0;
  if (typeof u.stats.totalDopaReset !== "number") u.stats.totalDopaReset = 0;
  if (typeof u.stats.totalDopaDestroy !== "number") u.stats.totalDopaDestroy = 0;
  if (typeof u.stats.totalEscapes !== "number") u.stats.totalEscapes = 0;
  if (typeof u.stats.totalCookieUsed !== "number") u.stats.totalCookieUsed = 0;
  if (typeof u.stats.totalGodBallBought !== "number") u.stats.totalGodBallBought = 0;
  
  if (typeof u.nextSpawnPid !== "number") u.nextSpawnPid = 0;
  if (typeof u.nextSpawnPid !== "number") u.nextSpawnPid = 0;
  if (typeof u.nextSpawnShiny !== "boolean") u.nextSpawnShiny = false;

  if (typeof u.lastAttendanceKey !== "string") u.lastAttendanceKey = "";
  if (!Array.isArray(u.pokemons)) u.pokemons = [];
  if (typeof u.nextPokeUid !== "number") u.nextPokeUid = 1;
  if (typeof u.catchFailStreak !== "number") u.catchFailStreak = 0;
  if (typeof u.lastCatchPid !== "number") u.lastCatchPid = 0;

  var fixed = [];
  for (var i = 0; i < u.pokemons.length; i++) {
    var p = u.pokemons[i];
    if (!p || typeof p !== "object") continue;
    
    // â˜… [í•µì‹¬] í¬ì¼“ëª¬ë³„ ì¥ë¹„ ìŠ¬ë¡¯ ì´ˆê¸°í™”
    if (p.equip === undefined) p.equip = null;

    var pid = parseInt(p.pid, 10);
    var uid = parseInt(p.uid, 10);
    var enh = parseInt(p.enh, 10);
    if (!pid || !uid) continue;
    if (!findPokemonDB(pid)) continue;

    var cleanObj = {
      uid: uid,
      pid: pid,
      enh: isNaN(enh) ? 0 : enh,
      grade: p.grade || "D",
      ivStr: p.ivStr || 0,
      ivHp: p.ivHp || 0,
      ivSpd: p.ivSpd || 0,
      shiny: !!p.shiny,
      equip: p.equip // ì¥ë¹„ ë°ì´í„° ìœ ì§€
    };
    fixed.push(cleanObj);
  }
  u.pokemons = fixed;
  ensureUserDex(u);
}

// 1. ë„ê° ì¹´ìš´íŠ¸ í—¬í¼ (ì¹­í˜¸ ì¡°ê±´ ì²´í¬ ì „ìš©)
function getDexCount(u) {
  var cnt = 0;
  if (u && u.dex) {
    for (var k in u.dex) {
      if (u.dex[k].caught > 0) cnt++;
    }
  }
  return cnt;
}

// 2. [ìµœì¢… í†µí•©] ì¹­í˜¸ ìë™ ì§€ê¸‰ ë¡œì§
function updateTitles(u) {
  if (!u.titles) u.titles = ["ë‰´ë¹„"];
  var gained = [];

  // ì¹­í˜¸ ì¶”ê°€ ë³´ì¡° í•¨ìˆ˜
  function check(titleName, condition) {
    if (u.titles.indexOf(titleName) === -1 && condition) {
      u.titles.push(titleName);
      gained.push(titleName);
    }
  }

  // ğŸŒ± ì„±ì¥ ê´€ë ¨ (Lv 30, 100, 150...)
  check("ë‰´ë¹„", true);
  check("ì„±ì¥ ì¤‘ì¸", u.trainerLv >= 30);
  check("ê³ ì—¬ë²„ë¦°", u.trainerLv >= 100);
  check("ì§„ì§€ì¶©", u.trainerLv >= 150);
  var totalB = (u.stats.battleWin || 0) + (u.stats.battleLose || 0);
  var winR = totalB > 0 ? (u.stats.battleWin / totalB) : 1;
  check("ë ˆë²¨ê°’ ëª»í•˜ëŠ”", u.trainerLv >= 50 && winR <= 0.3);

  // âš”ï¸ ì „íˆ¬ ê´€ë ¨ (ì—°ìŠ¹, ì—°íŒ¨, ëˆ„ì  íŒìˆ˜...)
  check("ì‹¸ì›€ê¾¼ì¸", u.stats.bestStreak >= 10);
  check("ê°•ë ¥í•œ", u.stats.bestStreak >= 20);
  check("ë„ë¼ì´", u.stats.bestStreak >= 50);
  check("ë°°í‹€ë§ˆìŠ¤í„°", u.stats.bestStreak >= 100);
  check("ìµœì•½ì²´ì¸", u.stats.loseStreak >= 10);
  check("ì°ë”° ê°™ì€", u.stats.loseStreak >= 20);
  check("ë‹¤ íŒ¨ê³  ë‹¤ë‹ˆëŠ”", (u.stats.battleWin + u.stats.battleLose + u.stats.battleDraw) >= 1000);

  // ğŸ“– ìˆ˜ì§‘ ê´€ë ¨ (ë„ê° ê°œìˆ˜, ë³´ìœ  ê°œìˆ˜...)
  var caughtCount = getDexCount(u); // ìœ„ 1ë²ˆ í•¨ìˆ˜ ì‚¬ìš©
  check("ìˆ˜ì§‘ê°€", caughtCount >= 50);
  check("ìˆ˜ì§‘ì— ë¯¸ì¹œ", caughtCount >= 130);
  check("1ì„¸ëŒ€ ë§ˆìŠ¤í„°", caughtCount >= 151);
  check("ì¡ëŠ” ë§›ì„ ì•„ëŠ”", u.pokemons.length >= 150);
  
  if (caughtCount >= 151) {
    var allS = true;
    for(var k in u.dex) { 
      if(u.dex[k].caught > 0 && (u.dex[k].maxGrade !== "S")) { allS = false; break; } 
    }
    check("ì§„ì •í•œ 1ì„¸ëŒ€ ë§ˆìŠ¤í„°", allS);
  }

  // ğŸ’° ê²½ì œ/ë„ë°• ê´€ë ¨
  check("ë°±ë§Œì¥ì", u.gold >= 1000000);
  check("ì²œë§Œì¥ì", u.gold >= 10000000);
  check("ì´ë”ë¦¬ì›€ í™€ë”", u.gold >= 80000000);
  check("ì¼ë¡ ë¨¸ìŠ¤í¬", u.gold >= 150000000);
  check("í”Œë ‰ìŠ¤", (u.stats.totalSpentShop || 0) >= 100000000);
  check("ê°•í™” ì¤‘ë…ì", (u.stats.totalSpentEnhance || 0) >= 100000000);
  check("ë„íŒŒë¯¼ ì¤‘ë…", (u.stats.totalDopaUsed || 0) >= 1000);
  check("íƒœì´ˆë§ˆì„ ëŸ¬ë²„", (u.stats.totalDopaReset || 0) >= 10);
  check("í¬ì¼“ëª¬ ì¥ì˜ì‚¬", (u.stats.totalDopaDestroy || 0) >= 10);
  
  // â˜… [í•µì‹¬ ì¶”ê°€] í‰ë²”í•˜ê²Œ ë¯¸ì¹œ (í‚¹ê°“ë³¼ 3ê°œ ì´ìƒ ëˆ„ì  êµ¬ë§¤ ì‹œ)
  check("í‰ë²”í•˜ê²Œ ë¯¸ì¹œ", (u.stats.totalGodBallBought || 0) >= 3);

  // ğŸ”¥ ê¸°íƒ€ íŠ¹ìˆ˜ ì¡°ê±´
  check("êµ¬ìŠ¬ë™ì ê°™ì€", u.ball >= 100 && u.superBall >= 100 && u.ultraBall >= 100);
  check("ìš°ì‚¬ì¸ë³¼íŠ¸ ê°™ì€", (u.stats.totalEscapes || 0) >= 1000);
  check("ì«€ë“í•œ", (u.stats.totalCookieUsed || 0) >= 1000);
  
  var sCount = 0;
  for(var i=0; i<u.pokemons.length; i++) { if(u.pokemons[i].shiny) sCount++; }
  check("ë¹›ë‚˜ëŠ” ëŒ€ë¨¸ë¦¬", sCount >= 5);

  // íŠ¹ì • 60ê°• ì²´í¬
  for(var j=0; j<u.pokemons.length; j++) {
    var p = u.pokemons[j];
    if (p.enh >= 60) {
      if (p.pid === 95) check("ë”´ë”´í•œê½‚ì¸„", true);   // ë¡±ìŠ¤í†¤
      if (p.pid === 145) check("í…ŒìŠ¬ë¼ ëŒ€ì£¼ì£¼", true); // ì¬ë”
      if (p.pid === 149) check("ê°œë§ë‚˜ë‹ˆ", true);     // ë§ë‚˜ë‡½
    }
  }

  return gained;
}

// 3. ë‹‰ë„¤ì„ ê¾¸ë¯¸ê¸° (ìˆ˜ì •ë¨: ì±”í”¼ì–¸ ì™•ê´€ ìë™ ë¶€ì°©)
function getDecoratedName(d, u, name) {
  if (!u) return name;
  
  var title = u.activeTitle || "ë‰´ë¹„";
  var finalName = title + " " + name; // ê¸°ë³¸: [ì¹­í˜¸] [ë‹‰ë„¤ì„]
  
  // â˜… [í•µì‹¬] í˜„ì¬ ì±”í”¼ì–¸ì¸ì§€ í™•ì¸
  if (d && d.champion && d.champion.name === name) {
      // NPCê°€ ì•„ë‹ ë•Œë§Œ (ìœ ì € ì±”í”¼ì–¸ì¼ ë•Œ)
      if (!d.champion.isNpc) {
          finalName = finalName + " ğŸ‘‘"; // ë’¤ì— ì™•ê´€ ì¶”ê°€!
      }
  }
  
  return finalName;
}

// 4. ë°ì´í„° ë³´ì • (ë“±ê¸‰ ëˆ„ë½ ë°©ì§€)
function ensurePokemonGrades(u) {
  if (!u || !u.pokemons || !Array.isArray(u.pokemons)) return false;
  var isChanged = false;
  for (var i = 0; i < u.pokemons.length; i++) {
    var p = u.pokemons[i]; 
    if (!p.grade) {
      var newGrade = generatePokemonGrade();
      var newIVs = generateIVsByGrade(newGrade);
      p.grade = newGrade;
      p.ivStr = newIVs.str;
      p.ivHp = newIVs.hp;
      p.ivSpd = newIVs.spd;
      if (typeof dexCaught === "function") dexCaught(u, p.pid, newGrade);
      isChanged = true;
    }
  }
  return isChanged;
}


// [ì‹ ê·œ] í¬ì¼“ëª¬ IDë¡œ ì–´ìš¸ë¦¬ëŠ” ì§€ì—­ ì°¾ê¸°
function getRecommendedRegion(pid) {
  var db = findPokemonDB(pid);
  if (!db) return REGIONS[0].key;

  var t1 = db.type1;
  var t2 = db.type2;

  // ì§€ì—­ë³„ íƒ€ì… ë§¤ì¹­ í™•ì¸
  for (var i = 0; i < REGIONS.length; i++) {
    var r = REGIONS[i];
    if (r.key === "ëƒ¥ì¹˜ì˜ ë°©") continue; // ëƒ¥ì¹˜ì˜ ë°©ì€ ì œì™¸
    if (r.types.indexOf(t1) !== -1 || (t2 && r.types.indexOf(t2) !== -1)) {
      return r.key;
    }
  }
  return REGIONS[0].key; // ëª» ì°¾ìœ¼ë©´ ê¸°ë³¸ ì´ˆì›
}

function findUserPokemonByUid(u, uid) {
  uid = parseInt(uid, 10);
  if (!u || !Array.isArray(u.pokemons)) 
    return null;
  for (var i = 0; i < u.pokemons.length; i++) {
    if (parseInt(u.pokemons[i].uid, 10) === uid) 
      return u.pokemons[i];
  }
  return null;
}
function randomPick(arr) {
  return arr[Math.floor(Math.random() * arr.length)];
}
function say(userName, text) {
  return userName + "ë‹˜, " + text;
}
function sayDo(userName, text) {
  return userName + "ë‹˜ì´ " + text;
}
var ENH_RESULT_UP = "UP";
var ENH_RESULT_KEEP = "KEEP";
var ENH_RESULT_EXIT = "EXIT";
var ENH_RESULT_DOWN = "DOWN";// ë”±íˆ ì•ˆì“°ì¼ ì˜ˆì •

// [ìˆ˜ì •ë¨] ê°•í™” í‹°ì–´ êµ¬ë¶„ (60ê°• ê¸°ì¤€)
function getEnhTier(enh) {
  if (enh < 10) return "EASY";
  if (enh < 20) return "MID";   // 20ê°•ê¹Œì§€ ì§„í™” êµ¬ê°„
  if (enh < 40) return "HARD";  // 20~40ê°• ê³ ë¹„
  return "HELL";                // 40ê°• ì´ìƒ ì§€ì˜¥
}
// -------------------- ì¶œì„ ë³´ìƒ í…Œì´ë¸” --------------------
var ATTENDANCE_STREAK_REWARD = {
  7:  { dopa: 7 },
  14: { dopa: 14 },
  30: { dopa: 30 }
};

// ì¶œì„ ë°ì´í„° ì´ˆê¸°í™”
function ensureAttendance(u) {
  if (!u.attendance) {
    u.attendance = {
      lastDate: "",
      streak: 0,
      total: 0
    };
  }
}

// ì¶œì„ ê³¨ë“œ ê³„ì‚° (ê¸°ì¡´ * 5ë°°)
function calcAttendanceGold(u) {
  var base = randInt(300, 900);
  var lv = (u && typeof u.trainerLv === "number") ? u.trainerLv : 1;
  lv = Math.max(1, Math.min(99, lv));

  var mul = 1 + (lv - 1) * 0.08;
  if (mul > 3.5) mul = 3.5;

  return Math.floor(base * mul * 8);
}

function randInt(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

// -------------------- ì¶œì„ ì²´í¬ --------------------
function doAttendanceCheck(u, sender) {
  ensureUserStats(u);
  ensureAttendance(u);

  var today = dateKeyKST();

  // ì´ë¯¸ ì¶œì„
  if (u.attendance.lastDate === today) {
    return {
      ok: false,
      msg: "ì˜¤ëŠ˜ì€ ì´ë¯¸ ì¶œì„í–ˆì–´ìš”.\në‚´ì¼ ë‹¤ì‹œ ì™€ì£¼ì„¸ìš”."
    };
  }

  // ì—°ì† ì¶œì„ ê³„ì‚°
  var newStreak = 1;
  if (u.attendance.lastDate) {
    var lastDay = dateKeyToDayNumber(u.attendance.lastDate);
    var todayDay = dateKeyToDayNumber(today);
    if (todayDay - lastDay === 1) {
      newStreak = (u.attendance.streak || 0) + 1;
    }
  }

  // ë°˜ì˜
  u.attendance.lastDate = today;
  u.attendance.streak = newStreak;
  u.attendance.total = (u.attendance.total || 0) + 1;

  // ğŸ ê³¨ë“œ
  var goldGain = calcAttendanceGold(u);
  u.gold = (u.gold || 0) + goldGain;

  // ğŸ EXP
  var expGain = 50 + (u.trainerLv * 10);
  var lvMsg = addExpWithLevelUpMsg(u, expGain);

  // ğŸ ë§¤ì¼ ë„íŒŒë¯¼ 1ì¥
  u.dopaTicket = (u.dopaTicket || 0) + 1;

  var bonusLines = [];
  bonusLines.push("ë„íŒŒë¯¼ ê°•í™”ê¶Œ +1ğŸ’³");

  // ğŸ ì—°ì† ì¶œì„ ë³´ë„ˆìŠ¤ (7/14/30)
  var streakReward = ATTENDANCE_STREAK_REWARD[newStreak];
  if (streakReward && streakReward.dopa) {
    u.dopaTicket += streakReward.dopa;
    bonusLines.push(
      newStreak + "ì¼ ì—°ì† ë³´ë„ˆìŠ¤ ë„íŒŒë¯¼ ê°•í™”ê¶Œ +" + streakReward.dopa + "ğŸ’³"
    );
  }

  var msg =
    sender + "ë‹˜ ì¶œì„ ì™„ë£Œ!\n" +
    "ì—°ì† ì¶œì„: " + newStreak + "ì¼\n" +
    "ëˆ„ì  ì¶œì„: " + u.attendance.total + "ì¼\n\n" +
    "ğŸ ì¶œì„ ë³´ìƒ\n" +
    "+" + goldGain + "ğŸ’° / +" + expGain + "EXP\n";

  if (bonusLines.length > 0) {
    msg += "\nğŸ”¥ ë³´ë„ˆìŠ¤\n" + bonusLines.join("\n") + "\n";
  }
// ğŸ¯ ë‹¤ìŒ ëª©í‘œ ì•ˆë‚´ (7ì¼ ë¯¸ë§Œì¼ ë•Œë§Œ)
// ğŸ¯ ë‹¤ìŒ ì—°ì† ì¶œì„ ëª©í‘œ ì•ˆë‚´
var nextTarget = null;
var nextReward = 0;

if (newStreak < 7) {
  nextTarget = 7;
  nextReward = 7;
} else if (newStreak < 14) {
  nextTarget = 14;
  nextReward = 14;
} else if (newStreak < 30) {
  nextTarget = 30;
  nextReward = 30;
}

if (nextTarget) {
  var remain = nextTarget - newStreak;
  msg +=
    "\nğŸ¯ ëª©í‘œ\n" +
    nextTarget + "ì¼ ì—°ì† ì¶œì„ ì‹œ ë„íŒŒë¯¼ ê°•í™”ê¶Œ +" +
    nextReward + "ğŸ’³ (" + remain + "ì¼ ë‚¨ìŒ)\n";
}
  if (lvMsg) {
    msg += "\n" + lvMsg;
  }

  return { ok: true, msg: msg };
}

// ë‚ ì§œ â†’ ì¼ìˆ˜ ë³€í™˜
function dateKeyToDayNumber(key) {
  var y = parseInt(key.substr(0, 4), 10);
  var m = parseInt(key.substr(5, 2), 10);
  var d = parseInt(key.substr(8, 2), 10);
  return Math.floor(Date.UTC(y, m - 1, d) / 86400000);
}
// -------------------- íƒ€ì¸ ì •ë³´ ìœ í‹¸ --------------------
function getTargetFromMsg(d, sender, msg, cmd) {
  var tail = msg.slice(cmd.length).trim();
  if (!tail) 
    return {
  user: d.users[sender], 
  name: sender};
  if (tail.charAt(0) === "@") 
    tail = tail.slice(1);
  var tu = d.users[tail];
  if (!tu) 
    return null;
  normalizeUserData(tu);
  return {
  user: tu, 
  name: tail};
}

// -------------------- ë°°í‹€ ì—°ì¶œ ìœ í‹¸ --------------------
function clamp(n, a, b) {
  return Math.max(a, Math.min(b, n));
}
function rnd(min, max) {
  return min + Math.random() * (max - min);
}
function typeEffectTier(mult) {
  // remap ì´í›„ mult ìŠ¤ì¼€ì¼ì— ë§ì¶˜ ë¬¸êµ¬ ê¸°ì¤€
  if (mult >= 7.5) 
    return 3;
  if (mult >= 4.2) 
    return 2;
  if (mult >= 2.8) 
    return 1;
  if (mult <= 1.20) 
    return -1;
  return 0;
}
function typeEffectText(mult) {
  var t = typeEffectTier(mult);
  if (t === 3) 
    return "íš¨ê³¼ê°€ ë§ë„ ì•ˆ ë˜ê²Œ êµ‰ì¥í–ˆë‹¤!";
  if (t === 2) 
    return "íš¨ê³¼ê°€ êµ‰ì¥í–ˆë‹¤!";
  if (t === 1) 
    return "íš¨ê³¼ê°€ ì¢‹ì•˜ë‹¤!";
  if (t === -1) 
    return "íš¨ê³¼ê°€ ë³„ë¡œì¸ ë“¯í•˜ë‹¤â€¦";
  return "";
}
function funnyHitText() {
  var arr = ["ì •ì‹ ì´ ì ê¹ ë‚˜ê°”ë‹¤!", "í™”ë©´ ë°–ìœ¼ë¡œ ë‚ ì•„ê°ˆ ë»”í–ˆë‹¤!", "ì˜†ì—ì„œ êµ¬ê²½í•˜ë˜ ì‚¬ëŒë„ ë†€ëë‹¤!", "ë‚´ê°€ ë°©ê¸ˆ ë­˜ ë³¸ ê±°ì§€â€¦?", "ì´ê±´ ì¢€ ê³¼í–ˆë‹¤!", "ìƒëŒ€ê°€ ì ê¹ ë©ˆì·„ë‹¤â€¦(ë ‰ ì•„ë‹˜)"];
  return arr[Math.floor(Math.random() * arr.length)];
}
function funnyDodgeText() {
  var arr = ["íšŒí”¼í–ˆë‹¤! ìŠ¬ì© ë¹„ì¼œê°”ë‹¤!", "íšŒí”¼í–ˆë‹¤! ë¯¸ë„ëŸ¬ì§€ë“¯ í”¼í–ˆë‹¤!", "íšŒí”¼í–ˆë‹¤! â€˜ì•ˆ ë§ì¥¬?â€™", "íšŒí”¼í–ˆë‹¤! ì´ê±¸ í”¼í•˜ë„¤â€¦?", "íšŒí”¼í–ˆë‹¤! ë°œë°‘ì´ ê°€ë²¼ì› ë‹¤!"];
  return arr[Math.floor(Math.random() * arr.length)];
}
function funnyGuardText() {
  var arr = ["ë°©ì–´ íƒœì„¸! ë°ë¯¸ì§€ê°€ ì¤„ì—ˆë‹¤!", "ê°€ë“œ ì„±ê³µ! ë‹¨ë‹¨í•˜ê²Œ ë²„í…¼ë‹¤!", "ë§‰ì•„ëƒˆë‹¤! ê±°ì˜ ì•ˆ ë“¤ì–´ê°”ë‹¤!", "ë°©ì–´! ìƒëŒ€ê°€ ë‹¹í™©í–ˆë‹¤!"];
  return arr[Math.floor(Math.random() * arr.length)];
}
function crisisText(name) {
  var arr = [name + " ìœ„ê¸°! ìˆ¨ì´ í„±ê¹Œì§€ ì°¼ë‹¤!", name + " ìœ„ê¸°! ëˆˆì•ì´ í•˜ì–˜ì¡Œë‹¤!", name + " ìœ„ê¸°! ì†ì— ë•€ì´ ë‚œë‹¤!", name + " ìœ„ê¸°! â€˜ì—¬ê¸°ì„œ ì§€ë©´ ì•ˆ ë¼!â€™"];
  return arr[Math.floor(Math.random() * arr.length)];
}
// [ìˆ˜ì •] ì²´ë ¥ ê³„ì‚° (ì¥ë¹„ í¼ì„¼íŠ¸ ì¦ê°€ ë¡œì§ ì¶”ê°€)
function calcHP(db, enh, ivHp, equipName) {
  var s = getStageFromBase(db.id);
  if (db.rarity === 5) s = 2; 
  
  var addPerEnh = (s === 0) ? 20 : (s === 1) ? 50 : 100; 
  var base = 500 + (db.basePower * 12);
  var hp = base + Math.floor(enh * addPerEnh) + (ivHp || 0);
  
  if (db.rarity === 5) hp = Math.floor(hp * 1.2);

  // â˜… ì¥ë¹„ íš¨ê³¼ ì ìš©
  if (equipName && EQUIP_DB[equipName]) {
      var item = EQUIP_DB[equipName];
      
      // 1. ê¹¡ì²´ë ¥ ì¦ê°€ (ìë­‰ì—´ë§¤)
      if (item.type === "hp_flat") {
          hp += item.val;
      }
      // 2. í¼ì„¼íŠ¸ ì¦ê°€ (ëˆ„ëˆ„ì˜ìš”ë¦¬) - â˜… ì‹ ê·œ ë¡œì§
      else if (item.type === "hp_pct") {
          hp = Math.floor(hp * (1 + item.val));
      }
  }

  return clamp(hp, 500, 200000); // ì²´ë ¥ ìƒí•œì„  20ë§Œìœ¼ë¡œ ìƒí–¥
}


// [ìˆ˜ì •] ë°ë¯¸ì§€ ê³„ì‚° (ì¥ë¹„ ê³µê²©ë ¥/ë°©ì–´ë ¥/ì†ì„± ë°˜ì˜)
function calcDamage(attDb, attEnh, defDb, defEnh, attEquip, defEquip) {
  var atkType = attDb.type1;
  var mult = typeMultiplierAdjusted(atkType, defDb.type1);
  if (defDb.type2) mult = Math.min(mult, TYPE_STRONG * 1.4);

  // --- ê¸°ë³¸ ìŠ¤íƒ¯ ê³„ì‚° ---
  var attPid = attDb.id || attDb.pid;
  var defPid = defDb.id || defDb.pid;
  var aStage = stageBattleMul(attPid);
  var dStage = stageBattleMul(defPid);
  var aR = rarityBattleMul(attDb.rarity || 2);
  var dR = rarityBattleMul(defDb.rarity || 2);

  var atkPower = attDb.basePower * (1 + (attEnh * ATK_ENH_RATE)) * aStage.atk * aR;
  var defPower = defDb.basePower * (1 + (defEnh * DEF_ENH_RATE)) * dStage.def * dR;

  // â˜… [ì¥ë¹„] ê³µê²©ì ë³´ë„ˆìŠ¤
  if (attEquip && EQUIP_DB[attEquip]) {
      var eq = EQUIP_DB[attEquip];
      // 1. ê¹¡ê³µê²©ë ¥ % ì¦ê°€
      if (eq.type === "atk_pct") atkPower *= (1 + eq.val);
      // 2. ì†ì„± ë§ì¶¤ ë³´ë„ˆìŠ¤ (ì˜ˆ: ë¦¬ìëª½ + ë¶ˆê½ƒêµ¬ìŠ¬)
      if (eq.type === "type_boost") {
          if (attDb.type1 === eq.cond || attDb.type2 === eq.cond) {
              atkPower *= (1 + eq.val);
          }
      }
  }

  // â˜… [ì¥ë¹„] ë°©ì–´ì ë³´ë„ˆìŠ¤ (ë°ë¯¸ì§€ ê°ì†Œ = ë°©ì–´ë ¥ ì¦ê°€ë¡œ í™˜ì‚° ì ìš©)
  if (defEquip && EQUIP_DB[defEquip]) {
      var eq = EQUIP_DB[defEquip];
      if (eq.type === "def_pct") {
          // ë°ë¯¸ì§€ ê°ì†Œìœ¨ì„ ë°©ì–´ë ¥ ì¦ê°€ë¡œ ì—­ì‚° ì ìš© (ë‹¨ìˆœí™”)
          // ë°›ëŠ” í”¼í•´ 30% ê°ì†Œ -> ë°©ì–´ë ¥ ì•½ 1.42ë°°
          defPower *= (1 / (1 - eq.val)); 
      }
  }

  var baseDmg = atkPower * 0.35;
  var powerRatio = atkPower / Math.max(1, defPower);
  var score = Math.floor(baseDmg * powerRatio * mult);

  return { score: Math.max(1, score), mult: mult };
}

// [ìˆ˜ì •] ìŠ¤í”¼ë“œ(ì„ ê³µ/íšŒí”¼)ì— ì¥ë¹„ ë°˜ì˜
function calcHit(attDb, attP, defDb, defP, trainerLvAtt, trainerLvDef) {
  // ë°ë¯¸ì§€ ê³„ì‚° ì‹œ ì¥ë¹„ ì •ë³´ ì „ë‹¬
  var base = calcDamage(attDb, attP.enh, defDb, defP.enh, attP.equip, defP.equip);
  
  var strBonus = 1 + ((attP.ivStr || 0) * 0.015); 
  if (attP.shiny) strBonus *= 1.1; 
  base.score = Math.floor(base.score * strBonus);

  // â˜… [ì¥ë¹„] ìŠ¤í”¼ë“œ ê³„ì‚°
  var spdAtt = (attP.ivSpd || 0);
  var spdDef = (defP.ivSpd || 0);
  
  if (attP.equip && EQUIP_DB[attP.equip] && EQUIP_DB[attP.equip].type === "spd_flat") spdAtt += EQUIP_DB[attP.equip].val;
  if (defP.equip && EQUIP_DB[defP.equip] && EQUIP_DB[defP.equip].type === "spd_flat") spdDef += EQUIP_DB[defP.equip].val;

  var spdDiff = spdDef - spdAtt; 
  
  // (ì´í•˜ ê¸°ì¡´ íšŒí”¼/í¬ë¦¬ ë¡œì§ ë™ì¼...)
  var dodge = 0.10 + clamp(((trainerLvDef || 1) - (trainerLvAtt || 1)) * 0.0008, -0.03, 0.03) + clamp((defP.enh - attP.enh) * 0.004, -0.02, 0.02) + (spdDiff * 0.002); 
  dodge = clamp(dodge, 0.05, 0.25); 

  var guard = 0.12 + clamp(defP.enh * 0.002, 0, 0.04);
  var crit = 0.12 + clamp(attP.enh * 0.001, 0, 0.03) + ((attP.ivSpd || 0) * 0.003);
  if (attP.shiny) crit += 0.02; 
  crit = clamp(crit, 0.10, 0.25);

  var swing = rnd(0.88, 1.12);

  if (Math.random() < dodge) return { dodged: true, guarded: false, crit: false, dmg: 0, mult: base.mult };

  var isGuard = (Math.random() < guard);
  var isCrit = (Math.random() < crit);
  var dmg = Math.max(1, Math.floor(base.score * swing * (isCrit ? 1.55 : 1.0) * (isGuard ? 0.55 : 1.0)));

  return { dodged: false, guarded: isGuard, crit: isCrit, dmg: dmg, mult: base.mult };
}


// [ìˆ˜ì •ë¨] ë°°í‹€ ë¡œê·¸ ì‹œë®¬ë ˆì´í„° (ì´ˆë°˜ 10í„´ + í›„ë°˜ 4í„´ ë…¸ì¶œ)
function simulateBattleLog(aName, aDb, aP, aTLv, bName, bDb, bP, bTLv) {
  // 1. ì²´ë ¥ ë° ìŠ¤íƒ¯ ì„¸íŒ…
  var aMax = calcHP(aDb, aP.enh, aP.ivHp || 0);
  var bMax = calcHP(bDb, bP.enh, bP.ivHp || 0);
  var aHP = aMax;
  var bHP = bMax;

  // ì‹¤ì „ ê³µê²©ë ¥ (ë¡œê·¸ í‘œì‹œìš©)
  function getRealAtk(db, p) {
    var base = db.basePower;
    var enhBonus = 1 + (p.enh * 0.085);
    var ivBonus = 1 + ((p.ivStr || 0) * 0.015);
    var rMul = rarityBattleMul(db.rarity || 2); 
    var sMul = stageBattleMul(db.id).atk;
    var val = base * enhBonus * ivBonus * rMul * sMul;
    if (p.shiny) val *= 1.1; 
    return Math.floor(val);
  }

  var aRealAtk = getRealAtk(aDb, aP);
  var bRealAtk = getRealAtk(bDb, bP);

  // ì´ë¦„ (ì´ë¡œì¹˜ ë°˜ì˜)
  var aPokeName = getDisplayName(aP);
  var bPokeName = getDisplayName(bP);

  // ì„ ê³µ ê²°ì •
  var spdAdvantage = ((aP.ivSpd || 0) - (bP.ivSpd || 0)) * 0.02;
  var aFirst = 0.50 + clamp((aP.enh - bP.enh) * 0.02 + spdAdvantage, -0.2, 0.2);
  var aTurn = (Math.random() < aFirst);

  // ë¡œê·¸ í—¤ë” ìƒì„±
  var logHeader = "";
  var aE = enhLabel(aP.enh);
  var bE = enhLabel(bP.enh);

  logHeader += "âš”ï¸ " + aName + ": " + aPokeName + (aE ? " " + aE : "") + "\n";
  logHeader += "(HP " + aMax + " / ê³µ " + aRealAtk + " / ìŠ¤ " + (aP.ivSpd||0) + ")\n";
  logHeader += "ğŸ›¡ï¸ " + bName + ": " + bPokeName + (bE ? " " + bE : "") + "\n";
  logHeader += "(HP " + bMax + " / ê³µ " + bRealAtk + " / ìŠ¤ " + (bP.ivSpd||0) + ")\n\n";
  logHeader += (aTurn ? (aPokeName + "ì˜ ì„ ê³µ!\n\n") : (bPokeName + "ì˜ ì„ ê³µ!\n\n"));

  var turn = 1;
  var MAX_SAFE_TURNS = 200;
  
  // â˜… ëª¨ë“  í„´ì˜ ë¡œê·¸ë¥¼ ì €ì¥í•  ë°°ì—´
  var turnLogs = []; 
  var aCrisisShown = false; var bCrisisShown = false;

  // --- ë°°í‹€ ë£¨í”„ ì‹œì‘ ---
  while (aHP > 0 && bHP > 0 && turn <= MAX_SAFE_TURNS) {
    var attackerName = aTurn ? aPokeName : bPokeName;
    var defenderName = aTurn ? bPokeName : aPokeName;
    
    var attDb = aTurn ? aDb : bDb;
    var defDb = aTurn ? bDb : aDb;
    var attP_curr = aTurn ? aP : bP;
    var defP_curr = aTurn ? bP : aP;
    var attLv = aTurn ? aTLv : bTLv;
    var defLv = aTurn ? bTLv : aTLv;

    // ëª…ì¤‘/íšŒí”¼/í¬ë¦¬ ê³„ì‚°
    var hit = calcHit(attDb, attP_curr, defDb, defP_curr, attLv, defLv);
    
    // ì´ë²ˆ í„´ì˜ ë¡œê·¸ë¥¼ ì„ì‹œ ì €ì¥í•  ë³€ìˆ˜
    var thisTurnStr = "";

    if (hit.dodged) {
      thisTurnStr = turn + "í„´) " + attackerName + " ê³µê²©! â†’ " + defenderName + " " + funnyDodgeText();
    } else {
      // ë°ë¯¸ì§€ ë³´ì • ë° ì ìš©
      var finalDmg = hit.dmg;
      var mod = getRarityBattleModifier(attDb, turn); 
      finalDmg = Math.floor(finalDmg * mod.atk);
      if(defDb.rarity) {
          var dmod = getRarityBattleModifier(defDb, turn);
          finalDmg = Math.floor(finalDmg * dmod.def);
      }
      finalDmg = Math.max(1, finalDmg);
      if (isNaN(finalDmg)) finalDmg = 1;

      if (aTurn) bHP -= finalDmg; else aHP -= finalDmg;

      // í„´ ë¡œê·¸ êµ¬ì„±
      thisTurnStr = turn + "í„´) " + attackerName + " ê³µê²©! â†’ " + defenderName + " -" + finalDmg;
      if (hit.crit) thisTurnStr += " ğŸ’¥ê¸‰ì†Œ!";
      if (hit.guarded) thisTurnStr += " ğŸ›¡ï¸ë°©ì–´";
      thisTurnStr += "\n";
      
      var eff = typeEffectText(hit.mult);
      if (eff) thisTurnStr += eff + "\n";
      
      thisTurnStr += "HP: " + aPokeName + " " + Math.max(0, aHP) + " vs " + bPokeName + " " + Math.max(0, bHP);
    }
    
    // ìœ„ê¸° ì—°ì¶œ (í•œ ë²ˆë§Œ)
    if (!aCrisisShown && aHP > 0 && aHP <= aMax * 0.2) { 
        thisTurnStr += "\n\n" + crisisText(aPokeName); 
        aCrisisShown = true; 
    }
    if (!bCrisisShown && bHP > 0 && bHP <= bMax * 0.2) { 
        thisTurnStr += "\n\n" + crisisText(bPokeName); 
        bCrisisShown = true; 
    }

    // ë°°ì—´ì— ì €ì¥
    turnLogs.push(thisTurnStr);

    aTurn = !aTurn;
    turn++;
  }
  // --- ë°°í‹€ ë£¨í”„ ë ---

  // ìŠ¹íŒ¨ íŒì •
  var winner = "draw";
  if (aHP <= 0 && bHP <= 0) winner = "draw";
  else if (bHP <= 0) winner = "A";
  else if (aHP <= 0) winner = "B";
  else { if (aHP > bHP) winner = "A"; else if (bHP > aHP) winner = "B"; }

  // â˜… [ë¡œê·¸ ì¡°ë¦½] ì• 10í„´ + ... + ë’¤ 4í„´
  var finalLogBody = "";
  var SHOW_HEAD = 10; // ì•ì—ì„œ ë³´ì—¬ì¤„ í„´ ìˆ˜
  var SHOW_TAIL = 4;  // ë’¤ì—ì„œ ë³´ì—¬ì¤„ í„´ ìˆ˜ (0ë˜ê¸° ì§ì „ ìƒí™©)

  if (turnLogs.length <= (SHOW_HEAD + SHOW_TAIL + 2)) {
      // í„´ì´ ì§§ìœ¼ë©´ ë‹¤ ë³´ì—¬ì¤Œ
      finalLogBody = turnLogs.join("\n\n");
  } else {
      // í„´ì´ ê¸¸ë©´ ìë¦„
      var headLog = turnLogs.slice(0, SHOW_HEAD).join("\n\n");
      var tailLog = turnLogs.slice(turnLogs.length - SHOW_TAIL).join("\n\n");
      finalLogBody = headLog + "\n\n...\nâš”ï¸ (ì¹˜ì—´í•œ ê³µë°©ì´ ì´ì–´ì§‘ë‹ˆë‹¤...)\n...\n\n" + tailLog;
  }

  var fullLog = logHeader + finalLogBody + "\n";
  var resultLine = (winner === "A") ? ("ê²°ê³¼: " + aName + " ìŠ¹ë¦¬!") : (winner === "B") ? ("ê²°ê³¼: " + bName + " ìŠ¹ë¦¬!") : "ê²°ê³¼: ë¬´ìŠ¹ë¶€!";
  
  return { winner: winner, log: fullLog, resultLine: resultLine };
}

function battleRewardLine(gold, exp) {
  return "ğŸ ë³´ìƒ: +" + gold + "ğŸ’° / +" + exp + "EXP";
}

// [ìˆ˜ì •] ë°°í‹€ ê²°ê³¼ì°½ ë‚´ í¬ì¼“ëª¬ í‘œì‹œ (ì´ë¡œì¹˜ ë°˜ì˜)
function battleMyPickLine(myUid, db, p) { // enh ëŒ€ì‹  p ê°ì²´ ë°›ìŒ
  var e = enhLabel(p.enh);
  var pName = getDisplayName(p); // â˜… ì—¬ê¸°ì„œ âœ¨ ì²˜ë¦¬
  return "ë‚´ í¬ì¼“ëª¬: #" + myUid + " " + pName + (e ? (" " + e) : "");
}

// [ìˆ˜ì •] ë°°í‹€ ê²°ê³¼ì°½ ìƒëŒ€ í¬ì¼“ëª¬ í‘œì‹œ
function battleOppPickLine(oppName, oppUid, db, p) { // enh ëŒ€ì‹  p ê°ì²´ ë°›ìŒ
  var e = enhLabel(p.enh);
  var pName = getDisplayName(p); // â˜… ì—¬ê¸°ì„œ âœ¨ ì²˜ë¦¬
  return oppName + "ì˜ í¬ì¼“ëª¬: #" + oppUid + " " + pName + (e ? (" " + e) : "");
}

// [ìµœì¢… ìˆ˜ì •] ë°°í‹€ ì‹¤í–‰ í•¨ìˆ˜ (ë°¸ëŸ°ìŠ¤ ì¡°ì ˆ: ê¸°ë³¸ê¸‰â†‘ ë³´ë„ˆìŠ¤â†“)
function runSingleBattle(d, room, sender, u, myPickUid, opt) {
  ensureUserStats(u);
  opt = opt || {};
  var isChain = !!opt.isChain; 
  var mult = (opt.rewardMult != null) ? opt.rewardMult : 1.0;
  var affectRecord = !isChain;

  if (ensurePokemonGrades(u)) saveData(d);

  // 1. ë‚´ í¬ì¼“ëª¬ ì„ ì •
  var myEligible = getBattleEligiblePokemons(u);
  if (myEligible.length === 0) {
    return { ok: false, msg: "ë°°í‹€ ì°¸ê°€ ì¡°ê±´: " + BATTLE_MIN_ENH + "ê°• ì´ìƒ í¬ì¼“ëª¬ì´ í•„ìš”í•©ë‹ˆë‹¤." };
  }

    var myP = null;
  if (myPickUid != null) {
    myP = findUserPokemonByUid(u, myPickUid);
    
    // â˜… [ì¶”ê°€] ì§ì ‘ ì§€ëª©í•œ í¬ì¼“ëª¬ì´ íƒí—˜ ì¤‘ì¸ì§€ ì—¬ê¸°ì„œë„ ì²´í¬!
    if (isPokemonBusy(u, myPickUid)) {
        return { ok: false, msg: "ğŸš« í•´ë‹¹ í¬ì¼“ëª¬ì€ íƒí—˜ ì¤‘ì´ë¼ ë°°í‹€ì— ë‚˜ê°ˆ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." };
    }

    if (!myP || (myP.enh || 0) < BATTLE_MIN_ENH) {
      return { ok: false, msg: "í•´ë‹¹ í¬ì¼“ëª¬ì€ ë°°í‹€ì— ì°¸ê°€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ìµœì†Œ " + BATTLE_MIN_ENH + "ê°• í•„ìš”)" };
    }
  } else {
    myP = randomPick(myEligible);
  }
  

  // 2. ë ˆë²¨ ìº¡ í•„í„°ë§ (Â±10ê°•)
  var oppList = getEligibleOpponentsMem(d, room, sender, myP.enh);
  if (oppList.length === 0) {
    return { ok: false, msg: "âš”ï¸ ë§¤ì¹­ ì‹¤íŒ¨\në¹„ìŠ·í•œ ì²´ê¸‰(Â±10ê°•)ì˜ ìƒëŒ€ê°€ ì—†ìŠµë‹ˆë‹¤." };
  }

  var oppName = randomPick(oppList);
  var opp = d.users[oppName];
  normalizeUserData(opp);
  ensureUserStats(opp);
  if (ensurePokemonGrades(opp)) saveData(d);

  // 3. ìƒëŒ€ í¬ì¼“ëª¬ ì„ ì • (ë²”ìœ„ ë‚´)
  var oppAllEligible = getBattleEligiblePokemons(opp);
  var oppTargetPool = [];
  var RANGE = 10;
  var minTarget = myP.enh - RANGE;
  var maxTarget = myP.enh + RANGE;

  for(var z=0; z<oppAllEligible.length; z++) {
    var pObj = oppAllEligible[z];
    var pe = pObj.enh || 0;
    if (pe >= minTarget && pe <= maxTarget) {
      oppTargetPool.push(pObj);
    }
  }

  if (oppTargetPool.length === 0) {
     return { ok: false, msg: "ë§¤ì¹­ ì·¨ì†Œ (ìƒëŒ€ ë°ì´í„° ë³€ê²½)" };
  }

  var opP = randomPick(oppTargetPool);
  var myDb = findPokemonDB(myP.pid);
  var opDb = findPokemonDB(opP.pid);
  if (!myDb || !opDb) return { ok: false, msg: "DB ì˜¤ë¥˜" };

  // 4. ì‹œë®¬ë ˆì´ì…˜
  var sim = simulateBattleLog(sender, myDb, myP, u.trainerLv, oppName, opDb, opP, opp.trainerLv);
  var result = 0; 
  if (sim.winner === "A") result = 1; else if (sim.winner === "B") result = -1;

  var goldGain = 0; var expGain = 0; var extraLines = "";
  var baseWinGold = 0;
  var enhBonusGold = 0;

  // 5. ë³´ìƒ ì§€ê¸‰ (ë°¸ëŸ°ìŠ¤ íŒ¨ì¹˜ ì ìš©)
  if (result === 1) { // ìŠ¹ë¦¬
    if (affectRecord) {
      u.stats.battleWin++;
      u.stats.battleStreak++;
      u.stats.loseStreak = 0; 
      u.stats.bestStreak = Math.max(u.stats.bestStreak, u.stats.battleStreak);

      // ì—°ìŠ¹ ë³´ë„ˆìŠ¤ë„ ì‚´ì§ í˜„ì‹¤í™” (50ë°° -> 30ë°°)
      if (u.stats.battleStreak % STREAK_GOLD_BONUS_EVERY === 0) {
        var streakGold = STREAK_GOLD_BONUS * 30; 
        u.gold += streakGold;
        extraLines += "ğŸ”¥ ì—°ìŠ¹ ë³´ë„ˆìŠ¤ í­ë°œ! +" + fmtNum(streakGold) + "ğŸ’°\n";
      }
      if (u.stats.battleStreak % STREAK_EXP_BONUS_EVERY === 0) {
        var lvMsg = addExpWithLevelUpMsg(u, STREAK_EXP_BONUS);
        if (lvMsg) extraLines += lvMsg + "\n";
      }
    }
    
    // [ë°¸ëŸ°ìŠ¤ ìˆ˜ì •] ê¸°ë³¸ê¸‰ 150ë°° (ì•½ 2.1ë§Œ) / ë³´ë„ˆìŠ¤ 1500ë°° (60ê°• ì‹œ 9ë§Œ)
    baseWinGold = Math.floor((BATTLE_GOLD_WIN * 150) + (u.trainerLv * 200));
    var randomMul = randInt(567, 3456); 
    enhBonusGold = (myP.enh || 0) * randomMul; 
    
    goldGain = baseWinGold + enhBonusGold;
    expGain = BATTLE_EXP_WIN;

  } else if (result === -1) { // íŒ¨ë°°
    if (affectRecord) {
      u.stats.battleLose++;
      u.stats.battleStreak = 0;
      u.stats.loseStreak = (u.stats.loseStreak||0) + 1;
      u.stats.maxLoseStreak = Math.max(u.stats.maxLoseStreak||0, u.stats.loseStreak);
    }
    // íŒ¨ë°° ìœ„ë¡œê¸ˆë„ í˜„ì‹¤í™” (ì•½ 4ì²œì›)
    goldGain = BATTLE_GOLD_LOSE * 100; 
    expGain = BATTLE_EXP_LOSE;

  } else { // ë¬´ìŠ¹ë¶€
    if (affectRecord) {
      u.stats.battleDraw++;
      if (u.stats.battleStreak > 0) {
        u.stats.battleStreak = 0;
        extraLines += "ë¬´ìŠ¹ë¶€ë¡œ ì—°ìŠ¹ ì¢…ë£Œ!\n";
      }
    }
    goldGain = 2000; // ë¬´ìŠ¹ë¶€ (ì•½ 2ì²œì›)
  }

  goldGain = Math.floor(goldGain * mult); 
  expGain = Math.floor(expGain * mult);
  
  if (goldGain > 0) u.gold += goldGain;
  if (expGain > 0) { 
    var lvMsg = addExpWithLevelUpMsg(u, expGain); 
    if(lvMsg) extraLines += lvMsg + "\n"; 
  }

  var header = blockTitle("ë°°í‹€ ê²°ê³¼");
  header += battleMyPickLine(myP.uid, myDb, myP) + "\n";
  header += battleOppPickLine(oppName, opP.uid, opDb, opP) + "\n\n";

  var resultLine = (result === 1) ? ("ğŸ† ìŠ¹ë¦¬: " + sender + "\n") : (result === -1) ? ("ğŸ’€ íŒ¨ë°°: " + sender + "\n") : ("ğŸ¤ ë¬´ìŠ¹ë¶€\n");
  
  // [ë³´ìƒ í‘œê¸°]
  var rewardLine = "";
  if (goldGain > 0) {
      if (result === 1 && enhBonusGold > 0) {
          rewardLine += "ğŸ ê¸°ë³¸: " + fmtNum(baseWinGold) + " + âš¡ë³´ë„ˆìŠ¤ " + fmtNum(enhBonusGold) + "\n";
          rewardLine += "ğŸ’° ì´ íšë“: +" + fmtNum(goldGain) + "ğŸ’° / +" + expGain + "EXP\n";
      } else {
          rewardLine += "ğŸ ë³´ìƒ: +" + fmtNum(goldGain) + "ğŸ’° / +" + expGain + "EXP\n";
      }
  }
  
  var summary = header + resultLine + rewardLine + (extraLines ? ("\n" + extraLines) : "") + "\nì „ì²´ë³´ê¸°ë¡œ ë°°í‹€ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.";
  var full = "\n\n[ë°°í‹€ ë¡œê·¸]\n\n" + sim.log + sim.resultLine + "\n";

  return { ok: true, result: result, summary: summary, full: full, myPick: myP, oppPick: opP };
}

function battleRewardLine(gold, exp) {
  return "ğŸ ë³´ìƒ: +" + gold + "ğŸ’° / +" + exp + "EXP";
}
// [ìˆ˜ì •] ë°°í‹€ ê²°ê³¼ì°½ ë‚´ í¬ì¼“ëª¬ í‘œì‹œ (ì´ë¡œì¹˜ ë°˜ì˜)
function battleMyPickLine(myUid, db, p) { // enh ëŒ€ì‹  p ê°ì²´ ë°›ìŒ
  var e = enhLabel(p.enh);
  var pName = getDisplayName(p); // â˜… ì—¬ê¸°ì„œ âœ¨ ì²˜ë¦¬
  return "ë‚´ í¬ì¼“ëª¬: #" + myUid + " " + pName + (e ? (" " + e) : "");
}

// [ìˆ˜ì •] ë°°í‹€ ê²°ê³¼ì°½ ìƒëŒ€ í¬ì¼“ëª¬ í‘œì‹œ
function battleOppPickLine(oppName, oppUid, db, p) { // enh ëŒ€ì‹  p ê°ì²´ ë°›ìŒ
  var e = enhLabel(p.enh);
  var pName = getDisplayName(p); // â˜… ì—¬ê¸°ì„œ âœ¨ ì²˜ë¦¬
  return oppName + "ì˜ í¬ì¼“ëª¬: #" + oppUid + " " + pName + (e ? (" " + e) : "");
}

// [ìˆ˜ì •ë¨] ë°°í‹€ ì°¸ê°€ ê°€ëŠ¥ í¬ì¼“ëª¬ (íƒí—˜ ì¤‘ì¸ ë…€ì„ ì œì™¸)
function getBattleEligiblePokemons(u) {
  if (!u) return [];
  var p = u.pokemons;
  if (!p) return [];
  
  var out = [];
  for (var i = 0; i < p.length; i++) {
    var pp = p[i];
    if (!pp) continue;
    
    // â˜… [ì¶”ê°€] íƒí—˜ ì¤‘ì´ë©´ ë°°í‹€ ëª…ë‹¨ì—ì„œ ì œì™¸
    if (isPokemonBusy(u, pp.uid)) continue; 

    if ((pp.enh || 0) >= BATTLE_MIN_ENH) out.push(pp);
  }
  return out;
}

// [ìˆ˜ì •ë¨] í¬ê·€ë„/í„´ ë³´ì • (2-3í‹°ì–´ í†µí•© ë°¸ëŸ°ìŠ¤)
function getRarityBattleModifier(db, turn, hpRate) {
  var r = db.rarity || 1;
  var atkMod = 1.0;
  var defMod = 1.0;

  // 1. [2~3í‹°ì–´] ì–¸ë”ë…ì˜ ë°˜ë€ (ë²„í„°í”Œ, í”¼ì£¤íˆ¬, ë¼ì´ì¸„ ë“±)
  // "ë¬´ì‹œí•˜ì§€ ë§ˆë¼! ì¥ë„ ê¶ì§€ì— ëª°ë¦¬ë©´ ê³ ì–‘ì´ë¥¼ ë¬¸ë‹¤."
  // ì „ëµ: ë§ìœ¼ë©´ì„œ ë²„í‹°ë‹¤ê°€, ì²´ë ¥ ì ˆë°˜ ì´í•˜(ìœ„ê¸°)ì¼ ë•Œ í­ë”œì„ ë„£ì–´ì•¼ í•¨.
  if (r <= 3) {
      if (hpRate <= 0.5) { 
          atkMod = 1.25; // ê³µê²©ë ¥ 25% ë–¡ìƒ (ë°°ìˆ˜ì˜ ì§„)
      }
  }
  
  // 2. [4í‹°ì–´] ë©”ì´ì € í¬ì¼“ëª¬ (ë¦¬ìëª½, ë§ë‚˜ë‡½, ê°¸ë¼ë„ìŠ¤ ë“±)
  // "ê°€ì¥ ì¹˜ì—´í•˜ê²Œ ì‹¸ìš°ëŠ” í—ˆë¦¬ ë¼ì¸"
  // ì „ëµ: ì´ˆë°˜ íƒìƒ‰ì „ì´ ëë‚œ ì¤‘ë°˜(4~8í„´)ì— ìŠ¹ë¶€ë¥¼ ë´ì•¼ í•¨.
  else if (r === 4) {
      if (turn >= 4 && turn <= 8) {
          atkMod = 1.15; // ê³µ 15% ì¦ê°€
          defMod = 1.10; // ë°© 10% ì¦ê°€
      }
  }
  
  // 3. [5í‹°ì–´] ì „ì„¤ì˜ í¬ì¼“ëª¬ (ë®¤ì¸ , ì¬ë”, í”„ë¦¬ì ¸ ë“±)
  // "ì••ë„ì ì¸ ì²´ê¸‰ì˜ ë³´ìŠ¤"
  // ì „ëµ: ì´ˆë°˜ì—” ë°©ì‹¬í•˜ì§€ë§Œ, ì¥ê¸°ì „ìœ¼ë¡œ ê°ˆìˆ˜ë¡ ì¬ì•™ì´ ë¨.
  else if (r === 5) {
      if (turn <= 3) {
          atkMod = 0.90; // ì´ˆë°˜ 3í„´: 10% ë´ì¤Œ (ë°©ì‹¬)
      } else if (turn >= 10) {
          atkMod = 1.45; // 10í„´ ì´í›„: 45% ë€ì¦ (ì¬ì•™)
          defMod = 1.15; // ë§·ì§‘ë„ ì„¸ì§
      }
  }

  return { atk: atkMod, def: defMod };
}


// -------------------- ì—°ì†ë°°í‹€ ë³´ìƒ ë°°ìœ¨ --------------------
function chainRewardMult(i) {
  // i = 1ë¶€í„° ì‹œì‘
  // 1íŒ 100%, 2íŒ 70%, 3íŒ 50%, 4íŒ 40%, 5íŒ 30%
  var table = [1.0, 0.7, 0.5, 0.4, 0.3];
  if (i <= 0) 
    return 0;
  if (i <= table.length) 
    return table[i - 1];
  return 0.25;
}
function applyMult(n, mult) {
  return Math.max(0, Math.floor((n || 0) * (mult || 0)));
}
/* =========================
   ê°•í™” ë©˜íŠ¸ ì„¸íŠ¸ (ì™„í™” ë²„ì „)
========================= */

// ---------- ìƒìŠ¹ ----------
var ENH_UP_EASY = ["í›ˆë ¨ íš¨ê³¼ê°€ ë°”ë¡œ ë‚˜íƒ€ë‚¬ì–´ìš”.", "ëª¸ë†€ë¦¼ì´ í•œê²° ê°€ë²¼ì›Œì¡ŒìŠµë‹ˆë‹¤.", "í¬ì¼“ëª¬ì´ ì¦ê²ê²Œ ì„±ì¥í•˜ê³  ìˆì–´ìš”."];
var ENH_UP_MID = ["í›ˆë ¨ì´ ì‰½ì§„ ì•Šì•˜ì§€ë§Œ ì„±ê³¼ê°€ ìˆì—ˆì–´ìš”.", "í¬ì¼“ëª¬ì´ ì´ë¥¼ ì•…ë¬¼ê³  ë²„í…¨ëƒˆìŠµë‹ˆë‹¤.", "ì„±ì¥ì´ ëˆˆì— ë„ê²Œ ëŠê»´ì§‘ë‹ˆë‹¤."];
var ENH_UP_HARD = ["âš¡ ì ì¬ë ¥ì´ í¬ê²Œ ìê·¹ë°›ì•˜ìŠµë‹ˆë‹¤!", "ğŸ”¥ í•œê³„ë¥¼ ë„˜ëŠ” ì„±ì¥ì…ë‹ˆë‹¤!", "âœ¨ ìƒˆë¡œìš´ ê²½ì§€ì— í•œ ë°œ ë‹¤ê°€ì„°ì–´ìš”."];
// ---------- ìœ ì§€ ----------
var ENH_KEEP_EASY = ["í° ë³€í™”ëŠ” ì—†ì—ˆì§€ë§Œ ì•ˆì •ì ì´ì—ˆì–´ìš”.", "ì˜¤ëŠ˜ì€ ì»¨ë””ì…˜ ì ê²€ ì •ë„ë¡œ ì¶©ë¶„í•©ë‹ˆë‹¤.", "ë¬´ë¦¬í•˜ì§€ ì•ŠëŠ” ê²ƒë„ ì„±ì¥ì˜ ì¼ë¶€ì˜ˆìš”."];
var ENH_KEEP_MID = ["ê°„ì‹ íˆ ê· í˜•ì„ ìœ ì§€í–ˆìŠµë‹ˆë‹¤.", "ì„±ì¥ì€ ë©ˆì·„ì§€ë§Œ ë¬´ë„ˆì§€ì§„ ì•Šì•˜ì–´ìš”.", "ì§€ê¸ˆ ë‹¨ê³„ì—ì„  ì´ê²ƒë„ ë‚˜ì˜ì§€ ì•Šì•„ìš”."];
var ENH_KEEP_HARD = ["âš ï¸ ë§¤ìš° ì•„ìŠ¬ì•„ìŠ¬í•œ í›ˆë ¨ì´ì—ˆì–´ìš”.", "ğŸ”¥ í•œê³„ì—ì„œ ê°„ì‹ íˆ ë²„í…¨ëƒˆìŠµë‹ˆë‹¤.", "ì¡°ê¸ˆë§Œ ë” ë°€ì—ˆìœ¼ë©´ ìœ„í—˜í–ˆì„ì§€ë„ ëª°ë¼ìš”."];
// ---------- í•˜ë½ ----------
var ENH_DOWN_EASY = ["í›ˆë ¨ ê°•ë„ê°€ ì¡°ê¸ˆ ê³¼í–ˆë‚˜ ë´…ë‹ˆë‹¤.", "ì»¨ë””ì…˜ ì¡°ì ˆì´ í•„ìš”í•´ ë³´ì—¬ìš”.", "ì ì‹œ ì‰¬ì–´ê°€ëŠ” ê²Œ ì¢‹ê² ìŠµë‹ˆë‹¤."];
var ENH_DOWN_MID = ["í›ˆë ¨ ë¶€ë‹´ì´ ê·¸ëŒ€ë¡œ ë“œëŸ¬ë‚¬ìŠµë‹ˆë‹¤.", "í¬ì¼“ëª¬ì´ ë²„í‹°ê¸° í˜ë“¤ì–´í–ˆì–´ìš”.", "ì§€ê¸ˆ ë‹¨ê³„ì—ì„  ë¬´ë¦¬ì˜€ë˜ ê²ƒ ê°™ì•„ìš”."];
var ENH_DOWN_HARD = ["ğŸ’¢ í•œê³„ì— í¬ê²Œ ë¶€ë”ªí˜”ìŠµë‹ˆë‹¤.", "ğŸ”¥ ìœ„í—˜í•œ í›ˆë ¨ì´ì—ˆì–´ìš”.", "âš ï¸ ìƒíƒœê°€ ëˆˆì— ë„ê²Œ ë‚˜ë¹ ì¡ŒìŠµë‹ˆë‹¤."];
// ---------- ì´íƒˆ (ì™„í™”ëœ ì‚¬ë§) ----------
var ENH_EXIT_LINES = ["í¬ì¼“ëª¬ì´ í›ˆë ¨ì„ ë” ì´ìƒ ì´ì–´ê°€ê¸° í˜ë“  ìƒíƒœì…ë‹ˆë‹¤.", "í° ë¶€ë‹´ì´ ëˆ„ì ë˜ì–´ í›ˆë ¨ì—ì„œ ì´íƒˆí–ˆìŠµë‹ˆë‹¤.", "ì§€ê¸ˆì€ íœ´ì‹ê³¼ íšŒë³µì´ í•„ìš”í•œ ìƒíƒœì˜ˆìš”.", "ë¬´ë¦¬í•œ í›ˆë ¨ìœ¼ë¡œ ë” ì´ìƒ ë™í–‰í•  ìˆ˜ ì—†ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤."];
// ---------- í—¬ ê°“? ----------
var ENH_UP_HELL = ["ğŸ”¥ ë¶ˆê°€ëŠ¥ì„ ê°€ëŠ¥ìœ¼ë¡œ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤!", "ğŸ©¸ í”¼ì™€ ë•€ìœ¼ë¡œ ë§Œë“  ê²°ê³¼ì…ë‹ˆë‹¤!", "ğŸ”± ì‹ í™”ì ì¸ í˜ì´ ê¹ƒë“¤ê¸° ì‹œì‘í•©ë‹ˆë‹¤."];
var ENH_UP_GOD = ["ğŸ‘‘ ì´ê²ƒì€ ê¸°ì ì…ë‹ˆë‹¤! ì „ì„¤ì˜ íƒ„ìƒ!", "ğŸŒŒ ìš°ì£¼ê°€ ë‹¹ì‹ ì„ ë•ê³  ìˆìŠµë‹ˆë‹¤!", "ğŸŒŸ ì„œë²„ì˜ ì—­ì‚¬ë¥¼ ìƒˆë¡œ ì”ë‹ˆë‹¤!"];
var ENH_KEEP_HELL = ["ğŸ’€ ì‹¬ì¥ì´ ë©ˆì¶œ ë»”í–ˆìŠµë‹ˆë‹¤... ìœ ì§€ ì„±ê³µ.", "ğŸ›¡ï¸ íŒŒê´´ë˜ì§€ ì•Šì€ ê²ƒë§Œìœ¼ë¡œë„ ë‹¤í–‰ì…ë‹ˆë‹¤.", "ğŸ’¢ ë²½ì´ ë„ˆë¬´ë‚˜ë„ ë†’ìŠµë‹ˆë‹¤."];
var ENH_KEEP_GOD = ["ğŸŒŒ ì‹ ì˜ ì˜ì—­ì€ ì‰½ê²Œ í—ˆë½ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.", "ğŸ§˜ ë¬´ì‚¬í•œ ê²ƒì— ê°ì‚¬í•˜ì‹­ì‹œì˜¤.", "ğŸŒ«ï¸ í—ˆê³µì— ê³¨ë“œë¥¼ ë¿Œë ¸ì§€ë§Œ, í¬ì¼“ëª¬ì€ ë¬´ì‚¬í•©ë‹ˆë‹¤."];
var ENH_DOWN_HELL = ["ğŸ©¸ ë¼ˆì•„í”ˆ ì‹¤íŒ¨... ë‹¨ê³„ê°€ í•˜ë½í–ˆìŠµë‹ˆë‹¤.", "ğŸ“‰ ì •ì ì—ì„œ ë¯¸ë„ëŸ¬ì¡ŒìŠµë‹ˆë‹¤.", "ğŸ’” ìš•ì‹¬ì´ ê³¼í–ˆë˜ ê±¸ê¹Œìš”..."];
var ENH_DOWN_GOD = ["â˜„ï¸ ì¶”ë½í•˜ëŠ” ê²ƒì€ ë‚ ê°œê°€ ìˆë‹¤...", "ğŸ“‰ ì‹ ì˜ ë¶„ë…¸ë¥¼ ìƒ€ìŠµë‹ˆë‹¤.", "ğŸŒ‘ ë‹¤ì‹œ ë°‘ë°”ë‹¥ë¶€í„° ê¸°ì–´ì˜¬ë¼ê°€ì•¼ í•©ë‹ˆë‹¤."];

// -------------------- ê°•í™” ê²°ê³¼ ë©˜íŠ¸ ë¹Œë” (ì´ë¡œì¹˜ ë°˜ì˜ ë²„ì „) --------------------
function buildEnhResultMsg(sender, p, before, after, resultType) {
  var tier = getEnhTier(before);
  var line = "";
  
  // â˜… í¬ì¼“ëª¬ ê°ì²´(p)ë¥¼ ë„£ì–´ì„œ âœ¨ë³„ì´ ë¶™ì€ ì´ë¦„ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
  var pShowName = getDisplayName(p); 
  
  if (resultType === ENH_RESULT_UP) {
    if (tier === "EASY") line = pick(ENH_UP_EASY);
    else if (tier === "MID") line = pick(ENH_UP_MID);
    else if (tier === "HARD") line = pick(ENH_UP_HARD);
    else if (tier === "HELL") line = pick(ENH_UP_HELL);
    else line = pick(ENH_UP_GOD);
  } else if (resultType === ENH_RESULT_KEEP) {
    if (tier === "EASY") line = pick(ENH_KEEP_EASY);
    else if (tier === "MID") line = pick(ENH_KEEP_MID);
    else if (tier === "HARD") line = pick(ENH_KEEP_HARD);
    else if (tier === "HELL") line = pick(ENH_KEEP_HELL);
    else line = pick(ENH_KEEP_GOD);
  } else if (resultType === ENH_RESULT_DOWN) {
    if (tier === "EASY") line = pick(ENH_DOWN_EASY);
    else if (tier === "MID") line = pick(ENH_DOWN_MID);
    else if (tier === "HARD") line = pick(ENH_DOWN_HARD);
    else if (tier === "HELL") line = pick(ENH_DOWN_HELL);
    else line = pick(ENH_DOWN_GOD);
  } else if (resultType === ENH_RESULT_EXIT) {
    line = pick(ENH_EXIT_LINES);
  }
  
  var afterLabel = (resultType === ENH_RESULT_EXIT) ? "ì´íƒˆ" : enhLabelAlways(after);
  // pName ëŒ€ì‹  pShowNameì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
  var header = "ğŸ¾ " + sayDo(sender, pShowName + " í›ˆë ¨ ê²°ê³¼") + "\n" + "ğŸ“Š ê°•í™” ë‹¨ê³„: " + enhLabelAlways(before) + " â†’ " + afterLabel + "\n\n";
  return header + line;
}

function pct(x) {
  return Math.floor(x * 1000) / 10;
}
function clamp01(x) {
  return Math.max(0, Math.min(1, x));
}

// [ë°¸ëŸ°ìŠ¤ íŒ¨ì¹˜] 60ê°• ì²´ì œ í™•ë¥ í‘œ
// 0~20: ì§„í™” ì§€ì› (í˜œì)
// 30~40: í†µê³¡ì˜ ë²½ (ë‘ì«€ì¿  ìœ ë„ ì‹œì‘)
// 40~60: 1~2% (ë‘ì«€ì¿  í•„ìˆ˜ êµ¬ê°„)
function enhanceRatesByRarity(nextEnh, trainerLv, rarity) {
  nextEnh = parseInt(nextEnh, 10);
  if (isNaN(nextEnh)) nextEnh = 1;
  var curEnh = nextEnh - 1; 

  var min = 0.01, max = 0.01;

  // [êµ¬ê°„ë³„ í™•ë¥  ì„¤ì •]
  if (curEnh < 5)        { min = 0.95; max = 1.00; } // 0~4 (ê±°ì˜ ì„±ê³µ)
  else if (curEnh < 10)  { min = 0.80; max = 0.90; } // 5~9 (ë§¤ìš° ì‰¬ì›€)
  else if (curEnh < 15)  { min = 0.60; max = 0.75; } // 10~14 (ì‰¬ì›€)
  else if (curEnh < 20)  { min = 0.40; max = 0.55; } // 15~19 (í• ë§Œí•¨ - ì§„í™” êµ¬ê°„)
  else if (curEnh < 30)  { min = 0.15; max = 0.30; } // 20~29 (ê°‘ìê¸° ì–´ë ¤ì›Œì§)
  else if (curEnh < 40)  { min = 0.03; max = 0.08; } // 30~39 (í†µê³¡ì˜ ë²½ - ë‘ì«€ì¿  ë§ˆë ¤ì›€)
  else                   { min = 0.01; max = 0.02; } // 40~59 (ì§€ì˜¥ - ì¿ í‚¤ ì—†ìœ¼ë©´ ë¶ˆê°€)

  // êµ¬ê°„ ë‚´ ë¯¸ì„¸ ì¡°ì •
  var rangeSize = 5;
  if (curEnh >= 20) rangeSize = 10; 
  if (curEnh >= 40) rangeSize = 20;

  var segmentPos = curEnh % rangeSize;
  var t = clamp01(segmentPos / rangeSize);
  var base = max - (max - min) * t;

  // [ë ˆë²¨ ë³´ì •] (ìµœëŒ€ +8%)
  // 40ê°• ì´í›„ì—” ë ˆë²¨ë¹¨ë„ ê±°ì˜ ì•ˆ ë°›ê²Œ ë„ˆí”„ (ì¿ í‚¤ ê°€ì¹˜ ë³´ì¡´)
  var lv = trainerLv || 1;
  var bonus = (lv - 1) * 0.0008; 
  if (curEnh >= 40) bonus = 0; // 40ê°•ë¶€í„°ëŠ” ë ˆë²¨ ë³´ì • ì—†ìŒ (ìˆœìˆ˜ ìš´ or ì¿ í‚¤)
  else if (bonus > 0.08) bonus = 0.08;

  var success = base + bonus;

  // [í¬ê·€ë„ ë³´ì •] ì „ì„¤(5ì„±)ì€ 30ê°• ì´í›„ ì•„ì£¼ ì¡°ê¸ˆ ë³´ì •
  if (rarity === 5 && curEnh >= 30) success += 0.005;

  success = clamp01(success);
  if (success < 0.01) success = 0.01; // ìµœì†Œ 1% ë³´ì¥

  return { success: success, keep: 1 - success, death: 0 };
}

function buildNextEnhInfoLine(p, resultType, u) {
  if (resultType === ENH_RESULT_EXIT) {
    return "\n\nğŸ“Œ ë‹¤ë¥¸ í¬ì¼“ëª¬ì„ ê°•í™”í•˜ë ¤ë©´ /ë‚´í¬ì¼“ëª¬ ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.";
  }
  if (!p) return "";

  var dbx = findPokemonDB(p.pid);
  var rr = dbx ? dbx.rarity : 2;

  // âœ… ë‹¤ìŒ ì‹œë„ëŠ” (í˜„ì¬ ê°•í™” + 1)ì„ ëª©í‘œë¡œ í•¨
  var nextEnh = Math.min(ENHANCE_MAX, (p.enh || 0) + 1);

  // ê¸°ì¡´: var rates = enhanceRatesByRarity(p.enh, (u ? u.trainerLv : 1), rr);
  var rates = enhanceRatesByRarity(nextEnh, (u ? u.trainerLv : 1), rr);

  // ê¸°ì¡´: var nextCost = enhanceCostByRarity(p.enh, rr);
  var nextCost = enhanceCostByRarity(nextEnh, rr);

  var myGold = (u && typeof u.gold === "number") ? u.gold : null;

  var out = "";
  out += "\n\ní˜„ì¬ ë³´ìœ  ê³¨ë“œ : " + (myGold === null ? "-" : (fmtNum(myGold) + "ğŸ’°")) + "\n";
  out += "ë‹¤ìŒ ê°•í™” ì„±ê³µ í™•ë¥  : " + pct(rates.success) + "%\n";
  out += "ë‹¤ìŒ ê°•í™” í•„ìš” ê³¨ë“œ : " + fmtNum(nextCost) + "ğŸ’°";
  return out;
}


// íƒí—˜ í¬ì¼“ëª¬ íšë“ í™•ë¥  (ë ˆë²¨ ê¸°ë°˜)
function getExplorePokemonChance(trainerLv) {
  var base = 0.03;  // ê¸°ë³¸ 3%
  var perLv = 0.002;  // ë ˆë²¨ë‹¹ +0.2%
  var max = 0.15;  // ìµœëŒ€ 15%
  var chance = base + (trainerLv * perLv);
  if (chance > max) 
    chance = max;
  if (chance < 0) 
    chance = 0;
  return chance;
}
function cooldownRemainMsg(sender, lastAt, cooldownMs, actionName) {
  var now = nowMs();
  var remainMs = cooldownMs - (now - lastAt);
  if (remainMs < 0) 
    remainMs = 0;
  var sec = Math.ceil(remainMs / 1000);
  return sender + "ë‹˜, " + sec + "ì´ˆ í›„ ë‹¤ì‹œ " + actionName + "í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
}
// -------------------- [ì‹ ê·œ] íƒí—˜ ìƒíƒœ í™•ì¸ ìœ í‹¸ --------------------
var EXPLORE_TIME_MS = 60 * 60 * 1000; // 1ì‹œê°„ (í…ŒìŠ¤íŠ¸í•  ë• 1000 * 10 ìœ¼ë¡œ 10ì´ˆë§Œ í•´ë³´ì„¸ìš”) 60 * 60 * 1000;

function isPokemonBusy(u, uid) {
  if (!u.exploration) return false; // íƒí—˜ ì •ë³´ ì—†ìœ¼ë©´ ì•ˆ ë°”ì¨
  if (u.exploration.uid === uid) return true; // íƒí—˜ ê°„ ë†ˆì„
  return false;
}

function getExploringPokemon(u) {
  if (!u.exploration) return null;
  return findUserPokemonByUid(u, u.exploration.uid);
}
// -------------------- ëœë¤ ë©˜íŠ¸ ì„¸íŠ¸ --------------------
function pick(arr) {
  return arr[Math.floor(Math.random() * arr.length)];
}
// í•„ë“œ íƒìƒ‰/ì¡°ìš° ë©˜íŠ¸
var FIELD_SEARCH_LINES = ["ì£¼ë³€ì„ ë‘ë¦¬ë²ˆê±°ë ¸ì–´ìš”.", "í’€ìˆ²ì„ í—¤ì§‘ê³  ë“¤ì–´ê°”ì–´ìš”.", "ë°œì†Œë¦¬ë¥¼ ì£½ì´ê³  ì‚´ê¸ˆì‚´ê¸ˆ ë‹¤ê°€ê°”ì–´ìš”.", "ë­”ê°€ ìˆ˜ìƒí•œ ê¸°ìš´ì´ ëŠê»´ì ¸ìš”â€¦", "ì´ë²ˆì—” ë­”ê°€ ë‚˜ì˜¬ ê²ƒ ê°™ì€ë°ìš”?"];
var FIELD_ENCOUNTER_LINES = ["ì™€! ê°‘ìê¸° íŠ€ì–´ë‚˜ì™”ì–´ìš”!", "ëˆˆì´ ë§ˆì£¼ì³¤ì–´ìš”â€¦!", "ê¸°ì²™ì„ ëŠë¼ê³  ë‚˜íƒ€ë‚¬ì–´ìš”!", "ì‚¬ë‚©ê²Œ ìš¸ë¶€ì§–ìœ¼ë©° ë‹¤ê°€ì™€ìš”!", "ê°€ë§Œíˆ ìˆë‹¤ê°€ ìŠ¬ì© ëª¨ìŠµì„ ë“œëŸ¬ëƒˆì–´ìš”!"];
// í¬íš ì„±ê³µ/ì‹¤íŒ¨ ë“œë¦½
var CATCH_SUCCESS_LINES = ["ë”¸ê¹! ì™„ë²½í–ˆì–´ìš”.", "ì˜¤ì¼€ì´! ì†ë§› ì œëŒ€ë¡œë„¤ìš”.", "ë“¤ì–´ê°”ë‹¤! ì¡ì•˜ë‹¤!", "ê¹”ë”í•˜ê²Œ í¬íš ì„±ê³µ!", "ì˜¤ëŠ˜ ìš´ ì¢‹ì€ë°ìš”?"];
var CATCH_FAIL_LINES = ["ì•—! íŠ€ì–´ë‚˜ì™”ì–´ìš”â€¦", "ì•„ê¹ë‹¤â€¦ ì†ëì—ì„œ ë¹ ì ¸ë‚˜ê°”ì–´ìš”.", "ë°©ê¸ˆ ì¡ì€ ì¤„ ì•Œì•˜ëŠ”ë°!", "êµ¬ë¥´ë‹¤ê°€ íˆ­! íƒˆì¶œí–ˆì–´ìš”.", "ì´ê±´â€¦ ì¢€ ì–µìš¸í•œë°ìš”?"];
var CATCH_TRY_AGAIN_LINES = ["ë‹¤ì‹œ í•œ ë²ˆë§Œ ë”!", "ì´ë²ˆì—” ì§„ì§œ ì¡ì•„ë³´ì.", "ë³¼ë§Œ ë” ìˆìœ¼ë©´ ëœë‹¤â€¦", "ë‹¤ìŒì—” ë” ê°•í•œ ë³¼ë¡œ ê°€ì.", "ì¹¨ì°©â€¦ ì¹¨ì°©â€¦"];
// ë°°í‹€ ìš”ì•½ í•´ì„¤ ë©˜íŠ¸
var BATTLE_COMMENT_WIN = ["ì˜¤ëŠ˜ ì»¨ë””ì…˜ ë¯¸ì³¤ë‹¤!", "ì™„ë²½í•œ ìš´ì˜ì´ì—ˆì–´ìš”.", "ìƒì„±/ê°•í™”/ê° ëª¨ë‘ ì¢‹ì•˜ë„¤ìš”.", "ìƒëŒ€ê°€ ë‹¹í™©í–ˆì„ ë“¯!", "ì´ ë§›ì— ë°°í‹€í•˜ì£ ."];
var BATTLE_COMMENT_LOSE = ["ì•„â€¦ ë‹¤ìŒì—” ë³µìˆ˜ì „ ê°‘ì‹œë‹¤.", "ìƒëŒ€ê°€ í•œ ìˆ˜ ìœ„ì˜€ì–´ìš”.", "ìš´ì´ ì‚´ì§ ì•ˆ ë”°ë¼ì¤¬ë„¤ìš”.", "ê´œì°®ì•„ìš”. ê²½í—˜ì¹˜ê°€ ìŒ“ì˜€ì–´ìš”.", "ë‹¤ìŒ íŒì—” ë’¤ì§‘ëŠ”ë‹¤."];
var BATTLE_COMMENT_DRAW = ["íŒ½íŒ½í–ˆë‹¤â€¦ ì§„ì§œ íŒ½íŒ½!", "ë‘˜ ë‹¤ í•œ ë— ì°¨ì´ì˜€ì–´ìš”.", "ìŠ¹ë¶€ê°€ ì•ˆ ë‚˜ë„¤â€¦ ë‹¤ì‹œ?", "ë¬´ìŠ¹ë¶€ë„ ë‚˜ì˜ì§€ ì•Šì£ .", "ì„œë¡œ ì¸ì •!"];
// ë¬´ìŠ¹ë¶€ streak ë¦¬ì…‹ ë¬¸êµ¬ (ë„¤ ì •ì±… ì“¸ ë•Œ)
var STREAK_RESET_DRAW_LINES = ["ë¬´ìŠ¹ë¶€ë¼ ì—°ìŠ¹ì€ ì—¬ê¸°ì„œ ì ê¹ ë©ˆì·„ì–´ìš”.", "ìŠ¹ë¶€ê°€ ì•ˆ ë‚¬ìœ¼ë‹ˆ ì—°ìŠ¹ì€ ë¦¬ì…‹!", "ë¬´ìŠ¹ë¶€! ì—°ìŠ¹ ê¸°ë¡ì€ ì ì‹œ ë³´ë¥˜!", "íŒ½íŒ½í–ˆì§€ë§Œâ€¦ ì—°ìŠ¹ì€ ì´ˆê¸°í™”!"];
function blockTitle(t) {
  return "ã€" + t + "ã€‘\n";
}
function joinLines(arr) {
  var out = "";
  for (var i = 0; i < arr.length; i++) 
    out += arr[i] + "\n";
  return out;
}
var EMPHASIS_RARE5 = ["âœ¨ í¬ê·€í•œ ê¸°ìš´ì´ ëŠê»´ì§‘ë‹ˆë‹¤â€¦", "âœ¨ ê³µê¸°ê°€ ë‹¬ë¼ì¡Œì–´ìš”â€¦ ë­”ê°€ ì˜¨ë‹¤!", "âœ¨ ë“±ê³¨ì´ ì„œëŠ˜í•´ì¡ŒìŠµë‹ˆë‹¤â€¦", "âœ¨ ì´ê±´â€¦ ì§„ì§œë‹¤."];
var EMPHASIS_LEGENDARY = ["ğŸ”¥ ì „ì„¤ê¸‰ í¬ì¼“ëª¬ ì¶œí˜„!", "ğŸ”¥ ë¶„ìœ„ê¸° ë¬´ì—‡â€¦ ì „ì„¤ ê°ì¸ë°ìš”?", "ğŸ”¥ ì´ê±´ ì¡ì•„ì•¼ í•©ë‹ˆë‹¤. ë¬´ì¡°ê±´.", "ğŸ”¥ ì‹¬ì¥ì´ ë›´ë‹¤â€¦ ì „ì„¤ì´ë‹¤!"];
var CATCH_FAIL_DRIP_LINES = ["ğŸ’¥ ì•„â€¦ ë°©ê¸ˆ ê·¸ê±° ì¡ì„ ë»”í–ˆëŠ”ë°!", "ğŸ˜µâ€ğŸ’« ì†ì´ ë¯¸ë„ëŸ¬ì¡Œì–´ìš”â€¦ ë‹¤ì‹œ!", "ğŸ˜¤ ì•„ë‹ˆ ì´ê²Œ ì™œ ì•ˆ ì¡í˜€â€¦?", "ğŸ¥² ë³¼ì´ ë°°ì‹ í–ˆì–´ìš”â€¦", "ğŸ«  ì§„ì§œ ë”± í•œ ë²ˆë§Œ ë”â€¦"];
var CATCH_FAIL_TIP_LINES = ["íŒíŠ¸: ë” ì¢‹ì€ ë³¼ì´ë©´ í™•ë¥ ì´ ì˜¬ë¼ê°€ìš”.", "íŒíŠ¸: íŠ¸ë ˆì´ë„ˆ ë ˆë²¨ì´ ì˜¤ë¥´ë©´ í¬íš ë³´ë„ˆìŠ¤ë„ ì˜¬ë¼ê°€ìš”.", "íŒíŠ¸: ìŠˆí¼ë³¼/í•˜ì´í¼ë³¼ë¡œ ì••ë°•í•´ë´…ì‹œë‹¤.", "íŒíŠ¸: ìš´ë„ ì‹¤ë ¥ì…ë‹ˆë‹¤â€¦(ì•„ë§ˆë„)"];
var COOLDOWN_LINES = ["ì•„ì§ ìˆ¨ ì¢€ ëŒë¦¬ëŠ” ì¤‘ì´ì—ìš”. ì ì‹œë§Œìš”!", "ì ê¹ë§Œ! ì¬ì •ë¹„í•˜ê³  ë‹¤ì‹œ ê°€ìš”.", "ì¡°ê¸ˆë§Œ ê¸°ë‹¤ë¦¬ë©´ ë°”ë¡œ ë‹¤ì‹œ í•  ìˆ˜ ìˆì–´ìš”."];
function enhLabel(enh) {
  // 0ì´ë©´ í‘œê¸° ì•ˆ í•¨ (ë‚´í¬ì¼“ëª¬/ë°°í‹€ í‘œê¸°ìš©)
  return (enh > 0) ? (enh + "ê°•") : "";
}
function enhLabelAlways(enh) {
  // 0ë„ í‘œê¸° (ê°•í™” ê²°ê³¼ â€œ0ê°• â†’ 1ê°•â€ ê°™ì€ í‘œê¸°ìš©)
  return (enh + "ê°•");
}
function ensureUserDex(u) {
  if (!u.dex) 
    u.dex = {};
  for (var k in u.dex) {
    if (u.dex.hasOwnProperty(k)) {
      if (typeof u.dex[k] === "number") {
        u.dex[k] = {
  seen: 0, 
  caught: u.dex[k]};
      }
    }
  }
  // ë§ˆì´ê·¸ë ˆì´ì…˜: í˜„ì¬ ë³´ìœ  í¬ì¼“ëª¬ì€ ìµœì†Œ caught 1ë¡œ ë‚¨ê²¨ì¤Œ
  if (u.pokemons && u.pokemons.length > 0) {
    for (var i = 0; i < u.pokemons.length; i++) {
      var p = u.pokemons[i];
      if (!p || p.pid == null) 
        continue;
      var pid = String(p.pid);
      if (!u.dex[pid]) 
        u.dex[pid] = {
  seen: 0, 
  caught: 0};
      if (u.dex[pid].caught < 1) 
        u.dex[pid].caught = 1;
    }
  }
}
function dexSeen(u, pid) {
  ensureUserDex(u);
  pid = String(pid);
  if (!u.dex[pid]) 
    u.dex[pid] = {
  seen: 0, 
  caught: 0};
  u.dex[pid].seen += 1;
}
function dexCaught(u, pid, grade) {
  ensureUserDex(u);
  pid = String(pid);
  if (!u.dex[pid]) {
    u.dex[pid] = { seen: 0, caught: 0, maxGrade: "D" };
  }
  u.dex[pid].caught += 1;
  
  // í˜„ì¬ ì¡ì€ ë“±ê¸‰ì´ ê¸°ì¡´ ìµœê³  ë“±ê¸‰ë³´ë‹¤ ë†’ìœ¼ë©´ ê°±ì‹ 
  var curMax = u.dex[pid].maxGrade || "D";
  if (GRADE_ORDER[grade] > GRADE_ORDER[curMax]) {
    u.dex[pid].maxGrade = grade;
  }
}
// [ìµœì¢… ìˆ˜ì •] UID ìƒì„±ê¸° (ì¹´ìš´í„° ë°©ì‹ íê¸° -> MAX ê²€ìƒ‰ ë°©ì‹ ì ìš©)
// ì´ì œ í¬íšì´ë“  êµí™˜ì´ë“  ë¬´ì¡°ê±´ ì´ í•¨ìˆ˜ë¥¼ ì“°ë©´ ì¤‘ë³µì´ ì ˆëŒ€ ì•ˆ ìƒê¹ë‹ˆë‹¤.
function nextPokemonUid(u) {
  if (!u.pokemons) u.pokemons = [];
  
  var max = 0;
  for (var i = 0; i < u.pokemons.length; i++) {
    // ì•ˆì „í•˜ê²Œ ìˆ«ìë¡œ ë³€í™˜í•´ì„œ ë¹„êµ
    var p = u.pokemons[i];
    if (p && p.uid) {
        var uid = parseInt(p.uid, 10);
        if (!isNaN(uid) && uid > max) {
          max = uid;
        }
    }
  }
  
  // ë¬´ì¡°ê±´ (ê°€ì¥ í° ë²ˆí˜¸ + 1) ë¦¬í„´
  var newUid = max + 1;
  
  // ì¹´ìš´í„° ë³€ìˆ˜ë„ í˜¹ì‹œ ëª¨ë¥´ë‹ˆ ê°±ì‹ í•´ë‘  (í•˜ìœ„ í˜¸í™˜ì„±)
  u.nextPokeUid = newUid + 1; 
  
  return newUid;
}
function expNeed(lv) {
  var L = Math.max(1, Math.min(MAX_LV, lv));
  var x = L - 1;
  return 90 + 18 * x + 5 * x * x;
}
function onLevelUpReward(u) {
  u.ball += 2;
  u.gold += 180;
  if (u.trainerLv % 10 === 0 && u.trainerLv < 99) {
    u.superBall += 5;
    u.ultraBall += 2;
  }
  if (u.trainerLv === 99) {
    u.superBall += 10;
    u.ultraBall += 5;
  }
}
function addExpAndCheckLevelUp(u, expGained) {
  var leveled = false;
  u.trainerExp += expGained;
  while (u.trainerLv < MAX_LV && u.trainerExp >= expNeed(u.trainerLv)) {
    u.trainerExp -= expNeed(u.trainerLv);
    u.trainerLv += 1;
    leveled = true;
    onLevelUpReward(u);
  }
  return leveled;
}
// -------------------- ë ˆë²¨ì—… ë©”ì‹œì§€(ë³´ìƒ í¬í•¨) --------------------
function addExpWithLevelUpMsg(u, expGained) {
  var beforeLv = u.trainerLv;
  var bGold = u.gold;
  var bBall = u.ball;
  var bSuper = u.superBall;
  var bUltra = u.ultraBall;
  var leveled = addExpAndCheckLevelUp(u, expGained);
  if (!leveled) 
    return "";
  var gGold = u.gold - bGold;
  var gBall = u.ball - bBall;
  var gSuper = u.superBall - bSuper;
  var gUltra = u.ultraBall - bUltra;
  var line = "ğŸŠ ë ˆë²¨ì—…! Lv." + beforeLv + " â†’ Lv." + u.trainerLv;
  var rewards = [];
  if (gGold > 0) 
    rewards.push("+" + gGold + "ğŸ’°");
  if (gBall > 0) 
    rewards.push("+" + gBall + " ëª¬ìŠ¤í„°ë³¼");
  if (gSuper > 0) 
    rewards.push("+" + gSuper + " ìŠˆí¼ë³¼");
  if (gUltra > 0) 
    rewards.push("+" + gUltra + " í•˜ì´í¼ë³¼");
  if (rewards.length > 0) {
    line += "\nğŸ ë ˆë²¨ì—… ë³´ìƒ: " + rewards.join(" / ");
  }
  return line;
}
// -------------------- ìŠ¤í°/í¬ê·€ë„ ê°€ì¤‘ì¹˜ --------------------
// [ë°¸ëŸ°ìŠ¤ ìˆ˜ì •] í¬ê·€ë„ë³„ ì¶œí˜„ ê°€ì¤‘ì¹˜ (ê³ ë“±ê¸‰ í™•ë¥  UP!)
function raritySpawnWeight(r) {
  if (r === 1) return 1.00; // í”í•¨ (ë³€ë™ ì—†ìŒ)
  if (r === 2) return 0.95; // (ê¸°ì¡´ 0.85) -> ì†Œí­ ìƒí–¥
  if (r === 3) return 0.80; // (ê¸°ì¡´ 0.60) -> ê½¤ ìì£¼ ë‚˜ì˜´
  if (r === 4) return 0.55; // (ê¸°ì¡´ 0.30) -> ê±°ì˜ 2ë°° ìƒí–¥!
  return 0.35;              // (ê¸°ì¡´ 0.15) -> ì „ì„¤ í™•ë¥  2ë°° ì´ìƒ ìƒí–¥!
}

function enhanceCost(nextEnh) {
  nextEnh = parseInt(nextEnh, 10);
  if (isNaN(nextEnh)) 
    nextEnh = 1;
  if (nextEnh < 1) 
    nextEnh = 1;
  if (nextEnh > ENHANCE_MAX) 
    nextEnh = ENHANCE_MAX;
  return 25 + Math.floor(nextEnh * nextEnh * 2.6);
}
function rarityCostMult(rarity) {
  // í¬ê·€ë„ 1ì€ ì‹¸ê³  5ëŠ” ë§¤ìš° ë¹„ì‹¸ê²Œ
  if (rarity <= 1) 
    return 1.0;
  if (rarity === 2) 
    return 1.4;
  if (rarity === 3) 
    return 1.9;
  if (rarity === 4) 
    return 2.6;
  return 3.6;
}
// ê¸°ì¡´ enhanceCost(enh)ëŠ” "ë² ì´ìŠ¤ ë¹„ìš©"ìœ¼ë¡œ ìœ ì§€í•˜ê³ ,
// ì‹¤ì œ ì°¨ê°ì—ëŠ” ì•„ë˜ í•¨ìˆ˜ ì‚¬ìš©
function enhanceCostByRarity(enh, rarity) {
  var base = enhanceCost(enh);
  var mult = rarityCostMult(rarity || 2);
  // ê³ ê°•í™” êµ¬ê°„ ì¶”ê°€ ê°€ì¤‘ì¹˜(ì „ì„¤ ê°€ì¹˜ ìƒìŠ¹ í•µì‹¬)
  // enh 15ë¶€í„° ì„œì„œíˆ, 20ë¶€í„° í™•ì‹¤íˆ ë¹„ì‹¸ì§€ê²Œ
  var extra = 1.0;
  if (enh >= 15) 
    extra += (enh - 14) * 0.03;  // 15->1.03, 20->1.18
  if (enh >= 20) 
    extra += (enh - 19) * 0.04;  // 20->+0.04, 25->+0.24
  return Math.floor(base * mult * extra);
}

// [ìˆ˜ì •ë¨] íŒë§¤ê°€ ê³„ì‚° (ì¸í”Œë ˆ ë°©ì§€: ì ë‹¹í•œ ìƒí•œì„  ìœ ì§€)
function sellPrice(pid, enh, grade) {
  var db = findPokemonDB(pid);
  if (!db) return 1;

  var r = db.rarity || 2;
  enh = parseInt(enh, 10) || 0;
  if (enh > ENHANCE_MAX) enh = ENHANCE_MAX;

  // ê¸°ë³¸ ê°€ê²© ê³µì‹ (ê¸°ì¡´ ìœ ì§€)
  var baseByR = [0, 1000, 2500, 7000, 40000, 80000];
  var base = baseByR[r] || 2500;

  var e0 = Math.min(enh, 14);
  var lin = e0 * (40 + r * 18);
  var quad = (e0 * e0) * (6 + r * 3);

  var premium15 = 0;
  if (enh >= 15) {
    var e15 = Math.min(enh, 19) - 14; 
    premium15 = e15 * (700 + r * 450);
  }

  var premium20 = 0;
  if (enh >= 20) {
    var e20 = Math.min(enh, 24) - 19; 
    premium20 = (e20 * e20) * (6000 + r * 2500);
  }

  var premium25 = 0;
  if (enh >= 25) {
    var e25 = enh - 24; 
    premium25 = (e25 * e25 * e25) * (12000 + r * 5000);
  }

  // 5ë°° íŒ¨ì¹˜ëŠ” ìœ ì§€í•˜ë˜, ë„ˆë¬´ í­ì£¼í•˜ì§€ ì•Šê²Œ í•¨
  var price = Math.floor((base + lin + quad + premium15 + premium20 + premium25) * 5);

  // ë“±ê¸‰ ë³´ë„ˆìŠ¤
  var gradeMult = 1.0;
  if (grade === "S") gradeMult = 2.0;      
  else if (grade === "A") gradeMult = 1.6; 
  else if (grade === "B") gradeMult = 1.2; 
  else if (grade === "C") gradeMult = 1.0; 
  else gradeMult = 0.8; 
  
  price = Math.floor(price * gradeMult);

  // â˜… [ì¸í”Œë ˆ ë°©ì§€ ìº¡]
  // ë„ˆë¬´ ë†’ì§€ ì•Šê²Œ ì„¤ì •í•˜ì—¬ ê³ ê°•í™” í¬ì¼“ëª¬ì€ "ìœ ì € ê±°ë˜"ë¥¼ ìœ ë„í•¨
  var cap = (r === 5) ? 20000000  // ì „ì„¤: 2ì²œë§Œ (ì¶©ë¶„íˆ í¬ì§€ë§Œ ì¸í”Œë ˆëŠ” ì•ˆ ì˜´)
          : (r === 4) ? 15000000  // ìµœì¢…ì§„í™”: 1.5ì²œë§Œ
          : (r === 3) ? 8000000   // 3í‹°ì–´: 800ë§Œ
          : 5000000;              // ì¡ëª¹: 500ë§Œ

  if (price > cap) price = cap;

  return price;
}


function rarityCatchMod(rarity) {
  // í¬ê·€ë„ë³„ í¬íš ë‚œì´ë„ ê³„ìˆ˜ (ë‚®ì„ìˆ˜ë¡ ì–´ë ¤ì›€)
  // ì²´ê° ì°¨ì´ í¬ê²Œ ì„¤ê³„
  if (rarity <= 1) 
    return 1.40;
  if (rarity === 2) 
    return 1.15;
  if (rarity === 3) 
    return 0.85;
  if (rarity === 4) 
    return 0.55;
  return 0.32;
}
function trainerCatchBonus(lv) {
  lv = Math.max(1, Math.min(99, lv || 1));
  // 1ë ˆë²¨ 0% â†’ 50ë ˆë²¨ ì•½ +18% â†’ 99ë ˆë²¨ +30%
  return 0.30 * Math.sqrt((lv - 1) / 98);
}
// [ë³´ìƒ ìƒí–¥] ê³¨ë“œ 8~15ë°° ì¦ê°€ ë²„ì „
// [ìµœì¢… ì—ëŸ¬ í•´ê²°] ìº¡ ë³€ìˆ˜ ì—†ì´ ê³¨ë“œ ë¬´ì œí•œ ë°˜í™˜
function calcExploreGold(u) {
  // 1. ë² ì´ìŠ¤ ê³¨ë“œ (1,000 ~ 5,000 ëœë¤)
  var base = Math.floor(Math.random() * (EXPLORE_GOLD_MAX - EXPLORE_GOLD_MIN + 1) + EXPLORE_GOLD_MIN);
  
  // 2. íŠ¸ë ˆì´ë„ˆ ë ˆë²¨ ë³´ë„ˆìŠ¤
  var lv = Math.max(1, u.trainerLv || 1);
  var mult = 1 + (lv * EXPLORE_LV_RATE);
  
  // 3. ìµœì¢… ê³¨ë“œ í•©ì‚°
  var gold = Math.floor(base * mult);
  
  // â˜… ìº¡(Math.min) ë¡œì§ì„ ì•„ì˜ˆ ì§€ì› ìŠµë‹ˆë‹¤. ê³„ì‚°ëœ ìˆ«ìë¥¼ ê·¸ëŒ€ë¡œ ì´ì¤ë‹ˆë‹¤!
  return gold; 
}

// [ë³´ìƒ ìƒí–¥] ê²½í—˜ì¹˜ 3ë°° ê³ ì • ë²„ì „
function calcExploreExp() {
  var base = Math.floor(Math.random() * (EXPLORE_EXP_MAX - EXPLORE_EXP_MIN + 1) + EXPLORE_EXP_MIN);
  
  // â˜… ì‚¬ì¥ë‹˜ ì§€ì‹œ: ë¬´ì¡°ê±´ 3ë°°!
  return base * 3;
}

function clampInt(n, a, b) {
  n = Math.floor(n);
  return Math.max(a, Math.min(b, n));
}

function calcCatchGold(u, db, ballType) {
  var base = Math.floor(rnd(CATCH_GOLD_MIN, CATCH_GOLD_MAX + 1));
  var lv = Math.max(1, u.trainerLv || 1);
  var lvMult = 1 + (lv * 0.012);  // ë ˆë²¨ 50ì´ë©´ ì•½ +60%
  var rarity = (db && db.rarity) ? db.rarity : 2;
  var rarityMult = 1 + (rarity - 1) * 0.22;  // rarity 5ë©´ +88%
  var ballMult = (ballType === 2) ? 1.18 : (ballType === 1) ? 1.10 : 1.00;
  var gold = Math.floor(base * lvMult * rarityMult * ballMult);
  return clampInt(gold, 1, CATCH_GOLD_CAP);
}
function calcCatchExp(u, db, ballType) {
  var base = Math.floor(rnd(CATCH_EXP_MIN, CATCH_EXP_MAX + 1));
  var lv = Math.max(1, u.trainerLv || 1);
  var lvMult = 1 + (lv * 0.006);  // ê³¨ë“œë³´ë‹¨ ì™„ë§Œ
  var rarity = (db && db.rarity) ? db.rarity : 2;
  var rarityMult = 1 + (rarity - 1) * 0.16;
  var ballMult = (ballType === 2) ? 1.12 : (ballType === 1) ? 1.06 : 1.00;
  var exp = Math.floor(base * lvMult * rarityMult * ballMult);
  return clampInt(exp, 1, CATCH_EXP_CAP);
}
// -------------------- í¬íš ë‚œì´ë„ ê°œë³„ ë³´ì • --------------------
var CATCH_TIER_OVERRIDES = {
  131: 3.5, 
  143: 3.5, 
  144: 4.6, 
  145: 4.6, 
  146: 4.6, 
  150: 4.85, 
  151: 4.75, 
  133: 4.2, 
  134: 4.4, 
  135: 4.4, 
  136: 4.4};
// -------------------- ì§€ì—­/ìŠ¤í° í’€ --------------------
var REGIONS = [{
  key: "ì´ˆì›", 
  types: ["ë…¸ë§", "í’€", "ë²Œë ˆ", "ë¹„í–‰", "ë…"]}, {
  key: "í˜¸ìˆ˜", 
  types: ["ë¬¼", "ì–¼ìŒ"]}, {
  key: "ë™êµ´", 
  types: ["ë°”ìœ„", "ë•…", "ê³ ìŠ¤íŠ¸", "ë…"]}, {
  key: "ë°œì „ì†Œ", 
  types: ["ì „ê¸°", "ê°•ì² "]}, {
  key: "ìœ ì ", 
  types: ["ì—ìŠ¤í¼", "ê³ ìŠ¤íŠ¸", "ë“œë˜ê³¤"]}, {
  key: "ê²©íˆ¬ì¥", 
  types: ["ê²©íˆ¬"]}, {
  key: "ìš”ì •ìˆ²", 
  types: ["í˜ì–´ë¦¬", "í’€"]}, {
  key: "í™”ì‚°", 
  types: ["ë¶ˆ", "ë°”ìœ„", "ë•…"]}, {
  key: "ë°”ë‹¤", 
  types: ["ë¬¼", "ë¬¼", "ë¹„í–‰"]}, {
  key: "ì„¤ì‚°", 
  types: ["ì–¼ìŒ", "ì–¼ìŒ", "ë°”ìœ„"]}, {
  key: "í­í’í‰ì›", 
  types: ["ì „ê¸°", "ë¹„í–‰"]}, {
  key: "ì–´ë‘ ì˜ìˆ²", 
  types: ["ì•…", "ê³ ìŠ¤íŠ¸", "ë…"]}, {
  key: "ì‚¬ë§‰", 
  types: ["ë•…", "ë°”ìœ„", "ë…"]}, {
  key: "ì—°êµ¬ì†Œ", 
  types: ["ì—ìŠ¤í¼", "ê°•ì² ", "ë…¸ë§"]}, {
  key: "ìš©ì˜ë‘¥ì§€", 
  types: ["ë“œë˜ê³¤", "ë“œë˜ê³¤", "ë¶ˆ"]},
{ key: "ëƒ¥ì¹˜ì˜ ë°©", types: [] }
];
var REGION_ROTATE_MS = 60 * 60 * 1000;// (ì›í•˜ë©´ ë‚¨ê²¨ë„ ë˜ê³  ì•ˆ ì¨ë„ ë¨)
var SPAWN_EXPIRE_MS = 60 * 1000;
function getRoomRegion(d, room) {
  // ë°©/ì‹œê°„ ê³ ì • ì—†ì´ ë§¤ í˜¸ì¶œ ëœë¤
  return randomPick(REGIONS).key;
}
function regionTypes(regionKey) {
  for (var i = 0; i < REGIONS.length; i++) {
    if (REGIONS[i].key === regionKey) 
      return REGIONS[i].types;
  }
  return ["ë…¸ë§", "í’€", "ë²Œë ˆ", "ë¹„í–‰"];
}
// PRE_MAPì€ ì•„ë˜ì—ì„œ ìƒì„±
var PRE_MAP = null;
function isBaseStagePokemonId(pid) {
  if (!PRE_MAP) 
    return true;
  return !PRE_MAP[pid];
}
function spawnPokemonForRegion(regionKey) {
  var allowedTypes = regionTypes(regionKey);
  var pool = [];
  for (var i = 0; i < POKEMON_DB.length; i++) {
    var p = POKEMON_DB[i];
    if (!p) 
      continue;
    if (!isBaseStagePokemonId(p.id)) 
      continue;
    var ok = false;
    if (allowedTypes.indexOf(p.type1) !== -1) 
      ok = true;
    else if (p.type2 && allowedTypes.indexOf(p.type2) !== -1) 
      ok = true;
    if (ok) 
      pool.push(p);
  }
  if (pool.length === 0) {
    var fb = [];
    for (var j = 0; j < POKEMON_DB.length; j++) {
      var pp = POKEMON_DB[j];
      if (!pp) 
        continue;
      if (isBaseStagePokemonId(pp.id)) 
        fb.push(pp);
    }
    return randomPick(fb);
  }
  var filtered = [];
  for (var k = 0; k < pool.length; k++) {
    var c = pool[k];
    var w = raritySpawnWeight(c.rarity || 2);
    if (Math.random() < w) {
      filtered.push(c);
    }
  }
  // ì „ë¶€ íƒˆë½í–ˆìœ¼ë©´ ì›ë˜ í’€ ì‚¬ìš©
  if (filtered.length === 0) 
    filtered = pool;
  var sum = 0;
  var weights = [];
  for (var m = 0; m < filtered.length; m++) {
    var rarity = filtered[m].rarity || 2;
    var ww = 1 / Math.pow(rarity, 1.2);
    weights.push(ww);
    sum += ww;
  }
  var r = Math.random() * sum;
  for (var n = 0; n < filtered.length; n++) {
    r -= weights[n];
    if (r <= 0) 
      return filtered[n];
  }
  return filtered[filtered.length - 1];
}
// -------------------- ì•¼ìƒ ìŠ¤í° ì €ì¥ --------------------
function getWild(d, room) {
  var w = d.lastSpawnByRoom[room];
  if (!w) 
    return null;
  if (nowMs() > (w.expiresAt || 0)) {
    // ë§Œë£Œ â†’ ë°”ë¡œ ì§€ìš°ì§€ ì•Šê³  expired í”Œë˜ê·¸ë§Œ ë‚¨ê¹€
    d.lastSpawnByRoom[room] = {
  expired: true, 
  pid: w.pid};
    return null;
  }
  return w;
}
// ë§Œë£Œëœ ì•¼ìƒ í¬ì¼“ëª¬ì„ "1íšŒì„±"ìœ¼ë¡œ êº¼ë‚´ê¸°
function takeExpiredWild(d, room) {
  var w = d.lastSpawnByRoom[room];
  if (w && w.expired) {
    delete d.lastSpawnByRoom[room];
    return w;
  }
  return null;
}
function setWild(d, room, pid, isShiny) {
  d.lastSpawnByRoom[room] = {
    pid: pid,
    at: nowMs(),
    expiresAt: nowMs() + SPAWN_EXPIRE_MS,
    attempts: 0,
    maxAttempts: getMaxCatchAttempts(pid),
    isShiny: !!isShiny // â˜… ì´ë¡œì¹˜ ì—¬ë¶€ ì €ì¥
  };
}

function clearWild(d, room) {
  delete d.lastSpawnByRoom[room];
}
// -------------------- ë³¼/í¬íš í™•ë¥  --------------------
function ballCatchRate(ballType) {
  if (ballType === 0) 
    return 0.75;
  if (ballType === 1) 
    return 1.15;
  return 1.45;
}
// í¬ê·€ë„ì— ë”°ë¥¸ í¬íš íŒ¨ë„í‹°
function rarityCatchPenalty(r) {
  if (r <= 1) 
    return 1.0;
  if (r === 2) 
    return 0.9;
  if (r === 3) 
    return 0.75;
  if (r === 4) 
    return 0.6;
  return 0.45;
}
function consumeBall(u, ballType) {
  if (ballType === 0) { if (u.ball <= 0) return false; u.ball--; return true; }
  if (ballType === 1) { if (u.superBall <= 0) return false; u.superBall--; return true; }
  if (ballType === 2) { if (u.ultraBall <= 0) return false; u.ultraBall--; return true; }
  
  // â˜… í‚¹ê°“ë„ë¶€ë³¼ ì†Œëª¨ ë¡œì§ (godBall í•„ë“œ)
  if (ballType === 3) { 
    if (!u.godBall || u.godBall <= 0) return false; 
    u.godBall--; 
    return true; 
  }
  return false;
}

function getMaxCatchAttempts(pid) {
  var db = findPokemonDB(pid);
  var r = db ? (db.rarity || 2) : 2;
  var min = 1;
  var max = 8;
  if (r <= 1) 
    min = 5;
  else if (r === 2) 
    min = 4;
  else if (r === 3) 
    min = 3;
  else if (r === 4) 
    min = 2;
  else 
    min = 1;  // r5
  return min + Math.floor(Math.random() * (max - min + 1));
}
// -------------------- í¬ê·€ë„ í¬íš ë°°ìœ¨ --------------------
function rarityCatchMul(r) {
  if (r === 1) 
    return 1.00;
  if (r === 2) 
    return 0.85;
  if (r === 3) 
    return 0.65;
  if (r === 4) 
    return 0.40;
  return 0.18;
}
// ë„íŒŒë¯¼ê°•í™”ê¶Œ
function rollDopaEnhance() {
  var r = Math.random();
  // UP 35% / KEEP 25% / RESET0 30% / EXIT 10%
  if (r < 0.35) {
    // ì„±ê³µ ì‹œ 2~10ê°• ë¶„í¬
    var x = Math.random();
    var up = 2;
    if (x < 0.25) 
      up = 2;
    else if (x < 0.45) 
      up = 3;
    else if (x < 0.60) 
      up = 4;
    else if (x < 0.72) 
      up = 5;
    else if (x < 0.82) 
      up = 6;
    else if (x < 0.90) 
      up = 7;
    else if (x < 0.95) 
      up = 8;
    else if (x < 0.98) 
      up = 9;
    else 
      up = 10;
    return {
  kind: "UP", 
  up: up};
  }
  if (r < 0.60) 
    return {
  kind: "KEEP"};
  if (r < 0.90) 
    return {
  kind: "RESET0"};
  return {
  kind: "EXIT"};
}
// [ìˆ˜ì •ë¨] ìƒì  ëª©ë¡ (í‹°ì–´ë¦¬ì…‹ê¶Œ ì‚­ì œ)
function shopText(d, u, sender) {
  return (
    "ğŸ‘¤ " + sender + "ë‹˜ í˜„ì¬ ì”ì—¬ ê³¨ë“œëŠ” " + fmtNum(u.gold) + "ğŸ’° ì…ë‹ˆë‹¤\n\n" +
    "ğŸª [ìƒì  ë¬¼í’ˆ ëª©ë¡]\n" +
    "1. ëª¬ìŠ¤í„°ë³¼ : " + fmtNum(getShopPrice(d, "BALL")) + "ğŸ’°\n" +
    "2. ìŠˆí¼ë³¼ : " + fmtNum(getShopPrice(d, "SUPER")) + "ğŸ’° (3ë°°â†‘)\n" +
    "3. í•˜ì´í¼ë³¼ : " + fmtNum(getShopPrice(d, "ULTRA")) + "ğŸ’° (5ë°°â†‘)\n" +
    "4. ë„íŒŒë¯¼ê°•í™”ê¶Œ : " + fmtNum(getShopPrice(d, "DOPA")) + "ğŸ’°\n" +
    "5. ë‘ì«€ì¿ (í™•ì •ê°•í™”) : " + fmtNum(SHOP_PRICE_COOKIE) + "ğŸ’°\n" +
    "6. ì´ë™í‹°ì¼“ : " + fmtNum(SHOP_PRICE_TICKET) + "ğŸ’°\n" +
    "7. ìŠˆí¼ìš¸íŠ¸ë¼í‚¹ê°“ì— í˜ëŸ¬ê°œì©ŒëŠ”í•˜ì´í¼ì±Œë¦°ì €í˜ì´ì»¤í‰ë²”í•œìš©íƒœëŠ”ë¯¸ì¹œì‚¬ëŒê°“ë¯¼ìˆ˜ë„ë¶€ë³¼ : " + fmtNum(SHOP_PRICE_GOD) + "ğŸ’°\n\n" +
    "ğŸ›’ [êµ¬ë§¤ ë°©ë²•]\n" +
    "/êµ¬ë§¤ ëª¬ìŠ¤í„°ë³¼ 10\n" +
    "/êµ¬ë§¤ ìŠˆí¼ìš¸íŠ¸ë¼í‚¹ê°“ì— í˜ëŸ¬ê°œì©ŒëŠ”í•˜ì´í¼ì±Œë¦°ì €í˜ì´ì»¤í‰ë²”í•œìš©íƒœëŠ”ë¯¸ì¹œì‚¬ëŒê°“ë¯¼ìˆ˜ë„ë¶€ë³¼ 1"
  );
}


// [ìˆ˜ì •ë¨] ì•„ì´í…œ êµ¬ë§¤ í•¨ìˆ˜ (í‹°ì–´ë¦¬ì…‹ê¶Œ íŒë§¤ ì¤‘ë‹¨ ì ìš©)
function buyItem(d, u, sender, itemName, qty, replier) {
  qty = parseInt(qty, 10);
  if (isNaN(qty)) qty = 1;
  qty = Math.max(1, Math.min(999, qty));
  
  var cost = 0;
  var field = "";
  var label = "";
  
  if (itemName === "ëª¬ìŠ¤í„°ë³¼") { cost = getShopPrice(d, "BALL"); field = "ball"; label = "ëª¬ìŠ¤í„°ë³¼"; }
  else if (itemName === "ìŠˆí¼ë³¼") { cost = getShopPrice(d, "SUPER"); field = "superBall"; label = "ìŠˆí¼ë³¼"; }
  else if (itemName === "í•˜ì´í¼ë³¼") { cost = getShopPrice(d, "ULTRA"); field = "ultraBall"; label = "í•˜ì´í¼ë³¼"; }
  else if (itemName === "ë„íŒŒë¯¼" || itemName === "ë„íŒŒë¯¼ê°•í™”ê¶Œ") { cost = getShopPrice(d, "DOPA"); field = "dopaTicket"; label = "ë„íŒŒë¯¼ê°•í™”ê¶Œ"; }
  else if (itemName === "ë‘ì«€ì¿ " || itemName === "ì¿ í‚¤") { cost = SHOP_PRICE_COOKIE; field = "cookie"; label = "ë‘ì«€ì¿ "; }
  else if (itemName === "ì´ë™í‹°ì¼“" || itemName === "í‹°ì¼“") { cost = SHOP_PRICE_TICKET; field = "ticket"; label = "ì´ë™í‹°ì¼“"; }
  
  // â˜… [ìˆ˜ì •] í‹°ì–´ë¦¬ì…‹ê¶Œ êµ¬ë§¤ ì‹œë„ ì‹œ 'íŒë§¤ ì¢…ë£Œ' ë©”ì‹œì§€ ì¶œë ¥ í›„ ë°”ë¡œ ë¦¬í„´(ì°¨ë‹¨)
  else if (itemName === "í‹°ì–´ë¦¬ì…‹" || itemName === "í‹°ì–´" || itemName === "ë¦¬ì…‹") { 
    return { ok: false, reason: "ğŸš« [êµ¬ë§¤ ë¶ˆê°€] í‹°ì–´ë¦¬ì…‹ê¶Œì€ ë” ì´ìƒ ìƒì ì—ì„œ íŒë§¤í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\nğŸ§­ ì˜¤ì§ '/íƒí—˜'ì„ í†µí•´ì„œë§Œ íšë“í•  ìˆ˜ ìˆëŠ” í¬ê·€ ì•„ì´í…œì…ë‹ˆë‹¤!" }; 
  }
  
  // â˜… í‚¹ê°“ë³¼ í’€ë„¤ì„ ì²´í¬
  else if (itemName === "ìŠˆí¼ìš¸íŠ¸ë¼í‚¹ê°“ì— í˜ëŸ¬ê°œì©ŒëŠ”í•˜ì´í¼ì±Œë¦°ì €í˜ì´ì»¤í‰ë²”í•œìš©íƒœëŠ”ë¯¸ì¹œì‚¬ëŒê°“ë¯¼ìˆ˜ë„ë¶€ë³¼") { 
    cost = SHOP_PRICE_GOD;
    field = "godBall"; 
    label = "ìŠˆí¼ìš¸íŠ¸ë¼í‚¹ê°“ì— í˜ëŸ¬ê°œì©ŒëŠ”í•˜ì´í¼ì±Œë¦°ì €í˜ì´ì»¤í‰ë²”í•œìš©íƒœëŠ”ë¯¸ì¹œì‚¬ëŒê°“ë¯¼ìˆ˜ë„ë¶€ë³¼"; 
  }
  else {
    return { ok: false, reason: "ğŸš« ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì•„ì´í…œì…ë‹ˆë‹¤." };
  }

  // ëˆ ìˆëŠ”ì§€ í™•ì¸
  if (u.gold < cost * qty) {
    return { ok: false, reason: sender + "ë‹˜, ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.\ní•„ìš”: " + fmtNum(cost * qty) + "ğŸ’°" };
  }

  // ì¬í™” ì°¨ê°
  u.gold -= cost * qty;
  if (!u.stats.totalSpentShop) u.stats.totalSpentShop = 0;
  u.stats.totalSpentShop += (cost * qty);

  // â˜… [í•µì‹¬] ìƒì ì—ì„œ êµ¬ë§¤í–ˆì„ ë•Œë§Œ ëˆ„ì  êµ¬ë§¤ íšŸìˆ˜(ì¹­í˜¸ìš©) ì¥ë¶€ ê¸°ë¡
  if (field === "godBall") {
    if (typeof u.stats.totalGodBallBought !== "number") u.stats.totalGodBallBought = 0;
    u.stats.totalGodBallBought += qty;
  }

  // ì•„ì´í…œ ê°€ë°© ì§€ê¸‰
  if (typeof u[field] !== "number") u[field] = 0; 
  u[field] += qty;
  
  commitSave(true);
  checkAndNotifyTitles(u, replier); 
  
  return { ok: true, msg: "ğŸ›’ " + label + " " + qty + "ê°œ êµ¬ë§¤ ì™„ë£Œ!\nğŸ’° ì”ì—¬ ê³¨ë“œ: " + fmtNum(u.gold) + "ğŸ’°" };
}

// -------------------- ì „ì /ë­í¬ --------------------
function battleScoreRank(u) {
  ensureUserStats(u);
  var w = u.stats.battleWin;
  var l = u.stats.battleLose;
  var d0 = u.stats.battleDraw;
  var total = w + l + d0;
  var base = (w * 3) + (d0 * 1);
  var streakBonus = Math.min(30, u.stats.battleStreak * 2);
  var playPenalty = (total < 3) ? (3 - total) * 2 : 0;
  return base + streakBonus - playPenalty;
}
function formatRecord(u) {
  ensureUserStats(u);
  var w = u.stats.battleWin, l = u.stats.battleLose, d0 = u.stats.battleDraw;
  var total = w + l + d0;
  var rate = (total === 0) ? 0 : Math.floor((w / total) * 1000) / 10;
  return ("ì „ì : " + w + "ìŠ¹ " + l + "íŒ¨" + (d0 > 0 ? (" " + d0 + "ë¬´") : "") + "\n" + "ìŠ¹ë¥ : " + rate + "%\n" + "ì—°ìŠ¹: " + u.stats.battleStreak + "\n" + "ìµœê³  ì—°ìŠ¹: " + u.stats.bestStreak + "\n" + "ë­í‚¹ ì ìˆ˜: " + battleScoreRank(u));
}
function rankTopList(d) {
  var list = [];
  for (var name in d.users) {
    var uu = d.users[name];
    if (!uu) 
      continue;
    ensureUserStats(uu);
    var total = uu.stats.battleWin + uu.stats.battleLose + uu.stats.battleDraw;
    if (total <= 0) 
      continue;
    list.push({
  name: name, 
  score: battleScoreRank(uu), 
  w: uu.stats.battleWin, 
  l: uu.stats.battleLose, 
  s: uu.stats.battleStreak, 
  total: total});
  }
  list.sort(function(a, b) {
  if (b.score !== a.score) 
    return b.score - a.score;
  if (b.w !== a.w) 
    return b.w - a.w;
  return b.total - a.total;
});
  return list;
}
//ì „íˆ¬ë ¥ë­í‚¹
// [ìˆ˜ì •] ì „íˆ¬ë ¥ ë­í‚¹ìš© ì •ë³´ ì¶”ì¶œ (ì´ë¡œì¹˜ ì´ë¦„ ë°˜ì˜)
function getUserTopPokemonPower(user) {
  normalizeUserData(user);
  if (!user.pokemons || user.pokemons.length === 0) {
    return { power: 0, uid: 0, name: "-", enh: 0 };
  }
  var sorted = sortPokemonsByPower(user.pokemons);
  var top = sorted[0];
  
  // â˜… [ìˆ˜ì •] ì—¬ê¸°ì„œ getDisplayName ì‚¬ìš©!
  var pName = getDisplayName(top); 
  
  return {
    power: calcBattlePower(top), 
    uid: top.uid, 
    name: pName, // db.name ëŒ€ì‹  pName ì‚¬ìš©
    enh: top.enh || 0
  };
}

// [ìˆ˜ì •ë¨] ì „íˆ¬ë ¥ ë­í‚¹ (ì¡°íšŒ ì‹œ ë°ì´í„° ë³´ì • í¬í•¨)
function buildBattlePowerRanking(d, topN, sender) {
  topN = topN || 7;
  var rows = [];
  var names = Object.keys(d.users || {});
  
  // ë­í‚¹ ì‚°ì • ì¤‘ ë°ì´í„° ë³€ê²½ì´ ì¼ì–´ë‚  ìˆ˜ ìˆìŒ (ë¯¸ì ‘ì†ì ë“±ê¸‰ ë¶€ì—¬ ë“±)
  var dataChanged = false; 

  for (var i = 0; i < names.length; i++) {
    var name = names[i];
    if (!name) continue;
    var user = d.users[name];
    if (!user) continue;

    normalizeUserData(user);
    if (!user.pokemons || user.pokemons.length === 0) continue;

    // [ì¤‘ìš”] ë­í‚¹ ì§‘ê³„í•  ë•Œë„ ë“±ê¸‰ ì—†ìœ¼ë©´ ë¶€ì—¬í•´ë²„ë¦¼
    if (ensurePokemonGrades(user)) {
      dataChanged = true;
    }

    var top = getUserTopPokemonPower(user); // ì´ì œ ë“±ê¸‰ì´ ë°˜ì˜ëœ ì „íˆ¬ë ¥ì´ ë‚˜ì˜´
    rows.push({
      name: name,
      power: top.power,
      uid: top.uid,
      pName: top.name,
      enh: top.enh
    });
  }

  // ë­í‚¹ ì§‘ê³„ ì¤‘ ë°ì´í„°ê°€ ë³€í–ˆìœ¼ë©´ ì €ì¥ (ë¯¸ì ‘ì†ì ë°ì´í„° ê°±ì‹ )
  if (dataChanged) {
    saveData(d);
  }

  rows.sort(function(a, b) {
    if (b.power !== a.power) return b.power - a.power;
    if ((b.enh || 0) !== (a.enh || 0)) return (b.enh || 0) - (a.enh || 0);
    return (a.uid || 0) - (b.uid || 0);
  });

  var myIdx = -1;
  if (sender) {
    for (var k = 0; k < rows.length; k++) {
      if (rows[k].name === sender) { myIdx = k; break; }
    }
  }

  return { rows: rows, myIdx: myIdx, topN: topN };
}

// ğŸ’ [ì¥ë¹„] ì•„ì´í…œ ë°ì´í„°ë² ì´ìŠ¤
// type: atk_pct(ê³µ%), hp_flat(ì²´ë ¥+), def_pct(ë°©%), spd_flat(ì†ë„+)
//       type_boost(ì†ì„±ë€ì¦)
var EQUIP_DB = {
  // --- [í‹°ì–´ 1] ---
  "í˜ì˜ë¨¸ë¦¬ë ": { type: "atk_pct", val: 0.10, icon: "ğŸ—ï¸", desc: "ê³µê²©ë ¥ 10% ì¦ê°€" },
  "ìë­‰ì—´ë§¤":   { type: "hp_flat", val: 1000, icon: "ğŸ’", desc: "ìµœëŒ€ ì²´ë ¥ +1000" },
  "êµ¬ì• ìŠ¤ì¹´í”„": { type: "spd_flat", val: 15,   icon: "ğŸ§£", desc: "ìŠ¤í”¼ë“œ +15 (ì„ ê³µ ìœ ë¦¬)" },
  "ë°©ì–´ë³´ì„":   { type: "def_pct", val: 0.15, icon: "ğŸ’ ", desc: "ë°›ëŠ” í”¼í•´ 15% ê°ì†Œ" },

  // --- [í‹°ì–´ 2] ---
  "ë¶ˆê½ƒêµ¬ìŠ¬":   { type: "type_boost", val: 0.15, cond: "ë¶ˆ", icon: "ğŸ”¥", desc: "[ë¶ˆ] ì†ì„± ê¸°ìˆ  ìœ„ë ¥ 15% ì¦ê°€" },
  "ë¬¼ë°©ìš¸êµ¬ìŠ¬": { type: "type_boost", val: 0.15, cond: "ë¬¼", icon: "ğŸ’§", desc: "[ë¬¼] ì†ì„± ê¸°ìˆ  ìœ„ë ¥ 15% ì¦ê°€" },
  "ê¸°ì ì˜ì”¨":   { type: "type_boost", val: 0.15, cond: "í’€", icon: "ğŸŒ±", desc: "[í’€] ì†ì„± ê¸°ìˆ  ìœ„ë ¥ 15% ì¦ê°€" },
  "ìì„":       { type: "type_boost", val: 0.15, cond: "ì „ê¸°", icon: "ğŸ§²", desc: "[ì „ê¸°] ì†ì„± ê¸°ìˆ  ìœ„ë ¥ 15% ì¦ê°€" },
  "ë…¹ì§€ì•ŠëŠ”ì–¼ìŒ":{ type: "type_boost", val: 0.15, cond: "ì–¼ìŒ", icon: "ğŸ§Š", desc: "[ì–¼ìŒ] ì†ì„± ê¸°ìˆ  ìœ„ë ¥ 15% ì¦ê°€" },
  "ë¶€ë“œëŸ¬ìš´ëª¨ë˜":{ type: "type_boost", val: 0.15, cond: "ë•…", icon: "ğŸœï¸", desc: "[ë•…] ì†ì„± ê¸°ìˆ  ìœ„ë ¥ 15% ì¦ê°€" },
  "ë‚ ì¹´ë¡œìš´ë¶€ë¦¬":{ type: "type_boost", val: 0.15, cond: "ë¹„í–‰", icon: "ğŸª¶", desc: "[ë¹„í–‰] ì†ì„± ê¸°ìˆ  ìœ„ë ¥ 15% ì¦ê°€" },
  "ìš©ì˜ì´ë¹¨":   { type: "type_boost", val: 0.15, cond: "ë“œë˜ê³¤", icon: "ğŸ¦·", desc: "[ë“œë˜ê³¤] ì†ì„± ê¸°ìˆ  ìœ„ë ¥ 15% ì¦ê°€" },
  "ê²€ì€ì•ˆê²½":   { type: "type_boost", val: 0.15, cond: "ì•…", icon: "ğŸ•¶ï¸", desc: "[ì•…]/ê³ ìŠ¤íŠ¸ ë“± ìœ„ë ¥ 15% ì¦ê°€" },

  // --- [í‹°ì–´ 3: ì—”ë“œê¸‰ (ì••ë„ì  ì„±ëŠ¥)] ---
  "ê°•ë¶€ì¥ì˜êµìœ¡": { type: "atk_pct", val: 0.40, icon: "ğŸ‘º", desc: "ê³µê²©ë ¥ 40% ì¦ê°€ (íŒŒê´´ì‹ )", tier: 3 },
  // â˜… [ë³€ê²½] ì²´ë ¥ ê¹¡ìˆ˜ì¹˜ -> í¼ì„¼íŠ¸ ì¦ê°€ (í›„ë°˜ íš¨ìœ¨ ê·¹ëŒ€í™”)
  "ëˆ„ëˆ„ì˜ìš”ë¦¬":   { type: "hp_pct",  val: 0.30, icon: "ğŸ¥˜", desc: "ìµœëŒ€ ì²´ë ¥ 30% ì¦ê°€ (ë¶ˆì‚¬ì‹ )", tier: 3 },
  "ê¾¸ê¾¸ì˜íƒ„ìƒ":   { type: "spd_flat", val: 80,   icon: "ğŸ£", desc: "ìŠ¤í”¼ë“œ +80 (ì„ ê³µ í™•ì •)", tier: 3 },
  "ë¯¼ì¤€ì´ì§€ê°‘":   { type: "def_pct", val: 0.40, icon: "ğŸ’¸", desc: "ë°›ëŠ” í”¼í•´ 40% ê°ì†Œ (ì ˆëŒ€ë°©ì–´)", tier: 3 }
};


// -------------------- ìš´ì˜ì(ê´€ë¦¬ì) ì„¤ì • --------------------
var ADMIN_MAP = {
  "ì†ì‚¬ì¥": true};
function isAdmin(sender) {
  return !!ADMIN_MAP[sender];
}
function cleanName(s) {
  if (!s) 
    return "";
  s = ("" + s).trim();
  if (s.charAt(0) === "@") 
    s = s.slice(1);
  return s.trim();
}
function getUserByName(d, name) {
  name = cleanName(name);
  if (!name) 
    return null;
  if (!d.users) 
    d.users = {};
  var u = d.users[name];
  if (!u) 
    return null;
  if (typeof u.gold !== "number") 
    u.gold = 0;
  if (typeof u.trainerLv !== "number") 
    u.trainerLv = 1;
  if (typeof u.trainerExp !== "number") 
    u.trainerExp = 0;
  if (typeof u.ball !== "number") 
    u.ball = 0;
  if (typeof u.superBall !== "number") 
    u.superBall = 0;
  if (typeof u.ultraBall !== "number") 
    u.ultraBall = 0;
  if (typeof u.dopaTicket !== "number") 
    u.dopaTicket = 0;
  if (!u.pokemons) 
    u.pokemons = [];
  return {
  name: name, 
  user: u};
}
function addAdminLog(d, actor, line) {
  if (!d.adminLog) 
    d.adminLog = [];
  d.adminLog.push({
  t: nowMs(), 
  by: actor, 
  line: line});
  if (d.adminLog.length > 200) 
    d.adminLog = d.adminLog.slice(d.adminLog.length - 200);
}
// -------------------- ì „ì—­ ì„¤ì •(ëŸ°íƒ€ì„ + ì €ì¥) --------------------
function ensureConfig(d) {
  if (!d.config) 
    d.config = {};
  if (!d.config.shop) 
    d.config.shop = {};
  if (!d.config.flags) 
    d.config.flags = {};
  if (typeof d.config.shop.BALL !== "number") 
    d.config.shop.BALL = SHOP_PRICE_BALL;
  if (typeof d.config.shop.SUPER !== "number") 
    d.config.shop.SUPER = SHOP_PRICE_SUPER;
  if (typeof d.config.shop.ULTRA !== "number") 
    d.config.shop.ULTRA = SHOP_PRICE_ULTRA;
  if (typeof d.config.shop.DOPA !== "number") 
    d.config.shop.DOPA = SHOP_PRICE_DOPA;
  if (typeof d.config.flags.EVENT_ON !== "boolean") 
    d.config.flags.EVENT_ON = false;
  if (typeof d.config.flags.FIELD_ON !== "boolean") 
    d.config.flags.FIELD_ON = true;
  if (typeof d.config.flags.ENHANCE_ON !== "boolean") 
    d.config.flags.ENHANCE_ON = true;
  if (typeof d.config.flags.DOPA_ON !== "boolean") 
    d.config.flags.DOPA_ON = true;
}
function getShopPrice(d, key) {
  ensureConfig(d);
  return d.config.shop[key];
}
function setShopPrice(d, key, val) {
  ensureConfig(d);
  d.config.shop[key] = val;
}
function isFlagOn(d, key) {
  ensureConfig(d);
  return !!d.config.flags[key];
}
function setFlag(d, key, on) {
  ensureConfig(d);
  d.config.flags[key] = !!on;
}
function globalConfigText(d) {
  ensureConfig(d);
  return ("ì „ì—­ ì„¤ì •\n\n" + "ìƒì \n" + "ëª¬ìŠ¤í„°ë³¼: " + d.config.shop.BALL + "ğŸ’°\n" + "ìŠˆí¼ë³¼: " + d.config.shop.SUPER + "ğŸ’°\n" + "í•˜ì´í¼ë³¼: " + d.config.shop.ULTRA + "ğŸ’°\n" + "ë„íŒŒë¯¼ê°•í™”ê¶Œ: " + d.config.shop.DOPA + "ğŸ’°\n\n" + "í† ê¸€\n" + "ì´ë²¤íŠ¸: " + (d.config.flags.EVENT_ON ? "ON" : "OFF") + "\n" + "í•„ë“œ: " + (d.config.flags.FIELD_ON ? "ON" : "OFF") + "\n" + "ê°•í™”: " + (d.config.flags.ENHANCE_ON ? "ON" : "OFF") + "\n" + "ë„íŒŒë¯¼ê°•í™”: " + (d.config.flags.DOPA_ON ? "ON" : "OFF"));
}
// [ìµœì¢… ì—…ë°ì´íŠ¸] ê´€ë¦¬ì ë„ì›€ë§ (ë ˆì´ë“œ & ì¥ë¹„ í¬í•¨)
function adminHelpText() {
  return (
    "ğŸ‘‘ [ìš´ì˜ì ê´€ë¦¬ íŒ¨ë„ v2.3]\n\n" +
    
    "ğŸ¦– [ë ˆì´ë“œ ê´€ë¦¬] (NEW)\n" +
    "/ê´€ë¦¬ì ë ˆì´ë“œì†Œí™˜ [ì²´ë ¥(ì–µ)]\n" +
    "â”” ì˜ˆ: /ê´€ë¦¬ì ë ˆì´ë“œì†Œí™˜ 30\n" +
    "/ê´€ë¦¬ì ë ˆì´ë“œì¢…ë£Œ (ê°•ì œ ì‚­ì œ)\n\n" +
    
    "ğŸ [ì§€ê¸‰ ë° ë³´ìƒ]\n" +
    "/ê´€ë¦¬ì ì§€ê¸‰ [ë‹‰ë„¤ì„] [í•­ëª©] [ìˆ˜ëŸ‰]\n" +
    "â”” ìì›: ê³¨ë“œ, ê²½í—˜ì¹˜, ë ˆë²¨\n" +
    "â”” ì•„ì´í…œ: ëª¬, ìŠˆ, í•˜, í‚¹ê°“ë³¼, ë„íŒŒë¯¼, ì¿ í‚¤, ë¦¬ì…‹, í‹°ì¼“\n" +
    "â”” ì¥ë¹„: í˜ì˜ë¨¸ë¦¬ë , ëˆ„ëˆ„ì˜ìš”ë¦¬ ë“± (ìë™ì¸ì‹)\n" +
    "/ê´€ë¦¬ì ì „ì²´ë³´ìƒ [í•­ëª©] [ìˆ˜ëŸ‰]\n\n" +

    "ğŸ“¢ [ì„œë²„ ê´€ë¦¬]\n" +
    "/ê´€ë¦¬ì ê³µì§€ [ë‚´ìš©]\n" +
    "/ê´€ë¦¬ì ì €ì¥ / ë°ì´í„°ì •ë¦¬\n" +
    "/ê´€ë¦¬ì ì „ì ì´ˆê¸°í™” [ë‹‰ë„¤ì„/ìƒëµì‹œì „ì²´]\n" +
    "/ê´€ë¦¬ì ê³„ì •ì´ë™ [êµ¬ë‹‰] [ì‹ ë‹‰]\n\n" +

    "ğŸ‘¾ [í¬ì¼“ëª¬ ê´€ë¦¬]\n" +
    "/ê´€ë¦¬ì í¬ì¼“ëª¬ [ë‹‰ë„¤ì„]\n" +
    "/ê´€ë¦¬ì í¬ì¼“ëª¬ì§€ê¸‰ [ë‹‰ë„¤ì„] [ì´ë¦„]\n" +
    "/ê´€ë¦¬ì ìŠ¤í° [ë‹‰ë„¤ì„] [ì´ë¦„] [ì´ë¡œì¹˜Y/N]\n" +
    "/ê´€ë¦¬ì ì‚­ì œ [ë‹‰ë„¤ì„] [UID]\n" +
    "/ê´€ë¦¬ì ê°•í™” [ë‹‰ë„¤ì„] [UID] [ìˆ˜ì¹˜]\n\n" +
    
    "ğŸ§ª [ì»¤ìŠ¤í…€ ì—ë””íŠ¸]\n" +
    "/ê´€ë¦¬ì ì´ë¡œì¹˜ [ë‹‰ë„¤ì„] [UID]\n" +
    "/ê´€ë¦¬ì ì ì¬ë ¥ [ë‹‰ë„¤ì„] [UID] [í˜] [ì²´] [ë¯¼]"
  );
}

// -------------------- roomActive: ë©”ëª¨ë¦¬ ì „ìš©(íŒŒì¼ ì €ì¥ X) --------------------
// ë°©ë³„ ìµœê·¼ í™œë™ ìœ ì €(ë°°í‹€ ë§¤ì¹­ìš©) - ì•± ì¬ì‹œì‘ ì‹œ ë¦¬ì…‹ë¨ (ì˜ë„ëœ ë™ì‘)
var ROOM_ACTIVE_MEM = {};// { [room]: { [sender]: lastActiveMs } }
function trackRoomActiveMem(room, sender) {
  var now = nowMs();
  var key = MATCH_POOL_KEY;  // room ëŒ€ì‹  ê³ ì •í‚¤ ì‚¬ìš©
  if (!ROOM_ACTIVE_MEM[key]) 
    ROOM_ACTIVE_MEM[key] = {};
  ROOM_ACTIVE_MEM[key][sender] = now;
  if (Math.random() < 0.08) {
    var m = ROOM_ACTIVE_MEM[key];
    for (var name in m) {
      if (now - m[name] > ACTIVE_TTL_MS) 
        delete m[name];
    }
  }
}
// [ìˆ˜ì •ë¨] ìƒëŒ€ ë§¤ì¹­ í•„í„° (ê°•í™” ìˆ˜ì¹˜ ë²”ìœ„ ì ìš©)
function getEligibleOpponentsMem(d, room, myName, targetEnh) {
  var now = nowMs();
  var key = MATCH_POOL_KEY;
  var active = ROOM_ACTIVE_MEM[key] || {};
  var list = [];
  var RANGE = 10; // Â±10ê°• ë§¤ì¹­

  for (var name in active) {
    if (name === myName) continue; 
    if (now - active[name] > ACTIVE_TTL_MS) continue; 
    
    var u = d.users[name];
    if (!u) continue;
    normalizeUserData(u);

    var hasEligible = false;
    var pokes = getBattleEligiblePokemons(u); 

    if (pokes.length === 0) continue;

    if (targetEnh == null) {
      hasEligible = true;
    } else {
      // ë‚´ í¬ì¼“ëª¬ ê¸°ì¤€ Â±10ê°•ì´ ìˆëŠ”ì§€ í™•ì¸
      var minE = targetEnh - RANGE;
      var maxE = targetEnh + RANGE;
      
      for (var k = 0; k < pokes.length; k++) {
        var pe = pokes[k].enh || 0;
        if (pe >= minE && pe <= maxE) {
          hasEligible = true;
          break; 
        }
      }
    }

    if (hasEligible) list.push(name);
  }
  return list;
}

// ë˜í¼(ê¸°ì¡´ í˜¸ì¶œë¶€ í˜¸í™˜)
function trackRoomActive(d, room, sender) {
  trackRoomActiveMem(room, sender);
}
function getEligibleOpponents(d, room, myName) {
  return getEligibleOpponentsMem(d, room, myName);
}

// -------------------- íƒ€ì… ìƒì„± ê³„ì‚° --------------------
function remapTypeMult(m) {
  // ì›ë³¸ ìƒì„± m: 0, 0.5, 1, 2
  // ëª©í‘œ: ìƒì„±ì€ ê°•í•˜ê²Œ, í•˜ì§€ë§Œ ê°•í™”/í¬ê·€ë„ë¡œ ì»¤ë²„ ì—¬ì§€ ìœ ì§€
  if (m === 0) 
    return 0.25;
  if (m === 0.5) 
    return 0.95;
  if (m === 1) 
    return 1.50;
  if (m === 2) 
    return TYPE_STRONG;
  return 2.40;
}
function typeMultiplierAdjusted(attackType, defendType) {
  if (!attackType || !defendType) 
    return 2;
  var row = TYPE_CHART[attackType];
  if (!row) 
    return 2;
  var raw = row[defendType];
  return remapTypeMult((raw === undefined) ? 1 : raw);
}
// [ìˆ˜ì •ë¨] í¬ê·€ë„ë³„ ê¸°ë³¸ ìŠ¤íƒ¯ ë°°ìœ¨ (ì „ì„¤ ë² ë„¤í• í™•ì‹¤í•˜ê²Œ!)
function rarityBattleMul(r) {
  if (r <= 1) return 1.00; // ì¡ëª¹ (1.0ë°°)
  if (r === 2) return 1.06; // 2í‹°ì–´ (1.06ë°°)
  if (r === 3) return 1.13; // 3í‹°ì–´ (1.13ë°°)
  
  // 4í‹°ì–´ (ìµœì¢…ì§„í™”í˜•): ê¸°ì¡´ë³´ë‹¤ ì¡°ê¸ˆ ë” ëŒ€ìš°í•´ì¤Œ
  if (r === 4) return 1.25; 
  
  // â˜… 5í‹°ì–´ (ì „ì„¤): ì••ë„ì  ì°¨ì´ (ê¸°ì¡´ 1.18 -> 1.45)
  // ë™ê¸‰ ê°•í™”ì¼ ë•Œ ì „ì„¤ì´ ì¼ë°˜ëª¹ë³´ë‹¤ ë°ë¯¸ì§€ê°€ 40% ë” ë‚˜ì˜µë‹ˆë‹¤.
  // í„´ ì œí•œ ì—†ì´, ë°°í‹€ ë‚´ë‚´ ê°•ë ¥í•©ë‹ˆë‹¤.
  return 1.40; 
}


function stageBattleMul(pid) {
  if (!pid) 
    return {
  atk: 1.00, 
  def: 1.00};
  var s = getStageFromBase(pid);
  if (s === 0) 
    return {
  atk: 1.00, 
  def: 1.00};
  if (s === 1) 
    return {
  atk: 1.15, 
  def: 1.08};
  return {
  atk: 1.32, 
  def: 1.16};
}


// -------------------- ì§„í™” ìœ í‹¸ --------------------
function buildPreMap() {
  var pre = {};
  for (var from in EVOLUTION_MAP) {
    var to = EVOLUTION_MAP[from];
    pre[to] = parseInt(from, 10);
  }
  return pre;
}
PRE_MAP = buildPreMap();
function getBaseId(pid) {
  var cur = pid;
  while (PRE_MAP[cur]) 
    cur = PRE_MAP[cur];
  return cur;
}
function chainDepthFromBase(baseId) {
  var depth = 0;
  var cur = baseId;
  while (EVOLUTION_MAP[cur]) {
    depth++;
    cur = EVOLUTION_MAP[cur];
    if (depth >= 3) 
      break;
  }
  return depth;
}
function getStageFromBase(pid) {
  var base = getBaseId(pid);
  if (pid === base) 
    return 0;
  var s1 = EVOLUTION_MAP[base];
  if (pid === s1) 
    return 1;
  var s2 = s1 ? EVOLUTION_MAP[s1] : null;
  if (pid === s2) 
    return 2;
  return 0;
}
function evolveTo(p, newPid) {
  var before = findPokemonDB(p.pid);
  p.pid = newPid;
  var after = findPokemonDB(p.pid);
  var bName = before ? before.name : "í¬ì¼“ëª¬";
  var aName = after ? after.name : "í¬ì¼“ëª¬";
  return bName + " â†’ " + aName;
}
function tryAutoEvolveByEnh(p) {
  // ì´ë¸Œì´ ë¶„ê¸°ì§„í™”
  if (p.pid === 133 && p.enh >= EVOLVE_EEVEE) {
    var pick = EEVEE_EVOS[Math.floor(Math.random() * EEVEE_EVOS.length)];
    return evolveTo(p, pick);
  }
  var base = getBaseId(p.pid);
  var depth = chainDepthFromBase(base);
  var stage = getStageFromBase(p.pid);
  if (depth >= 2) {
    if (stage === 0 && p.enh >= EVOLVE_TWO_STAGE_1) {
      return evolveTo(p, EVOLUTION_MAP[p.pid]);
    }
    if (stage === 1 && p.enh >= EVOLVE_TWO_STAGE_2) {
      return evolveTo(p, EVOLUTION_MAP[p.pid]);
    }
  }
  if (depth === 1 && stage === 0 && p.enh >= EVOLVE_ONE_STAGE) {
    return evolveTo(p, EVOLUTION_MAP[p.pid]);
  }
  return null;
}
// -------------------- íšŒì› / ê³„ì • --------------------
function ensureUser(d, sender) {
  if (!d.users[sender]) {
    d.users[sender] = {
  trainerLv: 1, 
  trainerExp: 0, 
  gold: 0, 
  ball: 0, 
  superBall: 0, 
  ultraBall: 0, 
  pokemons: [], 
  nextPokeUid: 1, 
  lastFieldAt: 0, 
  lastExploreAt: 0, 
  lastEnhanceAt: 0, 
  lastAttendanceKey: "", 
  catchFailStreak: 0, 
  lastCatchPid: 0, 
  stats: {}, 
  dex: {}, 
  isNewUser: true};
    ensureUserStats(d.users[sender]);
    ensureUserDex(d.users[sender]);
    return true;
  }
  return false;
}
// -------------------- [ì‹ ì„¤] ë“±ê¸‰ ë° ê°œì²´ê°’(IV) ì‹œìŠ¤í…œ --------------------
var GRADE_ORDER = { "D": 0, "C": 1, "B": 2, "A": 3, "S": 4 };

// ëœë¤ ë“±ê¸‰ ê²°ì • (S: 5%, A: 10%, B: 20%, C: 35%, D: 30%)
function generatePokemonGrade() {
  var r = Math.random();
  if (r < 0.05) return "S";
  if (r < 0.15) return "A";
  if (r < 0.35) return "B";
  if (r < 0.65) return "C";
  return "D";
}

// ë“±ê¸‰ì— ë”°ë¥¸ ê°œì²´ê°’(IV) ìƒì„± ë²”ìœ„
function generateIVsByGrade(grade) {
  var ivs = { str: 0, hp: 0, spd: 0 };
  if (grade === "S") {
    ivs.str = randInt(13, 15); ivs.hp = randInt(120, 150); ivs.spd = randInt(13, 15);
  } else if (grade === "A") {
    ivs.str = randInt(10, 12); ivs.hp = randInt(80, 119); ivs.spd = randInt(10, 12);
  } else if (grade === "B") {
    ivs.str = randInt(7, 9);   ivs.hp = randInt(50, 79);  ivs.spd = randInt(7, 9);
  } else if (grade === "C") {
    ivs.str = randInt(4, 6);   ivs.hp = randInt(20, 49);  ivs.spd = randInt(4, 6);
  } else {
    ivs.str = randInt(1, 3);   ivs.hp = randInt(1, 19);   ivs.spd = randInt(1, 3);
  }
  return ivs;
}


// -------------------- í¬íš ìœ í‹¸ --------------------
// [ìµœì¢… ë””ë²„ê·¸ìš©] ì €ì¥ í•¨ìˆ˜
// [ìµœì¢… ì™„ë£Œ] ì´ë¡œì¹˜ ì €ì¥ í•¨ìˆ˜ (ë””ë²„ê·¸ ë©”ì‹œì§€ ì œê±°ë¨)
function addPokemonToUser(u, pid, isShiny) { 
  var uid = nextPokemonUid(u);
  var grade = generatePokemonGrade();
  var ivs = generateIVsByGrade(grade);

  u.pokemons.push({
    uid: uid,
    pid: pid,
    enh: 0,
    grade: grade,
    ivStr: ivs.str,
    ivHp: ivs.hp,
    ivSpd: ivs.spd,
    shiny: !!isShiny // ì´ë¡œì¹˜ ì €ì¥ í•„ìˆ˜!
  });

  dexCaught(u, pid, grade);
  return uid;
}

// í¬ê·€ë„: 1(í”í•¨) ~ 5(ì „ì„¤)
// db.rarity ë˜ëŠ” db.tier ê°™ì€ ê°’ì´ ì´ë¯¸ ìˆìœ¼ë©´ ê±°ê¸°ì— ë§ì¶° ì—°ê²°í•˜ë©´ ë¨.
function randInt(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}
function getRarity(pid) {
  // ìš°ì„  DBì— rarityê°€ ìˆìœ¼ë©´ ê·¸ê±¸ ì“°ëŠ” ê±¸ ì¶”ì²œ
  // ì—¬ê¸°ì„œëŠ” findPokemonDB(pid).rarity ë¥¼ ê°€ì •
  var db = findPokemonDB(pid);
  if (db && db.rarity != null) 
    return db.rarity;
  return 1;
}
function isLegendary(pid) {
  // DBì— legendary í”Œë˜ê·¸ê°€ ìˆìœ¼ë©´ ê·¸ê±¸ ì‚¬ìš© ì¶”ì²œ
  // ì—¬ê¸°ì„œëŠ” db.legendary ë˜ëŠ” rarity==5 ë¡œ ì²˜ë¦¬
  var db = findPokemonDB(pid);
  if (db && db.legendary != null) 
    return !!db.legendary;
  var r = (db && db.rarity != null) ? db.rarity : 1;
  return r >= 5;
}
// í¬ê·€ë„ë³„ ê¸°ë³¸ ë³´ìƒ í…Œì´ë¸” (ì›í•˜ëŠ” ìˆ˜ì¹˜ë¡œ ì¡°ì ˆ ê°€ëŠ¥)
var CATCH_REWARD_BASE = {
  1: {
  gold: 60, 
  exp: 18}, 
  2: {
  gold: 100, 
  exp: 28}, 
  3: {
  gold: 160, 
  exp: 45}, 
  4: {
  gold: 260, 
  exp: 70}, 
  5: {
  gold: 400, 
  exp: 110}};
// ë ˆë²¨/ë‚œìˆ˜/í¬ê·€ë„ê¹Œì§€ ë°˜ì˜í•´ì„œ ìµœì¢… ë³´ìƒ ì‚°ì¶œ
function calcCatchRewards(u, pid) {
  var db = findPokemonDB(pid) || {};
  var rarity = (db.rarity != null) ? db.rarity : 1;
  rarity = clamp(rarity, 1, 5);
  var base = CATCH_REWARD_BASE[rarity] || CATCH_REWARD_BASE[1];
  // ë ˆë²¨ ë³´ì •: ë ˆë²¨ì´ ë†’ì„ìˆ˜ë¡ ì†Œí­ ì¦ê°€ (ë„ˆë¬´ í­ì¦í•˜ì§€ ì•Šê²Œ)
  var lv = (u && typeof u.trainerLv === "number") ? u.trainerLv : 1;
  // ë‚œìˆ˜ ë³´ì •: í¬ê·€ë„ê°€ ë†’ì„ìˆ˜ë¡ í­ì´ ì»¤ì§
  // ì˜ˆ: í”í•¨ Â±20%, ì „ì„¤ Â±35%
  var jitterPct = [0, 20, 22, 26, 30, 35][rarity];  // ì¸ë±ìŠ¤ ë§ì¶¤
  var goldJ = randInt(-jitterPct, jitterPct) / 100;
  var expJ = randInt(-jitterPct, jitterPct) / 100;
  // ë ˆë²¨ ê³„ìˆ˜: 1 + (ë ˆë²¨ / 100) ì •ë„ë¡œ ì™„ë§Œí•˜ê²Œ
  var lvMul = 1 + (lv / 100);
  var gold = Math.floor(base.gold * lvMul * (1 + goldJ));
  var exp = Math.floor(base.exp * lvMul * (1 + expJ));
  // ìµœì†Œê°’ ë³´ì •
  gold = Math.max(1, gold);
  exp = Math.max(1, exp);
  // ì „ì„¤ íŠ¹ìˆ˜ ë³´ë„ˆìŠ¤(ì¶”ê°€ ë³´ìƒ): í° í•œë°© + ì—°ì¶œìš©
  var legendary = isLegendary(pid);
  var bonusGold = 0;
  var bonusExp = 0;
  if (legendary) {
    bonusGold = randInt(180, 360) + Math.floor(lv * 1.2);
    bonusExp = randInt(120, 240) + Math.floor(lv * 0.9);
  }
  return {
  rarity: rarity, 
  legendary: legendary, 
  gold: gold, 
  exp: exp, 
  bonusGold: bonusGold, 
  bonusExp: bonusExp, 
  totalGold: gold + bonusGold, 
  totalExp: exp + bonusExp};
}
// ì „ì„¤ ì—°ì¶œ ë¬¸êµ¬
function legendaryCatchFX(sender, name, r) {
  // r: calcCatchRewards ê²°ê³¼
  return (blockTitle("ì „ì„¤ í¬íš") + "âœ¨ " + sayDo(sender, "ì „ì„¤ê¸‰ " + name + "ì„(ë¥¼) í¬íší–ˆì–´ìš”!") + "\n\n" + "ğŸ† íŠ¹ìˆ˜ ë³´ìƒ ë°œìƒ!\n" + "ì¶”ê°€ ë³´ìƒ: +" + r.bonusGold + "ğŸ’° / +" + r.bonusExp + "EXP\n\n");
}
function getMaxCatchAttempts(pid) {
  var db = findPokemonDB(pid);
  var r = db ? (db.rarity || 2) : 2;
  var min = 1;
  var max = 8;
  if (r <= 1) 
    min = 5;
  else if (r === 2) 
    min = 4;
  else if (r === 3) 
    min = 3;
  else if (r === 4) 
    min = 2;
  else 
    min = 1;  // r5
  return min + Math.floor(Math.random() * (max - min + 1));
}
// -------------------- ì†Œí”„íŠ¸ í”¼í‹° í¬í•¨ í¬íš íŒì • (4-D) --------------------
var CATCH_PITY_START = 2;// 2ì—°ì† ì‹¤íŒ¨ë¶€í„°
var CATCH_PITY_STEP = 0.01;// ì‹¤íŒ¨ 1íšŒë‹¹ +1%
var CATCH_PITY_MAX = 0.05;// ìµœëŒ€ +5%
function lerp(a, b, t) {
  return a + (b - a) * t;
}
function tierCatchMod(tier) {
  if (tier <= 1) 
    return 1.40;
  if (tier >= 5) 
    return 0.32;
  if (tier < 2) 
    return lerp(1.40, 1.15, tier - 1);
  if (tier < 3) 
    return lerp(1.15, 0.85, tier - 2);
  if (tier < 4) 
    return lerp(0.85, 0.55, tier - 3);
  return lerp(0.55, 0.32, tier - 4);
}
function getCatchTier(db) {
  if (!db) 
    return 2;
  return CATCH_TIER_OVERRIDES[db.id] || db.rarity || 2;
}
function tryCatch(u, pid, ballType) {
  var db = findPokemonDB(pid);
  if (!db) 
    return {
  ok: false};
  if (u.lastCatchPid !== pid) {
    u.catchFailStreak = 0;
    u.lastCatchPid = pid;
  }
  var base = 0.38;
  var ballMult = BALL_CATCH_MULT[ballType] || 1.0;
  var tier = getCatchTier(db);
  var tierMult = tierCatchMod(tier);
  var lvBonus = trainerCatchBonus(u.trainerLv);
  var chance = base * ballMult * tierMult * rarityCatchMul(db.rarity || 2) * (1 + lvBonus);
  // ì €ë ˆë²¨ ì „ì„¤ ì–µì œ
  if (db.rarity === 5 && u.trainerLv < 20) {
    chance *= 0.5;
  }
  if (chance < 0.02) 
    chance = 0.02;
  if (chance > 0.90) 
    chance = 0.90;
  if (u.catchFailStreak >= CATCH_PITY_START) {
    var pity = (u.catchFailStreak - CATCH_PITY_START + 1) * CATCH_PITY_STEP;
    pity *= (1 + (tier - 2) * 0.12);    // ì „ì„¤ì¼ìˆ˜ë¡ ì‚´ì§ ë” ë³´ì •
    pity = Math.min(CATCH_PITY_MAX, pity);
    chance *= (1 + pity);
  }
  chance = Math.max(0.02, Math.min(0.85, chance));
  var success = Math.random() < chance;
  if (success) {
    u.catchFailStreak = 0;
    u.lastCatchPid = 0;
  } else {
    u.catchFailStreak++;
  }
  return {
  ok: true, 
  success: success, 
  chance: chance, 
  streak: u.catchFailStreak, 
  tier: tier};
}
function commitSave(force) {
  markDirty();
  flushSaveIfNeeded(!!force);
}
function debugBattle(d, sender, room, replier) {
  var now = Date.now();
  var roomActive = ROOM_ACTIVE_MEM[room] || {};
  var activeUsers = [];
  var existUsers = [];
  var pokemonUsers = [];
  var candidates = [];
  for (var name in roomActive) {
    var last = roomActive[name];
    if (now - last <= ACTIVE_TTL_MS) {
      activeUsers.push(name);
      if (d.users && d.users[name]) {
        existUsers.push(name);
        var pokes = d.users[name].pokemons;
        if (pokes && Object.keys(pokes).length > 0) {
          pokemonUsers.push(name);
          if (name !== sender) 
            candidates.push(name);
        }
      }
    }
  }
  var msgLines = [];
  msgLines.push("ë°°í‹€ ë””ë²„ê·¸");
  msgLines.push("ë°©: " + room);
  msgLines.push("ë‚˜: " + sender);
  msgLines.push("í˜„ì¬ ì‹œê°„: " + new Date(now).toLocaleString());
  msgLines.push("");
  msgLines.push("ìµœê·¼ í™œë™ ìœ ì € ìˆ˜: " + activeUsers.length);
  msgLines.push(activeUsers.join(", ") || "(ì—†ìŒ)");
  msgLines.push("");
  msgLines.push("ìœ ì € ë°ì´í„° ì¡´ì¬: " + existUsers.length);
  msgLines.push(existUsers.join(", ") || "(ì—†ìŒ)");
  msgLines.push("");
  msgLines.push("í¬ì¼“ëª¬ ë³´ìœ  ìœ ì €: " + pokemonUsers.length);
  msgLines.push(pokemonUsers.join(", ") || "(ì—†ìŒ)");
  msgLines.push("");
  msgLines.push("ìµœì¢… ë°°í‹€ í›„ë³´(ë³¸ì¸ ì œì™¸): " + candidates.length);
  msgLines.push(candidates.join(", ") || "(ì—†ìŒ)");
  replier.reply(msgLines.join("\n"));
}

// ê±°ë˜ ì¤‘ë³µ ë°©ì§€ìš© ë½
var TRANSACTION_LOCK = {};

// ==================================================================
// ğŸ›ï¸ [v3.4 ìµœì¢…] ì²´ìœ¡ê´€ ê´€ì¥ (ì…ì¥ë£Œ í˜„ì‹¤í™”: 50ë§Œ ~ 2,000ë§Œ)
// ==================================================================
var GYM_LEADERS = [
  { name: "ì›…ì´", type: "ë°”ìœ„", badge: "ğŸª¨", entryFee: 500000, lineup: [ 
      { id: 74, name: "ê¼¬ë§ˆëŒ", enh: 10, grade: "B", shiny: false },
      { id: 111, name: "ë¿”ì¹´ë…¸", enh: 15, grade: "A", shiny: false },
      { id: 95, name: "ë¡±ìŠ¤í†¤", enh: 25, grade: "S", shiny: true } 
    ] 
  },
  { name: "ì´ìŠ¬", type: "ë¬¼", badge: "ğŸ’§", entryFee: 1000000, lineup: [
      { id: 120, name: "ë³„ê°€ì‚¬ë¦¬", enh: 20, grade: "A", shiny: false },
      { id: 130, name: "ê°¸ë¼ë„ìŠ¤", enh: 30, grade: "S", shiny: false },
      { id: 121, name: "ì•„ì¿ ìŠ¤íƒ€", enh: 40, grade: "S", shiny: true }
    ] 
  },
  { name: "ë§ˆí‹°ìŠ¤", type: "ì „ê¸°", badge: "âš¡", entryFee: 2000000, lineup: [
      { id: 100, name: "ì°Œë¦¬ë¦¬ê³µ", enh: 35, grade: "A", shiny: false },
      { id: 125, name: "ì—ë ˆë¸Œ", enh: 45, grade: "S", shiny: false },
      { id: 26, name: "ë¼ì´ì¸„", enh: 50, grade: "S", shiny: true }
    ] 
  },
  { name: "ë¯¼í™”", type: "í’€", badge: "ğŸŒ¿", entryFee: 3500000, lineup: [
      { id: 70, name: "ìš°ì¸ ë™", enh: 45, grade: "A", shiny: false },
      { id: 114, name: "ë©ì¿ ë¦¬", enh: 50, grade: "S", shiny: false },
      { id: 3, name: "ì´ìƒí•´ê½ƒ", enh: 60, grade: "S", shiny: true }
    ] 
  },
  { name: "ë…ìˆ˜", type: "ë…", badge: "â˜ ï¸", entryFee: 5000000, lineup: [
      { id: 109, name: "ë˜ê°€ìŠ¤", enh: 55, grade: "A", shiny: false },
      { id: 89, name: "ì§ˆë»ê¸°", enh: 60, grade: "S", shiny: false },
      { id: 110, name: "ë˜ë„ê°€ìŠ¤", enh: 65, grade: "S", shiny: true }
    ] 
  },
  // â˜… ì—¬ê¸°ì„œë¶€í„° ì „ì„¤ ì—ì´ìŠ¤ ë“±ì¥ (ì…ì¥ë£Œ 800ë§Œ ~ 2000ë§Œ)
  { name: "ì´ˆë ¨", type: "ì—ìŠ¤í¼", badge: "ğŸ”®", entryFee: 8000000, lineup: [
      { id: 122, name: "ë§ˆì„ë§¨", enh: 60, grade: "S", shiny: false },
      { id: 65, name: "í›„ë”˜", enh: 65, grade: "S", shiny: false },
      { id: 151, name: "ë®¤", enh: 70, grade: "S", shiny: true } 
    ] 
  },
  { name: "ê°•ì—°", type: "ë¶ˆ", badge: "ğŸ”¥", entryFee: 12000000, lineup: [
      { id: 78, name: "ë‚ ìŒ©ë§ˆ", enh: 65, grade: "S", shiny: false },
      { id: 6, name: "ë¦¬ìëª½", enh: 70, grade: "S", shiny: false },
      { id: 146, name: "íŒŒì´ì–´", enh: 75, grade: "S", shiny: true } 
    ] 
  },
  { name: "ë¹„ì£¼ê¸°", type: "ë•…", badge: "ğŸŒ", entryFee: 20000000, lineup: [
      { id: 112, name: "ì½”ë¿Œë¦¬", enh: 75, grade: "S", shiny: false },
      { id: 34, name: "ë‹ˆë“œí‚¹", enh: 80, grade: "S", shiny: false },
      { id: 150, name: "ë®¤ì¸ ", enh: 80, grade: "S", shiny: true } 
    ] 
  }
];

// ==================================================================
// ğŸ‘‘ [v3.4 ìµœì¢…] NPC ì±”í”¼ì–¸ 'ë ˆë“œ' (ë§ë‚˜ë‡½ ì—ì´ìŠ¤) - í•˜ë‚˜ë§Œ ë‚¨ê¹€
// ==================================================================
var NPC_CHAMPION = {
  name: "ë ˆë“œ(NPC)",
  isNpc: true,
  lineup: [
    { id: 25, name: "í”¼ì¹´ì¸„", enh: 75, grade: "S", shiny: true }, 
    { id: 3, name: "ì´ìƒí•´ê½ƒ", enh: 78, grade: "S", shiny: false },
    { id: 9, name: "ê±°ë¶ì™•", enh: 78, grade: "S", shiny: false },
    { id: 143, name: "ì ë§Œë³´", enh: 78, grade: "S", shiny: false },
    { id: 6, name: "ë¦¬ìëª½", enh: 85, grade: "S", shiny: true },
    { id: 149, name: "ë§ë‚˜ë‡½", enh: 90, grade: "S", shiny: true } 
  ]
};


// ==================== [í•µì‹¬] ë¦´ë ˆì´ ë°°í‹€ ì—”ì§„ (3v3, 6v6 ê³µìš©) ====================
function simulateRelayBattle(teamA, teamB, nameA, nameB, isChampBattle) {
  // íŒ€ ë°ì´í„° ì´ˆê¸°í™” (HP ì„¸íŒ…)
  function initTeam(team, isChallenger) {
    return team.map(function(p) {
      var db = findPokemonDB(p.pid || p.id); // ìœ ì €í¬ì¼“ëª¬ì€ pid, NPCëŠ” id
      var maxHp = calcHP(db, p.enh, p.ivHp || 15);
      
      // â˜… ì±”í”¼ì–¸ ë°©ì–´ì „ ë²„í”„: ë„ì „ìê°€ ì•„ë‹Œ(ë°©ì–´ì) ê²½ìš° ì²´ë ¥/ë°©ì–´ë ¥ 1.5ë°° ë»¥íŠ€ê¸°
      if (isChampBattle && !isChallenger) {
          maxHp = Math.floor(maxHp * 1.5); 
      }
      
      return {
        origin: p,
        db: db,
        maxHp: maxHp,
        curHp: maxHp,
        isDead: false
      };
    });
  }

  var tA = initTeam(teamA, true);  // ë„ì „ì (A)
  var tB = initTeam(teamB, false); // ë°©ì–´ì/ê´€ì¥ (B)

  var idxA = 0;
  var idxB = 0;
  var log = [];
  var turn = 1;

  log.push("âš”ï¸ BATTLE START âš”ï¸");
  log.push(nameA + " vs " + nameB + "\n");

  // --- ë¦´ë ˆì´ ë£¨í”„ ---
  while (idxA < tA.length && idxB < tB.length && turn < 500) {
    var pA = tA[idxA];
    var pB = tB[idxB];

    // í¬ì¼“ëª¬ ë“±ì¥ ë¡œê·¸ (êµì²´ ì‹œ)
    if (turn === 1 || pA.justSwapped || pB.justSwapped) {
        var aStat = pA.justSwapped ? ("Go! " + getDisplayName(pA.origin)) : "";
        var bStat = pB.justSwapped ? ("ë‚˜ì™€ë¼! " + getDisplayName(pB.origin)) : "";
        if(aStat || bStat) log.push("ğŸ”„ " + aStat + (aStat&&bStat?" vs ":"") + bStat);
        pA.justSwapped = false; pB.justSwapped = false;
    }

    // ë‹¨íŒ ìŠ¹ë¶€ ë¡œì§ ê°€ì ¸ì˜¤ê¸° (calcHit ë“± í™œìš©)
    // ì—¬ê¸°ì„œëŠ” ì•½ì‹ìœ¼ë¡œ 1í„´ì”© ì£¼ê³ ë°›ê¸° êµ¬í˜„
    
    // ì†ë„ ê³„ì‚° (ì„ ê³µ)
    var spdA = (pA.origin.ivSpd || 0) + (pA.origin.enh || 0);
    var spdB = (pB.origin.ivSpd || 0) + (pB.origin.enh || 0);
    var aFirst = spdA >= spdB;
    if (spdA === spdB) aFirst = Math.random() < 0.5;

    // ê³µê²© í•¨ìˆ˜
    function attack(attacker, defender, isChallenger) {
        var attP = attacker.origin;
        var defP = defender.origin;
        
        // ë°ë¯¸ì§€ ê³„ì‚°
        var dmgObj = calcDamage(attacker.db, attP.enh, defender.db, defP.enh);
        var damage = dmgObj.score;
        
        // â˜… ì±”í”¼ì–¸ ë°©ì–´ ë²„í”„ (ë°ë¯¸ì§€ ê°ì†Œ)
        if (isChampBattle && !isChallenger) {
            // ë°©ì–´ìê°€ ë§ì„ ë•Œ ë°ë¯¸ì§€ ê°ì†Œ
            // (ì´ë¯¸ HPê°€ 1.5ë°°ë¼ ì¶©ë¶„í•˜ì§€ë§Œ, í™•ì‹¤í•˜ê²Œ 0.8ë°° ë°ë¯¸ì§€ë§Œ ë°›ê²Œ í•¨)
            damage = Math.floor(damage * 0.8); 
        }

        // ì´ë¡œì¹˜ ë³´ë„ˆìŠ¤
        if (attP.shiny) damage = Math.floor(damage * 1.1);

        // ëœë¤ì„±
        damage = Math.floor(damage * rnd(0.9, 1.1));
        
        defender.curHp -= damage;
        
        var eff = typeEffectText(dmgObj.mult);
        var icon = (dmgObj.mult > 1.5) ? "ğŸ’¥" : "ğŸ—¡ï¸";
        
        log.push(turn + "í„´) " + icon + " " + getDisplayName(attP) + "ì˜ ê³µê²©! -> " + damage + " ë°ë¯¸ì§€" + (eff ? (" ("+eff+")") : ""));
    }

    // í„´ ì§„í–‰
    if (aFirst) {
        attack(pA, pB, true);
        if (pB.curHp > 0) attack(pB, pA, false);
    } else {
        attack(pB, pA, false);
        if (pA.curHp > 0) attack(pA, pB, true);
    }

    // ì‚¬ë§ ì²´í¬
    if (pA.curHp <= 0) {
        log.push("ğŸ’€ " + getDisplayName(pA.origin) + " ì“°ëŸ¬ì§!");
        idxA++;
        if (idxA < tA.length) tA[idxA].justSwapped = true;
    }
    if (pB.curHp <= 0) {
        log.push("ğŸ’€ " + getDisplayName(pB.origin) + " ì“°ëŸ¬ì§!");
        idxB++;
        if (idxB < tB.length) tB[idxB].justSwapped = true;
    }

    turn++;
  }

  var winner = (idxA < tA.length) ? "A" : "B";
  log.push("\nğŸ ê²½ê¸° ì¢…ë£Œ! ìŠ¹ì: " + (winner === "A" ? nameA : nameB));

  return { winner: winner, log: log.join("\n") };
}


// ==================================================================
// ğŸ¦– [ì›”ë“œ ë³´ìŠ¤] ë ˆì´ë“œ ì‹œìŠ¤í…œ ì—”ì§„ (ê³µë™ ê¸ˆê³  & Në¹µ ë¶„ë°°)
// ==================================================================

// 1. ë³´ìŠ¤ ì†Œí™˜ (ê¸ˆê³  ì´ˆê¸°í™” ì¶”ê°€)
function spawnRaidBoss(d, hpBillions) {
    var hp = (hpBillions || 20) * 100000000; 
    d.worldBoss = {
        active: true,
        name: "ë‹¤ì½”íƒ€ ë®¤ì¸ ", 
        maxHp: hp,
        curHp: hp,
        startTime: nowMs(),
        endTime: nowMs() + RAID_DURATION_MS,
        logs: {}, 
        lastHitter: null,
        rewardPool: 0 // â˜… [ì‹ ê·œ] ì½”ì¸ì´ ëª¨ì´ëŠ” ê³µë™ ê¸ˆê³ 
    };
    return "ğŸ¦– [ê²½ê³ ] ì›”ë“œ ë³´ìŠ¤ 'ë‹¤ì½”íƒ€ ë®¤ì¸ 'ê°€ ì†Œí™˜ë˜ì—ˆìŠµë‹ˆë‹¤!\nì²´ë ¥: " + fmtNum(hp) + "\nì œí•œì‹œê°„: 2ì‹œê°„\nëª…ë ¹ì–´: /ë ˆì´ë“œ";
}

// 2. ë ˆì´ë“œ ì¢…ë£Œ ë° ë³´ìƒ ì •ì‚° (ì‹¤íŒ¨ ë³´ìƒ & ì„±ê³µ ë³´ë„ˆìŠ¤ ì ìš©)
function endRaidBoss(d, isClear) {
    if (!d.worldBoss || !d.worldBoss.active) return "ì§„í–‰ ì¤‘ì¸ ë ˆì´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.";
    
    var boss = d.worldBoss;
    if (!boss.logs) boss.logs = {}; 

    var rankMsg = "";
    
    // --- 1. ë­í‚¹ ë° í†µê³„ ì‚°ì • (ì„±ê³µ/ì‹¤íŒ¨ ê³µí†µ) ---
    var list = [];
    var totalDamage = 0; 
    
    for (var name in boss.logs) {
        var dmg = boss.logs[name];
        list.push({ name: name, dmg: dmg });
        totalDamage += dmg;
    }
    // ë”œëŸ‰ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
    list.sort(function(a, b) { return b.dmg - a.dmg; });
    
    // --- 2. ê¸ˆê³ (Pool) ê³„ì‚° ---
    var totalPool = boss.rewardPool || 0; // í˜„ì¬ ëª¨ì¸ ëˆ
    
    // â˜… [ì„±ê³µ ë³´ë„ˆìŠ¤] í† ë²Œ ì„±ê³µ ì‹œ 1000ê°œ ì¶”ê°€!
    if (isClear) {
        totalPool += 1000;
    }
    
    var participantCount = list.length;
    
    // ê¸°ë³¸ ì§€ê¸‰ (ì°¸ê°€ìƒ 3ê°œ)
    var basicReward = 3; 
    var usedForBasic = participantCount * basicReward;
    
    // ì„±ê³¼ê¸‰ ì¬ì› (ê¸ˆê³  - ì°¸ê°€ìƒ)
    var performancePool = Math.max(0, totalPool - usedForBasic);
    
    // --- 3. ë¶„ë°° ë¡œì§ ---
    for (var i = 0; i < list.length; i++) {
        var r = list[i];
        var u = d.users[r.name];
        if (!u) continue;
        
        // ì§€ë¶„ìœ¨ (ë‚´ ë”œ / ì „ì²´ ë”œ)
        var share = (totalDamage > 0) ? (r.dmg / totalDamage) : 0;
        var bonusCoin = Math.floor(performancePool * share);
        
        var finalCoin = basicReward + bonusCoin;
        var lastHitMsg = "";

        // â˜… ë§‰íƒ€ ë³´ë„ˆìŠ¤ëŠ” ì„±ê³µí–ˆì„ ë•Œë§Œ ì§€ê¸‰
        if (isClear && boss.lastHitter === r.name) {
            finalCoin += 30;
            lastHitMsg = " (ë§‰íƒ€+30)";
        }
        
        u.dakotaCoin = (u.dakotaCoin || 0) + finalCoin;
        
        // ë­í‚¹ ë¡œê·¸ (ìƒìœ„ 5ëª…)
        if (i < 5) {
            var percent = Math.floor(share * 100);
            rankMsg += (i + 1) + "ìœ„ " + r.name + " (" + percent + "% ê¸°ì—¬) â” +" + fmtNum(finalCoin) + "ğŸª™" + lastHitMsg + "\n";
        }
    }
    
    var title = "";
    var subTitle = "";
    
    if (isClear) {
        title = "ğŸ‰ ë ˆì´ë“œ í† ë²Œ ì„±ê³µ! ğŸ‰";
        subTitle = "ğŸ’° ì„±ê³µ ë³´ë„ˆìŠ¤ +1,000ì½”ì¸ í¬í•¨ ë¶„ë°° ì™„ë£Œ!";
    } else {
        title = "ğŸ’€ ì œí•œ ì‹œê°„ ì¢…ë£Œ... í† ë²Œ ì‹¤íŒ¨";
        subTitle = "âš ï¸ ë³´ìŠ¤ëŠ” ë†“ì³¤ì§€ë§Œ, ì ë¦½ëœ ì½”ì¸ì€ ì •ì‚°í•˜ì—¬ ì§€ê¸‰ë©ë‹ˆë‹¤.";
    }
    
    var resultMsg = title + "\n\n" +
                    subTitle + "\n" +
                    "ğŸ’° ì´ ë¶„ë°° ì½”ì¸: " + fmtNum(totalPool) + "ê°œ\n" +
                    "ğŸ‘¥ ì°¸ì—¬ì: " + participantCount + "ëª…\n" +
                    "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                    "[ğŸ… ëª…ì˜ˆì˜ ì „ë‹¹ & ì •ì‚° ê²°ê³¼]\n" + rankMsg;
    
    d.worldBoss = null; // ë³´ìŠ¤ ì‚­ì œ
    return resultMsg;
}

// 3. ì „íˆ¬ë ¥ ê³„ì‚°
function getRaidPower(u) {
    if (!u.champTeam || u.champTeam.length === 0) return 0;
    var totalPower = 0;
    for(var i=0; i<u.champTeam.length; i++) {
        var p = findUserPokemonByUid(u, u.champTeam[i]);
        if(p) totalPower += calcBattlePower(p); 
    }
    if (u.champTeam.length < 6) totalPower = Math.floor(totalPower * 0.5); 
    return totalPower;
}



// -------------------- ë©”ì¸ ì‘ë‹µ --------------------
function response(room, msg, sender, isGroupChat, replier) {
  trackRoomActiveMem(room, sender);
  var MATCH_POOL = "__GLOBAL_MATCH__";
  if (!ROOM_ACTIVE_MEM[MATCH_POOL]) 
    ROOM_ACTIVE_MEM[MATCH_POOL] = {};
  ROOM_ACTIVE_MEM[MATCH_POOL][sender] = Date.now();
  var d = getDataCached();

  // ==================================================================
  // ğŸ‘‘ [ê´€ë¦¬ì] í†µí•© ì‹œìŠ¤í…œ (ë ˆì´ë“œ + ì¥ë¹„ì§€ê¸‰ + ë¦¬íŒ©í† ë§)
  // ==================================================================
  if (msg.indexOf("/ê´€ë¦¬ì") === 0) {
    if (!isAdmin(sender)) {
      replier.reply("ğŸš« ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    var parts = msg.split(" ").filter(Boolean);
    var sub = parts[1] || "ë„ì›€";

    // -------------------- 1. [ë„ì›€ë§ & ì—…ë°ì´íŠ¸] --------------------
    if (sub === "ë„ì›€") {
      replier.reply(adminHelpText());
      return;
    }

    if (sub === "ì—…ë°ì´íŠ¸") {
      replier.reply("â³ ê¹ƒí—ˆë¸Œì—ì„œ ìµœì‹  ì½”ë“œë¥¼ ë°›ì•„ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...\n" + GITHUB_RAW_URL);
      try {
        // â˜… [ìˆ˜ì •] URL ë’¤ì— '?v=ì‹œê°„'ì„ ë¶™ì—¬ì„œ ìºì‹œë¥¼ ë¬´ì‹œí•˜ê³  ìµœì‹ ë³¸ì„ ê°•ì œë¡œ ê°€ì ¸ì˜´
        var noCacheUrl = GITHUB_RAW_URL + "?v=" + new Date().getTime();
        var newCode = org.jsoup.Jsoup.connect(noCacheUrl).ignoreContentType(true).execute().body();
        
        if (!newCode || newCode.length < 100) {
          replier.reply("ğŸš« ì‹¤íŒ¨: ì½”ë“œê°€ ë„ˆë¬´ ì§§ê±°ë‚˜ ë¹„ì–´ìˆìŠµë‹ˆë‹¤."); return;
        }
        
        // ê²½ë¡œì™€ íŒŒì¼ëª… í™•ì¸ (íŒŒì¼ëª… ë’¤ì— .jsê°€ ë¶™ëŠ”ì§€ í™•ì¸ í•„ìˆ˜)
        var path = "/sdcard/msgbot/Bots/" + SCRIPT_NAME + ".js";
        
        // (ê¸°ì¡´ ì½”ë“œ ê·¸ëŒ€ë¡œ)
        var currentCode = readFile(path);
        if (currentCode) writeFile(path + ".bak", currentCode); // ë°±ì—…
        writeFile(path, newCode); // ë®ì–´ì“°ê¸°
        
        replier.reply("âœ… ë‹¤ìš´ë¡œë“œ ì™„ë£Œ! ë´‡ì„ ì¬ë¡œë”©í•©ë‹ˆë‹¤...");
        Api.reload(SCRIPT_NAME);
      } catch (e) {
        replier.reply("âŒ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨!\n" + e);
      }
      return;
    }


    // -------------------- 2. [ë ˆì´ë“œ ê´€ë¦¬] (ì‹ ê·œ) --------------------
    if (sub === "ë ˆì´ë“œì†Œí™˜") {
        var hpInput = parseInt(parts[2]); // ì–µ ë‹¨ìœ„
        var msgRaid = spawnRaidBoss(d, hpInput || 20); // ê¸°ë³¸ 20ì–µ
        commitSave(true);
        replier.reply(msgRaid);
        return;
    }
    
    if (sub === "ë ˆì´ë“œì¢…ë£Œ") {
        d.worldBoss = null; // ê°•ì œ ì‚­ì œ
        commitSave(true);
        replier.reply("ğŸ—‘ï¸ ë ˆì´ë“œê°€ ê°•ì œ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        return;
    }

    // -------------------- 3. [ì§€ê¸‰] ìì›/ì†Œëª¨í’ˆ/ì¥ë¹„/ë‹¤ì½”íƒ€ í†µí•© --------------------
    if (sub === "ì§€ê¸‰") {
      var targetName = parts[2];
      var itemKey = parts[3];
      var amount = parseInt(parts[4], 10);

      if (!targetName || !itemKey || isNaN(amount)) {
        replier.reply("ì‚¬ìš©ë²•: /ê´€ë¦¬ì ì§€ê¸‰ [ë‹‰ë„¤ì„] [ì•„ì´í…œëª…] [ìˆ˜ëŸ‰]");
        return;
      }

      var t = getUserByName(d, targetName);
      if (!t) { replier.reply("ğŸš« ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
      
      normalizeUserData(t.user); // ê°€ë°© ì•ˆì „ ì´ˆê¸°í™”

      var logMsg = "";

      // [A] ê¸°ë³¸ ìì› (ì½”ì¸ ì¶”ê°€ë¨)
      if (itemKey === "ê³¨ë“œ") { t.user.gold += amount; logMsg = "ê³¨ë“œ"; }
      else if (["ì½”ì¸", "ë‹¤ì½”íƒ€ì½”ì¸", "ë‹¤ì½”íƒ€"].indexOf(itemKey) !== -1) { 
          t.user.dakotaCoin = (t.user.dakotaCoin || 0) + amount; 
          logMsg = "ë‹¤ì½”íƒ€ ì½”ì¸"; 
      }
      else if (itemKey === "ê²½í—˜ì¹˜") { t.user.trainerExp += amount; logMsg = "ê²½í—˜ì¹˜"; }
      else if (itemKey === "ë ˆë²¨") { t.user.trainerLv = Math.min(MAX_LV, t.user.trainerLv + amount); logMsg = "ë ˆë²¨"; }
      
      // [B] ì†Œëª¨í’ˆ (ë§¤í•‘)
      else if (["ëª¬ìŠ¤í„°ë³¼","ëª¬","ã…"].indexOf(itemKey) !== -1) { t.user.ball += amount; logMsg = "ëª¬ìŠ¤í„°ë³¼"; }
      else if (["ìŠˆí¼ë³¼","ìŠˆ","ã……"].indexOf(itemKey) !== -1) { t.user.superBall += amount; logMsg = "ìŠˆí¼ë³¼"; }
      else if (["í•˜ì´í¼ë³¼","í•˜","ã…"].indexOf(itemKey) !== -1) { t.user.ultraBall += amount; logMsg = "í•˜ì´í¼ë³¼"; }
      else if (itemKey.indexOf("í‚¹ê°“") !== -1) { t.user.godBall = (t.user.godBall||0) + amount; logMsg = "í‚¹ê°“ë³¼"; }
      else if (["ë„íŒŒë¯¼","ê°•í™”ê¶Œ"].indexOf(itemKey) !== -1) { t.user.dopaTicket += amount; logMsg = "ë„íŒŒë¯¼ê°•í™”ê¶Œ"; }
      else if (["ë‘ì«€ì¿ ","ì¿ í‚¤"].indexOf(itemKey) !== -1) { t.user.cookie += amount; logMsg = "ë‘ì«€ì¿ "; }
      else if (["í‹°ì–´ë¦¬ì…‹","ë¦¬ì…‹"].indexOf(itemKey) !== -1) { t.user.reroll += amount; logMsg = "í‹°ì–´ë¦¬ì…‹ê¶Œ"; }
      else if (["ì´ë™í‹°ì¼“","í‹°ì¼“"].indexOf(itemKey) !== -1) { t.user.ticket += amount; logMsg = "ì´ë™í‹°ì¼“"; }

      // [C] â˜… ë‹¤ì½”íƒ€ ì•„ì´í…œ (ì‹ ê·œ ì¶”ê°€)
      // ì•„ì´í…œ ê°€ë°©(u.items)ì— ì§ì ‘ ë„£ì–´ì¤ë‹ˆë‹¤.
      else if (["ì¥ë¹„ìƒì", "ìƒì", "ë³´ë¬¼ìƒì"].indexOf(itemKey) !== -1) { 
          if (!t.user.items) t.user.items = {};
          t.user.items["ì¥ë¹„ìƒì"] = (t.user.items["ì¥ë¹„ìƒì"] || 0) + amount; 
          logMsg = "ğŸ“¦ ì¥ë¹„ìƒì"; 
      }
      else if (["ìƒìíŒŒí¸", "íŒŒí¸"].indexOf(itemKey) !== -1) { 
          if (!t.user.items) t.user.items = {};
          t.user.items["ìƒìíŒŒí¸"] = (t.user.items["ìƒìíŒŒí¸"] || 0) + amount; 
          logMsg = "ğŸ§© ìƒìíŒŒí¸"; 
      }
      else if (["ë”¸ê¸°ì¿ í‚¤", "ë”¸ê¸°", "ë”¸ì«€ì¿ "].indexOf(itemKey) !== -1) { 
          if (!t.user.items) t.user.items = {};
          t.user.items["ë”¸ê¸°ì¿ í‚¤"] = (t.user.items["ë”¸ê¸°ì¿ í‚¤"] || 0) + amount; 
          logMsg = "ğŸ“ ë”¸ê¸°ì¿ í‚¤"; 
      }
      else if (["í™©ê¸ˆì—´ë§¤", "ì—´ë§¤", "ë¼ì¦ˆì—´ë§¤"].indexOf(itemKey) !== -1) { 
          if (!t.user.items) t.user.items = {};
          t.user.items["í™©ê¸ˆì—´ë§¤"] = (t.user.items["í™©ê¸ˆì—´ë§¤"] || 0) + amount; 
          logMsg = "ğŸ¥œ í™©ê¸ˆì—´ë§¤"; 
      }
      else if (["í™©ê¸ˆí˜ì¸íŠ¸", "í˜ì¸íŠ¸", "ì´ë¡œì¹˜"].indexOf(itemKey) !== -1) { 
          if (!t.user.items) t.user.items = {};
          t.user.items["í™©ê¸ˆí˜ì¸íŠ¸"] = (t.user.items["í™©ê¸ˆí˜ì¸íŠ¸"] || 0) + amount; 
          logMsg = "ğŸ¨ í™©ê¸ˆí˜ì¸íŠ¸"; 
      }

      // [D] ì¥ë¹„ ì•„ì´í…œ (EQUIP_DB ìë™ ì¸ì‹)
      else if (EQUIP_DB[itemKey]) {
          if (!t.user.items) t.user.items = {};
          t.user.items[itemKey] = (t.user.items[itemKey] || 0) + amount;
          var icon = EQUIP_DB[itemKey].icon || "ğŸ›¡ï¸";
          logMsg = icon + " " + itemKey;
      }
      else {
          replier.reply("ğŸš« ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì•„ì´í…œì…ë‹ˆë‹¤: " + itemKey); return;
      }

      commitSave(true);
      replier.reply("âœ… ì§€ê¸‰ ì™„ë£Œ: " + t.name + " ë‹˜ì—ê²Œ [" + logMsg + "] x" + amount);
      return;
    }


    // -------------------- 4. [ì „ì²´ë³´ìƒ] (ì¥ë¹„ í¬í•¨) --------------------
    if (sub === "ì „ì²´ë³´ìƒ") {
      var itemKey = parts[2];
      var amount = parseInt(parts[3], 10);
      if (!itemKey || isNaN(amount)) { replier.reply("ì‚¬ìš©ë²•: /ê´€ë¦¬ì ì „ì²´ë³´ìƒ [ì•„ì´í…œ] [ìˆ˜ëŸ‰]"); return; }

      var count = 0;
      var isEquip = !!EQUIP_DB[itemKey]; 

      for (var name in d.users) {
        var uTarget = d.users[name];
        normalizeUserData(uTarget); 

        if (itemKey === "ê³¨ë“œ") uTarget.gold += amount;
        else if (["ë„íŒŒë¯¼","ê°•í™”ê¶Œ"].includes(itemKey)) uTarget.dopaTicket += amount;
        else if (["ë‘ì«€ì¿ ","ì¿ í‚¤"].includes(itemKey)) uTarget.cookie += amount;
        else if (["í‹°ì–´ë¦¬ì…‹","ë¦¬ì…‹"].includes(itemKey)) uTarget.reroll += amount;
        else if (["ì´ë™í‹°ì¼“","í‹°ì¼“"].includes(itemKey)) uTarget.ticket += amount;
        else if (itemKey.indexOf("í‚¹ê°“") !== -1) uTarget.godBall = (uTarget.godBall||0) + amount;
        else if (isEquip) {
            uTarget.items[itemKey] = (uTarget.items[itemKey] || 0) + amount;
        }
        else { 
            if (itemKey === "ëª¬ìŠ¤í„°ë³¼") uTarget.ball += amount;
            else continue;
        }
        count++;
      }
      commitSave(true);
      replier.reply("ğŸ“¢ ì „ì²´ ë³´ìƒ ì§€ê¸‰ ì™„ë£Œ (" + count + "ëª…)\në‚´ìš©: " + itemKey + " x" + amount);
      return;
    }

    // -------------------- 5. [í¬ì¼“ëª¬ ê´€ë¦¬] --------------------
    if (sub === "ìŠ¤í°" || sub === "ìŠ¤í°ì˜ˆì•½") {
       var tName = parts[2]; var pName = parts[3]; var shinyOpt = parts[4];
       var t = getUserByName(d, tName);
       if(!t) { replier.reply("ìœ ì € ì—†ìŒ"); return; }
       var db = findPokemonDBByName(pName);
       if(!db) { replier.reply("í¬ì¼“ëª¬ ì—†ìŒ"); return; }
       t.user.nextSpawnPid = db.id;
       t.user.nextSpawnShiny = (shinyOpt === "Y" || shinyOpt === "y");
       commitSave(true);
       replier.reply("ğŸ“ ìŠ¤í° ì˜ˆì•½: " + t.name + " -> " + db.name + (t.user.nextSpawnShiny?"(âœ¨)":""));
       return;
    }

    if (sub === "í¬ì¼“ëª¬ì§€ê¸‰") {
       var tName = parts[2]; var pName = parts[3];
       var t = getUserByName(d, tName);
       if (!t) { replier.reply("ìœ ì € ì—†ìŒ"); return; }
       var db = isNaN(parseInt(pName)) ? findPokemonDBByName(pName) : findPokemonDB(pName);
       if (!db) { replier.reply("í¬ì¼“ëª¬ ì—†ìŒ"); return; }
       var uid = addPokemonToUser(t.user, db.id);
       commitSave(true);
       replier.reply("âœ… í¬ì¼“ëª¬ ì§€ê¸‰: " + t.name + " -> " + db.name + " (#" + uid + ")");
       return;
    }

    if (sub === "ì‚­ì œ") {
       var tName = parts[2]; var uid = parseInt((parts[3]||"").replace("#",""), 10);
       var t = getUserByName(d, tName);
       if (!t) return;
       var arr = t.user.pokemons;
       for(var i=0; i<arr.length; i++) {
          if (arr[i].uid === uid) {
             var delName = getDisplayName(arr[i]);
             arr.splice(i, 1);
             commitSave(true);
             replier.reply("ğŸ—‘ï¸ ì‚­ì œ ì™„ë£Œ: " + t.name + "ì˜ " + delName);
             return;
          }
       }
       replier.reply("UID ëª» ì°¾ìŒ");
       return;
    }

    // -------------------- 6. [ì—ë””íŠ¸: ì ì¬ë ¥/ê°•í™”/ì´ë¡œì¹˜] --------------------
    if (sub === "ì ì¬ë ¥") {
       var tName = parts[2]; var uid = parseInt(parts[3], 10);
       var str = parseInt(parts[4]); var hp = parseInt(parts[5]); var spd = parseInt(parts[6]);
       var t = getUserByName(d, tName);
       if(!t || isNaN(str)) { replier.reply("ì‚¬ìš©ë²•: /ê´€ë¦¬ì ì ì¬ë ¥ [ë‹‰] [UID] [í˜] [ì²´] [ë¯¼]"); return; }
       var p = findUserPokemonByUid(t.user, uid);
       if(!p) { replier.reply("í¬ì¼“ëª¬ ì—†ìŒ"); return; }
       p.ivStr = str; p.ivHp = hp; p.ivSpd = spd;
       // ë“±ê¸‰ ì¬ê³„ì‚°
       var score = str + Math.floor(hp/10) + spd;
       if (score >= 38) p.grade = "S";
       else if (score >= 28) p.grade = "A";
       else if (score >= 19) p.grade = "B";
       else if (score >= 10) p.grade = "C";
       else p.grade = "D";
       commitSave(true);
       replier.reply("ğŸ’ª ì ì¬ë ¥ ë³€ê²½ ì™„ë£Œ: " + getDisplayName(p) + " (" + p.grade + ")");
       return;
    }

    if (sub === "ê°•í™”") {
       var tName = parts[2]; var uid = parseInt(parts[3], 10); var val = parseInt(parts[4], 10);
       var t = getUserByName(d, tName);
       if(!t) return;
       var p = findUserPokemonByUid(t.user, uid);
       if(!p) return;
       p.enh = val;
       if(typeof tryAutoEvolveByEnh === "function") tryAutoEvolveByEnh(p);
       commitSave(true);
       replier.reply("ğŸ› ï¸ ê°•í™” ìˆ˜ì¹˜ ë³€ê²½: " + val + "ê°•");
       return;
    }

    if (sub === "ì´ë¡œì¹˜") {
       var tName = parts[2]; var uid = parseInt(parts[3], 10);
       var t = getUserByName(d, tName);
       if(!t) return;
       var p = findUserPokemonByUid(t.user, uid);
       if(!p) { replier.reply("í¬ì¼“ëª¬ ì—†ìŒ"); return; }
       p.shiny = !p.shiny;
       commitSave(true);
       replier.reply("âœ¨ ì´ë¡œì¹˜ ìƒíƒœ ë³€ê²½: " + (p.shiny ? "ON" : "OFF"));
       return;
    }

    // -------------------- 7. [ì„œë²„ ê´€ë¦¬] --------------------
    if (sub === "ê³µì§€") {
      var text = msg.replace("/ê´€ë¦¬ì ê³µì§€", "").trim();
      addAdminLog(d, sender, "ê³µì§€: " + text);
      commitSave(true);
      replier.reply("ğŸ“¢ [ê³µì§€ì‚¬í•­]\n\n" + text);
      return;
    }
    
    if (sub === "ì €ì¥") { saveData(d); replier.reply("ğŸ’¾ ì €ì¥ ì™„ë£Œ"); return; }
    
    if (sub === "ë°ì´í„°ì •ë¦¬") {
        var res = manageInactiveUsers(d);
        replier.reply(res);
        return;
    }

    if (sub === "ê³„ì •ì´ë™") {
      var oldName = parts[2]; var newName = parts[3];
      if (!d.users[oldName]) { replier.reply("êµ¬ ë‹‰ë„¤ì„ ë°ì´í„° ì—†ìŒ"); return; }
      d.users[newName] = JSON.parse(JSON.stringify(d.users[oldName]));
      delete d.users[oldName];
      commitSave(true);
      replier.reply("âœ… ê³„ì • ì´ë™ ì™„ë£Œ: " + oldName + " -> " + newName);
      return;
    }

    if (sub === "ì „ì ì´ˆê¸°í™”") {
      var target = parts[2];
      if (target) {
         var t = getUserByName(d, target);
         if(t) { resetBattleStats(t.user); replier.reply(t.name + " ì „ì  ì´ˆê¸°í™” ì™„ë£Œ"); }
      } else {
         var n = resetBattleStatsAll(d);
         replier.reply("ì „ì²´ ìœ ì €(" + n + "ëª…) ì „ì  ì´ˆê¸°í™” ì™„ë£Œ");
      }
      commitSave(true);
      return;
    }

    // [ê¸°íƒ€] ì¡°íšŒ ë“±
    if (sub === "ì¡°íšŒ") {
      var t = getUserByName(d, parts[2]);
      if (!t) { replier.reply("ìœ ì € ì—†ìŒ"); return; }
      var uInfo = t.user;
      replier.reply("ğŸ” " + t.name + "\nê³¨ë“œ: " + fmtNum(uInfo.gold) + "\në„íŒŒë¯¼: " + uInfo.dopaTicket + "\ní¬ì¼“ëª¬: " + uInfo.pokemons.length);
      return;
    }
    
    // [ì„¤ì •] ì „ì—­ì„¤ì • ë“±
    if (sub === "ì „ì—­ì¡°íšŒ") { replier.reply(globalConfigText(d)); return; }
    if (sub === "ì „ì—­ì„¤ì •") {
      var key = parts[2]; var val = parseInt(parts[3], 10);
      if (key && key.indexOf("SHOP_PRICE") !== -1) {
          if (key === "SHOP_PRICE_BALL") setShopPrice(d, "BALL", val);
          else if (key === "SHOP_PRICE_SUPER") setShopPrice(d, "SUPER", val);
          else if (key === "SHOP_PRICE_ULTRA") setShopPrice(d, "ULTRA", val);
          else if (key === "SHOP_PRICE_DOPA") setShopPrice(d, "DOPA", val);
          else { replier.reply("ì•Œ ìˆ˜ ì—†ëŠ” í‚¤"); return; }
      }
      commitSave(true);
      replier.reply("âœ… ì„¤ì • ì™„ë£Œ: " + key + " = " + val);
      return;
    }

    replier.reply("ì•Œ ìˆ˜ ì—†ëŠ” ëª…ë ¹ì–´ì…ë‹ˆë‹¤. '/ê´€ë¦¬ì ë„ì›€'ì„ í™•ì¸í•˜ì„¸ìš”.");
    return;
  }


     // -------------------- [ë³µêµ¬ ì‹œìŠ¤í…œ] ì•„ì¹´ì´ë¸Œ í™•ì¸ (ìˆ˜ì •ë¨) --------------------
  if (!d.users[sender]) {
    var archivePath = "/sdcard/mbot_pokemon_archive.json"; 
    var file = new java.io.File(archivePath); // íŒŒì¼ ê°ì²´ ìƒì„±

    // [í•µì‹¬ ìˆ˜ì •] íŒŒì¼ì´ ìˆì„ ë•Œë§Œ ì½ê¸° ì‹œë„
    if (file.exists()) {
      var archiveStr = File.read(archivePath);
      if (archiveStr) {
        try {
          var archive = JSON.parse(archiveStr);
          if (archive[sender]) {
            // ë³µêµ¬ ì§„í–‰
            d.users[sender] = archive[sender];
            d.users[sender].lastDate = new Date().getTime();
            
            delete archive[sender];
            File.save(archivePath, JSON.stringify(archive)); // êº¼ëƒˆìœ¼ë‹ˆ íŒŒì¼ ê°±ì‹ 
            
            commitSave(true);
            replier.reply("ğŸ“¦ íœ´ë©´ ê³„ì •ì´ì—ˆë˜ " + sender + "ë‹˜ì˜ ë°ì´í„°ë¥¼ ë³µêµ¬í–ˆìŠµë‹ˆë‹¤!\në‹¤ì‹œ ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤! ğŸ‰");
          }
        } catch (e) { /* íŒŒì‹± ì—ëŸ¬ ë¬´ì‹œ */ }
      }
    }
  }
  // ------------------------------------------------------------------
  if (msg === "/íšŒì›ê°€ì…") {
    if (ensureUser(d, sender)) {
      commitSave(true);
      replier.reply("íšŒì›ê°€ì… ì™„ë£Œ!\n/í•„ë“œ ë¡œ í¬ì¼“ëª¬ì„ ë§Œë‚˜ë³´ì„¸ìš”.");
    } else {
      replier.reply("ì´ë¯¸ íšŒì›ì…ë‹ˆë‹¤.");
    }
    return;
  }
  var u = d.users[sender];
  if (!u) {
    replier.reply("ë¨¼ì € /íšŒì›ê°€ì… ì„ í•´ì£¼ì„¸ìš”.");
    return;
  }

normalizeUserData(u);
  // â˜… ì—¬ê¸°ì— dë¥¼ ì¶”ê°€í•´ì„œ í•¨ìˆ˜ì— ë„˜ê²¨ì¤ë‹ˆë‹¤!
  var decoName = getDecoratedName(d, u, sender); 
  
  // âœ… ì‹ ê·œ íšŒì›ê°€ì… ë³´ìƒ (ë”± 1íšŒ)
  var joinMsg = grantSignupBonusIfNeeded(u, sender);
  if (joinMsg) {
    replier.reply(joinMsg);
    commitSave(true);
  }

// -------------------- [ìˆ˜ì •ë¨] /ë‚´ì •ë³´ (ë‹¤ì½”íƒ€ ì½”ì¸ ì¶”ê°€) --------------------
  if (msg === "/ë‚´ì •ë³´") {
    ensureUserStats(u);
    // EXP ì§„í–‰ë¥ 
    var need = expNeed(u.trainerLv);
    var cur = u.trainerExp;
    var pctExp = (need <= 0) ? 0 : Math.floor((cur / need) * 1000) / 10;
    
    // ê°„ë‹¨ ì§„í–‰ ë°” (10ì¹¸)
    var barN = 10;
    var filled = Math.max(0, Math.min(barN, Math.floor((cur / need) * barN)));
    var bar = "";
    for (var i = 0; i < barN; i++) bar += (i < filled ? "â– " : "â–¡");
    
    // ì „ì /ë­í¬
    var w = u.stats.battleWin, l = u.stats.battleLose, d0 = u.stats.battleDraw;
    var total = w + l + d0;
    var winRate = (total === 0) ? 0 : Math.floor((w / total) * 1000) / 10;
    
    // ë„ê° ìˆ˜ì§‘ë¥ 
    ensureUserDex(u);
    var uniqueCaught = 0;
    for (var i = 0; i < POKEMON_DB.length; i++) {
      var pid = String(POKEMON_DB[i].id);
      var rec = u.dex[pid] || { seen: 0, caught: 0 };
      if (rec.caught > 0) uniqueCaught++;
    }
    var dexRate = (POKEMON_DB.length === 0) ? 0 : Math.floor((uniqueCaught / POKEMON_DB.length) * 1000) / 10;

    // ë°°ì§€ ëª©ë¡
    var badgesStr = "";
    if (!u.badges) u.badges = [];
    for (var k = 0; k < GYM_LEADERS.length; k++) {
        var g = GYM_LEADERS[k];
        if (u.badges.indexOf(g.badge) !== -1) badgesStr += g.badge + " ";
    }
    if (badgesStr === "") badgesStr = "(ì—†ìŒ)";

    var out = "";
    out += "ğŸ‘¤ " + decoName + "ë‹˜ì˜ íŠ¸ë ˆì´ë„ˆ ì •ë³´\n\n";
    out += "Lv." + u.trainerLv + " (" + pctExp + "%)\n";
    out += bar + "  " + cur + "/" + need + " EXP\n\n";
    
    // â˜… [ìˆ˜ì •] ì¬í™” ì •ë³´ì— ì½”ì¸ ì¶”ê°€
    out += "[ë³´ìœ  ì¬í™”]\n";
    out += "ğŸ’° ê³¨ë“œ: " + fmtNum(u.gold) + "ğŸ’°\n";
    out += "ğŸª™ íƒ€ì½”íƒ€ ì½”ì¸: " + fmtNum(u.dakotaCoin || 0) + "ê°œ\n\n";
    
    out += "ğŸ–ï¸ ë°°ì§€: " + badgesStr + "\n\n";
    
    out += "ğŸ¾ ì»¬ë ‰ì…˜\n";
    out += "ë³´ìœ  í¬ì¼“ëª¬: " + u.pokemons.length + "ë§ˆë¦¬\n";
    out += "ë„ê°: " + uniqueCaught + "/" + POKEMON_DB.length + " (" + dexRate + "%)\n\n";
    
    out += "âš”ï¸ ë°°í‹€\n";
    out += "ì „ì : " + w + "ìŠ¹ " + l + "íŒ¨" + (d0 > 0 ? (" " + d0 + "ë¬´") : "") + "\n";
    out += "ìŠ¹ë¥ : " + winRate + "% | ì—°ìŠ¹: " + u.stats.battleStreak + " | ë­í‚¹ì ìˆ˜: " + battleScoreRank(u);
    
    replier.reply(out);
    commitSave(false);
    return;
  }

  // -------------------- [ì‹ ê·œ] /ë‚´ì§€ê°‘ (ì¬í™” ìƒíƒœ í™•ì¸) --------------------
  if (msg === "/ë‚´ì§€ê°‘" || msg === "/ì§€ê°‘" || msg === "/ëˆ") {
      var coin = u.dakotaCoin || 0;
      
      replier.reply(
          "ğŸ‘› " + decoName + "ë‹˜ì˜ ì§€ê°‘\n" +
          "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
          "ğŸ’° ê³¨ë“œ : " + fmtNum(u.gold) + "ğŸ’°\n" +
          "ğŸª™ ë‹¤ì½”íƒ€ ì½”ì¸ : " + fmtNum(coin) + "ê°œ\n" +
          "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
          "ğŸ’¡ ì½”ì¸ì€ ë ˆì´ë“œ ë³´ìƒìœ¼ë¡œ íšë“ ê°€ëŠ¥í•©ë‹ˆë‹¤."
      );
      return;
  }

  // -------------------- [ìˆ˜ì •ë¨] /ì •ë³´ (ë°°ì§€ í‘œì‹œ ì¶”ê°€ ì™„ë£Œ) --------------------
  if (msg.indexOf("/ì •ë³´") === 0) {
    var t = getTargetFromMsg(d, sender, msg, "/ì •ë³´");
    if (!t) {
      replier.reply("í•´ë‹¹ ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }
    var target = t.user;
    var targetName = t.name;
    
    ensureUserStats(target);
    ensureUserDex(target);
    
    // EXP ì§„í–‰ë¥ 
    var need = expNeed(target.trainerLv);
    var cur = target.trainerExp;
    var pctExp = (need <= 0) ? 0 : Math.floor((cur / need) * 1000) / 10;
    
    // ê°„ë‹¨ ì§„í–‰ ë°”
    var barN = 10;
    var filled = (need <= 0) ? 0 : Math.max(0, Math.min(barN, Math.floor((cur / need) * barN)));
    var bar = "";
    for (var i = 0; i < barN; i++) bar += (i < filled ? "â– " : "â–¡");
    
    // ì „ì 
    var w = target.stats.battleWin, l = target.stats.battleLose, d0 = target.stats.battleDraw;
    var total = w + l + d0;
    var winRate = (total === 0) ? 0 : Math.floor((w / total) * 1000) / 10;
    
    // ë„ê°
    var uniqueCaught = 0;
    for (var j = 0; j < POKEMON_DB.length; j++) {
      var pid = String(POKEMON_DB[j].id);
      var rec = target.dex[pid] || { seen: 0, caught: 0 };
      if (rec.caught > 0) uniqueCaught++;
    }
    var dexRate = (POKEMON_DB.length === 0) ? 0 : Math.floor((uniqueCaught / POKEMON_DB.length) * 1000) / 10;

    // â˜… [ì¶”ê°€ë¨] ë°°ì§€ ëª©ë¡ ìƒì„± ë¡œì§
    var badgesStr = "";
    if (!target.badges) target.badges = [];
    for (var k = 0; k < GYM_LEADERS.length; k++) {
        var g = GYM_LEADERS[k];
        if (target.badges.indexOf(g.badge) !== -1) badgesStr += g.badge + " ";
    }
    if (badgesStr === "") badgesStr = "(ì—†ìŒ)";

    var out = "";
    out += "ğŸ‘¤ " + targetName + "ë‹˜ì˜ íŠ¸ë ˆì´ë„ˆ ì •ë³´\n\n";
    out += "Lv." + target.trainerLv + " (" + pctExp + "%)\n";
    out += bar + "  " + cur + "/" + need + " EXP\n\n";
    
    out += "ğŸ’° ì¬í™”: " + fmtNum(target.gold) + "ğŸ’°\n";
    
    // â˜… [ì¶”ê°€ë¨] ë°°ì§€ ì¶œë ¥
    out += "ğŸ–ï¸ ë°°ì§€: " + badgesStr + "\n\n";
    
    out += "ğŸ¾ ì»¬ë ‰ì…˜\n";
    out += "ë³´ìœ  í¬ì¼“ëª¬: " + (target.pokemons ? target.pokemons.length : 0) + "ë§ˆë¦¬\n";
    out += "ë„ê°: " + uniqueCaught + "/" + POKEMON_DB.length + " (" + dexRate + "%)\n\n";
    
    out += "âš”ï¸ ë°°í‹€\n";
    out += "ì „ì : " + w + "ìŠ¹ " + l + "íŒ¨" + (d0 > 0 ? (" " + d0 + "ë¬´") : "") + "\n";
    out += "ìŠ¹ë¥ : " + winRate + "% | ì—°ìŠ¹: " + target.stats.battleStreak + " | ë­í‚¹ì ìˆ˜: " + battleScoreRank(target);
    
    replier.reply(out);
    commitSave(false);
    return;
  }

  // -------------------- [ìˆ˜ì •ë¨] ë‚´ê°€ë°© (ë‹¤ì½”íƒ€ ì•„ì´í…œ ì„¹ì…˜ ì¶”ê°€) --------------------
  if (msg === "/ë‚´ê°€ë°©") {
    var list = "";
    list += "ğŸ”´ ëª¬ìŠ¤í„°ë³¼: " + fmtNum(u.ball) + "ê°œ\n";
    list += "ğŸ”µ ìŠˆí¼ë³¼: " + fmtNum(u.superBall) + "ê°œ\n";
    list += "âš« í•˜ì´í¼ë³¼: " + fmtNum(u.ultraBall) + "ê°œ\n";
    list += "ğŸ‘‘ í‚¹ê°“ë³¼: " + fmtNum(u.godBall || 0) + "ê°œ\n"; 
    list += "ğŸ’³ ë„íŒŒë¯¼ê°•í™”ê¶Œ: " + fmtNum(u.dopaTicket) + "ì¥\n";
    list += "ğŸª ë‘ì«€ì¿ (í™•ì •ê°•í™”): " + fmtNum(u.cookie) + "ê°œ\n";
    list += "ğŸ« ì´ë™í‹°ì¼“: " + fmtNum(u.ticket) + "ì¥\n";
    list += "ğŸ”„ í‹°ì–´ë¦¬ì…‹ê¶Œ: " + fmtNum(u.reroll) + "ì¥";

    // [ì‹ ê·œ] ë‹¤ì½”íƒ€ ì•„ì´í…œ ëª©ë¡ (u.itemsì— ìˆì§€ë§Œ EQUIP_DBì—ëŠ” ì—†ëŠ” ê²ƒë“¤)
    var dakotaList = [];
    var specialItems = ["ì¥ë¹„ìƒì", "ìƒìíŒŒí¸", "ë”¸ê¸°ì¿ í‚¤", "í™©ê¸ˆì—´ë§¤", "í™©ê¸ˆí˜ì¸íŠ¸"];
    
    // ì•ˆì „ì¥ì¹˜
    if (!u.items) u.items = {};

    if ((u.items["ì¥ë¹„ìƒì"]||0) > 0) dakotaList.push("ğŸ“¦ ì¥ë¹„ìƒì: " + u.items["ì¥ë¹„ìƒì"] + "ê°œ");
    if ((u.items["ìƒìíŒŒí¸"]||0) > 0) dakotaList.push("ğŸ§© ìƒìíŒŒí¸: " + u.items["ìƒìíŒŒí¸"] + "ê°œ (10ê°œ ëª¨ìœ¼ë©´ ìƒì!)");
    if ((u.items["ë”¸ê¸°ì¿ í‚¤"]||0) > 0) dakotaList.push("ğŸ“ ë”¸ê¸°ì¿ í‚¤: " + u.items["ë”¸ê¸°ì¿ í‚¤"] + "ê°œ (+3ê°•)");
    if ((u.items["í™©ê¸ˆì—´ë§¤"]||0) > 0) dakotaList.push("ğŸ¥œ í™©ê¸ˆì—´ë§¤: " + u.items["í™©ê¸ˆì—´ë§¤"] + "ê°œ (ì ì¬ë ¥MAX)");
    if ((u.items["í™©ê¸ˆí˜ì¸íŠ¸"]||0) > 0) dakotaList.push("ğŸ¨ í™©ê¸ˆí˜ì¸íŠ¸: " + u.items["í™©ê¸ˆí˜ì¸íŠ¸"] + "ê°œ (ì´ë¡œì¹˜)");

    if (dakotaList.length > 0) {
        list += "\n\n[ë‹¤ì½”íƒ€ ë³´ê´€í•¨]\n" + dakotaList.join("\n");
    }

    // [ê¸°ì¡´] ì¥ì°© ì¥ë¹„ ëª©ë¡ (EQUIP_DBì— ìˆëŠ” ê²ƒë§Œ)
    var equipList = [];
    for (var key in u.items) {
        // ë‹¤ì½”íƒ€ ì•„ì´í…œì€ ìœ„ì—ì„œ ì²˜ë¦¬í–ˆìœ¼ë‹ˆ ê±´ë„ˆëœ€
        if (specialItems.indexOf(key) !== -1) continue; 
        
        if (u.items[key] > 0) {
            var item = EQUIP_DB[key];
            if (!item) continue; 
            
            var icon = item.icon || "ğŸ›¡ï¸";
            var dName = key;
            if (item.tier === 3) dName = "ã€" + dName + "ã€"; // í‹°ì–´3 ê°•ì¡°
            
            equipList.push(icon + " " + dName + ": " + u.items[key] + "ê°œ");
        }
    }
    
    if (equipList.length > 0) {
        list += "\n\n[ì¥ë¹„ ë³´ê´€í•¨]\n" + equipList.join("\n");
    } else {
        list += "\n\n[ì¥ë¹„ ë³´ê´€í•¨]\n(ë¹„ì–´ìˆìŒ)";
    }

    replier.reply("ğŸ’ " + sender + "ë‹˜ì˜ ê°€ë°©\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + list);
    return;
  }

   // ==================================================================
  // ğŸ’ [í†µí•©] ì•„ì´í…œ ì‚¬ìš© ì‹œìŠ¤í…œ (ìƒìê¹¡ ë²„ê·¸ ìˆ˜ì •íŒ)
  // ==================================================================
  if (msg.indexOf("/ì‚¬ìš©") === 0) {
    var parts = msg.split(" ").filter(Boolean);
    var itemCmd = parts[1]; 
    
    // -----------------------------------------------------------
    // [A] ë‹¤ì½”íƒ€ì˜ ë³´ë¬¼ìƒì (ê°€ì±  & íŒŒí¸ ì‹œìŠ¤í…œ)
    // -----------------------------------------------------------
    if (itemCmd === "ìƒì" || itemCmd === "ë³´ë¬¼ìƒì" || itemCmd === "ì¥ë¹„ìƒì") {
        var qty = parseInt(parts[2], 10); 
        if (isNaN(qty)) qty = 1;
        
        if (!u.items || !u.items["ì¥ë¹„ìƒì"] || u.items["ì¥ë¹„ìƒì"] < qty) {
            replier.reply("ğŸ 'ì¥ë¹„ìƒì'ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.\në³´ìœ : " + (u.items ? (u.items["ì¥ë¹„ìƒì"]||0) : 0) + "ê°œ");
            return;
        }

        // ìƒì ì°¨ê°
        u.items["ì¥ë¹„ìƒì"] -= qty;
        if (u.items["ì¥ë¹„ìƒì"] <= 0) delete u.items["ì¥ë¹„ìƒì"];

        var resultLog = "";
        var getItems = {}; 
        var fragmentCount = 0; 

        // â˜… [ìˆ˜ì •] í‹°ì–´ë³„ ì•„ì´í…œ ë¶„ë¥˜ ë¡œì§ ê°•í™”
        var t1 = [], t2 = [], t3 = [];
        
        for (var k in EQUIP_DB) {
            var item = EQUIP_DB[k];
            var tier = item.tier || 1;

            // [ìë™ ë³´ì •] 'type_boost'(ì†ì„±êµ¬ìŠ¬)ëŠ” 2í‹°ì–´ë¡œ ì·¨ê¸‰!
            if (!item.tier && item.type === "type_boost") {
                tier = 2;
            }

            if (tier === 3) t3.push(k);
            else if (tier === 2) t2.push(k);
            else t1.push(k);
        }

        // ì•ˆì „ì¥ì¹˜: í˜¹ì‹œë¼ë„ ë°°ì—´ì´ ë¹„ì–´ìˆìœ¼ë©´ 1í‹°ì–´ë¡œ ì±„ì›€ (ì—ëŸ¬ ë°©ì§€)
        if (t2.length === 0) t2 = t1.slice();
        if (t3.length === 0) t3 = t1.slice();

        // ë½‘ê¸° ì§„í–‰
        for (var i=0; i<qty; i++) {
            var roll = Math.random(); 
            var picked = "";
            var grade = "";

            // â‘  ì „ì„¤ (3%)
            if (roll < BOX_PROB_TIER_3) { 
                picked = t3[Math.floor(Math.random() * t3.length)];
                grade = "ğŸ‘‘";
            } 
            // â‘¡ í¬ê·€ (17%)
            else if (roll < (BOX_PROB_TIER_3 + BOX_PROB_TIER_2)) { 
                picked = t2[Math.floor(Math.random() * t2.length)];
                grade = "ğŸ”¹";
            } 
            // â‘¢ ì¼ë°˜ (40%)
            else if (roll < (BOX_PROB_TIER_3 + BOX_PROB_TIER_2 + BOX_PROB_TIER_1)) { 
                picked = t1[Math.floor(Math.random() * t1.length)];
                grade = "âšª";
            } 
            // â‘£ íŒŒí¸ (ë‚˜ë¨¸ì§€ 40%)
            else {
                fragmentCount++;
                continue; 
            }
            
            // ì•„ì´í…œ ì ë¦½
            getItems[picked] = (getItems[picked] || 0) + 1;
            resultLog += grade + " " + picked + "\n";
        }

        // --- ê²°ê³¼ ì •ì‚° ---
        for (var key in getItems) {
            u.items[key] = (u.items[key] || 0) + getItems[key];
        }
        
        var autoBox = 0;
        if (fragmentCount > 0) {
            u.items["ìƒìíŒŒí¸"] = (u.items["ìƒìíŒŒí¸"] || 0) + fragmentCount;
            resultLog += "ğŸ§© ìƒìíŒŒí¸ +" + fragmentCount + "ê°œ\n";
            
            if (u.items["ìƒìíŒŒí¸"] >= 10) {
                autoBox = Math.floor(u.items["ìƒìíŒŒí¸"] / 10);
                u.items["ìƒìíŒŒí¸"] %= 10;
                u.items["ì¥ë¹„ìƒì"] = (u.items["ì¥ë¹„ìƒì"] || 0) + autoBox;
            }
        }

        commitSave(true);
        
        var summary = "ğŸ ìƒì " + qty + "ê°œë¥¼ ê°œë´‰í–ˆìŠµë‹ˆë‹¤!\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + 
                      (resultLog || "ğŸ§© íŒŒí¸ë§Œ ì”ëœ© ë‚˜ì™”ìŠµë‹ˆë‹¤...\n");
        
        if (autoBox > 0) {
            summary += "\nâ™»ï¸ íŒŒí¸ 10ê°œë¥¼ ëª¨ì•„ [ì¥ë¹„ìƒì +" + autoBox + "]ê°œë¥¼ í•©ì„±í–ˆìŠµë‹ˆë‹¤!";
        }
        
        replier.reply(summary);
        return;
    }

    // -----------------------------------------------------------
    // [B] ì†Œëª¨í’ˆ ì•„ì´í…œ (UID ëŒ€ìƒ)
    // -----------------------------------------------------------
    var targetUid = parseInt(parts[2], 10);
    
    // ëŒ€ìƒì´ í•„ìš”í•œ ì•„ì´í…œì¸ë° UIDê°€ ì—†ìœ¼ë©´ ì•ˆë‚´
    if (["ë‘ì«€ì¿ ","ì¿ í‚¤","ì´ë™","í‹°ì¼“","í‹°ì–´ë¦¬ì…‹","í‹°ì–´","ë¦¬ì…‹","ë”¸ê¸°","ë”¸ì«€ì¿ ","ì—´ë§¤","í™©ê¸ˆì—´ë§¤","í˜ì¸íŠ¸","í™©ê¸ˆí˜ì¸íŠ¸"].indexOf(itemCmd) !== -1) {
        if (!targetUid && itemCmd.indexOf("ì´ë™") === -1 && itemCmd.indexOf("í‹°ì¼“") === -1) {
             replier.reply("ì‚¬ìš©ë²•: /ì‚¬ìš© [ì•„ì´í…œëª…] [UID]\nì˜ˆ: /ì‚¬ìš© ë”¸ê¸° 15"); 
             return;
        }
    }

    // 1. ë”¸ê¸°ë§› ì«€ë“ ì¿ í‚¤ (ê°•í™” +3)
    if (itemCmd === "ë”¸ê¸°" || itemCmd === "ë”¸ì«€ì¿ " || itemCmd === "ë”¸ê¸°ì¿ í‚¤") {
        if (!u.items || !u.items["ë”¸ê¸°ì¿ í‚¤"] || u.items["ë”¸ê¸°ì¿ í‚¤"] <= 0) { replier.reply("ğŸ“ 'ë”¸ì«€ì¿ 'ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
        
        var p = findUserPokemonByUid(u, targetUid);
        if (!p) { replier.reply("í•´ë‹¹ í¬ì¼“ëª¬ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
        if (isPokemonBusy(u, p.uid)) { replier.reply("íƒí—˜ ì¤‘ì¸ í¬ì¼“ëª¬ì…ë‹ˆë‹¤."); return; }
        if (p.enh >= ENHANCE_MAX) { replier.reply("ì´ë¯¸ ìµœëŒ€ ê°•í™”ì…ë‹ˆë‹¤."); return; }

        u.items["ë”¸ê¸°ì¿ í‚¤"]--;
        var before = p.enh || 0;
        var after = Math.min(ENHANCE_MAX, before + 3);
        p.enh = after;

        commitSave(true);
        var db = findPokemonDB(p.pid);
        replier.reply("ğŸ“ ëƒ ëƒ ! ë”¸ê¸°ë§› ì¿ í‚¤ë¥¼ ë¨¹ì—ˆìŠµë‹ˆë‹¤.\n\nğŸ”¥ ì´ˆê³ ì† ì„±ì¥! " + (db?db.name:"") + "\n" + before + "ê°• â” " + after + "ê°• (+3)");
        return;
    }

    // 2. í™©ê¸ˆ ë¼ì¦ˆì—´ë§¤ (Së“±ê¸‰ + í’€ìŠ¤íƒ¯)
    if (itemCmd === "ì—´ë§¤" || itemCmd === "í™©ê¸ˆì—´ë§¤" || itemCmd === "ë¼ì¦ˆì—´ë§¤") {
        if (!u.items || !u.items["í™©ê¸ˆì—´ë§¤"] || u.items["í™©ê¸ˆì—´ë§¤"] <= 0) { replier.reply("ğŸ¥œ 'í™©ê¸ˆì—´ë§¤'ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
        
        var p = findUserPokemonByUid(u, targetUid);
        if (!p) { replier.reply("í•´ë‹¹ í¬ì¼“ëª¬ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
        if (isPokemonBusy(u, p.uid)) { replier.reply("íƒí—˜ ì¤‘ì¸ í¬ì¼“ëª¬ì…ë‹ˆë‹¤."); return; }
        
        if (p.grade === "S" && p.ivStr === 15 && p.ivHp >= 150 && p.ivSpd === 15) {
            replier.reply("ì´ë¯¸ ì™„ë²½í•œ í¬ì¼“ëª¬ì…ë‹ˆë‹¤."); return;
        }

        u.items["í™©ê¸ˆì—´ë§¤"]--;
        p.grade = "S";
        p.ivStr = 15;
        p.ivHp = 150;
        p.ivSpd = 15;
        
        dexCaught(u, p.pid, "S"); 

        commitSave(true);
        replier.reply("ğŸ¥œ ì „ì„¤ì˜ ì—´ë§¤ë¥¼ ë¨¹ì˜€ìŠµë‹ˆë‹¤!\nì ì¬ë ¥ì´ í­ë°œí•©ë‹ˆë‹¤!\n\nğŸ‘‘ ë“±ê¸‰: [S] í™•ì •\nğŸ’ª í˜: 15 (MAX)\nâ¤ï¸ ì²´ë ¥: 15 (MAX)\nâš¡ ê³µì†: 15 (MAX)");
        return;
    }

    // 3. í™©ê¸ˆ í˜ì¸íŠ¸ (ì´ë¡œì¹˜ ë³€í™˜)
    if (itemCmd === "í˜ì¸íŠ¸" || itemCmd === "í™©ê¸ˆí˜ì¸íŠ¸" || itemCmd === "ì´ë¡œì¹˜") {
        if (!u.items || !u.items["í™©ê¸ˆí˜ì¸íŠ¸"] || u.items["í™©ê¸ˆí˜ì¸íŠ¸"] <= 0) { replier.reply("ğŸ¨ 'í™©ê¸ˆí˜ì¸íŠ¸'ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
        
        var p = findUserPokemonByUid(u, targetUid);
        if (!p) { replier.reply("í•´ë‹¹ í¬ì¼“ëª¬ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
        if (isPokemonBusy(u, p.uid)) { replier.reply("íƒí—˜ ì¤‘ì¸ í¬ì¼“ëª¬ì…ë‹ˆë‹¤."); return; }
        if (p.shiny) { replier.reply("ì´ë¯¸ ì´ë¡œì¹˜ í¬ì¼“ëª¬ì…ë‹ˆë‹¤."); return; }

        u.items["í™©ê¸ˆí˜ì¸íŠ¸"]--;
        p.shiny = true;
        
        ensureUserDex(u);
        if (u.dex[String(p.pid)]) u.dex[String(p.pid)].hasShiny = true;

        commitSave(true);
        checkAndNotifyTitles(u, replier);
        replier.reply("ğŸ¨ ì“±ì‹¹ì“±ì‹¹... í™©ê¸ˆìƒ‰ìœ¼ë¡œ ì¹ í–ˆìŠµë‹ˆë‹¤!\n\nâœ¨ " + getDisplayName(p) + "(ìœ¼)ë¡œ ë³€ì‹  ì„±ê³µ!");
        return;
    }

    // -----------------------------------------------------------
    // [C] ê¸°ì¡´ ì†Œëª¨í’ˆ (ë‘ì«€ì¿ , ì´ë™, í‹°ì–´ë¦¬ì…‹)
    // -----------------------------------------------------------
    
    // 4. ë‘ì«€ì¿  (+1ê°•)
    if (itemCmd === "ë‘ì«€ì¿ " || itemCmd === "ì¿ í‚¤") {
      var uid = parseInt(parts[2], 10);
      if (!u.cookie || u.cookie <= 0) { replier.reply("ğŸª ë‘ì«€ì¿ ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
      var p = findUserPokemonByUid(u, uid);
      if (!p) { replier.reply("í•´ë‹¹ í¬ì¼“ëª¬ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
      if (isPokemonBusy(u, p.uid)) { replier.reply("íƒí—˜ ì¤‘ì…ë‹ˆë‹¤."); return; }
      if (p.enh >= ENHANCE_MAX) { replier.reply("ì´ë¯¸ ìµœëŒ€ ê°•í™”ì…ë‹ˆë‹¤."); return; }

      u.cookie--;
      p.enh++; 
      u.stats.totalCookieUsed = (u.stats.totalCookieUsed || 0) + 1;

      commitSave(true);
      checkAndNotifyTitles(u, replier);
      replier.reply("ğŸª ëƒ ëƒ ... ë‘ì«€ì¿ ë¥¼ ë¨¹ì—ˆìŠµë‹ˆë‹¤!\nğŸ”¥ " + (p.enh-1) + "ê°• â” " + p.enh + "ê°• ì„±ê³µ!");
      return;
    }

    // 5. ì´ë™í‹°ì¼“
    if (itemCmd === "ì´ë™" || itemCmd === "í‹°ì¼“") {
      var regionName = parts[2];
      var validRegions = [];
      for(var i=0; i<REGIONS.length; i++) {
        if (REGIONS[i].key !== "ëƒ¥ì¹˜ì˜ ë°©") validRegions.push(REGIONS[i].key);
      }
      
      if (!regionName || validRegions.indexOf(regionName) === -1) {
        replier.reply("ğŸš« ê°ˆ ìˆ˜ ì—†ëŠ” ì§€ì—­ì…ë‹ˆë‹¤.\nì‚¬ìš©ë²•: /ì‚¬ìš© ì´ë™ [ì§€ì—­ëª…]\nğŸ« ê°€ëŠ¥ ì§€ì—­: " + validRegions.join(", "));
        return;
      }
      if (!u.ticket || u.ticket <= 0) { replier.reply("ğŸ« ì´ë™í‹°ì¼“ì´ ì—†ìŠµë‹ˆë‹¤."); return; }

      u.ticket--;
      u.nextFieldRegion = regionName;
      
      commitSave(true);
      replier.reply("ğŸ« í‹°ì¼“ ì‚¬ìš© ì™„ë£Œ!\nğŸš€ ë‹¤ìŒ '/í•„ë“œ' íƒìƒ‰ ì‹œ [" + regionName + "] ì§€ì—­ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
      return;
    }
    
    // 6. í‹°ì–´ë¦¬ì…‹ê¶Œ
    if (itemCmd === "í‹°ì–´ë¦¬ì…‹" || itemCmd === "í‹°ì–´" || itemCmd === "ë¦¬ì…‹") {
      var uid = parseInt(parts[2], 10);
      if (!u.reroll || u.reroll <= 0) { replier.reply("ğŸ”„ í‹°ì–´ë¦¬ì…‹ê¶Œì´ ì—†ìŠµë‹ˆë‹¤."); return; }
      var p = findUserPokemonByUid(u, uid);
      if (!p) { replier.reply("í•´ë‹¹ í¬ì¼“ëª¬ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
      if (isPokemonBusy(u, p.uid)) { replier.reply("íƒí—˜ ì¤‘ì…ë‹ˆë‹¤."); return; }

      u.reroll--;
      var oldGrade = p.grade || "D";
      var newGrade = generatePokemonGrade(); 
      var newIVs = generateIVsByGrade(newGrade); 
      
      p.grade = newGrade;
      p.ivStr = newIVs.str;
      p.ivHp = newIVs.hp;
      p.ivSpd = newIVs.spd;

      commitSave(true);
      var pShowName = getDisplayName(p); 
      replier.reply("ğŸ”„ ë¦¬ì…‹ ì™„ë£Œ! " + pShowName + "\n[" + oldGrade + "] â” ã€ " + newGrade + " ã€‘ ë“±ê¸‰ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
      return;
    }

    replier.reply(
        "ğŸ“ [ì•„ì´í…œ ì‚¬ìš©ë²•]\n" +
        "ğŸ ìƒìê¹¡: /ì‚¬ìš© ìƒì [ìˆ˜ëŸ‰]\n" +
        "ğŸ“ ë”¸ì«€ì¿ : /ì‚¬ìš© ë”¸ê¸° [UID]\n" +
        "ğŸ¥œ í™©ê¸ˆì—´ë§¤: /ì‚¬ìš© ì—´ë§¤ [UID]\n" +
        "ğŸ¨ í™©ê¸ˆí˜ì¸íŠ¸: /ì‚¬ìš© í˜ì¸íŠ¸ [UID]\n" +
        "ğŸª ë‘ì«€ì¿ : /ì‚¬ìš© ë‘ì«€ì¿  [UID]\n" +
        "ğŸ« ì´ë™: /ì‚¬ìš© ì´ë™ [ì§€ì—­ëª…]\n" +
        "ğŸ”„ í‹°ì–´ë¦¬ì…‹: /ì‚¬ìš© ë¦¬ì…‹ [UID]"
    );
    return;
  }
 
  
  // -------------------- [ìˆ˜ì •ë¨] /ë‚´í¬ì¼“ëª¬ (ì•„ì´ì½˜ ì ìš© Ver.) --------------------
  if (msg === "/ë‚´í¬ì¼“ëª¬") {
    if (!u.pokemons || u.pokemons.length === 0) {
      replier.reply(sender + "ë‹˜ì€ ë³´ìœ í•œ í¬ì¼“ëª¬ì´ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }
    
    ensurePokemonGrades(u);

    var summary = "ğŸ’ " + sender + "ë‹˜ì˜ ë³´ìœ  í¬ì¼“ëª¬\n" + "ì´ " + u.pokemons.length + "ë§ˆë¦¬\n\n" + "ì „ì²´ë³´ê¸°ë¡œ ëª©ë¡ì„ í™•ì¸í•˜ì„¸ìš”.";
    var full = "\n\n[ë³´ìœ  í¬ì¼“ëª¬ ëª©ë¡]\n\n";
    
    var listCopy = u.pokemons.slice(); 
    var sorted = sortPokemonsByPower(listCopy);

    for (var i = 0; i < sorted.length; i++) {
      var p = sorted[i];
      var power = calcBattlePower(p);
      
      var name = getDisplayName(p); 
      var enh = (p.enh && p.enh > 0) ? (p.enh + "ê°•") : "0ê°•";
      var grade = p.grade || "D";
      var gradeStr = "[" + grade + "ë“±ê¸‰]";
      if (grade === "S") gradeStr += " ğŸ‘‘"; 
      
      // â˜… ì¥ë¹„ í‘œì‹œ (í‹°ì–´3ëŠ” ê´„í˜¸ ê°•ì¡°)
      var equipStr = "";
      if (p.equip && EQUIP_DB[p.equip]) {
          var item = EQUIP_DB[p.equip];
          var icon = item.icon || "ğŸ›¡ï¸";
          var pItemName = p.equip;
          
          // í‹°ì–´ 3 (ë„¤ì„ë“œ) ì•„ì´í…œì´ë©´ ê´„í˜¸ ì”Œìš°ê¸°
          if (item.tier === 3) pItemName = "ã€" + pItemName + "ã€";
          
          equipStr = " " + icon + "[" + pItemName + "]";
      }

      
      full += (i + 1) + ". #" + p.uid + " " + name + " " + enh + " | ì „íˆ¬ë ¥ " + power + " | " + gradeStr + equipStr + "\n";
    }

    replyFold(replier, summary, full);
    return;
  }


  // -------------------- [ìˆ˜ì •ë¨] í¬ì¼“ëª¬ ìƒì„¸ ëŠ¥ë ¥ì¹˜ í™•ì¸ (ì¥ë¹„ ì ìš©) --------------------
  if (msg.indexOf("/ìƒíƒœ") === 0 || msg.indexOf("/ëŠ¥ë ¥ì¹˜") === 0) {
    var parts = msg.split(" ").filter(Boolean);
    if (parts.length < 2) {
      replier.reply("ì‚¬ìš©ë²•: /ìƒíƒœ [UID]\nì˜ˆ: /ìƒíƒœ 15");
      return;
    }
    
    var uid = parseInt(parts[1], 10);
    if (isNaN(uid)) { replier.reply("UID ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }

    var p = findUserPokemonByUid(u, uid);
    if (!p) { replier.reply("í•´ë‹¹ í¬ì¼“ëª¬ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }

    var db = findPokemonDB(p.pid);
    if (!db) return;

    // 1. ë“±ê¸‰ ë° ì´ë¦„
    var pName = getDisplayName(p);
    var grade = p.grade || "D";
    // ë“±ê¸‰ í‘œì‹œëŠ” ì•„ê¹Œ ì„¤ì •í•˜ì‹  ìŠ¤íƒ€ì¼ì— ë§ê²Œ
    var gradeStr = "ã€ " + grade + " ë“±ê¸‰ ã€‘" + (grade === "S" ? " ğŸ‘‘" : "");

    // 2. ì¥ë¹„ ì •ë³´ í™•ì¸
    var equipStr = "(ì—†ìŒ)";
    if (p.equip && EQUIP_DB[p.equip]) {
        var icon = EQUIP_DB[p.equip].icon || "ğŸ›¡ï¸";
        equipStr = icon + " " + p.equip;
    }

    // 3. ì‹¤ì „ ìŠ¤íƒ¯ ê³„ì‚° (ì¥ë¹„ íš¨ê³¼ ë°˜ì˜)
    
    // [ì²´ë ¥] calcHPì— p.equip ì „ë‹¬ í•„ìˆ˜!
    var realHP = calcHP(db, p.enh, p.ivHp || 0, p.equip);
    
    // [ê³µê²©ë ¥] ë°°í‹€ ê³µì‹ ì—­ì‚° + ì¥ë¹„ íš¨ê³¼ ì¶”ê°€
    var base = db.basePower;
    var enhBonus = 1 + (p.enh * 0.085);
    var ivBonus = 1 + ((p.ivStr || 0) * 0.015);
    var rMul = rarityBattleMul(db.rarity || 2); 
    var sMul = stageBattleMul(db.id).atk;
    
    var atkVal = base * enhBonus * ivBonus * rMul * sMul;
    
    if (p.shiny) atkVal *= 1.1; // ì´ë¡œì¹˜ ë³´ë„ˆìŠ¤

    // â˜… ì¥ë¹„ ê³µê²©ë ¥ ë³´ë„ˆìŠ¤ ì ìš©
    if (p.equip && EQUIP_DB[p.equip]) {
        var eq = EQUIP_DB[p.equip];
        // 1. ê¹¡ê³µê²©ë ¥ % ì¦ê°€ (í˜ì˜ë¨¸ë¦¬ë  ë“±)
        if (eq.type === "atk_pct") {
            atkVal *= (1 + eq.val);
        }
        // 2. ì†ì„± ë§ì¶¤ ë³´ë„ˆìŠ¤ (ë¶ˆê½ƒêµ¬ìŠ¬ ë“±) - ë‚´ ì†ì„±ê³¼ ë§ìœ¼ë©´ ì ìš©ëœ ìˆ˜ì¹˜ë¡œ í‘œê¸°
        if (eq.type === "type_boost") {
            if (db.type1 === eq.cond || (db.type2 && db.type2 === eq.cond)) {
                atkVal *= (1 + eq.val);
            }
        }
    }
    var realAtk = Math.floor(atkVal);

    // [ìŠ¤í”¼ë“œ] IV + ì¥ë¹„ ë³´ë„ˆìŠ¤
    var realSpd = (p.ivSpd || 0);
    var spdMsg = "";
    if (p.equip && EQUIP_DB[p.equip]) {
        var eq = EQUIP_DB[p.equip];
        if (eq.type === "spd_flat") {
            realSpd += eq.val;
            spdMsg = " (+" + eq.val + " í…œ)";
        }
    }

    // 4. ì¶œë ¥ ë©”ì‹œì§€ êµ¬ì„±
    var out = blockTitle("í¬ì¼“ëª¬ ìƒì„¸ ì •ë³´");
    out += "ğŸ‘¾ " + pName + " (UID: #" + p.uid + ")\n\n";
    out += "ğŸ”¥ ê°•í™”: " + (p.enh || 0) + "ê°•\n";
    out += "ğŸ“Š ë“±ê¸‰: " + gradeStr + "\n";
    out += "ğŸ›¡ï¸ ì¥ë¹„: " + equipStr + "\n";
    out += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n";
    out += "[ì‹¤ì „ ëŠ¥ë ¥ì¹˜ (ì¥ë¹„ ë°˜ì˜)]\n";
    out += "â¤ï¸ ì²´ë ¥ (HP) : " + fmtNum(realHP) + "\n";
    out += "âš”ï¸ ê³µê²©ë ¥ (ATK) : " + fmtNum(realAtk) + "\n";
    out += "âš¡ ìŠ¤í”¼ë“œ (Total) : " + realSpd + spdMsg + "\n";
    out += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n";
    out += "[ì ì¬ë ¥ (IV) - ìˆœìˆ˜ ìŠ¤íƒ¯]\n";
    out += "ğŸ’ª í˜ : " + (p.ivStr||0) + " / 15\n";
    out += "â¤ï¸ ë§·ì§‘ : " + Math.floor((p.ivHp||0)/10) + " / 15\n";
    out += "ğŸ¦¶ ë¯¼ì²© : " + (p.ivSpd||0) + " / 15\n";
    out += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n";

    replier.reply(out);
    return;
  }


// -------------------- /íŒë§¤ í•˜ìœ„ N (íƒí—˜ ë³´í˜¸ ì ìš©) --------------------
if (msg.indexOf("/íŒë§¤ í•˜ìœ„") === 0) {
  var sp = msg.split(" ").filter(Boolean);
  var n = parseInt(sp[2], 10);

  if (isNaN(n) || n <= 0) {
    replier.reply("ì‚¬ìš©ë²•: /íŒë§¤ í•˜ìœ„ 5");
    return;
  }

  if (!u.pokemons || u.pokemons.length <= 1) {
    replier.reply("íŒë§¤í•  í¬ì¼“ëª¬ì´ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  var sorted = sortPokemonsByPower(u.pokemons); // ë†’ì€ ìˆœ ì •ë ¬
  var maxSell = Math.min(n, sorted.length - 1); // ìµœì†Œ 1ë§ˆë¦¬ëŠ” ë‚¨ê¹€
  var targets = sorted.slice(sorted.length - maxSell); // ë’¤ì—ì„œë¶€í„° në§ˆë¦¬ (ë‚®ì€ ìˆœ)

  var totalGold = 0;
  var soldLines = [];
  var skippedCount = 0; // íƒí—˜ ì¤‘ì´ë¼ ëª» íŒ ë§ˆë¦¿ìˆ˜

  for (var i = u.pokemons.length - 1; i >= 0; i--) {
    var p = u.pokemons[i];

    for (var j = 0; j < targets.length; j++) {
      if (p.uid === targets[j].uid) {
        
        // â˜… [í•µì‹¬ ì¶”ê°€] íƒí—˜ ì¤‘ì¸ í¬ì¼“ëª¬ì€ íŒë§¤ ìŠ¤í‚µ!
        if (isPokemonBusy(u, p.uid)) {
            skippedCount++;
            break; // íŒë§¤ ì•ˆ í•˜ê³  ë„˜ì–´ê°
        }

        var db = findPokemonDB(p.pid);
        var name = db ? db.name : "í¬ì¼“ëª¬";
        // â˜… ì´ë¡œì¹˜ ì´ë¦„ ì ìš©
        if (p.shiny) name = "âœ¨" + name;
        
        var price = sellPrice(p.pid, p.enh, p.grade); 

        u.pokemons.splice(i, 1); // ê°€ë°©ì—ì„œ ì‚­ì œ
        totalGold += price;

        soldLines.push("#" + p.uid + " " + name + " " + (p.enh || 0) + "ê°• (+" + fmtNum(price) + "ğŸ’°)");
        break;
      }
    }
  }

  u.gold += totalGold;
  commitSave(true);
  checkAndNotifyTitles(u, replier);

  var resultMsg = sayDo(decoName, "í•˜ìœ„ í¬ì¼“ëª¬ íŒë§¤ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.") +
    "\n\nğŸ§¾ íŒë§¤ ë‚´ì—­\n" + soldLines.join("\n") +
    "\n\nğŸ’° ì´ íšë“ ê³¨ë“œ: +" + fmtNum(totalGold) + "ğŸ’°" +
    "\nğŸ’° ì”ì—¬ ê³¨ë“œ: " + fmtNum(u.gold) + "ğŸ’°";

  // íƒí—˜ ì¤‘ì´ë¼ ëª» íŒ ì• ê°€ ìˆìœ¼ë©´ ì•Œë ¤ì¤Œ
  if (skippedCount > 0) {
      resultMsg += "\n\nâš ï¸ íƒí—˜ ì¤‘ì¸ " + skippedCount + "ë§ˆë¦¬ëŠ” íŒë§¤ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
  }

  replier.reply(resultMsg);
  return;
}
// -------------------- /íŒë§¤ (ë‹¨ì¼/ë‹¤ì¤‘ UID) --------------------
if (msg.indexOf("/íŒë§¤") === 0) {
  var sp2 = msg.split(" ").filter(Boolean);

  if (sp2.length < 2) {
    replier.reply("ì‚¬ìš©ë²•:\n/íŒë§¤ 12\n/íŒë§¤ 12 15 19\n/íŒë§¤ í•˜ìœ„ 5");
    return;
  }

  if (!u.pokemons || u.pokemons.length === 0) {
    replier.reply("íŒë§¤í•  í¬ì¼“ëª¬ì´ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  if (u.pokemons.length <= 1) {
    replier.reply("ë³´ìœ  í¬ì¼“ëª¬ì´ 1ë§ˆë¦¬ì¼ ë•ŒëŠ” íŒë§¤í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  var uidList = [];
  for (var a = 1; a < sp2.length; a++) {
    var v = parseInt(sp2[a], 10);
    if (!isNaN(v) && v > 0 && uidList.indexOf(v) === -1) uidList.push(v);
  }

  if (uidList.length === 0) {
    replier.reply("í¬ì¼“ëª¬IDê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.\nì˜ˆ: /íŒë§¤ 12 15 19");
    return;
  }

  var soldLines2 = [];
  var notFound = [];
  var blockedLines = [];
  var totalGold2 = 0;

  var foundMap = {};
  for (var i2 = 0; i2 < uidList.length; i2++) foundMap[uidList[i2]] = false;

  for (var si = u.pokemons.length - 1; si >= 0; si--) {
    var pSell = u.pokemons[si];
    if (uidList.indexOf(pSell.uid) === -1) continue;

    if (isPokemonBusy(u, pSell.uid)) {
        blockedLines.push("#" + pSell.uid + "(íƒí—˜ì¤‘)");
        continue;
    }

    foundMap[pSell.uid] = true;

    if (u.pokemons.length <= 1) {
      blockedLines.push("#" + pSell.uid + "(ë§ˆì§€ë§‰ 1ë§ˆë¦¬ ë³´í˜¸)");
      continue;
    }

    var dbSell = findPokemonDB(pSell.pid);
    
    // â˜… [ìˆ˜ì •] ì´ë¡œì¹˜ ì´ë¦„ ì ìš©
    var nm = getDisplayName(pSell);
    var price2 = sellPrice(pSell.pid, pSell.enh, pSell.grade); // grade ì¸ì ì¶”ê°€ë¨ì— ì£¼ì˜

    u.pokemons.splice(si, 1);
    totalGold2 += price2;

    soldLines2.push("#" + pSell.uid + " " + nm + " " + (pSell.enh || 0) + "ê°• (+" + fmtNum(price2) + "ğŸ’°)");
  } 

  for (var k = 0; k < uidList.length; k++) {
    if (!foundMap[uidList[k]]) notFound.push("#" + uidList[k]);
  }

  if (soldLines2.length === 0) {
    var msgFail = "íŒë§¤ ê°€ëŠ¥í•œ í¬ì¼“ëª¬ì´ ì—†ìŠµë‹ˆë‹¤.";
    if (notFound.length) msgFail += "\n\nì°¾ì§€ ëª»í•œ ID: " + notFound.join(", ");
    if (blockedLines.length) msgFail += "\n\níŒë§¤ ì œí•œ: " + blockedLines.join(", ");
    replier.reply(msgFail);
    return;
  }

  u.gold += totalGold2;
  commitSave(true);
  checkAndNotifyTitles(u, replier);
  var out =
    sayDo(decoName, "ìš”ì²­í•˜ì‹  í¬ì¼“ëª¬ íŒë§¤ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.") +
    "\n\nğŸ§¾ íŒë§¤ ë‚´ì—­\n" + soldLines2.join("\n") +
    "\n\nğŸ’° ì´ íšë“ ê³¨ë“œ: +" + fmtNum(totalGold2) + "ğŸ’°" +
    "\nğŸ’° ì”ì—¬ ê³¨ë“œ: " + fmtNum(u.gold) + "ğŸ’°";

  if (notFound.length) out += "\n\nğŸ” ì°¾ì§€ ëª»í•œ ID\n" + notFound.join(", ");
  if (blockedLines.length) out += "\n\nâ›” íŒë§¤ ì œí•œ\n" + blockedLines.join(", ");

  replier.reply(out);
  return;
}


   // ==================== [ì‹ ê·œ] ìŠ¤ë§ˆíŠ¸ ë„ì›€ë§ & ì„¤ëª… ì‹œìŠ¤í…œ (v2.5 ìµœì‹ í™”) ====================
   
  // 1. ìƒì„¸ ê°€ì´ë“œ ë‚´ìš© (ì‚¬ì „)
  var GUIDE_MAP = {
    "ì´ë¡œì¹˜": "âœ¨ [ì´ë¡œì¹˜(Shiny) ì‹œìŠ¤í…œ]\n\n- í•„ë“œì—ì„œ 0.5%ì˜ ê·¹ì•… í™•ë¥ ë¡œ ë“±ì¥í•˜ëŠ” ìƒ‰ì´ ë‹¤ë¥¸ í¬ì¼“ëª¬ì…ë‹ˆë‹¤.\n- í¬íš ì‹œ ì´ë¦„ ì•ì— âœ¨í‘œì‹œê°€ ë¶™ìŠµë‹ˆë‹¤.\n- [íŠ¹ì „] ì¼ë°˜ í¬ì¼“ëª¬ë³´ë‹¤ ì „íˆ¬ë ¥(CP)ì´ 10% ë†’ìœ¼ë©°, ë°°í‹€ ì‹œ ë°ë¯¸ì§€ê°€ 1.1ë°° ê°•ë ¥í•©ë‹ˆë‹¤.",
    "ë“±ê¸‰": "ğŸ“Š [ë“±ê¸‰(Tier) ì‹œìŠ¤í…œ]\n\n- íƒœì–´ë‚  ë•Œ S~D ë“±ê¸‰ì„ ë¶€ì—¬ë°›ìŠµë‹ˆë‹¤.\n- Së“±ê¸‰(ì™•ê´€ğŸ‘‘)ì€ ì ì¬ë ¥(IV)ì´ ë§Œì ì— ê°€ê¹ìŠµë‹ˆë‹¤.\n- [ì ì¬ë ¥] í˜/ë§·ì§‘/ë¯¼ì²© ìˆ˜ì¹˜ê°€ ë†’ì„ìˆ˜ë¡ ì‹¤ì „ ë°°í‹€ì—ì„œ ê°•ë ¥í•©ë‹ˆë‹¤.\n- [ì¤‘ìš”] í‹°ì–´ë¦¬ì…‹ê¶Œì€ íƒí—˜ì„ í†µí•´ì„œë§Œ íšë“í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
    "ì ì¬ë ¥": "ğŸ§¬ [ì ì¬ë ¥(IV) ì‹œìŠ¤í…œ]\n\n- ëª¨ë“  í¬ì¼“ëª¬ì€ íƒœì–´ë‚  ë•Œ 0~15 ì‚¬ì´ì˜ ê³ ìœ  ëŠ¥ë ¥ì¹˜ë¥¼ ê°€ì§‘ë‹ˆë‹¤.\n- ğŸ’ª í˜: ê³µê²©ë ¥ ì¦ê°€ (ë°ë¯¸ì§€ UP)\n- â¤ï¸ ë§·ì§‘: ìµœëŒ€ ì²´ë ¥ ì¦ê°€ (íƒ±í‚¹ UP)\n- âš¡ ë¯¼ì²©: ì„ ê³µ í™•ë¥  & íšŒí”¼/ì¹˜ëª…íƒ€ìœ¨ ì¦ê°€\n* '/ìƒíƒœ [UID]' ëª…ë ¹ì–´ë¡œ í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤.",
    "ê°•í™”": "ğŸ”¥ [ê°•í™” ì‹œìŠ¤í…œ]\n\n- '/ê°•í™”': ê³¨ë“œë¥¼ ì†Œëª¨í•˜ì—¬ ì•ˆì „í•˜ê²Œ +1ê°• (ì‹¤íŒ¨ ì‹œ í•˜ë½ ì—†ìŒ)\n- '/ë„íŒŒë¯¼': í‹°ì¼“ì„ ì†Œëª¨í•˜ì—¬ ë„ë°• ê°•í™” (ëŒ€ì„±ê³µ or ë–¡ë½ or íŒŒê´´)\n- ìµœëŒ€ +60ê°•ê¹Œì§€ ê°€ëŠ¥í•˜ë©°, ê³ ê°•í™”ì¼ìˆ˜ë¡ ë°°í‹€ ìŠ¹ë¦¬ ìˆ˜ë‹¹ì´ í­ì¦í•©ë‹ˆë‹¤.",
    "ë°°í‹€": "âš”ï¸ [ë°°í‹€ ì‹œìŠ¤í…œ]\n\n- ë‚´ ê°•í™”ìˆ˜ì¹˜ Â±10ê°• ì´ë‚´ì˜ ìƒëŒ€ì™€ ë§¤ì¹­ë©ë‹ˆë‹¤.\n- ì „ì„¤ í¬ì¼“ëª¬ê³¼ ì´ë¡œì¹˜ í¬ì¼“ëª¬ì€ ì¶”ê°€ ìŠ¤íƒ¯ ë³´ë„ˆìŠ¤ë¥¼ ë°›ìŠµë‹ˆë‹¤.\n- [ëª¨ì˜ì „] '/ëª¨ì˜ë°°í‹€ [UID1] [UID2]'ë¡œ ë‚´ í¬ì¼“ëª¬ë¼ë¦¬ ìŠ¤íŒŒë§ì„ ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
    "ì¹­í˜¸": "ğŸ·ï¸ [ì¹­í˜¸ ì‹œìŠ¤í…œ]\n\n- ê²Œì„ ë‚´ ì—…ì ì„ ë‹¬ì„±í•˜ë©´ íšë“í•©ë‹ˆë‹¤.\n- '/ë­í‚¹ ì¹­í˜¸'ì—ì„œ ìˆ˜ì§‘ ë­í‚¹ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n- '/ì¹­í˜¸ [ë²ˆí˜¸]'ë¡œ ì¥ì°©í•˜ë©´ ë‹‰ë„¤ì„ì´ ë©‹ì§€ê²Œ ë°”ë€ë‹ˆë‹¤.",
    "ì•„ì´í…œ": "ğŸ’ [ì£¼ìš” ì•„ì´í…œ]\n\n- ğŸª ë‘ì«€ì¿ : 100% í™•ë¥ ë¡œ ê°•í™” ì„±ê³µ (+1ê°•)\n- ğŸ« ì´ë™í‹°ì¼“: ì›í•˜ëŠ” í•„ë“œ ì§€ì—­ìœ¼ë¡œ í™•ì • ì´ë™\n- ğŸ”„ í‹°ì–´ë¦¬ì…‹ê¶Œ: (í¬ê·€) ë“±ê¸‰ê³¼ ì ì¬ë ¥ì„ ëœë¤ ë³€ê²½\n- ğŸ’³ ë„íŒŒë¯¼ê°•í™”ê¶Œ: í™•ë¥ í˜• ê°•í™” (ì¸ìƒì—­ì „ or ë‚˜ë½)",
    "íƒí—˜": "ğŸ§­ [íƒí—˜ ì‹œìŠ¤í…œ]\n\n- '/íƒí—˜' ëª…ë ¹ì–´ë¡œ ìì›ê³¼ í¬ì¼“ëª¬ì„ ì°¾ìŠµë‹ˆë‹¤.\n- í•œ ë²ˆì— ëª¬ìŠ¤í„°ë³¼ 30~50ê°œ, í‹°ì–´ë¦¬ì…‹ê¶Œ ë“± ëŒ€ëŸ‰ì˜ ë³´ìƒì„ íšë“í•  ê¸°íšŒì…ë‹ˆë‹¤.\n- íƒí—˜ ì¤‘ì¸ í¬ì¼“ëª¬ì€ ë°°í‹€ì´ë‚˜ ê±°ë˜ë¥¼ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
  };

  // 2. ëª…ë ¹ì–´: /ë„ì›€ (ê°„ëµ ì•ˆë‚´)
  if (msg === "/ë„ì›€") {
    replier.reply(
      "ğŸ¤– ì£ ë´‡ í¬ì¼“ëª¬ ë„ìš°ë¯¸\n\n" +
      "ğŸ“œ ì „ì²´ ëª…ë ¹ì–´ ë³´ê¸°\n" +
      "ğŸ‘‰ /ëª…ë ¹ì–´\n\n" +
      "ğŸ“– ì‹œìŠ¤í…œ ì„¤ëª…ì„œ\n" +
      "ğŸ‘‰ /ì„¤ëª… [í‚¤ì›Œë“œ]\n" +
      "(ì˜ˆ: /ì„¤ëª… ì ì¬ë ¥, /ì„¤ëª… ë„íŒŒë¯¼)\n\n" +
      "âš¡ ë¹ ë¥¸ ì‹œì‘\n" +
      "/í•„ë“œ â†’ /ëª¬ â†’ /ë‚´í¬ì¼“ëª¬"
    );
    return;
  }

  // 3. ëª…ë ¹ì–´: /ëª…ë ¹ì–´ (ìµœì‹  ê¸°ëŠ¥ í¬í•¨)
  if (msg === "/ëª…ë ¹ì–´") {
    var summary = "ğŸ“œ ì£ ë´‡ í¬ì¼“ëª¬ ì „ì²´ ëª…ë ¹ì–´ ëª©ë¡\n\nì „ì²´ë³´ê¸°ë¡œ í™•ì¸í•˜ì„¸ìš”.";
    var full = "\n\n[ì „ì²´ ëª…ë ¹ì–´]\n\n";

    full += "ğŸ‘¤ [ê¸°ë³¸/ê´€ë¦¬]\n";
    full += "/íšŒì›ê°€ì…, /ë‚´ì •ë³´, /ë‚´í¬ì¼“ëª¬\n";
    full += "/ìƒíƒœ [UID] : ìƒì„¸ ëŠ¥ë ¥ì¹˜(IV) í™•ì¸\n";
    full += "/ì¹­í˜¸, /ì¹­í˜¸ ë„ê° : ì¹­í˜¸ ê´€ë¦¬\n\n";

    full += "ğŸ¾ [í¬íš/ì„±ì¥]\n";
    full += "/í•„ë“œ : ì•¼ìƒ í¬ì¼“ëª¬ ì°¾ê¸°\n";
    full += "/íƒí—˜ [UID], /íƒí—˜ì·¨ì†Œ : íŒŒë° ë³´ë‚´ê¸°\n";
    full += "/ë„ê°, /ì´ë¡œì¹˜ : ìˆ˜ì§‘ í˜„í™©\n";
    full += "/ê°•í™” [UID] : ì•ˆì „ ê°•í™” (ê³¨ë“œ)\n";
    full += "/ë„íŒŒë¯¼ [UID] : ë„ë°• ê°•í™” (í‹°ì¼“)\n";
    full += "/ì‚¬ìš© [ì•„ì´í…œ] [ëŒ€ìƒ] : ì•„ì´í…œ ì‚¬ìš©\n\n";

    full += "âš”ï¸ [ì „íˆ¬]\n";
    full += "/ë°°í‹€ : ì‹¤ì „ ë§¤ì¹­ (ë³´ìƒO)\n";
    full += "/ë°°í‹€ì—°ì† [íšŸìˆ˜] : ìë™ ì—°ì† ë°°í‹€\n";
    full += "/ëª¨ì˜ë°°í‹€ [A] [B] : ë‚´ í¬ì¼“ëª¬ ìŠ¤íŒŒë§ (ë³´ìƒX)\n";
    full += "/ì „ì , /ë­í‚¹ [ì¢…ë¥˜]\n\n";

    full += "ğŸ’° [ê²½ì œ/ìƒì ]\n";
    full += "/ìƒì , /êµ¬ë§¤ [ì´ë¦„] [ìˆ˜ëŸ‰]\n";
    full += "/íŒë§¤ [UID], /íŒë§¤ í•˜ìœ„ [ìˆ«ì]\n\n";

    full += "ğŸ¤ [ê±°ë˜/ì†Œì…œ]\n";
    full += "/êµí™˜ [ë‹‰ë„¤ì„] [UID] : í¬ì¼“ëª¬ ì£¼ê¸°\n";
    full += "/ì„ ë¬¼ [ë‹‰ë„¤ì„] [ì•„ì´í…œ] [ìˆ˜ëŸ‰]\n";
    full += "/ì†¡ê¸ˆ [ë‹‰ë„¤ì„] [ê¸ˆì•¡]";

    replyFold(replier, summary, full);
    return;
  }

  // 4. ëª…ë ¹ì–´: /ì„¤ëª… (ì‹œìŠ¤í…œ ê°€ì´ë“œ + ì¥ë¹„ ë„ê° í†µí•©)
  if (msg.indexOf("/ì„¤ëª…") === 0) {
    var keyword = msg.replace("/ì„¤ëª…", "").trim();
    
    // [A] í‚¤ì›Œë“œ ì—†ì´ ì…ë ¥ ì‹œ ì•ˆë‚´
    if (!keyword) {
      var keys = Object.keys(GUIDE_MAP).join(", ");
      replier.reply(
        "ğŸ“– ì£ ë´‡ ë°±ê³¼ì‚¬ì „\n\n" +
        "ì‚¬ìš©ë²•: /ì„¤ëª… [ê²€ìƒ‰ì–´]\n" +
        "ì˜ˆ: /ì„¤ëª… ì ì¬ë ¥, /ì„¤ëª… í˜ì˜ë¨¸ë¦¬ë \n\n" +
        "ğŸ“š [ì‹œìŠ¤í…œ ê°€ì´ë“œ]\n" + keys + "\n\n" +
        "ğŸ›¡ï¸ [ì¥ë¹„ ë„ê°]\n" +
        "'/ì„¤ëª… ì¥ë¹„'ë¥¼ ì…ë ¥í•˜ë©´ ëª¨ë“  ì¥ë¹„ ëª©ë¡ê³¼ íš¨ê³¼ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
      );
      return;
    }

    // [B] 'ì¥ë¹„' ê²€ìƒ‰ ì‹œ -> ì „ì²´ ë¦¬ìŠ¤íŠ¸ ì¶œë ¥ (ë„ê° ëª¨ë“œ)
    if (keyword === "ì¥ë¹„" || keyword === "ì¥ë¹„ëª©ë¡" || keyword === "ì•„ì´í…œ") {
        var summary = "ğŸ›¡ï¸ ì „ì²´ ì¥ë¹„ ì•„ì´í…œ ëª©ë¡\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\n";
        var full = "\n[ì¥ë¹„ ì•„ì´í…œ íš¨ê³¼ ì´ì •ë¦¬]\n\n";
        
        // í‹°ì–´ë³„ êµ¬ë¶„ì„ ìœ„í•´ ìˆœíšŒ
        for (var key in EQUIP_DB) {
            var item = EQUIP_DB[key];
            var icon = item.icon || "â–ªï¸";
            full += icon + " " + key + "\n   â”” " + item.desc + "\n\n";
        }
        
        replyFold(replier, summary + "ì „ì²´ë³´ê¸°ë¡œ ìƒì„¸ íš¨ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.", full);
        return;
    }

    // [C] ì‹œìŠ¤í…œ ê°€ì´ë“œ (GUIDE_MAP) í™•ì¸
    if (GUIDE_MAP[keyword]) {
      replier.reply(GUIDE_MAP[keyword]);
      return;
    }

    // [D] ì¥ë¹„ ì•„ì´í…œ (EQUIP_DB) ê°œë³„ ê²€ìƒ‰ í™•ì¸
    if (EQUIP_DB[keyword]) {
      var item = EQUIP_DB[keyword];
      var icon = item.icon || "ğŸ›¡ï¸";
      
      // ì¶”ê°€ ì„¤ëª…(TMI) ìƒì„±
      var detail = "";
      if (item.type === "atk_pct") detail = "ë”œëŸ¬ìš© ìµœê³ ì˜ ì•„ì´í…œì…ë‹ˆë‹¤. ê¹¡ê³µê²©ë ¥ì„ ì¦í­ì‹œí‚µë‹ˆë‹¤.";
      else if (item.type === "hp_flat") detail = "ì²´ë ¥ì´ ë‚®ì€ í¬ì¼“ëª¬ì´ë‚˜ íƒ±ì»¤ì—ê²Œ ì•„ì£¼ ì¢‹ìŠµë‹ˆë‹¤.";
      else if (item.type === "spd_flat") detail = "ì„ ê³µì„ ì¡ê¸° ìœ ë¦¬í•´ì§‘ë‹ˆë‹¤. ì†ë„ëŠ” ë°°í‹€ì˜ ìƒëª…!";
      else if (item.type === "def_pct") detail = "ë°›ëŠ” ë°ë¯¸ì§€ë¥¼ ì¤„ì—¬ ìƒì¡´ë ¥ì„ ë†’ì…ë‹ˆë‹¤.";
      else if (item.type === "type_boost") detail = "í•´ë‹¹ ì†ì„±ì„ ê°€ì§„ í¬ì¼“ëª¬ì´ ì°©ìš©í•˜ë©´ ê¸°ìˆ  ìœ„ë ¥ì´ ê°•í•´ì§‘ë‹ˆë‹¤.";

      replier.reply(
          "ğŸ›¡ï¸ [ì¥ë¹„ ìƒì„¸ ì •ë³´]\n\n" +
          icon + " " + keyword + "\n" +
          "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
          "ğŸ“ íš¨ê³¼: " + item.desc + "\n" +
          "ğŸ’¡ íŒ: " + detail
      );
      return;
    }

    // [E] ê²€ìƒ‰ ì‹¤íŒ¨
    replier.reply("â“ '" + keyword + "'ì— ëŒ€í•œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì‹œìŠ¤í…œ ê°€ì´ë“œë‚˜ ì •í™•í•œ ì¥ë¹„ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.\n(ì „ì²´ ëª©ë¡: /ì„¤ëª… ì¥ë¹„)");
    return;
  }


   // -------------------- [ì¥ë¹„] ì¥ì°© ë° í•´ì œ --------------------
  if (msg.indexOf("/ì¥ì°©") === 0) {
      var parts = msg.split(" ").filter(Boolean);
      var uid = parseInt(parts[1]);
      var itemName = parts[2]; 

      if (isNaN(uid) || !itemName) {
          replier.reply("ì‚¬ìš©ë²•: /ì¥ì°© [UID] [ì•„ì´í…œëª…]\nì˜ˆ: /ì¥ì°© 15 í˜ì˜ë¨¸ë¦¬ë ");
          return;
      }

      var p = findUserPokemonByUid(u, uid);
      if (!p) { replier.reply("í•´ë‹¹ í¬ì¼“ëª¬ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
      if (isPokemonBusy(u, p.uid)) { replier.reply("íƒí—˜ ì¤‘ì¸ í¬ì¼“ëª¬ì€ ì¥ë¹„ë¥¼ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }

      if (!u.items || !u.items[itemName] || u.items[itemName] <= 0) {
          replier.reply("ğŸ’ ê°€ë°©ì— '" + itemName + "' ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤.");
          return;
      }
      
      if (!EQUIP_DB[itemName]) { replier.reply("ğŸš« ì°©ìš©í•  ìˆ˜ ì—†ëŠ” ì•„ì´í…œì…ë‹ˆë‹¤."); return; }

      // êµì²´ ë¡œì§
      if (p.equip) {
          u.items[p.equip] = (u.items[p.equip] || 0) + 1; // ê¸°ì¡´ ì¥ë¹„ í•´ì œ
      }

      u.items[itemName]--; 
      p.equip = itemName;

      commitSave(true);
      replier.reply("ğŸ¦¾ " + getDisplayName(p) + "ì—ê²Œ [" + itemName + "] ì¥ì°© ì™„ë£Œ!\níš¨ê³¼: " + EQUIP_DB[itemName].desc);
      return;
  }

  if (msg.indexOf("/í•´ì œ") === 0) {
      var uid = parseInt(msg.split(" ")[1]);
      var p = findUserPokemonByUid(u, uid);
      if (!p) return;
      if (isPokemonBusy(u, p.uid)) { replier.reply("íƒí—˜ ì¤‘ì¸ í¬ì¼“ëª¬ì€ ì¥ë¹„ë¥¼ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }

      if (!p.equip) { replier.reply("ì¥ì°© ì¤‘ì¸ ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤."); return; }

      if (!u.items) u.items = {};
      u.items[p.equip] = (u.items[p.equip] || 0) + 1; 
      var old = p.equip;
      p.equip = null;

      commitSave(true);
      replier.reply("ğŸ’ " + getDisplayName(p) + "ì˜ [" + old + "] ì¥ë¹„ë¥¼ í•´ì œí–ˆìŠµë‹ˆë‹¤.");
      return;
  }
 

  // ==================================================================
  // ğŸª [ìƒì  ì‹œìŠ¤í…œ] ê³¨ë“œ ìƒì  & ë‹¤ì½”íƒ€ ì•”ì‹œì¥ & í†µí•© êµ¬ë§¤
  // ==================================================================

  // 1. ê³¨ë“œ ìƒì  ëª©ë¡ (ê¸°ì¡´ ìœ ì§€)
  if (msg === "/ìƒì ") {
    replier.reply(shopText(d, u, sender));
    return;
  }

  // 2. ë‹¤ì½”íƒ€ ì•”ì‹œì¥ ëª©ë¡ (ì½”ì¸ ìƒì )
  if (msg === "/ë‹¤ì½”íƒ€ìƒì " || msg === "/ì½”ì¸ìƒì " || msg === "/ì•”ì‹œì¥") {
      var coin = u.dakotaCoin || 0;
      replier.reply(
          "ğŸ° [ë‹¤ì½”íƒ€ ìƒì ]\n" +
          "\"ì–´ì„œ ì˜¤ê²Œ... ì½”ì¸ë§Œ ìˆë‹¤ë©´ ë¬´ì—‡ì´ë“  íŒ”ì§€.\"\n\n" +
          "ğŸª™ ë‚´ ì½”ì¸: " + fmtNum(coin) + "ê°œ\n" +
          "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
          "ğŸ“¦ 1. ì¥ë¹„ìƒì : " + DAKOTA_PRICE_BOX + "ì½”ì¸\n" +
          "   â”” ì¥ë¹„ or íŒŒí¸ íšë“ (5% ì „ì„¤!)\n\n" +
          "ğŸ“ 2. ë”¸ì«€ì¿  : " + DAKOTA_PRICE_DDAL + "ì½”ì¸\n" +
          "   â”” [ê°•í™” +3] ìƒìŠ¹ (ì‹¤íŒ¨ ì—†ìŒ)\n\n" +
          "ğŸ¥œ 3. í™©ê¸ˆì—´ë§¤ : " + DAKOTA_PRICE_NUT + "ì½”ì¸\n" +
          "   â”” ì ì¬ë ¥ MAX & Së“±ê¸‰ í™•ì •\n\n" +
          "ğŸ¨ 4. í™©ê¸ˆí˜ì¸íŠ¸ : " + DAKOTA_PRICE_PAINT + "ì½”ì¸\n" +
          "   â”” ì¼ë°˜ í¬ì¼“ëª¬ì„ [âœ¨ì´ë¡œì¹˜]ë¡œ ë³€í™˜\n" +
          "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
          "ğŸ›’ êµ¬ë§¤ ë°©ë²• (í†µí•©)\n" +
          "/êµ¬ë§¤ ìƒì 1\n" +
          "/êµ¬ë§¤ ë”¸ê¸° 1\n" +
          "/êµ¬ë§¤ í˜ì¸íŠ¸ 1"
      );
      return;
  }

  // 3. [í†µí•©] êµ¬ë§¤ ì‹œìŠ¤í…œ (ê³¨ë“œ/ì½”ì¸ ìë™ ê°ì§€)
  if (msg.indexOf("/êµ¬ë§¤") === 0) {
    var parts = msg.split(" ").filter(Boolean);
    
    // ì…ë ¥ê°’ ë¶€ì¡± ì‹œ ì•ˆë‚´
    if (parts.length < 2) {
      replier.reply(
          "ğŸ›’ [ìƒì  êµ¬ë§¤ ê°€ì´ë“œ]\n" +
          "ì‚¬ìš©ë²•: /êµ¬ë§¤ [ì•„ì´í…œëª…] [ìˆ˜ëŸ‰]\n\n" +
          "ğŸ’° [ê³¨ë“œ ìƒí’ˆ] ëª¬ìŠ¤í„°ë³¼, ë„íŒŒë¯¼, í‚¹ê°“ë³¼...\n" +
          "ğŸª™ [ì½”ì¸ ìƒí’ˆ] ìƒì, ë”¸ì«€ì¿ , í˜ì¸íŠ¸, ì—´ë§¤...\n\n" +
          "ì˜ˆ: /êµ¬ë§¤ ëª¬ìŠ¤í„°ë³¼ 10\n" +
          "ì˜ˆ: /êµ¬ë§¤ ìƒì 5"
      );
      return;
    }

    var item = parts[1]; // ì•„ì´í…œ ì´ë¦„
    var qty = 1;
    if (parts.length >= 3) {
      qty = parseInt(parts[2], 10);
      if (isNaN(qty)) qty = 1;
    }
    qty = Math.max(1, Math.min(999, qty)); // í•œ ë²ˆì— ìµœëŒ€ 999ê°œ ì œí•œ

    // -------------------------------------------------------
    // [A] ë‹¤ì½”íƒ€ ì•”ì‹œì¥ ë¬¼í’ˆ (ì½”ì¸ ìë™ ê°ì§€)
    // -------------------------------------------------------
    var dakotaPrice = 0;
    var dakotaRealName = "";
    var isDakotaItem = false;

    // ì½”ì¸ ì•„ì´í…œì¸ì§€ ì´ë¦„ìœ¼ë¡œ ì²´í¬
    if (item === "ìƒì" || item === "ë³´ë¬¼ìƒì" || item === "ì¥ë¹„ìƒì") { 
        dakotaPrice = DAKOTA_PRICE_BOX; dakotaRealName = "ì¥ë¹„ìƒì"; isDakotaItem = true; 
    }
    else if (item === "ë”¸ê¸°" || item === "ë”¸ì«€ì¿ " || item === "ë”¸ê¸°ì¿ í‚¤") { 
        dakotaPrice = DAKOTA_PRICE_DDAL; dakotaRealName = "ë”¸ì«€ì¿ "; isDakotaItem = true; 
    }
    else if (item === "ì—´ë§¤" || item === "í™©ê¸ˆì—´ë§¤" || item === "ë¼ì¦ˆì—´ë§¤") { 
        dakotaPrice = DAKOTA_PRICE_NUT; dakotaRealName = "í™©ê¸ˆì—´ë§¤"; isDakotaItem = true; 
    }
    else if (item === "í˜ì¸íŠ¸" || item === "í™©ê¸ˆí˜ì¸íŠ¸" || item === "ì´ë¡œì¹˜") { 
        dakotaPrice = DAKOTA_PRICE_PAINT; dakotaRealName = "í™©ê¸ˆí˜ì¸íŠ¸"; isDakotaItem = true; 
    }

    // â˜… ë‹¤ì½”íƒ€ ì•„ì´í…œì´ë©´ -> ì½”ì¸ ê²°ì œ ë¡œì§ ì‹¤í–‰
    if (isDakotaItem) {
        var totalCoin = dakotaPrice * qty;
        var myCoin = u.dakotaCoin || 0;

        if (myCoin < totalCoin) {
            replier.reply("ğŸª™ ë‹¤ì½”íƒ€ ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.\ní•„ìš”: " + fmtNum(totalCoin) + "ê°œ / ë³´ìœ : " + fmtNum(myCoin) + "ê°œ");
            return;
        }

        // ì½”ì¸ ì°¨ê° ë° ì•„ì´í…œ ì§€ê¸‰
        u.dakotaCoin -= totalCoin;
        
        if (!u.items) u.items = {};
        u.items[dakotaRealName] = (u.items[dakotaRealName] || 0) + qty;

        commitSave(true);
        replier.reply(
            "ğŸ›’ [ë‹¤ì½”íƒ€] êµ¬ë§¤ ì™„ë£Œ!\n" +
            "ğŸ“¦ " + dakotaRealName + " x" + qty + "ê°œ\n" +
            "ğŸª™ ì”ì•¡: " + fmtNum(u.dakotaCoin) + "ì½”ì¸\n" +
            "(ì‚¬ìš©ë²•: /ì‚¬ìš© " + item + " [ìˆ˜ëŸ‰/UID])"
        );
        return;
    }

    // -------------------------------------------------------
    // [B] ì¼ë°˜ ìƒì  ë¬¼í’ˆ (ê³¨ë“œ ê²°ì œ) - ê¸°ì¡´ í•¨ìˆ˜ ì—°ê²°
    // -------------------------------------------------------
    // ë‹¤ì½”íƒ€ ì•„ì´í…œì´ ì•„ë‹ˆë©´ ì¼ë°˜ ê³¨ë“œ ì•„ì´í…œìœ¼ë¡œ ê°„ì£¼í•˜ê³  ì²˜ë¦¬
    var rBuy = buyItem(d, u, sender, item, qty, replier);
    
    if (rBuy.ok) {
      commitSave(true);
      checkAndNotifyTitles(u, replier);
      replier.reply(rBuy.msg);
    } else {
      // êµ¬ë§¤ ì‹¤íŒ¨ ì‚¬ìœ  ì¶œë ¥ (ëˆ ë¶€ì¡±, ì—†ëŠ” ì•„ì´í…œ ë“±)
      replier.reply(rBuy.reason);
    }
    return;
  }

// -------------------- [ìµœì¢… í†µí•©] /í•„ë“œ (ì§€ì—­ ìë™ ë§¤ì¹­ + ê´€ë¦¬ì ì˜ˆì•½) --------------------
  if (msg === "/í•„ë“œ") {
    // 1. ì¤‘ë³µ ìŠ¤í° ë° ì¿¨íƒ€ì„ ì²´í¬ (ê¸°ì¡´ ìœ ì§€)
    var currentWild = getWild(d, room);
    if (currentWild) {
      var dbWild = findPokemonDB(currentWild.pid);
      var wildName = dbWild ? dbWild.name : "í¬ì¼“ëª¬";
      if (currentWild.isShiny) wildName = "âœ¨" + wildName;
      replier.reply("âš ï¸ ì´ë¯¸ í•„ë“œì— " + wildName + "ê°€ ë‚˜íƒ€ë‚˜ ìˆìŠµë‹ˆë‹¤!\ní¬íší•˜ì‹œê±°ë‚˜ /ë„ë§(/ã…Œã…Œ) í›„ì— ë‹¤ì‹œ íƒìƒ‰í•´ì£¼ì„¸ìš”.");
      return;
    }

    var now = nowMs();
    if (now - u.lastFieldAt < FIELD_COOLDOWN_MS) {
      var remain = FIELD_COOLDOWN_MS - (now - u.lastFieldAt);
      var sec = Math.ceil(remain / 1000);
      replier.reply(sayDo(decoName, pick(COOLDOWN_LINES)) + "\nâ³ " + sec + "ì´ˆ í›„ ë‹¤ì‹œ í•„ë“œë¥¼ íƒìƒ‰í•  ìˆ˜ ìˆì–´ìš”.");
      return;
    }
    u.lastFieldAt = now;

    var region = "";
    var wildData;
    var forcedShiny = false;

    // 2. ì§€ì—­ ê²°ì • ë° ìŠ¤í° ë¡œì§ (ì˜ˆì•½ ìš°ì„  ìˆœìœ„)
    if (u.nextSpawnPid && u.nextSpawnPid > 0) {
      // [A] ê´€ë¦¬ì ì˜ˆì•½ ìŠ¤í°ì¼ ë•Œ
      wildData = findPokemonDB(u.nextSpawnPid);
      forcedShiny = !!u.nextSpawnShiny;
      
      // ì˜ˆì•½ëœ í¬ì¼“ëª¬ íƒ€ì…ì— ë§ëŠ” ì§€ì—­ìœ¼ë¡œ ê°•ì œ ë°°ì •
      region = getRecommendedRegion(u.nextSpawnPid);
      
      u.nextSpawnPid = 0;   // ì‚¬ìš© ì™„ë£Œ í›„ ì´ˆê¸°í™”
      u.nextSpawnShiny = false;
      u.nextFieldRegion = ""; // í‹°ì¼“ ì˜ˆì•½ ë¬´ì‹œ
      
    } else if (u.nextFieldRegion) {
      // [B] ì´ë™ í‹°ì¼“ ì˜ˆì•½ì´ ìˆì„ ë•Œ
      region = u.nextFieldRegion;
      u.nextFieldRegion = ""; 
      wildData = spawnPokemonForRegion(region);
      forcedShiny = (Math.random() < (SHINY_PROBABILITY / 100));
      replier.reply("ğŸš€ ì´ë™ í‹°ì¼“ íš¨ê³¼ ë°œë™! [" + region + "] ì§€ì—­ì— ë„ì°©í–ˆìŠµë‹ˆë‹¤.");

    } else {
      // [C] ì¼ë°˜ ëœë¤ ìŠ¤í°
      region = getRoomRegion(d, room);
      // ëƒ¥ì¹˜ì˜ ë°© ì•ˆì „ì¥ì¹˜
      var safetyNet = 0;
      while (region === "ëƒ¥ì¹˜ì˜ ë°©" && safetyNet < 10) {
        region = getRoomRegion(d, room);
        safetyNet++;
      }
      if (region === "ëƒ¥ì¹˜ì˜ ë°©") region = REGIONS[0].key;
      
      wildData = spawnPokemonForRegion(region);
      forcedShiny = (Math.random() < (SHINY_PROBABILITY / 100));
    }

    // 3. ì•¼ìƒ ë°ì´í„° ì €ì¥ ë° ë„ê° ë°˜ì˜
    setWild(d, room, wildData.id, forcedShiny);
    dexSeen(u, wildData.id);
    commitSave(true);

    // 4. ì—°ì¶œ ë©”ì‹œì§€ êµ¬ì„±
    var dbw = findPokemonDB(wildData.id);
    var shinyLine = forcedShiny ? "âœ¨âœ¨âœ¨ ë ë¦¬ë§~! ìƒ‰ì´ ë‹¤ë¥¸ í¬ì¼“ëª¬ì…ë‹ˆë‹¤! âœ¨âœ¨âœ¨\n" : "";
    
    var rareLine = "";
    if (dbw && dbw.rarity === 5) {
      rareLine = sayDo(decoName, pick(EMPHASIS_RARE5)) + "\n" + pick(EMPHASIS_LEGENDARY) + "\n\n";
    }
    
    var ballLine = "ğŸ’ ë³´ìœ  ë³¼\n" + "- ëª¬ìŠ¤í„°ë³¼: " + u.ball + "\n" + "- ìŠˆí¼ë³¼: " + u.superBall + "\n" + "- í•˜ì´í¼ë³¼: " + u.ultraBall + "\n\n";
    var guide = "ğŸ¯ í¬íš: /ëª¬(/ã…), /ìŠˆ(/ã……), /í•˜(/ã…)\n" + "ğŸƒ ë„ë§: /ë„ë§(/ã…Œã…Œ)\n" + "â³ " + Math.floor(SPAWN_EXPIRE_MS / 1000) + "ì´ˆ ì•ˆì— ì„ íƒ";
    
    // ìµœì¢… ì¶œë ¥
    replier.reply(
      sayDo(decoName, pick(FIELD_SEARCH_LINES)) + "\n\n" + 
      "[ì§€ì—­: " + region + "]\n\n" + 
      shinyLine + rareLine + 
      "âš¡ " + sayDo(decoName, dbw.name + " ì™€(ê³¼) ë§ˆì£¼ì³¤ì–´ìš”!") + "\n" + 
      pick(FIELD_ENCOUNTER_LINES) + "\n\n" + 
      ballLine + guide
    );
    return;
  }
     // -------------------- [êµì •] ë„ë§ ì‹œìŠ¤í…œ (/ã…Œã…Œ í†µí•© ë° ì•ˆì „ ì¥ì¹˜) --------------------
  if (msg === "/ë„ë§" || msg === "/ã…Œã…Œ") {
    // 1. í˜„ì¬ ë°©ì˜ ì•¼ìƒ í¬ì¼“ëª¬ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    var targetW = d.lastSpawnByRoom[room];

    // 2. ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ì´ë¯¸ ë§Œë£Œ/ë„ë§ ìƒíƒœì¸ì§€ ì²´í¬
    if (!targetW || targetW.expired) {
      replier.reply("í•„ë“œì— ë§ˆì£¼ì¹œ í¬ì¼“ëª¬ì´ ì—†ê±°ë‚˜ ì´ë¯¸ ì‚¬ë¼ì¡ŒìŠµë‹ˆë‹¤.");
      return;
    }

    // 3. DBì—ì„œ ì´ë¦„ ì°¾ê¸° (targetW.pid ì‚¬ìš©)
    var dbw3 = findPokemonDB(targetW.pid);
    
    // ğŸŒŸ [í•µì‹¬ ìˆ˜ì •] dbw3ê°€ ì—†ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•œ ê¸°ë³¸ê°’ ì„¤ì • (ì˜¤ë¥˜ ë°©ì§€)
    var pName = (dbw3 && dbw3.name) ? dbw3.name : "ì•¼ìƒ í¬ì¼“ëª¬";

    // 4. í•„ë“œ ë°ì´í„° í™•ì‹¤íˆ ì‚­ì œ (clearWild ì—­í• )
    delete d.lastSpawnByRoom[room];

    if (!u.stats.totalEscapes) u.stats.totalEscapes = 0;
    u.stats.totalEscapes++;
    
    // 5. ë³€ê²½ì‚¬í•­ ì €ì¥
    commitSave(true);    
    checkAndNotifyTitles(u, replier);

    // 6. ê²°ê³¼ ì „ì†¡ (ì•ˆì „í•˜ê²Œ ì²˜ë¦¬ëœ pName ì‚¬ìš©)
    replier.reply(sayDo(decoName, pName + "ì—ê²Œì„œ ë¬´ì‚¬íˆ ë„ë§ì³¤ìŠµë‹ˆë‹¤! ğŸƒğŸ’¨"));
    return;
  }
   
// [ìˆ˜ì •ë¨] í¬íš ë‹´ë‹¹ í•¨ìˆ˜ (ì¥ë¹„ ë“œë ë° ì•ˆì „ì¥ì¹˜ ì ìš© ì™„ë£Œ)
function handleCatch(ballType, ballName, decoName, replier) {
  var wild = getWild(d, room);
  
  if (!wild) {
    var ex = takeExpiredWild(d, room);
    if (ex) {
      var dbx = findPokemonDB(ex.pid);
      var name = dbx ? dbx.name : "ì•¼ìƒ í¬ì¼“ëª¬";
      commitSave(false);
      replier.reply(sayDo(decoName, name + "ì„(ë¥¼) ë†“ì³¤ìŠµë‹ˆë‹¤. (ë„ë§ê°)"));
      return;
    }
    replier.reply(sayDo(decoName, "í˜„ì¬ ì•¼ìƒ í¬ì¼“ëª¬ì´ ì—†ìŠµë‹ˆë‹¤.") + "\n/í•„ë“œ ë¡œ íƒìƒ‰í•´ ì£¼ì„¸ìš”.");
    return;
  }

  if (typeof wild.attempts !== "number") wild.attempts = 0;
  if (typeof wild.maxAttempts !== "number") wild.maxAttempts = getMaxCatchAttempts(wild.pid);

  if (!consumeBall(u, ballType)) {
    replier.reply(ballName + "ì´(ê°€) ë¶€ì¡±í•©ë‹ˆë‹¤.\n/ìƒì  ì—ì„œ êµ¬ë§¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
    return;
  }

  var t = tryCatch(u, wild.pid, ballType);
  
  if (!t.ok) {
    saveData(d);
    replier.reply("í¬íš ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    return;
  }

  var db = findPokemonDB(wild.pid);

  // -------------------- [ì„±ê³µ ì‹œ] --------------------
  if (t.success) {
    clearWild(d, room); 
    
    // í¬ì¼“ëª¬ ì €ì¥
    var uid = addPokemonToUser(u, wild.pid, wild.isShiny); 
    
    // ==================================================================
    // ğŸ’ [ì—…ë°ì´íŠ¸] ì†Œì§€í’ˆ ë°œê²¬ (ì¥ë¹„ í¬í•¨ & ê°€ë…ì„± ê°•í™”)
    // ==================================================================
    var heldItemMsg = "";
    var lootRoll = Math.random(); // 0.0 ~ 1.0

    // 15% í™•ë¥ ë¡œ í¬ì¼“ëª¬ì´ ì•„ì´í…œì„ ì§€ë‹ˆê³  ìˆìŒ
    if (lootRoll < 0.15) { 
        var itemRoll = Math.random();
        
        // [í™•ë¥  í…Œì´ë¸”] (í¬ê·€í•œ ìˆœì„œëŒ€ë¡œ ê²€ì‚¬)
        
        // 1. í‚¹ê°“ë³¼ (0.3%)
        if (itemRoll < 0.003) { 
            u.godBall = (u.godBall || 0) + 1;
            heldItemMsg = "\nğŸ‘‘ [ëŒ€ë°•] ì´ ë…€ì„... ì „ì„¤ì˜ [í‚¹ê°“ë³¼]ì„ ìˆ¨ê¸°ê³  ìˆì—ˆêµ°ìš”! (+1ê°œ)";
        }
        // 2. ì¥ë¹„ ì•„ì´í…œ (ì•½ 1.2%)
        else if (itemRoll < 0.005) { 
            var dropList = [
                "í˜ì˜ë¨¸ë¦¬ë ", "ìë­‰ì—´ë§¤", "êµ¬ì• ìŠ¤ì¹´í”„", "ë°©ì–´ë³´ì„", 
                "ë¶ˆê½ƒêµ¬ìŠ¬", "ë¬¼ë°©ìš¸êµ¬ìŠ¬", "ê¸°ì ì˜ì”¨", "ìì„", "ë…¹ì§€ì•ŠëŠ”ì–¼ìŒ", "ë¶€ë“œëŸ¬ìš´ëª¨ë˜", "ë‚ ì¹´ë¡œìš´ë¶€ë¦¬", "ìš©ì˜ì´ë¹¨", "ê²€ì€ì•ˆê²½"
            ];
            var dropItem = dropList[Math.floor(Math.random() * dropList.length)];
            
            // ê°€ë°© ì•ˆì „ ìƒì„±
            if (!u.items) u.items = {};
            u.items[dropItem] = (u.items[dropItem] || 0) + 1;
            
            // â˜… ì•„ì´ì½˜ ë¶ˆëŸ¬ì™€ì„œ ë©”ì‹œì§€ì— ë„£ê¸°
            var icon = (EQUIP_DB[dropItem] && EQUIP_DB[dropItem].icon) ? EQUIP_DB[dropItem].icon : "ğŸ’";
            heldItemMsg = "\n" + icon + " [ë“í…œ] ë…€ì„ì´ ì§€ë‹ˆê³  ìˆë˜ [" + dropItem + "]ì„(ë¥¼) ëºì—ˆìŠµë‹ˆë‹¤! (+1ê°œ)";
        }
        // 3. ë‘ì«€ì¿  (ì•½ 4% / ~0.055 êµ¬ê°„)
        else if (itemRoll < 0.065) { 
            u.cookie = (u.cookie || 0) + 1;
            heldItemMsg = "\nğŸª [ë°œê²¬] ì£¼ë¨¸ë‹ˆì—ì„œ ë‹¬ì½¤í•œ [ë‘ì«€ì¿ ]ê°€ ë‚˜ì™”ìŠµë‹ˆë‹¤! (+1ê°œ)";
        }
        // 4. í‹°ì–´ë¦¬ì…‹ê¶Œ (ì•½ 10% / ~0.155 êµ¬ê°„)
        else if (itemRoll < 0.155) { 
            u.reroll = (u.reroll || 0) + 1;
            heldItemMsg = "\nğŸ”„ [íšë“] ì˜¤! ì´ í¬ì¼“ëª¬, [í‹°ì–´ë¦¬ì…‹ê¶Œ]ì„ ê°€ì§€ê³  ìˆì—ˆë„¤ìš”! (+1ì¥)";
        }
        // 5. ë„íŒŒë¯¼ê°•í™”ê¶Œ (ì•½ 20% / ~0.355 êµ¬ê°„)
        else if (itemRoll < 0.355) { 
            u.dopaTicket = (u.dopaTicket || 0) + 1;
            heldItemMsg = "\nğŸ’³ [íšë“] ë…€ì„ì˜ í’ˆì—ì„œ [ë„íŒŒë¯¼ê°•í™”ê¶Œ]ì„ ì±™ê²¼ìŠµë‹ˆë‹¤! (+1ì¥)";
        }
        // 6. ì´ë™í‹°ì¼“ (ì•½ 35% / ~0.70 êµ¬ê°„)
        else if (itemRoll < 0.70) { 
            u.ticket = (u.ticket || 0) + 1;
            heldItemMsg = "\nğŸ« [íšë“] ì—¬í–‰ì„ ì¢‹ì•„í•˜ë‚˜ ë´ìš”. [ì´ë™í‹°ì¼“]ì„ ì••ìˆ˜í–ˆìŠµë‹ˆë‹¤. (+1ì¥)";
        } 
        // 7. ëª¬ìŠ¤í„°ë³¼ (ë‚˜ë¨¸ì§€ 30%)
        else { 
            u.ball = (u.ball || 0) + 1;
            heldItemMsg = "\nğŸ”´ [ì¤ì¤] ë°”ë‹¥ì— ë–¨ì–´ì§„ ëª¬ìŠ¤í„°ë³¼ì„ ë‹¤ì‹œ íšŒìˆ˜í–ˆìŠµë‹ˆë‹¤. (+1ê°œ)";
        }
    }
    // ==================================================================

    var p = findUserPokemonByUid(u, uid); 
    var reward = calcCatchRewards(u, wild.pid); 
    u.gold += reward.totalGold; 
    addExpWithLevelUpMsg(u, reward.totalExp); 
    commitSave(true); 
      
    checkAndNotifyTitles(u, replier);

    var fx = ""; 
    if (reward.legendary) fx = legendaryCatchFX(sender, db.name, reward); 
    if (wild.isShiny) fx += "âœ¨âœ¨âœ¨ ì´ë¡œì¹˜ í¬ì¼“ëª¬ í¬íš ì„±ê³µ! âœ¨âœ¨âœ¨\n";

    var showHp = Math.floor((p.ivHp || 0) / 10); 
    if (showHp < 1) showHp = 1;

    var catchResultMsg = 
      fx +
      blockTitle("í¬íš ì„±ê³µ") +
      "ğŸ‰ " + sayDo(decoName, db.name + " í¬íšì— ì„±ê³µí–ˆì–´ìš”!") + "\n\n" +
      "âœ¨ ë“±ê¸‰: ã€ " + (p.grade || "D") + " ë“±ê¸‰ ã€‘\n" +
      "ğŸ“Š ì ì¬ë ¥ (15ì  ë§Œì )\n" +
      "âš”ï¸ í˜ : " + (p.ivStr || 0) + " / 15\n" +
      "â¤ï¸ ì²´ë ¥: " + showHp + " / 15\n" +
      "âš¡ ê³µì†: " + (p.ivSpd || 0) + " / 15\n" +
      "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
      "ğŸ§¬ ë‚´ í¬ì¼“ëª¬ ID #" + uid + "\n" +
      "ğŸ’° ë³´ìƒ: +" + fmtNum(reward.totalGold) + "ğŸ’° / +" + reward.totalExp + "EXP\n" +
      heldItemMsg + 
      "\n\n" + pick(CATCH_SUCCESS_LINES); 

    replier.reply(catchResultMsg); 
    return; 
  }
  
  // -------------------- [ì‹¤íŒ¨ ì‹œ] --------------------
  wild.attempts++; 
  var leftTry = Math.max(0, wild.maxAttempts - wild.attempts);
  var escapePressure = 0; 
  if (wild.attempts > 2) escapePressure = (wild.attempts - 2) * 0.05; 
  if (escapePressure > 0.35) escapePressure = 0.35; 
  
  if (wild.attempts >= wild.maxAttempts || Math.random() < escapePressure) { 
    wild.byEscape = true; 
    clearWild(d, room); 
    commitSave(true); 
    replier.reply("ğŸ’¨ " + (db?db.name:"í¬ì¼“ëª¬") + "ì´(ê°€) ë„ë§ì³¤ìŠµë‹ˆë‹¤!\n/í•„ë“œ ë¡œ ë‹¤ì‹œ íƒìƒ‰í•´ ì£¼ì„¸ìš”."); 
    return; 
  }
  
  commitSave(true); 
  replier.reply(blockTitle("í¬íš ì‹¤íŒ¨") + "ğŸ’¥ " + sayDo(decoName, db.name + " í¬íšì— ì‹¤íŒ¨í–ˆì–´ìš”.") + "\n\n" + pick(CATCH_FAIL_DRIP_LINES) + "\n\n" + "ğŸ¯ ë‚¨ì€ ê¸°íšŒ: " + leftTry + "íšŒ" + "\n\nğŸ’¡ " + pick(CATCH_FAIL_TIP_LINES) + "\n\n" + "ğŸ¯ í¬íš\n" + "/ëª¬ ë˜ëŠ” /ã…  â†’ ëª¬ìŠ¤í„°ë³¼\n" + "/ìŠˆ ë˜ëŠ” /ã……  â†’ ìŠˆí¼ë³¼\n" + "/í•˜ ë˜ëŠ” /ã…  â†’ í•˜ì´í¼ë³¼\n\n" + "ğŸƒ ë„ë§: /ë„ë§"); 
  return; 
}

// ğŸ¯ í¬íš ëª…ë ¹ì–´ êµ¬ì—­
if (msg === "/ëª¬ìŠ¤í„°ë³¼" || msg === "/ëª¬" || msg === "/ã…") { handleCatch(0, "ëª¬ìŠ¤í„°ë³¼", decoName, replier); return; }
if (msg === "/ìŠˆí¼ë³¼" || msg === "/ìŠˆ" || msg === "/ã……") { handleCatch(1, "ìŠˆí¼ë³¼", decoName, replier); return; }
if (msg === "/í•˜ì´í¼ë³¼" || msg === "/í•˜" || msg === "/ã…") { handleCatch(2, "í•˜ì´í¼ë³¼", decoName, replier); return; }

// â˜… ì „ì„¤ì˜ ë„ë¶€ë³¼ ëª…ë ¹ì–´ (í’€ë„¤ì„ ì•„ë‹ˆë©´ ë°œë™ ì•ˆí•¨)
if (msg === "/ìŠˆí¼ìš¸íŠ¸ë¼í‚¹ê°“ì— í˜ëŸ¬ê°œì©ŒëŠ”í•˜ì´í¼ì±Œë¦°ì €í˜ì´ì»¤í‰ë²”í•œìš©íƒœëŠ”ë¯¸ì¹œì‚¬ëŒê°“ë¯¼ìˆ˜ë„ë¶€ë³¼") { 
  handleCatch(3, "ìŠˆí¼ìš¸íŠ¸ë¼í‚¹ê°“ì— í˜ëŸ¬ê°œì©ŒëŠ”í•˜ì´í¼ì±Œë¦°ì €í˜ì´ì»¤í‰ë²”í•œìš©íƒœëŠ”ë¯¸ì¹œì‚¬ëŒê°“ë¯¼ìˆ˜ë„ë¶€ë³¼", decoName, replier); 
  return; 
}

// -------------------- [ìˆ˜ì •ë¨] ì¹­í˜¸ ì‹œìŠ¤í…œ (í‰ë²”í•˜ê²Œ ë¯¸ì¹œ ì¶”ê°€ ì™„ë£Œ) --------------------
  if (msg.indexOf("/ì¹­í˜¸") === 0) {
    updateTitles(u); 

    var parts = msg.split(" ").filter(Boolean);
    var sub = parts[1]; 

    // [A] ì¹­í˜¸ ë„ê° (ì „ì²´ ëª©ë¡ ë° íšë“ ì¡°ê±´ ê³µê°œ)
    if (sub === "ë„ê°") {
      var listStr = "";
      var masterList = [
        { n: "ë‰´ë¹„", c: "ìœ ì € íšŒì›ê°€ì…" },
        { n: "ì„±ì¥ ì¤‘ì¸", c: "30ë ˆë²¨ ë‹¬ì„±" },
        { n: "ê³ ì—¬ë²„ë¦°", c: "100ë ˆë²¨ ë‹¬ì„±" },
        { n: "ì§„ì§€ì¶©", c: "150ë ˆë²¨ ë‹¬ì„±" },
        { n: "ë ˆë²¨ê°’ ëª»í•˜ëŠ”", c: "50ë ˆë²¨ ì´ìƒ ìŠ¹ë¥  30% ì´í•˜" },
        { n: "ì‹¸ì›€ê¾¼ì¸", c: "ë°°í‹€ 10ì—°ìŠ¹ ë‹¬ì„±" },
        { n: "ê°•ë ¥í•œ", c: "ë°°í‹€ 20ì—°ìŠ¹ ë‹¬ì„±" },
        { n: "ë„ë¼ì´", c: "ë°°í‹€ 50ì—°ìŠ¹ ë‹¬ì„±" },
        { n: "ë°°í‹€ë§ˆìŠ¤í„°", c: "ë°°í‹€ 100ì—°ìŠ¹ ë‹¬ì„±" },
        { n: "ìµœì•½ì²´ì¸", c: "ë°°í‹€ 10ì—°íŒ¨ ë‹¬ì„±" },
        { n: "ì°ë”° ê°™ì€", c: "ë°°í‹€ 20ì—°íŒ¨ ë‹¬ì„±" },
        { n: "ë‹¤ íŒ¨ê³  ë‹¤ë‹ˆëŠ”", c: "ë°°í‹€ ëˆ„ì  1,000íšŒ" },
        { n: "ìˆ˜ì§‘ê°€", c: "ì¡ì€ í¬ì¼“ëª¬ 50ì¢… ë‹¬ì„±" },
        { n: "ìˆ˜ì§‘ì— ë¯¸ì¹œ", c: "ì¡ì€ í¬ì¼“ëª¬ 130ì¢… ë‹¬ì„±" },
        { n: "1ì„¸ëŒ€ ë§ˆìŠ¤í„°", c: "ì¡ì€ í¬ì¼“ëª¬ 151ì¢… ë‹¬ì„±" },
        { n: "ì¡ëŠ” ë§›ì„ ì•„ëŠ”", c: "ë³´ìœ  í¬ì¼“ëª¬ 150ë§ˆë¦¬ ë‹¬ì„±" },
        { n: "ì§„ì •í•œ 1ì„¸ëŒ€ ë§ˆìŠ¤í„°", c: "ë„ê° 151ì¢… & ì „ì› Së“±ê¸‰" },
        { n: "ë°±ë§Œì¥ì", c: "100ë§Œ ê³¨ë“œ ë³´ìœ " },
        { n: "ì²œë§Œì¥ì", c: "1,000ë§Œ ê³¨ë“œ ë³´ìœ " },
        { n: "ì´ë”ë¦¬ì›€ í™€ë”", c: "8,000ë§Œ ê³¨ë“œ ë³´ìœ " },
        { n: "ì¼ë¡ ë¨¸ìŠ¤í¬", c: "1ì–µ 5,000ë§Œ ê³¨ë“œ ë³´ìœ " },
        { n: "í”Œë ‰ìŠ¤", c: "ìƒì  ëˆ„ì  1ì–µ ì†Œë¹„" },
        { n: "ê°•í™” ì¤‘ë…ì", c: "ê°•í™” ëˆ„ì  1ì–µ ì†Œë¹„" },
        { n: "ë„íŒŒë¯¼ ì¤‘ë…", c: "ë„íŒŒë¯¼ ê°•í™” 1,000íšŒ ì‚¬ìš©" },
        { n: "íƒœì´ˆë§ˆì„ ëŸ¬ë²„", c: "ë„íŒŒë¯¼ 0ê°• ì´ˆê¸°í™” 10íšŒ ë°œìƒ" },
        { n: "í¬ì¼“ëª¬ ì¥ì˜ì‚¬", c: "ë„íŒŒë¯¼ íŒŒê´´ 10íšŒ ë°œìƒ" },
        { n: "êµ¬ìŠ¬ë™ì ê°™ì€", c: "ëª¬/ìŠˆ/í•˜ ë³¼ 100ê°œì”© ë³´ìœ " },
        { n: "ìš°ì‚¬ì¸ë³¼íŠ¸ ê°™ì€", c: "ë„ë§ì¹˜ê¸° 1,000íšŒ ë‹¬ì„±" },
        { n: "ë”´ë”´í•œê½‚ì¸„", c: "ë¡±ìŠ¤í†¤ 60ê°• ë‹¬ì„±" },
        { n: "í…ŒìŠ¬ë¼ ëŒ€ì£¼ì£¼", c: "ì¬ë” 60ê°• ë‹¬ì„±" },
        { n: "ê°œë§ë‚˜ë‹ˆ", c: "ë§ë‚˜ë‡½ 60ê°• ë‹¬ì„±" },
        { n: "ì«€ë“í•œ", c: "ë‘ì«€ì¿  1,000ê°œ ì‚¬ìš©" },
        { n: "ë¹›ë‚˜ëŠ” ëŒ€ë¨¸ë¦¬", c: "ì´ë¡œì¹˜ í¬ì¼“ëª¬ 5ë§ˆë¦¬ ë³´ìœ " },
        { n: "í‰ë²”í•˜ê²Œ ë¯¸ì¹œ", c: "ì „ì„¤ì˜ ë³¼ ëˆ„ì  3ê°œ êµ¬ë§¤" } // â˜… ì‚¬ì¥ë‹˜ ì§€ì‹œì‚¬í•­ ì¶”ê°€!
      ];

      var collected = 0;
      for (var i = 0; i < masterList.length; i++) {
        var item = masterList[i];
        var has = (u.titles.indexOf(item.n) !== -1);
        if (has) {
          collected++;
          listStr += (i + 1) + ". âœ… " + item.n + " (" + item.c + ")\n";
        } else {
          listStr += (i + 1) + ". ğŸ”’ " + item.n + " (ë¯¸íšë“)\n";
        }
      }

      var rate = Math.floor((collected / masterList.length) * 100);
      replier.reply(
        "ğŸ·ï¸ " + sender + "ë‹˜ì˜ ì¹­í˜¸ ë„ê°\n" +
        "ìˆ˜ì§‘ë¥ : " + rate + "% (" + collected + "/" + masterList.length + ")\n" +
        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
        listStr + "\n" +
        "ğŸ’¡ íšë“í•œ ì¹­í˜¸ë§Œ ìƒì„¸ ì¡°ê±´ì´ ê³µê°œë©ë‹ˆë‹¤!"
      );
      return;
    }

    // [B] ì¹­í˜¸ ì¥ì°© (ë²ˆí˜¸/ì´ë¦„)
    if (sub) {
        var targetTitle = "";
        var num = parseInt(sub, 10);
        if (!isNaN(num)) {
            var idx = num - 1;
            if (idx >= 0 && idx < u.titles.length) {
                targetTitle = u.titles[idx];
            } else {
                replier.reply("ğŸš« í•´ë‹¹ ë²ˆí˜¸ì˜ ì¹­í˜¸ë¥¼ ë³´ìœ í•˜ê³  ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.");
                return;
            }
        } else {
            targetTitle = parts.slice(1).join(" ");
            if (u.titles.indexOf(targetTitle) === -1 && u.titles.indexOf(targetTitle + "ì¸") !== -1) {
                targetTitle = targetTitle + "ì¸";
            }
        }

        if (u.titles.indexOf(targetTitle) !== -1) {
            u.activeTitle = targetTitle;
            commitSave(true);
            replier.reply("ğŸ·ï¸ ì¹­í˜¸ ì¥ì°© ì™„ë£Œ!\nì´ì œë¶€í„° '" + targetTitle + " " + sender + "'ë‹˜ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.");
        } else {
            replier.reply("ğŸš« ë³´ìœ í•˜ì§€ ì•Šì€ ì¹­í˜¸ì…ë‹ˆë‹¤.");
        }
        return;
    }

    // [C] ë‚´ ë³´ìœ  ëª©ë¡ ì¡°íšŒ
    var myStr = "";
    for (var j = 0; j < u.titles.length; j++) {
      var tName = u.titles[j];
      var mark = (tName === u.activeTitle) ? "âœ…" : "â¬œ";
      myStr += (j + 1) + ". " + mark + " " + tName + "\n";
    }

    replier.reply(
      "ğŸ·ï¸ " + sender + "ë‹˜ì˜ ë³´ìœ  ì¹­í˜¸ ëª©ë¡\n" +
      "í˜„ì¬ ì¥ì°©: " + (u.activeTitle || "ë‰´ë¹„") + "\n\n" +
      myStr + "\n" +
      "ğŸ’¡ ì‚¬ìš©ë²•: /ì¹­í˜¸ [ë²ˆí˜¸]\n" +
      "ğŸ’¡ ì „ì²´ ëª©ë¡ í™•ì¸: /ì¹­í˜¸ ë„ê°"
    );
    return;
  }



  // -------------------- [ìˆ˜ì •ë¨] ë„ê° ì‹œìŠ¤í…œ (ì´ë¡œì¹˜ ìë™ ë™ê¸°í™” & ì™•ê´€) --------------------
  if (msg.indexOf("/ë„ê°") === 0) {
    var t = getTargetFromMsg(d, sender, msg, "/ë„ê°");
    if (!t) { replier.reply("ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }

    var target = t.user;
    var targetName = t.name;
    ensureUserDex(target);

    // â˜… [í•µì‹¬] ê°€ë°©ì„ ë’¤ì ¸ì„œ ë„ê°ì— 'ì´ë¡œì¹˜' ë„ì¥ ì°ê¸° (ë™ê¸°í™”)
    // ì´ ë¶€ë¶„ì´ ìˆì–´ì•¼ ê°€ë°©ì— ìˆëŠ” ì´ë¡œì¹˜ê°€ ë„ê°ì—ë„ í‘œì‹œë©ë‹ˆë‹¤!
    if (target.pokemons) {
        for(var k=0; k<target.pokemons.length; k++) {
            var p = target.pokemons[k];
            // ê°€ë°©ì— ì´ë¡œì¹˜ê°€ ìˆë‹¤ë©´?
            if (p.shiny) {
                var pidStr = String(p.pid);
                // ë„ê°ì— ê¸°ë¡ì´ ì—†ìœ¼ë©´ ë§Œë“¤ê³ , ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸
                if (!target.dex[pidStr]) {
                    target.dex[pidStr] = { seen: 0, caught: 0, maxGrade: "D", hasShiny: true };
                } else {
                    target.dex[pidStr].hasShiny = true; // ë„ì¥ ì¾…!
                }
            }
        }
    }

    // í†µê³„ ê³„ì‚°
    var total = POKEMON_DB.length;
    var uniqueCaught = 0;
    var shinyCount = 0; // ì´ë¡œì¹˜ ìˆ˜ì§‘ ê°œìˆ˜

    for (var i = 0; i < POKEMON_DB.length; i++) {
      var id = String(POKEMON_DB[i].id);
      if (target.dex[id]) {
          if (target.dex[id].caught > 0) uniqueCaught++;
          if (target.dex[id].hasShiny) shinyCount++;
      }
    }

    var rate = Math.floor((uniqueCaught / total) * 1000) / 10;

    var summary =
      "ğŸ“– " + targetName + "ë‹˜ì˜ í¬ì¼“ëª¬ ë„ê°\n" +
      "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
      "âœ… ìˆ˜ì§‘ë¥ : " + uniqueCaught + " / " + total + " (" + rate + "%)\n" +
      "âœ¨ ì´ë¡œì¹˜ ë°œê²¬: " + shinyCount + "ì¢…\n\n" +
      "ì „ì²´ë³´ê¸°ë¡œ ìƒì„¸ ëª©ë¡ì„ í™•ì¸í•˜ì„¸ìš”.";

    // ìƒì„¸ ëª©ë¡ ì¶œë ¥
    var full = "\n\n[ë„ê° ëª©ë¡ / ìµœê³  í‹°ì–´]\n" + "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n";
    
    for (var j = 0; j < POKEMON_DB.length; j++) {
      var pp = POKEMON_DB[j];
      var pid = String(pp.id);
      var rec = target.dex[pid] || { seen: 0, caught: 0, maxGrade: "" };
      
      var mark = rec.caught ? "âœ”" : rec.seen ? "ğŸ‘€" : "â–¡";
      
      // ë“±ê¸‰, ì™•ê´€, ì´ë¡œì¹˜ í‘œì‹œ ë¡œì§
      var infoMsg = "";
      if (rec.caught) {
        var grade = rec.maxGrade || "D";
        var crown = (grade === "S") ? " ğŸ‘‘" : "";     // Sê¸‰ì´ë©´ ì™•ê´€
        var star = (rec.hasShiny) ? " âœ¨" : "";      // â˜… ì´ë¡œì¹˜ë©´ ë°˜ì§ì´ ì¶”ê°€!
        
        infoMsg = " [" + grade + "ë“±ê¸‰]" + crown + star;
      }

      full += mark + " #" + pp.id + " " + pp.name + infoMsg + "\n";
    }

    replyFold(replier, summary, full);
    return;
  }

  // -------------------- [ìˆ˜ì •ë¨] ì´ë¡œì¹˜ ì „ìš© ë„ê° (ìë™ ë™ê¸°í™” í¬í•¨) --------------------
  if (msg === "/ì´ë¡œì¹˜" || msg === "/ì´ë¡œì¹˜ë„ê°") {
    var t = getTargetFromMsg(d, sender, msg, "/ì´ë¡œì¹˜");
    if (!t) return;
    var target = t.user;
    var targetName = t.name;
    
    ensureUserDex(target);

    // â˜… [í•µì‹¬ ì¶”ê°€] ë‚´ ê°€ë°©(ì¸ë²¤í† ë¦¬)ì„ ë’¤ì ¸ì„œ ë„ê°ì— 'ì´ë¡œì¹˜ íšë“' ë„ì¥ ì°ê¸°
    if (target.pokemons) {
        for(var k=0; k<target.pokemons.length; k++) {
            var p = target.pokemons[k];
            // ë§Œì•½ ê°€ë°©ì— ì´ë¡œì¹˜ê°€ ìˆëŠ”ë°?
            if (p.shiny) {
                var pidStr = String(p.pid);
                // ë„ê°ì— ê¸°ë¡ì´ ì—†ê±°ë‚˜, shiny ì²´í¬ê°€ ì•ˆ ë˜ì–´ ìˆë‹¤ë©´?
                if (!target.dex[pidStr]) {
                    target.dex[pidStr] = { seen: 0, caught: 0, maxGrade: "D", hasShiny: true };
                } else {
                    target.dex[pidStr].hasShiny = true; // ë„ì¥ ì¾…!
                }
            }
        }
    }

    // ë³´ìœ í•œ ì´ë¡œì¹˜ë§Œ í•„í„°ë§ (ì´ì œ ë„ì¥ì´ ì°í˜”ìœ¼ë‹ˆ ì˜ ë³´ì¼ ê²ë‹ˆë‹¤)
    var myShinies = [];
    for (var i = 0; i < POKEMON_DB.length; i++) {
        var db = POKEMON_DB[i];
        var pid = String(db.id);
        
        if (target.dex[pid] && target.dex[pid].hasShiny) {
            myShinies.push(db);
        }
    }

    if (myShinies.length === 0) {
        replier.reply("âœ¨ " + targetName + "ë‹˜ì€ ì•„ì§ ë°œê²¬í•œ ì´ë¡œì¹˜ í¬ì¼“ëª¬ì´ ì—†ìŠµë‹ˆë‹¤.\n(í•„ë“œì—ì„œ 0.5% í™•ë¥ ë¡œ ë“±ì¥í•©ë‹ˆë‹¤!)");
        return;
    }

    var totalShiny = POKEMON_DB.length;
    var rate = Math.floor((myShinies.length / totalShiny) * 1000) / 10;

    var out = "âœ¨ " + targetName + "ë‹˜ì˜ ìƒ¤ì´ë‹ˆ ì»¬ë ‰ì…˜ âœ¨\n" +
              "ìˆ˜ì§‘ í˜„í™©: " + myShinies.length + " / " + totalShiny + " (" + rate + "%)\n" +
              "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n";
    
    for (var k = 0; k < myShinies.length; k++) {
        var s = myShinies[k];
        out += "ğŸŒŸ #" + s.id + " " + s.name + "\n";
    }
    
    out += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
           "ì´ë¡œì¹˜ëŠ” ì¼ë°˜ í¬ì¼“ëª¬ë³´ë‹¤ ê°•ë ¥í•©ë‹ˆë‹¤!";

    replier.reply(out);
    return;
  }

  // ==================================================================
  // ğŸ§­ [íƒí—˜ ì‹œìŠ¤í…œ v2.4] (ë‹‰ë„¤ì„ í‘œì‹œ & 1ì‹œê°„ ì ìš©)
  // ==================================================================

  // 1. íƒí—˜ ì·¨ì†Œ (ì‹¤ìˆ˜ ë°©ì§€ìš©)
  if (msg === "/íƒí—˜ì·¨ì†Œ") {
    if (!u.exploration) {
      replier.reply("í˜„ì¬ íƒí—˜ ì¤‘ì¸ í¬ì¼“ëª¬ì´ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }
    var pEx = findUserPokemonByUid(u, u.exploration.uid);
    var pName = pEx ? getDisplayName(pEx) : "ì•Œ ìˆ˜ ì—†ëŠ” í¬ì¼“ëª¬";

    delete u.exploration; 
    commitSave(true);

    replier.reply(
      "â†©ï¸ íƒí—˜ì„ ì·¨ì†Œí•˜ê³  ê¸´ê¸‰ ë³µê·€ ëª…ë ¹ì„ ë‚´ë ¸ìŠµë‹ˆë‹¤.\n\n" +
      "ğŸƒ " + decoName + "ë‹˜ì˜ " + pName + "ì´(ê°€) ë¹ˆì†ìœ¼ë¡œ í—ë ˆë²Œë–¡ ëŒì•„ì™”ìŠµë‹ˆë‹¤.\n" +
      "âš ï¸ ì¤‘ë„ í¬ê¸°ë¡œ ì¸í•´ ì•„ë¬´ëŸ° ë³´ìƒë„ íšë“í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."
    );
    return;
  }

  // 2. íƒí—˜ ë©”ì¸ ëª…ë ¹ì–´
  if (msg.indexOf("/íƒí—˜") === 0) {
    var now = nowMs();
    
    // â˜… [ì„¤ì •] íƒí—˜ ì†Œìš” ì‹œê°„ (1ì‹œê°„ ì ìš© ì™„ë£Œ)
    var EXPLORE_TIME_MS = 60 * 60 * 1000; 

    // -----------------------------------------------------------
    // [A] íƒí—˜ ë³µê·€ ë° ê²°ê³¼ ì •ì‚°
    // -----------------------------------------------------------
    if (u.exploration) {
      var diff = u.exploration.endAt - now;
      var pEx = findUserPokemonByUid(u, u.exploration.uid);
      var pName = pEx ? getDisplayName(pEx) : "ì•Œ ìˆ˜ ì—†ëŠ” í¬ì¼“ëª¬";

      // 1) ì•„ì§ ì‹œê°„ ì•ˆ ë¨
      if (diff > 0) {
        var min = Math.floor(diff / 60000);
        var sec = Math.floor((diff % 60000) / 1000);
        replier.reply(
          "ğŸ§­ " + decoName + "ë‹˜ì˜ " + pName + "ì´(ê°€) ëŒ€ëª¨í—˜ì„ ë– ë‚œ ìƒíƒœì…ë‹ˆë‹¤.\n" +
          "í˜„ì¬ [" + u.exploration.routes[Math.floor(Math.random()*u.exploration.routes.length)] + "] ì£¼ë³€ì„ ì§€ë‚˜ëŠ” ì¤‘...\n\n" +
          "â³ ë‚¨ì€ ì‹œê°„: " + min + "ë¶„ " + sec + "ì´ˆ\n" +
          "âš ï¸ íƒí—˜ ì¤‘ì—ëŠ” í•´ë‹¹ í¬ì¼“ëª¬ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
        );
        return;
      }

      // 2) â˜… [ë³´ìƒ ì •ì‚° ë¡œì§]
      var baseGold = randInt(100000, 300000); 
      var baseExp = randInt(30000, 50000);   
      
      var pGrade = pEx ? (pEx.grade || "D") : "D";
      var pEnh = pEx ? (pEx.enh || 0) : 0;

      var bonusMult = 1 + (u.trainerLv * 0.05) + (pEnh * 0.05); 
      var finalGold = Math.floor(baseGold * bonusMult);
      var finalExp = Math.floor(baseExp * bonusMult);

      var lootCalc = 3; 
      if (pGrade === "S") lootCalc += 2;
      else if (pGrade === "A") lootCalc += 1;
      lootCalc += Math.floor(pEnh / 20); 
      
      var lootCount = Math.min(7, lootCalc); 
      lootCount += randInt(-1, 1); 
      lootCount = Math.max(3, Math.min(7, lootCount)); 

      var itemLog = "";
      
      for(var i=0; i<lootCount; i++) {
          var rVal = Math.random();
          
          if (rVal < 0.0005) { 
              u.godBall++; itemLog += "ğŸ‘‘ ìŠˆí¼ìš¸íŠ¸ë¼í‚¹ê°“ì— í˜ëŸ¬ê°œì©ŒëŠ”í•˜ì´í¼ì±Œë¦°ì €í˜ì´ì»¤í‰ë²”í•œìš©íƒœëŠ”ë¯¸ì¹œì‚¬ëŒê°“ë¯¼ìˆ˜ë„ë¶€ë³¼ +1 (ì´ˆëŒ€ë°•!!)\n"; 
          }
          else if (rVal < 0.08) { 
              u.reroll++; itemLog += "ğŸ”„ í‹°ì–´ë¦¬ì…‹ê¶Œ +1 (ëŒ€ë°•!!)\n"; 
          }
          else if (rVal < 0.15) { 
              u.cookie++; itemLog += "ğŸª ë‘ì«€ì¿  +1\n"; 
          }
          else if (rVal < 0.30) { 
              u.dopaTicket++; itemLog += "ğŸ’³ ë„íŒŒë¯¼ê°•í™”ê¶Œ +1\n"; 
          }
          else if (rVal < 0.45) { 
              var tAmt = (Math.random() < 0.3) ? 2 : 1;
              u.ticket += tAmt; itemLog += "ğŸ« ì´ë™í‹°ì¼“ +" + tAmt + "\n"; 
          }
          else if (rVal < 0.65) { 
              var amt = randInt(5, 15);
              u.ultraBall += amt; itemLog += "âš« í•˜ì´í¼ë³¼ +" + amt + "\n";
          }
          else if (rVal < 0.85) { 
              var amt = randInt(15, 30);
              u.superBall += amt; itemLog += "ğŸ”µ ìŠˆí¼ë³¼ +" + amt + "\n";
          }
          else { 
              var ballAmt = randInt(30, 50);
              u.ball += ballAmt; itemLog += "ğŸ”´ ëª¬ìŠ¤í„°ë³¼ +" + ballAmt + "\n";
          }
      }
      
      u.gold += finalGold;
      addExpWithLevelUpMsg(u, finalExp);
      var routeStr = u.exploration.routes.join(" â” ");

      delete u.exploration; 
      commitSave(true);
      checkAndNotifyTitles(u, replier);

      var performanceMsg = "í‰ë²”í•œ íƒí—˜ì´ì—ˆìŠµë‹ˆë‹¤.";
      if (lootCount >= 7) performanceMsg = "ğŸ”¥ " + pGrade + "ë“±ê¸‰ " + pEnh + "ê°•ì˜ ì••ë„ì ì¸ ìŠ¤í™ìœ¼ë¡œ ì§€ì—­ì„ íœ©ì“¸ì—ˆìŠµë‹ˆë‹¤!";
      else if (lootCount >= 5) performanceMsg = "âœ¨ í›Œë¥­í•œ ëŠ¥ë ¥ì¹˜ ë•ë¶„ì— ë§ì€ ë³´ë¬¼ì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤!";

      // â˜… [ìˆ˜ì •] ë‹‰ë„¤ì„ í‘œì‹œ ì¶”ê°€
      replier.reply(
        "ğŸ‰ " + decoName + "ë‹˜ì˜ " + pName + " íƒí—˜ ë³µê·€ ì™„ë£Œ!\n" +
        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
        "ğŸ—ºï¸ ì´ë™ ê²½ë¡œ:\n" + routeStr + "\n\n" +
        "ğŸ’¬ íƒí—˜ ë³´ê³ :\n" + performanceMsg + "\n\n" +
        "ğŸ’¼ íšë“ ì „ë¦¬í’ˆ (" + lootCount + "ì¢…):\n" +
        "ğŸ’° ê³¨ë“œ: +" + fmtNum(finalGold) + "ğŸ’°\n" +
        "âœ¨ ê²½í—˜ì¹˜: +" + fmtNum(finalExp) + "EXP\n" +
        "ğŸ“¦ ì•„ì´í…œ:\n" + itemLog +
        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
        "ìˆ˜ê³ í–ˆì–´! í‘¹ ì‰¬ë ´."
      );
      return;
    }

    // -----------------------------------------------------------
    // [B] ìƒˆë¡œìš´ íƒí—˜ ì‹œì‘ (í¬ì¼“ëª¬ ì§€ì •)
    // -----------------------------------------------------------
    var parts = msg.split(" ").filter(Boolean);
    var targetUid = parseInt(parts[1], 10);

    if (isNaN(targetUid)) {
      replier.reply(
        "ğŸ’ ëˆ„êµ¬ë¥¼ ëŒ€ëª¨í—˜ì— ë³´ë‚¼ê¹Œìš”?\n" +
        "ì‚¬ìš©ë²•: /íƒí—˜ [í¬ì¼“ëª¬UID]\n" +
        "ì˜ˆ: /íƒí—˜ 15\n\n" +
        "ğŸ’¡ 1ì‹œê°„ ì†Œìš” / ê°•í•œ í¬ì¼“ëª¬ì¼ìˆ˜ë¡ ì•„ì´í…œì„ ë” ë§ì´(ìµœëŒ€ 7ì¢…) ê°€ì ¸ì˜µë‹ˆë‹¤!\n" +
        "(ë“±ê¸‰ S/A ë° ê³ ê°•í™” í¬ì¼“ëª¬ ì¶”ì²œ)"
      );
      return;
    }

    var pStart = findUserPokemonByUid(u, targetUid);
    if (!pStart) {
      replier.reply("í•´ë‹¹ UIDì˜ í¬ì¼“ëª¬ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    var pNameStart = getDisplayName(pStart);

    var routeCount = randInt(3, 5);
    var routes = [];
    var possibleRegions = [];
    for(var k=0; k<REGIONS.length; k++) {
        if (REGIONS[k].key !== "ëƒ¥ì¹˜ì˜ ë°©") possibleRegions.push(REGIONS[k].key);
    }
    
    for(var r=0; r<routeCount; r++) {
        routes.push(randomPick(possibleRegions));
    }
    if (Math.random() < 0.1) routes.push("ëƒ¥ì¹˜ì˜ ë°©");

    u.exploration = {
      uid: pStart.uid,
      routes: routes,
      region: routes[0], 
      startAt: now,
      endAt: now + EXPLORE_TIME_MS
    };

    commitSave(true);
    
    // â˜… [ìˆ˜ì •] ë‹‰ë„¤ì„ í‘œì‹œ ì¶”ê°€
    replier.reply(
      "ğŸ’ " + decoName + "ë‹˜ì˜ " + pNameStart + "ì´(ê°€) ëŒ€ëª¨í—˜ì„ ë– ë‚©ë‹ˆë‹¤!\n" +
      "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
      "ğŸ“… ì˜ˆì • ê²½ë¡œ: " + routes[0] + " ì™¸ " + (routes.length-1) + "ê³³\n" +
      "â³ ì†Œìš” ì‹œê°„: 1ì‹œê°„\n" +
      "ğŸ’ª ê¸°ëŒ€ ë³´ìƒ: ë“±ê¸‰/ê°•í™” ìˆ˜ì¹˜ì— ë¹„ë¡€\n" +
      "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
      "ğŸ‘‹ \"ë‹¤ë…€ì˜¤ê² ìŠµë‹ˆë‹¤! ëŒ€ë°• í„°íŠ¸ë¦¬ê³  ì˜¬ê²Œìš”!\"\n" +
      "(íƒí—˜ ì¤‘ì—ëŠ” í•´ë‹¹ í¬ì¼“ëª¬ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.)"
    );
    return;
 }


  if (msg === "/ì „ì ") {
    ensureUserStats(u);
    var total = u.stats.battleWin + u.stats.battleLose + u.stats.battleDraw;
    if (total === 0) {
      replier.reply("ì•„ì§ ë°°í‹€ ì „ì ì´ ì—†ìŠµë‹ˆë‹¤.\n/ë°°í‹€ ë¡œ ì²« ì „íˆ¬ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”.");
      return;
    }
    replier.reply(sender + "ë‹˜ì˜ ë°°í‹€ ì „ì \n\n" + formatRecord(u));
    return;
  }
// -------------------- [ìˆ˜ì •ë¨] ê°•í™” ì‹œìŠ¤í…œ (ì§„í™” ì•Œë¦¼ ì¶”ê°€) --------------------
  if (msg.indexOf("/ê°•í™”") === 0) {
    var nowE = nowMs();
    if (nowE - u.lastEnhanceAt < ENHANCE_COOLDOWN_MS) {
      var remain = ENHANCE_COOLDOWN_MS - (nowE - u.lastEnhanceAt);
      var sec = Math.ceil(remain / 1000);
      replier.reply(sayDo(decoName, pick(COOLDOWN_LINES)) + "\nâ³ " + sec + "ì´ˆ í›„ ë‹¤ì‹œ ê°•í™”ë¥¼ ì‹œë„í•  ìˆ˜ ìˆì–´ìš”.");
      return;
    }
    u.lastEnhanceAt = nowE;

    var spE = msg.split(" ");
    if (spE.length < 2) {
      replier.reply("ì‚¬ìš©ë²•: /ê°•í™” [í¬ì¼“ëª¬UID]\nì˜ˆ: /ê°•í™” 12");
      return;
    }
    var uidEnh = parseInt(spE[1], 10);
    if (!uidEnh) { replier.reply("í¬ì¼“ëª¬UIDê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."); return; }

    var p = findUserPokemonByUid(u, uidEnh);
    if (!p) { replier.reply("í•´ë‹¹ í¬ì¼“ëª¬ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }

if (isPokemonBusy(u, p.uid)) {
        replier.reply("ğŸš« í•´ë‹¹ í¬ì¼“ëª¬ì€ í˜„ì¬ íƒí—˜ ì¤‘ì…ë‹ˆë‹¤.\nëŒì•„ì˜¬ ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.");
        return;
    }

    if (p.enh >= ENHANCE_MAX) {
      replier.reply("ì´ë¯¸ ìµœëŒ€ ê°•í™” ë‹¨ê³„(" + ENHANCE_MAX + "ê°•)ì…ë‹ˆë‹¤.");
      return;
    }

    var dbp = findPokemonDB(p.pid);
    var pName = dbp ? dbp.name : "í¬ì¼“ëª¬";
    var nextEnh = (p.enh || 0) + 1;
    var rarity = dbp ? dbp.rarity : 2;
    var cost = enhanceCostByRarity(nextEnh, rarity);

    if (u.gold < cost) {
      replier.reply(sender + "ë‹˜, ê°•í™” ë¹„ìš©ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.\ní•„ìš”: " + fmtNum(cost) + "ğŸ’°\në³´ìœ : " + fmtNum(u.gold) + "ğŸ’°");
      return;
    }

    // 1. ê³¨ë“œ ì°¨ê°
    u.gold -= cost;

    // 2. [í†µê³„] ê°•í™”ë¹„ ëˆ„ì 
    if (!u.stats.totalSpentEnhance) u.stats.totalSpentEnhance = 0;
    u.stats.totalSpentEnhance += cost;

    // 3. ê°•í™” ì‹œë„
    var rates = enhanceRatesByRarity(nextEnh, u.trainerLv, rarity);
    var rVal = Math.random();
    var resultType = ENH_RESULT_KEEP; 

    if (rVal < rates.success) resultType = ENH_RESULT_UP;
    else if (rVal < rates.success + rates.keep) resultType = ENH_RESULT_KEEP;
    else resultType = ENH_RESULT_DOWN;

    var before = p.enh;
    var after = before;
    var evoMsg = null; // â˜… ì§„í™” ë©”ì‹œì§€ ì €ì¥ ë³€ìˆ˜

    if (resultType === ENH_RESULT_UP) {
      p.enh = nextEnh;
      after = nextEnh;
      // â˜… ì§„í™” í•¨ìˆ˜ ì‹¤í–‰ ê²°ê³¼ë¥¼ ë³€ìˆ˜ì— ì €ì¥!
      evoMsg = tryAutoEvolveByEnh(p); 
    } else if (resultType === ENH_RESULT_DOWN) {
      p.enh = Math.max(0, before - 1);
      after = p.enh;
    }

    commitSave(true);
    
    var resultMsg = buildEnhResultMsg(sender, p, before, after, resultType);
    
    // â˜… [ì¶”ê°€ë¨] ì§„í™” ì„±ê³µ ì‹œ ë©”ì‹œì§€ ë¶™ì´ê¸°
    if (evoMsg) {
        // [ìˆ˜ì • 2] ì§„í™” í›„ì—ë„ ì´ë¡œì¹˜ í‘œì‹œê°€ ìœ ì§€ë˜ë„ë¡ getDisplayName(p) ì‚¬ìš©
        var evolvedName = getDisplayName(p); 
        resultMsg += "\n\nğŸ§¬ ì¶•í•˜í•©ë‹ˆë‹¤! " + evolvedName + "(ìœ¼)ë¡œ ì§„í™”ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤.\n" + evoMsg;
        
        // ì§„í™”í–ˆìœ¼ë©´ ë„ê°ì—ë„ ë“±ë¡
        dexCaught(u, p.pid, p.grade);
    }
    var nextInfo = buildNextEnhInfoLine(p, resultType, u);
    replier.reply(resultMsg + nextInfo);
    return;
  }


  // -------------------- [ìˆ˜ì •ë¨] ì¶œì„ ì²´í¬ (ì±”í”¼ì–¸ ì—°ê¸ˆ ìƒí–¥: í‚¹ê°“ë³¼ + ì½”ì¸ 300ê°œ) --------------------
  if (msg === "/ì¶œì„" || msg === "/ì¶œì„ì²´í¬") {
    var r = doAttendanceCheck(u, sender);
    
    // ì¶œì„ ì„±ê³µ ì‹œ ì±”í”¼ì–¸ ì²´í¬
    if (r.ok) {
        // í˜„ì¬ ì±”í”¼ì–¸ì´ ë‚˜(sender)ì´ê³ , NPCê°€ ì•„ë‹ˆë¼ë©´?
        if (d.champion && d.champion.name === sender && !d.champion.isNpc) {
            // 1. í‚¹ê°“ë³¼ 1ê°œ
            u.godBall = (u.godBall || 0) + 1;
            // 2. ë‹¤ì½”íƒ€ ì½”ì¸ 300ê°œ (ì‹ ê·œ)
            u.dakotaCoin = (u.dakotaCoin || 0) + 300;
            
            r.msg += "\n\nğŸ‘‘ [ì±”í”¼ì–¸ íŠ¹ì „]\nì„œë²„ì˜ ì§€ë°°ìì—ê²Œ ì¡°ê³µì´ ë„ì°©í–ˆìŠµë‹ˆë‹¤.\nğŸ í‚¹ê°“ë³¼ +1ê°œ\nğŸª™ ë‹¤ì½”íƒ€ ì½”ì¸ +300ê°œ";
        }
    }

    commitSave(true);
    replier.reply(r.msg);
    return;
  }

  // -------------------- [ìˆ˜ì •ë¨] ë„íŒŒë¯¼ ì‹œìŠ¤í…œ (ì¸ìƒ ì—­ì „ íŒ¨ì¹˜) --------------------
  if (msg.indexOf("/ë„íŒŒë¯¼") === 0) {
    var spD = msg.split(" ");
    if (spD.length < 2) { replier.reply("ì‚¬ìš©ë²•: /ë„íŒŒë¯¼ [í¬ì¼“ëª¬UID]\nì˜ˆ: /ë„íŒŒë¯¼ 12"); return; }
    
    var uidD = parseInt(spD[1], 10);
    if (!uidD) { replier.reply("í¬ì¼“ëª¬UIDê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."); return; }

    var pD = findUserPokemonByUid(u, uidD);
    
    if (!pD) { replier.reply("í•´ë‹¹ í¬ì¼“ëª¬ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }

    // íƒí—˜ ì¤‘ì¸ì§€ ì²´í¬
    if (isPokemonBusy(u, pD.uid)) {
        replier.reply("ğŸš« í•´ë‹¹ í¬ì¼“ëª¬ì€ í˜„ì¬ íƒí—˜ ì¤‘ì…ë‹ˆë‹¤.\nëŒì•„ì˜¬ ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.");
        return;
    }

    if (pD.enh >= ENHANCE_MAX) {
      replier.reply("ì´ë¯¸ ìµœëŒ€ ê°•í™” ë‹¨ê³„(" + ENHANCE_MAX + "ê°•)ì…ë‹ˆë‹¤.");
      return;
    }

    if (!u.dopaTicket || u.dopaTicket <= 0) {
      replier.reply("ë„íŒŒë¯¼ê°•í™”ê¶Œì´ ì—†ìŠµë‹ˆë‹¤.\n/ìƒì  ì—ì„œ êµ¬ë§¤í•´ì£¼ì„¸ìš”.");
      return;
    }

    // 1. í‹°ì¼“ ì†Œëª¨ ë° í†µê³„ ê¸°ë¡
    u.dopaTicket--;
    u.stats.totalDopaUsed = (u.stats.totalDopaUsed || 0) + 1;

    var before = (typeof pD.enh === "number") ? pD.enh : 0;
    var pNameD = getDisplayName(pD);

    // ğŸ² í™•ë¥  ì£¼ì‚¬ìœ„ êµ´ë¦¬ê¸° (0.0 ~ 1.0)
    var roll = Math.random();
    
    var out = "";
    var header = "ğŸ° ë„íŒŒë¯¼ ê°•í™” ì‹œë„!\n" + decoName + "ë‹˜ì´ ìš´ëª…ì„ ê²ë‹ˆë‹¤...\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\n";
    var targetLine = "ğŸ‘¾ ëŒ€ìƒ: #" + uidD + " " + pNameD + "\n";

    // ğŸ’€ [1%] íŒŒê´´ (ëŒ€ì°¸ì‚¬)
    if (roll < 0.01) {
       var idxD = -1;
       for (var k=0; k<u.pokemons.length; k++) {
         if (u.pokemons[k].uid === uidD) { idxD = k; break; }
       }
       if (idxD >= 0) {
         u.pokemons.splice(idxD, 1);
         u.stats.totalDopaDestroy = (u.stats.totalDopaDestroy || 0) + 1;
       }
       out = header + "ğŸ’€ [íŒŒê´´] ğŸ’€\n\në„íŒŒë¯¼ ê³¼ë¶€í•˜ë¡œ í¬ì¼“ëª¬ì´ ì†Œë©¸í–ˆìŠµë‹ˆë‹¤...\n(1%ì˜ ë¶ˆìš´ì´ ì ì¤‘í–ˆìŠµë‹ˆë‹¤)\n\n" + targetLine;
       
       commitSave(true);
       checkAndNotifyTitles(u, replier);
       replier.reply(out);
       return;
    }

    // ğŸ“ˆ [40%] ëŒ€ë°• ìƒìŠ¹ (+2 ~ +10)
    else if (roll < 0.41) { 
       var upAmount = randInt(2, 10);
       var after = Math.min(ENHANCE_MAX, before + upAmount);
       pD.enh = after;
       
       // ì§„í™” ì²´í¬
       var evoMsg = tryAutoEvolveByEnh(pD);
       if(evoMsg) pNameD = getDisplayName(pD); // ì§„í™”í–ˆìœ¼ë©´ ì´ë¦„ ê°±ì‹ 

       out = header + "ğŸš€ [ëŒ€ì„±ê³µ] ğŸš€\n\ní•œê³„ë¥¼ ëŒíŒŒí–ˆìŠµë‹ˆë‹¤! (+" + upAmount + "ê°•)\n\n" + targetLine + "ğŸ”¥ " + before + "ê°• â†’ " + after + "ê°• ğŸ”¥";
       if(evoMsg) out += "\n\nğŸ§¬ ì§„í™” ì„±ê³µ!\n" + evoMsg;
    }

    // ğŸ›¡ï¸ [30%] ìœ ì§€ (í‹°ì¼“ë§Œ ë‚ ë¦¼)
    else if (roll < 0.71) {
       out = header + "ğŸ’¨ [ìœ ì§€] ğŸ’¨\n\nì•„ë¬´ ì¼ë„ ì¼ì–´ë‚˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n(íŒŒê´´ë˜ì§€ ì•Šì€ ê²Œ ë‹¤í–‰ì¼ì§€ë„?)\n\n" + targetLine + "ğŸ”¥ í˜„ì¬ ìœ ì§€: " + before + "ê°•";
    }

// ğŸ“‰ [29%] í•˜ë½ (-2 ~ -10)
    else {
       var downAmount = randInt(2, 10);
       var after = Math.max(0, before - downAmount); // 0 ë°‘ìœ¼ë¡œëŠ” ì•ˆ ë‚´ë ¤ê°
       pD.enh = after;

       // â˜… [í•µì‹¬ ì¶”ê°€] 0ê°•ìœ¼ë¡œ ë–¨ì–´ì¡ŒëŠ”ì§€ í™•ì¸ (íƒœì´ˆë§ˆì„ ìŠ¤íƒ ìŒ“ê¸°)
       if (after === 0 && before > 0) {
           // íƒœì´ˆë§ˆì„ ì¹´ìš´íŠ¸ ì¦ê°€ (ì¹­í˜¸ ì¡°ê±´)
           u.stats.totalDopaReset = (u.stats.totalDopaReset || 0) + 1;
           
           out = header + "ğŸ“‰ [íƒœì´ˆë§ˆì„í–‰] ğŸ“‰\n\n" +
                 "ê°•í™” ìˆ˜ì¹˜ê°€ ë°”ë‹¥ìœ¼ë¡œ ê³¤ë‘ë°•ì§ˆì³¤ìŠµë‹ˆë‹¤...\n" +
                 "( 0ê°• ì´ˆê¸°í™” ğŸ˜± ìŠ¤íƒ +1 )\n\n" + 
                 targetLine + "ğŸ”¥ " + before + "ê°• â†’ 0ê°•";
       } 
       else {
           // 0ê°•ê¹Œì§€ëŠ” ì•ˆ ê°”ê³  ê·¸ëƒ¥ ë–¨ì–´ì§
           out = header + "ğŸ“‰ [í•˜ë½] ğŸ“‰\n\n" +
                 "ìœ¼ì•…! ê°•í™” ìˆ˜ì¹˜ê°€ ë¯¸ë„ëŸ¬ì¡ŒìŠµë‹ˆë‹¤...\n" +
                 "( -" + downAmount + "ê°• )\n\n" + 
                 targetLine + "ğŸ”¥ " + before + "ê°• â†’ " + after + "ê°•";
       }
    }

    commitSave(true);
    checkAndNotifyTitles(u, replier);
    replier.reply(out);
    return;
  }

  // -------------------- /ë°°í‹€ --------------------
if (msg === "/ë°°í‹€" || msg.indexOf("/ë°°í‹€ ") === 0) {
  ensureUserStats(u);

  // âœ… í•¨ìˆ˜ ì¡´ì¬ ì²´í¬ (ìš”ì¦˜ ë„ˆ ì—ëŸ¬ ë‚œ í•µì‹¬ì´ ì´ê±°ì˜€ìŒ)
  if (typeof getBattleEligiblePokemons !== "function") {
    replier.reply("ë°°í‹€ ì‹œìŠ¤í…œ ë¡œë”© ì˜¤ë¥˜: getBattleEligiblePokemons í•¨ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.\në°°í‹€ ìœ í‹¸ í•¨ìˆ˜ ì˜ì—­ì— í•´ë‹¹ í•¨ìˆ˜ê°€ ì„ ì–¸ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.");
    return;
  }

  var nowB = nowMs();
  if (nowB - u.stats.lastBattleAt < BATTLE_COOLDOWN_MS) {
    replier.reply(cooldownRemainMsg(sender, u.stats.lastBattleAt, BATTLE_COOLDOWN_MS, "ë°°í‹€"));
    return;
  }
  u.stats.lastBattleAt = nowB;

  // /ë°°í‹€ #33 ì²˜ëŸ¼ uid ì§€ì • ê°€ëŠ¥
  var pickUid = null;
  if (msg !== "/ë°°í‹€") {
    var arg = msg.substring(3).trim(); // "/ë°°í‹€" ê¸¸ì´ 3
    arg = arg.replace("#", "").trim();
    pickUid = parseInt(arg, 10);
    if (isNaN(pickUid)) {
      replier.reply("ì‚¬ìš©ë²•: /ë°°í‹€ ë˜ëŠ” /ë°°í‹€ #ë²ˆí˜¸\nì˜ˆ) /ë°°í‹€ #33\n/ë‚´í¬ì¼“ëª¬ ì—ì„œ #ë²ˆí˜¸ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.");
      commitSave(false);
      return;
    }
    if (isPokemonBusy(u, pickUid)) {
        replier.reply("ğŸš« í•´ë‹¹ í¬ì¼“ëª¬ì€ í˜„ì¬ íƒí—˜ ì¤‘ì…ë‹ˆë‹¤.\në°°í‹€ì— ì°¸ê°€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        commitSave(false); // ì¿¨íƒ€ì„ì€ ëŒë ¤ì£¼ì§€ ì•ŠìŒ (ì‹¤ìˆ˜ ë°©ì§€)
        return;
    }
  }

  var r1 = runSingleBattle(d, room, sender, u, pickUid);
  if (!r1.ok) {
    commitSave(false);
    replier.reply(r1.msg);
    return;
  }

  commitSave(true);
  checkAndNotifyTitles(u, replier);
  replyFold(replier, r1.summary, r1.full);
  return;
}

// -------------------- [ìˆ˜ì •ë¨] /ë°°í‹€ì—°ì† (ì´ë¦„ í‘œê¸° ì˜¤ë¥˜ ìˆ˜ì •) --------------------
if (msg.indexOf("/ë°°í‹€ì—°ì†") === 0) {
  ensureUserStats(u);

  if (typeof getBattleEligiblePokemons !== "function") {
    replier.reply("ë°°í‹€ ì‹œìŠ¤í…œ ë¡œë”© ì˜¤ë¥˜");
    return;
  }

  if (ensurePokemonGrades(u)) saveData(d);

  var myEligible0 = getBattleEligiblePokemons(u);
  if (myEligible0.length === 0) {
    replier.reply("ë°°í‹€ ì°¸ê°€ ì¡°ê±´: " + BATTLE_MIN_ENH + "ê°• ì´ìƒ í¬ì¼“ëª¬ì´ í•„ìš”í•©ë‹ˆë‹¤.");
    return;
  }

  var sp = msg.split(" ").filter(Boolean);
  var n = 3;
  if (sp.length >= 2) n = parseInt(sp[1], 10);
  if (isNaN(n)) n = 3;
  n = Math.max(1, Math.min(MAX_BATTLE_CHAIN, n));

  var nowC = nowMs();
  if (nowC - u.stats.lastBattleAt < BATTLE_COOLDOWN_MS) {
    replier.reply(cooldownRemainMsg(sender, u.stats.lastBattleAt, BATTLE_COOLDOWN_MS, "ë°°í‹€"));
    return;
  }

  var win = 0, lose = 0, draw = 0;
  var totalGold = 0, totalExp = 0;
  var allSummary = "";
  var done = 0;
  var lastFull = "";

  for (var i = 1; i <= n; i++) {
    var rr = runSingleBattle(d, room, sender, u, null, {
      isChain: true,
      rewardMult: chainRewardMult(i)
    });

    if (!rr.ok) {
      allSummary += "ã€ì¤‘ë‹¨ã€‘ " + rr.msg + "\n";
      break;
    }

    done++;
    if (rr.result === 1) win++;
    else if (rr.result === -1) lose++;
    else draw++;

    var reward = parseRewardLine(rr.summary);
    totalGold += reward.gold;
    totalExp += reward.exp;

    var resultShort = (rr.result === 1) ? "ìŠ¹" : (rr.result === -1) ? "íŒ¨" : "ë¬´";

    // â˜… [í•µì‹¬ ìˆ˜ì •] ì´ë¦„ í‘œê¸° ë¡œì§ (undefined ë°©ì§€)
    var myP = rr.myPick;
    var opP = rr.oppPick;
    
    // ë‚´ í¬ì¼“ëª¬ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
    var myDb = findPokemonDB(myP.pid);
    var myName = myDb ? myDb.name : "í¬ì¼“ëª¬";
    
    // ìƒëŒ€ íŠ¸ë ˆì´ë„ˆ ë° í¬ì¼“ëª¬ ì´ë¦„ ê°€ì ¸ì˜¤ê¸° (ì „ì²´ ë¡œê·¸ì—ì„œ ì¶”ì¶œí•˜ê±°ë‚˜ ê°ì²´ ì°¸ì¡°)
    var oppDb = findPokemonDB(opP.pid);
    var oppPokeName = oppDb ? oppDb.name : "í¬ì¼“ëª¬";
    
    // ìƒëŒ€ë°© ì´ë¦„ ì°¾ê¸° (runSingleBattleì—ì„œ ë„˜ê²¨ì¤€ ë¡œê·¸ë¥¼ í™œìš©)
    var oppName = extractOppShortFromFull(rr.full, sender) || "ìƒëŒ€";
    // extractOppShortFromFullì€ ì´ë¦„+í¬ì¼“ëª¬ê¹Œì§€ ë‚˜ì˜¤ë¯€ë¡œ ì´ë¦„ë§Œ ë–¼ê¸° ìœ„í•´ ê°€ê³µ
    oppName = oppName.split(" ")[0]; 

    var vsText = "ë‚´ #" + myP.uid + " " + myName + " " + myP.enh + "ê°• vs " + oppName + "ì˜ " + oppPokeName + " " + opP.enh + "ê°•";

    var oneLine =
      "ã€" + i + "/" + n + "ã€‘ " + vsText + " | " + resultShort +
      (reward.raw ? (" | " + reward.raw.replace("ğŸ ë³´ìƒ: ", "")) : "");

    allSummary += oneLine + "\n";
    lastFull = rr.full;
  }

  u.stats.lastBattleAt = nowC + Math.max(0, done - 1) * BATTLE_COOLDOWN_MS;

  var head =
    blockTitle("ì—°ì† ë°°í‹€ ê²°ê³¼") +
    sender + "ë‹˜ " + done + "ì—°ì „ (" + win + "ìŠ¹ " + lose + "íŒ¨)\n" +
    "í•©ê³„: +" + fmtNum(totalGold) + "ğŸ’° / +" + fmtNum(totalExp) + "EXP\n\n" +
    "ì „ì²´ë³´ê¸°ë¡œ ìƒì„¸ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.";

  commitSave(true);
  replyFold(replier, head, allSummary + "\n\n[ë§ˆì§€ë§‰ ë°°í‹€ ë¡œê·¸]\n" + lastFull);
  return;
}
  // -------------------- [ì‹ ê·œ] ëª¨ì˜ ë°°í‹€ (ë‚´ í¬ì¼“ëª¬ë¼ë¦¬ ìŠ¤íŒŒë§) --------------------
  if (msg.indexOf("/ëª¨ì˜ë°°í‹€") === 0) {
    var parts = msg.split(" ").filter(Boolean);
    if (parts.length < 3) {
      replier.reply("âš”ï¸ [ëª¨ì˜ ë°°í‹€]\në‚´ í¬ì¼“ëª¬ë¼ë¦¬ ì‹¸ì›€ì„ ë¶™ì—¬ë³´ì„¸ìš”!\n(ë³´ìƒ/ì „ì  ë°˜ì˜ X)\n\nì‚¬ìš©ë²•: /ëª¨ì˜ë°°í‹€ [UID1] [UID2]\nì˜ˆ: /ëª¨ì˜ë°°í‹€ 15 23");
      return;
    }

    var uidA = parseInt(parts[1], 10);
    var uidB = parseInt(parts[2], 10);

    if (isNaN(uidA) || isNaN(uidB)) { replier.reply("UID ìˆ«ìë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
    if (uidA === uidB) { replier.reply("ìê¸° ìì‹ ê³¼ëŠ” ì‹¸ìš¸ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }

    var pA = findUserPokemonByUid(u, uidA);
    var pB = findUserPokemonByUid(u, uidB);

    if (!pA) { replier.reply("ì²« ë²ˆì§¸ í¬ì¼“ëª¬(UID " + uidA + ")ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
    if (!pB) { replier.reply("ë‘ ë²ˆì§¸ í¬ì¼“ëª¬(UID " + uidB + ")ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }

    // íƒí—˜ ì¤‘ ì²´í¬ (ì„ íƒ ì‚¬í•­: ëª¨ì˜ì „ì´ë¼ ë´ì¤˜ë„ ë˜ì§€ë§Œ, í—·ê°ˆë¦¬ë‹ˆê¹Œ ë§‰ìŒ)
    if (isPokemonBusy(u, pA.uid) || isPokemonBusy(u, pB.uid)) {
        replier.reply("ğŸš« íƒí—˜ ì¤‘ì¸ í¬ì¼“ëª¬ì€ ëª¨ì˜ ë°°í‹€ì— ì°¸ì—¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    var dbA = findPokemonDB(pA.pid);
    var dbB = findPokemonDB(pB.pid);

    // ì´ë¦„ ê°€ì ¸ì˜¤ê¸° (ì´ë¡œì¹˜ ë°˜ì˜)
    var nameA = getDisplayName(pA);
    var nameB = getDisplayName(pB);

    // ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰ (ì–‘ìª½ ë‹¤ ë‚´ ë ˆë²¨ ì ìš©)
    // simulateBattleLog(Aì´ë¦„, A_DB, A_Obj, A_Lv, Bì´ë¦„, B_DB, B_Obj, B_Lv)
    var sim = simulateBattleLog(
        sender + "(A)", dbA, pA, u.trainerLv, 
        sender + "(B)", dbB, pB, u.trainerLv
    );

    // ê²°ê³¼ í…ìŠ¤íŠ¸ êµ¬ì„±
    var resultStr = "";
    if (sim.winner === "A") resultStr = "ğŸ† ìŠ¹ì: #" + uidA + " " + nameA;
    else if (sim.winner === "B") resultStr = "ğŸ† ìŠ¹ì: #" + uidB + " " + nameB;
    else resultStr = "ğŸ¤ ê²°ê³¼: ë¬´ìŠ¹ë¶€";

    // ìš”ì•½ë³¸
    var summary = blockTitle("ëª¨ì˜ ë°°í‹€ ê²°ê³¼") +
                  "ğŸ¥Š " + nameA + " (" + (pA.enh||0) + "ê°•) vs " + nameB + " (" + (pB.enh||0) + "ê°•)\n\n" +
                  resultStr + "\n\n" +
                  "âš ï¸ ëª¨ì˜ì „ì€ ë³´ìƒê³¼ ì „ì ì— ë°˜ì˜ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\n" +
                  "ì „ì²´ë³´ê¸°ë¡œ ìƒì„¸ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.";
    
    // ì „ì²´ë³´ê¸°
    var full = "\n\n[âš”ï¸ ìŠ¤íŒŒë§ ìƒì„¸ ë¡œê·¸]\n\n" + sim.log;

    replyFold(replier, summary, full);
    return;
  }

  if (msg.indexOf("/ë­í‚¹") === 0) {
    var partsR = msg.split(" ").filter(Boolean);
    var typeR = partsR[1];

    // [1] ë„ê° ë­í‚¹
    if (typeR === "ë„ê°") {
      var data = buildDexRankingWithMyRank(d, 10, sender);
      var out = "ğŸ“˜ ë„ê° ë­í‚¹ (Sê¸‰ í¬í•¨)\n";
      for (var i=0; i<data.top.length; i++) {
        var rr = data.top[i];
        out += (i+1) + ". " + rr.name + " (" + rr.percent + "% / Sê¸‰ " + rr.sCount + "ê°œ)\n";
      }
      if (data.myIdx >= 0) {
        var me = data.rows[data.myIdx];
        out += "\në‚´ ìˆœìœ„: " + (data.myIdx+1) + "ìœ„ (" + me.percent + "%)\n";
      }
      replier.reply(out);
      return;
    }

    // [2] ì „íˆ¬ë ¥ ë­í‚¹
    if (typeR === "ì „íˆ¬ë ¥") {
      var pack = buildBattlePowerRanking(d, 7, sender);
      var out = "âš”ï¸ ì „íˆ¬ë ¥ ë­í‚¹ (ëŒ€í‘œ í¬ì¼“ëª¬)\n";
      for (var i=0; i<pack.rows.length; i++) {
        var r = pack.rows[i];
        out += (i+1) + ". " + r.name + " (" + fmtNum(r.power) + " / " + r.pName + ")\n";
      }
      if (pack.myIdx >= 0) {
        var my = pack.rows[pack.myIdx];
        out += "\në‚´ ìˆœìœ„: " + (pack.myIdx+1) + "ìœ„ (" + fmtNum(my.power) + ")\n";
      }
      replier.reply(out);
      return;
    }

  
    // [3] ë°°í‹€ ë­í‚¹ (ë””ìì¸ ê°œì„ íŒ)
    if (typeR === "ë°°í‹€") {
      var list = rankTopList(d);
      
      if (list.length === 0) {
        replier.reply("ì•„ì§ ë°°í‹€ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.\n/ë°°í‹€ ë¡œ ë­í‚¹ì— ë„ì „í•˜ì„¸ìš”!");
        return;
      }

      // ë‚´ ìˆœìœ„ ì°¾ê¸°
      var myRankIdx = -1;
      for(var k=0; k<list.length; k++) {
        if (list[k].name === sender) {
          myRankIdx = k;
          break;
        }
      }

      // 1. ìš”ì•½ë³¸ (ì±„íŒ…ì°½ì— ë°”ë¡œ ë³´ì´ëŠ” ë¶€ë¶„)
      var summary = "ğŸ† ë°°í‹€ ë­í‚¹ ëª…ì˜ˆì˜ ì „ë‹¹\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\n";
      var topSummaryLimit = Math.min(3, list.length); // 1~3ìœ„ë§Œ ê°•ì¡°
      
      for (var i = 0; i < topSummaryLimit; i++) {
        var r = list[i];
        var medal = (i === 0) ? "ğŸ¥‡" : (i === 1) ? "ğŸ¥ˆ" : "ğŸ¥‰";
        summary += medal + " " + r.name + " (" + fmtNum(r.score) + "ì )\n";
      }

      // ë‚´ ìˆœìœ„ ìš”ì•½
      if (myRankIdx !== -1) {
        var myR = list[myRankIdx];
        summary += "\nğŸ‘¤ ë‚´ ìˆœìœ„: " + (myRankIdx + 1) + "ìœ„ (" + fmtNum(myR.score) + "ì )";
      } else {
        summary += "\nğŸ‘¤ ë‚´ ìˆœìœ„: ê¸°ë¡ ì—†ìŒ";
      }
      
      summary += "\n\nì „ì²´ë³´ê¸°ë¡œ 100ìœ„ê¶Œ ìƒì„¸ ê¸°ë¡ì„ í™•ì¸í•˜ì„¸ìš”.";

      // 2. ì „ì²´ë³´ê¸° (ìƒì„¸ ë¦¬ìŠ¤íŠ¸)
      var full = "\n\n[âš”ï¸ ì „ì²´ ë­í‚¹ TOP 100]\n" + "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n";
      var limit = Math.min(100, list.length);

      for (var i = 0; i < limit; i++) {
        var r = list[i];
        var rankStr = (i + 1) + "ìœ„";
        if (i < 3) rankStr = ["ğŸ¥‡1ìœ„", "ğŸ¥ˆ2ìœ„", "ğŸ¥‰3ìœ„"][i];
        
        // ë‚´ ë‹‰ë„¤ì„ì´ë©´ ê°•ì¡° í‘œì‹œ
        var marker = (r.name === sender) ? " ğŸ‘ˆ (ë‚˜)" : "";
        
        full += rankStr + " " + r.name + marker + "\n";
        // ìƒì„¸ ì •ë³´ í•œ ì¤„ ì•„ë˜ì— í‘œì‹œ (ê°€ë…ì„± UP)
        full += "â”” " + fmtNum(r.score) + "ì  | " + r.w + "ìŠ¹ " + r.l + "íŒ¨ | " + r.s + "ì—°ìŠ¹\n";
      }

      // ë§¨ ì•„ë˜ì— ë‚´ ìƒì„¸ ì „ì  ì¹´ë“œ ë¶™ì´ê¸°
      full += "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\n[ğŸ“Š ë‚´ ìƒì„¸ ì „ì ]\n" + formatRecord(u);

      replyFold(replier, summary, full);
      return;
    }

    // [4] ì‹ ê·œ: ì¹­í˜¸ ë­í‚¹
    if (typeR === "ì¹­í˜¸") {
      var tData = buildTitleRanking(d, 10, sender);
      var out = "ğŸ·ï¸ ì¹­í˜¸ ìˆ˜ì§‘ ë­í‚¹ (ì´ " + tData.totalTitles + "ì¢…)\n";
      for (var i=0; i<tData.top.length; i++) {
        var row = tData.top[i];
        out += (i+1) + ". " + row.name + " (" + row.percent + "% / " + row.count + "ê°œ)\n";
      }
      if (tData.myIdx >= 0) {
        var me = tData.rows[tData.myIdx];
        out += "\në‚´ ìˆœìœ„: " + (tData.myIdx+1) + "ìœ„ (" + me.count + "ê°œ)\n";
      }
      replier.reply(out);
      return;
    }

    replier.reply("ğŸ“Š ì‚¬ìš©ë²•: /ë­í‚¹ [ì¢…ë¥˜]\nì¢…ë¥˜: ë„ê°, ì „íˆ¬ë ¥, ë°°í‹€, ì¹­í˜¸");
    return;
  }

  
// ==================================================================
  // ğŸ’° [ë³´ì•ˆ ê°•í™”] ê±°ë˜/êµí™˜/ì„ ë¬¼ í†µí•© ì‹œìŠ¤í…œ (ë½ ì ìš©)
  // ==================================================================

  // 1. 1:1 í¬ì¼“ëª¬ êµí™˜ (ìˆœìˆ˜ êµí™˜ ê¸°ëŠ¥ë§Œ ë‹´ë‹¹)
  if (msg.indexOf("/êµí™˜") === 0) {
    if (TRANSACTION_LOCK[sender]) { replier.reply("â³ ì´ì „ ê±°ë˜ë¥¼ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”."); return; }
    TRANSACTION_LOCK[sender] = true; // ğŸ”’ ë½ ê±¸ê¸°

    try {
      var parts = msg.split(" ").filter(Boolean);
      if (parts.length < 3) {
        replier.reply("ğŸ“¦ ì‚¬ìš©ë²•: /êµí™˜ [ë°›ì„ì‚¬ëŒ] [í¬ì¼“ëª¬UID]\nì˜ˆ: /êµí™˜ ì†ì‚¬ì¥ 15");
        delete TRANSACTION_LOCK[sender]; return;
      }

      var targetName = parts[1].replace("@", "").trim();
      var uidToSend = parseInt(parts[2], 10);

      if (targetName === sender) { replier.reply("ğŸš« ìê¸° ìì‹ ì—ê²ŒëŠ” ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); delete TRANSACTION_LOCK[sender]; return; }
      if (isNaN(uidToSend)) { replier.reply("ğŸš« í¬ì¼“ëª¬ UIDê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."); delete TRANSACTION_LOCK[sender]; return; }

      var targetU = d.users[targetName];
      if (!targetU) { replier.reply("ğŸš« '" + targetName + "'ë‹˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); delete TRANSACTION_LOCK[sender]; return; }
      
      normalizeUserData(targetU);

      // ë‚´ í¬ì¼“ëª¬ í™•ì¸
      var myPidx = -1;
      for (var i = 0; i < u.pokemons.length; i++) {
        if (u.pokemons[i].uid === uidToSend) { myPidx = i; break; }
      }

      if (myPidx === -1) { 
        replier.reply("ğŸš« í•´ë‹¹ UID(#" + uidToSend + ")ì˜ í¬ì¼“ëª¬ì´ ì—†ìŠµë‹ˆë‹¤."); 
        delete TRANSACTION_LOCK[sender]; return; 
      }
      if (u.pokemons.length <= 1) {
        replier.reply("ğŸš« ë§ˆì§€ë§‰ ë‚¨ì€ í¬ì¼“ëª¬ì€ ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        delete TRANSACTION_LOCK[sender]; return;
      }

      var tradeP = u.pokemons[myPidx]; 

if (isPokemonBusy(u, tradeP.uid)) {
          replier.reply("ğŸš« íƒí—˜ì„ ë– ë‚œ í¬ì¼“ëª¬ì€ êµí™˜í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          delete TRANSACTION_LOCK[sender]; return;
      }

      // [í•µì‹¬] íŠ¸ëœì­ì…˜: ë‚´êº¼ ì‚­ì œ -> ìƒëŒ€ ì¶”ê°€
      u.pokemons.splice(myPidx, 1); // ì‚­ì œ

      var newUid = nextPokemonUid(targetU);
      var newPokeObj = JSON.parse(JSON.stringify(tradeP)); // ê¹Šì€ ë³µì‚¬ë¡œ ì•ˆì „í•˜ê²Œ
      newPokeObj.uid = newUid;
      
      if (!targetU.pokemons) targetU.pokemons = [];
      targetU.pokemons.push(newPokeObj);

      dexCaught(targetU, tradeP.pid, tradeP.grade || "D");
      
      commitSave(true);
      checkAndNotifyTitles(u, replier);

      var pDisplayName = getDisplayName(newPokeObj);
      replier.reply("ğŸ“¦ êµí™˜ ì™„ë£Œ!\n" + sender + " â¡ï¸ " + targetName + "\ní¬ì¼“ëª¬: " + pDisplayName + " (#" + newUid + ")");

    } catch(e) {
      replier.reply("ğŸš« êµí™˜ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + e);
    } finally {
      delete TRANSACTION_LOCK[sender]; // ğŸ”“ ë½ í•´ì œ
    }
    return;
  }

  // 2. ê³¨ë“œ ì†¡ê¸ˆ (ì•ˆì „ì¥ì¹˜ ì¶”ê°€)
  if (msg.indexOf("/ì†¡ê¸ˆ") === 0 || msg.indexOf("/ê³¨ë“œë³´ë‚´ê¸°") === 0) {
    if (TRANSACTION_LOCK[sender]) { return; } // ì¡°ìš©íˆ ë¬´ì‹œ (ë”°ë‹¤ë‹¥ ë°©ì§€)
    TRANSACTION_LOCK[sender] = true;

    try {
      var parts = msg.split(" ").filter(Boolean);
      if (parts.length < 3) {
        replier.reply("ğŸ’¸ ì‚¬ìš©ë²•: /ì†¡ê¸ˆ [ë°›ì„ì‚¬ëŒ] [ê¸ˆì•¡]\nì˜ˆ: /ì†¡ê¸ˆ ì†ì‚¬ì¥ 10000");
        delete TRANSACTION_LOCK[sender]; return;
      }

      var targetName = parts[1].replace("@", "").trim();
      var amount = parseInt(parts[2], 10);

      if (targetName === sender) { replier.reply("ğŸš« ìê¸° ìì‹ ì—ê²ŒëŠ” ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); delete TRANSACTION_LOCK[sender]; return; }
      if (isNaN(amount) || amount <= 0) { replier.reply("ğŸš« 1ì› ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”."); delete TRANSACTION_LOCK[sender]; return; }

      var targetU = d.users[targetName];
      if (!targetU) { replier.reply("ğŸš« '" + targetName + "'ë‹˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); delete TRANSACTION_LOCK[sender]; return; }
      
      normalizeUserData(targetU);

      if (u.gold < amount) {
        replier.reply("ğŸš« ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.\në³´ìœ : " + fmtNum(u.gold) + "ğŸ’°");
        delete TRANSACTION_LOCK[sender]; return;
      }

      // [í•µì‹¬] ì„  ì°¨ê° í›„ ì§€ê¸‰ (ìˆœì„œ ì¤‘ìš”)
      u.gold -= amount;
      targetU.gold += amount;

      commitSave(true);
      checkAndNotifyTitles(u, replier);

      replier.reply("ğŸ’¸ ì†¡ê¸ˆ ì„±ê³µ!\n" + sender + " â¡ï¸ " + targetName + "\nê¸ˆì•¡: " + fmtNum(amount) + "ğŸ’°\në‚¨ì€ ëˆ: " + fmtNum(u.gold) + "ğŸ’°");

    } catch(e) {
      replier.reply("ğŸš« ì†¡ê¸ˆ ì˜¤ë¥˜: " + e);
    } finally {
      delete TRANSACTION_LOCK[sender];
    }
    return;
  }

  // 3. ì•„ì´í…œ ì„ ë¬¼ (ì¥ë¹„ í¬í•¨ í†µí•© ë²„ì „)
  if (msg.indexOf("/ì„ ë¬¼") === 0) {
    if (TRANSACTION_LOCK[sender]) { return; }
    TRANSACTION_LOCK[sender] = true;

    try {
      var parts = msg.split(" ").filter(Boolean);
      if (parts.length < 4) {
        replier.reply("ğŸ ì‚¬ìš©ë²•: /ì„ ë¬¼ [ë°›ì„ì‚¬ëŒ] [ì•„ì´í…œ] [ìˆ˜ëŸ‰]\nì˜ˆ: /ì„ ë¬¼ ì†ì‚¬ì¥ ë‘ì«€ì¿  1\nì˜ˆ: /ì„ ë¬¼ ì†ì‚¬ì¥ í˜ì˜ë¨¸ë¦¬ë  1");
        delete TRANSACTION_LOCK[sender]; return;
      }

      var targetName = parts[1].replace("@", "").trim();
      var itemName = parts[2];
      var qty = parseInt(parts[3], 10);

      if (targetName === sender) { replier.reply("ğŸš« ë³¸ì¸ì—ê²Œ ì„ ë¬¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); delete TRANSACTION_LOCK[sender]; return; }
      if (isNaN(qty) || qty <= 0) { replier.reply("ğŸš« 1ê°œ ì´ìƒ ë³´ë‚´ì„¸ìš”."); delete TRANSACTION_LOCK[sender]; return; }

      var targetU = d.users[targetName];
      if (!targetU) { replier.reply("ğŸš« ëŒ€ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); delete TRANSACTION_LOCK[sender]; return; }
      
      normalizeUserData(targetU); // ë°›ëŠ” ì‚¬ëŒ ê°€ë°© ì´ˆê¸°í™”

      // ë³€ìˆ˜ ì„¤ì •
      var isEquip = false; // ì¥ë¹„ ì•„ì´í…œì¸ê°€?
      var field = "";
      var label = "";

      // [1] ì†Œë¹„ ì•„ì´í…œ í™•ì¸
      if (itemName === "ë„íŒŒë¯¼" || itemName === "ë„íŒŒë¯¼ê°•í™”ê¶Œ") { field = "dopaTicket"; label = "ë„íŒŒë¯¼ê°•í™”ê¶Œ"; }
      else if (itemName === "ë‘ì«€ì¿ " || itemName === "ì¿ í‚¤") { field = "cookie"; label = "ë‘ì«€ì¿ "; }
      else if (itemName === "í‹°ì–´ë¦¬ì…‹" || itemName === "í‹°ì–´ë¦¬ì…‹ê¶Œ") { field = "reroll"; label = "í‹°ì–´ë¦¬ì…‹ê¶Œ"; }
      else if (itemName === "ì´ë™í‹°ì¼“" || itemName === "í‹°ì¼“") { field = "ticket"; label = "ì´ë™í‹°ì¼“"; }
      else if (itemName.indexOf("í‚¹ê°“ë³¼") !== -1) { field = "godBall"; label = "í‚¹ê°“ë³¼"; }
      
      // [2] ì¥ë¹„ ì•„ì´í…œ í™•ì¸ (EQUIP_DBì— ìˆëŠ”ì§€ ì²´í¬)
      else if (EQUIP_DB[itemName]) {
          isEquip = true;
          field = itemName; // ì¥ë¹„ëŠ” ì´ë¦„ ê·¸ëŒ€ë¡œê°€ í‚¤ê°’
          var icon = EQUIP_DB[itemName].icon || "ğŸ›¡ï¸";
          label = icon + " " + itemName;
      }
      else {
        replier.reply("ğŸš« ì„ ë¬¼í•  ìˆ˜ ì—†ëŠ” ì•„ì´í…œì…ë‹ˆë‹¤.\n(ì†Œë¹„í…œ ë˜ëŠ” ì •í™•í•œ ì¥ë¹„ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!)");
        delete TRANSACTION_LOCK[sender]; return;
      }

      // [3] ì•„ì´í…œ ì°¨ê° ë° ì „ì†¡ ë¡œì§
      if (isEquip) {
          // --- ì¥ë¹„ ì „ì†¡ ë¡œì§ ---
          if (!u.items) u.items = {};
          
          if (!u.items[field] || u.items[field] < qty) {
              replier.reply("ğŸš« ë³´ìœ í•˜ì‹  [" + field + "] ì¥ë¹„ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.\ní˜„ì¬ ë³´ìœ : " + (u.items[field]||0) + "ê°œ");
              delete TRANSACTION_LOCK[sender]; return;
          }

          // ì°¨ê°
          u.items[field] -= qty;
          if (u.items[field] <= 0) delete u.items[field]; // 0ê°œë©´ ì‚­ì œ

          // ì§€ê¸‰
          if (!targetU.items) targetU.items = {};
          targetU.items[field] = (targetU.items[field] || 0) + qty;

      } else {
          // --- ì†Œë¹„í…œ ì „ì†¡ ë¡œì§ ---
          var myQty = u[field] || 0;
          if (myQty < qty) {
            replier.reply("ğŸš« ìˆ˜ëŸ‰ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.\në³´ìœ : " + fmtNum(myQty) + "ê°œ");
            delete TRANSACTION_LOCK[sender]; return;
          }

          u[field] -= qty;
          if (typeof targetU[field] !== "number") targetU[field] = 0;
          targetU[field] += qty;
      }

      commitSave(true);
      checkAndNotifyTitles(u, replier);

      replier.reply("ğŸ ì„ ë¬¼ ë°°ì†¡ ì™„ë£Œ!\n" + sender + " â¡ï¸ " + targetName + "\në‚´ìš©ë¬¼: " + label + " " + qty + "ê°œ");

    } catch(e) {
      replier.reply("ğŸš« ì„ ë¬¼ ì˜¤ë¥˜: " + e);
    } finally {
      delete TRANSACTION_LOCK[sender];
    }
    return;
  }


// ==================== [ëª…ë ¹ì–´] ì„ ë°œëŒ€ ì„¤ì • ====================
if (msg.indexOf("/ì²´ìœ¡ê´€ ì„ ë°œ") === 0 || msg.indexOf("/ì²´ìœ¡ê´€ì„ ë°œ") === 0) {
    var parts = msg.split(" ").filter(Boolean); // ê³µë°± ì œê±°
    // parts[0]=cmd, parts[1]... UIDs
    
    // ëª…ë ¹ì–´ í•©ì³ì„œ ì²˜ë¦¬ (/ì²´ìœ¡ê´€ì„ ë°œ vs /ì²´ìœ¡ê´€ ì„ ë°œ)
    var uids = [];
    for(var i=1; i<parts.length; i++) {
        var num = parseInt(parts[i]);
        if(!isNaN(num)) uids.push(num);
    }

    if (uids.length !== 3) {
        replier.reply("ğŸš« 3ë§ˆë¦¬ì˜ í¬ì¼“ëª¬ UIDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.\nì‚¬ìš©ë²•: /ì²´ìœ¡ê´€ì„ ë°œ 10 25 33");
        return;
    }

    // ìœ íš¨ì„± ê²€ì‚¬
    var newTeam = [];
    for (var k=0; k<uids.length; k++) {
        var p = findUserPokemonByUid(u, uids[k]);
        if (!p) { replier.reply("ğŸš« ì¡´ì¬í•˜ì§€ ì•ŠëŠ” í¬ì¼“ëª¬ UIDì…ë‹ˆë‹¤: " + uids[k]); return; }
        if (isPokemonBusy(u, p.uid)) { replier.reply("ğŸš« íƒí—˜ ì¤‘ì¸ í¬ì¼“ëª¬ì€ ì„ ë°œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: " + uids[k]); return; }
        // ì¤‘ë³µ ì²´í¬
        if (newTeam.indexOf(p.uid) !== -1) { replier.reply("ğŸš« ì¤‘ë³µëœ í¬ì¼“ëª¬ì…ë‹ˆë‹¤."); return; }
        newTeam.push(p.uid);
    }

    u.gymTeam = newTeam;
    commitSave(true);
    replier.reply("âœ… ì²´ìœ¡ê´€ ë„ì „ ì—”íŠ¸ë¦¬(3ë§ˆë¦¬)ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
    return;
}

if (msg.indexOf("/ì±”í”¼ì–¸ ì„ ë°œ") === 0 || msg.indexOf("/ì±”í”¼ì–¸ì„ ë°œ") === 0) {
    var parts = msg.split(" ").filter(Boolean);
    var uids = [];
    for(var i=1; i<parts.length; i++) {
        var num = parseInt(parts[i]);
        if(!isNaN(num)) uids.push(num);
    }

    if (uids.length !== 6) {
        replier.reply("ğŸš« 6ë§ˆë¦¬ì˜ í¬ì¼“ëª¬ UIDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.\nì‚¬ìš©ë²•: /ì±”í”¼ì–¸ì„ ë°œ 1 2 3 4 5 6");
        return;
    }

    var newTeam = [];
    for (var k=0; k<uids.length; k++) {
        var p = findUserPokemonByUid(u, uids[k]);
        if (!p) { replier.reply("ğŸš« ì¡´ì¬í•˜ì§€ ì•ŠëŠ” í¬ì¼“ëª¬ UIDì…ë‹ˆë‹¤: " + uids[k]); return; }
        if (isPokemonBusy(u, p.uid)) { replier.reply("ğŸš« íƒí—˜ ì¤‘ì¸ í¬ì¼“ëª¬ì€ ì„ ë°œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
        if (newTeam.indexOf(p.uid) !== -1) { replier.reply("ğŸš« ì¤‘ë³µëœ í¬ì¼“ëª¬ì…ë‹ˆë‹¤."); return; }
        newTeam.push(p.uid);
    }

    u.champTeam = newTeam;
    commitSave(true);
    replier.reply("âœ… ì±”í”¼ì–¸ ë¦¬ê·¸ ì—”íŠ¸ë¦¬(6ë§ˆë¦¬)ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
    return;
}

// ==================== [ëª…ë ¹ì–´] ì²´ìœ¡ê´€ ë„ì „ ====================
if (msg === "/ì²´ìœ¡ê´€" || msg === "/ë°°ì§€") {
    ensureUserDex(u);
    if (!u.badges) u.badges = [];
    
    var out = blockTitle(sender + "ë‹˜ì˜ ë°°ì§€ í˜„í™©") + "\n";
    for(var i=0; i<GYM_LEADERS.length; i++) {
        var gym = GYM_LEADERS[i];
        var hasBadge = (u.badges.indexOf(gym.badge) !== -1);
        out += (i+1) + ". " + gym.name + " (" + gym.type + ") : " + (hasBadge ? "âœ… íšë“" : "ğŸ”’ ë¯¸íšë“") + "\n";
    }
    out += "\nâš”ï¸ ë„ì „í•˜ë ¤ë©´ '/ì²´ìœ¡ê´€ ë„ì „ [ë²ˆí˜¸]'ë¥¼ ì…ë ¥í•˜ì„¸ìš”.\n(ì…ì¥ë£Œê°€ í•„ìš”í•©ë‹ˆë‹¤)";
    replier.reply(out);
    return;
}

if (msg.indexOf("/ì²´ìœ¡ê´€ ë„ì „") === 0) {
    var parts = msg.split(" ");
    var num = parseInt(parts[2]);
    
    if (isNaN(num) || num < 1 || num > 8) {
        replier.reply("ğŸš« ì²´ìœ¡ê´€ ë²ˆí˜¸(1~8)ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
    }

    var gymIdx = num - 1;
    var gym = GYM_LEADERS[gymIdx];

    // 1. ì„ í–‰ ë°°ì§€ ì²´í¬ (ìˆœì„œëŒ€ë¡œ ê¹¨ì•¼ í•¨)
    if (gymIdx > 0) {
        var prevBadge = GYM_LEADERS[gymIdx-1].badge;
        if (!u.badges || u.badges.indexOf(prevBadge) === -1) {
            replier.reply("ğŸš« ì´ì „ ì²´ìœ¡ê´€(" + GYM_LEADERS[gymIdx-1].name + ")ì„ ë¨¼ì € í´ë¦¬ì–´í•´ì•¼ í•©ë‹ˆë‹¤.");
            return;
        }
    }
    
    // 2. ì´ë¯¸ ê¹¼ëŠ”ì§€ ì²´í¬ (ì¬ë„ì „ ë¶ˆê°€ or ê°€ëŠ¥? ë³´í†µì€ ì¬ë„ì „ ê°€ëŠ¥í•˜ì§€ë§Œ ë³´ìƒì€ X)
    // ì—¬ê¸°ì„  "ì´ë¯¸ ê¹¼ìœ¼ë©´ ë„ì „ ë¶ˆê°€"ë¡œ í•´ì„œ ì±”í”¼ì–¸ìœ¼ë¡œ ìœ ë„
    if (u.badges && u.badges.indexOf(gym.badge) !== -1) {
        replier.reply("âœ… ì´ë¯¸ " + gym.badge + "ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤.");
        return;
    }

    // 3. ì—”íŠ¸ë¦¬ ì²´í¬
    if (!u.gymTeam || u.gymTeam.length !== 3) {
        replier.reply("ğŸš« ë¨¼ì € '/ì²´ìœ¡ê´€ì„ ë°œ'ë¡œ 3ë§ˆë¦¬ë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”.");
        return;
    }
    
    // 4. ì…ì¥ë£Œ ì²´í¬
    if (u.gold < gym.entryFee) {
        replier.reply("ğŸš« ì…ì¥ë£Œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.\ní•„ìš”: " + fmtNum(gym.entryFee) + "ğŸ’°");
        return;
    }

    // --- ì „íˆ¬ ì‹œì‘ ---
    u.gold -= gym.entryFee; // ì„ ë¶ˆ

    // ë‚´ íŒ€ ë°ì´í„° êµ¬ì„±
    var myTeam = [];
    for(var k=0; k<u.gymTeam.length; k++) {
        var p = findUserPokemonByUid(u, u.gymTeam[k]);
        if (!p) { replier.reply("ğŸš« ì—”íŠ¸ë¦¬ì— ë“±ë¡ëœ í¬ì¼“ëª¬ì´ ì‚¬ë¼ì¡ŒìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë“±ë¡í•´ì£¼ì„¸ìš”."); return; }
        myTeam.push(p);
    }

    // ì „íˆ¬ ì‹œë®¬ë ˆì´ì…˜
var result = simulateRelayBattle(myTeam, gym.lineup, sender, "ê´€ì¥ " + gym.name, false);
    
    var out = blockTitle("ì²´ìœ¡ê´€ ë„ì „: " + gym.name) + "\n" + result.log + "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\n";

    if (result.winner === "A") {
        if (!u.badges) u.badges = [];
        u.badges.push(gym.badge);
        
        // [ë³´ìƒ ê°œí¸] 3ë°° ê³¨ë“œ + í‹°ì–´ë¦¬ì…‹ê¶Œ ì°¨ë“± ì§€ê¸‰
        var rewardGold = gym.entryFee * 3;
        u.gold += rewardGold;
        
        // â˜… 6ë²ˆì§¸(ì´ˆë ¨) ì²´ìœ¡ê´€ë¶€í„°ëŠ” í‹°ì–´ë¦¬ì…‹ê¶Œì„ 2ì¥ì”© ì¤ë‹ˆë‹¤!
        var ticketAmount = (gymIdx >= 5) ? 2 : 1;
        u.reroll = (u.reroll || 0) + ticketAmount;
        
        out += "ğŸ‰ ìŠ¹ë¦¬! " + gym.badge + "ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!\n";
        out += "ğŸ’° ìƒê¸ˆ: " + fmtNum(rewardGold) + "ğŸ’°\n";
        out += "ğŸ íŠ¹ë³„ ë³´ìƒ: í‹°ì–´ë¦¬ì…‹ê¶Œ +" + ticketAmount + "ì¥";
    } else {
        out += "ğŸ’€ íŒ¨ë°°... ëˆˆì•ì´ ìº„ìº„í•´ì¡ŒìŠµë‹ˆë‹¤.\n(ì…ì¥ë£ŒëŠ” í™˜ë¶ˆë˜ì§€ ì•ŠìŠµë‹ˆë‹¤)";
    }

    commitSave(true);
    checkAndNotifyTitles(u, replier);
    replyFold(replier, "âš”ï¸ " + sender + " vs " + gym.name + " ëŒ€ê²° ê²°ê³¼", out);
    return;
}

// ==================== [ëª…ë ¹ì–´] ì±”í”¼ì–¸ ë¦¬ê·¸ ====================
if (msg === "/ì±”í”¼ì–¸") {
    var champ = d.champion || NPC_CHAMPION;
    var owner = champ.name;
    var info = champ.isNpc ? "NPC (ì´ˆëŒ€ ì±”í”¼ì–¸)" : "ğŸ‘‘ í˜„ ì„œë²„ ìµœê°•ì";
    
    var line = "ğŸ† [í¬ì¼“ëª¬ ë¦¬ê·¸ ì±”í”¼ì–¸]\n\n" +
               "ğŸ‘¤ " + owner + "\n" +
               "ğŸ“ " + info + "\n\n" + 
               "ğŸ›¡ï¸ ë°©ì–´ ë¼ì¸ì—… (6ë§ˆë¦¬)\n";
               
    for(var i=0; i<champ.lineup.length; i++) {
        var p = champ.lineup[i];
        var icon = p.shiny ? "âœ¨" : "";
        var grade = p.grade ? (" [" + p.grade + "]") : "";
        line += (i+1) + ". " + icon + p.name + " (" + (p.enh||0) + "ê°•)" + grade + "\n";
    }
    
    line += "\nâš”ï¸ ë„ì „í•˜ë ¤ë©´ '/ì±”í”¼ì–¸ ë„ì „'ì„ ì…ë ¥í•˜ì„¸ìš”.\n(8ê°œ ë°°ì§€ ë³´ìœ  í•„ìˆ˜ / ì…ì¥ë£Œ 5,000ë§ŒğŸ’°)";
    replier.reply(line);
    return;
}

if (msg === "/ì±”í”¼ì–¸ ë„ì „") {
    // 1. ìê²© ì²´í¬ (ë°°ì§€ 8ê°œ)
    if (!u.badges || u.badges.length < 8) {
        replier.reply("ğŸš« ë„ì „ ìê²©ì´ ì—†ìŠµë‹ˆë‹¤.\n8ê°œì˜ ì²´ìœ¡ê´€ ë°°ì§€ë¥¼ ëª¨ë‘ ëª¨ì•„ì•¼ í•©ë‹ˆë‹¤.");
        return;
    }

    // 2. ì—”íŠ¸ë¦¬ ì²´í¬
    if (!u.champTeam || u.champTeam.length !== 6) {
        replier.reply("ğŸš« ë¨¼ì € '/ì±”í”¼ì–¸ì„ ë°œ'ë¡œ 6ë§ˆë¦¬ë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”.");
        return;
    }

    // 3. ì…ì¥ë£Œ ì²´í¬
    var champFee = 50000000;
    if (u.gold < champFee) {
        replier.reply("ğŸš« ì…ì¥ë£Œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.\ní•„ìš”: " + fmtNum(champFee) + "ğŸ’°");
        return;
    }

    u.gold -= champFee;

    // ë‚´ íŒ€ êµ¬ì„±
    var myTeam = [];
    for(var k=0; k<u.champTeam.length; k++) {
        var p = findUserPokemonByUid(u, u.champTeam[k]);
        if (!p) { replier.reply("ì—”íŠ¸ë¦¬ ì˜¤ë¥˜: í¬ì¼“ëª¬ ì¬ë“±ë¡ í•„ìš”"); return; }
        myTeam.push(p);
    }

    // ì±”í”¼ì–¸ íŒ€ êµ¬ì„± (ìŠ¤ëƒ…ìƒ· ë°ì´í„° ì‚¬ìš©)
    var currentChamp = d.champion || NPC_CHAMPION;
    var champTeamData = currentChamp.lineup;

    // ì „íˆ¬ ì‹¤í–‰ (ì±”í”¼ì–¸ ë²„í”„ ON)
    var result = simulateRelayBattle(myTeam, champTeamData, sender, "ğŸ‘‘ " + currentChamp.name, true);

    var out = blockTitle("ğŸ† ì±”í”¼ì–¸ íƒ€ì´í‹€ ë§¤ì¹˜ ğŸ†") + "\n" + result.log + "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\n";

    if (result.winner === "A") {
        // ìŠ¹ë¦¬! ìƒˆë¡œìš´ ì±”í”¼ì–¸ ë“±ê·¹
        out += "ğŸ‰ğŸ‰ğŸ‰ ê¸°ì ì´ ì¼ì–´ë‚¬ìŠµë‹ˆë‹¤! ğŸ‰ğŸ‰ğŸ‰\n\n";
        out += "ìƒˆë¡œìš´ ì±”í”¼ì–¸: " + sender + "ë‹˜!\n";
        out += "ê¸°ì¡´ ì±”í”¼ì–¸(" + currentChamp.name + ")ì„ êº¾ê³  ì™•ì¢Œì— ì˜¬ëìŠµë‹ˆë‹¤!\n\n";
        out += "ğŸ“¢ ì´ì œë¶€í„° ì ‘ì† ì‹œ ì±”í”¼ì–¸ ì•Œë¦¼ì´ ëœ¨ë©°,\në°©ì–´ì „ì—ì„œ [ì±”í”¼ì–¸ì˜ ìœ„ì—„] ë²„í”„ë¥¼ ë°›ìŠµë‹ˆë‹¤.";

        // ì±”í”¼ì–¸ ë°ì´í„° ê°±ì‹  (ë‚´ íŒ€ ìŠ¤ëƒ…ìƒ· ì €ì¥)
        // ì£¼ì˜: ë‚´ í¬ì¼“ëª¬ ê°ì²´ë¥¼ ê·¸ëŒ€ë¡œ ì €ì¥í•˜ë©´, ë‚´ê°€ íŒ”ì•˜ì„ ë•Œ ì˜¤ë¥˜ë‚¨ -> ê¹Šì€ ë³µì‚¬
        var newSnapshot = JSON.parse(JSON.stringify(myTeam));
        // ìŠ¤ëƒ…ìƒ·ì—ëŠ” db ì •ë³´ê°€ ì—†ìœ¼ë¯€ë¡œ name, pid ë“± í•„ìˆ˜ ì •ë³´ í™•ì¸
        for(var z=0; z<newSnapshot.length; z++) {
            var db = findPokemonDB(newSnapshot[z].pid);
            if(db) newSnapshot[z].name = db.name; // ì´ë¦„ ë°•ì œ
        }

        d.champion = {
            name: sender,
            isNpc: false,
            obtainedAt: nowMs(),
            lineup: newSnapshot
        };

        // ë³´ìƒ ìƒí–¥ (ì…ì¥ë£Œê°€ 5ì²œë§Œì´ë‹ˆ ë³´ìƒì€ 1ì–µ ì •ë„ëŠ” ì¤˜ì•¼ê² ì£ ?)
        u.gold += 100000000;
        out += "\nğŸ’° ìƒê¸ˆ: 100,000,000ğŸ’° íšë“!";

    } else {
        out += "ğŸ’€ ë„ì „ ì‹¤íŒ¨...\nì±”í”¼ì–¸ì˜ ë²½ì€ ë†’ì•˜ìŠµë‹ˆë‹¤.";
    }

    commitSave(true);
    replyFold(replier, "ğŸ† ì±”í”¼ì–¸ ë„ì „ ê²°ê³¼", out);
    return;
}
    // -------------------- [ì‹ ê·œ] ì„ ë°œëŒ€ í™•ì¸ (/ë‚´íŒ€) --------------------
    if (msg === "/ì„ ë°œëŒ€" || msg === "/ë‚´íŒ€" || msg === "/íŒ€") {
      
      // ë¦¬ìŠ¤íŠ¸ ì˜ˆì˜ê²Œ ë½‘ì•„ì£¼ëŠ” ë‚´ë¶€ í•¨ìˆ˜
      function buildTeamList(uids) {
        if (!uids || uids.length === 0) return "   (ë“±ë¡ëœ í¬ì¼“ëª¬ì´ ì—†ìŠµë‹ˆë‹¤)";
        
        var lines = [];
        for (var i = 0; i < uids.length; i++) {
          var p = findUserPokemonByUid(u, uids[i]);
          if (!p) { 
              lines.push("   " + (i+1) + ". ğŸš« (íŒë§¤ë¨/ì‚¬ë¼ì§)"); 
              continue; 
          }
          
          var name = getDisplayName(p);
          var grade = p.grade ? "[" + p.grade + "]" : "[D]";
          if(p.grade === "S") grade += "ğŸ‘‘";
          
          lines.push("   " + (i+1) + ". #" + p.uid + " " + name + " (" + (p.enh||0) + "ê°•) " + grade);
        }
        return lines.join("\n");
      }

      var gymStr = buildTeamList(u.gymTeam);
      var champStr = buildTeamList(u.champTeam);

      replier.reply(
        "ğŸ“‹ " + sender + "ë‹˜ì˜ ì„ ë°œëŒ€ ë°°ì¹˜ í˜„í™©\n" +
        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
        "ğŸ›¡ï¸ [ì²´ìœ¡ê´€ ë„ì „íŒ€] (3ë§ˆë¦¬)\n" + 
        gymStr + "\n\n" +
        "ğŸ‘‘ [ì±”í”¼ì–¸ ë„ì „/ë°©ì–´íŒ€] (6ë§ˆë¦¬)\n" + 
        champStr + "\n" +
        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
        "ğŸ’¡ ë©¤ë²„ë¥¼ ë°”ê¾¸ë ¤ë©´ ì„ ë°œ ëª…ë ¹ì–´ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”.\n" +
        "ì˜ˆ: /ì²´ìœ¡ê´€ì„ ë°œ 10 20 30"
      );
      return;
    }

  // ==================================================================
  // ğŸ¦– [ë ˆì´ë“œ] ìœ ì € ëª…ë ¹ì–´ (/ë ˆì´ë“œ, /ë ˆì´ë“œ ì •ë³´)
  // ==================================================================
  
  // 1. ë ˆì´ë“œ ì •ë³´ í™•ì¸
  if (msg === "/ë ˆì´ë“œ ì •ë³´" || msg === "/ë³´ìŠ¤") {
      if (!d.worldBoss || !d.worldBoss.active) {
          replier.reply("ğŸ’¤ í˜„ì¬ ì¶œí˜„í•œ ì›”ë“œ ë³´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.");
          return;
      }
      
      var b = d.worldBoss;
      var now = nowMs();
      var remain = b.endTime - now;
      
      if (remain <= 0) { // ì‹œê°„ ì´ˆê³¼ ì²˜ë¦¬
          var endMsg = endRaidBoss(d, false); // ì‹¤íŒ¨ ì²˜ë¦¬
          commitSave(true);
          replier.reply(endMsg);
          return;
      }
      
      var min = Math.floor(remain / 60000);
      var hpPct = Math.floor((b.curHp / b.maxHp) * 1000) / 10; // ì†Œìˆ˜ì  1ìë¦¬
      
      // HP ë°” ê·¸ë¦¬ê¸°
      var barLen = 15;
      var filled = Math.floor((b.curHp / b.maxHp) * barLen);
      var bar = "";
      for(var i=0; i<barLen; i++) bar += (i < filled ? "ğŸŸ¥" : "â¬œ");
      
      // ë”œë¯¸í„°ê¸° (TOP 3)
      var rankTxt = "";
      var list = [];
      for (var name in b.logs) list.push({n:name, d:b.logs[name]});
      list.sort(function(a, b) { return b.d - a.d; }); // ë‚´ë¦¼ì°¨ìˆœ
      
      for(var k=0; k<Math.min(3, list.length); k++) {
          rankTxt += (k+1) + ". " + list[k].n + " (" + fmtNum(list[k].d) + ")\n";
      }
      if(!rankTxt) rankTxt = "(ì•„ì§ ì°¸ì—¬ìê°€ ì—†ìŠµë‹ˆë‹¤)";

      replier.reply(
          "ğŸ¦– [ì›”ë“œ ë³´ìŠ¤] " + b.name + "\n" +
          "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
          "â¤ï¸ ì²´ë ¥: " + fmtNum(b.curHp) + " / " + fmtNum(b.maxHp) + " (" + hpPct + "%)\n" +
          "[" + bar + "]\n\n" +
          "â³ ë‚¨ì€ ì‹œê°„: " + min + "ë¶„\n\n" +
          "ğŸ† [ë”œ ë¯¸í„°ê¸° TOP 3]\n" + rankTxt + "\n" +
          "ğŸ‘‰ ì°¸ì—¬: '/ë ˆì´ë“œ' ì…ë ¥ (ì±”í”¼ì–¸ ì„ ë°œëŒ€ ì¶œê²©!)"
      );
      return;
  }

  // 2. ë ˆì´ë“œ ê³µê²© (ì‹œê°„ ì²´í¬ + 3ë°° í¬ë¦¬ + 2ë¶„ ì¹˜ë£Œ + ê¸ˆê³ )
  if (msg === "/ë ˆì´ë“œ") {
      // (1) ë³´ìŠ¤ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
      if (!d.worldBoss || !d.worldBoss.active) {
          replier.reply("ğŸ’¤ í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ë ˆì´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.");
          return;
      }
      var b = d.worldBoss;
      var now = nowMs();

      // â˜… [ì‹œê°„ ì²´í¬] ì‹œê°„ì´ ë‹¤ ëìœ¼ë©´ ì¦‰ì‹œ ì¢…ë£Œ ì²˜ë¦¬
      if (b.endTime <= now) {
          var failMsg = endRaidBoss(d, false); // ì‹¤íŒ¨(false) ì²˜ë¦¬ë¡œ ì •ì‚° í˜¸ì¶œ
          commitSave(true);
          replier.reply("â° ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤!\n\n" + failMsg);
          return;
      }
      
      // (2) ì±”í”¼ì–¸ ì„ ë°œëŒ€ ì²´í¬
      if (!u.champTeam || u.champTeam.length === 0) {
          replier.reply("ğŸš« ì±”í”¼ì–¸ ì„ ë°œëŒ€ê°€ ì—†ìŠµë‹ˆë‹¤.\në¨¼ì € '/ì±”í”¼ì–¸ì„ ë°œ'ë¡œ 6ë§ˆë¦¬ë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”.");
          return;
      }
      
      // (3) ì¿¨íƒ€ì„ ì²´í¬ (ê°„í˜¸ìˆœ ì¹˜ë£Œ ì¤‘)
      if (now - u.lastRaidAt < RAID_COOLDOWN_MS) {
          var remainSec = Math.ceil((RAID_COOLDOWN_MS - (now - u.lastRaidAt)) / 1000);
          replier.reply("ğŸ¥ ê°„í˜¸ìˆœ: \"í™˜ìë¶„! ì•„ì§ ì•ˆ ë¼ìš”! 2ë¶„ì€ ì‰¬ì…”ì•¼ í•©ë‹ˆë‹¤!\"\n(ğŸ©¹ ì •ì„±ê» ì¹˜ë£Œ ì¤‘...)\nâ³ ë‚¨ì€ ì‹œê°„: " + remainSec + "ì´ˆ");
          return;
      }
      
      // (4) ë°ë¯¸ì§€ ê³„ì‚°
      var power = getRaidPower(u);
      var randomRate = 0.9 + (Math.random() * 0.2); 
      var dmg = Math.floor(power * randomRate); 
      
      // â˜… [ì¹˜ëª…íƒ€!] 15% í™•ë¥ ë¡œ 3ë°° ë°ë¯¸ì§€
      var isCrit = Math.random() < 0.15; 
      var hitIcon = "ğŸ’¥";
      var hitTag = "ê³µê²©";
      
      if (isCrit) {
          dmg = Math.floor(dmg * 3);   
          hitIcon = "â˜„ï¸";             
          hitTag = "ì¹˜ëª…íƒ€";           
      }
      
      // (5) ë³´ìŠ¤ í”¼ê²© ë° ë¡œê·¸ ê¸°ë¡
      b.curHp -= dmg;
      if (!b.logs[sender]) b.logs[sender] = 0;
      b.logs[sender] += dmg; 
      
      // â˜… [ê¸ˆê³  ì‹œìŠ¤í…œ] ë³´ìŠ¤ ê¸ˆê³ ì— ì ë¦½
      var dropCoin = Math.floor(Math.random() * (RAID_MAX_COIN - RAID_MIN_COIN + 1)) + RAID_MIN_COIN;
      b.rewardPool = (b.rewardPool || 0) + dropCoin;
      
      commitSave(false);
      
      // (6) ê²°ê³¼ ì¶œë ¥
      var out = "âš”ï¸ [ë ˆì´ë“œ] ì±”í”¼ì–¸ ì„ ë°œëŒ€ ì´ê³µê²©!\n" +
                "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + 
                hitIcon + " " + hitTag + ": " + b.name + "ì—ê²Œ -" + fmtNum(dmg) + " í”¼í•´!\n" +
                "ğŸ¦ ì ë¦½: ê¸ˆê³ ì— ì½”ì¸ " + dropCoin + "ê°œ ì¶”ê°€ (ì´ " + fmtNum(b.rewardPool) + "ê°œ)\n";
      
      // (7) ì²˜ì¹˜ ì—¬ë¶€ ì²´í¬
      if (b.curHp <= 0) {
          b.curHp = 0;
          b.lastHitter = sender; 
          var clearMsg = endRaidBoss(d, true); // ì„±ê³µ(true) ì²˜ë¦¬
          commitSave(true);
          checkAndNotifyTitles(u, replier);
          replier.reply(out + "\n" + clearMsg);
          return;
      } 
      
      // â˜… [ë¶€ìƒ ì‹œìŠ¤í…œ] 20% í™•ë¥ ë¡œ ë¶€ìƒ (2ë¶„ ì»·)
      var isInjured = Math.random() < 0.2; 
      
      if (isInjured) {
          u.lastRaidAt = now; 
          out += "\nğŸ¤• ìœ¼ì•…! ê°•ë ¥í•œ ë°˜ê²©ì— ë‹¹í–ˆìŠµë‹ˆë‹¤!\n" +
                 "(ğŸš‘ ê°„í˜¸ìˆœì—ê²Œ ì‹¤ë ¤ê°‘ë‹ˆë‹¤... 2ë¶„ê°„ ì¹˜ë£Œ!)";
      } else {
          out += "\nğŸ’¨ ê°€ë³ê²Œ ë°˜ê²©ì„ í”¼í–ˆìŠµë‹ˆë‹¤!\n" +
                 "(ì¦‰ì‹œ ë‹¤ì‹œ ê³µê²© ê°€ëŠ¥!)";
      }
      
      replier.reply(out);
      return;
  }





} // â˜… ì—¬ê¸°ê°€ response í•¨ìˆ˜ ë (ë¦¬ìŠ¤í° ë‹«ê¸°)


// ==================================================================
// ğŸ”§ [ìœ í‹¸] ë°ì´í„° ê´€ë¦¬ ë° íƒ€ì´í‹€ ì•Œë¦¼ í•¨ìˆ˜
// ==================================================================

// [ìˆ˜ì •ë¨] ë¯¸ì ‘ì†ì ì •ë¦¬ í•¨ìˆ˜ (ëˆ„ë½ëœ ë¶€ë¶„ ë³µêµ¬ ì™„ë£Œ)
function manageInactiveUsers(d) {
  var now = new Date().getTime();
  var archivePath = "/sdcard/mbot_pokemon_archive.json"; 
  
  // íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
  var file = new java.io.File(archivePath);
  var archive = {}; 

  if (file.exists()) {
    var archiveStr = readFile(archivePath); // File.read ëŒ€ì‹  readFile ì‚¬ìš© ê¶Œì¥
    if (!archiveStr) {
        // readFileì´ ì‹¤íŒ¨í–ˆì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ê¸°ì¡´ File.read ì‹œë„ (í™˜ê²½ í˜¸í™˜ì„±)
        try { archiveStr = File.read(archivePath); } catch(e) {}
    }
    
    if (archiveStr) {
      try {
        archive = JSON.parse(archiveStr);
      } catch (e) {
        archive = {}; 
      }
    }
  }
  
  var deletedCount = 0;
  var archivedCount = 0;
  var users = d.users;
  var keys = Object.keys(users);
  
  var day = 24 * 60 * 60 * 1000;
  var limitDelete = 30 * day; 
  var limitArchive = 2 * day; 

  for (var i = 0; i < keys.length; i++) {
    var key = keys[i];
    var u = users[key];
    
    if (!u.lastDate) continue; 
    var diff = now - u.lastDate;

    if (diff > limitDelete) {
      delete users[key];
      deletedCount++;
    } else if (diff > limitArchive) {
      archive[key] = u; 
      delete users[key]; 
      archivedCount++;
    }
  }

  // ì •ë¦¬ ê²°ê³¼ ì €ì¥ ë° ë°˜í™˜
  if (deletedCount > 0 || archivedCount > 0) {
    saveData(d); 
    // ì•„ì¹´ì´ë¸Œ íŒŒì¼ ì €ì¥
    var fos = new java.io.FileOutputStream(file);
    var str = new java.lang.String(JSON.stringify(archive));
    fos.write(str.getBytes());
    fos.close();
    
    return "âœ… ë°ì´í„° ì •ë¦¬ ì™„ë£Œ!\nğŸ—‘ï¸ ì˜êµ¬ ì‚­ì œ: " + deletedCount + "ëª…\nğŸ“¦ ì•„ì¹´ì´ë¹™: " + archivedCount + "ëª…";
  } else {
    return "âœ¨ ì •ë¦¬í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
  }
}

// ì¹­í˜¸ íšë“ ì•Œë¦¼ í•¨ìˆ˜
function checkAndNotifyTitles(u, replier) {
  var gained = updateTitles(u);
  if (gained && gained.length > 0) {
    replier.reply("ğŸŠ [ì¹­í˜¸ íšë“!] ğŸŠ\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + gained.map(n => "['" + n + "']").join(", ") + " ì„(ë¥¼) ì–»ì—ˆìŠµë‹ˆë‹¤!");
  }
}
