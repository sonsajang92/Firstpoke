var scriptName = "ì£ ë´‡ í¬ì¼“ëª¬";
// -------------------- ì „ì²´ë³´ê¸°(ì ‘ê¸°) SAFE --------------------
// ì¹´í†¡/ë©”ì‹ ì €ë´‡Rì—ì„œ ë„ˆë¬´ ê¸´ ë©”ì‹œì§€ëŠ” ì „ì†¡ ì‹¤íŒ¨/í¬ë˜ì‹œ ìœ ë°œ ê°€ëŠ¥
function replyFold(replier, summary, full) {
  summary = String(summary || "");
  full = String(full || "");

  // âœ… ìš”ì•½ì´ ê¸¸ì–´ì§€ë©´, ë’¤ìª½ì„ ì˜ë¼ì„œ ì „ì²´ë³´ê¸°ë¡œ ë³´ë‚´ë²„ë¦¼
  var SUMMARY_LIMIT = 220; // 180~260 ì‚¬ì´ë¡œ ì·¨í–¥ ì¡°ì ˆ

  if (summary.length > SUMMARY_LIMIT) {
    var overflow = summary.substring(SUMMARY_LIMIT);
    summary = summary.substring(0, SUMMARY_LIMIT) + "\n... (ì „ì²´ë³´ê¸°)";
    // overflowë¥¼ full ì•ì— ë¶™ì—¬ì„œ "ëª©ë¡"ì´ ì „ì²´ë³´ê¸°ì— ë“¤ì–´ê°€ê²Œ í•¨
    full = overflow + "\n\n" + full;
  }

  replier.reply(summary + "\u200b".repeat(500) + (full ? ("\n" + full) : " "));
}
//ê³¨ë“œì½¤ë§ˆ
function fmtNum(n) {
  n = parseInt(n, 10);
  if (isNaN(n)) n = 0;
  return String(n).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

// null/undefined ëŒ€ë¹„ìš© (ìˆ«ì ì•„ë‹Œ ê°’ë„ ê·¸ëƒ¥ ë¬¸ìì—´ë¡œ)
function fmtAny(v) {
  if (v === null || v === undefined) return "";
  if (typeof v === "number") return fmtNum(v);
  // "12345" ê°™ì€ ìˆ«ì ë¬¸ìì—´ì´ë©´ ì½¤ë§ˆ
  if (typeof v === "string" && /^-?\d+$/.test(v)) return fmtNum(v);
  return String(v);
}

// -------------------- ì €ì¥ íŒŒì¼ ê²½ë¡œ --------------------
var DATA_PATH = "/sdcard/mbot_pokemon_db.json";
// -------------------- ë°¸ëŸ°ìŠ¤(í‘œì¤€) --------------------
var MAX_LV = 150;
var ENHANCE_MAX = 30;
var FIELD_COOLDOWN_MS = 10 * 1000;// /í•„ë“œ 10ì´ˆ
var EXPLORE_COOLDOWN_MS = 1 * 1000;// /íƒí—˜ 55ì´ˆ
var ENHANCE_COOLDOWN_MS = 4 * 1000;// /ê°•í™” 4ì´ˆ
var BATTLE_COOLDOWN_MS = 15 * 1000;// /ë°°í‹€ 15ì´ˆ
var ACTIVE_TTL_MS = 6 * 60 * 60 * 1000;// 6ì‹œê°„ ì´ë‚´ ì±„íŒ…í•œ ìœ ì €ë§Œ ë°°í‹€ ë§¤ì¹­

// í¬íš ë³´ìƒ (ë‚œìˆ˜)
var CATCH_GOLD_MIN = 35;
var CATCH_GOLD_MAX = 85;
var CATCH_EXP_MIN = 12;
var CATCH_EXP_MAX = 26;
// í¬íš ë³´ìƒ ì•ˆì „ ìº¡(ê²½ì œ í­ì£¼ ë°©ì§€)
var CATCH_GOLD_CAP = 220;
var CATCH_EXP_CAP = 80;
// -------------------- íƒí—˜ ë³´ìƒ ë°¸ëŸ°ìŠ¤ --------------------
var EXPLORE_GOLD_MIN = 12;
var EXPLORE_GOLD_MAX = 32;
var EXPLORE_EXP_MIN = 6;
var EXPLORE_EXP_MAX = 14;
// ë ˆë²¨ ê³„ìˆ˜ (ì¶”ì²œê°’)
var EXPLORE_LV_RATE = 0.08;
// ì•ˆì „ ìº¡ (ê²½ì œ í­ì£¼ ë°©ì§€)
var EXPLORE_GOLD_CAP = 180;
// ë°°í‹€ ë³´ìƒ
var BATTLE_GOLD_WIN = 140;
var BATTLE_GOLD_LOSE = 40;
var BATTLE_EXP_WIN = 65;
var BATTLE_EXP_LOSE = 30;

// ìŠ¹ë¦¬ ë³´ë„ˆìŠ¤(ê°•í™” +1)
var BATTLE_BONUS_ENH_CHANCE = 0.07;

// ë³¼ ê°€ê²©(ìƒì )
var SHOP_PRICE_BALL = 100;
var SHOP_PRICE_SUPER = 500;
var SHOP_PRICE_ULTRA = 1000;
var SHOP_PRICE_DOPA = 20000;// ë„íŒŒë¯¼ê°•í™”ê¶Œ
var SHOP_PRICE_COOKIE = 50000; // ë‘ì«€ì¿  (100% +1ê°•)
var SHOP_PRICE_TICKET = 5000;  // ì´ë™ í‹°ì¼“ (ì›í•˜ëŠ” ì§€ì—­ ì´ë™)
var SHOP_PRICE_REROLL = 30000; // ë“±ê¸‰ ì¬ì„¤ì •ê¶Œ (S~D ëœë¤)

// íƒ€ì… ìƒì„± ì¬ë§¤í•‘ ê°’(0->1, 0.5->1.5, 1->2, 2->3.5)
var TYPE_STRONG = 4.4;
// ë°ë¯¸ì§€ ê°•í™” í¼ì„¼íŠ¸ ê¸°ì—¬
var ATK_ENH_RATE = 0.085;
var DEF_ENH_RATE = 0.050;
// ë°°í‹€ ê´€ë ¨ 
var MAX_BATTLE_CHAIN = 5;
var STREAK_GOLD_BONUS_EVERY = 3;
var STREAK_GOLD_BONUS = 60;
var STREAK_EXP_BONUS_EVERY = 5;
var STREAK_EXP_BONUS = 25;
var STREAK_ENH_BONUS_EVERY = 10;
var STREAK_ENH_BONUS_CHANCE = 0.12;// 10ì—°ìŠ¹ ë„ë‹¬ ì‹œ ì¶”ê°€ í™•ë¥ 
var MIN_BATTLE_ENH = 5;
var BALL_CATCH_MULT = [1.00, 1.25, 1.55];
var ACTIVE_SAVE_INTERVAL_MS = 20 * 1000;// 20ì´ˆì— 1ë²ˆë§Œ ì €ì¥
var MATCH_POOL_KEY = "__GLOBAL_MATCH__";
// ==================== ë°°í‹€ ì°¸ê°€ ìµœì†Œ ê°•í™” ====================
var BATTLE_MIN_ENH = 20; // 5 -> 20

// -------------------- 1ì„¸ëŒ€ 151 DB --------------------
var POKEMON_DB = [
  { id: 1, name: "ì´ìƒí•´ì”¨", type1: "í’€", type2: "ë…", basePower: 50, rarity: 2 },
  { id: 2, name: "ì´ìƒí•´í’€", type1: "í’€", type2: "ë…", basePower: 70, rarity: 3 },
  { id: 3, name: "ì´ìƒí•´ê½ƒ", type1: "í’€", type2: "ë…", basePower: 90, rarity: 4 },

  { id: 4, name: "íŒŒì´ë¦¬", type1: "ë¶ˆ", type2: null, basePower: 50, rarity: 2 },
  { id: 5, name: "ë¦¬ìë“œ", type1: "ë¶ˆ", type2: null, basePower: 70, rarity: 3 },
  { id: 6, name: "ë¦¬ìëª½", type1: "ë¶ˆ", type2: "ë¹„í–‰", basePower: 92, rarity: 4 },

  { id: 7, name: "ê¼¬ë¶€ê¸°", type1: "ë¬¼", type2: null, basePower: 48, rarity: 2 },
  { id: 8, name: "ì–´ë‹ˆë¶€ê¸°", type1: "ë¬¼", type2: null, basePower: 68, rarity: 3 },
  { id: 9, name: "ê±°ë¶ì™•", type1: "ë¬¼", type2: null, basePower: 90, rarity: 4 },

  { id: 10, name: "ìºí„°í”¼", type1: "ë²Œë ˆ", type2: null, basePower: 30, rarity: 1 },
  { id: 11, name: "ë‹¨ë°ê¸°", type1: "ë²Œë ˆ", type2: null, basePower: 35, rarity: 1 },
  { id: 12, name: "ë²„í„°í”Œ", type1: "ë²Œë ˆ", type2: "ë¹„í–‰", basePower: 65, rarity: 2 },

  { id: 13, name: "ë¿”ì¶©ì´", type1: "ë²Œë ˆ", type2: "ë…", basePower: 30, rarity: 1 },
  { id: 14, name: "ë”±ì¶©ì´", type1: "ë²Œë ˆ", type2: "ë…", basePower: 35, rarity: 1 },
  { id: 15, name: "ë…ì¹¨ë¶•", type1: "ë²Œë ˆ", type2: "ë…", basePower: 70, rarity: 2 },

  { id: 16, name: "êµ¬êµ¬", type1: "ë…¸ë§", type2: "ë¹„í–‰", basePower: 40, rarity: 1 },
  { id: 17, name: "í”¼ì£¤", type1: "ë…¸ë§", type2: "ë¹„í–‰", basePower: 60, rarity: 2 },
  { id: 18, name: "í”¼ì£¤íˆ¬", type1: "ë…¸ë§", type2: "ë¹„í–‰", basePower: 82, rarity: 3 },

  { id: 19, name: "ê¼¬ë ›", type1: "ë…¸ë§", type2: null, basePower: 42, rarity: 1 },
  { id: 20, name: "ë ˆíŠ¸ë¼", type1: "ë…¸ë§", type2: null, basePower: 68, rarity: 2 },

  { id: 21, name: "ê¹¨ë¹„ì°¸", type1: "ë…¸ë§", type2: "ë¹„í–‰", basePower: 45, rarity: 1 },
  { id: 22, name: "ê¹¨ë¹„ë“œë¦´ì¡°", type1: "ë…¸ë§", type2: "ë¹„í–‰", basePower: 78, rarity: 2 },

  { id: 23, name: "ì•„ë³´", type1: "ë…", type2: null, basePower: 45, rarity: 1 },
  { id: 24, name: "ì•„ë³´í¬", type1: "ë…", type2: null, basePower: 75, rarity: 2 },

  { id: 25, name: "í”¼ì¹´ì¸„", type1: "ì „ê¸°", type2: null, basePower: 55, rarity: 3 },
  { id: 26, name: "ë¼ì´ì¸„", type1: "ì „ê¸°", type2: null, basePower: 78, rarity: 3 },

  { id: 27, name: "ëª¨ë˜ë‘ì§€", type1: "ë•…", type2: null, basePower: 50, rarity: 2 },
  { id: 28, name: "ê³ ì§€", type1: "ë•…", type2: null, basePower: 78, rarity: 3 },

  { id: 29, name: "ë‹ˆë“œëŸ°â™€", type1: "ë…", type2: null, basePower: 46, rarity: 2 },
  { id: 30, name: "ë‹ˆë“œë¦¬ë‚˜", type1: "ë…", type2: null, basePower: 64, rarity: 2 },
  { id: 31, name: "ë‹ˆë“œí€¸", type1: "ë…", type2: "ë•…", basePower: 88, rarity: 4 },

  { id: 32, name: "ë‹ˆë“œëŸ°â™‚", type1: "ë…", type2: null, basePower: 46, rarity: 2 },
  { id: 33, name: "ë‹ˆë“œë¦¬ë…¸", type1: "ë…", type2: null, basePower: 64, rarity: 2 },
  { id: 34, name: "ë‹ˆë“œí‚¹", type1: "ë…", type2: "ë•…", basePower: 88, rarity: 4 },

  { id: 35, name: "ì‚ì‚", type1: "í˜ì–´ë¦¬", type2: null, basePower: 48, rarity: 3 },
  { id: 36, name: "í”½ì‹œ", type1: "í˜ì–´ë¦¬", type2: null, basePower: 78, rarity: 3 },

  { id: 37, name: "ì‹ìŠ¤í…Œì¼", type1: "ë¶ˆ", type2: null, basePower: 45, rarity: 3 },
  { id: 38, name: "ë‚˜ì¸í…Œì¼", type1: "ë¶ˆ", type2: null, basePower: 80, rarity: 4 },

  { id: 39, name: "í‘¸ë¦°", type1: "ë…¸ë§", type2: "í˜ì–´ë¦¬", basePower: 45, rarity: 2 },
  { id: 40, name: "í‘¸í¬ë¦°", type1: "ë…¸ë§", type2: "í˜ì–´ë¦¬", basePower: 75, rarity: 3 },

  { id: 41, name: "ì£¼ë±ƒ", type1: "ë…", type2: "ë¹„í–‰", basePower: 40, rarity: 2 },
  { id: 42, name: "ê³¨ë±ƒ", type1: "ë…", type2: "ë¹„í–‰", basePower: 75, rarity: 3 },

  { id: 43, name: "ëšœë²…ìµ¸", type1: "í’€", type2: "ë…", basePower: 45, rarity: 2 },
  { id: 44, name: "ëƒ„ìƒˆê¼¬", type1: "í’€", type2: "ë…", basePower: 62, rarity: 2 },
  { id: 45, name: "ë¼í”Œë ˆì‹œì•„", type1: "í’€", type2: "ë…", basePower: 82, rarity: 3 },

  { id: 46, name: "íŒŒë¼ìŠ¤", type1: "ë²Œë ˆ", type2: "í’€", basePower: 42, rarity: 2 },
  { id: 47, name: "íŒŒë¼ì„¹íŠ¸", type1: "ë²Œë ˆ", type2: "í’€", basePower: 72, rarity: 3 },

  { id: 48, name: "ì½˜íŒ¡", type1: "ë²Œë ˆ", type2: "ë…", basePower: 40, rarity: 2 },
  { id: 49, name: "ë„ë‚˜ë¦¬", type1: "ë²Œë ˆ", type2: "ë…", basePower: 70, rarity: 3 },

  { id: 50, name: "ë””ê·¸ë‹¤", type1: "ë•…", type2: null, basePower: 45, rarity: 2 },
  { id: 51, name: "ë‹¥íŠ¸ë¦¬ì˜¤", type1: "ë•…", type2: null, basePower: 75, rarity: 3 },

  { id: 52, name: "ë‚˜ì˜¹", type1: "ë…¸ë§", type2: null, basePower: 48, rarity: 2 },
  { id: 53, name: "í˜ë¥´ì‹œì˜¨", type1: "ë…¸ë§", type2: null, basePower: 78, rarity: 3 },

  { id: 54, name: "ê³ ë¼íŒŒë•", type1: "ë¬¼", type2: null, basePower: 52, rarity: 2 },
  { id: 55, name: "ê³¨ë•", type1: "ë¬¼", type2: null, basePower: 80, rarity: 3 },

  { id: 56, name: "ë§í‚¤", type1: "ê²©íˆ¬", type2: null, basePower: 50, rarity: 2 },
  { id: 57, name: "ì„±ì›ìˆ­", type1: "ê²©íˆ¬", type2: null, basePower: 80, rarity: 3 },

  { id: 58, name: "ê°€ë””", type1: "ë¶ˆ", type2: null, basePower: 55, rarity: 3 },
  { id: 59, name: "ìœˆë””", type1: "ë¶ˆ", type2: null, basePower: 92, rarity: 4 },

  { id: 60, name: "ë°œì±™ì´", type1: "ë¬¼", type2: null, basePower: 48, rarity: 2 },
  { id: 61, name: "ìŠˆë¥™ì±™ì´", type1: "ë¬¼", type2: null, basePower: 65, rarity: 2 },
  { id: 62, name: "ê°•ì±™ì´", type1: "ë¬¼", type2: "ê²©íˆ¬", basePower: 88, rarity: 4 },

  { id: 63, name: "ìºì´ì‹œ", type1: "ì—ìŠ¤í¼", type2: null, basePower: 45, rarity: 3 },
  { id: 64, name: "ìœ¤ê²”ë¼", type1: "ì—ìŠ¤í¼", type2: null, basePower: 72, rarity: 3 },
  { id: 65, name: "í›„ë”˜", type1: "ì—ìŠ¤í¼", type2: null, basePower: 92, rarity: 4 },

  { id: 66, name: "ì•Œí†µëª¬", type1: "ê²©íˆ¬", type2: null, basePower: 55, rarity: 2 },
  { id: 67, name: "ê·¼ìœ¡ëª¬", type1: "ê²©íˆ¬", type2: null, basePower: 72, rarity: 3 },
  { id: 68, name: "ê´´ë ¥ëª¬", type1: "ê²©íˆ¬", type2: null, basePower: 90, rarity: 4 },

  { id: 69, name: "ëª¨ë‹¤í”¼", type1: "í’€", type2: "ë…", basePower: 45, rarity: 2 },
  { id: 70, name: "ìš°ì¸ ë™", type1: "í’€", type2: "ë…", basePower: 65, rarity: 2 },
  { id: 71, name: "ìš°ì¸ ë³´íŠ¸", type1: "í’€", type2: "ë…", basePower: 88, rarity: 4 },

  { id: 72, name: "ì™•ëˆˆí•´", type1: "ë¬¼", type2: "ë…", basePower: 40, rarity: 2 },
  { id: 73, name: "ë…íŒŒë¦¬", type1: "ë¬¼", type2: "ë…", basePower: 75, rarity: 3 },

  { id: 74, name: "ê¼¬ë§ˆëŒ", type1: "ë°”ìœ„", type2: "ë•…", basePower: 50, rarity: 2 },
  { id: 75, name: "ë°êµ¬ë¦¬", type1: "ë°”ìœ„", type2: "ë•…", basePower: 70, rarity: 3 },
  { id: 76, name: "ë”±êµ¬ë¦¬", type1: "ë°”ìœ„", type2: "ë•…", basePower: 90, rarity: 4 },

  { id: 77, name: "í¬ë‹ˆíƒ€", type1: "ë¶ˆ", type2: null, basePower: 55, rarity: 2 },
  { id: 78, name: "ë‚ ìŒ©ë§ˆ", type1: "ë¶ˆ", type2: null, basePower: 85, rarity: 3 },

  { id: 79, name: "ì•¼ëˆ", type1: "ë¬¼", type2: "ì—ìŠ¤í¼", basePower: 45, rarity: 2 },
  { id: 80, name: "ì•¼ë„ë€", type1: "ë¬¼", type2: "ì—ìŠ¤í¼", basePower: 80, rarity: 3 },

  { id: 81, name: "ì½”ì¼", type1: "ì „ê¸°", type2: "ê°•ì² ", basePower: 45, rarity: 2 },
  { id: 82, name: "ë ˆì–´ì½”ì¼", type1: "ì „ê¸°", type2: "ê°•ì² ", basePower: 78, rarity: 3 },

  { id: 83, name: "íŒŒì˜¤ë¦¬", type1: "ë…¸ë§", type2: "ë¹„í–‰", basePower: 65, rarity: 3 },

  { id: 84, name: "ë‘ë‘", type1: "ë…¸ë§", type2: "ë¹„í–‰", basePower: 45, rarity: 2 },
  { id: 85, name: "ë‘íŠ¸ë¦¬ì˜¤", type1: "ë…¸ë§", type2: "ë¹„í–‰", basePower: 78, rarity: 3 },

  { id: 86, name: "ì¥¬ì¥¬", type1: "ë¬¼", type2: null, basePower: 45, rarity: 2 },
  { id: 87, name: "ì¥¬ë ˆê³¤", type1: "ë¬¼", type2: "ì–¼ìŒ", basePower: 82, rarity: 4 },

  { id: 88, name: "ì§ˆí½ì´", type1: "ë…", type2: null, basePower: 45, rarity: 2 },
  { id: 89, name: "ì§ˆë»ê¸°", type1: "ë…", type2: null, basePower: 78, rarity: 3 },

  { id: 90, name: "ì…€ëŸ¬", type1: "ë¬¼", type2: null, basePower: 40, rarity: 2 },
  { id: 91, name: "íŒŒë¥´ì…€", type1: "ë¬¼", type2: "ì–¼ìŒ", basePower: 85, rarity: 4 },

  { id: 92, name: "ê³ ì˜¤ìŠ¤", type1: "ê³ ìŠ¤íŠ¸", type2: "ë…", basePower: 45, rarity: 3 },
  { id: 93, name: "ê³ ìš°ìŠ¤íŠ¸", type1: "ê³ ìŠ¤íŠ¸", type2: "ë…", basePower: 68, rarity: 3 },
  { id: 94, name: "íŒ¬í…€", type1: "ê³ ìŠ¤íŠ¸", type2: "ë…", basePower: 90, rarity: 4 },

  { id: 95, name: "ë¡±ìŠ¤í†¤", type1: "ë°”ìœ„", type2: "ë•…", basePower: 80, rarity: 4 },

  { id: 96, name: "ìŠ¬ë¦¬í”„", type1: "ì—ìŠ¤í¼", type2: null, basePower: 45, rarity: 2 },
  { id: 97, name: "ìŠ¬ë¦¬í¼", type1: "ì—ìŠ¤í¼", type2: null, basePower: 78, rarity: 3 },

  { id: 98, name: "í¬ë©", type1: "ë¬¼", type2: null, basePower: 50, rarity: 2 },
  { id: 99, name: "í‚¹í¬ë©", type1: "ë¬¼", type2: null, basePower: 85, rarity: 3 },

  { id: 100, name: "ì°Œë¦¬ë¦¬ê³µ", type1: "ì „ê¸°", type2: null, basePower: 45, rarity: 2 },
  { id: 101, name: "ë¶ë³¼", type1: "ì „ê¸°", type2: null, basePower: 80, rarity: 3 },

  { id: 102, name: "ì•„ë¼ë¦¬", type1: "í’€", type2: "ì—ìŠ¤í¼", basePower: 45, rarity: 2 },
  { id: 103, name: "ë‚˜ì‹œ", type1: "í’€", type2: "ì—ìŠ¤í¼", basePower: 85, rarity: 3 },

  { id: 104, name: "íƒ•êµ¬ë¦¬", type1: "ë•…", type2: null, basePower: 50, rarity: 2 },
  { id: 105, name: "í……êµ¬ë¦¬", type1: "ë•…", type2: null, basePower: 82, rarity: 3 },

  { id: 106, name: "ì‹œë¼ì†Œëª¬", type1: "ê²©íˆ¬", type2: null, basePower: 85, rarity: 4 },
  { id: 107, name: "í™ìˆ˜ëª¬", type1: "ê²©íˆ¬", type2: null, basePower: 85, rarity: 4 },

  { id: 108, name: "ë‚´ë£¨ë¯¸", type1: "ë…¸ë§", type2: null, basePower: 70, rarity: 3 },

  { id: 109, name: "ë˜ê°€ìŠ¤", type1: "ë…", type2: null, basePower: 45, rarity: 2 },
  { id: 110, name: "ë˜ë„ê°€ìŠ¤", type1: "ë…", type2: null, basePower: 80, rarity: 3 },

  { id: 111, name: "ë¿”ì¹´ë…¸", type1: "ë•…", type2: "ë°”ìœ„", basePower: 60, rarity: 3 },
  { id: 112, name: "ì½”ë¿Œë¦¬", type1: "ë•…", type2: "ë°”ìœ„", basePower: 88, rarity: 4 },

  { id: 113, name: "ëŸ­í‚¤", type1: "ë…¸ë§", type2: null, basePower: 70, rarity: 4 },

  { id: 114, name: "ë©ì¿ ë¦¬", type1: "í’€", type2: null, basePower: 70, rarity: 3 },

  { id: 115, name: "ìº¥ì¹´", type1: "ë…¸ë§", type2: null, basePower: 88, rarity: 4 },

  { id: 116, name: "ì˜ë“œë¼", type1: "ë¬¼", type2: null, basePower: 45, rarity: 2 },
  { id: 117, name: "ì‹œë“œë¼", type1: "ë¬¼", type2: null, basePower: 80, rarity: 3 },

  { id: 118, name: "ì½˜ì¹˜", type1: "ë¬¼", type2: null, basePower: 45, rarity: 2 },
  { id: 119, name: "ì™•ì½˜ì¹˜", type1: "ë¬¼", type2: null, basePower: 80, rarity: 3 },

  { id: 120, name: "ë³„ê°€ì‚¬ë¦¬", type1: "ë¬¼", type2: null, basePower: 45, rarity: 2 },
  { id: 121, name: "ì•„ì¿ ìŠ¤íƒ€", type1: "ë¬¼", type2: "ì—ìŠ¤í¼", basePower: 82, rarity: 4 },

  { id: 122, name: "ë§ˆì„ë§¨", type1: "ì—ìŠ¤í¼", type2: "í˜ì–´ë¦¬", basePower: 78, rarity: 4 },

  { id: 123, name: "ìŠ¤ë¼í¬", type1: "ë²Œë ˆ", type2: "ë¹„í–‰", basePower: 85, rarity: 4 },

  { id: 124, name: "ë£¨ì£¼ë¼", type1: "ì–¼ìŒ", type2: "ì—ìŠ¤í¼", basePower: 80, rarity: 4 },
  { id: 125, name: "ì—ë ˆë¸Œ", type1: "ì „ê¸°", type2: null, basePower: 82, rarity: 4 },
  { id: 126, name: "ë§ˆê·¸ë§ˆ", type1: "ë¶ˆ", type2: null, basePower: 82, rarity: 4 },

  { id: 127, name: "ì˜ì‚¬ì´ì €", type1: "ë²Œë ˆ", type2: null, basePower: 88, rarity: 4 },

  { id: 128, name: "ì¼„íƒ€ë¡œìŠ¤", type1: "ë…¸ë§", type2: null, basePower: 85, rarity: 4 },

  { id: 129, name: "ì‰ì–´í‚¹", type1: "ë¬¼", type2: null, basePower: 20, rarity: 2 },
  { id: 130, name: "ê°¸ë¼ë„ìŠ¤", type1: "ë¬¼", type2: "ë¹„í–‰", basePower: 95, rarity: 4 },

  { id: 131, name: "ë¼í”„ë¼ìŠ¤", type1: "ë¬¼", type2: "ì–¼ìŒ", basePower: 92, rarity: 5 },

  { id: 132, name: "ë©”íƒ€ëª½", type1: "ë…¸ë§", type2: null, basePower: 60, rarity: 4 },

  { id: 133, name: "ì´ë¸Œì´", type1: "ë…¸ë§", type2: null, basePower: 55, rarity: 4 },

  { id: 134, name: "ìƒ¤ë¯¸ë“œ", type1: "ë¬¼", type2: null, basePower: 88, rarity: 5 },
  { id: 135, name: "ì¥¬í”¼ì¬ë”", type1: "ì „ê¸°", type2: null, basePower: 88, rarity: 5 },
  { id: 136, name: "ë¶€ìŠ¤í„°", type1: "ë¶ˆ", type2: null, basePower: 88, rarity: 5 },

  { id: 137, name: "í´ë¦¬ê³¤", type1: "ë…¸ë§", type2: null, basePower: 70, rarity: 4 },

  { id: 138, name: "ì•”ë‚˜ì´íŠ¸", type1: "ë°”ìœ„", type2: "ë¬¼", basePower: 60, rarity: 4 },
  { id: 139, name: "ì•”ìŠ¤íƒ€", type1: "ë°”ìœ„", type2: "ë¬¼", basePower: 88, rarity: 5 },

  { id: 140, name: "íˆ¬êµ¬", type1: "ë°”ìœ„", type2: "ë¬¼", basePower: 60, rarity: 4 },
  { id: 141, name: "íˆ¬êµ¬í‘¸ìŠ¤", type1: "ë°”ìœ„", type2: "ë¬¼", basePower: 88, rarity: 5 },

  { id: 142, name: "í”„í…Œë¼", type1: "ë°”ìœ„", type2: "ë¹„í–‰", basePower: 95, rarity: 5 },

  { id: 143, name: "ì ë§Œë³´", type1: "ë…¸ë§", type2: null, basePower: 92, rarity: 5 },

  { id: 144, name: "í”„ë¦¬ì ¸", type1: "ì–¼ìŒ", type2: "ë¹„í–‰", basePower: 110, rarity: 5 },
  { id: 145, name: "ì¬ë”", type1: "ì „ê¸°", type2: "ë¹„í–‰", basePower: 110, rarity: 5 },
  { id: 146, name: "íŒŒì´ì–´", type1: "ë¶ˆ", type2: "ë¹„í–‰", basePower: 110, rarity: 5 },

  { id: 147, name: "ë¯¸ë‡½", type1: "ë“œë˜ê³¤", type2: null, basePower: 50, rarity: 4 },
  { id: 148, name: "ì‹ ë‡½", type1: "ë“œë˜ê³¤", type2: null, basePower: 78, rarity: 5 },
  { id: 149, name: "ë§ë‚˜ë‡½", type1: "ë“œë˜ê³¤", type2: "ë¹„í–‰", basePower: 112, rarity: 5 },

  { id: 150, name: "ë®¤ì¸ ", type1: "ì—ìŠ¤í¼", type2: null, basePower: 120, rarity: 5 },
  { id: 151, name: "ë®¤", type1: "ì—ìŠ¤í¼", type2: null, basePower: 115, rarity: 5 }
];

// -------------------- í¬ì¼“ëª¬ DB ë¹ ë¥¸ ì¡°íšŒ ë§µ --------------------
var POKE_BY_ID = {};
for (var __i = 0; __i < POKEMON_DB.length; __i++) {
  var __p = POKEMON_DB[__i];
  if (__p && __p.id != null) 
    POKE_BY_ID[__p.id] = __p;
}
// -------------------- ì§„í™” ë£° --------------------
// 2ë²ˆ ì§„í™”: +10, +20
// 1ë²ˆ ì§„í™”(ëŒ/í†µì‹  í¬í•¨): +15
// ì´ë¸Œì´: +13 ëœë¤(134/135/136)
var EVOLVE_TWO_STAGE_1 = 10;
var EVOLVE_TWO_STAGE_2 = 20;
var EVOLVE_ONE_STAGE = 15;
var EVOLVE_EEVEE = 13;
var EEVEE_EVOS = [134, 135, 136];
// 1ì„¸ëŒ€ ì§„í™” ë§µ(ë„ˆ ë£° ê¸°ì¤€: ëŒ/í†µì‹ ë„ í¬í•¨í•´ì„œ ì „ë¶€ ê°•í™”ë¡œ ì²˜ë¦¬)
var EVOLUTION_MAP = {
  1: 2, 
  2: 3, 
  4: 5, 
  5: 6, 
  7: 8, 
  8: 9, 
  10: 11, 
  11: 12, 
  13: 14, 
  14: 15, 
  16: 17, 
  17: 18, 
  19: 20, 
  21: 22, 
  23: 24, 
  25: 26, 
  27: 28, 
  29: 30, 
  30: 31, 
  32: 33, 
  33: 34, 
  35: 36, 
  37: 38, 
  39: 40, 
  41: 42, 
  43: 44, 
  44: 45, 
  46: 47, 
  48: 49, 
  50: 51, 
  52: 53, 
  54: 55, 
  56: 57, 
  58: 59, 
  60: 61, 
  61: 62, 
  63: 64, 
  64: 65, 
  66: 67, 
  67: 68, 
  69: 70, 
  70: 71, 
  72: 73, 
  74: 75, 
  75: 76, 
  77: 78, 
  79: 80, 
  81: 82, 
  84: 85, 
  86: 87, 
  88: 89, 
  90: 91, 
  92: 93, 
  93: 94, 
  96: 97, 
  98: 99, 
  100: 101, 
  102: 103, 
  104: 105, 
  109: 110, 
  111: 112, 
  116: 117, 
  118: 119, 
  120: 121, 
  129: 130, 
  138: 139, 
  140: 141, 
  147: 148, 
  148: 149};
// -------------------- íƒ€ì… ìƒì„±í‘œ(ê°„ë‹¨) --------------------
var TYPE_CHART = {
  "ë¶ˆ": {  "í’€": 2,   "ë²Œë ˆ": 2,   "ì–¼ìŒ": 2,   "ë¬¼": 0.5,   "ë°”ìœ„": 0.5,   "ë“œë˜ê³¤": 0.5}, 
  "ë¬¼": {  "ë¶ˆ": 2,   "ë•…": 2,   "ë°”ìœ„": 2,   "í’€": 0.5,   "ë“œë˜ê³¤": 0.5}, 
  "í’€": {  "ë¬¼": 2,   "ë•…": 2,   "ë°”ìœ„": 2,   "ë¶ˆ": 0.5,   "í’€": 0.5,   "ë…": 0.5,   "ë²Œë ˆ": 0.5,   "ë“œë˜ê³¤": 0.5,   "ë¹„í–‰": 0.5}, 
  "ì „ê¸°": {  "ë¬¼": 2,   "ë¹„í–‰": 2,   "ì „ê¸°": 0.5,   "í’€": 0.5,   "ë“œë˜ê³¤": 0.5,   "ë•…": 0}, 
  "ì–¼ìŒ": {  "í’€": 2,   "ë•…": 2,   "ë¹„í–‰": 2,   "ë“œë˜ê³¤": 2,   "ë¶ˆ": 0.5,   "ë¬¼": 0.5,   "ì–¼ìŒ": 0.5}, 
  "ê²©íˆ¬": {  "ë…¸ë§": 2,   "ë°”ìœ„": 2,   "ì–¼ìŒ": 2,   "ë…": 0.5,   "ë¹„í–‰": 0.5,   "ì—ìŠ¤í¼": 0.5,   "í˜ì–´ë¦¬": 0.5,   "ê³ ìŠ¤íŠ¸": 0}, 
  "ë…": {  "í’€": 2,   "í˜ì–´ë¦¬": 2,   "ë…": 0.5,   "ë•…": 0.5,   "ë°”ìœ„": 0.5,   "ê³ ìŠ¤íŠ¸": 0.5}, 
  "ë•…": {  "ë¶ˆ": 2,   "ì „ê¸°": 2,   "ë…": 2,   "ë°”ìœ„": 2,   "í’€": 0.5,   "ë²Œë ˆ": 0.5,   "ë¹„í–‰": 0}, 
  "ë¹„í–‰": {  "í’€": 2,   "ê²©íˆ¬": 2,   "ë²Œë ˆ": 2,   "ì „ê¸°": 0.5,   "ë°”ìœ„": 0.5}, 
  "ë²Œë ˆ": {  "í’€": 2,   "ì—ìŠ¤í¼": 2,   "ë¶ˆ": 0.5,   "ê²©íˆ¬": 0.5,   "ë¹„í–‰": 0.5,   "ê³ ìŠ¤íŠ¸": 0.5}, 
  "ë°”ìœ„": {  "ë¶ˆ": 2,   "ì–¼ìŒ": 2,  "ë¹„í–‰": 2,   "ë²Œë ˆ": 2,   "ê²©íˆ¬": 0.5,   "ë•…": 0.5}, 
  "ê³ ìŠ¤íŠ¸": {  "ê³ ìŠ¤íŠ¸": 2,   "ì—ìŠ¤í¼": 2,   "ë…¸ë§": 0}, 
  "ë“œë˜ê³¤": {  "ë“œë˜ê³¤": 2}, 
  "ì—ìŠ¤í¼": {  "ê²©íˆ¬": 2,   "ë…": 2,   "ì—ìŠ¤í¼": 0.5}, 
  "í˜ì–´ë¦¬": {  "ê²©íˆ¬": 2,   "ë“œë˜ê³¤": 2,   "ë¶ˆ": 0.5,   "ë…": 0.5}
  };
  
// -------------------- íŒŒì¼ IO (í™˜ê²½ë³„ë¡œ êµì²´) --------------------
function readFile(path) {
  try {
    var file = new java.io.File(path);
    if (!file.exists()) 
      return null;
    var fis = new java.io.FileInputStream(file);
    var isr = new java.io.InputStreamReader(fis, "UTF-8");
    var br = new java.io.BufferedReader(isr);
    var sb = "";
    var line = null;
    while ((line = br.readLine()) !== null) 
      sb += line;
    br.close();
    isr.close();
    fis.close();
    return sb;
  }  catch (e) {
  return null;
}
}
function writeFile(path, text) {
  try {
    var file = new java.io.File(path);
    var parent = file.getParentFile();
    if (parent && !parent.exists()) 
      parent.mkdirs();
    var fos = new java.io.FileOutputStream(file);
    var osw = new java.io.OutputStreamWriter(fos, "UTF-8");
    osw.write(text);
    osw.close();
    fos.close();
    return true;
  }  catch (e) {
  return false;
}
}
// -------------------- ë°ì´í„° ë¡œë“œ/ì„¸ì´ë¸Œ --------------------
function loadData() {
  var raw = readFile(DATA_PATH);
  if (!raw) {
    return {
  users: {}, 
  lastSpawnByRoom: {}, 
  regionByRoom: {}};
  }
  try {
    var d = JSON.parse(raw);
    if (!d.users) 
      d.users = {};
    if (!d.lastSpawnByRoom) 
      d.lastSpawnByRoom = {};
    if (!d.regionByRoom) 
      d.regionByRoom = {};
    return d;
  }  catch (e) {
  return {
  users: {}, 
  lastSpawnByRoom: {}, 
  regionByRoom: {}};
}
}
// -------------------- ë°ì´í„° ì„¸ì´ë¸Œ --------------------
function saveData(d) {
  try {
    if (!d) 
      return false;
    return writeFile(DATA_PATH, JSON.stringify(d));
  }  catch (e) {
  return false;
}
}
// -------------------- ë°ì´í„° ìºì‹œ (í•„ìˆ˜ ìµœì í™”) --------------------
var DATA_CACHE = null;
var DATA_DIRTY = false;
var LAST_SAVE_AT = 0;
var SAVE_INTERVAL_MS = 20 * 1000;// 20ì´ˆ
function getDataCached() {
  if (DATA_CACHE) 
    return DATA_CACHE;
  DATA_CACHE = loadData();  // ê¸°ì¡´ loadData ê·¸ëŒ€ë¡œ ì‚¬ìš©
  return DATA_CACHE;
}
function markDirty() {
  DATA_DIRTY = true;
}
function flushSaveIfNeeded(force) {
  var now = nowMs();
  if (!DATA_CACHE) 
    return;
  if (force || (DATA_DIRTY && (now - LAST_SAVE_AT >= SAVE_INTERVAL_MS))) {
    saveData(DATA_CACHE);
    DATA_DIRTY = false;
    LAST_SAVE_AT = now;
  }
}
// -------------------- ì‹ ê·œ íšŒì›ê°€ì… ë³´ìƒ --------------------
function grantSignupBonusIfNeeded(u, sender) {
  if (!u.isNewUser) 
    return "";
  u.gold += 10000;
  u.ball += 10;
  u.isNewUser = false;
  return (sender + "ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!\n\n" + "ğŸ‰ ì‹ ê·œ íšŒì›ê°€ì… ë³´ìƒ\n" + "+10000ğŸ’° / +10 ëª¬ìŠ¤í„°ë³¼");
}
// -------------------- ìœ í‹¸ --------------------
function nowMs() {
  return new Date().getTime();
}
function dateKeyKST() {
  // ì„œë²„/í° íƒ€ì„ì¡´ì´ ì„ì—¬ë„ ìµœëŒ€í•œ ì•ˆì •ì ìœ¼ë¡œ "ì˜¤ëŠ˜"ì„ ë§Œë“¤ê¸° ìœ„í•´
  // ë¡œì»¬ ë‚ ì§œ ê¸°ë°˜ YYYY-MM-DDë¡œ ì €ì¥
  var d = new Date();
  var y = d.getFullYear();
  var m = d.getMonth() + 1;
  var dd = d.getDate();
  if (m < 10) 
    m = "0" + m;
  if (dd < 10) 
    dd = "0" + dd;
  return y + "-" + m + "-" + dd;
}
function ensureUserStats(u) {
  if (!u.stats) 
    u.stats = {};
  if (typeof u.stats.battleWin !== "number") 
    u.stats.battleWin = 0;
  if (typeof u.stats.battleLose !== "number") 
    u.stats.battleLose = 0;
  if (typeof u.stats.battleDraw !== "number") 
    u.stats.battleDraw = 0;
  if (typeof u.stats.battleStreak !== "number") 
    u.stats.battleStreak = 0;
  if (typeof u.stats.bestStreak !== "number") 
    u.stats.bestStreak = 0;
  if (typeof u.stats.lastBattleAt !== "number") 
    u.stats.lastBattleAt = 0;
}

function resetBattleStats(u) {
  if (!u) return;
  if (!u.stats) u.stats = {};
  u.stats.battleWin = 0;
  u.stats.battleLose = 0;
  u.stats.battleDraw = 0;
  u.stats.battleStreak = 0;
  u.stats.bestStreak = 0;
  u.stats.lastBattleAt = 0;
}

function resetBattleStatsAll(d) {
  if (!d || !d.users) return 0;
  var cnt = 0;
  for (var name in d.users) {
    if (!d.users[name]) continue;
    resetBattleStats(d.users[name]);
    cnt++;
  }
  return cnt;
}

function findPokemonDB(pid) {
  pid = parseInt(pid, 10);
  return POKE_BY_ID[pid] || null;
}
// í¬ì¼“ëª¬ ì´ë¦„ìœ¼ë¡œ DB ì°¾ê¸° (ìš´ì˜ì í¬ì¼“ëª¬ì§€ê¸‰ìš©)
// "ë®¤", "í”¼ì¹´ì¸„" ê°™ì€ ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰
function findPokemonDBByName(name) {
  if (!name) 
    return null;
  var key = ("" + name).trim();
  if (!key) 
    return null;
  var k = key.replace(/\s+/g, "").toLowerCase();
  // DB í›„ë³´ë“¤(ë„¤ ì½”ë“œì—ì„œ ì–´ë–¤ ì´ë¦„ì„ ì“°ë“  ìµœëŒ€í•œ ëŒ€ì‘)
  var arr = null;
  if (typeof POKEMON_DB !== "undefined" && POKEMON_DB && POKEMON_DB.length) 
    arr = POKEMON_DB;
  else if (typeof pokemonDB !== "undefined" && pokemonDB && pokemonDB.length) 
    arr = pokemonDB;
  else if (typeof POKE_DB !== "undefined" && POKE_DB && POKE_DB.length) 
    arr = POKE_DB;
  else if (typeof POKEMONS !== "undefined" && POKEMONS && POKEMONS.length) 
    arr = POKEMONS;
  if (!arr) 
    return null;
  for (var i = 0; i < arr.length; i++) {
    var p = arr[i];
    if (!p) 
      continue;
    var cands = [];
    if (p.name) 
      cands.push(p.name);
    if (p.koName) 
      cands.push(p.koName);
    if (p.kor) 
      cands.push(p.kor);
    if (p.kr) 
      cands.push(p.kr);
    if (p.enName) 
      cands.push(p.enName);
    for (var j = 0; j < cands.length; j++) {
      var nm = ("" + cands[j]).trim();
      if (!nm) 
        continue;
      var nmKey = nm.replace(/\s+/g, "").toLowerCase();
      if (nmKey === k) 
        return p;
    }
  }
  return null;
}
// [4ë‹¨ê³„ ìˆ˜ì •] ì „íˆ¬ë ¥ ê³„ì‚° (í˜/ê³µì† IV ë°˜ì˜)
function calcBattlePower(p) {
  var db = findPokemonDB(p.pid);
  if (!db) return 0;
  
  var base = db.basePower || 1;
  var enh = p.enh || 0;
  
  // ê°œì²´ê°’ ë³´ë„ˆìŠ¤: í˜(ivStr)ê³¼ ê³µì†(ivSpd)ì„ ë”í•¨
  var ivBonus = (p.ivStr || 0) + (p.ivSpd || 0); 
  
  // (ê¸°ë³¸íŒŒì›Œ + ê°œì²´ê°’) ê¸°ì¤€ì— ê°•í™” ë°°ìœ¨ì„ ê³±í•¨
  return Math.floor((base + ivBonus) * (1 + enh * 0.15));
}

//ì „íˆ¬ë ¥ ê¸°ì¤€ ì •ë ¬
function sortPokemonsByPower(list) {
  return list.slice().sort(function(a, b) {
  var pa = calcBattlePower(a);
  var pb = calcBattlePower(b);
  if (pb !== pa) 
    return pb - pa;
  if ((b.enh || 0) !== (a.enh || 0)) 
    return (b.enh || 0) - (a.enh || 0);
  return a.uid - b.uid;
});
}
//ìœ ì € ë„ê° ë­í‚¹ ê³„ì‚°
function getTotalDexCount() {
  return POKEMON_DB.length;
}
function getUserDexCount(u) {
  if (!u.dex) return 0;
  var cnt = 0;
  for (var k in u.dex) {
    if (u.dex[k]) cnt++;
  }
  return cnt;
}
function getDexPercent(u) {
  var total = getTotalDexCount();
  if (total <= 0) return 0;
  return Math.floor((getUserDexCount(u) / total) * 1000) / 10; 
  // ì†Œìˆ˜ 1ìë¦¬
}
// ë„ê° ë­í‚¹ (ë‚´ ìˆœìœ„ í¬í•¨)
function buildDexRankingWithMyRank(d, limit, myName) {
  limit = limit || 10;
  var list = [];
  var total = getTotalDexCount();

  for (var name in d.users) {
    if (!d.users.hasOwnProperty(name)) continue;
    var u = d.users[name];
    if (!u || !u.dex) continue;

    var count = getUserDexCount(u);
    if (count <= 0) continue;

    list.push({
      name: name,
      count: count,
      percent: getDexPercent(u)
    });
  }

  list.sort(function(a, b) {
    if (b.percent !== a.percent) return b.percent - a.percent;
    if (b.count !== a.count) return b.count - a.count;
    return String(a.name).localeCompare(String(b.name));
  });

  var myIdx = -1;
  for (var i = 0; i < list.length; i++) {
    if (list[i].name === myName) { myIdx = i; break; }
  }

  return {
    rows: list,
    myIdx: myIdx,
    total: total,
    top: list.slice(0, Math.min(limit, list.length))
  };
}

// [ìˆ˜ì •ë¨] ì‹ ê·œ ì•„ì´í…œ í•„ë“œ ì¶”ê°€ (normalizeUserData)
function normalizeUserData(u) {
  if (!u) return;
  
  // 1. ê¸°ë³¸ ìœ ì € ì •ë³´ ì´ˆê¸°í™”
  if (typeof u.trainerLv !== "number") u.trainerLv = 1;
  if (typeof u.trainerExp !== "number") u.trainerExp = 0;
  if (typeof u.gold !== "number") u.gold = 0;
  
  // [ê¸°ì¡´ ë³¼]
  if (typeof u.ball !== "number") u.ball = 0;
  if (typeof u.superBall !== "number") u.superBall = 0;
  if (typeof u.ultraBall !== "number") u.ultraBall = 0;
  
  // [íŠ¹ìˆ˜ ì•„ì´í…œ]
  if (typeof u.dopaTicket !== "number") u.dopaTicket = 0; 
  if (typeof u.cookie !== "number") u.cookie = 0;    // ë‘ì«€ì¿ 
  if (typeof u.ticket !== "number") u.ticket = 0;    // ì´ë™í‹°ì¼“
  if (typeof u.reroll !== "number") u.reroll = 0;    // ì¬ì„¤ì •ê¶Œ
  if (typeof u.nextFieldRegion !== "string") u.nextFieldRegion = ""; // ë‹¤ìŒ ì´ë™ ì§€ì—­

  if (typeof u.lastAttendanceKey !== "string") u.lastAttendanceKey = "";
  if (!Array.isArray(u.pokemons)) u.pokemons = [];
  if (typeof u.nextPokeUid !== "number") u.nextPokeUid = 1;
  if (typeof u.catchFailStreak !== "number") u.catchFailStreak = 0;
  if (typeof u.lastCatchPid !== "number") u.lastCatchPid = 0;

  // 2. í¬ì¼“ëª¬ ë°°ì—´ ì •ë¦¬ (ë°ì´í„° ë³´ì¡´)
  var fixed = [];
  for (var i = 0; i < u.pokemons.length; i++) {
    var p = u.pokemons[i];
    if (!p || typeof p !== "object") continue;
    
    var pid = parseInt(p.pid, 10);
    var uid = parseInt(p.uid, 10);
    var enh = parseInt(p.enh, 10);
    
    if (!pid || !uid) continue;
    if (!findPokemonDB(pid)) continue;

    var cleanObj = {
      uid: uid,
      pid: pid,
      enh: isNaN(enh) ? 0 : enh,
      grade: p.grade,
      ivStr: p.ivStr,
      ivHp: p.ivHp,
      ivSpd: p.ivSpd
    };
    fixed.push(cleanObj);
  }
  u.pokemons = fixed;
  
  ensureUserStats(u);
  ensureUserDex(u);
}

// [ê°•ë ¥ ìˆ˜ì •] ì›ë³¸ ë°°ì—´ì„ í™•ì‹¤í•˜ê²Œ ìˆ˜ì •í•˜ê³  ì €ì¥ ì—¬ë¶€ë¥¼ ë°˜í™˜
function ensurePokemonGrades(u) {
  if (!u || !u.pokemons || !Array.isArray(u.pokemons)) return false;
  
  var isChanged = false;
  
  // ì›ë³¸ ë°°ì—´(u.pokemons)ì„ ì§ì ‘ ìˆœíšŒí•˜ë©° ìˆ˜ì •
  for (var i = 0; i < u.pokemons.length; i++) {
    // ì—¬ê¸°ì„œ pëŠ” ì›ë³¸ ë°°ì—´ì˜ ìš”ì†Œë¥¼ ì°¸ì¡°í•¨
    var p = u.pokemons[i]; 

    // ë“±ê¸‰ì´ ì—†ê±°ë‚˜(undefined), ìœ íš¨í•˜ì§€ ì•Šì€ ê°’ì¼ ë•Œë§Œ ìƒˆë¡œ ìƒì„±
    if (!p.grade) {
      // 1. ë“±ê¸‰ ë° IV ìƒì„±
      var newGrade = generatePokemonGrade();
      var newIVs = generateIVsByGrade(newGrade);
      
      // 2. ì›ë³¸ ê°ì²´ì— ì§ì ‘ í• ë‹¹
      u.pokemons[i].grade = newGrade;
      u.pokemons[i].ivStr = newIVs.str;
      u.pokemons[i].ivHp = newIVs.hp;
      u.pokemons[i].ivSpd = newIVs.spd;
      
      // 3. ë„ê° ë°˜ì˜ (ìµœì´ˆ 1íšŒ)
      if (typeof dexCaught === "function") {
        dexCaught(u, p.pid, newGrade);
      }
      
      isChanged = true;
    }
  }
  
  return isChanged; // ë³€ê²½ì‚¬í•­ì´ ìˆì—ˆë‹¤ë©´ true
}


function findUserPokemonByUid(u, uid) {
  uid = parseInt(uid, 10);
  if (!u || !Array.isArray(u.pokemons)) 
    return null;
  for (var i = 0; i < u.pokemons.length; i++) {
    if (parseInt(u.pokemons[i].uid, 10) === uid) 
      return u.pokemons[i];
  }
  return null;
}
function randomPick(arr) {
  return arr[Math.floor(Math.random() * arr.length)];
}
function say(userName, text) {
  return userName + "ë‹˜, " + text;
}
function sayDo(userName, text) {
  return userName + "ë‹˜ì´ " + text;
}
var ENH_RESULT_UP = "UP";
var ENH_RESULT_KEEP = "KEEP";
var ENH_RESULT_EXIT = "EXIT";
var ENH_RESULT_DOWN = "DOWN";// ë”±íˆ ì•ˆì“°ì¼ ì˜ˆì •
function getEnhTier(enh) {
  if (enh < 10) 
    return "EASY";
  if (enh < 20) 
    return "MID";
  return "HARD";
}
// -------------------- ì¶œì„ ë³´ìƒ í…Œì´ë¸” --------------------
var ATTENDANCE_STREAK_REWARD = {
  7:  { dopa: 7 },
  14: { dopa: 14 },
  30: { dopa: 30 }
};

// ì¶œì„ ë°ì´í„° ì´ˆê¸°í™”
function ensureAttendance(u) {
  if (!u.attendance) {
    u.attendance = {
      lastDate: "",
      streak: 0,
      total: 0
    };
  }
}

// ì¶œì„ ê³¨ë“œ ê³„ì‚° (ê¸°ì¡´ * 5ë°°)
function calcAttendanceGold(u) {
  var base = randInt(300, 900);
  var lv = (u && typeof u.trainerLv === "number") ? u.trainerLv : 1;
  lv = Math.max(1, Math.min(99, lv));

  var mul = 1 + (lv - 1) * 0.08;
  if (mul > 3.5) mul = 3.5;

  return Math.floor(base * mul * 8);
}

function randInt(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

// -------------------- ì¶œì„ ì²´í¬ --------------------
function doAttendanceCheck(u, sender) {
  ensureUserStats(u);
  ensureAttendance(u);

  var today = dateKeyKST();

  // ì´ë¯¸ ì¶œì„
  if (u.attendance.lastDate === today) {
    return {
      ok: false,
      msg: "ì˜¤ëŠ˜ì€ ì´ë¯¸ ì¶œì„í–ˆì–´ìš”.\në‚´ì¼ ë‹¤ì‹œ ì™€ì£¼ì„¸ìš”."
    };
  }

  // ì—°ì† ì¶œì„ ê³„ì‚°
  var newStreak = 1;
  if (u.attendance.lastDate) {
    var lastDay = dateKeyToDayNumber(u.attendance.lastDate);
    var todayDay = dateKeyToDayNumber(today);
    if (todayDay - lastDay === 1) {
      newStreak = (u.attendance.streak || 0) + 1;
    }
  }

  // ë°˜ì˜
  u.attendance.lastDate = today;
  u.attendance.streak = newStreak;
  u.attendance.total = (u.attendance.total || 0) + 1;

  // ğŸ ê³¨ë“œ
  var goldGain = calcAttendanceGold(u);
  u.gold = (u.gold || 0) + goldGain;

  // ğŸ EXP
  var expGain = 50 + (u.trainerLv * 10);
  var lvMsg = addExpWithLevelUpMsg(u, expGain);

  // ğŸ ë§¤ì¼ ë„íŒŒë¯¼ 1ì¥
  u.dopaTicket = (u.dopaTicket || 0) + 1;

  var bonusLines = [];
  bonusLines.push("ë„íŒŒë¯¼ ê°•í™”ê¶Œ +1ğŸ’³");

  // ğŸ ì—°ì† ì¶œì„ ë³´ë„ˆìŠ¤ (7/14/30)
  var streakReward = ATTENDANCE_STREAK_REWARD[newStreak];
  if (streakReward && streakReward.dopa) {
    u.dopaTicket += streakReward.dopa;
    bonusLines.push(
      newStreak + "ì¼ ì—°ì† ë³´ë„ˆìŠ¤ ë„íŒŒë¯¼ ê°•í™”ê¶Œ +" + streakReward.dopa + "ğŸ’³"
    );
  }

  var msg =
    sender + "ë‹˜ ì¶œì„ ì™„ë£Œ!\n" +
    "ì—°ì† ì¶œì„: " + newStreak + "ì¼\n" +
    "ëˆ„ì  ì¶œì„: " + u.attendance.total + "ì¼\n\n" +
    "ğŸ ì¶œì„ ë³´ìƒ\n" +
    "+" + goldGain + "ğŸ’° / +" + expGain + "EXP\n";

  if (bonusLines.length > 0) {
    msg += "\nğŸ”¥ ë³´ë„ˆìŠ¤\n" + bonusLines.join("\n") + "\n";
  }
// ğŸ¯ ë‹¤ìŒ ëª©í‘œ ì•ˆë‚´ (7ì¼ ë¯¸ë§Œì¼ ë•Œë§Œ)
// ğŸ¯ ë‹¤ìŒ ì—°ì† ì¶œì„ ëª©í‘œ ì•ˆë‚´
var nextTarget = null;
var nextReward = 0;

if (newStreak < 7) {
  nextTarget = 7;
  nextReward = 7;
} else if (newStreak < 14) {
  nextTarget = 14;
  nextReward = 14;
} else if (newStreak < 30) {
  nextTarget = 30;
  nextReward = 30;
}

if (nextTarget) {
  var remain = nextTarget - newStreak;
  msg +=
    "\nğŸ¯ ëª©í‘œ\n" +
    nextTarget + "ì¼ ì—°ì† ì¶œì„ ì‹œ ë„íŒŒë¯¼ ê°•í™”ê¶Œ +" +
    nextReward + "ğŸ’³ (" + remain + "ì¼ ë‚¨ìŒ)\n";
}
  if (lvMsg) {
    msg += "\n" + lvMsg;
  }

  return { ok: true, msg: msg };
}

// ë‚ ì§œ â†’ ì¼ìˆ˜ ë³€í™˜
function dateKeyToDayNumber(key) {
  var y = parseInt(key.substr(0, 4), 10);
  var m = parseInt(key.substr(5, 2), 10);
  var d = parseInt(key.substr(8, 2), 10);
  return Math.floor(Date.UTC(y, m - 1, d) / 86400000);
}
// -------------------- íƒ€ì¸ ì •ë³´ ìœ í‹¸ --------------------
function getTargetFromMsg(d, sender, msg, cmd) {
  var tail = msg.slice(cmd.length).trim();
  if (!tail) 
    return {
  user: d.users[sender], 
  name: sender};
  if (tail.charAt(0) === "@") 
    tail = tail.slice(1);
  var tu = d.users[tail];
  if (!tu) 
    return null;
  normalizeUserData(tu);
  return {
  user: tu, 
  name: tail};
}
// -------------------- ë°°í‹€ ì—°ì¶œ ìœ í‹¸ --------------------
function clamp(n, a, b) {
  return Math.max(a, Math.min(b, n));
}
function rnd(min, max) {
  return min + Math.random() * (max - min);
}
function typeEffectTier(mult) {
  // remap ì´í›„ mult ìŠ¤ì¼€ì¼ì— ë§ì¶˜ ë¬¸êµ¬ ê¸°ì¤€
  if (mult >= 7.5) 
    return 3;
  if (mult >= 4.2) 
    return 2;
  if (mult >= 2.8) 
    return 1;
  if (mult <= 1.20) 
    return -1;
  return 0;
}
function typeEffectText(mult) {
  var t = typeEffectTier(mult);
  if (t === 3) 
    return "íš¨ê³¼ê°€ ë§ë„ ì•ˆ ë˜ê²Œ êµ‰ì¥í–ˆë‹¤!";
  if (t === 2) 
    return "íš¨ê³¼ê°€ êµ‰ì¥í–ˆë‹¤!";
  if (t === 1) 
    return "íš¨ê³¼ê°€ ì¢‹ì•˜ë‹¤!";
  if (t === -1) 
    return "íš¨ê³¼ê°€ ë³„ë¡œì¸ ë“¯í•˜ë‹¤â€¦";
  return "";
}
function funnyHitText() {
  var arr = ["ì •ì‹ ì´ ì ê¹ ë‚˜ê°”ë‹¤!", "í™”ë©´ ë°–ìœ¼ë¡œ ë‚ ì•„ê°ˆ ë»”í–ˆë‹¤!", "ì˜†ì—ì„œ êµ¬ê²½í•˜ë˜ ì‚¬ëŒë„ ë†€ëë‹¤!", "ë‚´ê°€ ë°©ê¸ˆ ë­˜ ë³¸ ê±°ì§€â€¦?", "ì´ê±´ ì¢€ ê³¼í–ˆë‹¤!", "ìƒëŒ€ê°€ ì ê¹ ë©ˆì·„ë‹¤â€¦(ë ‰ ì•„ë‹˜)"];
  return arr[Math.floor(Math.random() * arr.length)];
}
function funnyDodgeText() {
  var arr = ["íšŒí”¼í–ˆë‹¤! ìŠ¬ì© ë¹„ì¼œê°”ë‹¤!", "íšŒí”¼í–ˆë‹¤! ë¯¸ë„ëŸ¬ì§€ë“¯ í”¼í–ˆë‹¤!", "íšŒí”¼í–ˆë‹¤! â€˜ì•ˆ ë§ì¥¬?â€™", "íšŒí”¼í–ˆë‹¤! ì´ê±¸ í”¼í•˜ë„¤â€¦?", "íšŒí”¼í–ˆë‹¤! ë°œë°‘ì´ ê°€ë²¼ì› ë‹¤!"];
  return arr[Math.floor(Math.random() * arr.length)];
}
function funnyGuardText() {
  var arr = ["ë°©ì–´ íƒœì„¸! ë°ë¯¸ì§€ê°€ ì¤„ì—ˆë‹¤!", "ê°€ë“œ ì„±ê³µ! ë‹¨ë‹¨í•˜ê²Œ ë²„í…¼ë‹¤!", "ë§‰ì•„ëƒˆë‹¤! ê±°ì˜ ì•ˆ ë“¤ì–´ê°”ë‹¤!", "ë°©ì–´! ìƒëŒ€ê°€ ë‹¹í™©í–ˆë‹¤!"];
  return arr[Math.floor(Math.random() * arr.length)];
}
function crisisText(name) {
  var arr = [name + " ìœ„ê¸°! ìˆ¨ì´ í„±ê¹Œì§€ ì°¼ë‹¤!", name + " ìœ„ê¸°! ëˆˆì•ì´ í•˜ì–˜ì¡Œë‹¤!", name + " ìœ„ê¸°! ì†ì— ë•€ì´ ë‚œë‹¤!", name + " ìœ„ê¸°! â€˜ì—¬ê¸°ì„œ ì§€ë©´ ì•ˆ ë¼!â€™"];
  return arr[Math.floor(Math.random() * arr.length)];
}
// [ìˆ˜ì •] ìµœëŒ€ ì²´ë ¥ ê³„ì‚° ìœ í‹¸ (ê°œì²´ê°’ ë°˜ì˜)
function calcHP(db, enh, ivHp) {
  var s = getStageFromBase(db.id);
  var addPerEnh = (s === 0) ? 10 : (s === 1) ? 24 : 42; 
  
  var base = 260 + (db.basePower * 8);
  
  // ê¸°ë³¸ ì²´ë ¥ + ê°•í™” ìˆ˜ì¹˜ + ê°œì²´ê°’ ì²´ë ¥(ivHp) ê°€ì‚°
  var hp = base + Math.floor(enh * addPerEnh) + (ivHp || 0);
  
  // ìº¡(ìƒí•œì„ )ì„ 2000 -> 3000ìœ¼ë¡œ ìƒí–¥í•˜ì—¬ Së“±ê¸‰ì˜ ê°€ì¹˜ë¥¼ ë³´ì¡´
  return clamp(hp, 300, 3000);
}

// [1ë‹¨ê³„] ê°œì²´ê°’(IV) ë°˜ì˜ ë°ë¯¸ì§€ ê³µì‹
function calcHit(attDb, attP, defDb, defP, trainerLvAtt, trainerLvDef) {
  // attP, defP: í¬ì¼“ëª¬ ê°ì²´ (enh, ivStr, ivSpd í¬í•¨)
  
  // 1. ë°ë¯¸ì§€ ê³„ì‚°ì— í˜(ivStr) ë°˜ì˜
  var base = calcDamage(attDb, attP.enh, defDb, defP.enh);
  
  // ê°œì²´ê°’ ë³´ë„ˆìŠ¤: (í˜ IV * 1.5)% ë§Œí¼ ìµœì¢… ë°ë¯¸ì§€ ì¦ê°€
  var strBonus = 1 + ((attP.ivStr || 0) * 0.015); 
  base.score = Math.floor(base.score * strBonus);

  // 2. íšŒí”¼ìœ¨ ê³„ì‚°ì— ê³µì†(ivSpd) ë°˜ì˜ (ìƒëŒ€ ê³µì†ì´ ë†’ìœ¼ë©´ íšŒí”¼ ì–´ë ¤ì›€)
  var spdDiff = (defP.ivSpd || 0) - (attP.ivStr || 0); 
  var dodge = 0.10 
    + clamp(((trainerLvDef || 1) - (trainerLvAtt || 1)) * 0.0008, -0.03, 0.03) 
    + clamp((defP.enh - attP.enh) * 0.004, -0.02, 0.02)
    + (spdDiff * 0.002); 

  dodge = clamp(dodge, 0.05, 0.25); 

  // 3. ë°©ì–´/í¬ë¦¬ ê³„ì‚°
  var guard = 0.12 + clamp(defP.enh * 0.002, 0, 0.04);
  var crit = 0.12 + clamp(attP.enh * 0.001, 0, 0.03) + ((attP.ivSpd || 0) * 0.003);
  crit = clamp(crit, 0.10, 0.25);

  var swing = rnd(0.88, 1.12);

  if (Math.random() < dodge) {
    return { dodged: true, guarded: false, crit: false, dmg: 0, mult: base.mult };
  }

  var isGuard = (Math.random() < guard);
  var isCrit = (Math.random() < crit);
  var dmg = Math.max(1, Math.floor(base.score * swing * (isCrit ? 1.55 : 1.0) * (isGuard ? 0.55 : 1.0)));

  return { dodged: false, guarded: isGuard, crit: isCrit, dmg: dmg, mult: base.mult };
}

// [ìˆ˜ì •ë¨] ë°°í‹€ ë¡œê·¸ ì‹œë®¬ë ˆì´í„° (ê°ì²´ë¥¼ ë°›ì•„ì„œ ì²˜ë¦¬í•˜ëŠ” ì‹ í˜•)
function simulateBattleLog(aName, aDb, aP, aTLv, bName, bDb, bP, bTLv) {
  // aP, bP: í¬ì¼“ëª¬ ê°ì²´ í†µì§¸ë¡œ (enh, ivHp, ivStr, ivSpd ë“± í¬í•¨)
  
  // ì²´ë ¥ ê³„ì‚° (IV ë°˜ì˜)
  var aMax = calcHP(aDb, aP.enh, aP.ivHp || 0);
  var bMax = calcHP(bDb, bP.enh, bP.ivHp || 0);
  var aHP = aMax;
  var bHP = bMax;

  // ì„ ê³µ í™•ë¥  (ê³µì† IVê°€ ë†’ì€ ìª½ì´ ìœ ë¦¬)
  var spdAdvantage = ((aP.ivSpd || 0) - (bP.ivSpd || 0)) * 0.02;
  var aFirst = 0.50 + clamp((aP.enh - bP.enh) * 0.02 + spdAdvantage, -0.2, 0.2);
  var aTurn = (Math.random() < aFirst);

  var log = "";
  var aE = enhLabel(aP.enh);
  var bE = enhLabel(bP.enh);

  // [ìƒì„¸ ìŠ¤íƒ¯ í‘œì‹œ]
  log += "âš”ï¸ " + aName + ": " + aDb.name + (aE ? " " + aE : "") + "\n(HP " + aMax + " / í˜ " + (aP.ivStr||0) + " / ë¯¼ " + (aP.ivSpd||0) + ")\n";
  log += "ğŸ›¡ï¸ " + bName + ": " + bDb.name + (bE ? " " + bE : "") + "\n(HP " + bMax + " / í˜ " + (bP.ivStr||0) + " / ë¯¼ " + (bP.ivSpd||0) + ")\n\n";
  log += (aTurn ? (aName + "ì˜ ì„ ê³µ!\n\n") : (bName + "ì˜ ì„ ê³µ!\n\n"));

  var turn = 1;
  var MAX_SAFE_TURNS = 200;
  var LOG_TURN_LIMIT = 14;
  var skipped = false;
  var aCrisisShown = false; var bCrisisShown = false;

  while (aHP > 0 && bHP > 0 && turn <= MAX_SAFE_TURNS) {
    var attackerName = aTurn ? aName : bName;
    var defenderName = aTurn ? bName : aName;
    
    // ê°ì²´ í†µì§¸ë¡œ ì „ë‹¬ ì¤€ë¹„
    var attDb = aTurn ? aDb : bDb;
    var defDb = aTurn ? bDb : aDb;
    var attP_curr = aTurn ? aP : bP;
    var defP_curr = aTurn ? bP : aP;
    var attLv = aTurn ? aTLv : bTLv;
    var defLv = aTurn ? bTLv : aTLv;

    // [ì¤‘ìš”] calcHitì— 'ê°ì²´'ë¥¼ ë„˜ê¹ë‹ˆë‹¤!
    var hit = calcHit(attDb, attP_curr, defDb, defP_curr, attLv, defLv);
    var doLog = (turn <= LOG_TURN_LIMIT);

    if (hit.dodged) {
      if (doLog) log += turn + "í„´) " + attackerName + " ê³µê²©! â†’ " + defenderName + " " + funnyDodgeText() + "\n\n";
    } else {
      var finalDmg = hit.dmg;
      // í¬ê·€ë„ ë³´ì •
      var mod = getRarityBattleModifier(attDb, turn); 
      finalDmg = Math.floor(finalDmg * mod.atk);
      if(defDb.rarity) {
          var dmod = getRarityBattleModifier(defDb, turn);
          finalDmg = Math.floor(finalDmg * dmod.def);
      }
      finalDmg = Math.max(1, finalDmg);
      
      // NaN ë°©ì§€
      if (isNaN(finalDmg)) finalDmg = 1;

      if (aTurn) bHP -= finalDmg; else aHP -= finalDmg;

      if (doLog) {
        log += turn + "í„´) " + attackerName + " ê³µê²©! â†’ " + defenderName + " -" + finalDmg;
        if (hit.crit) log += " ğŸ’¥ê¸‰ì†Œ!";
        if (hit.guarded) log += " ğŸ›¡ï¸ë°©ì–´";
        log += "\n";
        var eff = typeEffectText(hit.mult);
        if (eff) log += eff + "\n";
        log += "HP: " + aName + " " + Math.max(0, aHP) + " vs " + bName + " " + Math.max(0, bHP) + "\n\n";
      } else if (!skipped) {
        skipped = true;
        log += "...\n(ìƒëµ)\n...\n\n";
      }
    }
    
    // ìœ„ê¸° ì—°ì¶œ
    if (doLog) {
      if (!aCrisisShown && aHP > 0 && aHP <= aMax * 0.2) { log += crisisText(aName) + "\n\n"; aCrisisShown = true; }
      if (!bCrisisShown && bHP > 0 && bHP <= bMax * 0.2) { log += crisisText(bName) + "\n\n"; bCrisisShown = true; }
    }

    aTurn = !aTurn;
    turn++;
  }

  var winner = "draw";
  if (aHP <= 0 && bHP <= 0) winner = "draw";
  else if (bHP <= 0) winner = "A";
  else if (aHP <= 0) winner = "B";
  else {
    if (aHP > bHP) winner = "A"; else if (bHP > aHP) winner = "B";
  }

  var resultLine = (winner === "A") ? ("ê²°ê³¼: " + aName + " ìŠ¹ë¦¬!") : (winner === "B") ? ("ê²°ê³¼: " + bName + " ìŠ¹ë¦¬!") : "ê²°ê³¼: ë¬´ìŠ¹ë¶€!";
  return { winner: winner, log: log, resultLine: resultLine };
}

function battleRewardLine(gold, exp) {
  return "ğŸ ë³´ìƒ: +" + gold + "ğŸ’° / +" + exp + "EXP";
}
function battleMyPickLine(myUid, db, enh) {
  var e = enhLabel(enh);
  var pName = db ? db.name : "?";
  return "ë‚´ í¬ì¼“ëª¬: #" + myUid + " " + pName + (e ? (" " + e) : "");
}
function battleOppPickLine(oppName, oppUid, db, enh) {
  var e = enhLabel(enh);
  var pName = db ? db.name : "?";
  return oppName + "ì˜ í¬ì¼“ëª¬: #" + oppUid + " " + pName + (e ? (" " + e) : "");
}

// âœ… ë°°í‹€ ì°¸ê°€ ê°€ëŠ¥ í¬ì¼“ëª¬ í•„í„° (í•„ìˆ˜)
function getBattleEligiblePokemons(u) {
  if (!u) return [];

  // u.pokemons í˜•íƒœê°€ ë°°ì—´/ê°ì²´ ë‘˜ ë‹¤ì¼ ìˆ˜ ìˆì–´ì„œ ì•ˆì „ ì²˜ë¦¬
  var p = u.pokemons;
  if (!p) return [];

  var arr = [];
  if (Array.isArray(p)) {
    arr = p;
  } else if (typeof p === "object") {
    for (var k in p) {
      if (p.hasOwnProperty(k)) arr.push(p[k]);
    }
  }

  var out = [];
  for (var i = 0; i < arr.length; i++) {
    var pp = arr[i];
    if (!pp) continue;
    if ((pp.enh || 0) >= BATTLE_MIN_ENH) out.push(pp);
  }
  return out;
}

// [ìˆ˜ì •ë¨] ë“±ê¸‰/IVê°€ ë°˜ì˜ëœ ë°°í‹€ ì‹¤í–‰ í•¨ìˆ˜
function runSingleBattle(d, room, sender, u, myPickUid, opt) {
  ensureUserStats(u);
  opt = opt || {};
  var isChain = !!opt.isChain; // ì—°ì†ë°°í‹€ ì—¬ë¶€
  var mult = (opt.rewardMult != null) ? opt.rewardMult : 1.0;
  var affectRecord = !isChain;

  // 1. [ì•ˆì „ì¥ì¹˜] ë‚´ í¬ì¼“ëª¬ ë“±ê¸‰ ì—†ìœ¼ë©´ ì¦‰ì‹œ ìƒì„± (Sê¸‰ ë°˜ì˜ ìœ„í•´ í•„ìˆ˜)
  if (ensurePokemonGrades(u)) saveData(d);

  var myEligible = getBattleEligiblePokemons(u);
  if (myEligible.length === 0) {
    return { ok: false, msg: "ë°°í‹€ ì°¸ê°€ ì¡°ê±´: " + BATTLE_MIN_ENH + "ê°• ì´ìƒ í¬ì¼“ëª¬ì´ í•„ìš”í•©ë‹ˆë‹¤." };
  }

  var oppList = getEligibleOpponents(d, room, sender);
  if (oppList.length === 0) {
    return { ok: false, msg: "ë°°í‹€ ê°€ëŠ¥í•œ ìƒëŒ€ê°€ ì—†ìŠµë‹ˆë‹¤." };
  }

  var oppName = randomPick(oppList);
  var opp = d.users[oppName];
  normalizeUserData(opp);
  ensureUserStats(opp);

  // 2. [ì•ˆì „ì¥ì¹˜] ìƒëŒ€ë°©ë„ ë“±ê¸‰ ì—†ìœ¼ë©´ ì¦‰ì‹œ ìƒì„± (ê·¸ë˜ì•¼ ê³µí‰í•¨)
  if (ensurePokemonGrades(opp)) saveData(d);

  var myP = null;
  if (myPickUid != null) {
    myP = findUserPokemonByUid(u, myPickUid);
    if (!myP || (myP.enh || 0) < BATTLE_MIN_ENH) {
      return { ok: false, msg: "í•´ë‹¹ í¬ì¼“ëª¬ì€ ë°°í‹€ì— ì°¸ê°€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤." };
    }
  } else {
    myP = randomPick(myEligible);
  }

  var oppEligible = getBattleEligiblePokemons(opp);
  if (oppEligible.length === 0) return { ok: false, msg: "ìƒëŒ€ë°©ì—ê²Œ ë°°í‹€ ê°€ëŠ¥í•œ í¬ì¼“ëª¬ì´ ì—†ìŠµë‹ˆë‹¤." };
  var opP = randomPick(oppEligible);

  var myDb = findPokemonDB(myP.pid);
  var opDb = findPokemonDB(opP.pid);
  if (!myDb || !opDb) return { ok: false, msg: "DB ì˜¤ë¥˜" };

  // 3. [í•µì‹¬ ìˆ˜ì •] ê°ì²´ë¥¼ í†µì§¸ë¡œ ë„˜ê²¨ì„œ Sê¸‰ ì„±ëŠ¥ì„ ì œëŒ€ë¡œ ë°˜ì˜í•¨!
  var sim = simulateBattleLog(
    sender, myDb, myP, u.trainerLv,
    oppName, opDb, opP, opp.trainerLv
  );

  var result = 0; 
  if (sim.winner === "A") result = 1; else if (sim.winner === "B") result = -1;

  var goldGain = 0; var expGain = 0; var extraLines = "";

  if (result === 1) {
    if (affectRecord) {
      u.stats.battleWin++; u.stats.battleStreak++;
      u.stats.bestStreak = Math.max(u.stats.bestStreak, u.stats.battleStreak);
      if (u.stats.battleStreak % STREAK_GOLD_BONUS_EVERY === 0) { u.gold += STREAK_GOLD_BONUS; extraLines += "ì—°ìŠ¹ ë³´ë„ˆìŠ¤! +" + STREAK_GOLD_BONUS + "ğŸ’°\n"; }
      if (u.stats.battleStreak % STREAK_EXP_BONUS_EVERY === 0) { addExpWithLevelUpMsg(u, STREAK_EXP_BONUS); extraLines += "ì—°ìŠ¹ ë³´ë„ˆìŠ¤! +" + STREAK_EXP_BONUS + "EXP\n"; }
    }
    goldGain = BATTLE_GOLD_WIN; expGain = BATTLE_EXP_WIN;
  } else if (result === -1) {
    if (affectRecord) { u.stats.battleLose++; u.stats.battleStreak = 0; }
    goldGain = BATTLE_GOLD_LOSE; expGain = BATTLE_EXP_LOSE;
  } else {
    if (affectRecord) { u.stats.battleDraw++; if (u.stats.battleStreak > 0) { u.stats.battleStreak = 0; extraLines += pick(STREAK_RESET_DRAW_LINES) + "\n"; } }
  }

  goldGain = Math.floor(goldGain * mult); expGain = Math.floor(expGain * mult);
  if (goldGain > 0) u.gold += goldGain;
  if (expGain > 0) { var lvMsg = addExpWithLevelUpMsg(u, expGain); if(lvMsg) extraLines += lvMsg + "\n"; }

  var header = blockTitle("ë°°í‹€ ê²°ê³¼");
  header += battleMyPickLine(myP.uid, myDb, myP.enh) + "\n";
  header += battleOppPickLine(oppName, opP.uid, opDb, opP.enh) + "\n\n";

  var resultLine = (result === 1) ? ("ğŸ† ìŠ¹ë¦¬: " + sender + "\n") : (result === -1) ? ("ğŸ’€ íŒ¨ë°°: " + sender + "\n") : ("ğŸ¤ ë¬´ìŠ¹ë¶€\n");
  var rewardLine = (goldGain > 0) ? (battleRewardLine(goldGain, expGain) + "\n") : "";
  
  var summary = header + resultLine + rewardLine + (extraLines ? ("\n" + extraLines) : "") + "\nì „ì²´ë³´ê¸°ë¡œ ë°°í‹€ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.";
  var full = "\n\n[ë°°í‹€ ë¡œê·¸]\n\n" + sim.log + sim.resultLine + "\n";

  return { ok: true, result: result, summary: summary, full: full, myPick: myP, oppPick: opP };
}


function pickLine(summary, prefix) {
  var lines = String(summary || "").split("\n");
  for (var i = 0; i < lines.length; i++) {
    if (lines[i].indexOf(prefix) === 0) 
      return lines[i];
  }
  return "";
}
function extractOppShortFromFull(full, sender) {
  if (!full) 
    return null;
  var lines = String(full).split(/\r?\n/);
  var players = [];
  for (var i = 0; i < lines.length; i++) {
    var line = lines[i].trim();
    // ì˜ˆ: "Moon: ë®¤ì¸  29ê°• (HP 1200)"
    var m = line.match(/^([^:]{1,30}):\s*(.+)$/);
    if (!m) 
      continue;
    var name = m[1].trim();
    var rest = m[2].trim();
    // í”Œë ˆì´ì–´ ë¼ì¸ë§Œ ì¡ê¸° (HPê°€ ìˆëŠ” ì¤„)
    if (rest.indexOf("(HP") === -1) 
      continue;
    players.push({
  name: name, 
  rest: rest});
    if (players.length >= 2) 
      break;
  }
  if (players.length < 2) 
    return null;
  var opp = (players[0].name === sender) ? players[1] : players[0];
  // "(HP ...)" ì œê±°í•´ì„œ ì§§ê²Œ
  var pokePart = opp.rest.split("(HP")[0].trim();
  // ê²°ê³¼ ì˜ˆ: "Moon ë®¤ì¸  29ê°•"
  return opp.name + " " + pokePart;
}
function parseRewardLine(summary) {
  // ì˜ˆ: "ğŸ ë³´ìƒ: +40ğŸ’° / +30EXP"
  var line = pickLine(summary, "ğŸ ë³´ìƒ:");
  var out = {
  gold: 0, 
  exp: 0, 
  raw: line};
  if (!line) 
    return out;
  var mGold = line.match(/\+(\d+)\s*ğŸ’°/);
  var mExp = line.match(/\+(\d+)\s*EXP/);
  if (mGold) 
    out.gold = parseInt(mGold[1], 10) || 0;
  if (mExp) 
    out.exp = parseInt(mExp[1], 10) || 0;
  return out;
}

// -------------------- í¬ê·€ë„/í„´ ê¸°ë°˜ ë°°í‹€ ë³´ì • --------------------
// rarity 5: ì´ˆë°˜ ê°•í•¨ (1~4í„´)
// rarity 4: í›„ë°˜ ê°•í•¨ (8í„´ ì´í›„)

function getRarityBattleModifier(db, turn, hpRate) {
  // ê¸°ë³¸ê°’
  var atkMul = 1.0;
  var defMul = 1.0;

  if (!db || !db.rarity) {
    return { atk: atkMul, def: defMul };
  }

  // â­ rarity 5 (ì „ì„¤) : ì´ˆë°˜ í­ë”œ
  if (db.rarity === 5) {
    if (turn <= 4) {
      atkMul = 1.18;   // ì´ˆë°˜ ê°•ë ¥
    }
    // ì „ì„¤ì€ ë°©ì–´ ë³´ì • ì—†ìŒ (ìœ ë¦¬í•œ êµ¬ê°„ì´ ì§§ìŒ)
  }

  // â­ rarity 4 (ìµœì¢…ì§„í™”) : í›„ë°˜ íƒ±ë”œ
  if (db.rarity === 4) {
    if (turn >= 8) {
      atkMul = 1.15;   // í›„ë°˜ í™”ë ¥ ìƒìŠ¹
      defMul = 0.88;   // ë°›ëŠ” ë°ë¯¸ì§€ ê°ì†Œ (íƒ±í‚¹)
    }
  }

  return { atk: atkMul, def: defMul };
}

// -------------------- ì—°ì†ë°°í‹€ ë³´ìƒ ë°°ìœ¨ --------------------
function chainRewardMult(i) {
  // i = 1ë¶€í„° ì‹œì‘
  // 1íŒ 100%, 2íŒ 70%, 3íŒ 50%, 4íŒ 40%, 5íŒ 30%
  var table = [1.0, 0.7, 0.5, 0.4, 0.3];
  if (i <= 0) 
    return 0;
  if (i <= table.length) 
    return table[i - 1];
  return 0.25;
}
function applyMult(n, mult) {
  return Math.max(0, Math.floor((n || 0) * (mult || 0)));
}
/* =========================
   ê°•í™” ë©˜íŠ¸ ì„¸íŠ¸ (ì™„í™” ë²„ì „)
========================= */

// ---------- ìƒìŠ¹ ----------
var ENH_UP_EASY = ["í›ˆë ¨ íš¨ê³¼ê°€ ë°”ë¡œ ë‚˜íƒ€ë‚¬ì–´ìš”.", "ëª¸ë†€ë¦¼ì´ í•œê²° ê°€ë²¼ì›Œì¡ŒìŠµë‹ˆë‹¤.", "í¬ì¼“ëª¬ì´ ì¦ê²ê²Œ ì„±ì¥í•˜ê³  ìˆì–´ìš”."];
var ENH_UP_MID = ["í›ˆë ¨ì´ ì‰½ì§„ ì•Šì•˜ì§€ë§Œ ì„±ê³¼ê°€ ìˆì—ˆì–´ìš”.", "í¬ì¼“ëª¬ì´ ì´ë¥¼ ì•…ë¬¼ê³  ë²„í…¨ëƒˆìŠµë‹ˆë‹¤.", "ì„±ì¥ì´ ëˆˆì— ë„ê²Œ ëŠê»´ì§‘ë‹ˆë‹¤."];
var ENH_UP_HARD = ["âš¡ ì ì¬ë ¥ì´ í¬ê²Œ ìê·¹ë°›ì•˜ìŠµë‹ˆë‹¤!", "ğŸ”¥ í•œê³„ë¥¼ ë„˜ëŠ” ì„±ì¥ì…ë‹ˆë‹¤!", "âœ¨ ìƒˆë¡œìš´ ê²½ì§€ì— í•œ ë°œ ë‹¤ê°€ì„°ì–´ìš”."];
// ---------- ìœ ì§€ ----------
var ENH_KEEP_EASY = ["í° ë³€í™”ëŠ” ì—†ì—ˆì§€ë§Œ ì•ˆì •ì ì´ì—ˆì–´ìš”.", "ì˜¤ëŠ˜ì€ ì»¨ë””ì…˜ ì ê²€ ì •ë„ë¡œ ì¶©ë¶„í•©ë‹ˆë‹¤.", "ë¬´ë¦¬í•˜ì§€ ì•ŠëŠ” ê²ƒë„ ì„±ì¥ì˜ ì¼ë¶€ì˜ˆìš”."];
var ENH_KEEP_MID = ["ê°„ì‹ íˆ ê· í˜•ì„ ìœ ì§€í–ˆìŠµë‹ˆë‹¤.", "ì„±ì¥ì€ ë©ˆì·„ì§€ë§Œ ë¬´ë„ˆì§€ì§„ ì•Šì•˜ì–´ìš”.", "ì§€ê¸ˆ ë‹¨ê³„ì—ì„  ì´ê²ƒë„ ë‚˜ì˜ì§€ ì•Šì•„ìš”."];
var ENH_KEEP_HARD = ["âš ï¸ ë§¤ìš° ì•„ìŠ¬ì•„ìŠ¬í•œ í›ˆë ¨ì´ì—ˆì–´ìš”.", "ğŸ”¥ í•œê³„ì—ì„œ ê°„ì‹ íˆ ë²„í…¨ëƒˆìŠµë‹ˆë‹¤.", "ì¡°ê¸ˆë§Œ ë” ë°€ì—ˆìœ¼ë©´ ìœ„í—˜í–ˆì„ì§€ë„ ëª°ë¼ìš”."];
// ---------- í•˜ë½ ----------
var ENH_DOWN_EASY = ["í›ˆë ¨ ê°•ë„ê°€ ì¡°ê¸ˆ ê³¼í–ˆë‚˜ ë´…ë‹ˆë‹¤.", "ì»¨ë””ì…˜ ì¡°ì ˆì´ í•„ìš”í•´ ë³´ì—¬ìš”.", "ì ì‹œ ì‰¬ì–´ê°€ëŠ” ê²Œ ì¢‹ê² ìŠµë‹ˆë‹¤."];
var ENH_DOWN_MID = ["í›ˆë ¨ ë¶€ë‹´ì´ ê·¸ëŒ€ë¡œ ë“œëŸ¬ë‚¬ìŠµë‹ˆë‹¤.", "í¬ì¼“ëª¬ì´ ë²„í‹°ê¸° í˜ë“¤ì–´í–ˆì–´ìš”.", "ì§€ê¸ˆ ë‹¨ê³„ì—ì„  ë¬´ë¦¬ì˜€ë˜ ê²ƒ ê°™ì•„ìš”."];
var ENH_DOWN_HARD = ["ğŸ’¢ í•œê³„ì— í¬ê²Œ ë¶€ë”ªí˜”ìŠµë‹ˆë‹¤.", "ğŸ”¥ ìœ„í—˜í•œ í›ˆë ¨ì´ì—ˆì–´ìš”.", "âš ï¸ ìƒíƒœê°€ ëˆˆì— ë„ê²Œ ë‚˜ë¹ ì¡ŒìŠµë‹ˆë‹¤."];
// ---------- ì´íƒˆ (ì™„í™”ëœ ì‚¬ë§) ----------
var ENH_EXIT_LINES = ["í¬ì¼“ëª¬ì´ í›ˆë ¨ì„ ë” ì´ìƒ ì´ì–´ê°€ê¸° í˜ë“  ìƒíƒœì…ë‹ˆë‹¤.", "í° ë¶€ë‹´ì´ ëˆ„ì ë˜ì–´ í›ˆë ¨ì—ì„œ ì´íƒˆí–ˆìŠµë‹ˆë‹¤.", "ì§€ê¸ˆì€ íœ´ì‹ê³¼ íšŒë³µì´ í•„ìš”í•œ ìƒíƒœì˜ˆìš”.", "ë¬´ë¦¬í•œ í›ˆë ¨ìœ¼ë¡œ ë” ì´ìƒ ë™í–‰í•  ìˆ˜ ì—†ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤."];

// -------------------- ê°•í™” ê²°ê³¼ ë©˜íŠ¸ ë¹Œë” --------------------
function buildEnhResultMsg(sender, pName, before, after, resultType) {
  var tier = getEnhTier(before);
  var line = "";
  if (resultType === ENH_RESULT_UP) {
    if (tier === "EASY") 
      line = pick(ENH_UP_EASY);
    else if (tier === "MID") 
      line = pick(ENH_UP_MID);
    else 
      line = pick(ENH_UP_HARD);
  } else if (resultType === ENH_RESULT_KEEP) {
    if (tier === "EASY") 
      line = pick(ENH_KEEP_EASY);
    else if (tier === "MID") 
      line = pick(ENH_KEEP_MID);
    else 
      line = pick(ENH_KEEP_HARD);
  } else if (resultType === ENH_RESULT_DOWN) {
    if (tier === "EASY") 
      line = pick(ENH_DOWN_EASY);
    else if (tier === "MID") 
      line = pick(ENH_DOWN_MID);
    else 
      line = pick(ENH_DOWN_HARD);
  } else if (resultType === ENH_RESULT_EXIT) {
    line = pick(ENH_EXIT_LINES);
  }
  var afterLabel = (resultType === ENH_RESULT_EXIT) ? "ì´íƒˆ" : enhLabelAlways(after);
  var header = "ğŸ¾ " + sayDo(sender, pName + " í›ˆë ¨ ê²°ê³¼") + "\n" + "ğŸ“Š ê°•í™” ë‹¨ê³„: " + enhLabelAlways(before) + " â†’ " + afterLabel + "\n\n";
  return header + line;
}
function pct(x) {
  return Math.floor(x * 1000) / 10;
}
function clamp01(x) {
  return Math.max(0, Math.min(1, x));
}
// nextEnh: ì´ë²ˆ ì‹œë„ë¡œ ë„ë‹¬í•˜ë ¤ëŠ” ê°•í™” ë‹¨ê³„(1~30)
function enhanceRatesByRarity(nextEnh, trainerLv, rarity) {
  nextEnh = parseInt(nextEnh, 10);
  if (isNaN(nextEnh)) 
    nextEnh = 1;
  if (nextEnh < 1) 
    nextEnh = 1;
  if (nextEnh > ENHANCE_MAX) 
    nextEnh = ENHANCE_MAX;
  var curEnh = nextEnh - 1;  // í˜„ì¬ ê°•í™”(0~29)
  // ìš”êµ¬ì‚¬í•­ êµ¬ê°„ (min~max)
  var min = 0.90, max = 1.00;  // 0~5ê°•
  if (curEnh >= 5 && curEnh < 10) {
    min = 0.70;
    max = 0.80;
  } else if (curEnh >= 10 && curEnh < 15) {
    min = 0.50;
    max = 0.60;
  } else if (curEnh >= 15 && curEnh < 20) {
    min = 0.30;
    max = 0.40;
  } else if (curEnh >= 20 && curEnh < 25) {
    min = 0.20;
    max = 0.30;
  } else if (curEnh >= 25) {
    min = 0.05;
    max = 0.10;
  }
  var segStart = 0;
  if (curEnh >= 5 && curEnh < 10) 
    segStart = 5;
  else if (curEnh >= 10 && curEnh < 15) 
    segStart = 10;
  else if (curEnh >= 15 && curEnh < 20) 
    segStart = 15;
  else if (curEnh >= 20 && curEnh < 25) 
    segStart = 20;
  else if (curEnh >= 25) 
    segStart = 25;
  var t = clamp01((curEnh - segStart) / 5);  // 0~1
  var base = max - (max - min) * t;
  // ë ˆë²¨ ë³´ì •(ìµœëŒ€ +8%)
  var lv = trainerLv || 1;
  var bonus = (lv - 1) * 0.001;
  if (bonus > 0.08) 
    bonus = 0.08;
  var success = base + bonus;

  if (success > max) 
    success = max;
  if (success < min) 
    success = min;

  // =========================
  // âœ… ì„±ê³µ í™•ë¥  "ë¯¸ì„¸" í•˜í–¥ (ì²´ê° ì•½í•˜ê²Œ)
  // - 15ê°•ë¶€í„° ì•„ì£¼ ì‚´ì§
  // - 20ê°•ë¶€í„° ì¡°ê¸ˆ ë”
  // - 25ê°•ë¶€í„° ì¶”ê°€ë¡œ ì‚´ì§
  // =========================
  if (curEnh >= 15) success -= 0.005; // -0.5%
  if (curEnh >= 20) success -= 0.010; // ì¶”ê°€ -1.0% (ëˆ„ì  -1.5%)
  if (curEnh >= 25) success -= 0.010; // ì¶”ê°€ -1.0% (ëˆ„ì  -2.5%)

  // rarity 5 ì™„ì¶© (25ê°• ì´ìƒë§Œ ì•½ê°„ ë³µêµ¬)
  if (rarity === 5 && curEnh >= 25) success += 0.005;

  // ìµœì¢… ì•ˆì „ ë³´ì •
  success = clamp01(success);
  return {
  success: success, 
  keep: 1 - success, 
  death: 0};
}
function buildNextEnhInfoLine(p, resultType, u) {
  if (resultType === ENH_RESULT_EXIT) {
    return "\n\nğŸ“Œ ë‹¤ë¥¸ í¬ì¼“ëª¬ì„ ê°•í™”í•˜ë ¤ë©´ /ë‚´í¬ì¼“ëª¬ ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.";
  }
  if (!p) return "";

  var dbx = findPokemonDB(p.pid);
  var rr = dbx ? dbx.rarity : 2;

  // âœ… ë‹¤ìŒ ì‹œë„ëŠ” (í˜„ì¬ ê°•í™” + 1)ì„ ëª©í‘œë¡œ í•¨
  var nextEnh = Math.min(ENHANCE_MAX, (p.enh || 0) + 1);

  // ê¸°ì¡´: var rates = enhanceRatesByRarity(p.enh, (u ? u.trainerLv : 1), rr);
  var rates = enhanceRatesByRarity(nextEnh, (u ? u.trainerLv : 1), rr);

  // ê¸°ì¡´: var nextCost = enhanceCostByRarity(p.enh, rr);
  var nextCost = enhanceCostByRarity(nextEnh, rr);

  var myGold = (u && typeof u.gold === "number") ? u.gold : null;

  var out = "";
out += "\n\ní˜„ì¬ ë³´ìœ  ê³¨ë“œ : " + (myGold === null ? "-" : (fmtNum(myGold) + "ğŸ’°")) + "\n";
out += "ë‹¤ìŒ ê°•í™” ì„±ê³µ í™•ë¥  : " + pct(rates.success) + "%\n";
out += "ë‹¤ìŒ ê°•í™” í•„ìš” ê³¨ë“œ : " + fmtNum(nextCost) + "ğŸ’°";
return out;
}

// íƒí—˜ í¬ì¼“ëª¬ íšë“ í™•ë¥  (ë ˆë²¨ ê¸°ë°˜)
function getExplorePokemonChance(trainerLv) {
  var base = 0.03;  // ê¸°ë³¸ 3%
  var perLv = 0.002;  // ë ˆë²¨ë‹¹ +0.2%
  var max = 0.15;  // ìµœëŒ€ 15%
  var chance = base + (trainerLv * perLv);
  if (chance > max) 
    chance = max;
  if (chance < 0) 
    chance = 0;
  return chance;
}
function cooldownRemainMsg(sender, lastAt, cooldownMs, actionName) {
  var now = nowMs();
  var remainMs = cooldownMs - (now - lastAt);
  if (remainMs < 0) 
    remainMs = 0;
  var sec = Math.ceil(remainMs / 1000);
  return sender + "ë‹˜, " + sec + "ì´ˆ í›„ ë‹¤ì‹œ " + actionName + "í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
}
// -------------------- ëœë¤ ë©˜íŠ¸ ì„¸íŠ¸ --------------------
function pick(arr) {
  return arr[Math.floor(Math.random() * arr.length)];
}
// í•„ë“œ íƒìƒ‰/ì¡°ìš° ë©˜íŠ¸
var FIELD_SEARCH_LINES = ["ì£¼ë³€ì„ ë‘ë¦¬ë²ˆê±°ë ¸ì–´ìš”.", "í’€ìˆ²ì„ í—¤ì§‘ê³  ë“¤ì–´ê°”ì–´ìš”.", "ë°œì†Œë¦¬ë¥¼ ì£½ì´ê³  ì‚´ê¸ˆì‚´ê¸ˆ ë‹¤ê°€ê°”ì–´ìš”.", "ë­”ê°€ ìˆ˜ìƒí•œ ê¸°ìš´ì´ ëŠê»´ì ¸ìš”â€¦", "ì´ë²ˆì—” ë­”ê°€ ë‚˜ì˜¬ ê²ƒ ê°™ì€ë°ìš”?"];
var FIELD_ENCOUNTER_LINES = ["ì™€! ê°‘ìê¸° íŠ€ì–´ë‚˜ì™”ì–´ìš”!", "ëˆˆì´ ë§ˆì£¼ì³¤ì–´ìš”â€¦!", "ê¸°ì²™ì„ ëŠë¼ê³  ë‚˜íƒ€ë‚¬ì–´ìš”!", "ì‚¬ë‚©ê²Œ ìš¸ë¶€ì§–ìœ¼ë©° ë‹¤ê°€ì™€ìš”!", "ê°€ë§Œíˆ ìˆë‹¤ê°€ ìŠ¬ì© ëª¨ìŠµì„ ë“œëŸ¬ëƒˆì–´ìš”!"];
// í¬íš ì„±ê³µ/ì‹¤íŒ¨ ë“œë¦½
var CATCH_SUCCESS_LINES = ["ë”¸ê¹! ì™„ë²½í–ˆì–´ìš”.", "ì˜¤ì¼€ì´! ì†ë§› ì œëŒ€ë¡œë„¤ìš”.", "ë“¤ì–´ê°”ë‹¤! ì¡ì•˜ë‹¤!", "ê¹”ë”í•˜ê²Œ í¬íš ì„±ê³µ!", "ì˜¤ëŠ˜ ìš´ ì¢‹ì€ë°ìš”?"];
var CATCH_FAIL_LINES = ["ì•—! íŠ€ì–´ë‚˜ì™”ì–´ìš”â€¦", "ì•„ê¹ë‹¤â€¦ ì†ëì—ì„œ ë¹ ì ¸ë‚˜ê°”ì–´ìš”.", "ë°©ê¸ˆ ì¡ì€ ì¤„ ì•Œì•˜ëŠ”ë°!", "êµ¬ë¥´ë‹¤ê°€ íˆ­! íƒˆì¶œí–ˆì–´ìš”.", "ì´ê±´â€¦ ì¢€ ì–µìš¸í•œë°ìš”?"];
var CATCH_TRY_AGAIN_LINES = ["ë‹¤ì‹œ í•œ ë²ˆë§Œ ë”!", "ì´ë²ˆì—” ì§„ì§œ ì¡ì•„ë³´ì.", "ë³¼ë§Œ ë” ìˆìœ¼ë©´ ëœë‹¤â€¦", "ë‹¤ìŒì—” ë” ê°•í•œ ë³¼ë¡œ ê°€ì.", "ì¹¨ì°©â€¦ ì¹¨ì°©â€¦"];
// ë°°í‹€ ìš”ì•½ í•´ì„¤ ë©˜íŠ¸
var BATTLE_COMMENT_WIN = ["ì˜¤ëŠ˜ ì»¨ë””ì…˜ ë¯¸ì³¤ë‹¤!", "ì™„ë²½í•œ ìš´ì˜ì´ì—ˆì–´ìš”.", "ìƒì„±/ê°•í™”/ê° ëª¨ë‘ ì¢‹ì•˜ë„¤ìš”.", "ìƒëŒ€ê°€ ë‹¹í™©í–ˆì„ ë“¯!", "ì´ ë§›ì— ë°°í‹€í•˜ì£ ."];
var BATTLE_COMMENT_LOSE = ["ì•„â€¦ ë‹¤ìŒì—” ë³µìˆ˜ì „ ê°‘ì‹œë‹¤.", "ìƒëŒ€ê°€ í•œ ìˆ˜ ìœ„ì˜€ì–´ìš”.", "ìš´ì´ ì‚´ì§ ì•ˆ ë”°ë¼ì¤¬ë„¤ìš”.", "ê´œì°®ì•„ìš”. ê²½í—˜ì¹˜ê°€ ìŒ“ì˜€ì–´ìš”.", "ë‹¤ìŒ íŒì—” ë’¤ì§‘ëŠ”ë‹¤."];
var BATTLE_COMMENT_DRAW = ["íŒ½íŒ½í–ˆë‹¤â€¦ ì§„ì§œ íŒ½íŒ½!", "ë‘˜ ë‹¤ í•œ ë— ì°¨ì´ì˜€ì–´ìš”.", "ìŠ¹ë¶€ê°€ ì•ˆ ë‚˜ë„¤â€¦ ë‹¤ì‹œ?", "ë¬´ìŠ¹ë¶€ë„ ë‚˜ì˜ì§€ ì•Šì£ .", "ì„œë¡œ ì¸ì •!"];
// ë¬´ìŠ¹ë¶€ streak ë¦¬ì…‹ ë¬¸êµ¬ (ë„¤ ì •ì±… ì“¸ ë•Œ)
var STREAK_RESET_DRAW_LINES = ["ë¬´ìŠ¹ë¶€ë¼ ì—°ìŠ¹ì€ ì—¬ê¸°ì„œ ì ê¹ ë©ˆì·„ì–´ìš”.", "ìŠ¹ë¶€ê°€ ì•ˆ ë‚¬ìœ¼ë‹ˆ ì—°ìŠ¹ì€ ë¦¬ì…‹!", "ë¬´ìŠ¹ë¶€! ì—°ìŠ¹ ê¸°ë¡ì€ ì ì‹œ ë³´ë¥˜!", "íŒ½íŒ½í–ˆì§€ë§Œâ€¦ ì—°ìŠ¹ì€ ì´ˆê¸°í™”!"];
function blockTitle(t) {
  return "ã€" + t + "ã€‘\n";
}
function joinLines(arr) {
  var out = "";
  for (var i = 0; i < arr.length; i++) 
    out += arr[i] + "\n";
  return out;
}
var EMPHASIS_RARE5 = ["âœ¨ í¬ê·€í•œ ê¸°ìš´ì´ ëŠê»´ì§‘ë‹ˆë‹¤â€¦", "âœ¨ ê³µê¸°ê°€ ë‹¬ë¼ì¡Œì–´ìš”â€¦ ë­”ê°€ ì˜¨ë‹¤!", "âœ¨ ë“±ê³¨ì´ ì„œëŠ˜í•´ì¡ŒìŠµë‹ˆë‹¤â€¦", "âœ¨ ì´ê±´â€¦ ì§„ì§œë‹¤."];
var EMPHASIS_LEGENDARY = ["ğŸ”¥ ì „ì„¤ê¸‰ í¬ì¼“ëª¬ ì¶œí˜„!", "ğŸ”¥ ë¶„ìœ„ê¸° ë¬´ì—‡â€¦ ì „ì„¤ ê°ì¸ë°ìš”?", "ğŸ”¥ ì´ê±´ ì¡ì•„ì•¼ í•©ë‹ˆë‹¤. ë¬´ì¡°ê±´.", "ğŸ”¥ ì‹¬ì¥ì´ ë›´ë‹¤â€¦ ì „ì„¤ì´ë‹¤!"];
var CATCH_FAIL_DRIP_LINES = ["ğŸ’¥ ì•„â€¦ ë°©ê¸ˆ ê·¸ê±° ì¡ì„ ë»”í–ˆëŠ”ë°!", "ğŸ˜µâ€ğŸ’« ì†ì´ ë¯¸ë„ëŸ¬ì¡Œì–´ìš”â€¦ ë‹¤ì‹œ!", "ğŸ˜¤ ì•„ë‹ˆ ì´ê²Œ ì™œ ì•ˆ ì¡í˜€â€¦?", "ğŸ¥² ë³¼ì´ ë°°ì‹ í–ˆì–´ìš”â€¦", "ğŸ«  ì§„ì§œ ë”± í•œ ë²ˆë§Œ ë”â€¦"];
var CATCH_FAIL_TIP_LINES = ["íŒíŠ¸: ë” ì¢‹ì€ ë³¼ì´ë©´ í™•ë¥ ì´ ì˜¬ë¼ê°€ìš”.", "íŒíŠ¸: íŠ¸ë ˆì´ë„ˆ ë ˆë²¨ì´ ì˜¤ë¥´ë©´ í¬íš ë³´ë„ˆìŠ¤ë„ ì˜¬ë¼ê°€ìš”.", "íŒíŠ¸: ìŠˆí¼ë³¼/í•˜ì´í¼ë³¼ë¡œ ì••ë°•í•´ë´…ì‹œë‹¤.", "íŒíŠ¸: ìš´ë„ ì‹¤ë ¥ì…ë‹ˆë‹¤â€¦(ì•„ë§ˆë„)"];
var COOLDOWN_LINES = ["ì•„ì§ ìˆ¨ ì¢€ ëŒë¦¬ëŠ” ì¤‘ì´ì—ìš”. ì ì‹œë§Œìš”!", "ì ê¹ë§Œ! ì¬ì •ë¹„í•˜ê³  ë‹¤ì‹œ ê°€ìš”.", "ì¡°ê¸ˆë§Œ ê¸°ë‹¤ë¦¬ë©´ ë°”ë¡œ ë‹¤ì‹œ í•  ìˆ˜ ìˆì–´ìš”."];
function enhLabel(enh) {
  // 0ì´ë©´ í‘œê¸° ì•ˆ í•¨ (ë‚´í¬ì¼“ëª¬/ë°°í‹€ í‘œê¸°ìš©)
  return (enh > 0) ? (enh + "ê°•") : "";
}
function enhLabelAlways(enh) {
  // 0ë„ í‘œê¸° (ê°•í™” ê²°ê³¼ â€œ0ê°• â†’ 1ê°•â€ ê°™ì€ í‘œê¸°ìš©)
  return (enh + "ê°•");
}
function ensureUserDex(u) {
  if (!u.dex) 
    u.dex = {};
  for (var k in u.dex) {
    if (u.dex.hasOwnProperty(k)) {
      if (typeof u.dex[k] === "number") {
        u.dex[k] = {
  seen: 0, 
  caught: u.dex[k]};
      }
    }
  }
  // ë§ˆì´ê·¸ë ˆì´ì…˜: í˜„ì¬ ë³´ìœ  í¬ì¼“ëª¬ì€ ìµœì†Œ caught 1ë¡œ ë‚¨ê²¨ì¤Œ
  if (u.pokemons && u.pokemons.length > 0) {
    for (var i = 0; i < u.pokemons.length; i++) {
      var p = u.pokemons[i];
      if (!p || p.pid == null) 
        continue;
      var pid = String(p.pid);
      if (!u.dex[pid]) 
        u.dex[pid] = {
  seen: 0, 
  caught: 0};
      if (u.dex[pid].caught < 1) 
        u.dex[pid].caught = 1;
    }
  }
}
function dexSeen(u, pid) {
  ensureUserDex(u);
  pid = String(pid);
  if (!u.dex[pid]) 
    u.dex[pid] = {
  seen: 0, 
  caught: 0};
  u.dex[pid].seen += 1;
}
function dexCaught(u, pid, grade) {
  ensureUserDex(u);
  pid = String(pid);
  if (!u.dex[pid]) {
    u.dex[pid] = { seen: 0, caught: 0, maxGrade: "D" };
  }
  u.dex[pid].caught += 1;
  
  // í˜„ì¬ ì¡ì€ ë“±ê¸‰ì´ ê¸°ì¡´ ìµœê³  ë“±ê¸‰ë³´ë‹¤ ë†’ìœ¼ë©´ ê°±ì‹ 
  var curMax = u.dex[pid].maxGrade || "D";
  if (GRADE_ORDER[grade] > GRADE_ORDER[curMax]) {
    u.dex[pid].maxGrade = grade;
  }
}
function nextPokemonUid(u) {
  if (typeof u.nextPokeUid !== "number") 
    u.nextPokeUid = 1;
  var uid = u.nextPokeUid;
  u.nextPokeUid += 1;
  return uid;
}
function expNeed(lv) {
  var L = Math.max(1, Math.min(MAX_LV, lv));
  var x = L - 1;
  return 90 + 18 * x + 5 * x * x;
}
function onLevelUpReward(u) {
  u.ball += 2;
  u.gold += 180;
  if (u.trainerLv % 10 === 0 && u.trainerLv < 99) {
    u.superBall += 5;
    u.ultraBall += 2;
  }
  if (u.trainerLv === 99) {
    u.superBall += 10;
    u.ultraBall += 5;
  }
}
function addExpAndCheckLevelUp(u, expGained) {
  var leveled = false;
  u.trainerExp += expGained;
  while (u.trainerLv < MAX_LV && u.trainerExp >= expNeed(u.trainerLv)) {
    u.trainerExp -= expNeed(u.trainerLv);
    u.trainerLv += 1;
    leveled = true;
    onLevelUpReward(u);
  }
  return leveled;
}
// -------------------- ë ˆë²¨ì—… ë©”ì‹œì§€(ë³´ìƒ í¬í•¨) --------------------
function addExpWithLevelUpMsg(u, expGained) {
  var beforeLv = u.trainerLv;
  var bGold = u.gold;
  var bBall = u.ball;
  var bSuper = u.superBall;
  var bUltra = u.ultraBall;
  var leveled = addExpAndCheckLevelUp(u, expGained);
  if (!leveled) 
    return "";
  var gGold = u.gold - bGold;
  var gBall = u.ball - bBall;
  var gSuper = u.superBall - bSuper;
  var gUltra = u.ultraBall - bUltra;
  var line = "ğŸŠ ë ˆë²¨ì—…! Lv." + beforeLv + " â†’ Lv." + u.trainerLv;
  var rewards = [];
  if (gGold > 0) 
    rewards.push("+" + gGold + "ğŸ’°");
  if (gBall > 0) 
    rewards.push("+" + gBall + " ëª¬ìŠ¤í„°ë³¼");
  if (gSuper > 0) 
    rewards.push("+" + gSuper + " ìŠˆí¼ë³¼");
  if (gUltra > 0) 
    rewards.push("+" + gUltra + " í•˜ì´í¼ë³¼");
  if (rewards.length > 0) {
    line += "\nğŸ ë ˆë²¨ì—… ë³´ìƒ: " + rewards.join(" / ");
  }
  return line;
}
// -------------------- ìŠ¤í°/í¬ê·€ë„ ê°€ì¤‘ì¹˜ --------------------
// [ë°¸ëŸ°ìŠ¤ ìˆ˜ì •] í¬ê·€ë„ë³„ ì¶œí˜„ ê°€ì¤‘ì¹˜ ëŒ€í­ ìƒí–¥
function raritySpawnWeight(r) {
  if (r === 1) return 1.00; // í”í•¨: 100% í›„ë³´ ë“±ë¡
  if (r === 2) return 0.85; // (ê¸°ì¡´ 0.70)
  if (r === 3) return 0.60; // (ê¸°ì¡´ 0.35) -> ëŒ€í­ ìƒí–¥
  if (r === 4) return 0.30; // (ê¸°ì¡´ 0.12) -> ì•½ 2.5ë°° ìƒí–¥
  return 0.15;              // (ê¸°ì¡´ 0.04) -> ì „ì„¤ ì•½ 4ë°° ìƒí–¥ (ì´ì œ ëœ° ê²ë‹ˆë‹¤!)
}
function enhanceCost(nextEnh) {
  nextEnh = parseInt(nextEnh, 10);
  if (isNaN(nextEnh)) 
    nextEnh = 1;
  if (nextEnh < 1) 
    nextEnh = 1;
  if (nextEnh > ENHANCE_MAX) 
    nextEnh = ENHANCE_MAX;
  return 25 + Math.floor(nextEnh * nextEnh * 2.6);
}
function rarityCostMult(rarity) {
  // í¬ê·€ë„ 1ì€ ì‹¸ê³  5ëŠ” ë§¤ìš° ë¹„ì‹¸ê²Œ
  if (rarity <= 1) 
    return 1.0;
  if (rarity === 2) 
    return 1.4;
  if (rarity === 3) 
    return 1.9;
  if (rarity === 4) 
    return 2.6;
  return 3.6;
}
// ê¸°ì¡´ enhanceCost(enh)ëŠ” "ë² ì´ìŠ¤ ë¹„ìš©"ìœ¼ë¡œ ìœ ì§€í•˜ê³ ,
// ì‹¤ì œ ì°¨ê°ì—ëŠ” ì•„ë˜ í•¨ìˆ˜ ì‚¬ìš©
function enhanceCostByRarity(enh, rarity) {
  var base = enhanceCost(enh);
  var mult = rarityCostMult(rarity || 2);
  // ê³ ê°•í™” êµ¬ê°„ ì¶”ê°€ ê°€ì¤‘ì¹˜(ì „ì„¤ ê°€ì¹˜ ìƒìŠ¹ í•µì‹¬)
  // enh 15ë¶€í„° ì„œì„œíˆ, 20ë¶€í„° í™•ì‹¤íˆ ë¹„ì‹¸ì§€ê²Œ
  var extra = 1.0;
  if (enh >= 15) 
    extra += (enh - 14) * 0.03;  // 15->1.03, 20->1.18
  if (enh >= 20) 
    extra += (enh - 19) * 0.04;  // 20->+0.04, 25->+0.24
  return Math.floor(base * mult * extra);
}

// -------------------- íŒë§¤ê°€(í¬ê·€ë„ ì „ì²´ ê³µí†µ) --------------------
// ëª©í‘œ(ì°¸ê³ ): r4 ê¸°ì¤€ 20ê°•â‰ˆ8ë§Œ, 22ê°•â‰ˆ10ë§Œ, 25ê°•â‰ˆ20ë§Œ, 30ê°•â‰ˆ40ë§Œ+
function sellPrice(pid, enh) {
  var db = findPokemonDB(pid);
  if (!db) return 1;

  var r = db.rarity || 2;

  enh = parseInt(enh, 10);
  if (isNaN(enh) || enh < 0) enh = 0;
  if (enh > ENHANCE_MAX) enh = ENHANCE_MAX;

  // 1) í¬ê·€ë„ ë² ì´ìŠ¤ (ì €ê°•ë„ ê°€ì¹˜ ìœ ì§€)
  var baseByR = [0, 200, 500, 1400, 8000, 16000];
  var base = baseByR[r] || 500;

  // 2) 0~14ê°•: ì™„ë§Œ ì„±ì¥ (ì„ í˜• + ì•½í•œ ì œê³±)
  var e0 = Math.min(enh, 14);
  var lin = e0 * (40 + r * 18);
  var quad = (e0 * e0) * (6 + r * 3);

  // 3) 15~19ê°•: í”„ë¦¬ë¯¸ì—„ ì‹œì‘
  var premium15 = 0;
  if (enh >= 15) {
    var e15 = Math.min(enh, 19) - 14; // 1~5
    premium15 = e15 * (700 + r * 450);
  }

  // 4) 20~24ê°•: í™• íŠ
  var premium20 = 0;
  if (enh >= 20) {
    var e20 = Math.min(enh, 24) - 19; // 1~5
    premium20 = (e20 * e20) * (6000 + r * 2500);
  }

  // 5) 25~30ê°•: í­ë°œ
  var premium25 = 0;
  if (enh >= 25) {
    var e25 = enh - 24; // 1~6
    premium25 = (e25 * e25 * e25) * (12000 + r * 5000);
  }

  var price = Math.floor(base + lin + quad + premium15 + premium20 + premium25);

  // 6) í¬ê·€ë„ë³„ ìµœì†Œ ë³´ì¥
  var minByR = [0, 120, 300, 900, 6000, 12000];
  var minP = minByR[r] || 300;
  if (price < minP) price = minP;

  // 7) ê²½ì œ ë³´í˜¸ cap (í¬ê·€ë„ë³„)
  var cap = (r === 5) ? 1800000
          : (r === 4) ? 900000
          : (r === 3) ? 280000
          : (r === 2) ? 120000
          : 60000;

  if (price > cap) price = cap;

  return price;
}

function rarityCatchMod(rarity) {
  // í¬ê·€ë„ë³„ í¬íš ë‚œì´ë„ ê³„ìˆ˜ (ë‚®ì„ìˆ˜ë¡ ì–´ë ¤ì›€)
  // ì²´ê° ì°¨ì´ í¬ê²Œ ì„¤ê³„
  if (rarity <= 1) 
    return 1.40;
  if (rarity === 2) 
    return 1.15;
  if (rarity === 3) 
    return 0.85;
  if (rarity === 4) 
    return 0.55;
  return 0.32;
}
function trainerCatchBonus(lv) {
  lv = Math.max(1, Math.min(99, lv || 1));
  // 1ë ˆë²¨ 0% â†’ 50ë ˆë²¨ ì•½ +18% â†’ 99ë ˆë²¨ +30%
  return 0.30 * Math.sqrt((lv - 1) / 98);
}
function calcExploreGold(u) {
  var base = Math.floor(Math.random() * (EXPLORE_GOLD_MAX - EXPLORE_GOLD_MIN + 1) + EXPLORE_GOLD_MIN);
  var lv = Math.max(1, u.trainerLv || 1);
  var mult = 1 + lv * EXPLORE_LV_RATE;
  var gold = Math.floor(base * mult);
  // ì•ˆì „ ìº¡
  return Math.min(gold, EXPLORE_GOLD_CAP);
}
function calcExploreExp() {
  return Math.floor(Math.random() * (EXPLORE_EXP_MAX - EXPLORE_EXP_MIN + 1) + EXPLORE_EXP_MIN);
}
function clampInt(n, a, b) {
  n = Math.floor(n);
  return Math.max(a, Math.min(b, n));
}
function calcCatchGold(u, db, ballType) {
  var base = Math.floor(rnd(CATCH_GOLD_MIN, CATCH_GOLD_MAX + 1));
  var lv = Math.max(1, u.trainerLv || 1);
  var lvMult = 1 + (lv * 0.012);  // ë ˆë²¨ 50ì´ë©´ ì•½ +60%
  var rarity = (db && db.rarity) ? db.rarity : 2;
  var rarityMult = 1 + (rarity - 1) * 0.22;  // rarity 5ë©´ +88%
  var ballMult = (ballType === 2) ? 1.18 : (ballType === 1) ? 1.10 : 1.00;
  var gold = Math.floor(base * lvMult * rarityMult * ballMult);
  return clampInt(gold, 1, CATCH_GOLD_CAP);
}
function calcCatchExp(u, db, ballType) {
  var base = Math.floor(rnd(CATCH_EXP_MIN, CATCH_EXP_MAX + 1));
  var lv = Math.max(1, u.trainerLv || 1);
  var lvMult = 1 + (lv * 0.006);  // ê³¨ë“œë³´ë‹¨ ì™„ë§Œ
  var rarity = (db && db.rarity) ? db.rarity : 2;
  var rarityMult = 1 + (rarity - 1) * 0.16;
  var ballMult = (ballType === 2) ? 1.12 : (ballType === 1) ? 1.06 : 1.00;
  var exp = Math.floor(base * lvMult * rarityMult * ballMult);
  return clampInt(exp, 1, CATCH_EXP_CAP);
}
// -------------------- í¬íš ë‚œì´ë„ ê°œë³„ ë³´ì • --------------------
var CATCH_TIER_OVERRIDES = {
  131: 3.5, 
  143: 3.5, 
  144: 4.6, 
  145: 4.6, 
  146: 4.6, 
  150: 4.85, 
  151: 4.75, 
  133: 4.2, 
  134: 4.4, 
  135: 4.4, 
  136: 4.4};
// -------------------- ì§€ì—­/ìŠ¤í° í’€ --------------------
var REGIONS = [{
  key: "ì´ˆì›", 
  types: ["ë…¸ë§", "í’€", "ë²Œë ˆ", "ë¹„í–‰", "ë…"]}, {
  key: "í˜¸ìˆ˜", 
  types: ["ë¬¼", "ì–¼ìŒ"]}, {
  key: "ë™êµ´", 
  types: ["ë°”ìœ„", "ë•…", "ê³ ìŠ¤íŠ¸", "ë…"]}, {
  key: "ë°œì „ì†Œ", 
  types: ["ì „ê¸°", "ê°•ì² "]}, {
  key: "ìœ ì ", 
  types: ["ì—ìŠ¤í¼", "ê³ ìŠ¤íŠ¸", "ë“œë˜ê³¤"]}, {
  key: "ê²©íˆ¬ì¥", 
  types: ["ê²©íˆ¬"]}, {
  key: "ìš”ì •ìˆ²", 
  types: ["í˜ì–´ë¦¬", "í’€"]}, {
  key: "í™”ì‚°", 
  types: ["ë¶ˆ", "ë°”ìœ„", "ë•…"]}, {
  key: "ë°”ë‹¤", 
  types: ["ë¬¼", "ë¬¼", "ë¹„í–‰"]}, {
  key: "ì„¤ì‚°", 
  types: ["ì–¼ìŒ", "ì–¼ìŒ", "ë°”ìœ„"]}, {
  key: "í­í’í‰ì›", 
  types: ["ì „ê¸°", "ë¹„í–‰"]}, {
  key: "ì–´ë‘ ì˜ìˆ²", 
  types: ["ì•…", "ê³ ìŠ¤íŠ¸", "ë…"]}, {
  key: "ì‚¬ë§‰", 
  types: ["ë•…", "ë°”ìœ„", "ë…"]}, {
  key: "ì—°êµ¬ì†Œ", 
  types: ["ì—ìŠ¤í¼", "ê°•ì² ", "ë…¸ë§"]}, {
  key: "ìš©ì˜ë‘¥ì§€", 
  types: ["ë“œë˜ê³¤", "ë“œë˜ê³¤", "ë¶ˆ"]},
{ key: "ëƒ¥ì¹˜ì˜ ë°©", types: [] }
];
var REGION_ROTATE_MS = 60 * 60 * 1000;// (ì›í•˜ë©´ ë‚¨ê²¨ë„ ë˜ê³  ì•ˆ ì¨ë„ ë¨)
var SPAWN_EXPIRE_MS = 60 * 1000;
function getRoomRegion(d, room) {
  // ë°©/ì‹œê°„ ê³ ì • ì—†ì´ ë§¤ í˜¸ì¶œ ëœë¤
  return randomPick(REGIONS).key;
}
function regionTypes(regionKey) {
  for (var i = 0; i < REGIONS.length; i++) {
    if (REGIONS[i].key === regionKey) 
      return REGIONS[i].types;
  }
  return ["ë…¸ë§", "í’€", "ë²Œë ˆ", "ë¹„í–‰"];
}
// PRE_MAPì€ ì•„ë˜ì—ì„œ ìƒì„±
var PRE_MAP = null;
function isBaseStagePokemonId(pid) {
  if (!PRE_MAP) 
    return true;
  return !PRE_MAP[pid];
}
function spawnPokemonForRegion(regionKey) {
  var allowedTypes = regionTypes(regionKey);
  var pool = [];
  for (var i = 0; i < POKEMON_DB.length; i++) {
    var p = POKEMON_DB[i];
    if (!p) 
      continue;
    if (!isBaseStagePokemonId(p.id)) 
      continue;
    var ok = false;
    if (allowedTypes.indexOf(p.type1) !== -1) 
      ok = true;
    else if (p.type2 && allowedTypes.indexOf(p.type2) !== -1) 
      ok = true;
    if (ok) 
      pool.push(p);
  }
  if (pool.length === 0) {
    var fb = [];
    for (var j = 0; j < POKEMON_DB.length; j++) {
      var pp = POKEMON_DB[j];
      if (!pp) 
        continue;
      if (isBaseStagePokemonId(pp.id)) 
        fb.push(pp);
    }
    return randomPick(fb);
  }
  var filtered = [];
  for (var k = 0; k < pool.length; k++) {
    var c = pool[k];
    var w = raritySpawnWeight(c.rarity || 2);
    if (Math.random() < w) {
      filtered.push(c);
    }
  }
  // ì „ë¶€ íƒˆë½í–ˆìœ¼ë©´ ì›ë˜ í’€ ì‚¬ìš©
  if (filtered.length === 0) 
    filtered = pool;
  var sum = 0;
  var weights = [];
  for (var m = 0; m < filtered.length; m++) {
    var rarity = filtered[m].rarity || 2;
    var ww = 1 / Math.pow(rarity, 1.2);
    weights.push(ww);
    sum += ww;
  }
  var r = Math.random() * sum;
  for (var n = 0; n < filtered.length; n++) {
    r -= weights[n];
    if (r <= 0) 
      return filtered[n];
  }
  return filtered[filtered.length - 1];
}
// -------------------- ì•¼ìƒ ìŠ¤í° ì €ì¥ --------------------
function getWild(d, room) {
  var w = d.lastSpawnByRoom[room];
  if (!w) 
    return null;
  if (nowMs() > (w.expiresAt || 0)) {
    // ë§Œë£Œ â†’ ë°”ë¡œ ì§€ìš°ì§€ ì•Šê³  expired í”Œë˜ê·¸ë§Œ ë‚¨ê¹€
    d.lastSpawnByRoom[room] = {
  expired: true, 
  pid: w.pid};
    return null;
  }
  return w;
}
// ë§Œë£Œëœ ì•¼ìƒ í¬ì¼“ëª¬ì„ "1íšŒì„±"ìœ¼ë¡œ êº¼ë‚´ê¸°
function takeExpiredWild(d, room) {
  var w = d.lastSpawnByRoom[room];
  if (w && w.expired) {
    delete d.lastSpawnByRoom[room];
    return w;
  }
  return null;
}
function setWild(d, room, pid) {
  d.lastSpawnByRoom[room] = {
  pid: pid, 
  at: nowMs(), 
  expiresAt: nowMs() + SPAWN_EXPIRE_MS, 
  attempts: 0, 
  maxAttempts: getMaxCatchAttempts(pid)};
}
function clearWild(d, room) {
  delete d.lastSpawnByRoom[room];
}
// -------------------- ë³¼/í¬íš í™•ë¥  --------------------
function ballCatchRate(ballType) {
  if (ballType === 0) 
    return 0.75;
  if (ballType === 1) 
    return 1.15;
  return 1.45;
}
// í¬ê·€ë„ì— ë”°ë¥¸ í¬íš íŒ¨ë„í‹°
function rarityCatchPenalty(r) {
  if (r <= 1) 
    return 1.0;
  if (r === 2) 
    return 0.9;
  if (r === 3) 
    return 0.75;
  if (r === 4) 
    return 0.6;
  return 0.45;
}
function consumeBall(u, ballType) {
  if (ballType === 0) {
    if (u.ball <= 0) 
      return false;
    u.ball -= 1;
    return true;
  }
  if (ballType === 1) {
    if (u.superBall <= 0) 
      return false;
    u.superBall -= 1;
    return true;
  }
  if (u.ultraBall <= 0) 
    return false;
  u.ultraBall -= 1;
  return true;
}
function getMaxCatchAttempts(pid) {
  var db = findPokemonDB(pid);
  var r = db ? (db.rarity || 2) : 2;
  var min = 1;
  var max = 8;
  if (r <= 1) 
    min = 5;
  else if (r === 2) 
    min = 4;
  else if (r === 3) 
    min = 3;
  else if (r === 4) 
    min = 2;
  else 
    min = 1;  // r5
  return min + Math.floor(Math.random() * (max - min + 1));
}
// -------------------- í¬ê·€ë„ í¬íš ë°°ìœ¨ --------------------
function rarityCatchMul(r) {
  if (r === 1) 
    return 1.00;
  if (r === 2) 
    return 0.85;
  if (r === 3) 
    return 0.65;
  if (r === 4) 
    return 0.40;
  return 0.18;
}
// ë„íŒŒë¯¼ê°•í™”ê¶Œ
function rollDopaEnhance() {
  var r = Math.random();
  // UP 35% / KEEP 25% / RESET0 30% / EXIT 10%
  if (r < 0.35) {
    // ì„±ê³µ ì‹œ 2~10ê°• ë¶„í¬
    var x = Math.random();
    var up = 2;
    if (x < 0.25) 
      up = 2;
    else if (x < 0.45) 
      up = 3;
    else if (x < 0.60) 
      up = 4;
    else if (x < 0.72) 
      up = 5;
    else if (x < 0.82) 
      up = 6;
    else if (x < 0.90) 
      up = 7;
    else if (x < 0.95) 
      up = 8;
    else if (x < 0.98) 
      up = 9;
    else 
      up = 10;
    return {
  kind: "UP", 
  up: up};
  }
  if (r < 0.60) 
    return {
  kind: "KEEP"};
  if (r < 0.90) 
    return {
  kind: "RESET0"};
  return {
  kind: "EXIT"};
}
// -------------------- ìƒì  --------------------
function shopText(d, u, sender) {
  return (
    sender + "ë‹˜ í˜„ì¬ ì”ì—¬ ê³¨ë“œëŠ” " + fmtNum(u.gold) + "ğŸ’° ì…ë‹ˆë‹¤\n\n" +
    "ğŸª [ìƒì  ë¬¼í’ˆ ëª©ë¡]\n" +
    "1. ëª¬ìŠ¤í„°ë³¼ " + fmtNum(getShopPrice(d, "BALL")) + "ğŸ’°\n" +
    "2. ìŠˆí¼ë³¼ " + fmtNum(getShopPrice(d, "SUPER")) + "ğŸ’°\n" +
    "3. í•˜ì´í¼ë³¼ " + fmtNum(getShopPrice(d, "ULTRA")) + "ğŸ’°\n" +
    "4. ë„íŒŒë¯¼ê°•í™”ê¶Œ " + fmtNum(getShopPrice(d, "DOPA")) + "ğŸ’°\n" +
    "5. ë‘ì«€ì¿ (í™•ì •ê°•í™”) " + fmtNum(getShopPrice(d, "COOKIE") || SHOP_PRICE_COOKIE) + "ğŸ’°\n" +
    "6. ì´ë™í‹°ì¼“ " + fmtNum(getShopPrice(d, "TICKET") || SHOP_PRICE_TICKET) + "ğŸ’°\n" +
    "7. ë“±ê¸‰ì¬ì„¤ì •ê¶Œ " + fmtNum(getShopPrice(d, "REROLL") || SHOP_PRICE_REROLL) + "ğŸ’°\n\n" +
    "ğŸ›’ [êµ¬ë§¤ ë°©ë²•]\n" +
    "/êµ¬ë§¤ ëª¬ìŠ¤í„°ë³¼ 10\n" +
    "/êµ¬ë§¤ ë‘ì«€ì¿  1\n" +
    "/êµ¬ë§¤ ì´ë™í‹°ì¼“ 1\n" +
    "/êµ¬ë§¤ ì¬ì„¤ì •ê¶Œ 1"
  );
}
// [ìˆ˜ì •ë¨] êµ¬ë§¤ ì²˜ë¦¬ ë¡œì§ ì—…ë°ì´íŠ¸
function buyItem(d, u, sender, itemName, qty) {
  qty = parseInt(qty, 10);
  if (isNaN(qty)) qty = 1;
  qty = Math.max(1, Math.min(999, qty));
  
  var cost = 0;
  var field = "";
  var label = "";
  
  // ì•„ì´í…œ ë§¤í•‘
  if (itemName === "ëª¬ìŠ¤í„°ë³¼") { cost = getShopPrice(d, "BALL"); field = "ball"; label = "ëª¬ìŠ¤í„°ë³¼"; }
  else if (itemName === "ìŠˆí¼ë³¼") { cost = getShopPrice(d, "SUPER"); field = "superBall"; label = "ìŠˆí¼ë³¼"; }
  else if (itemName === "í•˜ì´í¼ë³¼") { cost = getShopPrice(d, "ULTRA"); field = "ultraBall"; label = "í•˜ì´í¼ë³¼"; }
  else if (itemName === "ë„íŒŒë¯¼" || itemName === "ë„íŒŒë¯¼ê°•í™”ê¶Œ") { cost = getShopPrice(d, "DOPA"); field = "dopaTicket"; label = "ë„íŒŒë¯¼ê°•í™”ê¶Œ"; }
  else if (itemName === "ë‘ì«€ì¿ " || itemName === "ì¿ í‚¤") { cost = getShopPrice(d, "COOKIE") || SHOP_PRICE_COOKIE; field = "cookie"; label = "ë‘ì«€ì¿ "; }
  else if (itemName === "ì´ë™í‹°ì¼“" || itemName === "í‹°ì¼“") { cost = getShopPrice(d, "TICKET") || SHOP_PRICE_TICKET; field = "ticket"; label = "ì´ë™í‹°ì¼“"; }
  else if (itemName === "ì¬ì„¤ì •ê¶Œ" || itemName === "ì¬ì„¤ì •") { cost = getShopPrice(d, "REROLL") || SHOP_PRICE_REROLL; field = "reroll"; label = "ë“±ê¸‰ì¬ì„¤ì •ê¶Œ"; }
  else {
    return { ok: false, reason: "ğŸš« ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì•„ì´í…œì…ë‹ˆë‹¤.\n(ëª¬ìŠ¤í„°ë³¼, ìŠˆí¼ë³¼, í•˜ì´í¼ë³¼, ë„íŒŒë¯¼, ë‘ì«€ì¿ , ì´ë™í‹°ì¼“, ì¬ì„¤ì •ê¶Œ)" };
  }

  if (u.gold < cost * qty) {
    return { ok: false, reason: sender + "ë‹˜, ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.\ní•„ìš”: " + fmtNum(cost * qty) + "ğŸ’°\në³´ìœ : " + fmtNum(u.gold) + "ğŸ’°" };
  }

  u.gold -= cost * qty;
  if (!u[field]) u[field] = 0;
  u[field] += qty;
  
  commitSave(true);
  return { ok: true, msg: "ğŸ›’ " + label + " " + qty + "ê°œ êµ¬ë§¤ ì™„ë£Œ!\nğŸ’° ì”ì—¬ ê³¨ë“œ: " + fmtNum(u.gold) + "ğŸ’°" };
}
// -------------------- ì „ì /ë­í¬ --------------------
function battleScoreRank(u) {
  ensureUserStats(u);
  var w = u.stats.battleWin;
  var l = u.stats.battleLose;
  var d0 = u.stats.battleDraw;
  var total = w + l + d0;
  var base = (w * 3) + (d0 * 1);
  var streakBonus = Math.min(30, u.stats.battleStreak * 2);
  var playPenalty = (total < 3) ? (3 - total) * 2 : 0;
  return base + streakBonus - playPenalty;
}
function formatRecord(u) {
  ensureUserStats(u);
  var w = u.stats.battleWin, l = u.stats.battleLose, d0 = u.stats.battleDraw;
  var total = w + l + d0;
  var rate = (total === 0) ? 0 : Math.floor((w / total) * 1000) / 10;
  return ("ì „ì : " + w + "ìŠ¹ " + l + "íŒ¨" + (d0 > 0 ? (" " + d0 + "ë¬´") : "") + "\n" + "ìŠ¹ë¥ : " + rate + "%\n" + "ì—°ìŠ¹: " + u.stats.battleStreak + "\n" + "ìµœê³  ì—°ìŠ¹: " + u.stats.bestStreak + "\n" + "ë­í‚¹ ì ìˆ˜: " + battleScoreRank(u));
}
function rankTopList(d) {
  var list = [];
  for (var name in d.users) {
    var uu = d.users[name];
    if (!uu) 
      continue;
    ensureUserStats(uu);
    var total = uu.stats.battleWin + uu.stats.battleLose + uu.stats.battleDraw;
    if (total <= 0) 
      continue;
    list.push({
  name: name, 
  score: battleScoreRank(uu), 
  w: uu.stats.battleWin, 
  l: uu.stats.battleLose, 
  s: uu.stats.battleStreak, 
  total: total});
  }
  list.sort(function(a, b) {
  if (b.score !== a.score) 
    return b.score - a.score;
  if (b.w !== a.w) 
    return b.w - a.w;
  return b.total - a.total;
});
  return list;
}
//ì „íˆ¬ë ¥ë­í‚¹
function getUserTopPokemonPower(user) {
  normalizeUserData(user);
  if (!user.pokemons || user.pokemons.length === 0) {
    return {
  power: 0, 
  uid: 0, 
  name: "-", 
  enh: 0};
  }
  var sorted = sortPokemonsByPower(user.pokemons);
  var top = sorted[0];
  var db = findPokemonDB(top.pid);
  return {
  power: calcBattlePower(top), 
  uid: top.uid, 
  name: db ? db.name : "ì•Œìˆ˜ì—†ìŒ", 
  enh: top.enh || 0};
}
// [ìˆ˜ì •ë¨] ì „íˆ¬ë ¥ ë­í‚¹ (ì¡°íšŒ ì‹œ ë°ì´í„° ë³´ì • í¬í•¨)
function buildBattlePowerRanking(d, topN, sender) {
  topN = topN || 7;
  var rows = [];
  var names = Object.keys(d.users || {});
  
  // ë­í‚¹ ì‚°ì • ì¤‘ ë°ì´í„° ë³€ê²½ì´ ì¼ì–´ë‚  ìˆ˜ ìˆìŒ (ë¯¸ì ‘ì†ì ë“±ê¸‰ ë¶€ì—¬ ë“±)
  var dataChanged = false; 

  for (var i = 0; i < names.length; i++) {
    var name = names[i];
    if (!name) continue;
    var user = d.users[name];
    if (!user) continue;

    normalizeUserData(user);
    if (!user.pokemons || user.pokemons.length === 0) continue;

    // [ì¤‘ìš”] ë­í‚¹ ì§‘ê³„í•  ë•Œë„ ë“±ê¸‰ ì—†ìœ¼ë©´ ë¶€ì—¬í•´ë²„ë¦¼
    if (ensurePokemonGrades(user)) {
      dataChanged = true;
    }

    var top = getUserTopPokemonPower(user); // ì´ì œ ë“±ê¸‰ì´ ë°˜ì˜ëœ ì „íˆ¬ë ¥ì´ ë‚˜ì˜´
    rows.push({
      name: name,
      power: top.power,
      uid: top.uid,
      pName: top.name,
      enh: top.enh
    });
  }

  // ë­í‚¹ ì§‘ê³„ ì¤‘ ë°ì´í„°ê°€ ë³€í–ˆìœ¼ë©´ ì €ì¥ (ë¯¸ì ‘ì†ì ë°ì´í„° ê°±ì‹ )
  if (dataChanged) {
    saveData(d);
  }

  rows.sort(function(a, b) {
    if (b.power !== a.power) return b.power - a.power;
    if ((b.enh || 0) !== (a.enh || 0)) return (b.enh || 0) - (a.enh || 0);
    return (a.uid || 0) - (b.uid || 0);
  });

  var myIdx = -1;
  if (sender) {
    for (var k = 0; k < rows.length; k++) {
      if (rows[k].name === sender) { myIdx = k; break; }
    }
  }

  return { rows: rows, myIdx: myIdx, topN: topN };
}

// -------------------- ìš´ì˜ì(ê´€ë¦¬ì) ì„¤ì • --------------------
var ADMIN_MAP = {
  "ì†ì‚¬ì¥": true};
function isAdmin(sender) {
  return !!ADMIN_MAP[sender];
}
function cleanName(s) {
  if (!s) 
    return "";
  s = ("" + s).trim();
  if (s.charAt(0) === "@") 
    s = s.slice(1);
  return s.trim();
}
function getUserByName(d, name) {
  name = cleanName(name);
  if (!name) 
    return null;
  if (!d.users) 
    d.users = {};
  var u = d.users[name];
  if (!u) 
    return null;
  if (typeof u.gold !== "number") 
    u.gold = 0;
  if (typeof u.trainerLv !== "number") 
    u.trainerLv = 1;
  if (typeof u.trainerExp !== "number") 
    u.trainerExp = 0;
  if (typeof u.ball !== "number") 
    u.ball = 0;
  if (typeof u.superBall !== "number") 
    u.superBall = 0;
  if (typeof u.ultraBall !== "number") 
    u.ultraBall = 0;
  if (typeof u.dopaTicket !== "number") 
    u.dopaTicket = 0;
  if (!u.pokemons) 
    u.pokemons = [];
  return {
  name: name, 
  user: u};
}
function addAdminLog(d, actor, line) {
  if (!d.adminLog) 
    d.adminLog = [];
  d.adminLog.push({
  t: nowMs(), 
  by: actor, 
  line: line});
  if (d.adminLog.length > 200) 
    d.adminLog = d.adminLog.slice(d.adminLog.length - 200);
}
// -------------------- ì „ì—­ ì„¤ì •(ëŸ°íƒ€ì„ + ì €ì¥) --------------------
function ensureConfig(d) {
  if (!d.config) 
    d.config = {};
  if (!d.config.shop) 
    d.config.shop = {};
  if (!d.config.flags) 
    d.config.flags = {};
  if (typeof d.config.shop.BALL !== "number") 
    d.config.shop.BALL = SHOP_PRICE_BALL;
  if (typeof d.config.shop.SUPER !== "number") 
    d.config.shop.SUPER = SHOP_PRICE_SUPER;
  if (typeof d.config.shop.ULTRA !== "number") 
    d.config.shop.ULTRA = SHOP_PRICE_ULTRA;
  if (typeof d.config.shop.DOPA !== "number") 
    d.config.shop.DOPA = SHOP_PRICE_DOPA;
  if (typeof d.config.flags.EVENT_ON !== "boolean") 
    d.config.flags.EVENT_ON = false;
  if (typeof d.config.flags.FIELD_ON !== "boolean") 
    d.config.flags.FIELD_ON = true;
  if (typeof d.config.flags.ENHANCE_ON !== "boolean") 
    d.config.flags.ENHANCE_ON = true;
  if (typeof d.config.flags.DOPA_ON !== "boolean") 
    d.config.flags.DOPA_ON = true;
}
function getShopPrice(d, key) {
  ensureConfig(d);
  return d.config.shop[key];
}
function setShopPrice(d, key, val) {
  ensureConfig(d);
  d.config.shop[key] = val;
}
function isFlagOn(d, key) {
  ensureConfig(d);
  return !!d.config.flags[key];
}
function setFlag(d, key, on) {
  ensureConfig(d);
  d.config.flags[key] = !!on;
}
function globalConfigText(d) {
  ensureConfig(d);
  return ("ì „ì—­ ì„¤ì •\n\n" + "ìƒì \n" + "ëª¬ìŠ¤í„°ë³¼: " + d.config.shop.BALL + "ğŸ’°\n" + "ìŠˆí¼ë³¼: " + d.config.shop.SUPER + "ğŸ’°\n" + "í•˜ì´í¼ë³¼: " + d.config.shop.ULTRA + "ğŸ’°\n" + "ë„íŒŒë¯¼ê°•í™”ê¶Œ: " + d.config.shop.DOPA + "ğŸ’°\n\n" + "í† ê¸€\n" + "ì´ë²¤íŠ¸: " + (d.config.flags.EVENT_ON ? "ON" : "OFF") + "\n" + "í•„ë“œ: " + (d.config.flags.FIELD_ON ? "ON" : "OFF") + "\n" + "ê°•í™”: " + (d.config.flags.ENHANCE_ON ? "ON" : "OFF") + "\n" + "ë„íŒŒë¯¼ê°•í™”: " + (d.config.flags.DOPA_ON ? "ON" : "OFF"));
}
function adminHelpText() {
  return ("ìš´ì˜ì ëª…ë ¹ì–´\n\n" + "/ê´€ë¦¬ì ë„ì›€\n" + "/ê´€ë¦¬ì ì¡°íšŒ ë‹‰ë„¤ì„\n" + "/ê´€ë¦¬ì ì§€ê¸‰ ë‹‰ë„¤ì„ ê³¨ë“œ 1000\n" + "/ê´€ë¦¬ì ì§€ê¸‰ ë‹‰ë„¤ì„ ê²½í—˜ì¹˜ 200\n" + "/ê´€ë¦¬ì ì§€ê¸‰ ë‹‰ë„¤ì„ ë„íŒŒë¯¼ 3\n" + "/ê´€ë¦¬ì ì„¤ì • ë‹‰ë„¤ì„ ë ˆë²¨ 15\n" + "/ê´€ë¦¬ì ì„¤ì • ë‹‰ë„¤ì„ ê°•í™”ê¶Œ 10\n" + "/ê´€ë¦¬ì í¬ì¼“ëª¬ ë‹‰ë„¤ì„\n" + "/ê´€ë¦¬ì í¬ì¼“ëª¬ì§€ê¸‰ ë‹‰ë„¤ì„ í¬ì¼“ëª¬ëª…\n" + "/ê´€ë¦¬ì í¬ì¼“ëª¬ì‚­ì œ ë‹‰ë„¤ì„ #í¬ì¼“ëª¬UID\n" + "/ê´€ë¦¬ì ì „ì—­ì¡°íšŒ\n" + "/ê´€ë¦¬ì ì „ì—­ì„¤ì • SHOP_PRICE_DOPA 15000\n");
}
// ìœ ì € ë³´ìœ  í¬ì¼“ëª¬ ëª©ë¡ì„ ê¸°ì¤€ìœ¼ë¡œ ë‹¤ìŒ UID ìƒì„±
function nextPokemonUIDForUser(u) {
  if (!u.pokemons) 
    u.pokemons = [];
  var maxUid = 0;
  for (var i = 0; i < u.pokemons.length; i++) {
    var p = u.pokemons[i];
    if (!p) 
      continue;
    var uid = parseInt(p.uid, 10);
    if (!isNaN(uid) && uid > maxUid) 
      maxUid = uid;
  }
  return maxUid + 1;
}
// -------------------- roomActive: ë©”ëª¨ë¦¬ ì „ìš©(íŒŒì¼ ì €ì¥ X) --------------------
// ë°©ë³„ ìµœê·¼ í™œë™ ìœ ì €(ë°°í‹€ ë§¤ì¹­ìš©) - ì•± ì¬ì‹œì‘ ì‹œ ë¦¬ì…‹ë¨ (ì˜ë„ëœ ë™ì‘)
var ROOM_ACTIVE_MEM = {};// { [room]: { [sender]: lastActiveMs } }
function trackRoomActiveMem(room, sender) {
  var now = nowMs();
  var key = MATCH_POOL_KEY;  // room ëŒ€ì‹  ê³ ì •í‚¤ ì‚¬ìš©
  if (!ROOM_ACTIVE_MEM[key]) 
    ROOM_ACTIVE_MEM[key] = {};
  ROOM_ACTIVE_MEM[key][sender] = now;
  if (Math.random() < 0.08) {
    var m = ROOM_ACTIVE_MEM[key];
    for (var name in m) {
      if (now - m[name] > ACTIVE_TTL_MS) 
        delete m[name];
    }
  }
}
function getEligibleOpponentsMem(d, room, myName) {
  var now = nowMs();
  var key = MATCH_POOL_KEY;
  var active = ROOM_ACTIVE_MEM[key] || {};
  var list = [];
  for (var name in active) {
    if (name === myName) 
      continue;
    if (now - active[name] > ACTIVE_TTL_MS) 
      continue;
    var u = d.users[name];
    if (!u) 
      continue;
    normalizeUserData(u);
    var eligible = getBattleEligiblePokemons(u);
    if (eligible.length === 0) 
      continue;
    list.push(name);
  }
  return list;
}
// ë˜í¼(ê¸°ì¡´ í˜¸ì¶œë¶€ í˜¸í™˜)
function trackRoomActive(d, room, sender) {
  trackRoomActiveMem(room, sender);
}
function getEligibleOpponents(d, room, myName) {
  return getEligibleOpponentsMem(d, room, myName);
}

// -------------------- íƒ€ì… ìƒì„± ê³„ì‚° --------------------
function remapTypeMult(m) {
  // ì›ë³¸ ìƒì„± m: 0, 0.5, 1, 2
  // ëª©í‘œ: ìƒì„±ì€ ê°•í•˜ê²Œ, í•˜ì§€ë§Œ ê°•í™”/í¬ê·€ë„ë¡œ ì»¤ë²„ ì—¬ì§€ ìœ ì§€
  if (m === 0) 
    return 0.25;
  if (m === 0.5) 
    return 0.95;
  if (m === 1) 
    return 1.50;
  if (m === 2) 
    return TYPE_STRONG;
  return 2.40;
}
function typeMultiplierAdjusted(attackType, defendType) {
  if (!attackType || !defendType) 
    return 2;
  var row = TYPE_CHART[attackType];
  if (!row) 
    return 2;
  var raw = row[defendType];
  return remapTypeMult((raw === undefined) ? 1 : raw);
}
function rarityBattleMul(r) {
  if (r <= 1) 
    return 1.00;
  if (r === 2) 
    return 1.04;
  if (r === 3) 
    return 1.08;
  if (r === 4) 
    return 1.13;
  return 1.18;
}
function stageBattleMul(pid) {
  if (!pid) 
    return {
  atk: 1.00, 
  def: 1.00};
  var s = getStageFromBase(pid);
  if (s === 0) 
    return {
  atk: 1.00, 
  def: 1.00};
  if (s === 1) 
    return {
  atk: 1.15, 
  def: 1.08};
  return {
  atk: 1.32, 
  def: 1.16};
}
function calcDamage(attDb, attEnh, defDb, defEnh) {
  var atkType = attDb.type1;
  var mult = typeMultiplierAdjusted(atkType, defDb.type1);
  if (defDb.type2) mult = Math.min(mult, TYPE_STRONG * 1.4);
  var attPid = attDb.id || attDb.pid;
  var defPid = defDb.id || defDb.pid;
  // ì§„í™” ë‹¨ê³„ ê³„ìˆ˜
  var aStage = stageBattleMul(attPid);
  var dStage = stageBattleMul(defPid);
  // í¬ê·€ë„ ê³„ìˆ˜(ê³µê²©/ë°©ì–´ ë‘˜ ë‹¤ì— ë°˜ì˜)
  var aR = rarityBattleMul(attDb.rarity || 2);
  var dR = rarityBattleMul(defDb.rarity || 2);
  // ê³µê²©/ë°©ì–´ íŒŒì›Œ
  var atkPower = attDb.basePower * (1 + (attEnh * ATK_ENH_RATE)) * aStage.atk * aR;
  var defPower = defDb.basePower * (1 + (defEnh * DEF_ENH_RATE)) * dStage.def * dR;
  // ë¹„ìœ¨ ê¸°ë°˜ ë°ë¯¸ì§€ ì ìˆ˜
  var ratio = (atkPower * mult) / Math.max(1, defPower);
  // 14ëŠ” ì „íˆ¬ í…œí¬ ì¡°ì ˆìš©(ëŠë¦¬ë©´ ì˜¬ë¦¬ê³ , ë¹ ë¥´ë©´ ë‚´ë¦¬ê¸°)
  var score = Math.max(1, Math.floor(ratio * 14));
  return {
  score: score, 
  mult: mult};
}
// -------------------- ì§„í™” ìœ í‹¸ --------------------
function buildPreMap() {
  var pre = {};
  for (var from in EVOLUTION_MAP) {
    var to = EVOLUTION_MAP[from];
    pre[to] = parseInt(from, 10);
  }
  return pre;
}
PRE_MAP = buildPreMap();
function getBaseId(pid) {
  var cur = pid;
  while (PRE_MAP[cur]) 
    cur = PRE_MAP[cur];
  return cur;
}
function chainDepthFromBase(baseId) {
  var depth = 0;
  var cur = baseId;
  while (EVOLUTION_MAP[cur]) {
    depth++;
    cur = EVOLUTION_MAP[cur];
    if (depth >= 3) 
      break;
  }
  return depth;
}
function getStageFromBase(pid) {
  var base = getBaseId(pid);
  if (pid === base) 
    return 0;
  var s1 = EVOLUTION_MAP[base];
  if (pid === s1) 
    return 1;
  var s2 = s1 ? EVOLUTION_MAP[s1] : null;
  if (pid === s2) 
    return 2;
  return 0;
}
function evolveTo(p, newPid) {
  var before = findPokemonDB(p.pid);
  p.pid = newPid;
  var after = findPokemonDB(p.pid);
  var bName = before ? before.name : "í¬ì¼“ëª¬";
  var aName = after ? after.name : "í¬ì¼“ëª¬";
  return bName + " â†’ " + aName;
}
function tryAutoEvolveByEnh(p) {
  // ì´ë¸Œì´ ë¶„ê¸°ì§„í™”
  if (p.pid === 133 && p.enh >= EVOLVE_EEVEE) {
    var pick = EEVEE_EVOS[Math.floor(Math.random() * EEVEE_EVOS.length)];
    return evolveTo(p, pick);
  }
  var base = getBaseId(p.pid);
  var depth = chainDepthFromBase(base);
  var stage = getStageFromBase(p.pid);
  if (depth >= 2) {
    if (stage === 0 && p.enh >= EVOLVE_TWO_STAGE_1) {
      return evolveTo(p, EVOLUTION_MAP[p.pid]);
    }
    if (stage === 1 && p.enh >= EVOLVE_TWO_STAGE_2) {
      return evolveTo(p, EVOLUTION_MAP[p.pid]);
    }
  }
  if (depth === 1 && stage === 0 && p.enh >= EVOLVE_ONE_STAGE) {
    return evolveTo(p, EVOLUTION_MAP[p.pid]);
  }
  return null;
}
// -------------------- íšŒì› / ê³„ì • --------------------
function ensureUser(d, sender) {
  if (!d.users[sender]) {
    d.users[sender] = {
  trainerLv: 1, 
  trainerExp: 0, 
  gold: 0, 
  ball: 0, 
  superBall: 0, 
  ultraBall: 0, 
  pokemons: [], 
  nextPokeUid: 1, 
  lastFieldAt: 0, 
  lastExploreAt: 0, 
  lastEnhanceAt: 0, 
  lastAttendanceKey: "", 
  catchFailStreak: 0, 
  lastCatchPid: 0, 
  stats: {}, 
  dex: {}, 
  isNewUser: true};
    ensureUserStats(d.users[sender]);
    ensureUserDex(d.users[sender]);
    return true;
  }
  return false;
}
// -------------------- [ì‹ ì„¤] ë“±ê¸‰ ë° ê°œì²´ê°’(IV) ì‹œìŠ¤í…œ --------------------
var GRADE_ORDER = { "D": 0, "C": 1, "B": 2, "A": 3, "S": 4 };

// ëœë¤ ë“±ê¸‰ ê²°ì • (S: 5%, A: 10%, B: 20%, C: 35%, D: 30%)
function generatePokemonGrade() {
  var r = Math.random();
  if (r < 0.05) return "S";
  if (r < 0.15) return "A";
  if (r < 0.35) return "B";
  if (r < 0.65) return "C";
  return "D";
}

// ë“±ê¸‰ì— ë”°ë¥¸ ê°œì²´ê°’(IV) ìƒì„± ë²”ìœ„
function generateIVsByGrade(grade) {
  var ivs = { str: 0, hp: 0, spd: 0 };
  if (grade === "S") {
    ivs.str = randInt(13, 15); ivs.hp = randInt(120, 150); ivs.spd = randInt(13, 15);
  } else if (grade === "A") {
    ivs.str = randInt(10, 12); ivs.hp = randInt(80, 119); ivs.spd = randInt(10, 12);
  } else if (grade === "B") {
    ivs.str = randInt(7, 9);   ivs.hp = randInt(50, 79);  ivs.spd = randInt(7, 9);
  } else if (grade === "C") {
    ivs.str = randInt(4, 6);   ivs.hp = randInt(20, 49);  ivs.spd = randInt(4, 6);
  } else {
    ivs.str = randInt(1, 3);   ivs.hp = randInt(1, 19);   ivs.spd = randInt(1, 3);
  }
  return ivs;
}


// -------------------- í¬íš ìœ í‹¸ --------------------
// -------------------- [ìˆ˜ì •] í¬ì¼“ëª¬ ìƒì„± ë¡œì§ --------------------
function addPokemonToUser(u, pid) {
  var uid = nextPokemonUid(u);
  var grade = generatePokemonGrade(); // ë“±ê¸‰ ìƒì„±
  var ivs = generateIVsByGrade(grade); // ë“±ê¸‰ì— ë”°ë¥¸ ê°œì²´ê°’ ìƒì„±

  u.pokemons.push({
    uid: uid,
    pid: pid,
    enh: 0,
    grade: grade,    // ë“±ê¸‰ ì €ì¥
    ivStr: ivs.str,  // í˜ IV
    ivHp: ivs.hp,    // ì²´ë ¥ IV
    ivSpd: ivs.spd   // ê³µì† IV
  });

  // dexCaughtì— ë“±ê¸‰(grade) ì •ë³´ë„ í•¨ê»˜ ì „ë‹¬
  dexCaught(u, pid, grade); 
  
  return uid; // ì¤‘ìš”: UIDë¥¼ ë°˜í™˜í•´ì•¼ í¬íš ë©”ì‹œì§€ì— IDê°€ ëœ¹ë‹ˆë‹¤.
}

// í¬ê·€ë„: 1(í”í•¨) ~ 5(ì „ì„¤)
// db.rarity ë˜ëŠ” db.tier ê°™ì€ ê°’ì´ ì´ë¯¸ ìˆìœ¼ë©´ ê±°ê¸°ì— ë§ì¶° ì—°ê²°í•˜ë©´ ë¨.
function randInt(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}
function getRarity(pid) {
  // ìš°ì„  DBì— rarityê°€ ìˆìœ¼ë©´ ê·¸ê±¸ ì“°ëŠ” ê±¸ ì¶”ì²œ
  // ì—¬ê¸°ì„œëŠ” findPokemonDB(pid).rarity ë¥¼ ê°€ì •
  var db = findPokemonDB(pid);
  if (db && db.rarity != null) 
    return db.rarity;
  return 1;
}
function isLegendary(pid) {
  // DBì— legendary í”Œë˜ê·¸ê°€ ìˆìœ¼ë©´ ê·¸ê±¸ ì‚¬ìš© ì¶”ì²œ
  // ì—¬ê¸°ì„œëŠ” db.legendary ë˜ëŠ” rarity==5 ë¡œ ì²˜ë¦¬
  var db = findPokemonDB(pid);
  if (db && db.legendary != null) 
    return !!db.legendary;
  var r = (db && db.rarity != null) ? db.rarity : 1;
  return r >= 5;
}
// í¬ê·€ë„ë³„ ê¸°ë³¸ ë³´ìƒ í…Œì´ë¸” (ì›í•˜ëŠ” ìˆ˜ì¹˜ë¡œ ì¡°ì ˆ ê°€ëŠ¥)
var CATCH_REWARD_BASE = {
  1: {
  gold: 60, 
  exp: 18}, 
  2: {
  gold: 100, 
  exp: 28}, 
  3: {
  gold: 160, 
  exp: 45}, 
  4: {
  gold: 260, 
  exp: 70}, 
  5: {
  gold: 400, 
  exp: 110}};
// ë ˆë²¨/ë‚œìˆ˜/í¬ê·€ë„ê¹Œì§€ ë°˜ì˜í•´ì„œ ìµœì¢… ë³´ìƒ ì‚°ì¶œ
function calcCatchRewards(u, pid) {
  var db = findPokemonDB(pid) || {};
  var rarity = (db.rarity != null) ? db.rarity : 1;
  rarity = clamp(rarity, 1, 5);
  var base = CATCH_REWARD_BASE[rarity] || CATCH_REWARD_BASE[1];
  // ë ˆë²¨ ë³´ì •: ë ˆë²¨ì´ ë†’ì„ìˆ˜ë¡ ì†Œí­ ì¦ê°€ (ë„ˆë¬´ í­ì¦í•˜ì§€ ì•Šê²Œ)
  var lv = (u && typeof u.trainerLv === "number") ? u.trainerLv : 1;
  // ë‚œìˆ˜ ë³´ì •: í¬ê·€ë„ê°€ ë†’ì„ìˆ˜ë¡ í­ì´ ì»¤ì§
  // ì˜ˆ: í”í•¨ Â±20%, ì „ì„¤ Â±35%
  var jitterPct = [0, 20, 22, 26, 30, 35][rarity];  // ì¸ë±ìŠ¤ ë§ì¶¤
  var goldJ = randInt(-jitterPct, jitterPct) / 100;
  var expJ = randInt(-jitterPct, jitterPct) / 100;
  // ë ˆë²¨ ê³„ìˆ˜: 1 + (ë ˆë²¨ / 100) ì •ë„ë¡œ ì™„ë§Œí•˜ê²Œ
  var lvMul = 1 + (lv / 100);
  var gold = Math.floor(base.gold * lvMul * (1 + goldJ));
  var exp = Math.floor(base.exp * lvMul * (1 + expJ));
  // ìµœì†Œê°’ ë³´ì •
  gold = Math.max(1, gold);
  exp = Math.max(1, exp);
  // ì „ì„¤ íŠ¹ìˆ˜ ë³´ë„ˆìŠ¤(ì¶”ê°€ ë³´ìƒ): í° í•œë°© + ì—°ì¶œìš©
  var legendary = isLegendary(pid);
  var bonusGold = 0;
  var bonusExp = 0;
  if (legendary) {
    bonusGold = randInt(180, 360) + Math.floor(lv * 1.2);
    bonusExp = randInt(120, 240) + Math.floor(lv * 0.9);
  }
  return {
  rarity: rarity, 
  legendary: legendary, 
  gold: gold, 
  exp: exp, 
  bonusGold: bonusGold, 
  bonusExp: bonusExp, 
  totalGold: gold + bonusGold, 
  totalExp: exp + bonusExp};
}
// ì „ì„¤ ì—°ì¶œ ë¬¸êµ¬
function legendaryCatchFX(sender, name, r) {
  // r: calcCatchRewards ê²°ê³¼
  return (blockTitle("ì „ì„¤ í¬íš") + "âœ¨ " + sayDo(sender, "ì „ì„¤ê¸‰ " + name + "ì„(ë¥¼) í¬íší–ˆì–´ìš”!") + "\n\n" + "ğŸ† íŠ¹ìˆ˜ ë³´ìƒ ë°œìƒ!\n" + "ì¶”ê°€ ë³´ìƒ: +" + r.bonusGold + "ğŸ’° / +" + r.bonusExp + "EXP\n\n");
}
function getMaxCatchAttempts(pid) {
  var db = findPokemonDB(pid);
  var r = db ? (db.rarity || 2) : 2;
  var min = 1;
  var max = 8;
  if (r <= 1) 
    min = 5;
  else if (r === 2) 
    min = 4;
  else if (r === 3) 
    min = 3;
  else if (r === 4) 
    min = 2;
  else 
    min = 1;  // r5
  return min + Math.floor(Math.random() * (max - min + 1));
}
// -------------------- ì†Œí”„íŠ¸ í”¼í‹° í¬í•¨ í¬íš íŒì • (4-D) --------------------
var CATCH_PITY_START = 2;// 2ì—°ì† ì‹¤íŒ¨ë¶€í„°
var CATCH_PITY_STEP = 0.01;// ì‹¤íŒ¨ 1íšŒë‹¹ +1%
var CATCH_PITY_MAX = 0.05;// ìµœëŒ€ +5%
function lerp(a, b, t) {
  return a + (b - a) * t;
}
function tierCatchMod(tier) {
  if (tier <= 1) 
    return 1.40;
  if (tier >= 5) 
    return 0.32;
  if (tier < 2) 
    return lerp(1.40, 1.15, tier - 1);
  if (tier < 3) 
    return lerp(1.15, 0.85, tier - 2);
  if (tier < 4) 
    return lerp(0.85, 0.55, tier - 3);
  return lerp(0.55, 0.32, tier - 4);
}
function getCatchTier(db) {
  if (!db) 
    return 2;
  return CATCH_TIER_OVERRIDES[db.id] || db.rarity || 2;
}
function tryCatch(u, pid, ballType) {
  var db = findPokemonDB(pid);
  if (!db) 
    return {
  ok: false};
  if (u.lastCatchPid !== pid) {
    u.catchFailStreak = 0;
    u.lastCatchPid = pid;
  }
  var base = 0.38;
  var ballMult = BALL_CATCH_MULT[ballType] || 1.0;
  var tier = getCatchTier(db);
  var tierMult = tierCatchMod(tier);
  var lvBonus = trainerCatchBonus(u.trainerLv);
  var chance = base * ballMult * tierMult * rarityCatchMul(db.rarity || 2) * (1 + lvBonus);
  // ì €ë ˆë²¨ ì „ì„¤ ì–µì œ
  if (db.rarity === 5 && u.trainerLv < 20) {
    chance *= 0.5;
  }
  if (chance < 0.02) 
    chance = 0.02;
  if (chance > 0.90) 
    chance = 0.90;
  if (u.catchFailStreak >= CATCH_PITY_START) {
    var pity = (u.catchFailStreak - CATCH_PITY_START + 1) * CATCH_PITY_STEP;
    pity *= (1 + (tier - 2) * 0.12);    // ì „ì„¤ì¼ìˆ˜ë¡ ì‚´ì§ ë” ë³´ì •
    pity = Math.min(CATCH_PITY_MAX, pity);
    chance *= (1 + pity);
  }
  chance = Math.max(0.02, Math.min(0.85, chance));
  var success = Math.random() < chance;
  if (success) {
    u.catchFailStreak = 0;
    u.lastCatchPid = 0;
  } else {
    u.catchFailStreak++;
  }
  return {
  ok: true, 
  success: success, 
  chance: chance, 
  streak: u.catchFailStreak, 
  tier: tier};
}
function commitSave(force) {
  markDirty();
  flushSaveIfNeeded(!!force);
}
function debugBattle(d, sender, room, replier) {
  var now = Date.now();
  var roomActive = ROOM_ACTIVE_MEM[room] || {};
  var activeUsers = [];
  var existUsers = [];
  var pokemonUsers = [];
  var candidates = [];
  for (var name in roomActive) {
    var last = roomActive[name];
    if (now - last <= ACTIVE_TTL_MS) {
      activeUsers.push(name);
      if (d.users && d.users[name]) {
        existUsers.push(name);
        var pokes = d.users[name].pokemons;
        if (pokes && Object.keys(pokes).length > 0) {
          pokemonUsers.push(name);
          if (name !== sender) 
            candidates.push(name);
        }
      }
    }
  }
  var msgLines = [];
  msgLines.push("ë°°í‹€ ë””ë²„ê·¸");
  msgLines.push("ë°©: " + room);
  msgLines.push("ë‚˜: " + sender);
  msgLines.push("í˜„ì¬ ì‹œê°„: " + new Date(now).toLocaleString());
  msgLines.push("");
  msgLines.push("ìµœê·¼ í™œë™ ìœ ì € ìˆ˜: " + activeUsers.length);
  msgLines.push(activeUsers.join(", ") || "(ì—†ìŒ)");
  msgLines.push("");
  msgLines.push("ìœ ì € ë°ì´í„° ì¡´ì¬: " + existUsers.length);
  msgLines.push(existUsers.join(", ") || "(ì—†ìŒ)");
  msgLines.push("");
  msgLines.push("í¬ì¼“ëª¬ ë³´ìœ  ìœ ì €: " + pokemonUsers.length);
  msgLines.push(pokemonUsers.join(", ") || "(ì—†ìŒ)");
  msgLines.push("");
  msgLines.push("ìµœì¢… ë°°í‹€ í›„ë³´(ë³¸ì¸ ì œì™¸): " + candidates.length);
  msgLines.push(candidates.join(", ") || "(ì—†ìŒ)");
  replier.reply(msgLines.join("\n"));
}

// -------------------- ë©”ì¸ ì‘ë‹µ --------------------
function response(room, msg, sender, isGroupChat, replier) {
  trackRoomActiveMem(room, sender);
  var MATCH_POOL = "__GLOBAL_MATCH__";
  if (!ROOM_ACTIVE_MEM[MATCH_POOL]) 
    ROOM_ACTIVE_MEM[MATCH_POOL] = {};
  ROOM_ACTIVE_MEM[MATCH_POOL][sender] = Date.now();
  var d = getDataCached();
  if (msg.indexOf("/ê´€ë¦¬ì") === 0) {
    if (!isAdmin(sender)) {
      replier.reply("ìš´ì˜ìë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ëª…ë ¹ì–´ì…ë‹ˆë‹¤.");
      return;
    }
    var parts = msg.split(" ").filter(Boolean);
    // parts[0] = /ê´€ë¦¬ì
    var sub = parts[1] || "ë„ì›€";
    // ==================== ë„ì›€ ====================
    if (sub === "ë„ì›€") {
      replier.reply(adminHelpText());
      return;
    }
    if (sub === "ì „ì—­ì¡°íšŒ") {
      replier.reply(globalConfigText(d));
      return;
    }
    if (sub === "ì „ì—­ì„¤ì •") {
      var key = parts[2];
      var val = parseInt(parts[3], 10);
      if (!key) {
        replier.reply("ì‚¬ìš©ë²•: /ê´€ë¦¬ì ì „ì—­ì„¤ì • SHOP_PRICE_DOPA 15000");
        return;
      }
      if (isNaN(val) || val < 0) {
        replier.reply("ì„¤ì • ê°’ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        return;
      }
      if (key === "SHOP_PRICE_BALL") 
        setShopPrice(d, "BALL", val);
      else if (key === "SHOP_PRICE_SUPER") 
        setShopPrice(d, "SUPER", val);
      else if (key === "SHOP_PRICE_ULTRA") 
        setShopPrice(d, "ULTRA", val);
      else if (key === "SHOP_PRICE_DOPA") 
        setShopPrice(d, "DOPA", val);
      else {
        replier.reply("ì „ì—­ì„¤ì • ê°€ëŠ¥í•œ í‚¤\n\n" + "SHOP_PRICE_BALL\nSHOP_PRICE_SUPER\nSHOP_PRICE_ULTRA\nSHOP_PRICE_DOPA");
        return;
      }
      addAdminLog(d, sender, "ì „ì—­ì„¤ì • " + key + "=" + val);
      commitSave(true);
      replier.reply("ì „ì—­ì„¤ì • ì™„ë£Œ\n" + key + " = " + val);
      return;
    }
    if (sub === "ê³µì§€") {
      var text = msg.replace("/ê´€ë¦¬ì ê³µì§€", "").trim();
      if (!text) {
        replier.reply("ì‚¬ìš©ë²•: /ê´€ë¦¬ì ê³µì§€ ë‚´ìš©...");
        return;
      }
      addAdminLog(d, sender, "ê³µì§€: " + text);
      commitSave(true);
      replier.reply("ğŸ“¢ ê³µì§€\n\n" + text);
      return;
    }    // [ì¶”ê°€] ë°ì´í„° ì •ë¦¬ ëª…ë ¹ì–´
    if (sub === "ë°ì´í„°ì •ë¦¬") {
      // manageInactiveUsers í•¨ìˆ˜ëŠ” ë§¨ ì•„ë˜ì— ì„ ì–¸ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
      var result = manageInactiveUsers(d); 
      replier.reply(result);
      return;
    }
    
    if (sub === "ì „ì²´ë³´ìƒ") {
      var item = parts[2];
      var amt = parseInt(parts[3], 10);
      if (!item || isNaN(amt) || amt <= 0) {
        replier.reply("ì‚¬ìš©ë²•: /ê´€ë¦¬ì ì „ì²´ë³´ìƒ ê³¨ë“œ 500");
        return;
      }
      if (!d.users) 
        d.users = {};
      var count = 0;
      for (var name in d.users) {
        if (!d.users.hasOwnProperty(name)) 
          continue;
        var uu = d.users[name];
        if (!uu) 
          continue;
        if (typeof uu.gold !== "number") 
          uu.gold = 0;
        if (typeof uu.trainerLv !== "number") 
          uu.trainerLv = 1;
        if (typeof uu.trainerExp !== "number") 
          uu.trainerExp = 0;
        if (typeof uu.dopaTicket !== "number") 
          uu.dopaTicket = 0;
        if (typeof uu.ball !== "number") 
          uu.ball = 0;
        if (typeof uu.superBall !== "number") 
          uu.superBall = 0;
        if (typeof uu.ultraBall !== "number") 
          uu.ultraBall = 0;
        if (!uu.pokemons) 
          uu.pokemons = [];
        if (item === "ê³¨ë“œ") 
          uu.gold += amt;
        else if (item === "ë„íŒŒë¯¼" || item === "ê°•í™”ê¶Œ") 
          uu.dopaTicket += amt;
        else if (item === "ëª¬ìŠ¤í„°ë³¼") 
          uu.ball += amt;
        else if (item === "ìŠˆí¼ë³¼") 
          uu.superBall += amt;
        else if (item === "í•˜ì´í¼ë³¼") 
          uu.ultraBall += amt;
        else {
          replier.reply("ì „ì²´ë³´ìƒ ê°€ëŠ¥ í•­ëª©: ê³¨ë“œ/ë„íŒŒë¯¼/ê°•í™”ê¶Œ/ëª¬ìŠ¤í„°ë³¼/ìŠˆí¼ë³¼/í•˜ì´í¼ë³¼");
          return;
        }
        count++;
      }
      addAdminLog(d, sender, "ì „ì²´ë³´ìƒ " + item + " +" + amt + " (ëŒ€ìƒ " + count + ")");
      commitSave(true);
      replier.reply("ì „ì²´ë³´ìƒ ì™„ë£Œ\n\n" + "í•­ëª©: " + item + "\n" + "ìˆ˜ëŸ‰: +" + amt + "\n" + "ëŒ€ìƒ: " + count + "ëª…");
      return;
    }
    if (sub === "ì¡°íšŒ") {
      var targetName = parts[2];
      var t = getUserByName(d, targetName);
      if (!t) {
        replier.reply("ëŒ€ìƒ ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      var uu = t.user;
      replier.reply("ìœ ì € ì¡°íšŒ: " + t.name + "\n\n" + "ë ˆë²¨: " + uu.trainerLv + "\n" + "ê²½í—˜ì¹˜: " + uu.trainerExp + "\n" + "ê³¨ë“œ: " + uu.gold + "ğŸ’°\n" + "ë³¼: ëª¬ìŠ¤í„°ë³¼ " + uu.ball + " | ìŠˆí¼ë³¼ " + uu.superBall + " | í•˜ì´í¼ë³¼ " + uu.ultraBall + "\n" + "ë„íŒŒë¯¼ê°•í™”ê¶Œ: " + uu.dopaTicket + "\n" + "ë³´ìœ  í¬ì¼“ëª¬ ìˆ˜: " + (uu.pokemons ? uu.pokemons.length : 0));
      return;
    }
    if (sub === "ì§€ê¸‰") {
      var tn = parts[2];
      var fieldK = parts[3];
      var amt2 = parseInt(parts[4], 10);
      var t2 = getUserByName(d, tn);
      if (!t2) {
        replier.reply("ëŒ€ìƒ ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      if (isNaN(amt2) || amt2 <= 0) {
        replier.reply("ì§€ê¸‰ ìˆ˜ëŸ‰ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        return;
      }
      var u2 = t2.user;
      if (fieldK === "ê³¨ë“œ") {
        u2.gold += amt2;
        addAdminLog(d, sender, "ì§€ê¸‰ " + t2.name + " ê³¨ë“œ +" + amt2);
      } else if (fieldK === "ê²½í—˜ì¹˜") {
        u2.trainerExp += amt2;
        addAdminLog(d, sender, "ì§€ê¸‰ " + t2.name + " ê²½í—˜ì¹˜ +" + amt2);
      } else if (fieldK === "ë ˆë²¨") {
        u2.trainerLv += amt2;
        if (u2.trainerLv < 1) 
          u2.trainerLv = 1;
        if (u2.trainerLv > 99) 
          u2.trainerLv = 99;
        addAdminLog(d, sender, "ì§€ê¸‰ " + t2.name + " ë ˆë²¨ +" + amt2);
      } else if (fieldK === "ëª¬ìŠ¤í„°ë³¼") {
        u2.ball += amt2;
        addAdminLog(d, sender, "ì§€ê¸‰ " + t2.name + " ëª¬ìŠ¤í„°ë³¼ +" + amt2);
      } else if (fieldK === "ìŠˆí¼ë³¼") {
        u2.superBall += amt2;
        addAdminLog(d, sender, "ì§€ê¸‰ " + t2.name + " ìŠˆí¼ë³¼ +" + amt2);
      } else if (fieldK === "í•˜ì´í¼ë³¼") {
        u2.ultraBall += amt2;
        addAdminLog(d, sender, "ì§€ê¸‰ " + t2.name + " í•˜ì´í¼ë³¼ +" + amt2);
      } else if (fieldK === "ë„íŒŒë¯¼" || fieldK === "ê°•í™”ê¶Œ") {
        u2.dopaTicket += amt2;
        addAdminLog(d, sender, "ì§€ê¸‰ " + t2.name + " ë„íŒŒë¯¼ê°•í™”ê¶Œ +" + amt2);
      } else {
        replier.reply("ì§€ê¸‰ ê°€ëŠ¥í•œ í•­ëª©: ê³¨ë“œ/ê²½í—˜ì¹˜/ë ˆë²¨/ëª¬ìŠ¤í„°ë³¼/ìŠˆí¼ë³¼/í•˜ì´í¼ë³¼/ë„íŒŒë¯¼/ê°•í™”ê¶Œ");
        return;
      }
      commitSave(true);
      replier.reply("ì§€ê¸‰ ì™„ë£Œ\n\n" + "ëŒ€ìƒ: " + t2.name + "\n" + "í•­ëª©: " + fieldK + "\n" + "ìˆ˜ëŸ‰: +" + amt2);
      return;
    }
    // /ê´€ë¦¬ì ì „ì ì´ˆê¸°í™”
if (sub === "ì „ì ì´ˆê¸°í™”") {
  var n = resetBattleStatsAll(d);
  commitSave(true);
  replier.reply("ë°°í‹€ ì „ì  ì´ˆê¸°í™” ì™„ë£Œ: " + n + "ëª…");
  return;
}

  // /ê´€ë¦¬ì ì „ì ì´ˆê¸°í™” ë‹‰ë„¤ì„
if (sub === "ì „ì ì´ˆê¸°í™”") {
  var target = parts[2]; // ì—†ìœ¼ë©´ ì „ì²´
  if (target) {
    var t = getUserByName(d, target);
    if (!t) { replier.reply("ëŒ€ìƒ ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
    resetBattleStats(t.user);
    commitSave(true);
    replier.reply("ë°°í‹€ ì „ì  ì´ˆê¸°í™” ì™„ë£Œ: " + t.name);
    return;
  }

  var n = resetBattleStatsAll(d);
  commitSave(true);
  replier.reply("ë°°í‹€ ì „ì  ì´ˆê¸°í™” ì™„ë£Œ: " + n + "ëª…");
  return;
}
    if (sub === "ì„¤ì •") {
      var tn3 = parts[2];
      var fieldK2 = parts[3];
      var val2 = parseInt(parts[4], 10);
      var t3 = getUserByName(d, tn3);
      if (!t3) {
        replier.reply("ëŒ€ìƒ ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      if (isNaN(val2)) {
        replier.reply("ì„¤ì • ê°’ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        return;
      }
      var u3 = t3.user;
      if (fieldK2 === "ë ˆë²¨") {
        u3.trainerLv = Math.max(1, Math.min(99, val2));
        addAdminLog(d, sender, "ì„¤ì • " + t3.name + " ë ˆë²¨=" + u3.trainerLv);
      } else if (fieldK2 === "ê²½í—˜ì¹˜") {
        u3.trainerExp = Math.max(0, val2);
        addAdminLog(d, sender, "ì„¤ì • " + t3.name + " ê²½í—˜ì¹˜=" + u3.trainerExp);
      } else if (fieldK2 === "ê³¨ë“œ") {
        u3.gold = Math.max(0, val2);
        addAdminLog(d, sender, "ì„¤ì • " + t3.name + " ê³¨ë“œ=" + u3.gold);
      } else if (fieldK2 === "ê°•í™”ê¶Œ" || fieldK2 === "ë„íŒŒë¯¼") {
        u3.dopaTicket = Math.max(0, val2);
        addAdminLog(d, sender, "ì„¤ì • " + t3.name + " ë„íŒŒë¯¼ê°•í™”ê¶Œ=" + u3.dopaTicket);
      } else {
        replier.reply("ì„¤ì • ê°€ëŠ¥í•œ í•­ëª©: ë ˆë²¨/ê²½í—˜ì¹˜/ê³¨ë“œ/ê°•í™”ê¶Œ/ë„íŒŒë¯¼");
        return;
      }
      commitSave(true);
      replier.reply("ì„¤ì • ì™„ë£Œ\n\n" + "ëŒ€ìƒ: " + t3.name + "\n" + "í•­ëª©: " + fieldK2 + "\n" + "ê°’: " + val2);
      return;
    }
    // ==================== í¬ì¼“ëª¬ ê°•í™” ì¡°ì • ====================
if (sub === "ê°•í™”") {
  var targetName = parts[2];
  var uid = parseInt(parts[3], 10);
  var enh = parseInt(parts[4], 10);

  if (!targetName || isNaN(uid) || isNaN(enh)) {
    replier.reply(
      "ì‚¬ìš©ë²•: /ê´€ë¦¬ì ê°•í™” ë‹‰ë„¤ì„ í¬ì¼“ëª¬UID ê°•í™”ìˆ˜ì¹˜\n" +
      "ì˜ˆ: /ê´€ë¦¬ì ê°•í™” ì†ì‚¬ì¥ 123 15"
    );
    return;
  }

  enh = Math.max(0, Math.min(ENHANCE_MAX, enh));

  var t = getUserByName(d, targetName);
  if (!t) {
    replier.reply("ëŒ€ìƒ ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  var u2 = t.user;
  var list = u2.pokemons || [];
  var p = null;

  for (var i = 0; i < list.length; i++) {
    if (list[i].uid === uid) {
      p = list[i];
      break;
    }
  }

  if (!p) {
    replier.reply("í•´ë‹¹ UIDì˜ í¬ì¼“ëª¬ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  var before = p.enh || 0;
  p.enh = enh;

  // ìë™ ì§„í™” ì²´í¬ (ìˆìœ¼ë©´)
  if (typeof tryAutoEvolveByEnh === "function") {
    tryAutoEvolveByEnh(p);
  }

  var dbp = findPokemonDB(p.pid);
  var name = dbp ? dbp.name : "í¬ì¼“ëª¬";

  addAdminLog(
    d,
    sender,
    "ê°•í™”ì¡°ì • " + t.name + " #" + uid + " " + before + "â†’" + enh
  );

  commitSave(true);

  replier.reply(
    "ğŸ›  ìš´ì˜ì ê°•í™” ì¡°ì • ì™„ë£Œ\n\n" +
    "ëŒ€ìƒ: " + t.name + "\n" +
    "í¬ì¼“ëª¬: #" + uid + " " + name + "\n" +
    "ê°•í™” ë‹¨ê³„: " + before + "ê°• â†’ " + enh + "ê°•"
  );
  return;
}
    if (sub === "í¬ì¼“ëª¬") {
      var tn4 = parts[2];
      var t4 = getUserByName(d, tn4);
      if (!t4) {
        replier.reply("ëŒ€ìƒ ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      var list = t4.user.pokemons || [];
      if (list.length === 0) {
        replier.reply("ëŒ€ìƒ ìœ ì €ê°€ ë³´ìœ í•œ í¬ì¼“ëª¬ì´ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      var out = "í¬ì¼“ëª¬ ëª©ë¡: " + t4.name + "\n\n";
      for (var i = 0; i < list.length; i++) {
        var pp = list[i];
        var dbp = findPokemonDB(pp.pid);
        var nm = dbp ? dbp.name : ("PID " + pp.pid);
        out += "#" + pp.uid + " " + nm + " " + (pp.enh || 0) + "ê°•\n";
      }
      replier.reply(out);
      return;
    }
    if (sub === "í¬ì¼“ëª¬ì§€ê¸‰") {
      var tnP = parts[2];
      var pokeKey = parts[3];
      if (!tnP || !pokeKey) {
        replier.reply("ì‚¬ìš©ë²•: /ê´€ë¦¬ì í¬ì¼“ëª¬ì§€ê¸‰ ë‹‰ë„¤ì„ í¬ì¼“ëª¬ëª…(or ID)");
        return;
      }
      var tP = getUserByName(d, tnP);
      if (!tP) {
        replier.reply("ëŒ€ìƒ ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      var dbp = null;
      var pid = parseInt(pokeKey, 10);
      if (!isNaN(pid)) {
        // ìˆ«ìë©´ ê¸°ì¡´ findPokemonDBë¥¼ ìš°ì„  ì‚¬ìš©
        if (typeof findPokemonDB === "function") 
          dbp = findPokemonDB(pid);
        if (!dbp && typeof POKEMON_DB !== "undefined" && POKEMON_DB && POKEMON_DB.length) {
          for (var i = 0; i < POKEMON_DB.length; i++) {
            var it = POKEMON_DB[i];
            if (!it) 
              continue;
            if (it.id === pid || it.pid === pid || it.no === pid || it.num === pid) {
              dbp = it;
              break;
            }
          }
        }
      } else {
        // ë¬¸ìì—´ì´ë©´ ì´ë¦„ ê²€ìƒ‰
        dbp = findPokemonDBByName(pokeKey);
      }
      if (!dbp) {
        replier.reply("í•´ë‹¹ í¬ì¼“ëª¬ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ì´ë¦„/ë²ˆí˜¸ í™•ì¸)");
        return;
      }
      var uP = tP.user;
      if (!uP.pokemons) 
        uP.pokemons = [];
      var newUid = nextPokemonUIDForUser(uP);
      // dbpì˜ id/pid ì¤‘ ë­ê°€ ì‹¤ì œ ë²ˆí˜¸ì¸ì§€ ëª¨í˜¸í•  ìˆ˜ ìˆì–´ì„œ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
      var realPid = (typeof dbp.id === "number") ? dbp.id : (typeof dbp.pid === "number" ? dbp.pid : pid);
      var newPoke = {
  uid: newUid, 
  pid: realPid, 
  enh: 0};
      uP.pokemons.push(newPoke);
      // ë„ê° ê¸°ë¡ ì²˜ë¦¬ (ìˆìœ¼ë©´)
      if (typeof dexSeen === "function") {
        dexSeen(uP, realPid);
      }
      var nm = dbp.name ? dbp.name : ("PID " + realPid);
      addAdminLog(d, sender, "í¬ì¼“ëª¬ì§€ê¸‰ " + tP.name + " " + nm + " #" + newUid);
      commitSave(true);
      replier.reply("í¬ì¼“ëª¬ ì§€ê¸‰ ì™„ë£Œ\n\n" + "ëŒ€ìƒ: " + tP.name + "\n" + "í¬ì¼“ëª¬: " + nm + "\n" + "UID: #" + newUid);
      return;
    }
    if (sub === "í¬ì¼“ëª¬ì‚­ì œ") {
      var tn5 = parts[2];
      var uidStr = (parts[3] || "").replace("#", "").trim();
      var uid = parseInt(uidStr, 10);
      var t5 = getUserByName(d, tn5);
      if (!t5) {
        replier.reply("ëŒ€ìƒ ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      if (isNaN(uid)) {
        replier.reply("ì‚¬ìš©ë²•: /ê´€ë¦¬ì í¬ì¼“ëª¬ì‚­ì œ ë‹‰ë„¤ì„ #í¬ì¼“ëª¬UID");
        return;
      }
      var arr = t5.user.pokemons || [];
      var idx = -1;
      for (var j = 0; j < arr.length; j++) {
        if (arr[j].uid === uid) {
          idx = j;
          break;
        }
      }
      if (idx < 0) {
        replier.reply("í•´ë‹¹ UIDì˜ í¬ì¼“ëª¬ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      var gone = arr[idx];
      var goneDb = findPokemonDB(gone.pid);
      var goneName = goneDb ? goneDb.name : ("PID " + gone.pid);
      arr.splice(idx, 1);
      addAdminLog(d, sender, "í¬ì¼“ëª¬ì‚­ì œ " + t5.name + " #" + uid + " " + goneName);
      commitSave(true);
      replier.reply("ì‚­ì œ ì™„ë£Œ\n\n" + "ëŒ€ìƒ: " + t5.name + "\n" + "í¬ì¼“ëª¬: #" + uid + " " + goneName);
      return;
    }
    replier.reply("ì•Œ ìˆ˜ ì—†ëŠ” ìš´ì˜ì ëª…ë ¹ì…ë‹ˆë‹¤.\n/ê´€ë¦¬ì ë„ì›€ ì„ í™•ì¸í•˜ì„¸ìš”.");
    return;
  }
  if (!d.users) 
    d.users = {};
  if (!d.lastSpawnByRoom) 
    d.lastSpawnByRoom = {};
  if (!d.regionByRoom) 
    d.regionByRoom = {};
      // -------------------- [ë³µêµ¬ ì‹œìŠ¤í…œ] ì•„ì¹´ì´ë¸Œ í™•ì¸ --------------------
     // -------------------- [ë³µêµ¬ ì‹œìŠ¤í…œ] ì•„ì¹´ì´ë¸Œ í™•ì¸ (ìˆ˜ì •ë¨) --------------------
  if (!d.users[sender]) {
    var archivePath = "/sdcard/mbot_pokemon_archive.json"; 
    var file = new java.io.File(archivePath); // íŒŒì¼ ê°ì²´ ìƒì„±

    // [í•µì‹¬ ìˆ˜ì •] íŒŒì¼ì´ ìˆì„ ë•Œë§Œ ì½ê¸° ì‹œë„
    if (file.exists()) {
      var archiveStr = File.read(archivePath);
      if (archiveStr) {
        try {
          var archive = JSON.parse(archiveStr);
          if (archive[sender]) {
            // ë³µêµ¬ ì§„í–‰
            d.users[sender] = archive[sender];
            d.users[sender].lastDate = new Date().getTime();
            
            delete archive[sender];
            File.save(archivePath, JSON.stringify(archive)); // êº¼ëƒˆìœ¼ë‹ˆ íŒŒì¼ ê°±ì‹ 
            
            commitSave(true);
            replier.reply("ğŸ“¦ íœ´ë©´ ê³„ì •ì´ì—ˆë˜ " + sender + "ë‹˜ì˜ ë°ì´í„°ë¥¼ ë³µêµ¬í–ˆìŠµë‹ˆë‹¤!\në‹¤ì‹œ ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤! ğŸ‰");
          }
        } catch (e) { /* íŒŒì‹± ì—ëŸ¬ ë¬´ì‹œ */ }
      }
    }
  }
  // ------------------------------------------------------------------
  if (msg === "/íšŒì›ê°€ì…") {
    if (ensureUser(d, sender)) {
      commitSave(true);
      replier.reply("íšŒì›ê°€ì… ì™„ë£Œ!\n/í•„ë“œ ë¡œ í¬ì¼“ëª¬ì„ ë§Œë‚˜ë³´ì„¸ìš”.");
    } else {
      replier.reply("ì´ë¯¸ íšŒì›ì…ë‹ˆë‹¤.");
    }
    return;
  }
  var u = d.users[sender];
  if (!u) {
    replier.reply("ë¨¼ì € /íšŒì›ê°€ì… ì„ í•´ì£¼ì„¸ìš”.");
    return;
  }
  normalizeUserData(u);
  // âœ… ì‹ ê·œ íšŒì›ê°€ì… ë³´ìƒ (ë”± 1íšŒ)
  var joinMsg = grantSignupBonusIfNeeded(u, sender);
  if (joinMsg) {
    replier.reply(joinMsg);
    commitSave(true);
  }
// -------------------- [ìˆ˜ì •ë¨] /ë‚´ì •ë³´ (ì•„ì´í…œ ëª©ë¡ ì œê±°) --------------------
  if (msg === "/ë‚´ì •ë³´") {
    ensureUserStats(u);
    // EXP ì§„í–‰ë¥ 
    var need = expNeed(u.trainerLv);
    var cur = u.trainerExp;
    var pctExp = (need <= 0) ? 0 : Math.floor((cur / need) * 1000) / 10;
    
    // ê°„ë‹¨ ì§„í–‰ ë°” (10ì¹¸)
    var barN = 10;
    var filled = Math.max(0, Math.min(barN, Math.floor((cur / need) * barN)));
    var bar = "";
    for (var i = 0; i < barN; i++) bar += (i < filled ? "â– " : "â–¡");
    
    // ì „ì /ë­í¬
    var w = u.stats.battleWin, l = u.stats.battleLose, d0 = u.stats.battleDraw;
    var total = w + l + d0;
    var winRate = (total === 0) ? 0 : Math.floor((w / total) * 1000) / 10;
    
    // ë„ê° ìˆ˜ì§‘ë¥ 
    ensureUserDex(u);
    var uniqueCaught = 0;
    for (var i = 0; i < POKEMON_DB.length; i++) {
      var pid = String(POKEMON_DB[i].id);
      var rec = u.dex[pid] || { seen: 0, caught: 0 };
      if (rec.caught > 0) uniqueCaught++;
    }
    var dexRate = (POKEMON_DB.length === 0) ? 0 : Math.floor((uniqueCaught / POKEMON_DB.length) * 1000) / 10;

    var out = "";
    out += "ğŸ‘¤ " + sender + "ë‹˜ì˜ íŠ¸ë ˆì´ë„ˆ ì •ë³´\n\n";
    out += "Lv." + u.trainerLv + " (" + pctExp + "%)\n";
    out += bar + "  " + cur + "/" + need + " EXP\n\n";
    
    out += "ğŸ’° ì¬í™”: " + fmtNum(u.gold) + "ğŸ’°\n";
    out += "ğŸ’ ë³´ìœ  ì•„ì´í…œì€ '/ë‚´ê°€ë°©'ìœ¼ë¡œ í™•ì¸í•˜ì„¸ìš”.\n\n";
    
    out += "ğŸ¾ ì»¬ë ‰ì…˜\n";
    out += "ë³´ìœ  í¬ì¼“ëª¬: " + u.pokemons.length + "ë§ˆë¦¬\n";
    out += "ë„ê°: " + uniqueCaught + "/" + POKEMON_DB.length + " (" + dexRate + "%)\n\n";
    
    out += "âš”ï¸ ë°°í‹€\n";
    out += "ì „ì : " + w + "ìŠ¹ " + l + "íŒ¨" + (d0 > 0 ? (" " + d0 + "ë¬´") : "") + "\n";
    out += "ìŠ¹ë¥ : " + winRate + "% | ì—°ìŠ¹: " + u.stats.battleStreak + " | ë­í‚¹ì ìˆ˜: " + battleScoreRank(u);
    
    replier.reply(out);
    commitSave(false);
    return;
  }

  // -------------------- [ìˆ˜ì •ë¨] /ì •ë³´ (ì•„ì´í…œ ëª©ë¡ ì œê±°) --------------------
  if (msg.indexOf("/ì •ë³´") === 0) {
    var t = getTargetFromMsg(d, sender, msg, "/ì •ë³´");
    if (!t) {
      replier.reply("í•´ë‹¹ ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }
    var target = t.user;
    var targetName = t.name;
    
    ensureUserStats(target);
    ensureUserDex(target);
    
    // EXP ì§„í–‰ë¥ 
    var need = expNeed(target.trainerLv);
    var cur = target.trainerExp;
    var pctExp = (need <= 0) ? 0 : Math.floor((cur / need) * 1000) / 10;
    
    // ê°„ë‹¨ ì§„í–‰ ë°”
    var barN = 10;
    var filled = (need <= 0) ? 0 : Math.max(0, Math.min(barN, Math.floor((cur / need) * barN)));
    var bar = "";
    for (var i = 0; i < barN; i++) bar += (i < filled ? "â– " : "â–¡");
    
    // ì „ì 
    var w = target.stats.battleWin, l = target.stats.battleLose, d0 = target.stats.battleDraw;
    var total = w + l + d0;
    var winRate = (total === 0) ? 0 : Math.floor((w / total) * 1000) / 10;
    
    // ë„ê°
    var uniqueCaught = 0;
    for (var j = 0; j < POKEMON_DB.length; j++) {
      var pid = String(POKEMON_DB[j].id);
      var rec = target.dex[pid] || { seen: 0, caught: 0 };
      if (rec.caught > 0) uniqueCaught++;
    }
    var dexRate = (POKEMON_DB.length === 0) ? 0 : Math.floor((uniqueCaught / POKEMON_DB.length) * 1000) / 10;

    var out = "";
    out += "ğŸ‘¤ " + targetName + "ë‹˜ì˜ íŠ¸ë ˆì´ë„ˆ ì •ë³´\n\n";
    out += "Lv." + target.trainerLv + " (" + pctExp + "%)\n";
    out += bar + "  " + cur + "/" + need + " EXP\n\n";
    
    out += "ğŸ’° ì¬í™”: " + fmtNum(target.gold) + "ğŸ’°\n";
    // íƒ€ì¸ ê°€ë°©ì€ ì•ˆ ë³´ì—¬ì£¼ëŠ” ê²Œ ê¹”ë”í•©ë‹ˆë‹¤.
    
    out += "\nğŸ¾ ì»¬ë ‰ì…˜\n";
    out += "ë³´ìœ  í¬ì¼“ëª¬: " + (target.pokemons ? target.pokemons.length : 0) + "ë§ˆë¦¬\n";
    out += "ë„ê°: " + uniqueCaught + "/" + POKEMON_DB.length + " (" + dexRate + "%)\n\n";
    
    out += "âš”ï¸ ë°°í‹€\n";
    out += "ì „ì : " + w + "ìŠ¹ " + l + "íŒ¨" + (d0 > 0 ? (" " + d0 + "ë¬´") : "") + "\n";
    out += "ìŠ¹ë¥ : " + winRate + "% | ì—°ìŠ¹: " + target.stats.battleStreak + " | ë­í‚¹ì ìˆ˜: " + battleScoreRank(target);
    
    replier.reply(out);
    commitSave(false);
    return;
  }
// -------------------- [ì‹ ê·œ] ë‚´ê°€ë°© (ì¸ë²¤í† ë¦¬) --------------------
  if (msg === "/ë‚´ê°€ë°©") {
    var list = "";
    list += "ğŸ”´ ëª¬ìŠ¤í„°ë³¼: " + fmtNum(u.ball) + "ê°œ\n";
    list += "ğŸ”µ ìŠˆí¼ë³¼: " + fmtNum(u.superBall) + "ê°œ\n";
    list += "âš« í•˜ì´í¼ë³¼: " + fmtNum(u.ultraBall) + "ê°œ\n";
    list += "ğŸ’³ ë„íŒŒë¯¼ê°•í™”ê¶Œ: " + fmtNum(u.dopaTicket) + "ì¥\n";
    list += "ğŸª ë‘ì«€ì¿ (í™•ì •ê°•í™”): " + fmtNum(u.cookie) + "ê°œ\n";
    list += "ğŸ« ì´ë™í‹°ì¼“: " + fmtNum(u.ticket) + "ì¥\n";
    list += "ğŸ”„ ë“±ê¸‰ì¬ì„¤ì •ê¶Œ: " + fmtNum(u.reroll) + "ì¥";

    replier.reply("ğŸ’ " + sender + "ë‹˜ì˜ ê°€ë°©\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + list);
    return;
  }
// -------------------- [ì‹ ê·œ] ì•„ì´í…œ ì‚¬ìš© ì‹œìŠ¤í…œ --------------------
  if (msg.indexOf("/ì‚¬ìš©") === 0) {
    var parts = msg.split(" ").filter(Boolean);
    var itemCmd = parts[1]; // ë‘ì«€ì¿ , ì´ë™, ì¬ì„¤ì •

    // 1. ë‘ì«€ì¿  (í™•ì • +1ê°•)
    if (itemCmd === "ë‘ì«€ì¿ " || itemCmd === "ì¿ í‚¤") {
      var uid = parseInt(parts[2], 10);
      if (!uid) { replier.reply("ì‚¬ìš©ë²•: /ì‚¬ìš© ë‘ì«€ì¿  [í¬ì¼“ëª¬UID]\nì˜ˆ: /ì‚¬ìš© ë‘ì«€ì¿  15"); return; }
      
      if (!u.cookie || u.cookie <= 0) { replier.reply("ğŸª ë‘ì«€ì¿ ê°€ ì—†ìŠµë‹ˆë‹¤. ìƒì ì—ì„œ êµ¬ë§¤í•´ì£¼ì„¸ìš”."); return; }
      
      var p = findUserPokemonByUid(u, uid);
      if (!p) { replier.reply("í•´ë‹¹ í¬ì¼“ëª¬ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
      if (p.enh >= 30) { replier.reply("ì´ë¯¸ ìµœëŒ€ ê°•í™”(30ê°•) ìƒíƒœì…ë‹ˆë‹¤."); return; }

      u.cookie--;
      p.enh++; // 100% ì„±ê³µ
      
      commitSave(true);
      var db = findPokemonDB(p.pid);
      replier.reply("ğŸª ëƒ ëƒ ... ë‘ì«€ì¿ ë¥¼ ë¨¹ì—ˆìŠµë‹ˆë‹¤!\n\nâœ¨ " + (db?db.name:"í¬ì¼“ëª¬") + " ê°•í™” ì„±ê³µ!\nğŸ”¥ " + (p.enh-1) + "ê°• â†’ " + p.enh + "ê°•");
      return;
    }

    // 2. ì´ë™í‹°ì¼“ (ì§€ì—­ ì´ë™)
    if (itemCmd === "ì´ë™" || itemCmd === "í‹°ì¼“") {
      var regionName = parts[2];
      // ì§€ì—­ ëª©ë¡ í™•ì¸
      var validRegions = REGIONS.map(function(r){ return r.key; });
      
      if (!regionName) {
        replier.reply("ì‚¬ìš©ë²•: /ì‚¬ìš© ì´ë™ [ì§€ì—­ëª…]\nğŸ« ê°ˆ ìˆ˜ ìˆëŠ” ì§€ì—­:\n" + validRegions.join(", "));
        return;
      }
      
      // ìœ íš¨í•œ ì§€ì—­ì¸ì§€ ì²´í¬
      var foundRegion = null;
      for (var i=0; i<REGIONS.length; i++) {
        if (REGIONS[i].key === regionName) { foundRegion = REGIONS[i].key; break; }
      }
      
      if (!foundRegion) {
        replier.reply("ğŸš« ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì§€ì—­ì…ë‹ˆë‹¤.\nê°ˆ ìˆ˜ ìˆëŠ” ì§€ì—­:\n" + validRegions.join(", "));
        return;
      }

      if (!u.ticket || u.ticket <= 0) { replier.reply("ğŸ« ì´ë™í‹°ì¼“ì´ ì—†ìŠµë‹ˆë‹¤. ìƒì ì—ì„œ êµ¬ë§¤í•´ì£¼ì„¸ìš”."); return; }

      u.ticket--;
      u.nextFieldRegion = foundRegion; // ë‹¤ìŒ í•„ë“œ íƒìƒ‰ ì‹œ ì´ ì§€ì—­ í™•ì •
      
      commitSave(true);
      replier.reply("ğŸ« í‹°ì¼“ì„ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤!\n\nğŸš€ ë‹¤ìŒ '/í•„ë“œ' íƒìƒ‰ ì‹œ [" + foundRegion + "] ì§€ì—­ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
      return;
    }

    // 3. ì¬ì„¤ì •ê¶Œ (ë“±ê¸‰/IV ëœë¤ ë³€ê²½)
    if (itemCmd === "ì¬ì„¤ì •" || itemCmd === "ì¬ì„¤ì •ê¶Œ") {
      var uid = parseInt(parts[2], 10);
      if (!uid) { replier.reply("ì‚¬ìš©ë²•: /ì‚¬ìš© ì¬ì„¤ì • [í¬ì¼“ëª¬UID]\nì˜ˆ: /ì‚¬ìš© ì¬ì„¤ì • 50"); return; }
      
      if (!u.reroll || u.reroll <= 0) { replier.reply("ğŸ”„ ë“±ê¸‰ì¬ì„¤ì •ê¶Œì´ ì—†ìŠµë‹ˆë‹¤. ìƒì ì—ì„œ êµ¬ë§¤í•´ì£¼ì„¸ìš”."); return; }

      var p = findUserPokemonByUid(u, uid);
      if (!p) { replier.reply("í•´ë‹¹ í¬ì¼“ëª¬ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }

      u.reroll--;
      
      var oldGrade = p.grade || "D";
      var newGrade = generatePokemonGrade(); // ëœë¤ ë“±ê¸‰ ìƒì„±
      var newIVs = generateIVsByGrade(newGrade); // í•´ë‹¹ ë“±ê¸‰ì— ë§ëŠ” IV ìƒì„±
      
      // ë°ì´í„° ê°±ì‹ 
      p.grade = newGrade;
      p.ivStr = newIVs.str;
      p.ivHp = newIVs.hp;
      p.ivSpd = newIVs.spd;

      // ë„ê°ì—ë„ ê°±ì‹ ëœ ë“±ê¸‰ ë°˜ì˜
      dexCaught(u, p.pid, newGrade);
      
      commitSave(true);
      
      var db = findPokemonDB(p.pid);
      replier.reply(
        "ğŸ”„ ë“±ê¸‰ ì¬ì„¤ì • ì™„ë£Œ!\n" + (db?db.name:"í¬ì¼“ëª¬") + "ì˜ ì ì¬ë ¥ì´ ë³€í™”í–ˆìŠµë‹ˆë‹¤.\n\n" +
        "ê¸°ì¡´: [" + oldGrade + "] ë“±ê¸‰\nâ¬‡ï¸\n" +
        "ê²°ê³¼: ã€ " + newGrade + " ã€‘ ë“±ê¸‰\n\n" +
        "ğŸ“Š ë³€ê²½ëœ ìŠ¤íƒ¯\n" +
        "âš”ï¸ í˜: " + p.ivStr + "/15\n" +
        "â¤ï¸ ì²´ë ¥: " + Math.floor(p.ivHp/10) + "/15\n" +
        "âš¡ ê³µì†: " + p.ivSpd + "/15"
      );
      return;
    }

    replier.reply("ì‚¬ìš©ë²•:\n/ì‚¬ìš© ë‘ì«€ì¿  [UID]\n/ì‚¬ìš© ì´ë™ [ì§€ì—­ëª…]\n/ì‚¬ìš© ì¬ì„¤ì • [UID]");
    return;
  }
  // -------------------- [ìˆ˜ì •ë¨] /ë‚´í¬ì¼“ëª¬ (ì €ì¥ í™•ì‹¤ì‹œ) --------------------
  if (msg === "/ë‚´í¬ì¼“ëª¬") {
    if (!u.pokemons || u.pokemons.length === 0) {
      replier.reply(sender + "ë‹˜ì€ ë³´ìœ í•œ í¬ì¼“ëª¬ì´ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    // 1. ë“±ê¸‰ì´ ì—†ìœ¼ë©´ ë¶€ì—¬í•˜ê³ , ë³€ê²½ì‚¬í•­ì´ ìˆìœ¼ë©´ "ê°•ì œ ì €ì¥"
    var needSave = ensurePokemonGrades(u);
    if (needSave) {
      saveData(d); // â˜… íŒŒì¼ì— ì¦‰ì‹œ ì €ì¥
      // (í…ŒìŠ¤íŠ¸ìš©) ì €ì¥í–ˆë‹¤ëŠ” ì‚¬ì‹¤ì„ ì•Œ ìˆ˜ ìˆê²Œ ë¡œê·¸ë¥¼ ë„ìš¸ ìˆ˜ë„ ìˆìŒ
      // replier.reply("[ì‹œìŠ¤í…œ] êµ¬í˜• í¬ì¼“ëª¬ ë°ì´í„°ë¥¼ ì‹ í˜•(ë“±ê¸‰ì œ)ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ì €ì¥í–ˆìŠµë‹ˆë‹¤.");
    }

    var summary = "ğŸ’ " + sender + "ë‹˜ì˜ ë³´ìœ  í¬ì¼“ëª¬\n" + "ì´ " + u.pokemons.length + "ë§ˆë¦¬\n\n" + "ì „ì²´ë³´ê¸°ë¡œ ëª©ë¡ì„ í™•ì¸í•˜ì„¸ìš”.";
    var full = "\n\n[ë³´ìœ  í¬ì¼“ëª¬ ëª©ë¡]\n\n";
    
    // 2. ì €ì¥ëœ ë°ì´í„°ë¥¼ ì •ë ¬ (ì—¬ê¸°ì„œëŠ” ê°’ ë³€ê²½ ì ˆëŒ€ ì—†ìŒ)
    // sortPokemonsByPowerê°€ ì›ë³¸ì„ ê±´ë“œë¦¬ì§€ ì•Šë„ë¡ slice()ë¡œ ë³µì‚¬ë³¸ ì‚¬ìš©
    var listCopy = u.pokemons.slice(); 
    var sorted = sortPokemonsByPower(listCopy);

    for (var i = 0; i < sorted.length; i++) {
      var p = sorted[i];
      var power = calcBattlePower(p);
      var dbp = findPokemonDB(p.pid);
      var name = dbp ? dbp.name : "ì•Œìˆ˜ì—†ìŒ";
      var enh = (p.enh && p.enh > 0) ? (p.enh + "ê°•") : "0ê°•";
      // ì´ì œ p.gradeëŠ” ë¬´ì¡°ê±´ íŒŒì¼ì—ì„œ ë¶ˆëŸ¬ì˜¨ ê³ ì •ê°’ì´ì–´ì•¼ í•¨
      var grade = p.grade || "D"; 
      
      full += (i + 1) + ". #" + p.uid + " " + name + " " + enh + " | ì „íˆ¬ë ¥ " + power + " | [" + grade + "ë“±ê¸‰]\n";
    }

    replyFold(replier, summary, full);
    return;
  }

// -------------------- /íŒë§¤ í•˜ìœ„ N --------------------
if (msg.indexOf("/íŒë§¤ í•˜ìœ„") === 0) {
  var sp = msg.split(" ").filter(Boolean);
  var n = parseInt(sp[2], 10);

  if (isNaN(n) || n <= 0) {
    replier.reply("ì‚¬ìš©ë²•: /íŒë§¤ í•˜ìœ„ 5");
    return;
  }

  if (!u.pokemons || u.pokemons.length <= 1) {
    replier.reply("íŒë§¤í•  í¬ì¼“ëª¬ì´ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  var sorted = sortPokemonsByPower(u.pokemons); // ë†’ì€ ìˆœ
  var maxSell = Math.min(n, sorted.length - 1);
  var targets = sorted.slice(sorted.length - maxSell); // ë‚®ì€ ì• ë“¤

  var totalGold = 0;
  var soldLines = [];

  for (var i = u.pokemons.length - 1; i >= 0; i--) {
    var p = u.pokemons[i];

    for (var j = 0; j < targets.length; j++) {
      if (p.uid === targets[j].uid) {
        var db = findPokemonDB(p.pid);
        var name = db ? db.name : "í¬ì¼“ëª¬";
        var price = sellPrice(p.pid, p.enh);

        u.pokemons.splice(i, 1);
        totalGold += price;

        soldLines.push("#" + p.uid + " " + name + " " + (p.enh || 0) + "ê°• (+" + fmtNum(price) + "ğŸ’°)");
        break;
      }
    }
  }

  u.gold += totalGold;
  commitSave(true);

  replier.reply(
    sayDo(sender, "í•˜ìœ„ í¬ì¼“ëª¬ íŒë§¤ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.") +
    "\n\nğŸ§¾ íŒë§¤ ë‚´ì—­\n" + soldLines.join("\n") +
    "\n\nğŸ’° ì´ íšë“ ê³¨ë“œ: +" + fmtNum(totalGold) + "ğŸ’°" +
    "\nğŸ’° ì”ì—¬ ê³¨ë“œ: " + fmtNum(u.gold) + "ğŸ’°"
  );
  return;
}
// -------------------- /íŒë§¤ (ë‹¨ì¼/ë‹¤ì¤‘ UID) --------------------
if (msg.indexOf("/íŒë§¤") === 0) {
  var sp2 = msg.split(" ").filter(Boolean);

  if (sp2.length < 2) {
    replier.reply("ì‚¬ìš©ë²•:\n/íŒë§¤ 12\n/íŒë§¤ 12 15 19\n/íŒë§¤ í•˜ìœ„ 5");
    return;
  }

  if (!u.pokemons || u.pokemons.length === 0) {
    replier.reply("íŒë§¤í•  í¬ì¼“ëª¬ì´ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  if (u.pokemons.length <= 1) {
    replier.reply("ë³´ìœ  í¬ì¼“ëª¬ì´ 1ë§ˆë¦¬ì¼ ë•ŒëŠ” íŒë§¤í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  var uidList = [];
  for (var a = 1; a < sp2.length; a++) {
    var v = parseInt(sp2[a], 10);
    if (!isNaN(v) && v > 0 && uidList.indexOf(v) === -1) uidList.push(v);
  }

  if (uidList.length === 0) {
    replier.reply("í¬ì¼“ëª¬IDê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.\nì˜ˆ: /íŒë§¤ 12 15 19");
    return;
  }

  var soldLines2 = [];
  var notFound = [];
  var blockedLines = [];
  var totalGold2 = 0;

  var foundMap = {};
  for (var i2 = 0; i2 < uidList.length; i2++) foundMap[uidList[i2]] = false;

  for (var si = u.pokemons.length - 1; si >= 0; si--) {
    var pSell = u.pokemons[si];
    if (uidList.indexOf(pSell.uid) === -1) continue;

    foundMap[pSell.uid] = true;

    if (u.pokemons.length <= 1) {
      blockedLines.push("#" + pSell.uid + "(ë§ˆì§€ë§‰ 1ë§ˆë¦¬ ë³´í˜¸)");
      continue;
    }

    var dbSell = findPokemonDB(pSell.pid);
    var nm = dbSell ? dbSell.name : ("í¬ì¼“ëª¬(" + pSell.pid + ")");
    var price2 = sellPrice(pSell.pid, pSell.enh);

    u.pokemons.splice(si, 1);
    totalGold2 += price2;

    soldLines2.push("#" + pSell.uid + " " + nm + " " + (pSell.enh || 0) + "ê°• (+" + fmtNum(price2) + "ğŸ’°)");
  } // âœ… ì—¬ê¸° ì¶”ê°€: for (si...) ë‹«ê¸°

  for (var k = 0; k < uidList.length; k++) {
    if (!foundMap[uidList[k]]) notFound.push("#" + uidList[k]);
  }

  if (soldLines2.length === 0) {
    var msgFail = "íŒë§¤ ê°€ëŠ¥í•œ í¬ì¼“ëª¬ì´ ì—†ìŠµë‹ˆë‹¤.";
    if (notFound.length) msgFail += "\n\nì°¾ì§€ ëª»í•œ ID: " + notFound.join(", ");
    if (blockedLines.length) msgFail += "\n\níŒë§¤ ì œí•œ: " + blockedLines.join(", ");
    replier.reply(msgFail);
    return;
  }

  u.gold += totalGold2;
  commitSave(true);

  var out =
    sayDo(sender, "ìš”ì²­í•˜ì‹  í¬ì¼“ëª¬ íŒë§¤ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.") +
    "\n\nğŸ§¾ íŒë§¤ ë‚´ì—­\n" + soldLines2.join("\n") +
    "\n\nğŸ’° ì´ íšë“ ê³¨ë“œ: +" + fmtNum(totalGold2) + "ğŸ’°" +
    "\nğŸ’° ì”ì—¬ ê³¨ë“œ: " + fmtNum(u.gold) + "ğŸ’°";

  if (notFound.length) out += "\n\nğŸ” ì°¾ì§€ ëª»í•œ ID\n" + notFound.join(", ");
  if (blockedLines.length) out += "\n\nâ›” íŒë§¤ ì œí•œ\n" + blockedLines.join(", ");

  replier.reply(out);
  return;
} // âœ… ì—¬ê¸° ì¶”ê°€: if ("/íŒë§¤") ë¸”ë¡ ë‹«ê¸°

 if (msg === "/ë„ì›€") {
  var summary = "ì£ ë´‡ í¬ì¼“ëª¬ ëª…ë ¹ì–´\n\n";
  summary += "ìì£¼ ì“°ëŠ” ëª…ë ¹ì–´\n";
  summary += "/í•„ë“œ /ëª¬ /ìŠˆ /í•˜ /ë„ë§(/ã…Œã…Œ)\n";
  summary += "/ë‚´í¬ì¼“ëª¬ /ê°•í™” /ë„íŒŒë¯¼\n";
  summary += "/ìƒì  /êµ¬ë§¤ /íŒë§¤\n";
  summary += "/ë°°í‹€ /ì „ì  /ë­í‚¹\n";
  summary += "\nì „ì²´ë³´ê¸°ë¡œ ì „ì²´ ëª©ë¡ì„ í™•ì¸í•˜ì„¸ìš”.";

  var full = "\n\n[ì „ì²´ ëª…ë ¹ì–´]\n\n";

  full += "ê¸°ë³¸\n";
  full += "/íšŒì›ê°€ì…\n";
  full += "/ë‚´ì •ë³´\n";
  full += "/ì •ë³´ ë‹‰ë„¤ì„\n";
  full += "ì˜ˆ: /ì •ë³´ ì†ì‚¬ì¥\n";
  full += "/ë‚´í¬ì¼“ëª¬\n";
  full += "/í¬ì¼“ëª¬ ë‹‰ë„¤ì„\n";
  full += "ì˜ˆ: /í¬ì¼“ëª¬ ì†ì‚¬ì¥\n";
  full += "/ë„ê°\n";
  full += "/ë„ê° ë‹‰ë„¤ì„\n";
  full += "ì˜ˆ: /ë„ê° ì†ì‚¬ì¥\n\n";

  full += "ì•¼ìƒ / í¬íš\n";
  full += "/í•„ë“œ\n";
  full += "/ëª¬ìŠ¤í„°ë³¼ ë˜ëŠ” /ëª¬ ë˜ëŠ” /ã…\n";
  full += "/ìŠˆí¼ë³¼ ë˜ëŠ” /ìŠˆ ë˜ëŠ” /ã……\n";
  full += "/í•˜ì´í¼ë³¼ ë˜ëŠ” /í•˜ ë˜ëŠ” /ã…\n";
  full += "/ë„ë§(/ã…Œã…Œ)\n\n";

  full += "íƒí—˜ / ì„±ì¥\n";
  full += "/íƒí—˜\n";
  full += "/ê°•í™” í¬ì¼“ëª¬ID\n";
  full += "ì˜ˆ: /ê°•í™” 12\n";
  full += "/ë„íŒŒë¯¼ í¬ì¼“ëª¬ID\n";
  full += "ì˜ˆ: /ë„íŒŒë¯¼ 12\n\n";

  full += "ìƒì  / ê²½ì œ\n";
  full += "/ìƒì \n";
  full += "/êµ¬ë§¤ ì•„ì´í…œ ìˆ˜ëŸ‰\n";
  full += "ì˜ˆ: /êµ¬ë§¤ ëª¬ìŠ¤í„°ë³¼ 5\n";
  full += "ì˜ˆ: /êµ¬ë§¤ ë„íŒŒë¯¼ 1\n";
  full += "/íŒë§¤ í¬ì¼“ëª¬ID...\n";
  full += "ì˜ˆ: /íŒë§¤ 12\n";
  full += "ì˜ˆ: /íŒë§¤ 12 15 19\n";
  full += "/íŒë§¤ í•˜ìœ„ N\n";
  full += "ì˜ˆ: /íŒë§¤ í•˜ìœ„ 5\n\n";

  full += "ë°°í‹€\n";
  full += "/ë°°í‹€\n";
  full += "/ë°°í‹€ì—°ì† N\n";
  full += "ì˜ˆ: /ë°°í‹€ì—°ì† 5\n";
  full += "/ì „ì \n\n";

  full += "ë­í‚¹\n";
  full += "/ë­í‚¹ ë°°í‹€\n";
  full += "/ë­í‚¹ ë„ê°\n";
  full += "/ë­í‚¹ ì „íˆ¬ë ¥\n";

  replyFold(replier, summary, full);
  return;
}

  if (msg === "/ìƒì ") {
    replier.reply(shopText(d, u, sender));
    return;
  }
  if (msg.indexOf("/êµ¬ë§¤") === 0) {
    var parts = msg.split(" ").filter(Boolean);
    if (parts.length < 2) {
      replier.reply("ì‚¬ìš©ë²•: /êµ¬ë§¤ ëª¬ìŠ¤í„°ë³¼ 5");
      return;
    }
    var item = parts[1];
    var qty = 1;
    if (parts.length >= 3) {
      qty = parseInt(parts[2], 10);
      if (isNaN(qty)) 
        qty = 1;
    }
    var rBuy = buyItem(d, u, sender, item, qty);
    if (rBuy.ok) {
      commitSave(true);
      replier.reply(rBuy.msg);
    } else {
      replier.reply(rBuy.reason);
    }
    return;
  }
// -------------------- [ìˆ˜ì •ë¨] /í•„ë“œ (ì´ë™ í‹°ì¼“ ì ìš©) --------------------
  if (msg === "/í•„ë“œ") {
    // 1. í˜„ì¬ í•„ë“œì— ì´ë¯¸ í¬ì¼“ëª¬ì´ ìˆëŠ”ì§€ í™•ì¸
    var currentWild = getWild(d, room);
    if (currentWild) {
      var dbWild = findPokemonDB(currentWild.pid);
      replier.reply("âš ï¸ ì´ë¯¸ í•„ë“œì— " + dbWild.name + "ê°€ ë‚˜íƒ€ë‚˜ ìˆìŠµë‹ˆë‹¤!\ní¬íší•˜ì‹œê±°ë‚˜ /ë„ë§(/ã…Œã…Œ) í›„ì— ë‹¤ì‹œ íƒìƒ‰í•´ì£¼ì„¸ìš”.");
      return;
    }

    var now = nowMs();
    if (now - u.lastFieldAt < FIELD_COOLDOWN_MS) {
      var remain = FIELD_COOLDOWN_MS - (now - u.lastFieldAt);
      var sec = Math.ceil(remain / 1000);
      replier.reply(sayDo(sender, pick(COOLDOWN_LINES)) + "\nâ³ " + sec + "ì´ˆ í›„ ë‹¤ì‹œ í•„ë“œë¥¼ íƒìƒ‰í•  ìˆ˜ ìˆì–´ìš”.");
      return;
    }
    u.lastFieldAt = now;

    var region = "";
    
    // [ì‹ ê·œ ê¸°ëŠ¥] ì´ë™ í‹°ì¼“ì„ ì‚¬ìš©í•´ì„œ ì˜ˆì•½ëœ ì§€ì—­ì´ ìˆëŠ”ì§€ í™•ì¸
    if (u.nextFieldRegion) {
      region = u.nextFieldRegion;
      u.nextFieldRegion = ""; // ì‚¬ìš©í–ˆìœ¼ë‹ˆ ì´ˆê¸°í™” (1íšŒì„±)
      replier.reply("ğŸš€ ì´ë™ í‹°ì¼“ íš¨ê³¼ ë°œë™! [" + region + "] ì§€ì—­ì— ë„ì°©í–ˆìŠµë‹ˆë‹¤.");
    } else {
      // ì˜ˆì•½ëœ ì§€ì—­ì´ ì—†ìœ¼ë©´ ê¸°ì¡´ì²˜ëŸ¼ ëœë¤ (ëƒ¥ì¹˜ì˜ ë°© ì œì™¸ ë¡œì§ í¬í•¨)
      region = getRoomRegion(d, room);
      var safetyNet = 0;
      while (region === "ëƒ¥ì¹˜ì˜ ë°©" && safetyNet < 10) {
        region = getRoomRegion(d, room);
        safetyNet++;
      }
      if (region === "ëƒ¥ì¹˜ì˜ ë°©") region = REGIONS[0].key;
    }

    // í¬ì¼“ëª¬ ìŠ¤í°
    var wild = spawnPokemonForRegion(region);
    setWild(d, room, wild.id);
    dexSeen(u, wild.id);
    commitSave(true);

    var dbw = findPokemonDB(wild.id);
    var rareLine = "";
    if (dbw && dbw.rarity === 5) {
      rareLine = sayDo(sender, pick(EMPHASIS_RARE5)) + "\n" + pick(EMPHASIS_LEGENDARY) + "\n\n";
    }
    
    var ballLine = "ğŸ’ ë³´ìœ  ë³¼\n" + "- ëª¬ìŠ¤í„°ë³¼: " + u.ball + "\n" + "- ìŠˆí¼ë³¼: " + u.superBall + "\n" + "- í•˜ì´í¼ë³¼: " + u.ultraBall + "\n\n";
    var guide = "ğŸ¯ í¬íš: /ëª¬(/ã…), /ìŠˆ(/ã……), /í•˜(/ã…)\n" + "ğŸƒ ë„ë§: /ë„ë§(/ã…Œã…Œ)\n" + "â³ " + Math.floor(SPAWN_EXPIRE_MS / 1000) + "ì´ˆ ì•ˆì— ì„ íƒ";
    
    replier.reply(sayDo(sender, pick(FIELD_SEARCH_LINES)) + "\n\n" + "[ì§€ì—­: " + region + "]\n\n" + rareLine + "âš¡ " + sayDo(sender, dbw.name + " ì™€(ê³¼) ë§ˆì£¼ì³¤ì–´ìš”!") + "\n" + pick(FIELD_ENCOUNTER_LINES) + "\n\n" + ballLine + guide);
    return;
  }
  
     // -------------------- [êµì •] ë„ë§ ì‹œìŠ¤í…œ (/ã…Œã…Œ í†µí•© ë° ì•ˆì „ ì¥ì¹˜) --------------------
  if (msg === "/ë„ë§" || msg === "/ã…Œã…Œ") {
    // 1. í˜„ì¬ ë°©ì˜ ì•¼ìƒ í¬ì¼“ëª¬ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    var targetW = d.lastSpawnByRoom[room];

    // 2. ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ì´ë¯¸ ë§Œë£Œ/ë„ë§ ìƒíƒœì¸ì§€ ì²´í¬
    if (!targetW || targetW.expired) {
      replier.reply("í•„ë“œì— ë§ˆì£¼ì¹œ í¬ì¼“ëª¬ì´ ì—†ê±°ë‚˜ ì´ë¯¸ ì‚¬ë¼ì¡ŒìŠµë‹ˆë‹¤.");
      return;
    }

    // 3. DBì—ì„œ ì´ë¦„ ì°¾ê¸° (targetW.pid ì‚¬ìš©)
    var dbw3 = findPokemonDB(targetW.pid);
    
    // ğŸŒŸ [í•µì‹¬ ìˆ˜ì •] dbw3ê°€ ì—†ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•œ ê¸°ë³¸ê°’ ì„¤ì • (ì˜¤ë¥˜ ë°©ì§€)
    var pName = (dbw3 && dbw3.name) ? dbw3.name : "ì•¼ìƒ í¬ì¼“ëª¬";

    // 4. í•„ë“œ ë°ì´í„° í™•ì‹¤íˆ ì‚­ì œ (clearWild ì—­í• )
    delete d.lastSpawnByRoom[room];
    
    // 5. ë³€ê²½ì‚¬í•­ ì €ì¥
    commitSave(true);

    // 6. ê²°ê³¼ ì „ì†¡ (ì•ˆì „í•˜ê²Œ ì²˜ë¦¬ëœ pName ì‚¬ìš©)
    replier.reply(sayDo(sender, pName + "ì—ê²Œì„œ ë¬´ì‚¬íˆ ë„ë§ì³¤ìŠµë‹ˆë‹¤! ğŸƒğŸ’¨"));
    return;
  }
   
  function handleCatch(ballType, ballName) {
  var wild = getWild(d, room); //
  if (!wild) { //
    var ex = takeExpiredWild(d, room); //
    if (ex) { //
      var dbx = findPokemonDB(ex.pid); //
      var name = dbx ? dbx.name : "ì•¼ìƒ í¬ì¼“ëª¬"; //
      commitSave(false); //
      if (ex.byEscape) replier.reply(name + "ì—ê²Œì„œ ì´ë¯¸ ë„ë§ì³¤ìŠµë‹ˆë‹¤.\n/í•„ë“œ ë¡œ ë‹¤ì‹œ íƒìƒ‰í•´ ì£¼ì„¸ìš”."); //
      else replier.reply(name + "ê°€(ì´) ë„ë§ê°”ìŠµë‹ˆë‹¤.\n/í•„ë“œ ë¡œ ë‹¤ì‹œ íƒìƒ‰í•´ ì£¼ì„¸ìš”."); //
      return; //
    }
    replier.reply(sayDo(sender, "í˜„ì¬ ì•¼ìƒ í¬ì¼“ëª¬ì´ ì—†ìŠµë‹ˆë‹¤.") + "\n/í•„ë“œ ë¡œ íƒìƒ‰í•´ ì£¼ì„¸ìš”."); //
    return; //
  }

  if (typeof wild.attempts !== "number") wild.attempts = 0; //
  if (typeof wild.maxAttempts !== "number") wild.maxAttempts = getMaxCatchAttempts(wild.pid); //

  if (!consumeBall(u, ballType)) { //
    replier.reply(ballName + "ì´(ê°€) ë¶€ì¡±í•©ë‹ˆë‹¤.\n/ìƒì  ì—ì„œ êµ¬ë§¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."); //
    return; //
  }

  var leftBallsLine = "ì”ì—¬ ë³¼: ëª¬ìŠ¤í„°ë³¼ " + u.ball + " | ìŠˆí¼ë³¼ " + u.superBall + " | í•˜ì´í¼ë³¼ " + u.ultraBall; //
  var t = tryCatch(u, wild.pid, ballType); //
  if (!t.ok) { //
    saveData(d); //
    replier.reply("í¬íš ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); //
    return; //
  }

  var db = findPokemonDB(wild.pid); //

  // ==================== [ìˆ˜ì •ëœ ì„±ê³µ ë¸”ë¡: 15ì  ë§Œì  í‘œê¸°] ====================
  if (t.success) {
    clearWild(d, room); 
    var uid = addPokemonToUser(u, wild.pid); 
    var p = findUserPokemonByUid(u, uid); // ë°©ê¸ˆ ì¡ì€ í¬ì¼“ëª¬ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    var reward = calcCatchRewards(u, wild.pid); 
    u.gold += reward.totalGold; 
    var lvMsg = addExpWithLevelUpMsg(u, reward.totalExp); 
    commitSave(true); 

    var fx = ""; 
    if (reward.legendary) fx = legendaryCatchFX(sender, db.name, reward); 

    // [UI ê°œì„ ] ì²´ë ¥ì€ ë‚´ë¶€ì ìœ¼ë¡œ í¬ì§€ë§Œ(150), ë³´ì—¬ì¤„ ë• 15ì  ë§Œì ìœ¼ë¡œ í™˜ì‚°
    var showHp = Math.floor((p.ivHp || 0) / 10); 
    // 0ì  ë°©ì§€ (ìµœì†Œ 1)
    if (showHp < 1) showHp = 1;

    var catchResultMsg = 
      fx +
      blockTitle("í¬íš ì„±ê³µ") +
      "ğŸ‰ " + sayDo(sender, db.name + " í¬íšì— ì„±ê³µí–ˆì–´ìš”!") + "\n\n" +
      "âœ¨ ë“±ê¸‰: ã€ " + (p.grade || "D") + " ë“±ê¸‰ ã€‘\n" +
      "ğŸ“Š ì ì¬ë ¥ (15ì  ë§Œì )\n" +
      "âš”ï¸ í˜ : " + (p.ivStr || 0) + " / 15\n" +
      "â¤ï¸ ì²´ë ¥: " + showHp + " / 15\n" +
      "âš¡ ê³µì†: " + (p.ivSpd || 0) + " / 15\n" +
      "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
      "ğŸ§¬ ë‚´ í¬ì¼“ëª¬ ID #" + uid + "\n" +
      "ğŸ’° ë³´ìƒ: +" + fmtNum(reward.totalGold) + "ğŸ’° / +" + reward.totalExp + "EXP\n" +
      (lvMsg ? ("\n" + lvMsg) : "") + "\n" +
      pick(CATCH_SUCCESS_LINES); 

    replier.reply(catchResultMsg); 
    return; 
  }
  // ==================== [ê¸°ì¡´ ì‹¤íŒ¨ ë¡œì§ ìœ ì§€] ====================
  wild.attempts += 1; //
  var leftTry = Math.max(0, wild.maxAttempts - wild.attempts); //
  var SAFE_FAILS = 2; //
  var escapePressure = 0; //
  if (wild.attempts > SAFE_FAILS) { //
    escapePressure = (wild.attempts - SAFE_FAILS) * 0.05; //
  }
  if (escapePressure > 0.35) escapePressure = 0.35; //
  if (wild.attempts >= wild.maxAttempts || Math.random() < escapePressure) { //
    wild.byEscape = true; //
    clearWild(d, room); //
    commitSave(true); //
    var escName = db ? db.name : "ì•¼ìƒ í¬ì¼“ëª¬"; //
    replier.reply("ğŸ’¨ " + escName + "ì´(ê°€) ê²½ê³„ì‹¬ì„ ëŠë¼ê³  ë„ë§ì³¤ìŠµë‹ˆë‹¤!\n\n" + "ğŸ¯ í¬íš ì‹œë„: " + wild.attempts + "/" + wild.maxAttempts + "\n" + "/í•„ë“œ ë¡œ ë‹¤ì‹œ íƒìƒ‰í•´ ì£¼ì„¸ìš”."); //
    return; //
  }
  commitSave(true); //
  replier.reply(blockTitle("í¬íš ì‹¤íŒ¨") + "ğŸ’¥ " + sayDo(sender, db.name + " í¬íšì— ì‹¤íŒ¨í–ˆì–´ìš”.") + "\n\n" + pick(CATCH_FAIL_DRIP_LINES) + "\n\n" + leftBallsLine + "\n\nğŸ¯ ë‚¨ì€ í¬íš ê¸°íšŒ: " + leftTry + "íšŒ" + "\n\nğŸ’¡ " + pick(CATCH_FAIL_TIP_LINES) + "\n\n" + "ğŸ¯ í¬íš\n" + "/ëª¬ ë˜ëŠ” /ã…  â†’ ëª¬ìŠ¤í„°ë³¼\n" + "/ìŠˆ ë˜ëŠ” /ã……  â†’ ìŠˆí¼ë³¼\n" + "/í•˜ ë˜ëŠ” /ã…  â†’ í•˜ì´í¼ë³¼\n\n" + "ğŸƒ ë„ë§: /ë„ë§"); //
  return; //
}
  
  if (msg === "/ëª¬ìŠ¤í„°ë³¼" || msg === "/ëª¬" || msg === "/ã…") {
    handleCatch(0, "ëª¬ìŠ¤í„°ë³¼");
    return;
  }
  if (msg === "/ìŠˆí¼ë³¼" || msg === "/ìŠˆ" || msg === "/ã……") {
    handleCatch(1, "ìŠˆí¼ë³¼");
    return;
  }
  if (msg === "/í•˜ì´í¼ë³¼" || msg === "/í•˜" || msg === "/ã…") {
    handleCatch(2, "í•˜ì´í¼ë³¼");
    return;
  }
  
  // -------------------- [ìµœì¢…] ë„ê° ì‹œìŠ¤í…œ (ì™•ê´€ íš¨ê³¼ & ê°€ë…ì„± ê°œì„ ) --------------------
  if (msg.indexOf("/ë„ê°") === 0) {
    var t = getTargetFromMsg(d, sender, msg, "/ë„ê°");
    if (!t) {
      replier.reply("í•´ë‹¹ ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    var target = t.user;
    var targetName = t.name;

    ensureUserDex(target);

    var total = POKEMON_DB.length;
    var uniqueCaught = 0;

    for (var i = 0; i < POKEMON_DB.length; i++) {
      var id = String(POKEMON_DB[i].id);
      if (target.dex[id] && target.dex[id].caught > 0) uniqueCaught++;
    }

    var rate = Math.floor((uniqueCaught / total) * 1000) / 10;

    var summary =
      "ğŸ“– " + targetName + "ë‹˜ì˜ í¬ì¼“ëª¬ ë„ê°\n" +
      "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
      "âœ… íšë“: " + uniqueCaught + " / " + total + " (" + rate + "%)\n\n" +
      "ì „ì²´ë³´ê¸°ë¡œ ìƒì„¸ ëª©ë¡ì„ í™•ì¸í•˜ì„¸ìš”.";

    // ìƒì„¸ ëª©ë¡ ìƒë‹¨ í—¤ë”
    var full = "\n\n[ë„ê° ëª©ë¡ / ìµœê³  í‹°ì–´]\n" + "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n";
    
    for (var j = 0; j < POKEMON_DB.length; j++) {
      var pp = POKEMON_DB[j];
      var pid = String(pp.id);
      var rec = target.dex[pid] || { seen: 0, caught: 0, maxGrade: "" };
      
      var mark = rec.caught ? "âœ”" : rec.seen ? "ğŸ‘€" : "â–¡";
      
      // ë“±ê¸‰ ë° ì™•ê´€ ì²˜ë¦¬ ë¡œì§
      var tierMsg = "";
      if (rec.caught) {
        var grade = rec.maxGrade || "D";
        // Së“±ê¸‰ì¼ ê²½ìš° ì™•ê´€ ì¶”ê°€
        if (grade === "S") {
          tierMsg = " / [Së“±ê¸‰] ğŸ‘‘";
        } else {
          tierMsg = " / [" + grade + "ë“±ê¸‰]";
        }
      }

      full += mark + " #" + pp.id + " " + pp.name + tierMsg + "\n";
    }

    replyFold(replier, summary, full);
    return;
  }

// -------------------- [ìµœì¢… ê°œí¸] íƒí—˜ ì‹œìŠ¤í…œ (í™•ë¥  ì´ì›í™”) --------------------
  if (msg === "/íƒí—˜") {
    var now2 = nowMs();
    if (now2 - u.lastExploreAt < EXPLORE_COOLDOWN_MS) {
      var remain = EXPLORE_COOLDOWN_MS - (now2 - u.lastExploreAt);
      var sec = Math.ceil(remain / 1000);
      replier.reply(sayDo(sender, pick(COOLDOWN_LINES)) + "\nâ³ " + sec + "ì´ˆ í›„ ë‹¤ì‹œ íƒí—˜í•  ìˆ˜ ìˆì–´ìš”.");
      return;
    }
    u.lastExploreAt = now2;

    // íƒí—˜ì—ì„œ ëƒ¥ì¹˜ì˜ ë°©ì´ 10% í™•ë¥ ë¡œë§Œ ë‚˜ì˜¤ê²Œ í•˜ê³  ì‹¶ì„ ë•Œ
var region2;
if (Math.random() < 0.10) {
  region2 = "ëƒ¥ì¹˜ì˜ ë°©";
} else {
  region2 = getRoomRegion(d, room);
  while(region2 === "ëƒ¥ì¹˜ì˜ ë°©") region2 = getRoomRegion(d, room); // ì¼ë°˜ ì§€ì—­ë§Œ ë½‘ê¸°
}
    
    var gainGold = calcExploreGold(u);
    var gainExp = calcExploreExp();
    var extraLog = "";

    // 1. [ì•„ì´í…œ íšë“ í…Œì´ë¸” ì •ì˜]
    var itemPool = [
      { name: "ëª¬ìŠ¤í„°ë³¼", field: "ball", amt: 1 },
      { name: "ìŠˆí¼ë³¼", field: "superBall", amt: 1 },
      { name: "í•˜ì´í¼ë³¼", field: "ultraBall", amt: 1 },
      { name: "ë„íŒŒë¯¼ ê°•í™”ê¶Œ", field: "dopaTicket", amt: 1 }
    ];

    // 2. [ì§€ì—­ë³„ íŠ¹ìˆ˜ ë¡œì§]
    if (region2 === "ëƒ¥ì¹˜ì˜ ë°©") {
      // ğŸ± ëƒ¥ì¹˜ì˜ ë°©: ê³¨ë“œ ëŒ€í­ ìƒí–¥ ë° ë†’ì€ ì•„ì´í…œ í™•ë¥ 
      var goldBonus = randInt(55555, 123456); 
      gainGold += goldBonus;
      extraLog = "ğŸ± ã€ëƒ¥ì¹˜ì˜ ë°© ë°œê²¬!ã€‘\níƒí—˜í•˜ë‹¤ë³´ë‹ˆ ëƒ¥ì¹˜ì˜ ë°©ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤!\n\nğŸ’° ëƒ¥ì¹˜ì—ê²Œì„œ í›”ì¹œ ëˆ: +" + fmtNum(goldBonus) + "ğŸ’°\n";

      // ëƒ¥ì¹˜ì˜ ë°© ì•„ì´í…œ í™•ë¥ : 70% (ë§¤ìš° ë†’ìŒ)
      if (Math.random() < 0.70) {
        var picked = randomPick(itemPool);
        var bonusAmt = (picked.field === "ball") ? randInt(3, 6) : randInt(1, 2); // ëƒ¥ì¹˜ë°©ì€ ìˆ˜ëŸ‰ë„ ë” ë§ì´
        u[picked.field] = (u[picked.field] || 0) + bonusAmt;
        extraLog += "ğŸ ëƒ¥ì¹˜ì˜ ë¬¼ê±´: " + picked.name + " " + bonusAmt + "ê°œë¥¼ í›”ì³¤ìŠµë‹ˆë‹¤!\n\n";
      }
    } else {
      // ğŸŒ² ì¼ë°˜ ì§€ì—­ ì•„ì´í…œ í™•ë¥ : 8% (ë‚®ì€ í™•ë¥ ë¡œ ê¹œì§ ë“í…œ)
      if (Math.random() < 0.08) {
        var picked = randomPick(itemPool);
        u[picked.field] = (u[picked.field] || 0) + picked.amt;
        extraLog = "ğŸ íƒí—˜ ì¤‘ ë°”ë‹¥ì—ì„œ ë¬´ì–¸ê°€ ë°˜ì§ì´ëŠ” ê²ƒì„ ì£¼ì› ìŠµë‹ˆë‹¤!\nğŸ“¦ ì•„ì´í…œ íšë“: " + picked.name + " " + picked.amt + "ê°œ\n\n";
      }
    }

    // 3. [í¬ì¼“ëª¬ íšë“ ë¡œì§] - ëª¨ë“  ì§€ì—­ ê³µí†µ (ë‚®ì€ í™•ë¥ )
    var pokeChance = getExplorePokemonChance(u.trainerLv);
    var gotPoke = (Math.random() < pokeChance);
    var pokeLog = "";

    if (gotPoke) {
      var found = spawnPokemonForRegion(region2);
      dexSeen(u, found.id);
      var uid2 = addPokemonToUser(u, found.id);
      var db2 = findPokemonDB(found.id);
      pokeLog = "ğŸ¾ ì•¼ìƒ í¬ì¼“ëª¬ ë°œê²¬!\n" + db2.name + " (#" + uid2 + ") ê°€ í•©ë¥˜í–ˆìŠµë‹ˆë‹¤!";
    }

    // 4. ë³´ìƒ ì •ì‚° ë° ì €ì¥
    u.gold += gainGold;
    var lvMsg = addExpWithLevelUpMsg(u, gainExp);
    commitSave(true);

    // 5. ê²°ê³¼ ì¶œë ¥
    var header = "ğŸ§­ " + sayDo(sender, "íƒí—˜ ê²°ê³¼") + "\n";
    var body = "ğŸ“ ì§€ì—­: " + region2 + "\n" +
               "ğŸ§­ ë³´ìƒ: +" + fmtNum(gainGold) + "ğŸ’° / +" + gainExp + "EXP\n" +
               (lvMsg ? (lvMsg + "\n") : "") + "\n" +
               (extraLog ? extraLog : "ì£¼ë³€ì— íŠ¹ë³„í•œ ë¬¼ê±´ì€ ë³´ì´ì§€ ì•ŠìŠµë‹ˆë‹¤.\n") +
               pokeLog;

    replier.reply(header + "\n" + body);
    return;
  }
  if (msg === "/ì „ì ") {
    ensureUserStats(u);
    var total = u.stats.battleWin + u.stats.battleLose + u.stats.battleDraw;
    if (total === 0) {
      replier.reply("ì•„ì§ ë°°í‹€ ì „ì ì´ ì—†ìŠµë‹ˆë‹¤.\n/ë°°í‹€ ë¡œ ì²« ì „íˆ¬ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”.");
      return;
    }
    replier.reply(sender + "ë‹˜ì˜ ë°°í‹€ ì „ì \n\n" + formatRecord(u));
    return;
  }
  if (msg.indexOf("/ê°•í™”") === 0) {
    var nowE = nowMs();
    if (nowE - u.lastEnhanceAt < ENHANCE_COOLDOWN_MS) {
      var remain = ENHANCE_COOLDOWN_MS - (nowE - u.lastEnhanceAt);
      var sec = Math.ceil(remain / 1000);
      replier.reply(sayDo(sender, pick(COOLDOWN_LINES)) + "\nâ³ " + sec + "ì´ˆ í›„ ë‹¤ì‹œ ê°•í™”ë¥¼ ì‹œë„í•  ìˆ˜ ìˆì–´ìš”.");
      return;
    }
    u.lastEnhanceAt = nowE;
    var spE = msg.split(" ");
    if (spE.length < 2) {
      replier.reply("ì‚¬ìš©ë²•: /ê°•í™” í¬ì¼“ëª¬ID\nì˜ˆ: /ê°•í™” 12");
      return;
    }
    var uidEnh = parseInt(spE[1], 10);
    if (!uidEnh) {
      replier.reply("í¬ì¼“ëª¬IDê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      return;
    }
    if (!u.pokemons || u.pokemons.length === 0) {
      replier.reply("ê°•í™”í•  í¬ì¼“ëª¬ì´ ì—†ìŠµë‹ˆë‹¤.\n/í•„ë“œ ë˜ëŠ” /íƒí—˜ ìœ¼ë¡œ í¬ì¼“ëª¬ì„ ì–»ì–´ë³´ì„¸ìš”.");
      return;
    }
    var idxE = -1;
    for (var ei = 0; ei < u.pokemons.length; ei++) {
      if (u.pokemons[ei].uid === uidEnh) {
        idxE = ei;
        break;
      }
    }
    if (idxE < 0) {
      replier.reply("í•´ë‹¹ í¬ì¼“ëª¬ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n/ë‚´í¬ì¼“ëª¬ ìœ¼ë¡œ IDë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.");
      return;
    }
    var p = u.pokemons[idxE];
    var dbp = findPokemonDB(p.pid);
    var pName = dbp ? dbp.name : "í¬ì¼“ëª¬";
    // ê°•í™” ìƒí•œ
    if (p.enh >= ENHANCE_MAX) {
      replier.reply("ì´ë¯¸ ìµœëŒ€ ê°•í™” ë‹¨ê³„ì…ë‹ˆë‹¤. (" + ENHANCE_MAX + "ê°•)");
      return;
    }
    var before = p.enh;
    var nextEnh = before + 1;
    // ë¹„ìš©
    var rarity = dbp ? dbp.rarity : 2;
    var cost = enhanceCostByRarity(nextEnh, rarity);
    if (u.gold < cost) {
      replier.reply(
  sender + "ë‹˜, ê°•í™” ë¹„ìš©ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.\n" +
  "í•„ìš” ê³¨ë“œ: " + fmtNum(cost) + "ğŸ’°\n" +
  "ë³´ìœ  ê³¨ë“œ: " + fmtNum(u.gold) + "ğŸ’°"
); return;
    }
    u.gold -= cost;
    // í™•ë¥ í‘œ + íŒì • (ì¼ë°˜ê°•í™”: ì„±ê³µ/ìœ ì§€ë§Œ)
    var rates = enhanceRatesByRarity(nextEnh, u.trainerLv, rarity);
    var roll = Math.random();
    if (roll < rates.success) {
      var after = before + 1;
      p.enh = after;
      var evoLine = tryAutoEvolveByEnh(p);
      var outMsg = buildEnhResultMsg(sender, pName, before, after, ENH_RESULT_UP);
      if (evoLine) 
        outMsg += "\n\nğŸŒŸ ì§„í™”! " + evoLine;
      outMsg += buildNextEnhInfoLine(p, ENH_RESULT_UP, u);
      commitSave(true);
      replier.reply(outMsg);
      return;
    } else {
      var outMsg2 = buildEnhResultMsg(sender, pName, before, before, ENH_RESULT_KEEP);
      outMsg2 += buildNextEnhInfoLine(p, ENH_RESULT_KEEP, u);
      commitSave(true);
      replier.reply(outMsg2);
      return;
    }
  }
  if (msg === "/ì¶œì„" || msg === "/ì¶œì„ì²´í¬") {
    var r = doAttendanceCheck(u, sender);
    commitSave(true);
    replier.reply(r.msg);
    return;
  }
  if (msg.indexOf("/ë„íŒŒë¯¼") === 0) {
    var spD = msg.split(" ");
    if (spD.length < 2) {
      replier.reply("ì‚¬ìš©ë²•: /ë„íŒŒë¯¼ í¬ì¼“ëª¬ID\nì˜ˆ: /ë„íŒŒë¯¼ 12");
      return;
    }
    var uidD = parseInt(spD[1], 10);
    if (!uidD) {
      replier.reply("í¬ì¼“ëª¬IDê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      return;
    }
    if (!u.pokemons || u.pokemons.length === 0) {
      replier.reply("ê°•í™”í•  í¬ì¼“ëª¬ì´ ì—†ìŠµë‹ˆë‹¤.\n/í•„ë“œ ë˜ëŠ” /íƒí—˜ ìœ¼ë¡œ í¬ì¼“ëª¬ì„ ì–»ì–´ë³´ì„¸ìš”.");
      return;
    }
    if (typeof u.dopaTicket !== "number") 
      u.dopaTicket = 0;
    if (u.dopaTicket <= 0) {
      replier.reply("ë„íŒŒë¯¼ê°•í™”ê¶Œì´ ì—†ìŠµë‹ˆë‹¤.\n/ìƒì  ì—ì„œ ë„íŒŒë¯¼ê°•í™”ê¶Œì„ êµ¬ë§¤í•  ìˆ˜ ìˆì–´ìš”.");
      return;
    }
    var idxD = -1;
    for (var di = 0; di < u.pokemons.length; di++) {
      if (u.pokemons[di].uid === uidD) {
        idxD = di;
        break;
      }
    }
    if (idxD < 0) {
      replier.reply("í•´ë‹¹ í¬ì¼“ëª¬ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n/ë‚´í¬ì¼“ëª¬ ìœ¼ë¡œ IDë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.");
      return;
    }
    var pD = u.pokemons[idxD];
    var dbD = findPokemonDB(pD.pid);
    var pNameD = dbD ? dbD.name : "í¬ì¼“ëª¬";
    if (pD.enh >= ENHANCE_MAX) {
      replier.reply("ì´ë¯¸ ìµœëŒ€ ê°•í™” ë‹¨ê³„ì…ë‹ˆë‹¤. (" + ENHANCE_MAX + "ê°•)");
      return;
    }
    u.dopaTicket -= 1;
    var before = (typeof pD.enh === "number") ? pD.enh : 0;
    var res = rollDopaEnhance();
    var header = "ğŸ’¥ ë„íŒŒë¯¼ ê°•í™” ì‹œë„!\n" + sender + "ë‹˜ì´ ìˆ¨ì„ ê³ ë¦…ë‹ˆë‹¤...\n" + "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n";
    // -------------------- UP --------------------
    if (res.kind === "UP") {
      var after = Math.min(ENHANCE_MAX, before + (res.up || 0));
      var realUp = after - before;      // ìº¡ ë°˜ì˜í•œ ì‹¤ì œ ìƒìŠ¹ëŸ‰
      pD.enh = after;
      var evoLine = tryAutoEvolveByEnh(pD);
      var out = header;
      // ğŸŒŒ ì´ˆëŒ€ì„±ê³µ(8ê°• ì´ìƒ)
      if (realUp >= 8) {
        out += "ğŸŒŒğŸŒŒğŸŒŒ ì´ˆ ëŒ€ ì„± ê³µ ğŸŒŒğŸŒŒğŸŒŒ\n\n" + "âš ï¸ ì „ì„¤ê¸‰ í­ì£¼ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤!\n" + "í•œ ë²ˆì— +" + realUp + "ê°• ìƒìŠ¹!\n\n" + "ğŸ”¥ " + before + "ê°• â†’ " + after + "ê°• ğŸ”¥\n" + "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + "ğŸ† " + sender + "ë‹˜ì´ " + pNameD + "ì„(ë¥¼) +" + after + "ê°•ê¹Œì§€ ì˜¬ë ¸ìŠµë‹ˆë‹¤!\n";
      } else if (realUp >= 5) {
        out += "âš¡âš¡âš¡ ëŒ€ ì„± ê³µ âš¡âš¡âš¡\n\n" + "ğŸ’¥ ë„íŒŒë¯¼ í•œê³„ ëŒíŒŒ!\n" + "+" + realUp + "ê°• í­ì£¼ ìƒìŠ¹!\n\n" + "ğŸ”¥ " + before + "ê°• â†’ " + after + "ê°• ğŸ”¥\n";
      } else {
        out += "âœ¨âœ¨ ì„±ê³µ! âœ¨âœ¨\n\n" + "ğŸ“ˆ ê°•í™” í­ì£¼ ë°œìƒ!\n" + "+" + realUp + "ê°• ìƒìŠ¹!\n\n" + before + "ê°• â†’ " + after + "ê°•\n";
      }
      if (evoLine) {
        out += "\n\nğŸŒŸ ì§„í™” ë°œìƒ!\n" + evoLine;
      }
      out += "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + "ğŸ« ì”ì—¬ ë„íŒŒë¯¼ê°•í™”ê¶Œ: " + u.dopaTicket + "ê°œ";
      commitSave(true);
      replier.reply(out);
      return;
    }
    if (res.kind === "KEEP") {
      commitSave(true);
      replier.reply(header + "ğŸ’¨ ì•„ìŠ¬ì•„ìŠ¬...\n\n" + "ê°•í™”ëŠ” ì‹¤íŒ¨í–ˆì§€ë§Œ,\n" + "í¬ì¼“ëª¬ì´ ë²„í…¨ëƒˆìŠµë‹ˆë‹¤.\n\n" + before + "ê°• â†’ " + before + "ê°• (ìœ ì§€)\n" + "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + "ğŸ« ì”ì—¬ ë„íŒŒë¯¼ê°•í™”ê¶Œ: " + u.dopaTicket + "ê°œ");
      return;
    }
    if (res.kind === "RESET0") {
      pD.enh = 0;
      commitSave(true);
      replier.reply(header + "ğŸ’¥ ê°•í™” í­ì£¼ ì‹¤íŒ¨!\n\n" + "ê°•í™” ì—ë„ˆì§€ê°€ ì—­ë¥˜í–ˆìŠµë‹ˆë‹¤...\n\n" + before + "ê°• â†’ ğŸ’€ 0ê°• ì´ˆê¸°í™”\n" + "ğŸ“‰ ì†ì‹¤: -" + before + "ê°•\n" + "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + "ğŸ« ì”ì—¬ ë„íŒŒë¯¼ê°•í™”ê¶Œ: " + u.dopaTicket + "ê°œ");
      return;
    }
    u.pokemons.splice(idxD, 1);
    commitSave(true);
    replier.reply(header + "â˜ ï¸ ì¹˜ëª…ì  ì‹¤íŒ¨ â˜ ï¸\n\n" + pNameD + "ì˜ í˜ì´ ê°ë‹¹ í•œê³„ë¥¼ ë„˜ì—ˆìŠµë‹ˆë‹¤.\n\n" + "í¬ì¼“ëª¬ì´ ì‚¬ë¼ì¡ŒìŠµë‹ˆë‹¤...\n" + "ğŸ§¾ í˜„ì¬ ë³´ìœ  í¬ì¼“ëª¬ ìˆ˜: " + u.pokemons.length + "ë§ˆë¦¬\n" + "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" + "ğŸ« ì”ì—¬ ë„íŒŒë¯¼ê°•í™”ê¶Œ: " + u.dopaTicket + "ê°œ");
    return;
  }
  // -------------------- /ë°°í‹€ --------------------
if (msg === "/ë°°í‹€" || msg.indexOf("/ë°°í‹€ ") === 0) {
  ensureUserStats(u);

  // âœ… í•¨ìˆ˜ ì¡´ì¬ ì²´í¬ (ìš”ì¦˜ ë„ˆ ì—ëŸ¬ ë‚œ í•µì‹¬ì´ ì´ê±°ì˜€ìŒ)
  if (typeof getBattleEligiblePokemons !== "function") {
    replier.reply("ë°°í‹€ ì‹œìŠ¤í…œ ë¡œë”© ì˜¤ë¥˜: getBattleEligiblePokemons í•¨ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.\në°°í‹€ ìœ í‹¸ í•¨ìˆ˜ ì˜ì—­ì— í•´ë‹¹ í•¨ìˆ˜ê°€ ì„ ì–¸ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.");
    return;
  }

  var nowB = nowMs();
  if (nowB - u.stats.lastBattleAt < BATTLE_COOLDOWN_MS) {
    replier.reply(cooldownRemainMsg(sender, u.stats.lastBattleAt, BATTLE_COOLDOWN_MS, "ë°°í‹€"));
    return;
  }
  u.stats.lastBattleAt = nowB;

  // /ë°°í‹€ #33 ì²˜ëŸ¼ uid ì§€ì • ê°€ëŠ¥
  var pickUid = null;
  if (msg !== "/ë°°í‹€") {
    var arg = msg.substring(3).trim(); // "/ë°°í‹€" ê¸¸ì´ 3
    arg = arg.replace("#", "").trim();
    pickUid = parseInt(arg, 10);
    if (isNaN(pickUid)) {
      replier.reply("ì‚¬ìš©ë²•: /ë°°í‹€ ë˜ëŠ” /ë°°í‹€ #ë²ˆí˜¸\nì˜ˆ) /ë°°í‹€ #33\n/ë‚´í¬ì¼“ëª¬ ì—ì„œ #ë²ˆí˜¸ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.");
      commitSave(false);
      return;
    }
  }

  var r1 = runSingleBattle(d, room, sender, u, pickUid);
  if (!r1.ok) {
    commitSave(false);
    replier.reply(r1.msg);
    return;
  }

  commitSave(true);
  replyFold(replier, r1.summary, r1.full);
  return;
}

// -------------------- [ìˆ˜ì •ë¨] /ë°°í‹€ì—°ì† (ë“±ê¸‰ ë°˜ì˜ ë° ì˜¤ë¥˜ ìˆ˜ì •) --------------------
if (msg.indexOf("/ë°°í‹€ì—°ì†") === 0) {
  ensureUserStats(u);

  if (typeof getBattleEligiblePokemons !== "function") {
    replier.reply("ë°°í‹€ ì‹œìŠ¤í…œ ë¡œë”© ì˜¤ë¥˜: getBattleEligiblePokemons í•¨ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.\në°°í‹€ ìœ í‹¸ í•¨ìˆ˜ ì˜ì—­ì— í•´ë‹¹ í•¨ìˆ˜ê°€ ì„ ì–¸ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.");
    return;
  }

  // 1. [ì•ˆì „ì¥ì¹˜] ë‚´ í¬ì¼“ëª¬ ë“±ê¸‰ ì—†ìœ¼ë©´ ì¦‰ì‹œ ìƒì„± ë° ì €ì¥
  if (ensurePokemonGrades(u)) saveData(d);

  // âœ… ì‹œì‘ ì „ì— ì°¸ê°€ ê°€ëŠ¥ ì—¬ë¶€ ë¨¼ì € ì²´í¬
  var myEligible0 = getBattleEligiblePokemons(u);
  if (myEligible0.length === 0) {
    replier.reply("ë°°í‹€ ì°¸ê°€ ì¡°ê±´: " + BATTLE_MIN_ENH + "ê°• ì´ìƒ í¬ì¼“ëª¬ì´ í•„ìš”í•©ë‹ˆë‹¤.\n/ê°•í™” ë¡œ " + BATTLE_MIN_ENH + "ê°• ì´ìƒì„ ë§Œë“  ë’¤ /ë°°í‹€ ì„ ì‹œë„í•´ ì£¼ì„¸ìš”.");
    return;
  }

  var sp = msg.split(" ").filter(Boolean);
  var n = 3;
  if (sp.length >= 2) n = parseInt(sp[1], 10);
  if (isNaN(n)) n = 3;
  n = Math.max(1, Math.min(MAX_BATTLE_CHAIN, n));

  var nowC = nowMs();
  if (nowC - u.stats.lastBattleAt < BATTLE_COOLDOWN_MS) {
    replier.reply(cooldownRemainMsg(sender, u.stats.lastBattleAt, BATTLE_COOLDOWN_MS, "ë°°í‹€"));
    return;
  }

  var win = 0, lose = 0, draw = 0;
  var totalGold = 0, totalExp = 0;
  var allSummary = "";
  var done = 0;

  // âœ… ë§ˆì§€ë§‰ 1íŒ ë¡œê·¸ë§Œ ë³´ê´€ (í¬ë˜ì‹œ ë°©ì§€)
  var lastFull = "";

  for (var i = 1; i <= n; i++) {
    // runSingleBattle í•¨ìˆ˜ê°€ ì´ë¯¸ ì˜¬ë°”ë¥´ê²Œ ìˆ˜ì •ë˜ì—ˆë‹¤ë©´ ê·¸ëŒ€ë¡œ í˜¸ì¶œí•´ë„ ë©ë‹ˆë‹¤.
    // ë‹¨, ì—°ì† ë°°í‹€ì—ì„œëŠ” `opt` ê°ì²´ë¥¼ í†µí•´ `isChain: true`ë¥¼ ì „ë‹¬í•´ì•¼ í•©ë‹ˆë‹¤.
    var rr = runSingleBattle(d, room, sender, u, null, {
      isChain: true,
      rewardMult: chainRewardMult(i)
    });

    if (!rr.ok) {
      allSummary += blockTitle("ë°°í‹€ì—°ì† ì¤‘ë‹¨") + rr.msg + "\n";
      break;
    }

    done++;

    if (rr.result === 1) win++;
    else if (rr.result === -1) lose++;
    else draw++;

    // ë³´ìƒ íŒŒì‹± ë¡œì§ ëŒ€ì‹  runSingleBattleì´ ë°˜í™˜í•˜ëŠ” ê°’ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¢‹ì„ ìˆ˜ë„ ìˆì§€ë§Œ,
    // í˜„ì¬ êµ¬ì¡°ìƒ runSingleBattleì€ ë³´ìƒì„ ì§ì ‘ ì§€ê¸‰í•˜ê³  summaryë§Œ ë°˜í™˜í•˜ë¯€ë¡œ
    // parseRewardLineì„ ì‚¬ìš©í•˜ì—¬ ë³´ìƒ ì´í•©ì„ ê³„ì‚°í•©ë‹ˆë‹¤.
    // (ì£¼ì˜: runSingleBattle ë‚´ë¶€ì—ì„œ ì´ë¯¸ u.gold ë“±ì„ ì¦ê°€ì‹œì¼°ìœ¼ë¯€ë¡œ ì—¬ê¸°ì„œ ë˜ ë”í•˜ë©´ ì¤‘ë³µ ì§€ê¸‰ë¨!)
    // ë”°ë¼ì„œ ì—¬ê¸°ì„œëŠ” totalGold, totalExpëŠ” 'í†µê³„ìš©'ìœ¼ë¡œë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.
    var reward = parseRewardLine(rr.summary);
    totalGold += reward.gold;
    totalExp += reward.exp;

    var resultShort = (rr.result === 1) ? "ìŠ¹" : (rr.result === -1) ? "íŒ¨" : "ë¬´";

    var vsText = "ë‚´ ? vs ?";
    if (rr.myPick && rr.oppPick) {
      vsText =
        "ë‚´ #" + rr.myPick.uid + " " + rr.myPick.name + " " + rr.myPick.enh + "ê°•" +
        " vs " +
        rr.oppPick.owner + " #" + rr.oppPick.uid + " " + rr.oppPick.name + " " + rr.oppPick.enh + "ê°•";
    }

    var oneLine =
      "ã€" + i + "/" + n + "ã€‘ " + vsText + " | " + resultShort +
      (reward.raw ? (" | " + reward.raw.replace("ğŸ ë³´ìƒ: ", "ë³´ìƒ: ")) : "");

    allSummary += oneLine + "\n";

    // âœ… ëˆ„ì  ê¸ˆì§€: ë§ˆì§€ë§‰ ë¡œê·¸ë§Œ ì €ì¥
    lastFull = rr.full;
  }

  // ì¿¨ë‹¤ìš´ ì²˜ë¦¬
  u.stats.lastBattleAt = nowC + Math.max(0, done - 1) * BATTLE_COOLDOWN_MS;

  var head =
    blockTitle("ì—°ì† ë°°í‹€ ê²°ê³¼") +
    sender + "ë‹˜ " + done + "ì—°ì „\n" +
    "ìš”ì•½: " + win + "ìŠ¹ " + lose + "íŒ¨" + (draw ? (" " + draw + "ë¬´") : "") + "\n" +
    "ì—°ì† ë°°í‹€ ë³´ìƒ í•©ê³„: +" + fmtNum(totalGold) + "ğŸ’° / +" + fmtNum(totalExp) + "EXP\n\n" +
    "ì „ì²´ë³´ê¸°ë¡œ ë§ˆì§€ë§‰ ë°°í‹€ ìƒì„¸ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.";

  // ëª¨ë“  ë°°í‹€ì´ ëë‚œ í›„ í•œ ë²ˆ ì €ì¥
  commitSave(true);

  var fullOut = lastFull ? ("\n\n[ë§ˆì§€ë§‰ ë°°í‹€ ë¡œê·¸]\n" + lastFull) : "";
  replyFold(replier, head + "\n\n" + allSummary.trim(), fullOut);
  return;
}

  if (msg === "/ë°°í‹€ë””ë²„ê·¸") {
    debugBattle(d, sender, MATCH_POOL, replier);
    return;
  } 
  // ========================= /ë­í‚¹ (ë„ê°/ì „íˆ¬ë ¥/ë°°í‹€) =========================
if (msg.indexOf("/ë­í‚¹") === 0) {
  var partsR = msg.split(" ").filter(Boolean);

  if (partsR.length < 2) {
    replier.reply(
      "ğŸ“Š ë­í‚¹ ì¢…ë¥˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.\n\n" +
      "- /ë­í‚¹ ë„ê°\n" +
      "- /ë­í‚¹ ì „íˆ¬ë ¥\n" +
      "- /ë­í‚¹ ë°°í‹€"
    );
    return;
  }

  var typeR = partsR[1];

  // ---------- ë„ê° ë­í‚¹ ----------
  if (typeR === "ë„ê°") {
    var data = buildDexRankingWithMyRank(d, 10, sender);

    if (!data.rows || data.rows.length === 0) {
      replier.reply("ì•„ì§ ë„ê° ê¸°ë¡ì´ ìˆëŠ” íŠ¸ë ˆì´ë„ˆê°€ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    var out = blockTitle("ğŸ“˜ ë„ê° ë­í‚¹ TOP 10\n(ìˆ˜ì§‘ë¥  ê¸°ì¤€)") + "\n";

    for (var i = 0; i < data.top.length; i++) {
      var rr = data.top[i];
      out += (i + 1) + "ìœ„. " + rr.name + " â€” " + rr.percent + "% (" + rr.count + "/" + data.total + ")\n";
    }

    out += "\n[ë‚´ ê¸°ë¡]\n";
    if (data.myIdx >= 0) {
      var me = data.rows[data.myIdx];
      out += (data.myIdx + 1) + "ìœ„. " + sender + " â€” " + me.percent + "% (" + me.count + "/" + data.total + ")";
    } else {
      out += "ë„ê° ê¸°ë¡ì´ ì—†ì–´ ìˆœìœ„ì— í¬í•¨ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
    }

    replier.reply(out);
    return;
  }

  // ---------- ì „íˆ¬ë ¥ ë­í‚¹ ----------
  if (typeR === "ì „íˆ¬ë ¥") {
    var pack = buildBattlePowerRanking(d, 7, sender);
    var rows = pack.rows;

    if (!rows || rows.length === 0) {
      replier.reply("ë­í‚¹ì„ í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. (í¬ì¼“ëª¬ ë³´ìœ  ìœ ì € ì—†ìŒ)");
      return;
    }

    var topN = pack.topN;
    var summaryN = Math.min(3, rows.length);

    var head = "ì „íˆ¬ë ¥ ë­í‚¹\n\n";
    for (var s = 0; s < summaryN; s++) {
      var r0 = rows[s];
      head += (s + 1) + "ìœ„ " + r0.name + " | ì „íˆ¬ë ¥ " + r0.power +
        " (#" + r0.uid + " " + r0.pName + " " + r0.enh + "ê°•)\n";
    }
    head += "\nì „ì²´ë³´ê¸°ë¡œ TOP " + topN + " ë° ë‚´ ê¸°ë¡ì„ í™•ì¸í•˜ì„¸ìš”.";

    var full = "\n\n[ì „íˆ¬ë ¥ ë­í‚¹ TOP " + topN + "]\n\n";
    for (var t = 0; t < Math.min(topN, rows.length); t++) {
      var r1 = rows[t];
      full += (t + 1) + "ìœ„ " + r1.name + " | ì „íˆ¬ë ¥ " + r1.power +
        " | #" + r1.uid + " " + r1.pName + " " + r1.enh + "ê°•\n";
    }

    full += "\n\n[ë‚´ ê¸°ë¡]\n\n";
    if (pack.myIdx >= 0) {
      var my = rows[pack.myIdx];
      full += (pack.myIdx + 1) + "ìœ„ " + sender + " | ì „íˆ¬ë ¥ " + my.power +
        " | #" + my.uid + " " + my.pName + " " + my.enh + "ê°•\n";
    } else {
      full += "ë³´ìœ  í¬ì¼“ëª¬ì´ ì—†ì–´ ìˆœìœ„ì— í¬í•¨ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n";
    }

    replyFold(replier, head, full);
    commitSave(false);
    return;
  }

  // ---------- ë°°í‹€ ë­í‚¹ ----------
  if (typeR === "ë°°í‹€") {
    var list = rankTopList(d);

    if (!list || list.length === 0) {
      replier.reply("ì•„ì§ ë°°í‹€ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    var topN2 = Math.min(10, list.length);
    var summary2 = "ë°°í‹€ ë­í‚¹\n\n";
    var showN2 = Math.min(3, topN2);

    for (var i2 = 0; i2 < showN2; i2++) {
      var r2 = list[i2];
      summary2 += (i2 + 1) + "ìœ„ " + r2.name + " | ì ìˆ˜ " + r2.score + "\n";
    }

    summary2 += "\nì „ì²´ë³´ê¸°ë¡œ TOP " + topN2 + " ë° ë‚´ ê¸°ë¡ì„ í™•ì¸í•˜ì„¸ìš”.";

    var full2 = "\n\n[ë°°í‹€ ë­í‚¹ TOP " + topN2 + "]\n\n";
    for (var j2 = 0; j2 < topN2; j2++) {
      var r3 = list[j2];
      full2 +=
        (j2 + 1) + "ìœ„ " + r3.name +
        " | ì ìˆ˜ " + r3.score +
        " | " + r3.w + "ìŠ¹ " + r3.l + "íŒ¨" +
        " | ì—°ìŠ¹ " + r3.s + "\n";
    }

    full2 += "\n\n[ë‚´ ê¸°ë¡]\n\n" + formatRecord(u);
    replyFold(replier, summary2, full2);
    return;
  }

  // ---------- íƒ€ì… ì˜¤ë¥˜ ----------
  replier.reply("ì•Œ ìˆ˜ ì—†ëŠ” ë­í‚¹ ëª…ë ¹ì…ë‹ˆë‹¤.\nì‚¬ìš©ë²•: /ë­í‚¹ ë„ê°  /ë­í‚¹ ì „íˆ¬ë ¥  /ë­í‚¹ ë°°í‹€");
  return;
}
  
  
}
//responeí•¨ìˆ˜ ë‹«ìŒ

// [ìˆ˜ì •ë¨] ì—ëŸ¬ ë°©ì§€ ë²„ì „: íŒŒì¼ì´ ì—†ìœ¼ë©´ ì½ì§€ ì•Šê³  ë„˜ì–´ê°
function manageInactiveUsers(d) {
  var now = new Date().getTime();
  var archivePath = "/sdcard/mbot_pokemon_archive.json"; 
  
  // [í•µì‹¬ ìˆ˜ì •] íŒŒì¼ì´ ì¡´ì¬í•˜ëŠ”ì§€ ë¨¼ì € í™•ì¸!
  var file = new java.io.File(archivePath);
  var archive = {}; // ê¸°ë³¸ê°’ì€ ë¹ˆ ê°ì²´

  if (file.exists()) {
    var archiveStr = File.read(archivePath);
    if (archiveStr) {
      try {
        archive = JSON.parse(archiveStr);
      } catch (e) {
        archive = {}; // ê¹¨ì§„ íŒŒì¼ì´ë©´ ë¹ˆ ê²ƒìœ¼ë¡œ ì·¨ê¸‰
      }
    }
  }
  
  var deletedCount = 0;
  var archivedCount = 0;
  var users = d.users;
  var keys = Object.keys(users);
  
  var day = 24 * 60 * 60 * 1000;
  var limitDelete = 30 * day; 
  var limitArchive = 2 * day; 

  for (var i = 0; i < keys.length; i++) {
    var key = keys[i];
    var u = users[key];
    
    if (!u.lastDate) continue; 
    var diff = now - u.lastDate;

    if (diff > limitDelete) {
      delete users[key];
      deletedCount++;
    } else if (diff > limitArchive) {
      archive[key] = u; 
      delete users[key]; 
      archivedCount++;
    }
  }

  if (deletedCount > 0 || archivedCount > 0) {
    saveData(d); 
    File.save(archivePath, JSON.stringify(archive)); 
    return "âœ… ë°ì´í„° ì •ë¦¬ ì™„ë£Œ!\nğŸ—‘ï¸ ì˜êµ¬ ì‚­ì œ: " + deletedCount + "ëª…\nğŸ“¦ ì•„ì¹´ì´ë¹™: " + archivedCount + "ëª…";
  } else {
    return "âœ¨ ì •ë¦¬í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
  }
}
